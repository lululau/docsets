<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<title>Data Access</title>
<link rel="stylesheet" href="stylesheets/asciidoctor-spring.css" /><link rel="stylesheet" href="tocbot-3.0.2/tocbot.css" /><style>#tocbot a.toc-link.node-name--H1{font-style:italic}@media screen{#tocbot>ul.toc-list{margin-bottom:.5em;margin-left:.125em}#tocbot ul.sectlevel0,#tocbot a.toc-link.node-name--H1+ul{padding-left:0}#tocbot a.toc-link{height:100%}.is-collapsible{max-height:3000px;overflow:hidden}.is-collapsed{max-height:0}.is-active-link{font-weight:700}}@media print{#tocbot a.toc-link.node-name--H4{display:none}}</style>
<link rel="stylesheet" href="../../../../../cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<style>.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 .5em 0 .25em}.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}table.CodeRay td{vertical-align:top;line-height:1.45}table.CodeRay td.line-numbers{text-align:right}table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}table.CodeRay td.code{padding:0 0 0 .5em}table.CodeRay td.code>pre{padding:0}.CodeRay .debug{color:#fff!important;background:navy!important}.CodeRay .annotation{color:#007}.CodeRay .attribute-name{color:navy}.CodeRay .attribute-value{color:#700}.CodeRay .binary{color:#509}.CodeRay .comment{color:#998;font-style:italic}.CodeRay .char{color:#04d}.CodeRay .char .content{color:#04d}.CodeRay .char .delimiter{color:#039}.CodeRay .class{color:#458;font-weight:bold}.CodeRay .complex{color:#a08}.CodeRay .constant,.CodeRay .predefined-constant{color:teal}.CodeRay .color{color:#099}.CodeRay .class-variable{color:#369}.CodeRay .decorator{color:#b0b}.CodeRay .definition{color:#099}.CodeRay .delimiter{color:#000}.CodeRay .doc{color:#970}.CodeRay .doctype{color:#34b}.CodeRay .doc-string{color:#d42}.CodeRay .escape{color:#666}.CodeRay .entity{color:#800}.CodeRay .error{color:#808}.CodeRay .exception{color:inherit}.CodeRay .filename{color:#099}.CodeRay .function{color:#900;font-weight:bold}.CodeRay .global-variable{color:teal}.CodeRay .hex{color:#058}.CodeRay .integer,.CodeRay .float{color:#099}.CodeRay .include{color:#555}.CodeRay .inline{color:#000}.CodeRay .inline .inline{background:#ccc}.CodeRay .inline .inline .inline{background:#bbb}.CodeRay .inline .inline-delimiter{color:#d14}.CodeRay .inline-delimiter{color:#d14}.CodeRay .important{color:#555;font-weight:bold}.CodeRay .interpreted{color:#b2b}.CodeRay .instance-variable{color:teal}.CodeRay .label{color:#970}.CodeRay .local-variable{color:#963}.CodeRay .octal{color:#40e}.CodeRay .predefined{color:#369}.CodeRay .preprocessor{color:#579}.CodeRay .pseudo-class{color:#555}.CodeRay .directive{font-weight:bold}.CodeRay .type{font-weight:bold}.CodeRay .predefined-type{color:inherit}.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}.CodeRay .key{color:#808}.CodeRay .key .delimiter{color:#606}.CodeRay .key .char{color:#80f}.CodeRay .value{color:#088}.CodeRay .regexp .delimiter{color:#808}.CodeRay .regexp .content{color:#808}.CodeRay .regexp .modifier{color:#808}.CodeRay .regexp .char{color:#d14}.CodeRay .regexp .function{color:#404;font-weight:bold}.CodeRay .string{color:#d20}.CodeRay .string .string .string{background:#ffd0d0}.CodeRay .string .content{color:#d14}.CodeRay .string .char{color:#d14}.CodeRay .string .delimiter{color:#d14}.CodeRay .shell{color:#d14}.CodeRay .shell .delimiter{color:#d14}.CodeRay .symbol{color:#990073}.CodeRay .symbol .content{color:#a60}.CodeRay .symbol .delimiter{color:#630}.CodeRay .tag{color:teal}.CodeRay .tag-special{color:#d70}.CodeRay .variable{color:#036}.CodeRay .insert{background:#afa}.CodeRay .delete{background:#faa}.CodeRay .change{color:#aaf;background:#007}.CodeRay .head{color:#f8f;background:#505}.CodeRay .insert .insert{color:#080}.CodeRay .delete .delete{color:#800}.CodeRay .change .change{color:#66f}.CodeRay .head .head{color:#f4f}</style>
</head>
<body id="spring-data-tier" class="book toc2 toc-left">
<div id="header">
<h1>Data Access</h1>
<div class="details">
<span id="revnumber">version 5.0.4.RELEASE</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="data-access.html#transaction">1. Transaction Management</a>
<ul class="sectlevel2">
<li><a href="data-access.html#transaction-intro">1.1. Introduction to Spring Framework transaction management</a></li>
<li><a href="data-access.html#transaction-motivation">1.2. Advantages of the Spring Framework&#8217;s transaction support model</a>
<ul class="sectlevel3">
<li><a href="data-access.html#transaction-global">1.2.1. Global transactions</a></li>
<li><a href="data-access.html#transaction-local">1.2.2. Local transactions</a></li>
<li><a href="data-access.html#transaction-programming-model">1.2.3. Spring Framework&#8217;s consistent programming model</a></li>
</ul>
</li>
<li><a href="data-access.html#transaction-strategies">1.3. Understanding the Spring Framework transaction abstraction</a></li>
<li><a href="data-access.html#tx-resource-synchronization">1.4. Synchronizing resources with transactions</a>
<ul class="sectlevel3">
<li><a href="data-access.html#tx-resource-synchronization-high">1.4.1. High-level synchronization approach</a></li>
<li><a href="data-access.html#tx-resource-synchronization-low">1.4.2. Low-level synchronization approach</a></li>
<li><a href="data-access.html#tx-resource-synchronization-tadsp">1.4.3. TransactionAwareDataSourceProxy</a></li>
</ul>
</li>
<li><a href="data-access.html#transaction-declarative">1.5. Declarative transaction management</a>
<ul class="sectlevel3">
<li><a href="data-access.html#tx-decl-explained">1.5.1. Understanding the Spring Framework&#8217;s declarative transaction implementation</a></li>
<li><a href="data-access.html#transaction-declarative-first-example">1.5.2. Example of declarative transaction implementation</a></li>
<li><a href="data-access.html#transaction-declarative-rolling-back">1.5.3. Rolling back a declarative transaction</a></li>
<li><a href="data-access.html#transaction-declarative-diff-tx">1.5.4. Configuring different transactional semantics for different beans</a></li>
<li><a href="data-access.html#transaction-declarative-txadvice-settings">1.5.5. &lt;tx:advice/&gt; settings</a></li>
<li><a href="data-access.html#transaction-declarative-annotations">1.5.6. Using @Transactional</a>
<ul class="sectlevel4">
<li><a href="data-access.html#transaction-declarative-attransactional-settings">@Transactional settings</a></li>
<li><a href="data-access.html#tx-multiple-tx-mgrs-with-attransactional">Multiple Transaction Managers with @Transactional</a></li>
<li><a href="data-access.html#tx-custom-attributes">Custom shortcut annotations</a></li>
</ul>
</li>
<li><a href="data-access.html#tx-propagation">1.5.7. Transaction propagation</a>
<ul class="sectlevel4">
<li><a href="data-access.html#tx-propagation-required">Required</a></li>
<li><a href="data-access.html#tx-propagation-requires_new">RequiresNew</a></li>
<li><a href="data-access.html#tx-propagation-nested">Nested</a></li>
</ul>
</li>
<li><a href="data-access.html#transaction-declarative-applying-more-than-just-tx-advice">1.5.8. Advising transactional operations</a></li>
<li><a href="data-access.html#transaction-declarative-aspectj">1.5.9. Using @Transactional with AspectJ</a></li>
</ul>
</li>
<li><a href="data-access.html#transaction-programmatic">1.6. Programmatic transaction management</a>
<ul class="sectlevel3">
<li><a href="data-access.html#tx-prog-template">1.6.1. Using the TransactionTemplate</a>
<ul class="sectlevel4">
<li><a href="data-access.html#tx-prog-template-settings">Specifying transaction settings</a></li>
</ul>
</li>
<li><a href="data-access.html#transaction-programmatic-ptm">1.6.2. Using the PlatformTransactionManager</a></li>
</ul>
</li>
<li><a href="data-access.html#tx-decl-vs-prog">1.7. Choosing between programmatic and declarative transaction management</a></li>
<li><a href="data-access.html#transaction-event">1.8. Transaction bound event</a></li>
<li><a href="data-access.html#transaction-application-server-integration">1.9. Application server-specific integration</a>
<ul class="sectlevel3">
<li><a href="data-access.html#transaction-application-server-integration-websphere">1.9.1. IBM WebSphere</a></li>
<li><a href="data-access.html#transaction-application-server-integration-weblogic">1.9.2. Oracle WebLogic Server</a></li>
</ul>
</li>
<li><a href="data-access.html#transaction-solutions-to-common-problems">1.10. Solutions to common problems</a>
<ul class="sectlevel3">
<li><a href="data-access.html#transaction-solutions-to-common-problems-wrong-ptm">1.10.1. Use of the wrong transaction manager for a specific DataSource</a></li>
</ul>
</li>
<li><a href="data-access.html#transaction-resources">1.11. Further resources</a></li>
</ul>
</li>
<li><a href="data-access.html#dao">2. DAO support</a>
<ul class="sectlevel2">
<li><a href="data-access.html#dao-introduction">2.1. Introduction</a></li>
<li><a href="data-access.html#dao-exceptions">2.2. Consistent exception hierarchy</a></li>
<li><a href="data-access.html#dao-annotations">2.3. Annotations used for configuring DAO or Repository classes</a></li>
</ul>
</li>
<li><a href="data-access.html#jdbc">3. Data access with JDBC</a>
<ul class="sectlevel2">
<li><a href="data-access.html#jdbc-introduction">3.1. Introduction to Spring Framework JDBC</a>
<ul class="sectlevel3">
<li><a href="data-access.html#jdbc-choose-style">3.1.1. Choosing an approach for JDBC database access</a></li>
<li><a href="data-access.html#jdbc-packages">3.1.2. Package hierarchy</a></li>
</ul>
</li>
<li><a href="data-access.html#jdbc-core">3.2. Using the JDBC core classes to control basic JDBC processing and error handling</a>
<ul class="sectlevel3">
<li><a href="data-access.html#jdbc-JdbcTemplate">3.2.1. JdbcTemplate</a>
<ul class="sectlevel4">
<li><a href="data-access.html#jdbc-JdbcTemplate-examples">Examples of JdbcTemplate class usage</a></li>
<li><a href="data-access.html#jdbc-JdbcTemplate-idioms">JdbcTemplate best practices</a></li>
</ul>
</li>
<li><a href="data-access.html#jdbc-NamedParameterJdbcTemplate">3.2.2. NamedParameterJdbcTemplate</a></li>
<li><a href="data-access.html#jdbc-SQLExceptionTranslator">3.2.3. SQLExceptionTranslator</a></li>
<li><a href="data-access.html#jdbc-statements-executing">3.2.4. Executing statements</a></li>
<li><a href="data-access.html#jdbc-statements-querying">3.2.5. Running queries</a></li>
<li><a href="data-access.html#jdbc-updates">3.2.6. Updating the database</a></li>
<li><a href="data-access.html#jdbc-auto-genereted-keys">3.2.7. Retrieving auto-generated keys</a></li>
</ul>
</li>
<li><a href="data-access.html#jdbc-connections">3.3. Controlling database connections</a>
<ul class="sectlevel3">
<li><a href="data-access.html#jdbc-datasource">3.3.1. DataSource</a></li>
<li><a href="data-access.html#jdbc-DataSourceUtils">3.3.2. DataSourceUtils</a></li>
<li><a href="data-access.html#jdbc-SmartDataSource">3.3.3. SmartDataSource</a></li>
<li><a href="data-access.html#jdbc-AbstractDataSource">3.3.4. AbstractDataSource</a></li>
<li><a href="data-access.html#jdbc-SingleConnectionDataSource">3.3.5. SingleConnectionDataSource</a></li>
<li><a href="data-access.html#jdbc-DriverManagerDataSource">3.3.6. DriverManagerDataSource</a></li>
<li><a href="data-access.html#jdbc-TransactionAwareDataSourceProxy">3.3.7. TransactionAwareDataSourceProxy</a></li>
<li><a href="data-access.html#jdbc-DataSourceTransactionManager">3.3.8. DataSourceTransactionManager</a></li>
</ul>
</li>
<li><a href="data-access.html#jdbc-advanced-jdbc">3.4. JDBC batch operations</a>
<ul class="sectlevel3">
<li><a href="data-access.html#jdbc-batch-classic">3.4.1. Basic batch operations with the JdbcTemplate</a></li>
<li><a href="data-access.html#jdbc-batch-list">3.4.2. Batch operations with a List of objects</a></li>
<li><a href="data-access.html#jdbc-batch-multi">3.4.3. Batch operations with multiple batches</a></li>
</ul>
</li>
<li><a href="data-access.html#jdbc-simple-jdbc">3.5. Simplifying JDBC operations with the SimpleJdbc classes</a>
<ul class="sectlevel3">
<li><a href="data-access.html#jdbc-simple-jdbc-insert-1">3.5.1. Inserting data using SimpleJdbcInsert</a></li>
<li><a href="data-access.html#jdbc-simple-jdbc-insert-2">3.5.2. Retrieving auto-generated keys using SimpleJdbcInsert</a></li>
<li><a href="data-access.html#jdbc-simple-jdbc-insert-3">3.5.3. Specifying columns for a SimpleJdbcInsert</a></li>
<li><a href="data-access.html#jdbc-simple-jdbc-parameters">3.5.4. Using SqlParameterSource to provide parameter values</a></li>
<li><a href="data-access.html#jdbc-simple-jdbc-call-1">3.5.5. Calling a stored procedure with SimpleJdbcCall</a></li>
<li><a href="data-access.html#jdbc-simple-jdbc-call-2">3.5.6. Explicitly declaring parameters to use for a SimpleJdbcCall</a></li>
<li><a href="data-access.html#jdbc-params">3.5.7. How to define SqlParameters</a></li>
<li><a href="data-access.html#jdbc-simple-jdbc-call-3">3.5.8. Calling a stored function using SimpleJdbcCall</a></li>
<li><a href="data-access.html#jdbc-simple-jdbc-call-4">3.5.9. Returning ResultSet/REF Cursor from a SimpleJdbcCall</a></li>
</ul>
</li>
<li><a href="data-access.html#jdbc-object">3.6. Modeling JDBC operations as Java objects</a>
<ul class="sectlevel3">
<li><a href="data-access.html#jdbc-SqlQuery">3.6.1. SqlQuery</a></li>
<li><a href="data-access.html#jdbc-MappingSqlQuery">3.6.2. MappingSqlQuery</a></li>
<li><a href="data-access.html#jdbc-SqlUpdate">3.6.3. SqlUpdate</a></li>
<li><a href="data-access.html#jdbc-StoredProcedure">3.6.4. StoredProcedure</a></li>
</ul>
</li>
<li><a href="data-access.html#jdbc-parameter-handling">3.7. Common problems with parameter and data value handling</a>
<ul class="sectlevel3">
<li><a href="data-access.html#jdbc-type-information">3.7.1. Providing SQL type information for parameters</a></li>
<li><a href="data-access.html#jdbc-lob">3.7.2. Handling BLOB and CLOB objects</a></li>
<li><a href="data-access.html#jdbc-in-clause">3.7.3. Passing in lists of values for IN clause</a></li>
<li><a href="data-access.html#jdbc-complex-types">3.7.4. Handling complex types for stored procedure calls</a></li>
</ul>
</li>
<li><a href="data-access.html#jdbc-embedded-database-support">3.8. Embedded database support</a>
<ul class="sectlevel3">
<li><a href="data-access.html#jdbc-why-embedded-database">3.8.1. Why use an embedded database?</a></li>
<li><a href="data-access.html#jdbc-embedded-database-xml">3.8.2. Creating an embedded database using Spring XML</a></li>
<li><a href="data-access.html#jdbc-embedded-database-java">3.8.3. Creating an embedded database programmatically</a></li>
<li><a href="data-access.html#jdbc-embedded-database-types">3.8.4. Selecting the embedded database type</a>
<ul class="sectlevel4">
<li><a href="data-access.html#jdbc-embedded-database-using-HSQL">Using HSQL</a></li>
<li><a href="data-access.html#jdbc-embedded-database-using-H2">Using H2</a></li>
<li><a href="data-access.html#jdbc-embedded-database-using-Derby">Using Derby</a></li>
</ul>
</li>
<li><a href="data-access.html#jdbc-embedded-database-dao-testing">3.8.5. Testing data access logic with an embedded database</a></li>
<li><a href="data-access.html#jdbc-embedded-database-unique-names">3.8.6. Generating unique names for embedded databases</a></li>
<li><a href="data-access.html#jdbc-embedded-database-extension">3.8.7. Extending the embedded database support</a></li>
</ul>
</li>
<li><a href="data-access.html#jdbc-initializing-datasource">3.9. Initializing a DataSource</a>
<ul class="sectlevel3">
<li><a href="data-access.html#jdbc-initializing-datasource-xml">3.9.1. Initializing a database using Spring XML</a>
<ul class="sectlevel4">
<li><a href="data-access.html#jdbc-client-component-initialization">Initialization of other components that depend on the database</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="data-access.html#orm">4. Object Relational Mapping (ORM) Data Access</a>
<ul class="sectlevel2">
<li><a href="data-access.html#orm-introduction">4.1. Introduction to ORM with Spring</a></li>
<li><a href="data-access.html#orm-general">4.2. General ORM integration considerations</a>
<ul class="sectlevel3">
<li><a href="data-access.html#orm-resource-mngmnt">4.2.1. Resource and transaction management</a></li>
<li><a href="data-access.html#orm-exception-translation">4.2.2. Exception translation</a></li>
</ul>
</li>
<li><a href="data-access.html#orm-hibernate">4.3. Hibernate</a>
<ul class="sectlevel3">
<li><a href="data-access.html#orm-session-factory-setup">4.3.1. SessionFactory setup in a Spring container</a></li>
<li><a href="data-access.html#orm-hibernate-straight">4.3.2. Implementing DAOs based on plain Hibernate API</a></li>
<li><a href="data-access.html#orm-hibernate-tx-declarative">4.3.3. Declarative transaction demarcation</a></li>
<li><a href="data-access.html#orm-hibernate-tx-programmatic">4.3.4. Programmatic transaction demarcation</a></li>
<li><a href="data-access.html#orm-hibernate-tx-strategies">4.3.5. Transaction management strategies</a></li>
<li><a href="data-access.html#orm-hibernate-resources">4.3.6. Comparing container-managed and locally defined resources</a></li>
<li><a href="data-access.html#orm-hibernate-invalid-jdbc-access-error">4.3.7. Spurious application server warnings with Hibernate</a></li>
</ul>
</li>
<li><a href="data-access.html#orm-jpa">4.4. JPA</a>
<ul class="sectlevel3">
<li><a href="data-access.html#orm-jpa-setup">4.4.1. Three options for JPA setup in a Spring environment</a>
<ul class="sectlevel4">
<li><a href="data-access.html#orm-jpa-setup-lemfb">LocalEntityManagerFactoryBean</a></li>
<li><a href="data-access.html#orm-jpa-setup-jndi">Obtaining an EntityManagerFactory from JNDI</a></li>
<li><a href="data-access.html#orm-jpa-setup-lcemfb">LocalContainerEntityManagerFactoryBean</a></li>
<li><a href="data-access.html#orm-jpa-multiple">Dealing with multiple persistence units</a></li>
</ul>
</li>
<li><a href="data-access.html#orm-jpa-dao">4.4.2. Implementing DAOs based on JPA: EntityManagerFactory and EntityManager</a></li>
<li><a href="data-access.html#orm-jpa-tx">4.4.3. Spring-driven JPA transactions</a></li>
<li><a href="data-access.html#orm-jpa-dialect">4.4.4. JpaDialect and JpaVendorAdapter</a></li>
<li><a href="data-access.html#orm-jpa-jta">4.4.5. Setting up JPA with JTA transaction management</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="data-access.html#oxm">5. Marshalling XML using O/X Mappers</a>
<ul class="sectlevel2">
<li><a href="data-access.html#oxm-introduction">5.1. Introduction</a>
<ul class="sectlevel3">
<li><a href="data-access.html#ease-of-configuration">5.1.1. Ease of configuration</a></li>
<li><a href="data-access.html#consistent-interfaces">5.1.2. Consistent interfaces</a></li>
<li><a href="data-access.html#consistent-exception-hierarchy">5.1.3. Consistent exception hierarchy</a></li>
</ul>
</li>
<li><a href="data-access.html#oxm-marshaller-unmarshaller">5.2. Marshaller and Unmarshaller</a>
<ul class="sectlevel3">
<li><a href="data-access.html#oxm-marshaller">5.2.1. Marshaller</a></li>
<li><a href="data-access.html#oxm-unmarshaller">5.2.2. Unmarshaller</a></li>
<li><a href="data-access.html#oxm-xmlmappingexception">5.2.3. XmlMappingException</a></li>
</ul>
</li>
<li><a href="data-access.html#oxm-usage">5.3. Using Marshaller and Unmarshaller</a></li>
<li><a href="data-access.html#oxm-schema-based-config">5.4. XML configuration namespace</a></li>
<li><a href="data-access.html#oxm-jaxb">5.5. JAXB</a>
<ul class="sectlevel3">
<li><a href="data-access.html#oxm-jaxb2">5.5.1. Jaxb2Marshaller</a>
<ul class="sectlevel4">
<li><a href="data-access.html#oxm-jaxb2-xsd">XML configuration namespace</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="data-access.html#oxm-castor">5.6. Castor</a>
<ul class="sectlevel3">
<li><a href="data-access.html#oxm-castor-marshaller">5.6.1. CastorMarshaller</a></li>
<li><a href="data-access.html#oxm-castor-mapping">5.6.2. Mapping</a>
<ul class="sectlevel4">
<li><a href="data-access.html#oxm-castor-xsd">XML configuration namespace</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="data-access.html#oxm-jibx">5.7. JiBX</a>
<ul class="sectlevel3">
<li><a href="data-access.html#oxm-jibx-marshaller">5.7.1. JibxMarshaller</a>
<ul class="sectlevel4">
<li><a href="data-access.html#oxm-jibx-xsd">XML configuration namespace</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="data-access.html#oxm-xstream">5.8. XStream</a>
<ul class="sectlevel3">
<li><a href="data-access.html#oxm-xstream-marshaller">5.8.1. XStreamMarshaller</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="data-access.html#appendix">6. Appendix</a>
<ul class="sectlevel2">
<li><a href="data-access.html#xsd-schemas">6.1. XML Schemas</a>
<ul class="sectlevel3">
<li><a href="data-access.html#xsd-schemas-tx">6.1.1. The <code>tx</code> schema</a></li>
<li><a href="data-access.html#xsd-schemas-jdbc">6.1.2. The <code>jdbc</code> schema</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This part of the reference documentation is concerned with data access and the
interaction between the data access layer and the business or service layer.</p>
</div>
<div class="paragraph">
<p>Spring&#8217;s comprehensive transaction management support is covered in some detail,
followed by thorough coverage of the various data access frameworks and technologies
that the Spring Framework integrates with.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="transaction"><a class="anchor" href="data-access.html#transaction"></a>1. Transaction Management</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="transaction-intro"><a class="anchor" href="data-access.html#transaction-intro"></a>1.1. Introduction to Spring Framework transaction management</h3>
<div class="paragraph">
<p>Comprehensive transaction support is among the most compelling reasons to use the Spring
Framework. The Spring Framework provides a consistent abstraction for transaction
management that delivers the following benefits:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Consistent programming model across different transaction APIs such as Java
Transaction API (JTA), JDBC, Hibernate, and Java Persistence API (JPA).</p>
</li>
<li>
<p>Support for <a href="data-access.html#transaction-declarative">declarative transaction management</a>.</p>
</li>
<li>
<p>Simpler API for <a href="data-access.html#transaction-programmatic">programmatic</a> transaction management than
complex transaction APIs such as JTA.</p>
</li>
<li>
<p>Excellent integration with Spring&#8217;s data access abstractions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following sections describe the Spring Framework&#8217;s transaction value-adds and
technologies. (The chapter also includes discussions of best practices, application
server integration, and solutions to common problems.)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="data-access.html#transaction-motivation">Advantages of the Spring Framework&#8217;s transaction support
model</a> describes <em>why</em> you would use the Spring Framework&#8217;s transaction abstraction
instead of EJB Container-Managed Transactions (CMT) or choosing to drive local
transactions through a proprietary API such as Hibernate.</p>
</li>
<li>
<p><a href="data-access.html#transaction-strategies">Understanding the Spring Framework transaction abstraction</a>
outlines the core classes and describes how to configure and obtain <code>DataSource</code>
instances from a variety of sources.</p>
</li>
<li>
<p><a href="data-access.html#tx-resource-synchronization">Synchronizing resources with transactions </a>describes
how the application code ensures that resources are created, reused, and cleaned up
properly.</p>
</li>
<li>
<p><a href="data-access.html#transaction-declarative">Declarative transaction management</a> describes support for
declarative transaction management.</p>
</li>
<li>
<p><a href="data-access.html#transaction-programmatic">Programmatic transaction management</a> covers support for
programmatic (that is, explicitly coded) transaction management.</p>
</li>
<li>
<p><a href="data-access.html#transaction-event">Transaction bound event</a> describes how you could use application
events within a transaction.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="transaction-motivation"><a class="anchor" href="data-access.html#transaction-motivation"></a>1.2. Advantages of the Spring Framework&#8217;s transaction support model</h3>
<div class="paragraph">
<p>Traditionally, Java EE developers have had two choices for transaction management:
<em>global</em> or <em>local</em> transactions, both of which have profound limitations. Global
and local transaction management is reviewed in the next two sections, followed by a
discussion of how the Spring Framework&#8217;s transaction management support addresses the
limitations of the global and local transaction models.</p>
</div>
<div class="sect3">
<h4 id="transaction-global"><a class="anchor" href="data-access.html#transaction-global"></a>1.2.1. Global transactions</h4>
<div class="paragraph">
<p>Global transactions enable you to work with multiple transactional resources, typically
relational databases and message queues. The application server manages global
transactions through the JTA, which is a cumbersome API to use (partly due to its
exception model). Furthermore, a JTA <code>UserTransaction</code> normally needs to be sourced from
JNDI, meaning that you <em>also</em> need to use JNDI in order to use JTA. Obviously the use
of global transactions would limit any potential reuse of application code, as JTA is
normally only available in an application server environment.</p>
</div>
<div class="paragraph">
<p>Previously, the preferred way to use global transactions was via EJB <em>CMT</em>
(<em>Container Managed Transaction</em>): CMT is a form of <em>declarative transaction
management</em> (as distinguished from <em>programmatic transaction management</em>). EJB CMT
removes the need for transaction-related JNDI lookups, although of course the use of EJB
itself necessitates the use of JNDI. It removes most but not all of the need to write
Java code to control transactions. The significant downside is that CMT is tied to JTA
and an application server environment. Also, it is only available if one chooses to
implement business logic in EJBs, or at least behind a transactional EJB facade. The
negatives of EJB in general are so great that this is not an attractive proposition,
especially in the face of compelling alternatives for declarative transaction management.</p>
</div>
</div>
<div class="sect3">
<h4 id="transaction-local"><a class="anchor" href="data-access.html#transaction-local"></a>1.2.2. Local transactions</h4>
<div class="paragraph">
<p>Local transactions are resource-specific, such as a transaction associated with a JDBC
connection. Local transactions may be easier to use, but have significant disadvantages:
they cannot work across multiple transactional resources. For example, code that manages
transactions using a JDBC connection cannot run within a global JTA transaction. Because
the application server is not involved in transaction management, it cannot help ensure
correctness across multiple resources. (It is worth noting that most applications use a
single transaction resource.) Another downside is that local transactions are invasive
to the programming model.</p>
</div>
</div>
<div class="sect3">
<h4 id="transaction-programming-model"><a class="anchor" href="data-access.html#transaction-programming-model"></a>1.2.3. Spring Framework&#8217;s consistent programming model</h4>
<div class="paragraph">
<p>Spring resolves the disadvantages of global and local transactions. It enables
application developers to use a <em>consistent</em> programming model <em>in any environment</em>.
You write your code once, and it can benefit from different transaction management
strategies in different environments. The Spring Framework provides both declarative and
programmatic transaction management. Most users prefer declarative transaction
management, which is recommended in most cases.</p>
</div>
<div class="paragraph">
<p>With programmatic transaction management, developers work with the Spring Framework
transaction abstraction, which can run over any underlying transaction infrastructure.
With the preferred declarative model, developers typically write little or no code
related to transaction management, and hence do not depend on the Spring Framework
transaction API, or any other transaction API.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Do you need an application server for transaction management?</div>
<div class="paragraph">
<p>The Spring Framework&#8217;s transaction management support changes traditional rules as to
when an enterprise Java application requires an application server.</p>
</div>
<div class="paragraph">
<p>In particular, you do not need an application server simply for declarative transactions
through EJBs. In fact, even if your application server has powerful JTA capabilities,
you may decide that the Spring Framework&#8217;s declarative transactions offer more power and
a more productive programming model than EJB CMT.</p>
</div>
<div class="paragraph">
<p>Typically you need an application server&#8217;s JTA capability only if your application needs
to handle transactions across multiple resources, which is not a requirement for many
applications. Many high-end applications use a single, highly scalable database (such as
Oracle RAC) instead. Standalone transaction managers such as
<a href="http://www.atomikos.com/">Atomikos Transactions</a> and <a href="http://jotm.objectweb.org/">JOTM</a>
are other options. Of course, you may need other application server capabilities such as
Java Message Service (JMS) and Java EE Connector Architecture (JCA).</p>
</div>
<div class="paragraph">
<p>The Spring Framework <em>gives you the choice of when to scale your application to a fully
loaded application server</em>. Gone are the days when the only alternative to using EJB
CMT or JTA was to write code with local transactions such as those on JDBC connections,
and face a hefty rework if you need that code to run within global, container-managed
transactions. With the Spring Framework, only some of the bean definitions in your
configuration file, rather than your code, need to change.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="transaction-strategies"><a class="anchor" href="data-access.html#transaction-strategies"></a>1.3. Understanding the Spring Framework transaction abstraction</h3>
<div class="paragraph">
<p>The key to the Spring transaction abstraction is the notion of a <em>transaction
strategy</em>. A transaction strategy is defined by the
<code>org.springframework.transaction.PlatformTransactionManager</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">PlatformTransactionManager</span> {

    TransactionStatus getTransaction(TransactionDefinition definition) <span class="directive">throws</span> TransactionException;

    <span class="type">void</span> commit(TransactionStatus status) <span class="directive">throws</span> TransactionException;

    <span class="type">void</span> rollback(TransactionStatus status) <span class="directive">throws</span> TransactionException;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is primarily a service provider interface (SPI), although it can be used
<a href="data-access.html#transaction-programmatic-ptm">programmatically</a> from your application code. Because
<code>PlatformTransactionManager</code> is an <em>interface</em>, it can be easily mocked or stubbed as
necessary. It is not tied to a lookup strategy such as JNDI.
<code>PlatformTransactionManager</code> implementations are defined like any other object (or bean)
in the Spring Framework IoC container. This benefit alone makes Spring Framework
transactions a worthwhile abstraction even when you work with JTA. Transactional code
can be tested much more easily than if it used JTA directly.</p>
</div>
<div class="paragraph">
<p>Again in keeping with Spring&#8217;s philosophy, the <code>TransactionException</code> that can be thrown
by any of the <code>PlatformTransactionManager</code> interface&#8217;s methods is <em>unchecked</em> (that
is, it extends the <code>java.lang.RuntimeException</code> class). Transaction infrastructure
failures are almost invariably fatal. In rare cases where application code can actually
recover from a transaction failure, the application developer can still choose to catch
and handle <code>TransactionException</code>. The salient point is that developers are not
<em>forced</em> to do so.</p>
</div>
<div class="paragraph">
<p>The <code>getTransaction(..)</code> method returns a <code>TransactionStatus</code> object, depending on a
<code>TransactionDefinition</code> parameter. The returned <code>TransactionStatus</code> might represent a
new transaction, or can represent an existing transaction if a matching transaction
exists in the current call stack. The implication in this latter case is that, as with
Java EE transaction contexts, a <code>TransactionStatus</code> is associated with a <em>thread</em> of
execution.</p>
</div>
<div class="paragraph">
<p>The <code>TransactionDefinition</code> interface specifies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Propagation</em>: Typically, all code executed within a transaction scope will run in
that transaction. However, you have the option of specifying the behavior in the event
that a transactional method is executed when a transaction context already exists. For
example, code can continue running in the existing transaction (the common case); or
the existing transaction can be suspended and a new transaction created. <em>Spring
offers all of the transaction propagation options familiar from EJB CMT</em>. To read
about the semantics of transaction propagation in Spring, see <a href="data-access.html#tx-propagation">Transaction propagation</a>.</p>
</li>
<li>
<p><em>Isolation</em>: The degree to which this transaction is isolated from the work of other
transactions. For example, can this transaction see uncommitted writes from other
transactions?</p>
</li>
<li>
<p><em>Timeout</em>: How long this transaction runs before timing out and being rolled back
automatically by the underlying transaction infrastructure.</p>
</li>
<li>
<p><em>Read-only status</em>: A read-only transaction can be used when your code reads but
does not modify data. Read-only transactions can be a useful optimization in some
cases, such as when you are using Hibernate.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These settings reflect standard transactional concepts. If necessary, refer to resources
that discuss transaction isolation levels and other core transaction concepts.
Understanding these concepts is essential to using the Spring Framework or any
transaction management solution.</p>
</div>
<div class="paragraph">
<p>The <code>TransactionStatus</code> interface provides a simple way for transactional code to
control transaction execution and query transaction status. The concepts should be
familiar, as they are common to all transaction APIs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">TransactionStatus</span> <span class="directive">extends</span> SavepointManager {

    <span class="type">boolean</span> isNewTransaction();

    <span class="type">boolean</span> hasSavepoint();

    <span class="type">void</span> setRollbackOnly();

    <span class="type">boolean</span> isRollbackOnly();

    <span class="type">void</span> flush();

    <span class="type">boolean</span> isCompleted();

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Regardless of whether you opt for declarative or programmatic transaction management in
Spring, defining the correct <code>PlatformTransactionManager</code> implementation is absolutely
essential. You typically define this implementation through dependency injection.</p>
</div>
<div class="paragraph">
<p><code>PlatformTransactionManager</code> implementations normally require knowledge of the
environment in which they work: JDBC, JTA, Hibernate, and so on. The following examples
show how you can define a local <code>PlatformTransactionManager</code> implementation. (This
example works with plain JDBC.)</p>
</div>
<div class="paragraph">
<p>You define a JDBC <code>DataSource</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.commons.dbcp.BasicDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">destroy-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">close</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">driverClassName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.driverClassName}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.url}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.username}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.password}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The related <code>PlatformTransactionManager</code> bean definition will then have a reference to
the <code>DataSource</code> definition. It will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txManager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.jdbc.datasource.DataSourceTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you use JTA in a Java EE container then you use a container <code>DataSource</code>, obtained
through JNDI, in conjunction with Spring&#8217;s <code>JtaTransactionManager</code>. This is what the JTA
and JNDI lookup version would look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:jee</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/jee</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
        <span class="content">http://www.springframework.org/schema/beans</span>
        <span class="content">http://www.springframework.org/schema/beans/spring-beans.xsd</span>
        <span class="content">http://www.springframework.org/schema/jee</span>
        <span class="content">http://www.springframework.org/schema/jee/spring-jee.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;jee:jndi-lookup</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">jndi-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc/jpetstore</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txManager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.transaction.jta.JtaTransactionManager</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- other &lt;bean/&gt; definitions here --&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>JtaTransactionManager</code> does not need to know about the <code>DataSource</code>, or any other
specific resources, because it uses the container&#8217;s global transaction management
infrastructure.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The above definition of the <code>dataSource</code> bean uses the <code>&lt;jndi-lookup/&gt;</code> tag from the
<code>jee</code> namespace. For more information see
<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/integration.html#xsd-schemas-jee">The JEE schema</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also use Hibernate local transactions easily, as shown in the following
examples. In this case, you need to define a Hibernate <code>LocalSessionFactoryBean</code>, which
your application code will use to obtain Hibernate <code>Session</code> instances.</p>
</div>
<div class="paragraph">
<p>The <code>DataSource</code> bean definition will be similar to the local JDBC example shown
previously and thus is not shown in the following example.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the <code>DataSource</code>, used by any non-JTA transaction manager, is looked up via JNDI and
managed by a Java EE container, then it should be non-transactional because the Spring
Framework, rather than the Java EE container, will manage the transactions.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>txManager</code> bean in this case is of the <code>HibernateTransactionManager</code> type. In the
same way as the <code>DataSourceTransactionManager</code> needs a reference to the <code>DataSource</code>,
the <code>HibernateTransactionManager</code> needs a reference to the <code>SessionFactory</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessionFactory</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.orm.hibernate5.LocalSessionFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mappingResources</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;list&gt;</span>
            <span class="tag">&lt;value&gt;</span>org/springframework/samples/petclinic/hibernate/petclinic.hbm.xml<span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;/list&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernateProperties</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;value&gt;</span>
            hibernate.dialect=${hibernate.dialect}
        <span class="tag">&lt;/value&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txManager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.orm.hibernate5.HibernateTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessionFactory</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are using Hibernate and Java EE container-managed JTA transactions, then you
should simply use the same <code>JtaTransactionManager</code> as in the previous JTA example for
JDBC.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txManager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.transaction.jta.JtaTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you use JTA , then your transaction manager definition will look the same regardless
of what data access technology you use, be it JDBC, Hibernate JPA or any other supported
technology. This is due to the fact that JTA transactions are global transactions, which
can enlist any transactional resource.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In all these cases, application code does not need to change. You can change how
transactions are managed merely by changing configuration, even if that change means
moving from local to global transactions or vice versa.</p>
</div>
</div>
<div class="sect2">
<h3 id="tx-resource-synchronization"><a class="anchor" href="data-access.html#tx-resource-synchronization"></a>1.4. Synchronizing resources with transactions</h3>
<div class="paragraph">
<p>It should now be clear how you create different transaction managers, and how they are
linked to related resources that need to be synchronized to transactions (for example
<code>DataSourceTransactionManager</code> to a JDBC <code>DataSource</code>, <code>HibernateTransactionManager</code> to
a Hibernate <code>SessionFactory</code>, and so forth). This section describes how the application
code, directly or indirectly using a persistence API such as JDBC, Hibernate, or JPA,
ensures that these resources are created, reused, and cleaned up properly. The section
also discusses how transaction synchronization is triggered (optionally) through the
relevant <code>PlatformTransactionManager</code>.</p>
</div>
<div class="sect3">
<h4 id="tx-resource-synchronization-high"><a class="anchor" href="data-access.html#tx-resource-synchronization-high"></a>1.4.1. High-level synchronization approach</h4>
<div class="paragraph">
<p>The preferred approach is to use Spring&#8217;s highest level template based persistence
integration APIs or to use native ORM APIs with transaction- aware factory beans or
proxies for managing the native resource factories. These transaction-aware solutions
internally handle resource creation and reuse, cleanup, optional transaction
synchronization of the resources, and exception mapping. Thus user data access code does
not have to address these tasks, but can be focused purely on non-boilerplate
persistence logic. Generally, you use the native ORM API or take a <em>template</em> approach
for JDBC access by using the <code>JdbcTemplate</code>. These solutions are detailed in subsequent
chapters of this reference documentation.</p>
</div>
</div>
<div class="sect3">
<h4 id="tx-resource-synchronization-low"><a class="anchor" href="data-access.html#tx-resource-synchronization-low"></a>1.4.2. Low-level synchronization approach</h4>
<div class="paragraph">
<p>Classes such as <code>DataSourceUtils</code> (for JDBC), <code>EntityManagerFactoryUtils</code> (for JPA),
<code>SessionFactoryUtils</code> (for Hibernate), and so on exist at a lower level. When you want the
application code to deal directly with the resource types of the native persistence APIs,
you use these classes to ensure that proper Spring Framework-managed instances are obtained,
transactions are (optionally) synchronized, and exceptions that occur in the process are
properly mapped to a consistent API.</p>
</div>
<div class="paragraph">
<p>For example, in the case of JDBC, instead of the traditional JDBC approach of calling
the <code>getConnection()</code> method on the <code>DataSource</code>, you instead use Spring&#8217;s
<code>org.springframework.jdbc.datasource.DataSourceUtils</code> class as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Connection</span> conn = DataSourceUtils.getConnection(dataSource);</code></pre>
</div>
</div>
<div class="paragraph">
<p>If an existing transaction already has a connection synchronized (linked) to it, that
instance is returned. Otherwise, the method call triggers the creation of a new
connection, which is (optionally) synchronized to any existing transaction, and made
available for subsequent reuse in that same transaction. As mentioned, any
<code>SQLException</code> is wrapped in a Spring Framework <code>CannotGetJdbcConnectionException</code>, one
of the Spring Framework&#8217;s hierarchy of unchecked DataAccessExceptions. This approach
gives you more information than can be obtained easily from the <code>SQLException</code>, and
ensures portability across databases, even across different persistence technologies.</p>
</div>
<div class="paragraph">
<p>This approach also works without Spring transaction management (transaction
synchronization is optional), so you can use it whether or not you are using Spring for
transaction management.</p>
</div>
<div class="paragraph">
<p>Of course, once you have used Spring&#8217;s JDBC support, JPA support or Hibernate support,
you will generally prefer not to use <code>DataSourceUtils</code> or the other helper classes,
because you will be much happier working through the Spring abstraction than directly
with the relevant APIs. For example, if you use the Spring <code>JdbcTemplate</code> or
<code>jdbc.object</code> package to simplify your use of JDBC, correct connection retrieval occurs
behind the scenes and you won&#8217;t need to write any special code.</p>
</div>
</div>
<div class="sect3">
<h4 id="tx-resource-synchronization-tadsp"><a class="anchor" href="data-access.html#tx-resource-synchronization-tadsp"></a>1.4.3. TransactionAwareDataSourceProxy</h4>
<div class="paragraph">
<p>At the very lowest level exists the <code>TransactionAwareDataSourceProxy</code> class. This is a
proxy for a target <code>DataSource</code>, which wraps the target <code>DataSource</code> to add awareness of
Spring-managed transactions. In this respect, it is similar to a transactional JNDI
<code>DataSource</code> as provided by a Java EE server.</p>
</div>
<div class="paragraph">
<p>It should almost never be necessary or desirable to use this class, except when existing
code must be called and passed a standard JDBC <code>DataSource</code> interface implementation. In
that case, it is possible that this code is usable, but participating in Spring managed
transactions. It is preferable to write your new code by using the higher level
abstractions mentioned above.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="transaction-declarative"><a class="anchor" href="data-access.html#transaction-declarative"></a>1.5. Declarative transaction management</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Most Spring Framework users choose declarative transaction management. This option has
the least impact on application code, and hence is most consistent with the ideals of a
<em>non-invasive</em> lightweight container.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Spring Framework&#8217;s declarative transaction management is made possible with Spring
aspect-oriented programming (AOP), although, as the transactional aspects code comes
with the Spring Framework distribution and may be used in a boilerplate fashion, AOP
concepts do not generally have to be understood to make effective use of this code.</p>
</div>
<div class="paragraph">
<p>The Spring Framework&#8217;s declarative transaction management is similar to EJB CMT in that
you can specify transaction behavior (or lack of it) down to individual method level. It
is possible to make a <code>setRollbackOnly()</code> call within a transaction context if
necessary. The differences between the two types of transaction management are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Unlike EJB CMT, which is tied to JTA, the Spring Framework&#8217;s declarative transaction
management works in any environment. It can work with JTA transactions or local
transactions using JDBC, JPA or Hibernate by simply adjusting the configuration
files.</p>
</li>
<li>
<p>You can apply the Spring Framework declarative transaction management to any class,
not merely special classes such as EJBs.</p>
</li>
<li>
<p>The Spring Framework offers declarative
<a href="data-access.html#transaction-declarative-rolling-back"><em>rollback rules</em>, </a>a feature with no EJB
equivalent. Both programmatic and declarative support for rollback rules is provided.</p>
</li>
<li>
<p>The Spring Framework enables you to customize transactional behavior, by using AOP.
For example, you can insert custom behavior in the case of transaction rollback. You
can also add arbitrary advice, along with the transactional advice. With EJB CMT, you
cannot influence the container&#8217;s transaction management except with
<code>setRollbackOnly()</code>.</p>
</li>
<li>
<p>The Spring Framework does not support propagation of transaction contexts across
remote calls, as do high-end application servers. If you need this feature, we
recommend that you use EJB. However, consider carefully before using such a feature,
because normally, one does not want transactions to span remote calls.</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Where is TransactionProxyFactoryBean?</div>
<div class="paragraph">
<p>Declarative transaction configuration in versions of Spring 2.0 and above differs
considerably from previous versions of Spring. The main difference is that there is no
longer any need to configure <code>TransactionProxyFactoryBean</code> beans.</p>
</div>
<div class="paragraph">
<p>The pre-Spring 2.0 configuration style is still 100% valid configuration; think of the
new <code>&lt;tx:tags/&gt;</code> as simply defining <code>TransactionProxyFactoryBean</code> beans on your behalf.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The concept of rollback rules is important: they enable you to specify which exceptions
(and throwables) should cause automatic rollback. You specify this declaratively, in
configuration, not in Java code. So, although you can still call <code>setRollbackOnly()</code> on
the <code>TransactionStatus</code> object to roll back the current transaction back, most often you
can specify a rule that <code>MyApplicationException</code> must always result in rollback. The
significant advantage to this option is that business objects do not depend on the
transaction infrastructure. For example, they typically do not need to import Spring
transaction APIs or other Spring APIs.</p>
</div>
<div class="paragraph">
<p>Although EJB container default behavior automatically rolls back the transaction on a
<em>system exception</em> (usually a runtime exception), EJB CMT does not roll back the
transaction automatically on an<em>application exception</em> (that is, a checked exception
other than <code>java.rmi.RemoteException</code>). While the Spring default behavior for
declarative transaction management follows EJB convention (roll back is automatic only
on unchecked exceptions), it is often useful to customize this behavior.</p>
</div>
<div class="sect3">
<h4 id="tx-decl-explained"><a class="anchor" href="data-access.html#tx-decl-explained"></a>1.5.1. Understanding the Spring Framework&#8217;s declarative transaction implementation</h4>
<div class="paragraph">
<p>It is not sufficient to tell you simply to annotate your classes with the
<code>@Transactional</code> annotation, add <code>@EnableTransactionManagement</code> to your configuration,
and then expect you to understand how it all works. This section explains the inner
workings of the Spring Framework&#8217;s declarative transaction infrastructure in the event
of transaction-related issues.</p>
</div>
<div class="paragraph">
<p>The most important concepts to grasp with regard to the Spring Framework&#8217;s declarative
transaction support are that this support is enabled
<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop-understanding-aop-proxies"><em>via AOP proxies</em></a>, and that the transactional advice
is driven by <em>metadata</em> (currently XML- or annotation-based). The combination of AOP
with transactional metadata yields an AOP proxy that uses a <code>TransactionInterceptor</code> in
conjunction with an appropriate <code>PlatformTransactionManager</code> implementation to drive
transactions <em>around method invocations</em>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Spring AOP is covered in <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop">the AOP section</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Conceptually, calling a method on a transactional proxy looks like this&#8230;&#8203;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/tx.png" alt="tx">
</div>
</div>
</div>
<div class="sect3">
<h4 id="transaction-declarative-first-example"><a class="anchor" href="data-access.html#transaction-declarative-first-example"></a>1.5.2. Example of declarative transaction implementation</h4>
<div class="paragraph">
<p>Consider the following interface, and its attendant implementation. This example uses
<code>Foo</code> and <code>Bar</code> classes as placeholders so that you can concentrate on the transaction
usage without focusing on a particular domain model. For the purposes of this example,
the fact that the <code>DefaultFooService</code> class throws <code>UnsupportedOperationException</code>
instances in the body of each implemented method is good; it allows you to see
transactions created and then rolled back in response to the
<code>UnsupportedOperationException</code> instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// the service interface that we want to make transactional</span>

<span class="keyword">package</span> <span class="namespace">x.y.service</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">FooService</span> {

    Foo getFoo(<span class="predefined-type">String</span> fooName);

    Foo getFoo(<span class="predefined-type">String</span> fooName, <span class="predefined-type">String</span> barName);

    <span class="type">void</span> insertFoo(Foo foo);

    <span class="type">void</span> updateFoo(Foo foo);

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// an implementation of the above interface</span>

<span class="keyword">package</span> <span class="namespace">x.y.service</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">DefaultFooService</span> <span class="directive">implements</span> FooService {

    <span class="directive">public</span> Foo getFoo(<span class="predefined-type">String</span> fooName) {
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>();
    }

    <span class="directive">public</span> Foo getFoo(<span class="predefined-type">String</span> fooName, <span class="predefined-type">String</span> barName) {
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>();
    }

    <span class="directive">public</span> <span class="type">void</span> insertFoo(Foo foo) {
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>();
    }

    <span class="directive">public</span> <span class="type">void</span> updateFoo(Foo foo) {
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">UnsupportedOperationException</span>();
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assume that the first two methods of the <code>FooService</code> interface, <code>getFoo(String)</code> and
<code>getFoo(String, String)</code>, must execute in the context of a transaction with read-only
semantics, and that the other methods, <code>insertFoo(Foo)</code> and <code>updateFoo(Foo)</code>, must
execute in the context of a transaction with read-write semantics. The following
configuration is explained in detail in the next few paragraphs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- from the file 'context.xml' --&gt;</span>
<span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:aop</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/aop</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:tx</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/tx</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
        <span class="content">http://www.springframework.org/schema/beans</span>
        <span class="content">http://www.springframework.org/schema/beans/spring-beans.xsd</span>
        <span class="content">http://www.springframework.org/schema/tx</span>
        <span class="content">http://www.springframework.org/schema/tx/spring-tx.xsd</span>
        <span class="content">http://www.springframework.org/schema/aop</span>
        <span class="content">http://www.springframework.org/schema/aop/spring-aop.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- this is the service object that we want to make transactional --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooService</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">x.y.service.DefaultFooService</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- the transactional advice (what 'happens'; see the &lt;aop:advisor/&gt; bean below) --&gt;</span>
    <span class="tag">&lt;tx:advice</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txAdvice</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- the transactional semantics... --&gt;</span>
        <span class="tag">&lt;tx:attributes&gt;</span>
            <span class="comment">&lt;!-- all methods starting with 'get' are read-only --&gt;</span>
            <span class="tag">&lt;tx:method</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">get*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="comment">&lt;!-- other methods use the default transaction settings (see below) --&gt;</span>
            <span class="tag">&lt;tx:method</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/tx:attributes&gt;</span>
    <span class="tag">&lt;/tx:advice&gt;</span>

    <span class="comment">&lt;!-- ensure that the above transactional advice runs for any execution
        of an operation defined by the FooService interface --&gt;</span>
    <span class="tag">&lt;aop:config&gt;</span>
        <span class="tag">&lt;aop:pointcut</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooServiceOperation</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">expression</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">execution(* x.y.service.FooService.*(..))</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;aop:advisor</span> <span class="attribute-name">advice-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txAdvice</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">pointcut-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooServiceOperation</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/aop:config&gt;</span>

    <span class="comment">&lt;!-- don't forget the DataSource --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.commons.dbcp.BasicDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">destroy-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">close</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">driverClassName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">oracle.jdbc.driver.OracleDriver</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:oracle:thin:@rj-t42:1521:elvis</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">scott</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tiger</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="comment">&lt;!-- similarly, don't forget the PlatformTransactionManager --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txManager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.jdbc.datasource.DataSourceTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="comment">&lt;!-- other &lt;bean/&gt; definitions here --&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Examine the preceding configuration. You want to make a service object, the <code>fooService</code>
bean, transactional. The transaction semantics to apply are encapsulated in the
<code>&lt;tx:advice/&gt;</code> definition. The <code>&lt;tx:advice/&gt;</code> definition reads as "<em>&#8230;&#8203; all methods on
starting with <code>'get'</code> are to execute in the context of a read-only transaction, and all
other methods are to execute with the default transaction semantics</em>". The
<code>transaction-manager</code> attribute of the <code>&lt;tx:advice/&gt;</code> tag is set to the name of the
<code>PlatformTransactionManager</code> bean that is going to <em>drive</em> the transactions, in this
case, the <code>txManager</code> bean.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can omit the <code>transaction-manager</code> attribute in the transactional advice
(<code>&lt;tx:advice/&gt;</code>) if the bean name of the <code>PlatformTransactionManager</code> that you want to
wire in has the name <code>transactionManager</code>. If the <code>PlatformTransactionManager</code> bean that
you want to wire in has any other name, then you must use the <code>transaction-manager</code>
attribute explicitly, as in the preceding example.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>&lt;aop:config/&gt;</code> definition ensures that the transactional advice defined by the
<code>txAdvice</code> bean executes at the appropriate points in the program. First you define a
pointcut that matches the execution of any operation defined in the <code>FooService</code>
interface ( <code>fooServiceOperation</code>). Then you associate the pointcut with the <code>txAdvice</code>
using an advisor. The result indicates that at the execution of a <code>fooServiceOperation</code>,
the advice defined by <code>txAdvice</code> will be run.</p>
</div>
<div class="paragraph">
<p>The expression defined within the <code>&lt;aop:pointcut/&gt;</code> element is an AspectJ pointcut
expression; see <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop">the AOP section</a> for more details on pointcut expressions in Spring.</p>
</div>
<div class="paragraph">
<p>A common requirement is to make an entire service layer transactional. The best way to
do this is simply to change the pointcut expression to match any operation in your
service layer. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;aop:config&gt;</span>
    <span class="tag">&lt;aop:pointcut</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooServiceMethods</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">expression</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">execution(* x.y.service.*.*(..))</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;aop:advisor</span> <span class="attribute-name">advice-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txAdvice</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">pointcut-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooServiceMethods</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/aop:config&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><em>In this example it is assumed that all your service interfaces are defined in the
<code>x.y.service</code> package; see <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop">the AOP section</a> for more details.</em></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that we&#8217;ve analyzed the configuration, you may be asking yourself, "<em>Okay&#8230;&#8203; but
what does all this configuration actually do?</em>".</p>
</div>
<div class="paragraph">
<p>The above configuration will be used to create a transactional proxy around the object
that is created from the <code>fooService</code> bean definition. The proxy will be configured with
the transactional advice, so that when an appropriate method is invoked <em>on the
proxy</em>, a transaction is started, suspended, marked as read-only, and so on, depending
on the transaction configuration associated with that method. Consider the following
program that test drives the above configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">Boot</span> {

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="directive">final</span> <span class="predefined-type">String</span><span class="type">[]</span> args) <span class="directive">throws</span> <span class="exception">Exception</span> {
        ApplicationContext ctx = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string"><span class="delimiter">&quot;</span><span class="content">context.xml</span><span class="delimiter">&quot;</span></span>, Boot.class);
        FooService fooService = (FooService) ctx.getBean(<span class="string"><span class="delimiter">&quot;</span><span class="content">fooService</span><span class="delimiter">&quot;</span></span>);
        fooService.insertFoo (<span class="keyword">new</span> Foo());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output from running the preceding program will resemble the following. (The Log4J
output and the stack trace from the UnsupportedOperationException thrown by the
insertFoo(..) method of the DefaultFooService class have been truncated for clarity.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- the Spring container is starting up... --&gt;</span>
[AspectJInvocationContextExposingAdvisorAutoProxyCreator] - Creating implicit proxy for bean 'fooService' with 0 common interceptors and 1 specific interceptors

<span class="comment">&lt;!-- the DefaultFooService is actually proxied --&gt;</span>
[JdkDynamicAopProxy] - Creating JDK dynamic proxy for [x.y.service.DefaultFooService]

<span class="comment">&lt;!-- ... the insertFoo(..) method is now being invoked on the proxy --&gt;</span>
[TransactionInterceptor] - Getting transaction for x.y.service.FooService.insertFoo

<span class="comment">&lt;!-- the transactional advice kicks in here... --&gt;</span>
[DataSourceTransactionManager] - Creating new transaction with name [x.y.service.FooService.insertFoo]
[DataSourceTransactionManager] - Acquired Connection [<a href="https://docs.spring.io/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="f8978a9fd69988999b909dd69b97959597968bd69c9a9b88d6a8979794999a949dbb9796969d9b8c919796b899cdcb9c9dcc">[email&#160;protected]</a>] for JDBC transaction

<span class="comment">&lt;!-- the insertFoo(..) method from DefaultFooService throws an exception... --&gt;</span>
[RuleBasedTransactionAttribute] - Applying rules to determine whether transaction should rollback on java.lang.UnsupportedOperationException
[TransactionInterceptor] - Invoking rollback for transaction on x.y.service.FooService.insertFoo due to throwable [java.lang.UnsupportedOperationException]

<span class="comment">&lt;!-- and the transaction is rolled back (by default, RuntimeException instances cause rollback) --&gt;</span>
[DataSourceTransactionManager] - Rolling back JDBC transaction on Connection [<a href="https://docs.spring.io/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="046b76632a657465676c612a676b69696b6a772a606667742a546b6b6865666861476b6a6a6167706d6b6a44653137606130">[email&#160;protected]</a>]
[DataSourceTransactionManager] - Releasing JDBC Connection after transaction
[DataSourceUtils] - Returning JDBC Connection to DataSource

Exception in thread &quot;main&quot; java.lang.UnsupportedOperationException at x.y.service.DefaultFooService.insertFoo(DefaultFooService.java:14)
<span class="comment">&lt;!-- AOP infrastructure stack trace elements removed for clarity --&gt;</span>
at $Proxy0.insertFoo(Unknown Source)
at Boot.main(Boot.java:11)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="transaction-declarative-rolling-back"><a class="anchor" href="data-access.html#transaction-declarative-rolling-back"></a>1.5.3. Rolling back a declarative transaction</h4>
<div class="paragraph">
<p>The previous section outlined the basics of how to specify transactional settings for
classes, typically service layer classes, declaratively in your application. This
section describes how you can control the rollback of transactions in a simple
declarative fashion.</p>
</div>
<div class="paragraph">
<p>The recommended way to indicate to the Spring Framework&#8217;s transaction infrastructure
that a transaction&#8217;s work is to be rolled back is to throw an <code>Exception</code> from code that
is currently executing in the context of a transaction. The Spring Framework&#8217;s
transaction infrastructure code will catch any unhandled <code>Exception</code> as it bubbles up
the call stack, and make a determination whether to mark the transaction for rollback.</p>
</div>
<div class="paragraph">
<p>In its default configuration, the Spring Framework&#8217;s transaction infrastructure code
<em>only</em> marks a transaction for rollback in the case of runtime, unchecked exceptions;
that is, when the thrown exception is an instance or subclass of <code>RuntimeException</code>. (
<code>Error</code>s will also - by default - result in a rollback). Checked exceptions that are
thrown from a transactional method do <em>not</em> result in rollback in the default
configuration.</p>
</div>
<div class="paragraph">
<p>You can configure exactly which <code>Exception</code> types mark a transaction for rollback,
including checked exceptions. The following XML snippet demonstrates how you configure
rollback for a checked, application-specific <code>Exception</code> type.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;tx:advice</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txAdvice</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tx:attributes&gt;</span>
    <span class="tag">&lt;tx:method</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">get*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">rollback-for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NoProductInStockException</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;tx:method</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/tx:attributes&gt;</span>
<span class="tag">&lt;/tx:advice&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify 'no rollback rules', if you do <em>not</em> want a transaction rolled
back when an exception is thrown. The following example tells the Spring Framework&#8217;s
transaction infrastructure to commit the attendant transaction even in the face of an
unhandled <code>InstrumentNotFoundException</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;tx:advice</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txAdvice</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tx:attributes&gt;</span>
    <span class="tag">&lt;tx:method</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">updateStock</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">no-rollback-for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">InstrumentNotFoundException</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;tx:method</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/tx:attributes&gt;</span>
<span class="tag">&lt;/tx:advice&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the Spring Framework&#8217;s transaction infrastructure catches an exception and it
consults configured rollback rules to determine whether to mark the transaction for
rollback, the <em>strongest</em> matching rule wins. So in the case of the following
configuration, any exception other than an <code>InstrumentNotFoundException</code> results in a
rollback of the attendant transaction.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;tx:advice</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txAdvice</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;tx:attributes&gt;</span>
    <span class="tag">&lt;tx:method</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">rollback-for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Throwable</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">no-rollback-for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">InstrumentNotFoundException</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/tx:attributes&gt;</span>
<span class="tag">&lt;/tx:advice&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also indicate a required rollback <em>programmatically</em>. Although very simple,
this process is quite invasive, and tightly couples your code to the Spring Framework&#8217;s
transaction infrastructure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> resolvePosition() {
    <span class="keyword">try</span> {
        <span class="comment">// some business logic...</span>
    } <span class="keyword">catch</span> (NoProductInStockException ex) {
        <span class="comment">// trigger rollback programmatically</span>
        TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You are strongly encouraged to use the declarative approach to rollback if at all
possible. Programmatic rollback is available should you absolutely need it, but its
usage flies in the face of achieving a clean POJO-based architecture.</p>
</div>
</div>
<div class="sect3">
<h4 id="transaction-declarative-diff-tx"><a class="anchor" href="data-access.html#transaction-declarative-diff-tx"></a>1.5.4. Configuring different transactional semantics for different beans</h4>
<div class="paragraph">
<p>Consider the scenario where you have a number of service layer objects, and you want to
apply a <em>totally different</em> transactional configuration to each of them. You do this
by defining distinct <code>&lt;aop:advisor/&gt;</code> elements with differing <code>pointcut</code> and
<code>advice-ref</code> attribute values.</p>
</div>
<div class="paragraph">
<p>As a point of comparison, first assume that all of your service layer classes are
defined in a root <code>x.y.service</code> package. To make all beans that are instances of classes
defined in that package (or in subpackages) and that have names ending in <code>Service</code> have
the default transactional configuration, you would write the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:aop</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/aop</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:tx</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/tx</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
        <span class="content">http://www.springframework.org/schema/beans</span>
        <span class="content">http://www.springframework.org/schema/beans/spring-beans.xsd</span>
        <span class="content">http://www.springframework.org/schema/tx</span>
        <span class="content">http://www.springframework.org/schema/tx/spring-tx.xsd</span>
        <span class="content">http://www.springframework.org/schema/aop</span>
        <span class="content">http://www.springframework.org/schema/aop/spring-aop.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;aop:config&gt;</span>

        <span class="tag">&lt;aop:pointcut</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">serviceOperation</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">expression</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">execution(* x.y.service..*Service.*(..))</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

        <span class="tag">&lt;aop:advisor</span> <span class="attribute-name">pointcut-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">serviceOperation</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">advice-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txAdvice</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;/aop:config&gt;</span>

    <span class="comment">&lt;!-- these two beans will be transactional... --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooService</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">x.y.service.DefaultFooService</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">barService</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">x.y.service.extras.SimpleBarService</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- ... and these two beans won't --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">anotherService</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.xyz.SomeService</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (not in the right package) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">barManager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">x.y.service.SimpleBarManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (doesn't end in 'Service') --&gt;</span>

    <span class="tag">&lt;tx:advice</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txAdvice</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;tx:attributes&gt;</span>
            <span class="tag">&lt;tx:method</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">get*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;tx:method</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/tx:attributes&gt;</span>
    <span class="tag">&lt;/tx:advice&gt;</span>

    <span class="comment">&lt;!-- other transaction infrastructure beans such as a PlatformTransactionManager omitted... --&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example shows how to configure two distinct beans with totally different
transactional settings.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:aop</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/aop</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:tx</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/tx</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
        <span class="content">http://www.springframework.org/schema/beans</span>
        <span class="content">http://www.springframework.org/schema/beans/spring-beans.xsd</span>
        <span class="content">http://www.springframework.org/schema/tx</span>
        <span class="content">http://www.springframework.org/schema/tx/spring-tx.xsd</span>
        <span class="content">http://www.springframework.org/schema/aop</span>
        <span class="content">http://www.springframework.org/schema/aop/spring-aop.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;aop:config&gt;</span>

        <span class="tag">&lt;aop:pointcut</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">defaultServiceOperation</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">expression</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">execution(* x.y.service.*Service.*(..))</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

        <span class="tag">&lt;aop:pointcut</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">noTxServiceOperation</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">expression</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">execution(* x.y.service.ddl.DefaultDdlManager.*(..))</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

        <span class="tag">&lt;aop:advisor</span> <span class="attribute-name">pointcut-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">defaultServiceOperation</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">advice-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">defaultTxAdvice</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

        <span class="tag">&lt;aop:advisor</span> <span class="attribute-name">pointcut-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">noTxServiceOperation</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">advice-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">noTxAdvice</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;/aop:config&gt;</span>

    <span class="comment">&lt;!-- this bean will be transactional (see the 'defaultServiceOperation' pointcut) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooService</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">x.y.service.DefaultFooService</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- this bean will also be transactional, but with totally different transactional settings --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">anotherFooService</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">x.y.service.ddl.DefaultDdlManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;tx:advice</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">defaultTxAdvice</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;tx:attributes&gt;</span>
            <span class="tag">&lt;tx:method</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">get*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;tx:method</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/tx:attributes&gt;</span>
    <span class="tag">&lt;/tx:advice&gt;</span>

    <span class="tag">&lt;tx:advice</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">noTxAdvice</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;tx:attributes&gt;</span>
            <span class="tag">&lt;tx:method</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">propagation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NEVER</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/tx:attributes&gt;</span>
    <span class="tag">&lt;/tx:advice&gt;</span>

    <span class="comment">&lt;!-- other transaction infrastructure beans such as a PlatformTransactionManager omitted... --&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="transaction-declarative-txadvice-settings"><a class="anchor" href="data-access.html#transaction-declarative-txadvice-settings"></a>1.5.5. &lt;tx:advice/&gt; settings</h4>
<div class="paragraph">
<p>This section summarizes the various transactional settings that can be specified using
the <code>&lt;tx:advice/&gt;</code> tag. The default <code>&lt;tx:advice/&gt;</code> settings are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="data-access.html#tx-propagation">Propagation setting</a> is <code>REQUIRED.</code></p>
</li>
<li>
<p>Isolation level is <code>DEFAULT.</code></p>
</li>
<li>
<p>Transaction is read/write.</p>
</li>
<li>
<p>Transaction timeout defaults to the default timeout of the underlying transaction
system, or none if timeouts are not supported.</p>
</li>
<li>
<p>Any <code>RuntimeException</code> triggers rollback, and any checked <code>Exception</code> does not.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can change these default settings; the various attributes of the <code>&lt;tx:method/&gt;</code> tags
that are nested within <code>&lt;tx:advice/&gt;</code> and <code>&lt;tx:attributes/&gt;</code> tags are summarized below:</p>
</div>
<table id="tx-method-settings" class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. &lt;tx:method/&gt; settings</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Required?</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Method name(s) with which the transaction attributes are to be associated. The
wildcard (*) character can be used to associate the same transaction attribute
settings with a number of methods; for example, <code>get*</code>, <code>handle*</code>, <code>on*Event</code>, and so
forth.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>propagation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">REQUIRED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction propagation behavior.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>isolation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DEFAULT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction isolation level. Only applicable to propagation REQUIRED or REQUIRES_NEW.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction timeout (seconds). Only applicable to propagation REQUIRED or REQUIRES_NEW.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>read-only</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read/write vs. read-only transaction. Only applicable to REQUIRED or REQUIRES_NEW.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rollback-for</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Exception(s)</code> that trigger rollback; comma-delimited. For example,
<code>com.foo.MyBusinessException,ServletException.</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>no-rollback-for</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Exception(s)</code> that do <em>not</em> trigger rollback; comma-delimited. For example,
<code>com.foo.MyBusinessException,ServletException.</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="transaction-declarative-annotations"><a class="anchor" href="data-access.html#transaction-declarative-annotations"></a>1.5.6. Using @Transactional</h4>
<div class="paragraph">
<p>In addition to the XML-based declarative approach to transaction configuration, you can
use an annotation-based approach. Declaring transaction semantics directly in the Java
source code puts the declarations much closer to the affected code. There is not much
danger of undue coupling, because code that is meant to be used transactionally is
almost always deployed that way anyway.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The standard <code>javax.transaction.Transactional</code> annotation is also supported as a drop-in
replacement to Spring&#8217;s own annotation. Please refer to JTA 1.2 documentation for more
details.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The ease-of-use afforded by the use of the <code>@Transactional</code> annotation is best
illustrated with an example, which is explained in the text that follows. Consider the
following class definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// the service class that we want to make transactional</span>
<strong><span class="annotation">@Transactional</span></strong>
<span class="directive">public</span> <span class="type">class</span> <span class="class">DefaultFooService</span> <span class="directive">implements</span> FooService {

    Foo getFoo(<span class="predefined-type">String</span> fooName);

    Foo getFoo(<span class="predefined-type">String</span> fooName, <span class="predefined-type">String</span> barName);

    <span class="type">void</span> insertFoo(Foo foo);

    <span class="type">void</span> updateFoo(Foo foo);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the above POJO is defined as a bean in a Spring IoC container, the bean instance
can be made transactional by adding merely <em>one</em> line of XML configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- from the file 'context.xml' --&gt;</span>
<span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:aop</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/aop</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:tx</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/tx</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
        <span class="content">http://www.springframework.org/schema/beans</span>
        <span class="content">http://www.springframework.org/schema/beans/spring-beans.xsd</span>
        <span class="content">http://www.springframework.org/schema/tx</span>
        <span class="content">http://www.springframework.org/schema/tx/spring-tx.xsd</span>
        <span class="content">http://www.springframework.org/schema/aop</span>
        <span class="content">http://www.springframework.org/schema/aop/spring-aop.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- this is the service object that we want to make transactional --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooService</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">x.y.service.DefaultFooService</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- enable the configuration of transactional behavior based on annotations --&gt;</span>
    <em><span class="tag">&lt;tx:annotation-driven</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></em><span class="comment">&lt;!-- a PlatformTransactionManager is still required --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txManager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.jdbc.datasource.DataSourceTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (this dependency is defined somewhere else) --&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="comment">&lt;!-- other &lt;bean/&gt; definitions here --&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can omit the <code>transaction-manager</code> attribute in the <code>&lt;tx:annotation-driven/&gt;</code> tag if
the bean name of the <code>PlatformTransactionManager</code> that you want to wire in has the name
<code>transactionManager</code>. If the <code>PlatformTransactionManager</code> bean that you want to
dependency-inject has any other name, then you have to use the <code>transaction-manager</code>
attribute explicitly, as in the preceding example.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>@EnableTransactionManagement</code> annotation provides equivalent support if you are
using Java based configuration. Simply add the annotation to a <code>@Configuration</code> class.
See the javadocs for full details.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Method visibility and @Transactional</div>
<div class="paragraph">
<p>When using proxies, you should apply the <code>@Transactional</code> annotation only to methods
with <em>public</em> visibility. If you do annotate protected, private or package-visible
methods with the <code>@Transactional</code> annotation, no error is raised, but the annotated
method does not exhibit the configured transactional settings. Consider the use of
AspectJ (see below) if you need to annotate non-public methods.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>You can place the <code>@Transactional</code> annotation before an interface definition, a method
on an interface, a class definition, or a <em>public</em> method on a class. However, the
mere presence of the <code>@Transactional</code> annotation is not enough to activate the
transactional behavior. The <code>@Transactional</code> annotation is simply metadata that can be
consumed by some runtime infrastructure that is <code>@Transactional</code>-aware and that can use
the metadata to configure the appropriate beans with transactional behavior. In the
preceding example, the <code>&lt;tx:annotation-driven/&gt;</code> element <em>switches on</em> the
transactional behavior.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Spring recommends that you only annotate concrete classes (and methods of concrete
classes) with the <code>@Transactional</code> annotation, as opposed to annotating interfaces. You
certainly can place the <code>@Transactional</code> annotation on an interface (or an interface
method), but this works only as you would expect it to if you are using interface-based
proxies. The fact that Java annotations are <em>not inherited from interfaces</em> means that
if you are using class-based proxies ( <code>proxy-target-class="true"</code>) or the weaving-based
aspect ( <code>mode="aspectj"</code>), then the transaction settings are not recognized by the
proxying and weaving infrastructure, and the object will not be wrapped in a
transactional proxy, which would be decidedly <em>bad</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In proxy mode (which is the default), only external method calls coming in through the
proxy are intercepted. This means that self-invocation, in effect, a method within the
target object calling another method of the target object, will not lead to an actual
transaction at runtime even if the invoked method is marked with <code>@Transactional</code>. Also,
the proxy must be fully initialized to provide the expected behaviour so you should not
rely on this feature in your initialization code, i.e. <code>@PostConstruct</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Consider the use of AspectJ mode (see mode attribute in table below) if you expect
self-invocations to be wrapped with transactions as well. In this case, there will not
be a proxy in the first place; instead, the target class will be weaved (that is, its
byte code will be modified) in order to turn <code>@Transactional</code> into runtime behavior on
any kind of method.</p>
</div>
<table id="tx-annotation-driven-settings" class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. Annotation driven transaction settings</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">XML Attribute</th>
<th class="tableblock halign-left valign-top">Annotation Attribute</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>transaction-manager</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A (See <code>TransactionManagementConfigurer</code> javadocs)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactionManager</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of transaction manager to use. Only required if the name of the transaction
manager is not <code>transactionManager</code>, as in the example above.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">proxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default mode "proxy" processes annotated beans to be proxied using Spring&#8217;s AOP
framework (following proxy semantics, as discussed above, applying to method calls
coming in through the proxy only). The alternative mode "aspectj" instead weaves the
affected classes with Spring&#8217;s AspectJ transaction aspect, modifying the target class
byte code to apply to any kind of method call. AspectJ weaving requires
spring-aspects.jar in the classpath as well as load-time weaving (or compile-time
weaving) enabled. (See <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop-aj-ltw-spring">Spring configuration</a>
for details on how to set up load-time weaving.)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>proxy-target-class</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>proxyTargetClass</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Applies to proxy mode only. Controls what type of transactional proxies are created
for classes annotated with the <code>@Transactional</code> annotation. If the
<code>proxy-target-class</code> attribute is set to <code>true</code>, then class-based proxies are created.
If <code>proxy-target-class</code> is <code>false</code> or if the attribute is omitted, then standard JDK
interface-based proxies are created. (See <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop-proxying">Proxying mechanisms</a>
for a detailed examination of the different proxy types.)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>order</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>order</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ordered.LOWEST_PRECEDENCE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the order of the transaction advice that is applied to beans annotated with
<code>@Transactional</code>. (For more information about the rules related to ordering of AOP
advice, see <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop-ataspectj-advice-ordering">Advice ordering</a>.)
No specified ordering means that the AOP subsystem determines the order of the advice.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The default advice mode for processing <code>@Transactional</code> annotations is "proxy" which
allows for interception of calls through the proxy only; local calls within the same
class cannot get intercepted that way. For a more advanced mode of interception,
consider switching to "aspectj" mode in combination with compile/load-time weaving.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>proxy-target-class</code> attribute controls what type of transactional proxies are
created for classes annotated with the <code>@Transactional</code> annotation. If
<code>proxy-target-class</code> is set to <code>true</code>, class-based proxies are created. If
<code>proxy-target-class</code> is <code>false</code> or if the attribute is omitted, standard JDK
interface-based proxies are created. (See <a href="data-access.html#aop-proxying">[aop-proxying]</a> for a discussion of the
different proxy types.)</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>@EnableTransactionManagement</code> and <code>&lt;tx:annotation-driven/&gt;</code> only looks for
<code>@Transactional</code> on beans in the same application context they are defined in. This
means that, if you put annotation driven configuration in a <code>WebApplicationContext</code> for
a <code>DispatcherServlet</code>, it only checks for <code>@Transactional</code> beans in your controllers,
and not your services. See <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-servlet">MVC</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The most derived location takes precedence when evaluating the transactional settings
for a method. In the case of the following example, the <code>DefaultFooService</code> class is
annotated at the class level with the settings for a read-only transaction, but the
<code>@Transactional</code> annotation on the <code>updateFoo(Foo)</code> method in the same class takes
precedence over the transactional settings defined at the class level.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Transactional</span>(readOnly = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">DefaultFooService</span> <span class="directive">implements</span> FooService {

    <span class="directive">public</span> Foo getFoo(<span class="predefined-type">String</span> fooName) {
        <span class="comment">// do something</span>
    }

    <span class="comment">// these settings have precedence for this method</span>
    <span class="annotation">@Transactional</span>(readOnly = <span class="predefined-constant">false</span>, propagation = Propagation.REQUIRES_NEW)
    <span class="directive">public</span> <span class="type">void</span> updateFoo(Foo foo) {
        <span class="comment">// do something</span>
    }
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="transaction-declarative-attransactional-settings"><a class="anchor" href="data-access.html#transaction-declarative-attransactional-settings"></a>@Transactional settings</h5>
<div class="paragraph">
<p>The <code>@Transactional</code> annotation is metadata that specifies that an interface, class, or
method must have transactional semantics; for example, "<em>start a brand new read-only
transaction when this method is invoked, suspending any existing transaction</em>". The
default <code>@Transactional</code> settings are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Propagation setting is <code>PROPAGATION_REQUIRED.</code></p>
</li>
<li>
<p>Isolation level is <code>ISOLATION_DEFAULT.</code></p>
</li>
<li>
<p>Transaction is read/write.</p>
</li>
<li>
<p>Transaction timeout defaults to the default timeout of the underlying transaction
system, or to none if timeouts are not supported.</p>
</li>
<li>
<p>Any <code>RuntimeException</code> triggers rollback, and any checked <code>Exception</code> does not.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These default settings can be changed; the various properties of the <code>@Transactional</code>
annotation are summarized in the following table:</p>
</div>
<table id="tx-attransactional-properties" class="tableblock frame-all grid-all spread">
<caption class="title">Table 3. @Transactional Settings</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="data-access.html#tx-multiple-tx-mgrs-with-attransactional">value</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional qualifier specifying the transaction manager to be used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="data-access.html#tx-propagation">propagation</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">enum: <code>Propagation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional propagation setting.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>isolation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">enum: <code>Isolation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional isolation level. Only applicable to propagation REQUIRED or REQUIRES_NEW.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int (in seconds granularity)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional transaction timeout. Only applicable to propagation REQUIRED or REQUIRES_NEW.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>readOnly</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read/write vs. read-only transaction. Only applicable to REQUIRED or REQUIRES_NEW.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rollbackFor</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array of <code>Class</code> objects, which must be derived from <code>Throwable.</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional array of exception classes that <em>must</em> cause rollback.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rollbackForClassName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array of class names. Classes must be derived from <code>Throwable.</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional array of names of exception classes that <em>must</em> cause rollback.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>noRollbackFor</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array of <code>Class</code> objects, which must be derived from <code>Throwable.</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional array of exception classes that <em>must not</em> cause rollback.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>noRollbackForClassName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array of <code>String</code> class names, which must be derived from <code>Throwable.</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional array of names of exception classes that <em>must not</em> cause rollback.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Currently you cannot have explicit control over the name of a transaction, where 'name'
means the transaction name that will be shown in a transaction monitor, if applicable
(for example, WebLogic&#8217;s transaction monitor), and in logging output. For declarative
transactions, the transaction name is always the fully-qualified class name + "."
+ method name of the transactionally-advised class. For example, if the
<code>handlePayment(..)</code> method of the <code>BusinessService</code> class started a transaction, the
name of the transaction would be: <code>com.foo.BusinessService.handlePayment</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="tx-multiple-tx-mgrs-with-attransactional"><a class="anchor" href="data-access.html#tx-multiple-tx-mgrs-with-attransactional"></a>Multiple Transaction Managers with @Transactional</h5>
<div class="paragraph">
<p>Most Spring applications only need a single transaction manager, but there may be
situations where you want multiple independent transaction managers in a single
application. The value attribute of the <code>@Transactional</code> annotation can be used to
optionally specify the identity of the <code>PlatformTransactionManager</code> to be used. This can
either be the bean name or the qualifier value of the transaction manager bean. For
example, using the qualifier notation, the following Java code</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">TransactionalService</span> {

    <span class="annotation">@Transactional</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">order</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> setSomething(<span class="predefined-type">String</span> name) { ... }

    <span class="annotation">@Transactional</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">account</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> doSomething() { ... }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>could be combined with the following transaction manager bean declarations in the
application context.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;tx:annotation-driven</span><span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.jdbc.datasource.DataSourceTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        ...
        <span class="tag">&lt;qualifier</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">order</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.jdbc.datasource.DataSourceTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        ...
        <span class="tag">&lt;qualifier</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">account</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the two methods on <code>TransactionalService</code> will run under separate
transaction managers, differentiated by the "order" and "account" qualifiers. The
default <code>&lt;tx:annotation-driven&gt;</code> target bean name <code>transactionManager</code> will still be
used if no specifically qualified PlatformTransactionManager bean is found.</p>
</div>
</div>
<div class="sect4">
<h5 id="tx-custom-attributes"><a class="anchor" href="data-access.html#tx-custom-attributes"></a>Custom shortcut annotations</h5>
<div class="paragraph">
<p>If you find you are repeatedly using the same attributes with <code>@Transactional</code> on many
different methods, then <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#beans-meta-annotations">Spring&#8217;s meta-annotation support</a> allows
you to define custom shortcut annotations for your specific use cases. For example,
defining the following annotations</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Target</span>({<span class="predefined-type">ElementType</span>.METHOD, <span class="predefined-type">ElementType</span>.TYPE})
<span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Transactional</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">order</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="annotation">@interface</span> OrderTx {
}

<span class="annotation">@Target</span>({<span class="predefined-type">ElementType</span>.METHOD, <span class="predefined-type">ElementType</span>.TYPE})
<span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Transactional</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">account</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="annotation">@interface</span> AccountTx {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>allows us to write the example from the previous section as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">TransactionalService</span> {

    <span class="annotation">@OrderTx</span>
    <span class="directive">public</span> <span class="type">void</span> setSomething(<span class="predefined-type">String</span> name) { ... }

    <span class="annotation">@AccountTx</span>
    <span class="directive">public</span> <span class="type">void</span> doSomething() { ... }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we have used the syntax to define the transaction manager qualifier, but could also
have included propagation behavior, rollback rules, timeouts etc.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tx-propagation"><a class="anchor" href="data-access.html#tx-propagation"></a>1.5.7. Transaction propagation</h4>
<div class="paragraph">
<p>This section describes some semantics of transaction propagation in Spring. Please note
that this section is not an introduction to transaction propagation proper; rather it
details some of the semantics regarding transaction propagation in Spring.</p>
</div>
<div class="paragraph">
<p>In Spring-managed transactions, be aware of the difference between <em>physical</em> and
<em>logical</em> transactions, and how the propagation setting applies to this difference.</p>
</div>
<div class="sect4">
<h5 id="tx-propagation-required"><a class="anchor" href="data-access.html#tx-propagation-required"></a>Required</h5>
<div class="imageblock">
<div class="content">
<img src="images/tx_prop_required.png" alt="tx prop required">
</div>
</div>
<div class="paragraph">
<p>PROPAGATION_REQUIRED</p>
</div>
<div class="paragraph">
<p><code>PROPAGATION_REQUIRED</code> enforces a physical transaction: either locally for the current
scope if no transaction exists yet, or participating in an existing 'outer' transaction
defined for a larger scope. This is a fine default in common call stack arrangements
within the same thread, e.g. a service facade delegating to several repository methods
where all the underlying resources have to participate in the service-level transaction.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default, a participating transaction will join the characteristics of the outer scope,
silently ignoring the local isolation level, timeout value or read-only flag (if any).
Consider switching the "validateExistingTransactions" flag to "true" on your transaction
manager if you&#8217;d like isolation level declarations to get rejected when participating in
an existing transaction with a different isolation level. This non-lenient mode will also
reject read-only mismatches, i.e. an inner read-write transaction trying to participate
in a read-only outer scope.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the propagation setting is <code>PROPAGATION_REQUIRED</code>, a <em>logical</em> transaction scope
is created for each method upon which the setting is applied. Each such logical
transaction scope can determine rollback-only status individually, with an outer
transaction scope being logically independent from the inner transaction scope.
Of course, in case of standard <code>PROPAGATION_REQUIRED</code> behavior, all these scopes will be
mapped to the same physical transaction. So a rollback-only marker set in the inner
transaction scope does affect the outer transaction&#8217;s chance to actually commit (as you
would expect it to).</p>
</div>
<div class="paragraph">
<p>However, in the case where an inner transaction scope sets the rollback-only marker, the
outer transaction has not decided on the rollback itself, and so the rollback (silently
triggered by the inner transaction scope) is unexpected. A corresponding
<code>UnexpectedRollbackException</code> is thrown at that point. This is <em>expected behavior</em> so
that the caller of a transaction can never be misled to assume that a commit was
performed when it really was not. So if an inner transaction (of which the outer caller
is not aware) silently marks a transaction as rollback-only, the outer caller still
calls commit. The outer caller needs to receive an <code>UnexpectedRollbackException</code> to
indicate clearly that a rollback was performed instead.</p>
</div>
</div>
<div class="sect4">
<h5 id="tx-propagation-requires_new"><a class="anchor" href="data-access.html#tx-propagation-requires_new"></a>RequiresNew</h5>
<div class="imageblock">
<div class="content">
<img src="images/tx_prop_requires_new.png" alt="tx prop requires new">
</div>
</div>
<div class="paragraph">
<p>PROPAGATION_REQUIRES_NEW</p>
</div>
<div class="paragraph">
<p><code>PROPAGATION_REQUIRES_NEW</code>, in contrast to <code>PROPAGATION_REQUIRED</code>, always uses an
<em>independent</em> physical transaction for each affected transaction scope, never
participating in an existing transaction for an outer scope. In such an arrangement,
the underlying resource transactions are different and hence can commit or roll back
independently, with an outer transaction not affected by an inner transaction&#8217;s rollback
status, and with an inner transaction&#8217;s locks released immediately after its completion.
Such an independent inner transaction may also declare its own isolation level, timeout
and read-only settings, never inheriting an outer transaction&#8217;s characteristics.</p>
</div>
</div>
<div class="sect4">
<h5 id="tx-propagation-nested"><a class="anchor" href="data-access.html#tx-propagation-nested"></a>Nested</h5>
<div class="paragraph">
<p><code>PROPAGATION_NESTED</code> uses a <em>single</em> physical transaction with multiple savepoints
that it can roll back to. Such partial rollbacks allow an inner transaction scope to
trigger a rollback <em>for its scope</em>, with the outer transaction being able to continue
the physical transaction despite some operations having been rolled back. This setting
is typically mapped onto JDBC savepoints, so will only work with JDBC resource
transactions. See Spring&#8217;s <code>DataSourceTransactionManager</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="transaction-declarative-applying-more-than-just-tx-advice"><a class="anchor" href="data-access.html#transaction-declarative-applying-more-than-just-tx-advice"></a>1.5.8. Advising transactional operations</h4>
<div class="paragraph">
<p>Suppose you want to execute <em>both</em> transactional <em>and</em> some basic profiling advice.
How do you effect this in the context of <code>&lt;tx:annotation-driven/&gt;</code>?</p>
</div>
<div class="paragraph">
<p>When you invoke the <code>updateFoo(Foo)</code> method, you want to see the following actions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configured profiling aspect starts up.</p>
</li>
<li>
<p>Transactional advice executes.</p>
</li>
<li>
<p>Method on the advised object executes.</p>
</li>
<li>
<p>Transaction commits.</p>
</li>
<li>
<p>Profiling aspect reports exact duration of the whole transactional method invocation.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This chapter is not concerned with explaining AOP in any great detail (except as it
applies to transactions). See <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop">AOP</a> for detailed coverage of the following AOP
configuration and AOP in general.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is the code for a simple profiling aspect discussed above. The ordering of advice
is controlled through the <code>Ordered</code> interface. For full details on advice ordering, see
<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop-ataspectj-advice-ordering">Advice ordering</a>.
.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">x.y</span>;

<span class="keyword">import</span> <span class="include">org.aspectj.lang.ProceedingJoinPoint</span>;
<span class="keyword">import</span> <span class="include">org.springframework.util.StopWatch</span>;
<span class="keyword">import</span> <span class="include">org.springframework.core.Ordered</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">SimpleProfiler</span> <span class="directive">implements</span> Ordered {

    <span class="directive">private</span> <span class="type">int</span> order;

    <span class="comment">// allows us to control the ordering of advice</span>
    <span class="directive">public</span> <span class="type">int</span> getOrder() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.order;
    }

    <span class="directive">public</span> <span class="type">void</span> setOrder(<span class="type">int</span> order) {
        <span class="local-variable">this</span>.order = order;
    }

    <span class="comment">// this method <strong>is</strong> the around advice</span>
    <span class="directive">public</span> <span class="predefined-type">Object</span> profile(ProceedingJoinPoint call) <span class="directive">throws</span> <span class="predefined-type">Throwable</span> {
        <span class="predefined-type">Object</span> returnValue;
        StopWatch clock = <span class="keyword">new</span> StopWatch(getClass().getName());
        <span class="keyword">try</span> {
            clock.start(call.toShortString());
            returnValue = call.proceed();
        } <span class="keyword">finally</span> {
            clock.stop();
            <span class="predefined-type">System</span>.out.println(clock.prettyPrint());
        }
        <span class="keyword">return</span> returnValue;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:aop</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/aop</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:tx</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/tx</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
        <span class="content">http://www.springframework.org/schema/beans</span>
        <span class="content">http://www.springframework.org/schema/beans/spring-beans.xsd</span>
        <span class="content">http://www.springframework.org/schema/tx</span>
        <span class="content">http://www.springframework.org/schema/tx/spring-tx.xsd</span>
        <span class="content">http://www.springframework.org/schema/aop</span>
        <span class="content">http://www.springframework.org/schema/aop/spring-aop.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooService</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">x.y.service.DefaultFooService</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- this is the aspect --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">profiler</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">x.y.SimpleProfiler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- execute before the transactional advice (hence the lower order number) --&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">order</span><span class="delimiter">&quot;</span></span> <span class="attribute-name"><em>value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="attribute-name"></em></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;tx:annotation-driven</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txManager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name"><em>order</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span><span class="attribute-name"></em></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;aop:config&gt;</span>
            <span class="comment">&lt;!-- this advice will execute around the transactional advice --&gt;</span>
            <span class="tag">&lt;aop:aspect</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">profilingAspect</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">profiler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;aop:pointcut</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">serviceMethodWithReturnValue</span><span class="delimiter">&quot;</span></span>
                        <span class="attribute-name">expression</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">execution(!void x.y..<strong>Service.</strong>(..))</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;aop:around</span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">profile</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">pointcut-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">serviceMethodWithReturnValue</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/aop:aspect&gt;</span>
    <span class="tag">&lt;/aop:config&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.commons.dbcp.BasicDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">destroy-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">close</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">driverClassName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">oracle.jdbc.driver.OracleDriver</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:oracle:thin:@rj-t42:1521:elvis</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">scott</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tiger</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txManager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.jdbc.datasource.DataSourceTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of the above configuration is a <code>fooService</code> bean that has profiling and
transactional aspects applied to it <em>in the desired order</em>. You configure any number
of additional aspects in similar fashion.</p>
</div>
<div class="paragraph">
<p>The following example effects the same setup as above, but uses the purely XML
declarative approach.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:aop</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/aop</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:tx</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/tx</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
        <span class="content">http://www.springframework.org/schema/beans</span>
        <span class="content">http://www.springframework.org/schema/beans/spring-beans.xsd</span>
        <span class="content">http://www.springframework.org/schema/tx</span>
        <span class="content">http://www.springframework.org/schema/tx/spring-tx.xsd</span>
        <span class="content">http://www.springframework.org/schema/aop</span>
        <span class="content">http://www.springframework.org/schema/aop/spring-aop.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fooService</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">x.y.service.DefaultFooService</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- the profiling advice --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">profiler</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">x.y.SimpleProfiler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- execute before the transactional advice (hence the lower order number) --&gt;</span>
        <em><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">order</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</em></span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;aop:config&gt;</span>
        <span class="tag">&lt;aop:pointcut</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">entryPointMethod</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">expression</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">execution(* x.y..<strong>Service.</strong>(..))</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="comment">&lt;!-- will execute after the profiling advice (c.f. the order attribute) --&gt;</span>

        <span class="tag">&lt;aop:advisor</span> <span class="attribute-name">advice-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txAdvice</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">pointcut-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">entryPointMethod</span><span class="delimiter">&quot;</span></span> <span class="attribute-name"><em>order</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</em></span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="comment">&lt;!-- order value is higher than the profiling aspect --&gt;</span>

        <span class="tag">&lt;aop:aspect</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">profilingAspect</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">profiler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;aop:pointcut</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">serviceMethodWithReturnValue</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">expression</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">execution(!void x.y..<strong>Service.</strong>(..))</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;aop:around</span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">profile</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">pointcut-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">serviceMethodWithReturnValue</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/aop:aspect&gt;</span>

    <span class="tag">&lt;/aop:config&gt;</span>

    <span class="tag">&lt;tx:advice</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txAdvice</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;tx:attributes&gt;</span>
            <span class="tag">&lt;tx:method</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">get*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">read-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;tx:method</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/tx:attributes&gt;</span>
    <span class="tag">&lt;/tx:advice&gt;</span>

    <span class="comment">&lt;!-- other &lt;bean/&gt; definitions such as a DataSource and a PlatformTransactionManager here --&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of the above configuration will be a <code>fooService</code> bean that has profiling and
transactional aspects applied to it <em>in that order</em>. If you want the profiling advice
to execute <em>after</em> the transactional advice on the way in, and <em>before</em> the
transactional advice on the way out, then you simply swap the value of the profiling
aspect bean&#8217;s <code>order</code> property so that it is higher than the transactional advice&#8217;s
order value.</p>
</div>
<div class="paragraph">
<p>You configure additional aspects in similar fashion.</p>
</div>
</div>
<div class="sect3">
<h4 id="transaction-declarative-aspectj"><a class="anchor" href="data-access.html#transaction-declarative-aspectj"></a>1.5.9. Using @Transactional with AspectJ</h4>
<div class="paragraph">
<p>It is also possible to use the Spring Framework&#8217;s <code>@Transactional</code> support outside of a
Spring container by means of an AspectJ aspect. To do so, you first annotate your
classes (and optionally your classes' methods) with the <code>@Transactional</code> annotation, and
then you link (weave) your application with the
<code>org.springframework.transaction.aspectj.AnnotationTransactionAspect</code> defined in the
<code>spring-aspects.jar</code> file. The aspect must also be configured with a transaction
manager. You can of course use the Spring Framework&#8217;s IoC container to take care of
dependency-injecting the aspect. The simplest way to configure the transaction
management aspect is to use the <code>&lt;tx:annotation-driven/&gt;</code> element and specify the <code>mode</code>
attribute to <code>aspectj</code> as described in <a href="data-access.html#transaction-declarative-annotations">Using @Transactional</a>. Because
we&#8217;re focusing here on applications running outside of a Spring container, we&#8217;ll show
you how to do it programmatically.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Prior to continuing, you may want to read <a href="data-access.html#transaction-declarative-annotations">Using @Transactional</a> and
<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop">AOP</a> respectively.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// construct an appropriate transaction manager</span>
DataSourceTransactionManager txManager = <span class="keyword">new</span> DataSourceTransactionManager(getDataSource());

<span class="comment">// configure the AnnotationTransactionAspect to use it; this must be done before executing any transactional methods</span>
AnnotationTransactionAspect.aspectOf().setTransactionManager(txManager);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When using this aspect, you must annotate the <em>implementation</em> class (and/or methods
within that class), <em>not</em> the interface (if any) that the class implements. AspectJ
follows Java&#8217;s rule that annotations on interfaces are <em>not inherited</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>@Transactional</code> annotation on a class specifies the default transaction semantics
for the execution of any method in the class.</p>
</div>
<div class="paragraph">
<p>The <code>@Transactional</code> annotation on a method within the class overrides the default
transaction semantics given by the class annotation (if present). Any method may be
annotated, regardless of visibility.</p>
</div>
<div class="paragraph">
<p>To weave your applications with the <code>AnnotationTransactionAspect</code> you must either build
your application with AspectJ (see the
<a href="https://www.eclipse.org/aspectj/doc/released/devguide/index.html">AspectJ Development
Guide</a>) or use load-time weaving. See <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop-aj-ltw">Load-time weaving with
AspectJ in the Spring Framework</a> for a discussion of load-time weaving with AspectJ.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="transaction-programmatic"><a class="anchor" href="data-access.html#transaction-programmatic"></a>1.6. Programmatic transaction management</h3>
<div class="paragraph">
<p>The Spring Framework provides two means of programmatic transaction management:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using the <code>TransactionTemplate</code>.</p>
</li>
<li>
<p>Using a <code>PlatformTransactionManager</code> implementation directly.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Spring team generally recommends the <code>TransactionTemplate</code> for programmatic
transaction management. The second approach is similar to using the JTA
<code>UserTransaction</code> API, although exception handling is less cumbersome.</p>
</div>
<div class="sect3">
<h4 id="tx-prog-template"><a class="anchor" href="data-access.html#tx-prog-template"></a>1.6.1. Using the TransactionTemplate</h4>
<div class="paragraph">
<p>The <code>TransactionTemplate</code> adopts the same approach as other Spring <em>templates</em> such as
the <code>JdbcTemplate</code>. It uses a callback approach, to free application code from having to
do the boilerplate acquisition and release of transactional resources, and results in
code that is intention driven, in that the code that is written focuses solely on what
the developer wants to do.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As you will see in the examples that follow, using the <code>TransactionTemplate</code> absolutely
couples you to Spring&#8217;s transaction infrastructure and APIs. Whether or not programmatic
transaction management is suitable for your development needs is a decision that you
will have to make yourself.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Application code that must execute in a transactional context, and that will use the
<code>TransactionTemplate</code> explicitly, looks like the following. You, as an application
developer, write a <code>TransactionCallback</code> implementation (typically expressed as an
anonymous inner class) that contains the code that you need to execute in the context of
a transaction. You then pass an instance of your custom <code>TransactionCallback</code> to the
<code>execute(..)</code> method exposed on the <code>TransactionTemplate</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SimpleService</span> <span class="directive">implements</span> Service {

    <span class="comment">// single TransactionTemplate shared amongst all methods in this instance</span>
    <span class="directive">private</span> <span class="directive">final</span> TransactionTemplate transactionTemplate;

    <span class="comment">// use constructor-injection to supply the PlatformTransactionManager</span>
    <span class="directive">public</span> SimpleService(PlatformTransactionManager transactionManager) {
        Assert.notNull(transactionManager, <span class="string"><span class="delimiter">&quot;</span><span class="content">The 'transactionManager' argument must not be null.</span><span class="delimiter">&quot;</span></span>);
        <span class="local-variable">this</span>.transactionTemplate = <span class="keyword">new</span> TransactionTemplate(transactionManager);
    }

    <span class="directive">public</span> <span class="predefined-type">Object</span> someServiceMethod() {
        <span class="keyword">return</span> transactionTemplate.execute(<span class="keyword">new</span> TransactionCallback() {
            <span class="comment">// the code in this method executes in a transactional context</span>
            <span class="directive">public</span> <span class="predefined-type">Object</span> doInTransaction(TransactionStatus status) {
                updateOperation1();
                <span class="keyword">return</span> resultOfUpdateOperation2();
            }
        });
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If there is no return value, use the convenient <code>TransactionCallbackWithoutResult</code> class
with an anonymous class as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">transactionTemplate.execute(<span class="keyword">new</span> <strong>TransactionCallbackWithoutResult</strong>() {
    <span class="directive">protected</span> <span class="type">void</span> doInTransactionWithoutResult(TransactionStatus status) {
        updateOperation1();
        updateOperation2();
    }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Code within the callback can roll the transaction back by calling the
<code>setRollbackOnly()</code> method on the supplied <code>TransactionStatus</code> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">transactionTemplate.execute(<span class="keyword">new</span> TransactionCallbackWithoutResult() {

    <span class="directive">protected</span> <span class="type">void</span> doInTransactionWithoutResult(TransactionStatus status) {
        <span class="keyword">try</span> {
            updateOperation1();
            updateOperation2();
        } <span class="keyword">catch</span> (SomeBusinessExeption ex) {
            <strong>status.setRollbackOnly();</strong>
        }
    }
});</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="tx-prog-template-settings"><a class="anchor" href="data-access.html#tx-prog-template-settings"></a>Specifying transaction settings</h5>
<div class="paragraph">
<p>You can specify transaction settings such as the propagation mode, the isolation level,
the timeout, and so forth on the <code>TransactionTemplate</code> either programmatically or in
configuration. <code>TransactionTemplate</code> instances by default have the
<a href="data-access.html#transaction-declarative-txadvice-settings">default transactional settings</a>. The
following example shows the programmatic customization of the transactional settings for
a specific <code>TransactionTemplate:</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SimpleService</span> <span class="directive">implements</span> Service {

    <span class="directive">private</span> <span class="directive">final</span> TransactionTemplate transactionTemplate;

    <span class="directive">public</span> SimpleService(PlatformTransactionManager transactionManager) {
        Assert.notNull(transactionManager, <span class="string"><span class="delimiter">&quot;</span><span class="content">The 'transactionManager' argument must not be null.</span><span class="delimiter">&quot;</span></span>);
        <span class="local-variable">this</span>.transactionTemplate = <span class="keyword">new</span> TransactionTemplate(transactionManager);

        <span class="comment">// the transaction settings can be set here explicitly if so desired</span>
        <span class="local-variable">this</span>.transactionTemplate.setIsolationLevel(TransactionDefinition.ISOLATION_READ_UNCOMMITTED);
        <span class="local-variable">this</span>.transactionTemplate.setTimeout(<span class="integer">30</span>); <span class="comment">// 30 seconds</span>
        <span class="comment">// and so forth...</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example defines a <code>TransactionTemplate</code> with some custom transactional
settings, using Spring XML configuration. The <code>sharedTransactionTemplate</code> can then be
injected into as many services as are required.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sharedTransactionTemplate</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.transaction.support.TransactionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">isolationLevelName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ISOLATION_READ_UNCOMMITTED</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">timeout</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, instances of the <code>TransactionTemplate</code> class are threadsafe, in that instances
do not maintain any conversational state. <code>TransactionTemplate</code> instances <em>do</em> however
maintain configuration state, so while a number of classes may share a single instance
of a <code>TransactionTemplate</code>, if a class needs to use a <code>TransactionTemplate</code> with
different settings (for example, a different isolation level), then you need to create
two distinct <code>TransactionTemplate</code> instances.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="transaction-programmatic-ptm"><a class="anchor" href="data-access.html#transaction-programmatic-ptm"></a>1.6.2. Using the PlatformTransactionManager</h4>
<div class="paragraph">
<p>You can also use the <code>org.springframework.transaction.PlatformTransactionManager</code>
directly to manage your transaction. Simply pass the implementation of the
<code>PlatformTransactionManager</code> you are using to your bean through a bean reference. Then,
using the <code>TransactionDefinition</code> and <code>TransactionStatus</code> objects you can initiate
transactions, roll back, and commit.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">DefaultTransactionDefinition def = <span class="keyword">new</span> DefaultTransactionDefinition();
<span class="comment">// explicitly setting the transaction name is something that can only be done programmatically</span>
def.setName(<span class="string"><span class="delimiter">&quot;</span><span class="content">SomeTxName</span><span class="delimiter">&quot;</span></span>);
def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);

TransactionStatus status = txManager.getTransaction(def);
<span class="keyword">try</span> {
    <span class="comment">// execute your business logic here</span>
}
<span class="keyword">catch</span> (MyException ex) {
    txManager.rollback(status);
    <span class="keyword">throw</span> ex;
}
txManager.commit(status);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tx-decl-vs-prog"><a class="anchor" href="data-access.html#tx-decl-vs-prog"></a>1.7. Choosing between programmatic and declarative transaction management</h3>
<div class="paragraph">
<p>Programmatic transaction management is usually a good idea only if you have a small
number of transactional operations. For example, if you have a web application that
require transactions only for certain update operations, you may not want to set up
transactional proxies using Spring or any other technology. In this case, using the
<code>TransactionTemplate</code> <em>may</em> be a good approach. Being able to set the transaction name
explicitly is also something that can only be done using the programmatic approach to
transaction management.</p>
</div>
<div class="paragraph">
<p>On the other hand, if your application has numerous transactional operations,
declarative transaction management is usually worthwhile. It keeps transaction
management out of business logic, and is not difficult to configure. When using the
Spring Framework, rather than EJB CMT, the configuration cost of declarative transaction
management is greatly reduced.</p>
</div>
</div>
<div class="sect2">
<h3 id="transaction-event"><a class="anchor" href="data-access.html#transaction-event"></a>1.8. Transaction bound event</h3>
<div class="paragraph">
<p>As of Spring 4.2, the listener of an event can be bound to a phase of the transaction. The
typical example is to handle the event when the transaction has completed successfully: this
allows events to be used with more flexibility when the outcome of the current transaction
actually matters to the listener.</p>
</div>
<div class="paragraph">
<p>Registering a regular event listener is done via the <code>@EventListener</code> annotation. If you need
to bind it to the transaction use <code>@TransactionalEventListener</code>. When you do so, the listener
will be bound to the commit phase of the transaction by default.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take an example to illustrate this concept. Assume that a component publishes an order
created event and we want to define a listener that should only handle that event once the
transaction in which it has been published has committed successfully:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyComponent</span> {

    <span class="annotation">@TransactionalEventListener</span>
    <span class="directive">public</span> <span class="type">void</span> handleOrderCreatedEvent(CreationEvent&lt;Order&gt; creationEvent) {
        ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>TransactionalEventListener</code> annotation exposes a <code>phase</code> attribute that allows us to customize
which phase of the transaction the listener should be bound to. The valid phases are <code>BEFORE_COMMIT</code>,
<code>AFTER_COMMIT</code> (default), <code>AFTER_ROLLBACK</code> and <code>AFTER_COMPLETION</code> that aggregates the transaction
completion (be it a commit or a rollback).</p>
</div>
<div class="paragraph">
<p>If no transaction is running, the listener is not invoked at all since we can&#8217;t honor the required
semantics. It is however possible to override that behaviour by setting the <code>fallbackExecution</code> attribute
of the annotation to <code>true</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="transaction-application-server-integration"><a class="anchor" href="data-access.html#transaction-application-server-integration"></a>1.9. Application server-specific integration</h3>
<div class="paragraph">
<p>Spring&#8217;s transaction abstraction generally is application server agnostic. Additionally,
Spring&#8217;s <code>JtaTransactionManager</code> class, which can optionally perform a JNDI lookup for
the JTA <code>UserTransaction</code> and <code>TransactionManager</code> objects, autodetects the location for
the latter object, which varies by application server. Having access to the JTA
<code>TransactionManager</code> allows for enhanced transaction semantics, in particular supporting
transaction suspension. See the <code>JtaTransactionManager</code> javadocs for details.</p>
</div>
<div class="paragraph">
<p>Spring&#8217;s <code>JtaTransactionManager</code> is the standard choice to run on Java EE application
servers, and is known to work on all common servers. Advanced functionality such as
transaction suspension works on many servers as well&#8201;&#8212;&#8201;including GlassFish, JBoss and
Geronimo&#8201;&#8212;&#8201;without any special configuration required. However, for fully supported
transaction suspension and further advanced integration, Spring ships special adapters
for WebLogic Server and WebSphere. These adapters are discussed in the following
sections.</p>
</div>
<div class="paragraph">
<p><em>For standard scenarios, including WebLogic Server and WebSphere, consider using the
convenient <code>&lt;tx:jta-transaction-manager/&gt;</code> configuration element.</em> When configured,
this element automatically detects the underlying server and chooses the best
transaction manager available for the platform. This means that you won&#8217;t have to
configure server-specific adapter classes (as discussed in the following sections)
explicitly; rather, they are chosen automatically, with the standard
<code>JtaTransactionManager</code> as default fallback.</p>
</div>
<div class="sect3">
<h4 id="transaction-application-server-integration-websphere"><a class="anchor" href="data-access.html#transaction-application-server-integration-websphere"></a>1.9.1. IBM WebSphere</h4>
<div class="paragraph">
<p>On WebSphere 6.1.0.9 and above, the recommended Spring JTA transaction manager to use is
<code>WebSphereUowTransactionManager</code>. This special adapter leverages IBM&#8217;s <code>UOWManager</code> API,
which is available in WebSphere Application Server 6.1.0.9 and later. With this adapter,
Spring-driven transaction suspension (suspend/resume as initiated by
<code>PROPAGATION_REQUIRES_NEW</code>) is officially supported by IBM.</p>
</div>
</div>
<div class="sect3">
<h4 id="transaction-application-server-integration-weblogic"><a class="anchor" href="data-access.html#transaction-application-server-integration-weblogic"></a>1.9.2. Oracle WebLogic Server</h4>
<div class="paragraph">
<p>On WebLogic Server 9.0 or above, you typically would use the
<code>WebLogicJtaTransactionManager</code> instead of the stock <code>JtaTransactionManager</code> class. This
special WebLogic-specific subclass of the normal <code>JtaTransactionManager</code> supports the
full power of Spring&#8217;s transaction definitions in a WebLogic-managed transaction
environment, beyond standard JTA semantics: Features include transaction names,
per-transaction isolation levels, and proper resuming of transactions in all cases.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="transaction-solutions-to-common-problems"><a class="anchor" href="data-access.html#transaction-solutions-to-common-problems"></a>1.10. Solutions to common problems</h3>
<div class="sect3">
<h4 id="transaction-solutions-to-common-problems-wrong-ptm"><a class="anchor" href="data-access.html#transaction-solutions-to-common-problems-wrong-ptm"></a>1.10.1. Use of the wrong transaction manager for a specific DataSource</h4>
<div class="paragraph">
<p>Use the <em>correct</em> <code>PlatformTransactionManager</code> implementation based on your choice of
transactional technologies and requirements. Used properly, the Spring Framework merely
provides a straightforward and portable abstraction. If you are using global
transactions, you <em>must</em> use the
<code>org.springframework.transaction.jta.JtaTransactionManager</code> class (or an
<a href="data-access.html#transaction-application-server-integration">application server-specific subclass</a> of
it) for all your transactional operations. Otherwise the transaction infrastructure
attempts to perform local transactions on resources such as container <code>DataSource</code>
instances. Such local transactions do not make sense, and a good application server
treats them as errors.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="transaction-resources"><a class="anchor" href="data-access.html#transaction-resources"></a>1.11. Further resources</h3>
<div class="paragraph">
<p>For more information about the Spring Framework&#8217;s transaction support:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.javaworld.com/javaworld/jw-01-2009/jw-01-spring-transactions.html">Distributed
transactions in Spring, with and without XA</a> is a JavaWorld presentation in which
Spring&#8217;s David Syer guides you through seven patterns for distributed
transactions in Spring applications, three of them with XA and four without.</p>
</li>
<li>
<p><a href="http://www.infoq.com/minibooks/JTDS">Java Transaction Design Strategies</a> is a book
available from <a href="http://www.infoq.com/">InfoQ</a> that provides a well-paced introduction
to transactions in Java. It also includes side-by-side examples of how to configure
and use transactions with both the Spring Framework and EJB3.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="dao"><a class="anchor" href="data-access.html#dao"></a>2. DAO support</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="dao-introduction"><a class="anchor" href="data-access.html#dao-introduction"></a>2.1. Introduction</h3>
<div class="paragraph">
<p>The Data Access Object (DAO) support in Spring is aimed at making it easy to work with
data access technologies like JDBC, Hibernate or JPA in a consistent way. This
allows one to switch between the aforementioned persistence technologies fairly easily
and it also allows one to code without worrying about catching exceptions that are
specific to each technology.</p>
</div>
</div>
<div class="sect2">
<h3 id="dao-exceptions"><a class="anchor" href="data-access.html#dao-exceptions"></a>2.2. Consistent exception hierarchy</h3>
<div class="paragraph">
<p>Spring provides a convenient translation from technology-specific exceptions like
<code>SQLException</code> to its own exception class hierarchy with the <code>DataAccessException</code> as
the root exception. These exceptions wrap the original exception so there is never any
risk that one might lose any information as to what might have gone wrong.</p>
</div>
<div class="paragraph">
<p>In addition to JDBC exceptions, Spring can also wrap Hibernate-specific exceptions,
converting them to a set of focused runtime exceptions (the same is true for JPA
exceptions). This allows one to handle most persistence exceptions, which are
non-recoverable, only in the appropriate layers, without having annoying boilerplate
catch-and-throw blocks and exception declarations in one&#8217;s DAOs. (One can still trap
and handle exceptions anywhere one needs to though.) As mentioned above, JDBC
exceptions (including database-specific dialects) are also converted to the same
hierarchy, meaning that one can perform some operations with JDBC within a consistent
programming model.</p>
</div>
<div class="paragraph">
<p>The above holds true for the various template classes in Springs support for various ORM
frameworks. If one uses the interceptor-based classes then the application must care
about handling <code>HibernateExceptions</code> and <code>PersistenceExceptions</code> itself, preferably via
delegating to <code>SessionFactoryUtils&#8217; `convertHibernateAccessException(..)</code> or
<code>convertJpaAccessException()</code> methods respectively. These methods convert the exceptions
to ones that are compatible with the exceptions in the <code>org.springframework.dao</code>
exception hierarchy. As <code>PersistenceExceptions</code> are unchecked, they can simply get
thrown too, sacrificing generic DAO abstraction in terms of exceptions though.</p>
</div>
<div class="paragraph">
<p>The exception hierarchy that Spring provides can be seen below. (Please note that the
class hierarchy detailed in the image shows only a subset of the entire
<code>DataAccessException</code> hierarchy.)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/DataAccessException.png" alt="DataAccessException">
</div>
</div>
</div>
<div class="sect2">
<h3 id="dao-annotations"><a class="anchor" href="data-access.html#dao-annotations"></a>2.3. Annotations used for configuring DAO or Repository classes</h3>
<div class="paragraph">
<p>The best way to guarantee that your Data Access Objects (DAOs) or repositories provide
exception translation is to use the <code>@Repository</code> annotation. This annotation also
allows the component scanning support to find and configure your DAOs and repositories
without having to provide XML configuration entries for them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><strong><span class="annotation">@Repository</span></strong>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SomeMovieFinder</span> <span class="directive">implements</span> MovieFinder {
    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any DAO or repository implementation will need to access to a persistence resource,
depending on the persistence technology used; for example, a JDBC-based repository will
need access to a JDBC <code>DataSource</code>; a JPA-based repository will need access to an
<code>EntityManager</code>. The easiest way to accomplish this is to have this resource dependency
injected using one of the <code>@Autowired,</code>, <code>@Inject</code>, <code>@Resource</code> or <code>@PersistenceContext</code>
annotations. Here is an example for a JPA repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Repository</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JpaMovieFinder</span> <span class="directive">implements</span> MovieFinder {

    <span class="annotation">@PersistenceContext</span>
    <span class="directive">private</span> EntityManager entityManager;

    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are using the classic Hibernate APIs than you can inject the SessionFactory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Repository</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">HibernateMovieFinder</span> <span class="directive">implements</span> MovieFinder {

    <span class="directive">private</span> SessionFactory sessionFactory;

    <span class="annotation">@Autowired</span>
    <span class="directive">public</span> <span class="type">void</span> setSessionFactory(SessionFactory sessionFactory) {
        <span class="local-variable">this</span>.sessionFactory = sessionFactory;
    }

    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Last example we will show here is for typical JDBC support. You would have the
<code>DataSource</code> injected into an initialization method where you would create a
<code>JdbcTemplate</code> and other data access support classes like <code>SimpleJdbcCall</code> etc using
this <code>DataSource</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Repository</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JdbcMovieFinder</span> <span class="directive">implements</span> MovieFinder {

    <span class="directive">private</span> JdbcTemplate jdbcTemplate;

    <span class="annotation">@Autowired</span>
    <span class="directive">public</span> <span class="type">void</span> init(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
    }

    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Please see the specific coverage of each persistence technology for details on how to
configure the application context to take advantage of these annotations.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jdbc"><a class="anchor" href="data-access.html#jdbc"></a>3. Data access with JDBC</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="jdbc-introduction"><a class="anchor" href="data-access.html#jdbc-introduction"></a>3.1. Introduction to Spring Framework JDBC</h3>
<div class="paragraph">
<p>The value-add provided by the Spring Framework JDBC abstraction is perhaps best shown by
the sequence of actions outlined in the table below. The table shows what actions Spring
will take care of and which actions are the responsibility of you, the application
developer.</p>
</div>
<table id="jdbc-who-does-what" class="tableblock frame-all grid-all spread">
<caption class="title">Table 4. Spring JDBC - who does what?</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Action</th>
<th class="tableblock halign-left valign-top">Spring</th>
<th class="tableblock halign-left valign-top">You</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define connection parameters.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Open the connection.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the SQL statement.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare parameters and provide parameter values</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prepare and execute the statement.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set up the loop to iterate through the results (if any).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do the work for each iteration.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Process any exception.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Handle transactions.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Close the connection, statement and resultset.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The Spring Framework takes care of all the low-level details that can make JDBC such a
tedious API to develop with.</p>
</div>
<div class="sect3">
<h4 id="jdbc-choose-style"><a class="anchor" href="data-access.html#jdbc-choose-style"></a>3.1.1. Choosing an approach for JDBC database access</h4>
<div class="paragraph">
<p>You can choose among several approaches to form the basis for your JDBC database access.
In addition to three flavors of the JdbcTemplate, a new SimpleJdbcInsert and
SimplejdbcCall approach optimizes database metadata, and the RDBMS Object style takes a
more object-oriented approach similar to that of JDO Query design. Once you start using
one of these approaches, you can still mix and match to include a feature from a
different approach. All approaches require a JDBC 2.0-compliant driver, and some
advanced features require a JDBC 3.0 driver.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>JdbcTemplate</em> is the classic Spring JDBC approach and the most popular. This
"lowest level" approach and all others use a JdbcTemplate under the covers.</p>
</li>
<li>
<p><em>NamedParameterJdbcTemplate</em> wraps a <code>JdbcTemplate</code> to provide named parameters
instead of the traditional JDBC "?" placeholders. This approach provides better
documentation and ease of use when you have multiple parameters for an SQL statement.</p>
</li>
<li>
<p><em>SimpleJdbcInsert and SimpleJdbcCall</em> optimize database metadata to limit the amount
of necessary configuration. This approach simplifies coding so that you only need to
provide the name of the table or procedure and provide a map of parameters matching
the column names. This only works if the database provides adequate metadata. If the
database doesn&#8217;t provide this metadata, you will have to provide explicit
configuration of the parameters.</p>
</li>
<li>
<p><em>RDBMS Objects including MappingSqlQuery, SqlUpdate and StoredProcedure</em> requires
you to create reusable and thread-safe objects during initialization of your data
access layer. This approach is modeled after JDO Query wherein you define your query
string, declare parameters, and compile the query. Once you do that, execute methods
can be called multiple times with various parameter values passed in.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-packages"><a class="anchor" href="data-access.html#jdbc-packages"></a>3.1.2. Package hierarchy</h4>
<div class="paragraph">
<p>The Spring Framework&#8217;s JDBC abstraction framework consists of four different packages,
namely <code>core</code>, <code>datasource</code>, <code>object</code>, and <code>support</code>.</p>
</div>
<div class="paragraph">
<p>The <code>org.springframework.jdbc.core</code> package contains the <code>JdbcTemplate</code> class and its
various callback interfaces, plus a variety of related classes. A subpackage named
<code>org.springframework.jdbc.core.simple</code> contains the <code>SimpleJdbcInsert</code> and
<code>SimpleJdbcCall</code> classes. Another subpackage named
<code>org.springframework.jdbc.core.namedparam</code> contains the <code>NamedParameterJdbcTemplate</code>
class and the related support classes. See <a href="data-access.html#jdbc-core">Using the JDBC core classes to control basic JDBC processing and error handling</a>, <a href="data-access.html#jdbc-advanced-jdbc">JDBC batch operations</a>, and
<a href="data-access.html#jdbc-simple-jdbc">Simplifying JDBC operations with the SimpleJdbc classes</a>.</p>
</div>
<div class="paragraph">
<p>The <code>org.springframework.jdbc.datasource</code> package contains a utility class for easy
<code>DataSource</code> access, and various simple <code>DataSource</code> implementations that can be used for
testing and running unmodified JDBC code outside of a Java EE container. A subpackage
named <code>org.springfamework.jdbc.datasource.embedded</code> provides support for creating
embedded databases using Java database engines such as HSQL, H2, and Derby. See
<a href="data-access.html#jdbc-connections">Controlling database connections</a> and <a href="data-access.html#jdbc-embedded-database-support">Embedded database support</a>.</p>
</div>
<div class="paragraph">
<p>The <code>org.springframework.jdbc.object</code> package contains classes that represent RDBMS
queries, updates, and stored procedures as thread-safe, reusable objects. See
<a href="data-access.html#jdbc-object">Modeling JDBC operations as Java objects</a>. This approach is modeled by JDO, although objects returned by queries
are naturally <em>disconnected</em> from the database. This higher level of JDBC abstraction
depends on the lower-level abstraction in the <code>org.springframework.jdbc.core</code> package.</p>
</div>
<div class="paragraph">
<p>The <code>org.springframework.jdbc.support</code> package provides <code>SQLException</code> translation
functionality and some utility classes. Exceptions thrown during JDBC processing are
translated to exceptions defined in the <code>org.springframework.dao</code> package. This means
that code using the Spring JDBC abstraction layer does not need to implement JDBC or
RDBMS-specific error handling. All translated exceptions are unchecked, which gives you
the option of catching the exceptions from which you can recover while allowing other
exceptions to be propagated to the caller. See <a href="data-access.html#jdbc-SQLExceptionTranslator">SQLExceptionTranslator</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jdbc-core"><a class="anchor" href="data-access.html#jdbc-core"></a>3.2. Using the JDBC core classes to control basic JDBC processing and error handling</h3>
<div class="sect3">
<h4 id="jdbc-JdbcTemplate"><a class="anchor" href="data-access.html#jdbc-JdbcTemplate"></a>3.2.1. JdbcTemplate</h4>
<div class="paragraph">
<p>The <code>JdbcTemplate</code> class is the central class in the JDBC core package. It handles the
creation and release of resources, which helps you avoid common errors such as
forgetting to close the connection. It performs the basic tasks of the core JDBC
workflow such as statement creation and execution, leaving application code to provide
SQL and extract results. The <code>JdbcTemplate</code> class executes SQL queries, update
statements and stored procedure calls, performs iteration over <code>ResultSet</code>s and
extraction of returned parameter values. It also catches JDBC exceptions and translates
them to the generic, more informative, exception hierarchy defined in the
<code>org.springframework.dao</code> package.</p>
</div>
<div class="paragraph">
<p>When you use the <code>JdbcTemplate</code> for your code, you only need to implement callback
interfaces, giving them a clearly defined contract. The <code>PreparedStatementCreator</code>
callback interface creates a prepared statement given a <code>Connection</code> provided by this
class, providing SQL and any necessary parameters. The same is true for the
<code>CallableStatementCreator</code> interface, which creates callable statements. The
<code>RowCallbackHandler</code> interface extracts values from each row of a <code>ResultSet</code>.</p>
</div>
<div class="paragraph">
<p>The <code>JdbcTemplate</code> can be used within a DAO implementation through direct instantiation
with a <code>DataSource</code> reference, or be configured in a Spring IoC container and given to
DAOs as a bean reference.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>DataSource</code> should always be configured as a bean in the Spring IoC container. In
the first case the bean is given to the service directly; in the second case it is given
to the prepared template.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All SQL issued by this class is logged at the <code>DEBUG</code> level under the category
corresponding to the fully qualified class name of the template instance (typically
<code>JdbcTemplate</code>, but it may be different if you are using a custom subclass of the
<code>JdbcTemplate</code> class).</p>
</div>
<div class="sect4">
<h5 id="jdbc-JdbcTemplate-examples"><a class="anchor" href="data-access.html#jdbc-JdbcTemplate-examples"></a>Examples of JdbcTemplate class usage</h5>
<div class="paragraph">
<p>This section provides some examples of <code>JdbcTemplate</code> class usage. These examples are
not an exhaustive list of all of the functionality exposed by the <code>JdbcTemplate</code>; see
the attendant javadocs for that.</p>
</div>
<div class="sect5">
<h6 id="jdbc-JdbcTemplate-examples-query"><a class="anchor" href="data-access.html#jdbc-JdbcTemplate-examples-query"></a>Querying (SELECT)</h6>
<div class="paragraph">
<p>Here is a simple query for getting the number of rows in a relation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">int</span> rowCount = <span class="local-variable">this</span>.jdbcTemplate.queryForObject(<span class="string"><span class="delimiter">&quot;</span><span class="content">select count(*) from t_actor</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Integer</span>.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>A simple query using a bind variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">int</span> countOfActorsNamedJoe = <span class="local-variable">this</span>.jdbcTemplate.queryForObject(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">select count(*) from t_actor where first_name = ?</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Integer</span>.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Querying for a <code>String</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> lastName = <span class="local-variable">this</span>.jdbcTemplate.queryForObject(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">select last_name from t_actor where id = ?</span><span class="delimiter">&quot;</span></span>,
        <span class="keyword">new</span> <span class="predefined-type">Object</span><span class="type">[]</span>{<span class="integer">1212L</span>}, <span class="predefined-type">String</span>.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Querying and populating a <em>single</em> domain object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Actor actor = <span class="local-variable">this</span>.jdbcTemplate.queryForObject(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">select first_name, last_name from t_actor where id = ?</span><span class="delimiter">&quot;</span></span>,
        <span class="keyword">new</span> <span class="predefined-type">Object</span><span class="type">[]</span>{<span class="integer">1212L</span>},
        <span class="keyword">new</span> <span class="predefined-type">RowMapper</span>&lt;Actor&gt;() {
            <span class="directive">public</span> Actor mapRow(<span class="predefined-type">ResultSet</span> rs, <span class="type">int</span> rowNum) <span class="directive">throws</span> <span class="exception">SQLException</span> {
                Actor actor = <span class="keyword">new</span> Actor();
                actor.setFirstName(rs.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>));
                actor.setLastName(rs.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>));
                <span class="keyword">return</span> actor;
            }
        });</code></pre>
</div>
</div>
<div class="paragraph">
<p>Querying and populating a number of domain objects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;Actor&gt; actors = <span class="local-variable">this</span>.jdbcTemplate.query(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">select first_name, last_name from t_actor</span><span class="delimiter">&quot;</span></span>,
        <span class="keyword">new</span> <span class="predefined-type">RowMapper</span>&lt;Actor&gt;() {
            <span class="directive">public</span> Actor mapRow(<span class="predefined-type">ResultSet</span> rs, <span class="type">int</span> rowNum) <span class="directive">throws</span> <span class="exception">SQLException</span> {
                Actor actor = <span class="keyword">new</span> Actor();
                actor.setFirstName(rs.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>));
                actor.setLastName(rs.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>));
                <span class="keyword">return</span> actor;
            }
        });</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the last two snippets of code actually existed in the same application, it would make
sense to remove the duplication present in the two <code>RowMapper</code> anonymous inner classes,
and extract them out into a single class (typically a <code>static</code> nested class) that can
then be referenced by DAO methods as needed. For example, it may be better to write the
last code snippet as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="predefined-type">List</span>&lt;Actor&gt; findAllActors() {
    <span class="keyword">return</span> <span class="local-variable">this</span>.jdbcTemplate.query( <span class="string"><span class="delimiter">&quot;</span><span class="content">select first_name, last_name from t_actor</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> ActorMapper());
}

<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">ActorMapper</span> <span class="directive">implements</span> <span class="predefined-type">RowMapper</span>&lt;Actor&gt; {

    <span class="directive">public</span> Actor mapRow(<span class="predefined-type">ResultSet</span> rs, <span class="type">int</span> rowNum) <span class="directive">throws</span> <span class="exception">SQLException</span> {
        Actor actor = <span class="keyword">new</span> Actor();
        actor.setFirstName(rs.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>));
        actor.setLastName(rs.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>));
        <span class="keyword">return</span> actor;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="jdbc-JdbcTemplate-examples-update"><a class="anchor" href="data-access.html#jdbc-JdbcTemplate-examples-update"></a>Updating (INSERT/UPDATE/DELETE) with JdbcTemplate</h6>
<div class="paragraph">
<p>You use the <code>update(..)</code> method to perform insert, update and delete operations.
Parameter values are usually provided as var args or alternatively as an object array.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="local-variable">this</span>.jdbcTemplate.update(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">insert into t_actor (first_name, last_name) values (?, ?)</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Leonor</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Watling</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="local-variable">this</span>.jdbcTemplate.update(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">update t_actor set last_name = ? where id = ?</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Banjo</span><span class="delimiter">&quot;</span></span>, <span class="integer">5276L</span>);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="local-variable">this</span>.jdbcTemplate.update(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">delete from actor where id = ?</span><span class="delimiter">&quot;</span></span>,
        <span class="predefined-type">Long</span>.valueOf(actorId));</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="jdbc-JdbcTemplate-examples-other"><a class="anchor" href="data-access.html#jdbc-JdbcTemplate-examples-other"></a>Other JdbcTemplate operations</h6>
<div class="paragraph">
<p>You can use the <code>execute(..)</code> method to execute any arbitrary SQL, and as such the
method is often used for DDL statements. It is heavily overloaded with variants taking
callback interfaces, binding variable arrays, and so on.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="local-variable">this</span>.jdbcTemplate.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">create table mytable (id integer, name varchar(100))</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example invokes a simple stored procedure. More sophisticated stored
procedure support is <a href="data-access.html#jdbc-StoredProcedure">covered later</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="local-variable">this</span>.jdbcTemplate.update(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">call SUPPORT.REFRESH_ACTORS_SUMMARY(?)</span><span class="delimiter">&quot;</span></span>,
        <span class="predefined-type">Long</span>.valueOf(unionId));</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="jdbc-JdbcTemplate-idioms"><a class="anchor" href="data-access.html#jdbc-JdbcTemplate-idioms"></a>JdbcTemplate best practices</h5>
<div class="paragraph">
<p>Instances of the <code>JdbcTemplate</code> class are <em>threadsafe once configured</em>. This is
important because it means that you can configure a single instance of a <code>JdbcTemplate</code>
and then safely inject this <em>shared</em> reference into multiple DAOs (or repositories).
The <code>JdbcTemplate</code> is stateful, in that it maintains a reference to a <code>DataSource</code>, but
this state is <em>not</em> conversational state.</p>
</div>
<div class="paragraph">
<p>A common practice when using the <code>JdbcTemplate</code> class (and the associated
<a href="data-access.html#jdbc-NamedParameterJdbcTemplate"><code>NamedParameterJdbcTemplate</code></a> classes) is to
configure a <code>DataSource</code> in your Spring configuration file, and then dependency-inject
that shared <code>DataSource</code> bean into your DAO classes; the <code>JdbcTemplate</code> is created in
the setter for the <code>DataSource</code>. This leads to DAOs that look in part like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">JdbcCorporateEventDao</span> <span class="directive">implements</span> CorporateEventDao {

    <span class="directive">private</span> JdbcTemplate jdbcTemplate;

    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        <strong><span class="local-variable">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);</strong>
    }

    <span class="comment">// JDBC-backed implementations of the methods on the CorporateEventDao follow...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The corresponding configuration might look like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
        <span class="content">http://www.springframework.org/schema/beans</span>
        <span class="content">http://www.springframework.org/schema/beans/spring-beans.xsd</span>
        <span class="content">http://www.springframework.org/schema/context</span>
        <span class="content">http://www.springframework.org/schema/context/spring-context.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">corporateEventDao</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.JdbcCorporateEventDao</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.commons.dbcp.BasicDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">destroy-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">close</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">driverClassName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.driverClassName}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.url}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.username}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.password}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;context:property-placeholder</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc.properties</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>An alternative to explicit configuration is to use component-scanning and annotation
support for dependency injection. In this case you annotate the class with <code>@Repository</code>
(which makes it a candidate for component-scanning) and annotate the <code>DataSource</code> setter
method with <code>@Autowired</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><strong><span class="annotation">@Repository</span></strong>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JdbcCorporateEventDao</span> <span class="directive">implements</span> CorporateEventDao {

    <span class="directive">private</span> JdbcTemplate jdbcTemplate;

    <strong><span class="annotation">@Autowired</span></strong>
    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        <strong><span class="local-variable">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);</strong>
    }

    <span class="comment">// JDBC-backed implementations of the methods on the CorporateEventDao follow...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The corresponding XML configuration file would look like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
        <span class="content">http://www.springframework.org/schema/beans</span>
        <span class="content">http://www.springframework.org/schema/beans/spring-beans.xsd</span>
        <span class="content">http://www.springframework.org/schema/context</span>
        <span class="content">http://www.springframework.org/schema/context/spring-context.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- Scans within the base package of the application for @Component classes to configure as beans --&gt;</span>
    <span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.docs.test</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.commons.dbcp.BasicDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">destroy-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">close</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">driverClassName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.driverClassName}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.url}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.username}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.password}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;context:property-placeholder</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc.properties</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are using Spring&#8217;s <code>JdbcDaoSupport</code> class, and your various JDBC-backed DAO classes
extend from it, then your sub-class inherits a <code>setDataSource(..)</code> method from the
<code>JdbcDaoSupport</code> class. You can choose whether to inherit from this class. The
<code>JdbcDaoSupport</code> class is provided as a convenience only.</p>
</div>
<div class="paragraph">
<p>Regardless of which of the above template initialization styles you choose to use (or
not), it is seldom necessary to create a new instance of a <code>JdbcTemplate</code> class each
time you want to execute SQL. Once configured, a <code>JdbcTemplate</code> instance is threadsafe.
You may want multiple <code>JdbcTemplate</code> instances if your application accesses multiple
databases, which requires multiple <code>DataSources</code>, and subsequently multiple differently
configured <code>JdbcTemplates</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-NamedParameterJdbcTemplate"><a class="anchor" href="data-access.html#jdbc-NamedParameterJdbcTemplate"></a>3.2.2. NamedParameterJdbcTemplate</h4>
<div class="paragraph">
<p>The <code>NamedParameterJdbcTemplate</code> class adds support for programming JDBC statements
using named parameters, as opposed to programming JDBC statements using only classic
placeholder ( <code>'?'</code>) arguments. The <code>NamedParameterJdbcTemplate</code> class wraps a
<code>JdbcTemplate</code>, and delegates to the wrapped <code>JdbcTemplate</code> to do much of its work. This
section describes only those areas of the <code>NamedParameterJdbcTemplate</code> class that differ
from the <code>JdbcTemplate</code> itself; namely, programming JDBC statements using named
parameters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// some JDBC-backed DAO class...</span>
<span class="directive">private</span> NamedParameterJdbcTemplate namedParameterJdbcTemplate;

<span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
    <span class="local-variable">this</span>.namedParameterJdbcTemplate = <span class="keyword">new</span> NamedParameterJdbcTemplate(dataSource);
}

<span class="directive">public</span> <span class="type">int</span> countOfActorsByFirstName(<span class="predefined-type">String</span> firstName) {

    <span class="predefined-type">String</span> sql = <span class="string"><span class="delimiter">&quot;</span><span class="content">select count(*) from T_ACTOR where first_name = :first_name</span><span class="delimiter">&quot;</span></span>;

    SqlParameterSource namedParameters = <span class="keyword">new</span> MapSqlParameterSource(<span class="string"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>, firstName);

    <span class="keyword">return</span> <span class="local-variable">this</span>.namedParameterJdbcTemplate.queryForObject(sql, namedParameters, <span class="predefined-type">Integer</span>.class);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the use of the named parameter notation in the value assigned to the <code>sql</code>
variable, and the corresponding value that is plugged into the <code>namedParameters</code>
variable (of type <code>MapSqlParameterSource</code>).</p>
</div>
<div class="paragraph">
<p>Alternatively, you can pass along named parameters and their corresponding values to a
<code>NamedParameterJdbcTemplate</code> instance by using the <code>Map</code>-based style.The remaining
methods exposed by the <code>NamedParameterJdbcOperations</code> and implemented by the
<code>NamedParameterJdbcTemplate</code> class follow a similar pattern and are not covered here.</p>
</div>
<div class="paragraph">
<p>The following example shows the use of the <code>Map</code>-based style.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// some JDBC-backed DAO class...</span>
<span class="directive">private</span> NamedParameterJdbcTemplate namedParameterJdbcTemplate;

<span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
    <span class="local-variable">this</span>.namedParameterJdbcTemplate = <span class="keyword">new</span> NamedParameterJdbcTemplate(dataSource);
}

<span class="directive">public</span> <span class="type">int</span> countOfActorsByFirstName(<span class="predefined-type">String</span> firstName) {

    <span class="predefined-type">String</span> sql = <span class="string"><span class="delimiter">&quot;</span><span class="content">select count(*) from T_ACTOR where first_name = :first_name</span><span class="delimiter">&quot;</span></span>;

    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; namedParameters = <span class="predefined-type">Collections</span>.singletonMap(<span class="string"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>, firstName);

    <span class="keyword">return</span> <span class="local-variable">this</span>.namedParameterJdbcTemplate.queryForObject(sql, namedParameters,  <span class="predefined-type">Integer</span>.class);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>One nice feature related to the <code>NamedParameterJdbcTemplate</code> (and existing in the same
Java package) is the <code>SqlParameterSource</code> interface. You have already seen an example of
an implementation of this interface in one of the previous code snippet (the
<code>MapSqlParameterSource</code> class). An <code>SqlParameterSource</code> is a source of named parameter
values to a <code>NamedParameterJdbcTemplate</code>. The <code>MapSqlParameterSource</code> class is a very
simple implementation that is simply an adapter around a <code>java.util.Map</code>, where the keys
are the parameter names and the values are the parameter values.</p>
</div>
<div class="paragraph">
<p>Another <code>SqlParameterSource</code> implementation is the <code>BeanPropertySqlParameterSource</code>
class. This class wraps an arbitrary JavaBean (that is, an instance of a class that
adheres to <a href="http://www.oracle.com/technetwork/java/javase/documentation/spec-136004.html">the
JavaBean conventions</a>), and uses the properties of the wrapped JavaBean as the source
of named parameter values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Actor</span> {

    <span class="directive">private</span> <span class="predefined-type">Long</span> id;
    <span class="directive">private</span> <span class="predefined-type">String</span> firstName;
    <span class="directive">private</span> <span class="predefined-type">String</span> lastName;

    <span class="directive">public</span> <span class="predefined-type">String</span> getFirstName() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.firstName;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getLastName() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.lastName;
    }

    <span class="directive">public</span> <span class="predefined-type">Long</span> getId() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.id;
    }

    <span class="comment">// setters omitted...</span>

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// some JDBC-backed DAO class...</span>
<span class="directive">private</span> NamedParameterJdbcTemplate namedParameterJdbcTemplate;

<span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
    <span class="local-variable">this</span>.namedParameterJdbcTemplate = <span class="keyword">new</span> NamedParameterJdbcTemplate(dataSource);
}

<span class="directive">public</span> <span class="type">int</span> countOfActors(Actor exampleActor) {

    <span class="comment">// notice how the named parameters match the properties of the above 'Actor' class</span>
    <span class="predefined-type">String</span> sql = <span class="string"><span class="delimiter">&quot;</span><span class="content">select count(*) from T_ACTOR where first_name = :firstName and last_name = :lastName</span><span class="delimiter">&quot;</span></span>;

    SqlParameterSource namedParameters = <span class="keyword">new</span> BeanPropertySqlParameterSource(exampleActor);

    <span class="keyword">return</span> <span class="local-variable">this</span>.namedParameterJdbcTemplate.queryForObject(sql, namedParameters, <span class="predefined-type">Integer</span>.class);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that the <code>NamedParameterJdbcTemplate</code> class <em>wraps</em> a classic <code>JdbcTemplate</code>
template; if you need access to the wrapped <code>JdbcTemplate</code> instance to access
functionality only present in the <code>JdbcTemplate</code> class, you can use the
<code>getJdbcOperations()</code> method to access the wrapped <code>JdbcTemplate</code> through the
<code>JdbcOperations</code> interface.</p>
</div>
<div class="paragraph">
<p>See also <a href="data-access.html#jdbc-JdbcTemplate-idioms">JdbcTemplate best practices</a> for guidelines on using the
<code>NamedParameterJdbcTemplate</code> class in the context of an application.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-SQLExceptionTranslator"><a class="anchor" href="data-access.html#jdbc-SQLExceptionTranslator"></a>3.2.3. SQLExceptionTranslator</h4>
<div class="paragraph">
<p><code>SQLExceptionTranslator</code> is an interface to be implemented by classes that can translate
between <code>SQLExceptions</code> and Spring&#8217;s own <code>org.springframework.dao.DataAccessException</code>,
which is agnostic in regard to data access strategy. Implementations can be generic (for
example, using SQLState codes for JDBC) or proprietary (for example, using Oracle error
codes) for greater precision.</p>
</div>
<div class="paragraph">
<p><code>SQLErrorCodeSQLExceptionTranslator</code> is the implementation of <code>SQLExceptionTranslator</code>
that is used by default. This implementation uses specific vendor codes. It is more
precise than the <code>SQLState</code> implementation. The error code translations are based on
codes held in a JavaBean type class called <code>SQLErrorCodes</code>. This class is created and
populated by an <code>SQLErrorCodesFactory</code> which as the name suggests is a factory for
creating <code>SQLErrorCodes</code> based on the contents of a configuration file named
<code>sql-error-codes.xml</code>. This file is populated with vendor codes and based on the
<code>DatabaseProductName</code> taken from the <code>DatabaseMetaData</code>. The codes for the actual
database you are using are used.</p>
</div>
<div class="paragraph">
<p>The <code>SQLErrorCodeSQLExceptionTranslator</code> applies matching rules in the following sequence:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>SQLErrorCodesFactory</code> is used by default to define Error codes and custom exception
translations. They are looked up in a file named <code>sql-error-codes.xml</code> from the
classpath and the matching <code>SQLErrorCodes</code> instance is located based on the database
name from the database metadata of the database in use.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Any custom translation implemented by a subclass. Normally the provided concrete
<code>SQLErrorCodeSQLExceptionTranslator</code> is used so this rule does not apply. It only
applies if you have actually provided a subclass implementation.</p>
</li>
<li>
<p>Any custom implementation of the <code>SQLExceptionTranslator</code> interface that is provided
as the <code>customSqlExceptionTranslator</code> property of the <code>SQLErrorCodes</code> class.</p>
</li>
<li>
<p>The list of instances of the <code>CustomSQLErrorCodesTranslation</code> class, provided for the
<code>customTranslations</code> property of the <code>SQLErrorCodes</code> class, are searched for a match.</p>
</li>
<li>
<p>Error code matching is applied.</p>
</li>
<li>
<p>Use the fallback translator. <code>SQLExceptionSubclassTranslator</code> is the default fallback
translator. If this translation is not available then the next fallback translator is
the <code>SQLStateSQLExceptionTranslator</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can extend <code>SQLErrorCodeSQLExceptionTranslator:</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CustomSQLErrorCodesTranslator</span> <span class="directive">extends</span> SQLErrorCodeSQLExceptionTranslator {

    <span class="directive">protected</span> DataAccessException customTranslate(<span class="predefined-type">String</span> task, <span class="predefined-type">String</span> sql, <span class="exception">SQLException</span> sqlex) {
        <span class="keyword">if</span> (sqlex.getErrorCode() == -<span class="integer">12345</span>) {
            <span class="keyword">return</span> <span class="keyword">new</span> DeadlockLoserDataAccessException(task, sqlex);
        }
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the specific error code <code>-12345</code> is translated and other errors are
left to be translated by the default translator implementation. To use this custom
translator, it is necessary to pass it to the <code>JdbcTemplate</code> through the method
<code>setExceptionTranslator</code> and to use this <code>JdbcTemplate</code> for all of the data access
processing where this translator is needed. Here is an example of how this custom
translator can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> JdbcTemplate jdbcTemplate;

<span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {

    <span class="comment">// create a JdbcTemplate and set data source</span>
    <span class="local-variable">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate();
    <span class="local-variable">this</span>.jdbcTemplate.setDataSource(dataSource);

    <span class="comment">// create a custom translator and set the DataSource for the default translation lookup</span>
    CustomSQLErrorCodesTranslator tr = <span class="keyword">new</span> CustomSQLErrorCodesTranslator();
    tr.setDataSource(dataSource);
    <span class="local-variable">this</span>.jdbcTemplate.setExceptionTranslator(tr);

}

<span class="directive">public</span> <span class="type">void</span> updateShippingCharge(<span class="type">long</span> orderId, <span class="type">long</span> pct) {
    <span class="comment">// use the prepared JdbcTemplate for this update</span>
    <span class="local-variable">this</span>.jdbcTemplate.update(<span class="string"><span class="delimiter">&quot;</span><span class="content">update orders</span><span class="delimiter">&quot;</span></span> +
        <span class="string"><span class="delimiter">&quot;</span><span class="content"> set shipping_charge = shipping_charge * ? / 100</span><span class="delimiter">&quot;</span></span> +
        <span class="string"><span class="delimiter">&quot;</span><span class="content"> where id = ?</span><span class="delimiter">&quot;</span></span>, pct, orderId);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The custom translator is passed a data source in order to look up the error codes in
<code>sql-error-codes.xml</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-statements-executing"><a class="anchor" href="data-access.html#jdbc-statements-executing"></a>3.2.4. Executing statements</h4>
<div class="paragraph">
<p>Executing an SQL statement requires very little code. You need a <code>DataSource</code> and a
<code>JdbcTemplate</code>, including the convenience methods that are provided with the
<code>JdbcTemplate</code>. The following example shows what you need to include for a minimal but
fully functional class that creates a new table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.sql.DataSource</span>;
<span class="keyword">import</span> <span class="include">org.springframework.jdbc.core.JdbcTemplate</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">ExecuteAStatement</span> {

    <span class="directive">private</span> JdbcTemplate jdbcTemplate;

    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
    }

    <span class="directive">public</span> <span class="type">void</span> doExecute() {
        <span class="local-variable">this</span>.jdbcTemplate.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">create table mytable (id integer, name varchar(100))</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-statements-querying"><a class="anchor" href="data-access.html#jdbc-statements-querying"></a>3.2.5. Running queries</h4>
<div class="paragraph">
<p>Some query methods return a single value. To retrieve a count or a specific value from
one row, use <code>queryForObject(..)</code>. The latter converts the returned JDBC <code>Type</code> to the
Java class that is passed in as an argument. If the type conversion is invalid, then an
<code>InvalidDataAccessApiUsageException</code> is thrown. Here is an example that contains two
query methods, one for an <code>int</code> and one that queries for a <code>String</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.sql.DataSource</span>;
<span class="keyword">import</span> <span class="include">org.springframework.jdbc.core.JdbcTemplate</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">RunAQuery</span> {

    <span class="directive">private</span> JdbcTemplate jdbcTemplate;

    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
    }

    <span class="directive">public</span> <span class="type">int</span> getCount() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jdbcTemplate.queryForObject(<span class="string"><span class="delimiter">&quot;</span><span class="content">select count(*) from mytable</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Integer</span>.class);
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jdbcTemplate.queryForObject(<span class="string"><span class="delimiter">&quot;</span><span class="content">select name from mytable</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">String</span>.class);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to the single result query methods, several methods return a list with an
entry for each row that the query returned. The most generic method is
<code>queryForList(..)</code> which returns a <code>List</code> where each entry is a <code>Map</code> with each entry in
the map representing the column value for that row. If you add a method to the above
example to retrieve a list of all the rows, it would look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> JdbcTemplate jdbcTemplate;

<span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
    <span class="local-variable">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
}

<span class="directive">public</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;&gt; getList() {
    <span class="keyword">return</span> <span class="local-variable">this</span>.jdbcTemplate.queryForList(<span class="string"><span class="delimiter">&quot;</span><span class="content">select * from mytable</span><span class="delimiter">&quot;</span></span>);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The list returned would look something like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[{name=Bob, id=1}, {name=Mary, id=2}]</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-updates"><a class="anchor" href="data-access.html#jdbc-updates"></a>3.2.6. Updating the database</h4>
<div class="paragraph">
<p>The following example shows a column updated for a certain primary key. In this example,
an SQL statement has placeholders for row parameters. The parameter values can be passed
in as varargs or alternatively as an array of objects. Thus primitives should be wrapped
in the primitive wrapper classes explicitly or using auto-boxing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.sql.DataSource</span>;

<span class="keyword">import</span> <span class="include">org.springframework.jdbc.core.JdbcTemplate</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">ExecuteAnUpdate</span> {

    <span class="directive">private</span> JdbcTemplate jdbcTemplate;

    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
    }

    <span class="directive">public</span> <span class="type">void</span> setName(<span class="type">int</span> id, <span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.jdbcTemplate.update(<span class="string"><span class="delimiter">&quot;</span><span class="content">update mytable set name = ? where id = ?</span><span class="delimiter">&quot;</span></span>, name, id);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-auto-genereted-keys"><a class="anchor" href="data-access.html#jdbc-auto-genereted-keys"></a>3.2.7. Retrieving auto-generated keys</h4>
<div class="paragraph">
<p>An <code>update()</code> convenience method supports the retrieval of primary keys generated by the
database. This support is part of the JDBC 3.0 standard; see Chapter 13.6 of the
specification for details. The method takes a <code>PreparedStatementCreator</code> as its first
argument, and this is the way the required insert statement is specified. The other
argument is a <code>KeyHolder</code>, which contains the generated key on successful return from the
update. There is not a standard single way to create an appropriate <code>PreparedStatement</code>
(which explains why the method signature is the way it is). The following example works
on Oracle but may not work on other platforms:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">final</span> <span class="predefined-type">String</span> INSERT_SQL = <span class="string"><span class="delimiter">&quot;</span><span class="content">insert into my_test (name) values(?)</span><span class="delimiter">&quot;</span></span>;
<span class="directive">final</span> <span class="predefined-type">String</span> name = <span class="string"><span class="delimiter">&quot;</span><span class="content">Rob</span><span class="delimiter">&quot;</span></span>;

KeyHolder keyHolder = <span class="keyword">new</span> GeneratedKeyHolder();
jdbcTemplate.update(
    <span class="keyword">new</span> PreparedStatementCreator() {
        <span class="directive">public</span> <span class="predefined-type">PreparedStatement</span> createPreparedStatement(<span class="predefined-type">Connection</span> connection) <span class="directive">throws</span> <span class="exception">SQLException</span> {
            <span class="predefined-type">PreparedStatement</span> ps = connection.prepareStatement(INSERT_SQL, <span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>});
            ps.setString(<span class="integer">1</span>, name);
            <span class="keyword">return</span> ps;
        }
    },
    keyHolder);

<span class="comment">// keyHolder.getKey() now contains the generated key</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jdbc-connections"><a class="anchor" href="data-access.html#jdbc-connections"></a>3.3. Controlling database connections</h3>
<div class="sect3">
<h4 id="jdbc-datasource"><a class="anchor" href="data-access.html#jdbc-datasource"></a>3.3.1. DataSource</h4>
<div class="paragraph">
<p>Spring obtains a connection to the database through a <code>DataSource</code>. A <code>DataSource</code> is
part of the JDBC specification and is a generalized connection factory. It allows a
container or a framework to hide connection pooling and transaction management issues
from the application code. As a developer, you need not know details about how to
connect to the database; that is the responsibility of the administrator that sets up
the datasource. You most likely fill both roles as you develop and test code, but you do
not necessarily have to know how the production data source is configured.</p>
</div>
<div class="paragraph">
<p>When using Spring&#8217;s JDBC layer, you obtain a data source from JNDI or you configure your
own with a connection pool implementation provided by a third party. Popular
implementations are Apache Jakarta Commons DBCP and C3P0. Implementations in the Spring
distribution are meant only for testing purposes and do not provide pooling.</p>
</div>
<div class="paragraph">
<p>This section uses Spring&#8217;s <code>DriverManagerDataSource</code> implementation, and several
additional implementations are covered later.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Only use the <code>DriverManagerDataSource</code> class should only be used for testing purposes
since it does not provide pooling and will perform poorly when multiple requests for a
connection are made.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You obtain a connection with <code>DriverManagerDataSource</code> as you typically obtain a JDBC
connection. Specify the fully qualified classname of the JDBC driver so that the
<code>DriverManager</code> can load the driver class. Next, provide a URL that varies between JDBC
drivers. (Consult the documentation for your driver for the correct value.) Then provide
a username and a password to connect to the database. Here is an example of how to
configure a <code>DriverManagerDataSource</code> in Java code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();
dataSource.setDriverClassName(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hsqldb.jdbcDriver</span><span class="delimiter">&quot;</span></span>);
dataSource.setUrl(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:hsqldb:hsql://localhost:</span><span class="delimiter">&quot;</span></span>);
dataSource.setUsername(<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span>);
dataSource.setPassword(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the corresponding XML configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">&lt;bean id=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="type">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.jdbc.datasource.DriverManagerDataSource</span><span class="delimiter">&quot;</span></span>&gt;
    &lt;<span class="class">property</span> name=<span class="string"><span class="delimiter">&quot;</span><span class="content">driverClassName</span><span class="delimiter">&quot;</span></span> value=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.driverClassName}</span><span class="delimiter">&quot;</span></span>/&gt;
    &lt;property name=<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span> value=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.url}</span><span class="delimiter">&quot;</span></span>/&gt;
    &lt;property name=<span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span> value=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.username}</span><span class="delimiter">&quot;</span></span>/&gt;
    &lt;property name=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> value=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.password}</span><span class="delimiter">&quot;</span></span>/&gt;
&lt;/bean&gt;

&lt;context:property-placeholder location=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc.properties</span><span class="delimiter">&quot;</span></span>/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following examples show the basic connectivity and configuration for DBCP and C3P0.
To learn about more options that help control the pooling features, see the product
documentation for the respective connection pooling implementations.</p>
</div>
<div class="paragraph">
<p>DBCP configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">&lt;bean id=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="type">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.commons.dbcp.BasicDataSource</span><span class="delimiter">&quot;</span></span> <span class="class">destroy</span>-method=<span class="string"><span class="delimiter">&quot;</span><span class="content">close</span><span class="delimiter">&quot;</span></span>&gt;
    &lt;property name=<span class="string"><span class="delimiter">&quot;</span><span class="content">driverClassName</span><span class="delimiter">&quot;</span></span> value=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.driverClassName}</span><span class="delimiter">&quot;</span></span>/&gt;
    &lt;property name=<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span> value=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.url}</span><span class="delimiter">&quot;</span></span>/&gt;
    &lt;property name=<span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span> value=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.username}</span><span class="delimiter">&quot;</span></span>/&gt;
    &lt;property name=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> value=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.password}</span><span class="delimiter">&quot;</span></span>/&gt;
&lt;/bean&gt;

&lt;context:property-placeholder location=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc.properties</span><span class="delimiter">&quot;</span></span>/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>C3P0 configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">&lt;bean id=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="type">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mchange.v2.c3p0.ComboPooledDataSource</span><span class="delimiter">&quot;</span></span> <span class="class">destroy</span>-method=<span class="string"><span class="delimiter">&quot;</span><span class="content">close</span><span class="delimiter">&quot;</span></span>&gt;
    &lt;property name=<span class="string"><span class="delimiter">&quot;</span><span class="content">driverClass</span><span class="delimiter">&quot;</span></span> value=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.driverClassName}</span><span class="delimiter">&quot;</span></span>/&gt;
    &lt;property name=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbcUrl</span><span class="delimiter">&quot;</span></span> value=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.url}</span><span class="delimiter">&quot;</span></span>/&gt;
    &lt;property name=<span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span> value=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.username}</span><span class="delimiter">&quot;</span></span>/&gt;
    &lt;property name=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> value=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.password}</span><span class="delimiter">&quot;</span></span>/&gt;
&lt;/bean&gt;

&lt;context:property-placeholder location=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc.properties</span><span class="delimiter">&quot;</span></span>/&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-DataSourceUtils"><a class="anchor" href="data-access.html#jdbc-DataSourceUtils"></a>3.3.2. DataSourceUtils</h4>
<div class="paragraph">
<p>The <code>DataSourceUtils</code> class is a convenient and powerful helper class that provides
<code>static</code> methods to obtain connections from JNDI and close connections if necessary. It
supports thread-bound connections with, for example, <code>DataSourceTransactionManager</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-SmartDataSource"><a class="anchor" href="data-access.html#jdbc-SmartDataSource"></a>3.3.3. SmartDataSource</h4>
<div class="paragraph">
<p>The <code>SmartDataSource</code> interface should be implemented by classes that can provide a
connection to a relational database. It extends the <code>DataSource</code> interface to allow
classes using it to query whether the connection should be closed after a given
operation. This usage is efficient when you know that you will reuse a connection.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-AbstractDataSource"><a class="anchor" href="data-access.html#jdbc-AbstractDataSource"></a>3.3.4. AbstractDataSource</h4>
<div class="paragraph">
<p><code>AbstractDataSource</code> is an <code>abstract</code> base class for Spring&#8217;s <code>DataSource</code>
implementations that implements code that is common to all <code>DataSource</code> implementations.
You extend the <code>AbstractDataSource</code> class if you are writing your own <code>DataSource</code>
implementation.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-SingleConnectionDataSource"><a class="anchor" href="data-access.html#jdbc-SingleConnectionDataSource"></a>3.3.5. SingleConnectionDataSource</h4>
<div class="paragraph">
<p>The <code>SingleConnectionDataSource</code> class is an implementation of the <code>SmartDataSource</code>
interface that wraps a <em>single</em> <code>Connection</code> that is <em>not</em> closed after each use.
Obviously, this is not multi-threading capable.</p>
</div>
<div class="paragraph">
<p>If any client code calls <code>close</code> in the assumption of a pooled connection, as when using
persistence tools, set the <code>suppressClose</code> property to <code>true</code>. This setting returns a
close-suppressing proxy wrapping the physical connection. Be aware that you will not be
able to cast this to a native Oracle <code>Connection</code> or the like anymore.</p>
</div>
<div class="paragraph">
<p>This is primarily a test class. For example, it enables easy testing of code outside an
application server, in conjunction with a simple JNDI environment. In contrast to
<code>DriverManagerDataSource</code>, it reuses the same connection all the time, avoiding
excessive creation of physical connections.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-DriverManagerDataSource"><a class="anchor" href="data-access.html#jdbc-DriverManagerDataSource"></a>3.3.6. DriverManagerDataSource</h4>
<div class="paragraph">
<p>The <code>DriverManagerDataSource</code> class is an implementation of the standard <code>DataSource</code>
interface that configures a plain JDBC driver through bean properties, and returns a new
<code>Connection</code> every time.</p>
</div>
<div class="paragraph">
<p>This implementation is useful for test and stand-alone environments outside of a Java EE
container, either as a <code>DataSource</code> bean in a Spring IoC container, or in conjunction
with a simple JNDI environment. Pool-assuming <code>Connection.close()</code> calls will simply
close the connection, so any <code>DataSource</code>-aware persistence code should work. However,
using JavaBean-style connection pools such as <code>commons-dbcp</code> is so easy, even in a test
environment, that it is almost always preferable to use such a connection pool over
<code>DriverManagerDataSource</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-TransactionAwareDataSourceProxy"><a class="anchor" href="data-access.html#jdbc-TransactionAwareDataSourceProxy"></a>3.3.7. TransactionAwareDataSourceProxy</h4>
<div class="paragraph">
<p><code>TransactionAwareDataSourceProxy</code> is a proxy for a target <code>DataSource</code>, which wraps that
target <code>DataSource</code> to add awareness of Spring-managed transactions. In this respect, it
is similar to a transactional JNDI <code>DataSource</code> as provided by a Java EE server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is rarely desirable to use this class, except when already existing code that must be
called and passed a standard JDBC <code>DataSource</code> interface implementation. In this case,
it&#8217;s possible to still have this code be usable, and at the same time have this code
participating in Spring managed transactions. It is generally preferable to write your
own new code using the higher level abstractions for resource management, such as
<code>JdbcTemplate</code> or <code>DataSourceUtils</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>(See the <code>TransactionAwareDataSourceProxy</code> javadocs for more details.)</em></p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-DataSourceTransactionManager"><a class="anchor" href="data-access.html#jdbc-DataSourceTransactionManager"></a>3.3.8. DataSourceTransactionManager</h4>
<div class="paragraph">
<p>The <code>DataSourceTransactionManager</code> class is a <code>PlatformTransactionManager</code>
implementation for single JDBC datasources. It binds a JDBC connection from the
specified data source to the currently executing thread, potentially allowing for one
thread connection per data source.</p>
</div>
<div class="paragraph">
<p>Application code is required to retrieve the JDBC connection through
<code>DataSourceUtils.getConnection(DataSource)</code> instead of Java EE&#8217;s standard
<code>DataSource.getConnection</code>. It throws unchecked <code>org.springframework.dao</code> exceptions
instead of checked <code>SQLExceptions</code>. All framework classes like <code>JdbcTemplate</code> use this
strategy implicitly. If not used with this transaction manager, the lookup strategy
behaves exactly like the common one - it can thus be used in any case.</p>
</div>
<div class="paragraph">
<p>The <code>DataSourceTransactionManager</code> class supports custom isolation levels, and timeouts
that get applied as appropriate JDBC statement query timeouts. To support the latter,
application code must either use <code>JdbcTemplate</code> or call the
<code>DataSourceUtils.applyTransactionTimeout(..)</code> method for each created statement.</p>
</div>
<div class="paragraph">
<p>This implementation can be used instead of <code>JtaTransactionManager</code> in the single
resource case, as it does not require the container to support JTA. Switching between
both is just a matter of configuration, if you stick to the required connection lookup
pattern. JTA does not support custom isolation levels!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jdbc-advanced-jdbc"><a class="anchor" href="data-access.html#jdbc-advanced-jdbc"></a>3.4. JDBC batch operations</h3>
<div class="paragraph">
<p>Most JDBC drivers provide improved performance if you batch multiple calls to the same
prepared statement. By grouping updates into batches you limit the number of round trips
to the database.</p>
</div>
<div class="sect3">
<h4 id="jdbc-batch-classic"><a class="anchor" href="data-access.html#jdbc-batch-classic"></a>3.4.1. Basic batch operations with the JdbcTemplate</h4>
<div class="paragraph">
<p>You accomplish <code>JdbcTemplate</code> batch processing by implementing two methods of a special
interface, <code>BatchPreparedStatementSetter</code>, and passing that in as the second parameter
in your <code>batchUpdate</code> method call. Use the <code>getBatchSize</code> method to provide the size of
the current batch. Use the <code>setValues</code> method to set the values for the parameters of
the prepared statement. This method will be called the number of times that you
specified in the <code>getBatchSize</code> call. The following example updates the actor table
based on entries in a list. The entire list is used as the batch in this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">JdbcActorDao</span> <span class="directive">implements</span> ActorDao {

    <span class="directive">private</span> JdbcTemplate jdbcTemplate;

    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
    }

    <span class="directive">public</span> <span class="type">int</span><span class="type">[]</span> batchUpdate(<span class="directive">final</span> <span class="predefined-type">List</span>&lt;Actor&gt; actors) {
        <span class="keyword">return</span> <span class="local-variable">this</span>.jdbcTemplate.batchUpdate(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">update t_actor set first_name = ?, last_name = ? where id = ?</span><span class="delimiter">&quot;</span></span>,
                <span class="keyword">new</span> BatchPreparedStatementSetter() {
                    <span class="directive">public</span> <span class="type">void</span> setValues(<span class="predefined-type">PreparedStatement</span> ps, <span class="type">int</span> i) <span class="directive">throws</span> <span class="exception">SQLException</span> {
                        ps.setString(<span class="integer">1</span>, actors.get(i).getFirstName());
                        ps.setString(<span class="integer">2</span>, actors.get(i).getLastName());
                        ps.setLong(<span class="integer">3</span>, actors.get(i).getId().longValue());
                    }
                    <span class="directive">public</span> <span class="type">int</span> getBatchSize() {
                        <span class="keyword">return</span> actors.size();
                    }
                });
    }

    <span class="comment">// ... additional methods</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are processing a stream of updates or reading from a file, then you might have a
preferred batch size, but the last batch might not have that number of entries. In this
case you can use the <code>InterruptibleBatchPreparedStatementSetter</code> interface, which allows
you to interrupt a batch once the input source is exhausted. The <code>isBatchExhausted</code> method
allows you to signal the end of the batch.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-batch-list"><a class="anchor" href="data-access.html#jdbc-batch-list"></a>3.4.2. Batch operations with a List of objects</h4>
<div class="paragraph">
<p>Both the <code>JdbcTemplate</code> and the <code>NamedParameterJdbcTemplate</code> provides an alternate way
of providing the batch update. Instead of implementing a special batch interface, you
provide all parameter values in the call as a list. The framework loops over these
values and uses an internal prepared statement setter. The API varies depending on
whether you use named parameters. For the named parameters you provide an array of
<code>SqlParameterSource</code>, one entry for each member of the batch. You can use the
<code>SqlParameterSourceUtils.createBatch</code> convenience methods to create this array, passing
in an array of bean-style objects (with getter methods corresponding to parameters)
and/or String-keyed Maps (containing the corresponding parameters as values).</p>
</div>
<div class="paragraph">
<p>This example shows a batch update using named parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">JdbcActorDao</span> <span class="directive">implements</span> ActorDao {

    <span class="directive">private</span> NamedParameterTemplate namedParameterJdbcTemplate;

    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">this</span>.namedParameterJdbcTemplate = <span class="keyword">new</span> NamedParameterJdbcTemplate(dataSource);
    }

    <span class="directive">public</span> <span class="type">int</span><span class="type">[]</span> batchUpdate(<span class="predefined-type">List</span>&lt;Actor&gt; actors) {
        <span class="keyword">return</span> <span class="local-variable">this</span>.namedParameterJdbcTemplate.batchUpdate(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">update t_actor set first_name = :firstName, last_name = :lastName where id = :id</span><span class="delimiter">&quot;</span></span>,
                SqlParameterSourceUtils.createBatch(actors));
    }

    <span class="comment">// ... additional methods</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For an SQL statement using the classic "?" placeholders, you pass in a list containing an
object array with the update values. This object array must have one entry for each
placeholder in the SQL statement, and they must be in the same order as they are defined
in the SQL statement.</p>
</div>
<div class="paragraph">
<p>The same example using classic JDBC "?" placeholders:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">JdbcActorDao</span> <span class="directive">implements</span> ActorDao {

    <span class="directive">private</span> JdbcTemplate jdbcTemplate;

    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
    }

    <span class="directive">public</span> <span class="type">int</span><span class="type">[]</span> batchUpdate(<span class="directive">final</span> <span class="predefined-type">List</span>&lt;Actor&gt; actors) {
        <span class="predefined-type">List</span>&lt;<span class="predefined-type">Object</span><span class="type">[]</span>&gt; batch = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;<span class="predefined-type">Object</span><span class="type">[]</span>&gt;();
        <span class="keyword">for</span> (Actor actor : actors) {
            <span class="predefined-type">Object</span><span class="type">[]</span> values = <span class="keyword">new</span> <span class="predefined-type">Object</span><span class="type">[]</span> {
                    actor.getFirstName(), actor.getLastName(), actor.getId()};
            batch.add(values);
        }
        <span class="keyword">return</span> <span class="local-variable">this</span>.jdbcTemplate.batchUpdate(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">update t_actor set first_name = ?, last_name = ? where id = ?</span><span class="delimiter">&quot;</span></span>,
                batch);
    }

    <span class="comment">// ... additional methods</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All of the above batch update methods return an int array containing the number of
affected rows for each batch entry. This count is reported by the JDBC driver. If the
count is not available, the JDBC driver returns a -2 value.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In such a scenario with automatic setting of values on an underlying <code>PreparedStatement</code>,
the corresponding JDBC type for each value needs to be derived from the given Java type.
While this usually works well, there is a potential for issues, e.g. with Map-contained
<code>null</code> values: Spring will by default call <code>ParameterMetaData.getParameterType</code> in such a
case which may be expensive with your JDBC driver. Please make sure to use a recent driver
version, and consider setting the "spring.jdbc.getParameterType.ignore" property to "true"
(as a JVM system property or in a <code>spring.properties</code> file in the root of your classpath)
if you encounter a performance issue, e.g. as reported on Oracle 12c (SPR-16139).</p>
</div>
<div class="paragraph">
<p>Alternatively, simply consider specifying the corresponding JDBC types explicitly:
either via a 'BatchPreparedStatementSetter' as shown above, or via an explicit type
array given to a 'List&lt;Object[]&gt;' based call, or via 'registerSqlType' calls on a
custom 'MapSqlParameterSource' instance, or via a 'BeanPropertySqlParameterSource'
which derives the SQL type from the Java-declared property type even for a null value.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-batch-multi"><a class="anchor" href="data-access.html#jdbc-batch-multi"></a>3.4.3. Batch operations with multiple batches</h4>
<div class="paragraph">
<p>The last example of a batch update deals with batches that are so large that you want to
break them up into several smaller batches. You can of course do this with the methods
mentioned above by making multiple calls to the <code>batchUpdate</code> method, but there is now a
more convenient method. This method takes, in addition to the SQL statement, a
Collection of objects containing the parameters, the number of updates to make for each
batch and a <code>ParameterizedPreparedStatementSetter</code> to set the values for the parameters
of the prepared statement. The framework loops over the provided values and breaks the
update calls into batches of the size specified.</p>
</div>
<div class="paragraph">
<p>This example shows a batch update using a batch size of 100:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">JdbcActorDao</span> <span class="directive">implements</span> ActorDao {

    <span class="directive">private</span> JdbcTemplate jdbcTemplate;

    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
    }

    <span class="directive">public</span> <span class="type">int</span><span class="type">[]</span><span class="type">[]</span> batchUpdate(<span class="directive">final</span> <span class="predefined-type">Collection</span>&lt;Actor&gt; actors) {
        <span class="type">int</span><span class="type">[]</span><span class="type">[]</span> updateCounts = jdbcTemplate.batchUpdate(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">update t_actor set first_name = ?, last_name = ? where id = ?</span><span class="delimiter">&quot;</span></span>,
                actors,
                <span class="integer">100</span>,
                <span class="keyword">new</span> ParameterizedPreparedStatementSetter&lt;Actor&gt;() {
                    <span class="directive">public</span> <span class="type">void</span> setValues(<span class="predefined-type">PreparedStatement</span> ps, Actor argument) <span class="directive">throws</span> <span class="exception">SQLException</span> {
                        ps.setString(<span class="integer">1</span>, argument.getFirstName());
                        ps.setString(<span class="integer">2</span>, argument.getLastName());
                        ps.setLong(<span class="integer">3</span>, argument.getId().longValue());
                    }
                });
        <span class="keyword">return</span> updateCounts;
    }

    <span class="comment">// ... additional methods</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The batch update methods for this call returns an array of int arrays containing an array
entry for each batch with an array of the number of affected rows for each update. The top
level array&#8217;s length indicates the number of batches executed and the second level array&#8217;s
length indicates the number of updates in that batch. The number of updates in each batch
should be the batch size provided for all batches except for the last one that might
be less, depending on the total number of update objects provided. The update count for
each update statement is the one reported by the JDBC driver. If the count is not
available, the JDBC driver returns a -2 value.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jdbc-simple-jdbc"><a class="anchor" href="data-access.html#jdbc-simple-jdbc"></a>3.5. Simplifying JDBC operations with the SimpleJdbc classes</h3>
<div class="paragraph">
<p>The <code>SimpleJdbcInsert</code> and <code>SimpleJdbcCall</code> classes provide a simplified configuration
by taking advantage of database metadata that can be retrieved through the JDBC driver.
This means there is less to configure up front, although you can override or turn off
the metadata processing if you prefer to provide all the details in your code.</p>
</div>
<div class="sect3">
<h4 id="jdbc-simple-jdbc-insert-1"><a class="anchor" href="data-access.html#jdbc-simple-jdbc-insert-1"></a>3.5.1. Inserting data using SimpleJdbcInsert</h4>
<div class="paragraph">
<p>Let&#8217;s start by looking at the <code>SimpleJdbcInsert</code> class with the minimal amount of
configuration options. You should instantiate the <code>SimpleJdbcInsert</code> in the data access
layer&#8217;s initialization method. For this example, the initializing method is the
<code>setDataSource</code> method. You do not need to subclass the <code>SimpleJdbcInsert</code> class; simply
create a new instance and set the table name using the <code>withTableName</code> method.
Configuration methods for this class follow the "fluid" style that returns the instance
of the <code>SimpleJdbcInsert</code>, which allows you to chain all configuration methods. This
example uses only one configuration method; you will see examples of multiple ones later.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">JdbcActorDao</span> <span class="directive">implements</span> ActorDao {

    <span class="directive">private</span> JdbcTemplate jdbcTemplate;
    <span class="directive">private</span> SimpleJdbcInsert insertActor;

    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
        <span class="local-variable">this</span>.insertActor = <span class="keyword">new</span> SimpleJdbcInsert(dataSource).withTableName(<span class="string"><span class="delimiter">&quot;</span><span class="content">t_actor</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="directive">public</span> <span class="type">void</span> add(Actor actor) {
        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; parameters = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;(<span class="integer">3</span>);
        parameters.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, actor.getId());
        parameters.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>, actor.getFirstName());
        parameters.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>, actor.getLastName());
        insertActor.execute(parameters);
    }

    <span class="comment">// ... additional methods</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The execute method used here takes a plain <code>java.utils.Map</code> as its only parameter. The
important thing to note here is that the keys used for the Map must match the column
names of the table as defined in the database. This is because we read the metadata in
order to construct the actual insert statement.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-simple-jdbc-insert-2"><a class="anchor" href="data-access.html#jdbc-simple-jdbc-insert-2"></a>3.5.2. Retrieving auto-generated keys using SimpleJdbcInsert</h4>
<div class="paragraph">
<p>This example uses the same insert as the preceding, but instead of passing in the id it
retrieves the auto-generated key and sets it on the new Actor object. When you create
the <code>SimpleJdbcInsert</code>, in addition to specifying the table name, you specify the name
of the generated key column with the <code>usingGeneratedKeyColumns</code> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">JdbcActorDao</span> <span class="directive">implements</span> ActorDao {

    <span class="directive">private</span> JdbcTemplate jdbcTemplate;
    <span class="directive">private</span> SimpleJdbcInsert insertActor;

    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
        <span class="local-variable">this</span>.insertActor = <span class="keyword">new</span> SimpleJdbcInsert(dataSource)
                .withTableName(<span class="string"><span class="delimiter">&quot;</span><span class="content">t_actor</span><span class="delimiter">&quot;</span></span>)
                .usingGeneratedKeyColumns(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="directive">public</span> <span class="type">void</span> add(Actor actor) {
        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; parameters = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;(<span class="integer">2</span>);
        parameters.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>, actor.getFirstName());
        parameters.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>, actor.getLastName());
        <span class="predefined-type">Number</span> newId = insertActor.executeAndReturnKey(parameters);
        actor.setId(newId.longValue());
    }

    <span class="comment">// ... additional methods</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The main difference when executing the insert by this second approach is that you do not
add the id to the Map and you call the <code>executeAndReturnKey</code> method. This returns a
<code>java.lang.Number</code> object with which you can create an instance of the numerical type that
is used in our domain class. You cannot rely on all databases to return a specific Java
class here; <code>java.lang.Number</code> is the base class that you can rely on. If you have
multiple auto-generated columns, or the generated values are non-numeric, then you can
use a <code>KeyHolder</code> that is returned from the <code>executeAndReturnKeyHolder</code> method.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-simple-jdbc-insert-3"><a class="anchor" href="data-access.html#jdbc-simple-jdbc-insert-3"></a>3.5.3. Specifying columns for a SimpleJdbcInsert</h4>
<div class="paragraph">
<p>You can limit the columns for an insert by specifying a list of column names with the
<code>usingColumns</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">JdbcActorDao</span> <span class="directive">implements</span> ActorDao {

    <span class="directive">private</span> JdbcTemplate jdbcTemplate;
    <span class="directive">private</span> SimpleJdbcInsert insertActor;

    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
        <span class="local-variable">this</span>.insertActor = <span class="keyword">new</span> SimpleJdbcInsert(dataSource)
                .withTableName(<span class="string"><span class="delimiter">&quot;</span><span class="content">t_actor</span><span class="delimiter">&quot;</span></span>)
                .usingColumns(<span class="string"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>)
                .usingGeneratedKeyColumns(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="directive">public</span> <span class="type">void</span> add(Actor actor) {
        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; parameters = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;(<span class="integer">2</span>);
        parameters.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>, actor.getFirstName());
        parameters.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>, actor.getLastName());
        <span class="predefined-type">Number</span> newId = insertActor.executeAndReturnKey(parameters);
        actor.setId(newId.longValue());
    }

    <span class="comment">// ... additional methods</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The execution of the insert is the same as if you had relied on the metadata to determine
which columns to use.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-simple-jdbc-parameters"><a class="anchor" href="data-access.html#jdbc-simple-jdbc-parameters"></a>3.5.4. Using SqlParameterSource to provide parameter values</h4>
<div class="paragraph">
<p>Using a <code>Map</code> to provide parameter values works fine, but it&#8217;s not the most convenient
class to use. Spring provides a couple of implementations of the <code>SqlParameterSource</code>
interface that can be used instead.The first one is <code>BeanPropertySqlParameterSource</code>,
which is a very convenient class if you have a JavaBean-compliant class that contains
your values. It will use the corresponding getter method to extract the parameter
values. Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">JdbcActorDao</span> <span class="directive">implements</span> ActorDao {

    <span class="directive">private</span> JdbcTemplate jdbcTemplate;
    <span class="directive">private</span> SimpleJdbcInsert insertActor;

    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
        <span class="local-variable">this</span>.insertActor = <span class="keyword">new</span> SimpleJdbcInsert(dataSource)
                .withTableName(<span class="string"><span class="delimiter">&quot;</span><span class="content">t_actor</span><span class="delimiter">&quot;</span></span>)
                .usingGeneratedKeyColumns(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="directive">public</span> <span class="type">void</span> add(Actor actor) {
        SqlParameterSource parameters = <span class="keyword">new</span> BeanPropertySqlParameterSource(actor);
        <span class="predefined-type">Number</span> newId = insertActor.executeAndReturnKey(parameters);
        actor.setId(newId.longValue());
    }

    <span class="comment">// ... additional methods</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another option is the <code>MapSqlParameterSource</code> that resembles a Map but provides a more
convenient <code>addValue</code> method that can be chained.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">JdbcActorDao</span> <span class="directive">implements</span> ActorDao {

    <span class="directive">private</span> JdbcTemplate jdbcTemplate;
    <span class="directive">private</span> SimpleJdbcInsert insertActor;

    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
        <span class="local-variable">this</span>.insertActor = <span class="keyword">new</span> SimpleJdbcInsert(dataSource)
                .withTableName(<span class="string"><span class="delimiter">&quot;</span><span class="content">t_actor</span><span class="delimiter">&quot;</span></span>)
                .usingGeneratedKeyColumns(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="directive">public</span> <span class="type">void</span> add(Actor actor) {
        SqlParameterSource parameters = <span class="keyword">new</span> MapSqlParameterSource()
                .addValue(<span class="string"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>, actor.getFirstName())
                .addValue(<span class="string"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>, actor.getLastName());
        <span class="predefined-type">Number</span> newId = insertActor.executeAndReturnKey(parameters);
        actor.setId(newId.longValue());
    }

    <span class="comment">// ... additional methods</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the configuration is the same; only the executing code has to change to
use these alternative input classes.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-simple-jdbc-call-1"><a class="anchor" href="data-access.html#jdbc-simple-jdbc-call-1"></a>3.5.5. Calling a stored procedure with SimpleJdbcCall</h4>
<div class="paragraph">
<p>The <code>SimpleJdbcCall</code> class leverages metadata in the database to look up names of <code>in</code>
and <code>out</code> parameters, so that you do not have to declare them explicitly. You can
declare parameters if you prefer to do that, or if you have parameters such as <code>ARRAY</code>
or <code>STRUCT</code> that do not have an automatic mapping to a Java class. The first example
shows a simple procedure that returns only scalar values in <code>VARCHAR</code> and <code>DATE</code> format
from a MySQL database. The example procedure reads a specified actor entry and returns
<code>first_name</code>, <code>last_name</code>, and <code>birth_date</code> columns in the form of <code>out</code> parameters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">PROCEDURE</span> read_actor (
    <span class="keyword">IN</span> in_id <span class="predefined-type">INTEGER</span>,
    OUT out_first_name <span class="predefined-type">VARCHAR</span>(<span class="integer">100</span>),
    OUT out_last_name <span class="predefined-type">VARCHAR</span>(<span class="integer">100</span>),
    OUT out_birth_date <span class="predefined-type">DATE</span>)
<span class="class">BEGIN</span>
    <span class="class">SELECT</span> first_name, last_name, birth_date
    <span class="class">INTO</span> out_first_name, out_last_name, out_birth_date
    <span class="keyword">FROM</span> t_actor <span class="keyword">where</span> id = in_id;
<span class="keyword">END</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>in_id</code> parameter contains the <code>id</code> of the actor you are looking up. The <code>out</code>
parameters return the data read from the table.</p>
</div>
<div class="paragraph">
<p>The <code>SimpleJdbcCall</code> is declared in a similar manner to the <code>SimpleJdbcInsert</code>. You
should instantiate and configure the class in the initialization method of your data
access layer. Compared to the StoredProcedure class, you don&#8217;t have to create a subclass
and you don&#8217;t have to declare parameters that can be looked up in the database metadata.
Following is an example of a SimpleJdbcCall configuration using the above stored
procedure. The only configuration option, in addition to the <code>DataSource</code>, is the name
of the stored procedure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">JdbcActorDao</span> <span class="directive">implements</span> ActorDao {

    <span class="directive">private</span> JdbcTemplate jdbcTemplate;
    <span class="directive">private</span> SimpleJdbcCall procReadActor;

    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
        <span class="local-variable">this</span>.procReadActor = <span class="keyword">new</span> SimpleJdbcCall(dataSource)
                .withProcedureName(<span class="string"><span class="delimiter">&quot;</span><span class="content">read_actor</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="directive">public</span> Actor readActor(<span class="predefined-type">Long</span> id) {
        SqlParameterSource in = <span class="keyword">new</span> MapSqlParameterSource()
                .addValue(<span class="string"><span class="delimiter">&quot;</span><span class="content">in_id</span><span class="delimiter">&quot;</span></span>, id);
        <span class="predefined-type">Map</span> out = procReadActor.execute(in);
        Actor actor = <span class="keyword">new</span> Actor();
        actor.setId(id);
        actor.setFirstName((<span class="predefined-type">String</span>) out.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">out_first_name</span><span class="delimiter">&quot;</span></span>));
        actor.setLastName((<span class="predefined-type">String</span>) out.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">out_last_name</span><span class="delimiter">&quot;</span></span>));
        actor.setBirthDate((<span class="predefined-type">Date</span>) out.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">out_birth_date</span><span class="delimiter">&quot;</span></span>));
        <span class="keyword">return</span> actor;
    }

    <span class="comment">// ... additional methods</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code you write for the execution of the call involves creating an <code>SqlParameterSource</code>
containing the IN parameter. It&#8217;s important to match the name provided for the input value
with that of the parameter name declared in the stored procedure. The case does not have
to match because you use metadata to determine how database objects should be referred to
in a stored procedure. What is specified in the source for the stored procedure is not
necessarily the way it is stored in the database. Some databases transform names to all
upper case while others use lower case or use the case as specified.</p>
</div>
<div class="paragraph">
<p>The <code>execute</code> method takes the IN parameters and returns a Map containing any <code>out</code>
parameters keyed by the name as specified in the stored procedure. In this case they are
<code>out_first_name, out_last_name</code> and <code>out_birth_date</code>.</p>
</div>
<div class="paragraph">
<p>The last part of the <code>execute</code> method creates an Actor instance to use to return the
data retrieved. Again, it is important to use the names of the <code>out</code> parameters as they
are declared in the stored procedure. Also, the case in the names of the <code>out</code>
parameters stored in the results map matches that of the <code>out</code> parameter names in the
database, which could vary between databases. To make your code more portable you should
do a case-insensitive lookup or instruct Spring to use a <code>LinkedCaseInsensitiveMap</code>.
To do the latter, you create your own <code>JdbcTemplate</code> and set the <code>setResultsMapCaseInsensitive</code>
property to <code>true</code>. Then you pass this customized <code>JdbcTemplate</code> instance into
the constructor of your <code>SimpleJdbcCall</code>. Here is an example of this configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">JdbcActorDao</span> <span class="directive">implements</span> ActorDao {

    <span class="directive">private</span> SimpleJdbcCall procReadActor;

    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
        jdbcTemplate.setResultsMapCaseInsensitive(<span class="predefined-constant">true</span>);
        <span class="local-variable">this</span>.procReadActor = <span class="keyword">new</span> SimpleJdbcCall(jdbcTemplate)
                .withProcedureName(<span class="string"><span class="delimiter">&quot;</span><span class="content">read_actor</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="comment">// ... additional methods</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By taking this action, you avoid conflicts in the case used for the names of your
returned <code>out</code> parameters.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-simple-jdbc-call-2"><a class="anchor" href="data-access.html#jdbc-simple-jdbc-call-2"></a>3.5.6. Explicitly declaring parameters to use for a SimpleJdbcCall</h4>
<div class="paragraph">
<p>You have seen how the parameters are deduced based on metadata, but you can declare then
explicitly if you wish. You do this by creating and configuring <code>SimpleJdbcCall</code> with
the <code>declareParameters</code> method, which takes a variable number of <code>SqlParameter</code> objects
as input. See the next section for details on how to define an <code>SqlParameter</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Explicit declarations are necessary if the database you use is not a Spring-supported
database. Currently Spring supports metadata lookup of stored procedure calls for the
following databases: Apache Derby, DB2, MySQL, Microsoft SQL Server, Oracle, and Sybase.
We also support metadata lookup of stored functions for MySQL, Microsoft SQL Server,
and Oracle.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can opt to declare one, some, or all the parameters explicitly. The parameter
metadata is still used where you do not declare parameters explicitly. To bypass all
processing of metadata lookups for potential parameters and only use the declared
parameters, you call the method <code>withoutProcedureColumnMetaDataAccess</code> as part of the
declaration. Suppose that you have two or more different call signatures declared for a
database function. In this case you call the <code>useInParameterNames</code> to specify the list
of IN parameter names to include for a given signature.</p>
</div>
<div class="paragraph">
<p>The following example shows a fully declared procedure call, using the information from
the preceding example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">JdbcActorDao</span> <span class="directive">implements</span> ActorDao {

    <span class="directive">private</span> SimpleJdbcCall procReadActor;

    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
        jdbcTemplate.setResultsMapCaseInsensitive(<span class="predefined-constant">true</span>);
        <span class="local-variable">this</span>.procReadActor = <span class="keyword">new</span> SimpleJdbcCall(jdbcTemplate)
                .withProcedureName(<span class="string"><span class="delimiter">&quot;</span><span class="content">read_actor</span><span class="delimiter">&quot;</span></span>)
                .withoutProcedureColumnMetaDataAccess()
                .useInParameterNames(<span class="string"><span class="delimiter">&quot;</span><span class="content">in_id</span><span class="delimiter">&quot;</span></span>)
                .declareParameters(
                        <span class="keyword">new</span> SqlParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">in_id</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Types</span>.NUMERIC),
                        <span class="keyword">new</span> SqlOutParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">out_first_name</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Types</span>.VARCHAR),
                        <span class="keyword">new</span> SqlOutParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">out_last_name</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Types</span>.VARCHAR),
                        <span class="keyword">new</span> SqlOutParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">out_birth_date</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Types</span>.DATE)
                );
    }

    <span class="comment">// ... additional methods</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The execution and end results of the two examples are the same; this one specifies all
details explicitly rather than relying on metadata.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-params"><a class="anchor" href="data-access.html#jdbc-params"></a>3.5.7. How to define SqlParameters</h4>
<div class="paragraph">
<p>To define a parameter for the SimpleJdbc classes and also for the RDBMS operations
classes, covered in <a href="data-access.html#jdbc-object">Modeling JDBC operations as Java objects</a>, you use an <code>SqlParameter</code> or one of its subclasses.
You typically specify the parameter name and SQL type in the constructor. The SQL type
is specified using the <code>java.sql.Types</code> constants. We have already seen declarations
like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">new</span> SqlParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">in_id</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Types</span>.NUMERIC),
    <span class="keyword">new</span> SqlOutParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">out_first_name</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Types</span>.VARCHAR),</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first line with the <code>SqlParameter</code> declares an IN parameter. IN parameters can be
used for both stored procedure calls and for queries using the <code>SqlQuery</code> and its
subclasses covered in the following section.</p>
</div>
<div class="paragraph">
<p>The second line with the <code>SqlOutParameter</code> declares an <code>out</code> parameter to be used in a
stored procedure call. There is also an <code>SqlInOutParameter</code> for <code>InOut</code> parameters,
parameters that provide an <code>IN</code> value to the procedure and that also return a value.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Only parameters declared as <code>SqlParameter</code> and <code>SqlInOutParameter</code> will be used to
provide input values. This is different from the <code>StoredProcedure</code> class, which for
backwards compatibility reasons allows input values to be provided for parameters
declared as <code>SqlOutParameter</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For IN parameters, in addition to the name and the SQL type, you can specify a scale for
numeric data or a type name for custom database types. For <code>out</code> parameters, you can
provide a <code>RowMapper</code> to handle mapping of rows returned from a <code>REF</code> cursor. Another
option is to specify an <code>SqlReturnType</code> that provides an opportunity to define
customized handling of the return values.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-simple-jdbc-call-3"><a class="anchor" href="data-access.html#jdbc-simple-jdbc-call-3"></a>3.5.8. Calling a stored function using SimpleJdbcCall</h4>
<div class="paragraph">
<p>You call a stored function in almost the same way as you call a stored procedure, except
that you provide a function name rather than a procedure name. You use the
<code>withFunctionName</code> method as part of the configuration to indicate that we want to make
a call to a function, and the corresponding string for a function call is generated. A
specialized execute call, <code>executeFunction,</code> is used to execute the function and it
returns the function return value as an object of a specified type, which means you do
not have to retrieve the return value from the results map. A similar convenience method
named <code>executeObject</code> is also available for stored procedures that only have one <code>out</code>
parameter. The following example is based on a stored function named <code>get_actor_name</code>
that returns an actor&#8217;s full name. Here is the MySQL source for this function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">FUNCTION</span> get_actor_name (in_id <span class="predefined-type">INTEGER</span>)
RETURNS <span class="predefined-type">VARCHAR</span>(<span class="integer">200</span>) READS SQL DATA
<span class="class">BEGIN</span>
    DECLARE out_name <span class="predefined-type">VARCHAR</span>(<span class="integer">200</span>);
    <span class="class">SELECT</span> concat(first_name, <span class="string"><span class="delimiter">'</span><span class="content"> </span><span class="delimiter">'</span></span>, last_name)
        <span class="class">INTO</span> out_name
        <span class="keyword">FROM</span> t_actor <span class="keyword">where</span> id = in_id;
    <span class="directive">RETURN</span> out_name;
<span class="keyword">END</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To call this function we again create a <code>SimpleJdbcCall</code> in the initialization method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">JdbcActorDao</span> <span class="directive">implements</span> ActorDao {

    <span class="directive">private</span> JdbcTemplate jdbcTemplate;
    <span class="directive">private</span> SimpleJdbcCall funcGetActorName;

    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
        JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
        jdbcTemplate.setResultsMapCaseInsensitive(<span class="predefined-constant">true</span>);
        <span class="local-variable">this</span>.funcGetActorName = <span class="keyword">new</span> SimpleJdbcCall(jdbcTemplate)
                .withFunctionName(<span class="string"><span class="delimiter">&quot;</span><span class="content">get_actor_name</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getActorName(<span class="predefined-type">Long</span> id) {
        SqlParameterSource in = <span class="keyword">new</span> MapSqlParameterSource()
                .addValue(<span class="string"><span class="delimiter">&quot;</span><span class="content">in_id</span><span class="delimiter">&quot;</span></span>, id);
        <span class="predefined-type">String</span> name = funcGetActorName.executeFunction(<span class="predefined-type">String</span>.class, in);
        <span class="keyword">return</span> name;
    }

    <span class="comment">// ... additional methods</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The execute method used returns a <code>String</code> containing the return value from the function
call.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-simple-jdbc-call-4"><a class="anchor" href="data-access.html#jdbc-simple-jdbc-call-4"></a>3.5.9. Returning ResultSet/REF Cursor from a SimpleJdbcCall</h4>
<div class="paragraph">
<p>Calling a stored procedure or function that returns a result set is a bit tricky. Some
databases return result sets during the JDBC results processing while others require an
explicitly registered <code>out</code> parameter of a specific type. Both approaches need
additional processing to loop over the result set and process the returned rows. With
the <code>SimpleJdbcCall</code> you use the <code>returningResultSet</code> method and declare a <code>RowMapper</code>
implementation to be used for a specific parameter. In the case where the result set is
returned during the results processing, there are no names defined, so the returned
results will have to match the order in which you declare the <code>RowMapper</code>
implementations. The name specified is still used to store the processed list of results
in the results map that is returned from the execute statement.</p>
</div>
<div class="paragraph">
<p>The next example uses a stored procedure that takes no IN parameters and returns all
rows from the t_actor table. Here is the MySQL source for this procedure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">PROCEDURE</span> read_all_actors()
<span class="class">BEGIN</span>
 <span class="class">SELECT</span> a.id, a.first_name, a.last_name, a.birth_date <span class="keyword">FROM</span> t_actor a;
<span class="keyword">END</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To call this procedure you declare the <code>RowMapper</code>. Because the class you want to map to
follows the JavaBean rules, you can use a <code>BeanPropertyRowMapper</code> that is
created by passing in the required class to map to in the <code>newInstance</code> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">JdbcActorDao</span> <span class="directive">implements</span> ActorDao {

    <span class="directive">private</span> SimpleJdbcCall procReadAllActors;

    <span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
        JdbcTemplate jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);
        jdbcTemplate.setResultsMapCaseInsensitive(<span class="predefined-constant">true</span>);
        <span class="local-variable">this</span>.procReadAllActors = <span class="keyword">new</span> SimpleJdbcCall(jdbcTemplate)
                .withProcedureName(<span class="string"><span class="delimiter">&quot;</span><span class="content">read_all_actors</span><span class="delimiter">&quot;</span></span>)
                .returningResultSet(<span class="string"><span class="delimiter">&quot;</span><span class="content">actors</span><span class="delimiter">&quot;</span></span>,
                BeanPropertyRowMapper.newInstance(Actor.class));
    }

    <span class="directive">public</span> <span class="predefined-type">List</span> getActorsList() {
        <span class="predefined-type">Map</span> m = procReadAllActors.execute(<span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;(<span class="integer">0</span>));
        <span class="keyword">return</span> (<span class="predefined-type">List</span>) m.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">actors</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="comment">// ... additional methods</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The execute call passes in an empty Map because this call does not take any parameters.
The list of Actors is then retrieved from the results map and returned to the caller.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jdbc-object"><a class="anchor" href="data-access.html#jdbc-object"></a>3.6. Modeling JDBC operations as Java objects</h3>
<div class="paragraph">
<p>The <code>org.springframework.jdbc.object</code> package contains classes that allow you to access
the database in a more object-oriented manner. As an example, you can execute queries
and get the results back as a list containing business objects with the relational
column data mapped to the properties of the business object. You can also execute stored
procedures and run update, delete, and insert statements.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Many Spring developers believe that the various RDBMS operation classes described below
(with the exception of the <a href="data-access.html#jdbc-StoredProcedure"><code>StoredProcedure</code></a> class) can often
be replaced with straight <code>JdbcTemplate</code> calls. Often it is simpler to write a DAO
method that simply calls a method on a <code>JdbcTemplate</code> directly (as opposed to
encapsulating a query as a full-blown class).</p>
</div>
<div class="paragraph">
<p>However, if you are getting measurable value from using the RDBMS operation classes,
continue using these classes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="jdbc-SqlQuery"><a class="anchor" href="data-access.html#jdbc-SqlQuery"></a>3.6.1. SqlQuery</h4>
<div class="paragraph">
<p><code>SqlQuery</code> is a reusable, threadsafe class that encapsulates an SQL query. Subclasses
must implement the <code>newRowMapper(..)</code> method to provide a <code>RowMapper</code> instance that can
create one object per row obtained from iterating over the <code>ResultSet</code> that is created
during the execution of the query. The <code>SqlQuery</code> class is rarely used directly because
the <code>MappingSqlQuery</code> subclass provides a much more convenient implementation for
mapping rows to Java classes. Other implementations that extend <code>SqlQuery</code> are
<code>MappingSqlQueryWithParameters</code> and <code>UpdatableSqlQuery</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-MappingSqlQuery"><a class="anchor" href="data-access.html#jdbc-MappingSqlQuery"></a>3.6.2. MappingSqlQuery</h4>
<div class="paragraph">
<p><code>MappingSqlQuery</code> is a reusable query in which concrete subclasses must implement the
abstract <code>mapRow(..)</code> method to convert each row of the supplied <code>ResultSet</code> into an
object of the type specified. The following example shows a custom query that maps the
data from the <code>t_actor</code> relation to an instance of the <code>Actor</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ActorMappingQuery</span> <span class="directive">extends</span> MappingSqlQuery&lt;Actor&gt; {

    <span class="directive">public</span> ActorMappingQuery(<span class="predefined-type">DataSource</span> ds) {
        <span class="local-variable">super</span>(ds, <span class="string"><span class="delimiter">&quot;</span><span class="content">select id, first_name, last_name from t_actor where id = ?</span><span class="delimiter">&quot;</span></span>);
        <span class="local-variable">super</span>.declareParameter(<span class="keyword">new</span> SqlParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Types</span>.INTEGER));
        compile();
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> Actor mapRow(<span class="predefined-type">ResultSet</span> rs, <span class="type">int</span> rowNumber) <span class="directive">throws</span> <span class="exception">SQLException</span> {
        Actor actor = <span class="keyword">new</span> Actor();
        actor.setId(rs.getLong(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>));
        actor.setFirstName(rs.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>));
        actor.setLastName(rs.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>));
        <span class="keyword">return</span> actor;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The class extends <code>MappingSqlQuery</code> parameterized with the <code>Actor</code> type. The constructor
for this customer query takes the <code>DataSource</code> as the only parameter. In this
constructor you call the constructor on the superclass with the <code>DataSource</code> and the SQL
that should be executed to retrieve the rows for this query. This SQL will be used to
create a <code>PreparedStatement</code> so it may contain place holders for any parameters to be
passed in during execution.You must declare each parameter using the <code>declareParameter</code>
method passing in an <code>SqlParameter</code>. The <code>SqlParameter</code> takes a name and the JDBC type
as defined in <code>java.sql.Types</code>. After you define all parameters, you call the
<code>compile()</code> method so the statement can be prepared and later executed. This class is
thread-safe after it is compiled, so as long as these instances are created when the DAO
is initialized they can be kept as instance variables and be reused.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> ActorMappingQuery actorMappingQuery;

<span class="annotation">@Autowired</span>
<span class="directive">public</span> <span class="type">void</span> setDataSource(<span class="predefined-type">DataSource</span> dataSource) {
    <span class="local-variable">this</span>.actorMappingQuery = <span class="keyword">new</span> ActorMappingQuery(dataSource);
}

<span class="directive">public</span> Customer getCustomer(<span class="predefined-type">Long</span> id) {
    <span class="keyword">return</span> actorMappingQuery.findObject(id);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The method in this example retrieves the customer with the id that is passed in as the
only parameter. Since we only want one object returned we simply call the convenience
method <code>findObject</code> with the id as parameter. If we had instead a query that returned a
list of objects and took additional parameters then we would use one of the execute
methods that takes an array of parameter values passed in as varargs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="predefined-type">List</span>&lt;Actor&gt; searchForActors(<span class="type">int</span> age, <span class="predefined-type">String</span> namePattern) {
    <span class="predefined-type">List</span>&lt;Actor&gt; actors = actorSearchMappingQuery.execute(age, namePattern);
    <span class="keyword">return</span> actors;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-SqlUpdate"><a class="anchor" href="data-access.html#jdbc-SqlUpdate"></a>3.6.3. SqlUpdate</h4>
<div class="paragraph">
<p>The <code>SqlUpdate</code> class encapsulates an SQL update. Like a query, an update object is
reusable, and like all <code>RdbmsOperation</code> classes, an update can have parameters and is
defined in SQL. This class provides a number of <code>update(..)</code> methods analogous to the
<code>execute(..)</code> methods of query objects. The <code>SQLUpdate</code> class is concrete. It can be
subclassed, for example, to add a custom update method, as in the following snippet
where it&#8217;s simply called <code>execute</code>. However, you don&#8217;t have to subclass the <code>SqlUpdate</code>
class since it can easily be parameterized by setting SQL and declaring parameters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.sql.Types</span>;

<span class="keyword">import</span> <span class="include">javax.sql.DataSource</span>;

<span class="keyword">import</span> <span class="include">org.springframework.jdbc.core.SqlParameter</span>;
<span class="keyword">import</span> <span class="include">org.springframework.jdbc.object.SqlUpdate</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">UpdateCreditRating</span> <span class="directive">extends</span> SqlUpdate {

    <span class="directive">public</span> UpdateCreditRating(<span class="predefined-type">DataSource</span> ds) {
        setDataSource(ds);
        setSql(<span class="string"><span class="delimiter">&quot;</span><span class="content">update customer set credit_rating = ? where id = ?</span><span class="delimiter">&quot;</span></span>);
        declareParameter(<span class="keyword">new</span> SqlParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">creditRating</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Types</span>.NUMERIC));
        declareParameter(<span class="keyword">new</span> SqlParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Types</span>.NUMERIC));
        compile();
    }

    <span class="comment">/**
     * @param id for the Customer to be updated
     * @param rating the new value for credit rating
     * @return number of rows updated
     */</span>
    <span class="directive">public</span> <span class="type">int</span> execute(<span class="type">int</span> id, <span class="type">int</span> rating) {
        <span class="keyword">return</span> update(rating, id);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-StoredProcedure"><a class="anchor" href="data-access.html#jdbc-StoredProcedure"></a>3.6.4. StoredProcedure</h4>
<div class="paragraph">
<p>The <code>StoredProcedure</code> class is a superclass for object abstractions of RDBMS stored
procedures. This class is <code>abstract</code>, and its various <code>execute(..)</code> methods have
<code>protected</code> access, preventing use other than through a subclass that offers tighter
typing.</p>
</div>
<div class="paragraph">
<p>The inherited <code>sql</code> property will be the name of the stored procedure in the RDBMS.</p>
</div>
<div class="paragraph">
<p>To define a parameter for the <code>StoredProcedure</code> class, you use an <code>SqlParameter</code> or one
of its subclasses. You must specify the parameter name and SQL type in the constructor
like in the following code snippet. The SQL type is specified using the <code>java.sql.Types</code>
constants.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">new</span> SqlParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">in_id</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Types</span>.NUMERIC),
    <span class="keyword">new</span> SqlOutParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">out_first_name</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Types</span>.VARCHAR),</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first line with the <code>SqlParameter</code> declares an IN parameter. IN parameters can be
used for both stored procedure calls and for queries using the <code>SqlQuery</code> and its
subclasses covered in the following section.</p>
</div>
<div class="paragraph">
<p>The second line with the <code>SqlOutParameter</code> declares an <code>out</code> parameter to be used in the
stored procedure call. There is also an <code>SqlInOutParameter</code> for <code>I</code> <code>nOut</code> parameters,
parameters that provide an <code>in</code> value to the procedure and that also return a value.</p>
</div>
<div class="paragraph">
<p>For <code>i</code> <code>n</code> parameters, in addition to the name and the SQL type, you can specify a
scale for numeric data or a type name for custom database types. For <code>out</code> parameters
you can provide a <code>RowMapper</code> to handle mapping of rows returned from a REF cursor.
Another option is to specify an <code>SqlReturnType</code> that enables you to define customized
handling of the return values.</p>
</div>
<div class="paragraph">
<p>Here is an example of a simple DAO that uses a <code>StoredProcedure</code> to call a function,
<code>sysdate()</code>,which comes with any Oracle database. To use the stored procedure
functionality you have to create a class that extends <code>StoredProcedure</code>. In this
example, the <code>StoredProcedure</code> class is an inner class, but if you need to reuse the
<code>StoredProcedure</code> you declare it as a top-level class. This example has no input
parameters, but an output parameter is declared as a date type using the class
<code>SqlOutParameter</code>. The <code>execute()</code> method executes the procedure and extracts the
returned date from the results <code>Map</code>. The results <code>Map</code> has an entry for each declared
output parameter, in this case only one, using the parameter name as the key.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.sql.Types</span>;
<span class="keyword">import</span> <span class="include">java.util.Date</span>;
<span class="keyword">import</span> <span class="include">java.util.HashMap</span>;
<span class="keyword">import</span> <span class="include">java.util.Map</span>;

<span class="keyword">import</span> <span class="include">javax.sql.DataSource</span>;

<span class="keyword">import</span> <span class="include">org.springframework.beans.factory.annotation.Autowired</span>;
<span class="keyword">import</span> <span class="include">org.springframework.jdbc.core.SqlOutParameter</span>;
<span class="keyword">import</span> <span class="include">org.springframework.jdbc.object.StoredProcedure</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">StoredProcedureDao</span> {

    <span class="directive">private</span> GetSysdateProcedure getSysdate;

    <span class="annotation">@Autowired</span>
    <span class="directive">public</span> <span class="type">void</span> init(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">this</span>.getSysdate = <span class="keyword">new</span> GetSysdateProcedure(dataSource);
    }

    <span class="directive">public</span> <span class="predefined-type">Date</span> getSysdate() {
        <span class="keyword">return</span> getSysdate.execute();
    }

    <span class="directive">private</span> <span class="type">class</span> <span class="class">GetSysdateProcedure</span> <span class="directive">extends</span> StoredProcedure {

        <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> SQL = <span class="string"><span class="delimiter">&quot;</span><span class="content">sysdate</span><span class="delimiter">&quot;</span></span>;

        <span class="directive">public</span> GetSysdateProcedure(<span class="predefined-type">DataSource</span> dataSource) {
            setDataSource(dataSource);
            setFunction(<span class="predefined-constant">true</span>);
            setSql(SQL);
            declareParameter(<span class="keyword">new</span> SqlOutParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Types</span>.DATE));
            compile();
        }

        <span class="directive">public</span> <span class="predefined-type">Date</span> execute() {
            <span class="comment">// the 'sysdate' sproc has no input parameters, so an empty Map is supplied...</span>
            <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; results = execute(<span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;());
            <span class="predefined-type">Date</span> sysdate = (<span class="predefined-type">Date</span>) results.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>);
            <span class="keyword">return</span> sysdate;
        }
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example of a <code>StoredProcedure</code> has two output parameters (in this case,
Oracle REF cursors).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">oracle.jdbc.OracleTypes</span>;
<span class="keyword">import</span> <span class="include">org.springframework.jdbc.core.SqlOutParameter</span>;
<span class="keyword">import</span> <span class="include">org.springframework.jdbc.object.StoredProcedure</span>;

<span class="keyword">import</span> <span class="include">javax.sql.DataSource</span>;
<span class="keyword">import</span> <span class="include">java.util.HashMap</span>;
<span class="keyword">import</span> <span class="include">java.util.Map</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">TitlesAndGenresStoredProcedure</span> <span class="directive">extends</span> StoredProcedure {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> SPROC_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">AllTitlesAndGenres</span><span class="delimiter">&quot;</span></span>;

    <span class="directive">public</span> TitlesAndGenresStoredProcedure(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">super</span>(dataSource, SPROC_NAME);
        declareParameter(<span class="keyword">new</span> SqlOutParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">titles</span><span class="delimiter">&quot;</span></span>, OracleTypes.CURSOR, <span class="keyword">new</span> TitleMapper()));
        declareParameter(<span class="keyword">new</span> SqlOutParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">genres</span><span class="delimiter">&quot;</span></span>, OracleTypes.CURSOR, <span class="keyword">new</span> GenreMapper()));
        compile();
    }

    <span class="directive">public</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; execute() {
        <span class="comment">// again, this sproc has no input parameters, so an empty Map is supplied</span>
        <span class="keyword">return</span> <span class="local-variable">super</span>.execute(<span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how the overloaded variants of the <code>declareParameter(..)</code> method that have been
used in the <code>TitlesAndGenresStoredProcedure</code> constructor are passed <code>RowMapper</code>
implementation instances; this is a very convenient and powerful way to reuse existing
functionality. The code for the two <code>RowMapper</code> implementations is provided below.</p>
</div>
<div class="paragraph">
<p>The <code>TitleMapper</code> class maps a <code>ResultSet</code> to a <code>Title</code> domain object for each row in
the supplied <code>ResultSet</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.springframework.jdbc.core.RowMapper</span>;

<span class="keyword">import</span> <span class="include">java.sql.ResultSet</span>;
<span class="keyword">import</span> <span class="include">java.sql.SQLException</span>;

<span class="keyword">import</span> <span class="include">com.foo.domain.Title</span>;

<span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">TitleMapper</span> <span class="directive">implements</span> <span class="predefined-type">RowMapper</span>&lt;Title&gt; {

    <span class="directive">public</span> Title mapRow(<span class="predefined-type">ResultSet</span> rs, <span class="type">int</span> rowNum) <span class="directive">throws</span> <span class="exception">SQLException</span> {
        Title title = <span class="keyword">new</span> Title();
        title.setId(rs.getLong(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>));
        title.setName(rs.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>));
        <span class="keyword">return</span> title;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>GenreMapper</code> class maps a <code>ResultSet</code> to a <code>Genre</code> domain object for each row in
the supplied <code>ResultSet</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.springframework.jdbc.core.RowMapper</span>;

<span class="keyword">import</span> <span class="include">java.sql.ResultSet</span>;
<span class="keyword">import</span> <span class="include">java.sql.SQLException</span>;

<span class="keyword">import</span> <span class="include">com.foo.domain.Genre</span>;

<span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">GenreMapper</span> <span class="directive">implements</span> <span class="predefined-type">RowMapper</span>&lt;Genre&gt; {

    <span class="directive">public</span> Genre mapRow(<span class="predefined-type">ResultSet</span> rs, <span class="type">int</span> rowNum) <span class="directive">throws</span> <span class="exception">SQLException</span> {
        <span class="keyword">return</span> <span class="keyword">new</span> Genre(rs.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To pass parameters to a stored procedure that has one or more input parameters in its
definition in the RDBMS, you can code a strongly typed <code>execute(..)</code> method that would
delegate to the superclass' untyped <code>execute(Map parameters)</code> method (which has
<code>protected</code> access); for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">oracle.jdbc.OracleTypes</span>;
<span class="keyword">import</span> <span class="include">org.springframework.jdbc.core.SqlOutParameter</span>;
<span class="keyword">import</span> <span class="include">org.springframework.jdbc.core.SqlParameter</span>;
<span class="keyword">import</span> <span class="include">org.springframework.jdbc.object.StoredProcedure</span>;

<span class="keyword">import</span> <span class="include">javax.sql.DataSource</span>;

<span class="keyword">import</span> <span class="include">java.sql.Types</span>;
<span class="keyword">import</span> <span class="include">java.util.Date</span>;
<span class="keyword">import</span> <span class="include">java.util.HashMap</span>;
<span class="keyword">import</span> <span class="include">java.util.Map</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">TitlesAfterDateStoredProcedure</span> <span class="directive">extends</span> StoredProcedure {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> SPROC_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">TitlesAfterDate</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> CUTOFF_DATE_PARAM = <span class="string"><span class="delimiter">&quot;</span><span class="content">cutoffDate</span><span class="delimiter">&quot;</span></span>;

    <span class="directive">public</span> TitlesAfterDateStoredProcedure(<span class="predefined-type">DataSource</span> dataSource) {
        <span class="local-variable">super</span>(dataSource, SPROC_NAME);
        declareParameter(<span class="keyword">new</span> SqlParameter(CUTOFF_DATE_PARAM, <span class="predefined-type">Types</span>.DATE);
        declareParameter(<span class="keyword">new</span> SqlOutParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">titles</span><span class="delimiter">&quot;</span></span>, OracleTypes.CURSOR, <span class="keyword">new</span> TitleMapper()));
        compile();
    }

    <span class="directive">public</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; execute(<span class="predefined-type">Date</span> cutoffDate) {
        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; inputs = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;();
        inputs.put(CUTOFF_DATE_PARAM, cutoffDate);
        <span class="keyword">return</span> <span class="local-variable">super</span>.execute(inputs);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jdbc-parameter-handling"><a class="anchor" href="data-access.html#jdbc-parameter-handling"></a>3.7. Common problems with parameter and data value handling</h3>
<div class="paragraph">
<p>Common problems with parameters and data values exist in the different approaches
provided by the Spring Framework JDBC.</p>
</div>
<div class="sect3">
<h4 id="jdbc-type-information"><a class="anchor" href="data-access.html#jdbc-type-information"></a>3.7.1. Providing SQL type information for parameters</h4>
<div class="paragraph">
<p>Usually Spring determines the SQL type of the parameters based on the type of parameter
passed in. It is possible to explicitly provide the SQL type to be used when setting
parameter values. This is sometimes necessary to correctly set NULL values.</p>
</div>
<div class="paragraph">
<p>You can provide SQL type information in several ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Many update and query methods of the <code>JdbcTemplate</code> take an additional parameter in
the form of an <code>int</code> array. This array is used to indicate the SQL type of the
corresponding parameter using constant values from the <code>java.sql.Types</code> class. Provide
one entry for each parameter.</p>
</li>
<li>
<p>You can use the <code>SqlParameterValue</code> class to wrap the parameter value that needs this
additional information.Create a new instance for each value and pass in the SQL type
and parameter value in the constructor. You can also provide an optional scale
parameter for numeric values.</p>
</li>
<li>
<p>For methods working with named parameters, use the <code>SqlParameterSource</code> classes
<code>BeanPropertySqlParameterSource</code> or <code>MapSqlParameterSource</code>. They both have methods
for registering the SQL type for any of the named parameter values.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-lob"><a class="anchor" href="data-access.html#jdbc-lob"></a>3.7.2. Handling BLOB and CLOB objects</h4>
<div class="paragraph">
<p>You can store images, other binary data, and large chunks of text in the database. These
large objects are called BLOBs (Binary Large OBject) for binary data and CLOBs (Character
Large OBject) for character data. In Spring you can handle these large objects by using
the <code>JdbcTemplate</code> directly and also when using the higher abstractions provided by RDBMS
Objects and the <code>SimpleJdbc</code> classes. All of these approaches use an implementation of
the <code>LobHandler</code> interface for the actual management of the LOB (Large OBject) data. The
<code>LobHandler</code> provides access to a <code>LobCreator</code> class, through the <code>getLobCreator</code> method,
used for creating new LOB objects to be inserted.</p>
</div>
<div class="paragraph">
<p>The <code>LobCreator/LobHandler</code> provides the following support for LOB input and output:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>BLOB</p>
<div class="ulist">
<ul>
<li>
<p><code>byte[]</code>&#8201;&#8212;&#8201;<code>getBlobAsBytes</code> and <code>setBlobAsBytes</code></p>
</li>
<li>
<p><code>InputStream</code>&#8201;&#8212;&#8201;<code>getBlobAsBinaryStream</code> and <code>setBlobAsBinaryStream</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>CLOB</p>
<div class="ulist">
<ul>
<li>
<p><code>String</code>&#8201;&#8212;&#8201;<code>getClobAsString</code> and <code>setClobAsString</code></p>
</li>
<li>
<p><code>InputStream</code>&#8201;&#8212;&#8201;<code>getClobAsAsciiStream</code> and <code>setClobAsAsciiStream</code></p>
</li>
<li>
<p><code>Reader</code>&#8201;&#8212;&#8201;<code>getClobAsCharacterStream</code> and <code>setClobAsCharacterStream</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The next example shows how to create and insert a BLOB. Later you will see how to read
it back from the database.</p>
</div>
<div class="paragraph">
<p>This example uses a <code>JdbcTemplate</code> and an implementation of the
<code>AbstractLobCreatingPreparedStatementCallback</code>. It implements one method,
<code>setValues</code>. This method provides a <code>LobCreator</code> that you use to set the values for the
LOB columns in your SQL insert statement.</p>
</div>
<div class="paragraph">
<p>For this example we assume that there is a variable, <code>lobHandler</code>, that already is
set to an instance of a <code>DefaultLobHandler</code>. You typically set this value through
dependency injection.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">final</span> <span class="predefined-type">File</span> blobIn = <span class="keyword">new</span> <span class="predefined-type">File</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">spring2004.jpg</span><span class="delimiter">&quot;</span></span>);
<span class="directive">final</span> <span class="predefined-type">InputStream</span> blobIs = <span class="keyword">new</span> <span class="predefined-type">FileInputStream</span>(blobIn);
<span class="directive">final</span> <span class="predefined-type">File</span> clobIn = <span class="keyword">new</span> <span class="predefined-type">File</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">large.txt</span><span class="delimiter">&quot;</span></span>);
<span class="directive">final</span> <span class="predefined-type">InputStream</span> clobIs = <span class="keyword">new</span> <span class="predefined-type">FileInputStream</span>(clobIn);
<span class="directive">final</span> <span class="predefined-type">InputStreamReader</span> clobReader = <span class="keyword">new</span> <span class="predefined-type">InputStreamReader</span>(clobIs);
jdbcTemplate.execute(
    <span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO lob_table (id, a_clob, a_blob) VALUES (?, ?, ?)</span><span class="delimiter">&quot;</span></span>,
    <span class="keyword">new</span> AbstractLobCreatingPreparedStatementCallback(lobHandler) { <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="directive">protected</span> <span class="type">void</span> setValues(<span class="predefined-type">PreparedStatement</span> ps, LobCreator lobCreator) <span class="directive">throws</span> <span class="exception">SQLException</span> {
            ps.setLong(<span class="integer">1</span>, <span class="integer">1L</span>);
            lobCreator.setClobAsCharacterStream(ps, <span class="integer">2</span>, clobReader, (<span class="type">int</span>)clobIn.length()); <i class="conum" data-value="2"></i><b>(2)</b>
            lobCreator.setBlobAsBinaryStream(ps, <span class="integer">3</span>, blobIs, (<span class="type">int</span>)blobIn.length()); <i class="conum" data-value="3"></i><b>(3)</b>
        }
    }
);
blobIs.close();
clobReader.close();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pass in the <code>lobHandler</code> that in this example is a plain <code>DefaultLobHandler</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Using the method <code>setClobAsCharacterStream</code>, pass in the contents of the CLOB.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Using the method <code>setBlobAsBinaryStream</code>, pass in the contents of the BLOB.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you invoke the <code>setBlobAsBinaryStream</code>, <code>setClobAsAsciiStream</code>, or
<code>setClobAsCharacterStream</code> method on the <code>LobCreator</code> returned from
<code>DefaultLobHandler.getLobCreator()</code>, you can optionally specify a negative value for the
<code>contentLength</code> argument. If the specified content length is negative, the
<code>DefaultLobHandler</code> will use the JDBC 4.0 variants of the set-stream methods without a
length parameter; otherwise, it will pass the specified length on to the driver.</p>
</div>
<div class="paragraph">
<p>Consult the documentation for the JDBC driver in use to verify support for streaming a
LOB without providing the content length.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now it&#8217;s time to read the LOB data from the database. Again, you use a <code>JdbcTemplate</code>
with the same instance variable <code>lobHandler</code> and a reference to a <code>DefaultLobHandler</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;&gt; l = jdbcTemplate.query(<span class="string"><span class="delimiter">&quot;</span><span class="content">select id, a_clob, a_blob from lob_table</span><span class="delimiter">&quot;</span></span>,
    <span class="keyword">new</span> <span class="predefined-type">RowMapper</span>&lt;<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;&gt;() {
        <span class="directive">public</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; mapRow(<span class="predefined-type">ResultSet</span> rs, <span class="type">int</span> i) <span class="directive">throws</span> <span class="exception">SQLException</span> {
            <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; results = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;();
            <span class="predefined-type">String</span> clobText = lobHandler.getClobAsString(rs, <span class="string"><span class="delimiter">&quot;</span><span class="content">a_clob</span><span class="delimiter">&quot;</span></span>); <i class="conum" data-value="1"></i><b>(1)</b>
results.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">CLOB</span><span class="delimiter">&quot;</span></span>, clobText); <span class="type">byte</span><span class="type">[]</span> blobBytes = lobHandler.getBlobAsBytes(rs, <span class="string"><span class="delimiter">&quot;</span><span class="content">a_blob</span><span class="delimiter">&quot;</span></span>); <i class="conum" data-value="2"></i><b>(2)</b>
results.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">BLOB</span><span class="delimiter">&quot;</span></span>, blobBytes); <span class="keyword">return</span> results; } });</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Using the method <code>getClobAsString</code>, retrieve the contents of the CLOB.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Using the method <code>getBlobAsBytes</code>, retrieve the contents of the BLOB.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-in-clause"><a class="anchor" href="data-access.html#jdbc-in-clause"></a>3.7.3. Passing in lists of values for IN clause</h4>
<div class="paragraph">
<p>The SQL standard allows for selecting rows based on an expression that includes a
variable list of values. A typical example would be <code>select * from T_ACTOR where id in
(1, 2, 3)</code>. This variable list is not directly supported for prepared statements by the
JDBC standard; you cannot declare a variable number of placeholders. You need a number
of variations with the desired number of placeholders prepared, or you need to generate
the SQL string dynamically once you know how many placeholders are required. The named
parameter support provided in the <code>NamedParameterJdbcTemplate</code> and <code>JdbcTemplate</code> takes
the latter approach. Pass in the values as a <code>java.util.List</code> of primitive objects. This
list will be used to insert the required placeholders and pass in the values during the
statement execution.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Be careful when passing in many values. The JDBC standard does not guarantee that you
can use more than 100 values for an <code>in</code> expression list. Various databases exceed this
number, but they usually have a hard limit for how many values are allowed. Oracle&#8217;s
limit is 1000.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In addition to the primitive values in the value list, you can create a <code>java.util.List</code>
of object arrays. This list would support multiple expressions defined for the <code>in</code>
clause such as <code>select * from T_ACTOR where (id, last_name) in ((1, 'Johnson'), (2,
'Harrop'\))</code>. This of course requires that your database supports this syntax.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-complex-types"><a class="anchor" href="data-access.html#jdbc-complex-types"></a>3.7.4. Handling complex types for stored procedure calls</h4>
<div class="paragraph">
<p>When you call stored procedures you can sometimes use complex types specific to the
database. To accommodate these types, Spring provides a <code>SqlReturnType</code> for handling
them when they are returned from the stored procedure call and <code>SqlTypeValue</code> when they
are passed in as a parameter to the stored procedure.</p>
</div>
<div class="paragraph">
<p>Here is an example of returning the value of an Oracle <code>STRUCT</code> object of the user
declared type <code>ITEM_TYPE</code>. The <code>SqlReturnType</code> interface has a single method named
<code>getTypeValue</code> that must be implemented. This interface is used as part of the
declaration of an <code>SqlOutParameter</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">final</span> TestItem = <span class="keyword">new</span> TestItem(<span class="integer">123L</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">A test item</span><span class="delimiter">&quot;</span></span>,
        <span class="keyword">new</span> <span class="predefined-type">SimpleDateFormat</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">yyyy-M-d</span><span class="delimiter">&quot;</span></span>).parse(<span class="string"><span class="delimiter">&quot;</span><span class="content">2010-12-31</span><span class="delimiter">&quot;</span></span>));

declareParameter(<span class="keyword">new</span> SqlOutParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span>, OracleTypes.STRUCT, <span class="string"><span class="delimiter">&quot;</span><span class="content">ITEM_TYPE</span><span class="delimiter">&quot;</span></span>,
    <span class="keyword">new</span> SqlReturnType() {
        <span class="directive">public</span> <span class="predefined-type">Object</span> getTypeValue(<span class="predefined-type">CallableStatement</span> cs, <span class="type">int</span> colIndx, <span class="type">int</span> sqlType, <span class="predefined-type">String</span> typeName) <span class="directive">throws</span> <span class="exception">SQLException</span> {
            STRUCT struct = (STRUCT) cs.getObject(colIndx);
            <span class="predefined-type">Object</span><span class="type">[]</span> attr = struct.getAttributes();
            TestItem item = <span class="keyword">new</span> TestItem();
            item.setId(((<span class="predefined-type">Number</span>) attr[<span class="integer">0</span>]).longValue());
            item.setDescription((<span class="predefined-type">String</span>) attr[<span class="integer">1</span>]);
            item.setExpirationDate((java.util.Date) attr[<span class="integer">2</span>]);
            <span class="keyword">return</span> item;
        }
    }));</code></pre>
</div>
</div>
<div class="paragraph">
<p>You use the <code>SqlTypeValue</code> to pass in the value of a Java object like <code>TestItem</code> into a
stored procedure. The <code>SqlTypeValue</code> interface has a single method named
<code>createTypeValue</code> that you must implement. The active connection is passed in, and you
can use it to create database-specific objects such as <code>StructDescriptor</code>s, as shown in
the following example, or <code>ArrayDescriptor</code>s.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">final</span> TestItem = <span class="keyword">new</span> TestItem(<span class="integer">123L</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">A test item</span><span class="delimiter">&quot;</span></span>,
        <span class="keyword">new</span> <span class="predefined-type">SimpleDateFormat</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">yyyy-M-d</span><span class="delimiter">&quot;</span></span>).parse(<span class="string"><span class="delimiter">&quot;</span><span class="content">2010-12-31</span><span class="delimiter">&quot;</span></span>));

SqlTypeValue value = <span class="keyword">new</span> AbstractSqlTypeValue() {
    <span class="directive">protected</span> <span class="predefined-type">Object</span> createTypeValue(<span class="predefined-type">Connection</span> conn, <span class="type">int</span> sqlType, <span class="predefined-type">String</span> typeName) <span class="directive">throws</span> <span class="exception">SQLException</span> {
        StructDescriptor itemDescriptor = <span class="keyword">new</span> StructDescriptor(typeName, conn);
        <span class="predefined-type">Struct</span> item = <span class="keyword">new</span> STRUCT(itemDescriptor, conn,
        <span class="keyword">new</span> <span class="predefined-type">Object</span><span class="type">[]</span> {
            testItem.getId(),
            testItem.getDescription(),
            <span class="keyword">new</span> java.sql.Date(testItem.getExpirationDate().getTime())
        });
        <span class="keyword">return</span> item;
    }
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>SqlTypeValue</code> can now be added to the Map containing the input parameters for the
execute call of the stored procedure.</p>
</div>
<div class="paragraph">
<p>Another use for the <code>SqlTypeValue</code> is passing in an array of values to an Oracle stored
procedure. Oracle has its own internal <code>ARRAY</code> class that must be used in this case, and
you can use the <code>SqlTypeValue</code> to create an instance of the Oracle <code>ARRAY</code> and populate
it with values from the Java <code>ARRAY</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">final</span> <span class="predefined-type">Long</span><span class="type">[]</span> ids = <span class="keyword">new</span> <span class="predefined-type">Long</span><span class="type">[]</span> {<span class="integer">1L</span>, <span class="integer">2L</span>};

SqlTypeValue value = <span class="keyword">new</span> AbstractSqlTypeValue() {
    <span class="directive">protected</span> <span class="predefined-type">Object</span> createTypeValue(<span class="predefined-type">Connection</span> conn, <span class="type">int</span> sqlType, <span class="predefined-type">String</span> typeName) <span class="directive">throws</span> <span class="exception">SQLException</span> {
        ArrayDescriptor arrayDescriptor = <span class="keyword">new</span> ArrayDescriptor(typeName, conn);
        ARRAY idArray = <span class="keyword">new</span> ARRAY(arrayDescriptor, conn, ids);
        <span class="keyword">return</span> idArray;
    }
};</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jdbc-embedded-database-support"><a class="anchor" href="data-access.html#jdbc-embedded-database-support"></a>3.8. Embedded database support</h3>
<div class="paragraph">
<p>The <code>org.springframework.jdbc.datasource.embedded</code> package provides support for embedded
Java database engines. Support for <a href="http://www.hsqldb.org">HSQL</a>,
<a href="http://www.h2database.com">H2</a>, and <a href="https://db.apache.org/derby">Derby</a> is provided
natively. You can also use an extensible API to plug in new embedded database types and
<code>DataSource</code> implementations.</p>
</div>
<div class="sect3">
<h4 id="jdbc-why-embedded-database"><a class="anchor" href="data-access.html#jdbc-why-embedded-database"></a>3.8.1. Why use an embedded database?</h4>
<div class="paragraph">
<p>An embedded database is useful during the development phase of a project because of its
lightweight nature. Benefits include ease of configuration, quick startup time,
testability, and the ability to rapidly evolve SQL during development.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-embedded-database-xml"><a class="anchor" href="data-access.html#jdbc-embedded-database-xml"></a>3.8.2. Creating an embedded database using Spring XML</h4>
<div class="paragraph">
<p>If you want to expose an embedded database instance as a bean in a Spring
<code>ApplicationContext</code>, use the <code>embedded-database</code> tag in the <code>spring-jdbc</code> namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;jdbc:embedded-database</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">generate-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;jdbc:script</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:schema.sql</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;jdbc:script</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:test-data.sql</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/jdbc:embedded-database&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding configuration creates an embedded HSQL database populated with SQL from
<code>schema.sql</code> and <code>test-data.sql</code> resources in the root of the classpath. In addition, as
a best practice, the embedded database will be assigned a uniquely generated name. The
embedded database is made available to the Spring container as a bean of type
<code>javax.sql.DataSource</code> which can then be injected into data access objects as needed.</p>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-embedded-database-java"><a class="anchor" href="data-access.html#jdbc-embedded-database-java"></a>3.8.3. Creating an embedded database programmatically</h4>
<div class="paragraph">
<p>The <code>EmbeddedDatabaseBuilder</code> class provides a fluent API for constructing an embedded
database programmatically. Use this when you need to create an embedded database in a
standalone environment or in a standalone integration test like in the following example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EmbeddedDatabase db = <span class="keyword">new</span> EmbeddedDatabaseBuilder()
        .generateUniqueName(<span class="predefined-constant">true</span>)
        .setType(H2)
        .setScriptEncoding(<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>)
        .ignoreFailedDrops(<span class="predefined-constant">true</span>)
        .addScript(<span class="string"><span class="delimiter">&quot;</span><span class="content">schema.sql</span><span class="delimiter">&quot;</span></span>)
        .addScripts(<span class="string"><span class="delimiter">&quot;</span><span class="content">user_data.sql</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">country_data.sql</span><span class="delimiter">&quot;</span></span>)
        .build();

<span class="comment">// perform actions against the db (EmbeddedDatabase extends javax.sql.DataSource)</span>

db.shutdown()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Consult the Javadoc for <code>EmbeddedDatabaseBuilder</code> for further details on all supported
options.</p>
</div>
<div class="paragraph">
<p>The <code>EmbeddedDatabaseBuilder</code> can also be used to create an embedded database using Java
Config like in the following example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Configuration</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">DataSourceConfig</span> {

    <span class="annotation">@Bean</span>
    <span class="directive">public</span> <span class="predefined-type">DataSource</span> dataSource() {
        <span class="keyword">return</span> <span class="keyword">new</span> EmbeddedDatabaseBuilder()
                .generateUniqueName(<span class="predefined-constant">true</span>)
                .setType(H2)
                .setScriptEncoding(<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>)
                .ignoreFailedDrops(<span class="predefined-constant">true</span>)
                .addScript(<span class="string"><span class="delimiter">&quot;</span><span class="content">schema.sql</span><span class="delimiter">&quot;</span></span>)
                .addScripts(<span class="string"><span class="delimiter">&quot;</span><span class="content">user_data.sql</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">country_data.sql</span><span class="delimiter">&quot;</span></span>)
                .build();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-embedded-database-types"><a class="anchor" href="data-access.html#jdbc-embedded-database-types"></a>3.8.4. Selecting the embedded database type</h4>
<div class="sect4">
<h5 id="jdbc-embedded-database-using-HSQL"><a class="anchor" href="data-access.html#jdbc-embedded-database-using-HSQL"></a>Using HSQL</h5>
<div class="paragraph">
<p>Spring supports HSQL 1.8.0 and above. HSQL is the default embedded database if no type is
specified explicitly. To specify HSQL explicitly, set the <code>type</code> attribute of the
<code>embedded-database</code> tag to <code>HSQL</code>. If you are using the builder API, call the
<code>setType(EmbeddedDatabaseType)</code> method with <code>EmbeddedDatabaseType.HSQL</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="jdbc-embedded-database-using-H2"><a class="anchor" href="data-access.html#jdbc-embedded-database-using-H2"></a>Using H2</h5>
<div class="paragraph">
<p>Spring supports the H2 database as well. To enable H2, set the <code>type</code> attribute of the
<code>embedded-database</code> tag to <code>H2</code>. If you are using the builder API, call the
<code>setType(EmbeddedDatabaseType)</code> method with <code>EmbeddedDatabaseType.H2</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="jdbc-embedded-database-using-Derby"><a class="anchor" href="data-access.html#jdbc-embedded-database-using-Derby"></a>Using Derby</h5>
<div class="paragraph">
<p>Spring also supports Apache Derby 10.5 and above. To enable Derby, set the <code>type</code>
attribute of the <code>embedded-database</code> tag to <code>DERBY</code>. If you are using the builder API,
call the <code>setType(EmbeddedDatabaseType)</code> method with <code>EmbeddedDatabaseType.DERBY</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-embedded-database-dao-testing"><a class="anchor" href="data-access.html#jdbc-embedded-database-dao-testing"></a>3.8.5. Testing data access logic with an embedded database</h4>
<div class="paragraph">
<p>Embedded databases provide a lightweight way to test data access code. The following is a
data access integration test template that uses an embedded database. Using a template
like this can be useful for <em>one-offs</em> when the embedded database does not need to be
reused across test classes. However, if you wish to create an embedded database that is
shared within a test suite, consider using the <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/testing.html#testcontext-framework">Spring TestContext
Framework</a> and configuring the embedded database as a bean in the Spring
<code>ApplicationContext</code> as described in <a href="data-access.html#jdbc-embedded-database-xml">Creating an embedded database using Spring XML</a> and
<a href="data-access.html#jdbc-embedded-database-java">Creating an embedded database programmatically</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">DataAccessIntegrationTestTemplate</span> {

    <span class="directive">private</span> EmbeddedDatabase db;

    <span class="annotation">@Before</span>
    <span class="directive">public</span> <span class="type">void</span> setUp() {
        <span class="comment">// creates an HSQL in-memory database populated from default scripts</span>
        <span class="comment">// classpath:schema.sql and classpath:data.sql</span>
        db = <span class="keyword">new</span> EmbeddedDatabaseBuilder()
                .generateUniqueName(<span class="predefined-constant">true</span>)
                .addDefaultScripts()
                .build();
    }

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> testDataAccess() {
        JdbcTemplate template = <span class="keyword">new</span> JdbcTemplate(db);
        template.query( <span class="comment">/* ... */</span> );
    }

    <span class="annotation">@After</span>
    <span class="directive">public</span> <span class="type">void</span> tearDown() {
        db.shutdown();
    }

}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-embedded-database-unique-names"><a class="anchor" href="data-access.html#jdbc-embedded-database-unique-names"></a>3.8.6. Generating unique names for embedded databases</h4>
<div class="paragraph">
<p>Development teams often encounter errors with embedded databases if their test suite
inadvertently attempts to recreate additional instances of the same database. This can
happen quite easily if an XML configuration file or <code>@Configuration</code> class is responsible
for creating an embedded database and the corresponding configuration is then reused
across multiple testing scenarios within the same test suite (i.e., within the same JVM
process) - for example, integration tests against embedded databases whose
<code>ApplicationContext</code> configuration only differs with regard to which bean definition
profiles are active.</p>
</div>
<div class="paragraph">
<p>The root cause of such errors is the fact that Spring&#8217;s <code>EmbeddedDatabaseFactory</code> (used
internally by both the <code>&lt;jdbc:embedded-database&gt;</code> XML namespace element and the
<code>EmbeddedDatabaseBuilder</code> for Java Config) will set the name of the embedded database to
<code>"testdb"</code> if not otherwise specified. For the case of <code>&lt;jdbc:embedded-database&gt;</code>, the
embedded database is typically assigned a name equal to the bean&#8217;s <code>id</code> (i.e., often
something like <code>"dataSource"</code>). Thus, subsequent attempts to create an embedded database
will not result in a new database. Instead, the same JDBC connection URL will be reused,
and attempts to create a new embedded database will actually point to an existing
embedded database created from the same configuration.</p>
</div>
<div class="paragraph">
<p>To address this common issue Spring Framework 4.2 provides support for generating
<em>unique</em> names for embedded databases. To enable the use of generated names, use one of
the following options.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>EmbeddedDatabaseFactory.setGenerateUniqueDatabaseName()</code></p>
</li>
<li>
<p><code>EmbeddedDatabaseBuilder.generateUniqueName()</code></p>
</li>
<li>
<p><code>&lt;jdbc:embedded-database generate-name="true" &#8230;&#8203; &gt;</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-embedded-database-extension"><a class="anchor" href="data-access.html#jdbc-embedded-database-extension"></a>3.8.7. Extending the embedded database support</h4>
<div class="paragraph">
<p>Spring JDBC embedded database support can be extended in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>EmbeddedDatabaseConfigurer</code> to support a new embedded database type.</p>
</li>
<li>
<p>Implement <code>DataSourceFactory</code> to support a new <code>DataSource</code> implementation, such as a
connection pool to manage embedded database connections.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You are encouraged to contribute back extensions to the Spring community at
<a href="https://jira.spring.io/browse/SPR">jira.spring.io</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jdbc-initializing-datasource"><a class="anchor" href="data-access.html#jdbc-initializing-datasource"></a>3.9. Initializing a DataSource</h3>
<div class="paragraph">
<p>The <code>org.springframework.jdbc.datasource.init</code> package provides support for initializing
an existing <code>DataSource</code>. The embedded database support provides one option for creating
and initializing a <code>DataSource</code> for an application, but sometimes you need to initialize
an instance running on a server somewhere.</p>
</div>
<div class="sect3">
<h4 id="jdbc-initializing-datasource-xml"><a class="anchor" href="data-access.html#jdbc-initializing-datasource-xml"></a>3.9.1. Initializing a database using Spring XML</h4>
<div class="paragraph">
<p>If you want to initialize a database and you can provide a reference to a <code>DataSource</code>
bean, use the <code>initialize-database</code> tag in the <code>spring-jdbc</code> namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;jdbc:initialize-database</span> <span class="attribute-name">data-source</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;jdbc:script</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:com/foo/sql/db-schema.sql</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;jdbc:script</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:com/foo/sql/db-test-data.sql</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/jdbc:initialize-database&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above executes the two scripts specified against the database: the first
script creates a schema, and the second populates tables with a test data set. The script
locations can also be patterns with wildcards in the usual ant style used for resources
in Spring (e.g.
<code>classpath*:/com/foo/**/sql/*-data.sql</code>). If a
pattern is used, the scripts are executed in lexical order of their URL or filename.</p>
</div>
<div class="paragraph">
<p>The default behavior of the database initializer is to unconditionally execute the
scripts provided. This will not always be what you want, for instance, if you are
executing the scripts against a database that already has test data in it. The likelihood
of accidentally deleting data is reduced by following the common pattern (as shown above)
of creating the tables first and then inserting the data&#8201;&#8212;&#8201;the first step will fail if
the tables already exist.</p>
</div>
<div class="paragraph">
<p>However, to gain more control over the creation and deletion of existing data, the XML
namespace provides a few additional options. The first is a flag to switch the
initialization on and off. This can be set according to the environment (e.g. to pull a
boolean value from system properties or an environment bean), for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;jdbc:initialize-database</span> <span class="attribute-name">data-source</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span>
    <span class="error"><strong></span><span class="error"></strong></span><span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{systemProperties.INITIALIZE_DATABASE}</span><span class="delimiter">&quot;</span></span><span class="error"><strong></span><span class="error"></strong></span><span class="tag">&gt;</span>
    <span class="tag">&lt;jdbc:script</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/jdbc:initialize-database&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The second option to control what happens with existing data is to be more tolerant of
failures. To this end you can control the ability of the initializer to ignore certain
errors in the SQL it executes from the scripts, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;jdbc:initialize-database</span> <span class="attribute-name">data-source</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="error"><strong></span><span class="error"></strong></span><span class="attribute-name">ignore-failures</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DROPS</span><span class="delimiter">&quot;</span></span><span class="error"><strong></span><span class="error"></strong></span><span class="tag">&gt;</span>
    <span class="tag">&lt;jdbc:script</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/jdbc:initialize-database&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example we are saying we expect that sometimes the scripts will be executed
against an empty database, and there are some <code>DROP</code> statements in the scripts which
would therefore fail. So failed SQL <code>DROP</code> statements will be ignored, but other failures
will cause an exception. This is useful if your SQL dialect doesn&#8217;t support <code>DROP &#8230;&#8203; IF
EXISTS</code> (or similar) but you want to unconditionally remove all test data before
re-creating it. In that case the first script is usually a set of <code>DROP</code> statements,
followed by a set of <code>CREATE</code> statements.</p>
</div>
<div class="paragraph">
<p>The <code>ignore-failures</code> option can be set to <code>NONE</code> (the default), <code>DROPS</code> (ignore failed
drops), or <code>ALL</code> (ignore all failures).</p>
</div>
<div class="paragraph">
<p>Each statement should be separated by <code>;</code> or a new line if the <code>;</code> character is not
present at all in the script. You can control that globally or script by script, for
example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;jdbc:initialize-database</span> <span class="attribute-name">data-source</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="error"><strong></span><span class="error"></strong></span><span class="attribute-name">separator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">@@</span><span class="delimiter">&quot;</span></span><span class="error"><strong></span><span class="error"></strong></span><span class="tag">&gt;</span>
    <span class="tag">&lt;jdbc:script</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:com/foo/sql/db-schema.sql</span><span class="delimiter">&quot;</span></span> <span class="error"><strong></span><span class="error"></strong></span><span class="attribute-name">separator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">;</span><span class="delimiter">&quot;</span></span><span class="error"><strong></span><span class="error"></strong></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;jdbc:script</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:com/foo/sql/db-test-data-1.sql</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;jdbc:script</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:com/foo/sql/db-test-data-2.sql</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/jdbc:initialize-database&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the two <code>test-data</code> scripts use <code>@@</code> as statement separator and only
the <code>db-schema.sql</code> uses <code>;</code>. This configuration specifies that the default separator
is <code>@@</code> and override that default for the <code>db-schema</code> script.</p>
</div>
<div class="paragraph">
<p>If you need more control than you get from the XML namespace, you can simply use the
<code>DataSourceInitializer</code> directly and define it as a component in your application.</p>
</div>
<div class="sect4">
<h5 id="jdbc-client-component-initialization"><a class="anchor" href="data-access.html#jdbc-client-component-initialization"></a>Initialization of other components that depend on the database</h5>
<div class="paragraph">
<p>A large class of applications can just use the database initializer with no further
complications: those that do not use the database until after the Spring context has
started. If your application is <em>not</em> one of those then you might need to read the rest
of this section.</p>
</div>
<div class="paragraph">
<p>The database initializer depends on a <code>DataSource</code> instance and executes the scripts
provided in its initialization callback (analogous to an <code>init-method</code> in an XML bean
definition, a <code>@PostConstruct</code> method in a component, or the <code>afterPropertiesSet()</code>
method in a component that implements <code>InitializingBean</code>). If other beans depend on the
same data source and also use the data source in an initialization callback, then there
might be a problem because the data has not yet been initialized. A common example of
this is a cache that initializes eagerly and loads data from the database on application
startup.</p>
</div>
<div class="paragraph">
<p>To get around this issue you have two options: change your cache initialization strategy
to a later phase, or ensure that the database initializer is initialized first.</p>
</div>
<div class="paragraph">
<p>The first option might be easy if the application is in your control, and not otherwise.
Some suggestions for how to implement this include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make the cache initialize lazily on first usage, which improves application startup
time.</p>
</li>
<li>
<p>Have your cache or a separate component that initializes the cache implement
<code>Lifecycle</code> or <code>SmartLifecycle</code>. When the application context starts up a
<code>SmartLifecycle</code> can be automatically started if its <code>autoStartup</code> flag is set, and a
<code>Lifecycle</code> can be started manually by calling <code>ConfigurableApplicationContext.start()</code>
on the enclosing context.</p>
</li>
<li>
<p>Use a Spring <code>ApplicationEvent</code> or similar custom observer mechanism to trigger the
cache initialization. <code>ContextRefreshedEvent</code> is always published by the context when
it is ready for use (after all beans have been initialized), so that is often a useful
hook (this is how the <code>SmartLifecycle</code> works by default).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The second option can also be easy. Some suggestions on how to implement this include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Rely on the default behavior of the Spring <code>BeanFactory</code>, which is that beans are
initialized in registration order. You can easily arrange that by adopting the common
practice of a set of <code>&lt;import/&gt;</code> elements in XML configuration that order your
application modules, and ensure that the database and database initialization are
listed first.</p>
</li>
<li>
<p>Separate the <code>DataSource</code> and the business components that use it, and control their
startup order by putting them in separate <code>ApplicationContext</code> instances (e.g. the
parent context contains the <code>DataSource</code>, and child context contains the business
components). This structure is common in Spring web applications but can be more
generally applied.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="orm"><a class="anchor" href="data-access.html#orm"></a>4. Object Relational Mapping (ORM) Data Access</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="orm-introduction"><a class="anchor" href="data-access.html#orm-introduction"></a>4.1. Introduction to ORM with Spring</h3>
<div class="paragraph">
<p>The Spring Framework supports integration with the Java Persistence API (JPA) as well
as native Hibernate for resource management, data access object (DAO) implementations,
and transaction strategies. For example, for Hibernate there is first-class support with
several convenient IoC features that address many typical Hibernate integration issues.
You can configure all of the supported features for O/R (object relational) mapping
tools through Dependency Injection. They can participate in Spring&#8217;s resource and
transaction management, and they comply with Spring&#8217;s generic transaction and DAO
exception hierarchies. The recommended integration style is to code DAOs against plain
Hibernate or JPA APIs.</p>
</div>
<div class="paragraph">
<p>Spring adds significant enhancements to the ORM layer of your choice when you create
data access applications. You can leverage as much of the integration support as you
wish, and you should compare this integration effort with the cost and risk of building
a similar infrastructure in-house. You can use much of the ORM support as you would a
library, regardless of technology, because everything is designed as a set of reusable
JavaBeans. ORM in a Spring IoC container facilitates configuration and deployment. Thus
most examples in this section show configuration inside a Spring container.</p>
</div>
<div class="paragraph">
<p>Benefits of using the Spring Framework to create your ORM DAOs include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Easier testing.</em> Spring&#8217;s IoC approach makes it easy to swap the implementations
and configuration locations of Hibernate <code>SessionFactory</code> instances, JDBC <code>DataSource</code>
instances, transaction managers, and mapped object implementations (if needed). This
in turn makes it much easier to test each piece of persistence-related code in
isolation.</p>
</li>
<li>
<p><em>Common data access exceptions.</em> Spring can wrap exceptions from your ORM tool,
converting them from proprietary (potentially checked) exceptions to a common runtime
DataAccessException hierarchy. This feature allows you to handle most persistence
exceptions, which are non-recoverable, only in the appropriate layers, without
annoying boilerplate catches, throws, and exception declarations. You can still trap
and handle exceptions as necessary. Remember that JDBC exceptions (including
DB-specific dialects) are also converted to the same hierarchy, meaning that you can
perform some operations with JDBC within a consistent programming model.</p>
</li>
<li>
<p><em>General resource management.</em> Spring application contexts can handle the location
and configuration of Hibernate <code>SessionFactory</code> instances, JPA <code>EntityManagerFactory</code>
instances, JDBC <code>DataSource</code> instances, and other related resources. This makes these
values easy to manage and change. Spring offers efficient, easy, and safe handling of
persistence resources. For example, related code that uses Hibernate generally needs to
use the same Hibernate <code>Session</code> to ensure efficiency and proper transaction handling.
Spring makes it easy to create and bind a <code>Session</code> to the current thread transparently,
by exposing a current <code>Session</code> through the Hibernate <code>SessionFactory</code>. Thus Spring
solves many chronic problems of typical Hibernate usage, for any local or JTA
transaction environment.</p>
</li>
<li>
<p><em>Integrated transaction management.</em> You can wrap your ORM code with a declarative,
aspect-oriented programming (AOP) style method interceptor either through the
<code>@Transactional</code> annotation or by explicitly configuring the transaction AOP advice in
an XML configuration file. In both cases, transaction semantics and exception handling
(rollback, and so on) are handled for you. As discussed below, in
<a href="data-access.html#orm-resource-mngmnt">Resource and transaction management</a>, you can also swap various
transaction managers, without affecting your ORM-related code. For example, you can
swap between local transactions and JTA, with the same full services (such as
declarative transactions) available in both scenarios. Additionally, JDBC-related code
can fully integrate transactionally with the code you use to do ORM. This is useful
for data access that is not suitable for ORM, such as batch processing and BLOB
streaming, which still need to share common transactions with ORM operations.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For more comprehensive ORM support, including support for alternative database
technologies such as MongoDB, you might want to check out the
<a href="https://projects.spring.io/spring-data/">Spring Data</a> suite of projects. If you are
a JPA user, the <a href="https://spring.io/guides/gs/accessing-data-jpa/">Getting Started Accessing
Data with JPA</a> guide from <a href="https://spring.io" class="bare">https://spring.io</a> provides a great introduction.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="orm-general"><a class="anchor" href="data-access.html#orm-general"></a>4.2. General ORM integration considerations</h3>
<div class="paragraph">
<p>This section highlights considerations that apply to all ORM technologies. The
<a href="data-access.html#orm-hibernate">Hibernate</a> section provides more details and also show these features and
configurations in a concrete context.</p>
</div>
<div class="paragraph">
<p>The major goal of Spring&#8217;s ORM integration is clear application layering, with any data
access and transaction technology, and for loose coupling of application objects. No
more business service dependencies on the data access or transaction strategy, no more
hard-coded resource lookups, no more hard-to-replace singletons, no more custom service
registries. One simple and consistent approach to wiring up application objects, keeping
them as reusable and free from container dependencies as possible. All the individual
data access features are usable on their own but integrate nicely with Spring&#8217;s
application context concept, providing XML-based configuration and cross-referencing of
plain JavaBean instances that need not be Spring-aware. In a typical Spring application,
many important objects are JavaBeans: data access templates, data access objects,
transaction managers, business services that use the data access objects and transaction
managers, web view resolvers, web controllers that use the business services,and so on.</p>
</div>
<div class="sect3">
<h4 id="orm-resource-mngmnt"><a class="anchor" href="data-access.html#orm-resource-mngmnt"></a>4.2.1. Resource and transaction management</h4>
<div class="paragraph">
<p>Typical business applications are cluttered with repetitive resource management code.
Many projects try to invent their own solutions, sometimes sacrificing proper handling
of failures for programming convenience. Spring advocates simple solutions for proper
resource handling, namely IoC through templating in the case of JDBC and applying AOP
interceptors for the ORM technologies.</p>
</div>
<div class="paragraph">
<p>The infrastructure provides proper resource handling and appropriate conversion of
specific API exceptions to an unchecked infrastructure exception hierarchy. Spring
introduces a DAO exception hierarchy, applicable to any data access strategy. For direct
JDBC, the <code>JdbcTemplate</code> class mentioned in a previous section provides connection
handling and proper conversion of <code>SQLException</code> to the <code>DataAccessException</code> hierarchy,
including translation of database-specific SQL error codes to meaningful exception
classes. For ORM technologies, see the next section for how to get the same exception
translation benefits.</p>
</div>
<div class="paragraph">
<p>When it comes to transaction management, the <code>JdbcTemplate</code> class hooks in to the Spring
transaction support and supports both JTA and JDBC transactions, through respective
Spring transaction managers. For the supported ORM technologies Spring offers Hibernate
and JPA support through the Hibernate and JPA transaction managers as well as JTA support.
For details on transaction support, see the <a href="data-access.html#transaction">Transaction Management</a> chapter.</p>
</div>
</div>
<div class="sect3">
<h4 id="orm-exception-translation"><a class="anchor" href="data-access.html#orm-exception-translation"></a>4.2.2. Exception translation</h4>
<div class="paragraph">
<p>When you use Hibernate or JPA in a DAO, you must decide how to handle the persistence
technology&#8217;s native exception classes. The DAO throws a subclass of a <code>HibernateException</code>
or <code>PersistenceException</code> depending on the technology. These exceptions are all runtime
exceptions and do not have to be declared or caught. You may also have to deal with
<code>IllegalArgumentException</code> and <code>IllegalStateException</code>. This means that callers can only
treat exceptions as generally fatal, unless they want to depend on the persistence
technology&#8217;s own exception structure. Catching specific causes such as an optimistic
locking failure is not possible without tying the caller to the implementation strategy.
This trade-off might be acceptable to applications that are strongly ORM-based and/or
do not need any special exception treatment. However, Spring enables exception
translation to be applied transparently through the <code>@Repository</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Repository</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ProductDaoImpl</span> <span class="directive">implements</span> ProductDao {

    <span class="comment">// class body here...</span>

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans&gt;</span>

    <span class="comment">&lt;!-- Exception translation bean post processor --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.dao.annotation.PersistenceExceptionTranslationPostProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myProductDao</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">product.ProductDaoImpl</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The postprocessor automatically looks for all exception translators (implementations of
the <code>PersistenceExceptionTranslator</code> interface) and advises all beans marked with the
<code>@Repository</code> annotation so that the discovered translators can intercept and apply the
appropriate translation on the thrown exceptions.</p>
</div>
<div class="paragraph">
<p>In summary: you can implement DAOs based on the plain persistence technology&#8217;s API and
annotations, while still benefiting from Spring-managed transactions, dependency
injection, and transparent exception conversion (if desired) to Spring&#8217;s custom
exception hierarchies.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="orm-hibernate"><a class="anchor" href="data-access.html#orm-hibernate"></a>4.3. Hibernate</h3>
<div class="paragraph">
<p>We will start with a coverage of <a href="http://www.hibernate.org/">Hibernate 5</a> in a Spring
environment, using it to demonstrate the approach that Spring takes towards integrating
O/R mappers. This section will cover many issues in detail and show different variations
of DAO implementations and transaction demarcation. Most of these patterns can be
directly translated to all other supported ORM tools. The following sections in this
chapter will then cover the other ORM technologies, showing briefer examples there.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As of Spring Framework 5.0, Spring requires Hibernate ORM 4.3 or later for JPA support
and even Hibernate ORM 5.0+ for programming against the native Hibernate Session API.
Note that the Hibernate team does not maintain any versions prior to 5.0 anymore and
is likely to focus on 5.2+ exclusively soon.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="orm-session-factory-setup"><a class="anchor" href="data-access.html#orm-session-factory-setup"></a>4.3.1. SessionFactory setup in a Spring container</h4>
<div class="paragraph">
<p>To avoid tying application objects to hard-coded resource lookups, you can define
resources such as a JDBC <code>DataSource</code> or a Hibernate <code>SessionFactory</code> as beans in the
Spring container. Application objects that need to access resources receive references
to such predefined instances through bean references, as illustrated in the DAO
definition in the next section.</p>
</div>
<div class="paragraph">
<p>The following excerpt from an XML application context definition shows how to set up a
JDBC <code>DataSource</code> and a Hibernate <code>SessionFactory</code> on top of it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.commons.dbcp.BasicDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">destroy-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">close</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">driverClassName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.hsqldb.jdbcDriver</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:hsqldb:hsql://localhost:9001</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sa</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mySessionFactory</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.orm.hibernate5.LocalSessionFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myDataSource</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mappingResources</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;list&gt;</span>
                <span class="tag">&lt;value&gt;</span>product.hbm.xml<span class="tag">&lt;/value&gt;</span>
            <span class="tag">&lt;/list&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernateProperties</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;value&gt;</span>
                hibernate.dialect=org.hibernate.dialect.HSQLDialect
            <span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Switching from a local Jakarta Commons DBCP <code>BasicDataSource</code> to a JNDI-located
<code>DataSource</code> (usually managed by an application server) is just a matter of
configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans&gt;</span>
    <span class="tag">&lt;jee:jndi-lookup</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">jndi-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java:comp/env/jdbc/myds</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also access a JNDI-located <code>SessionFactory</code>, using Spring&#8217;s
<code>JndiObjectFactoryBean</code> / <code>&lt;jee:jndi-lookup&gt;</code> to retrieve and expose it. However, that
is typically not common outside of an EJB context.</p>
</div>
</div>
<div class="sect3">
<h4 id="orm-hibernate-straight"><a class="anchor" href="data-access.html#orm-hibernate-straight"></a>4.3.2. Implementing DAOs based on plain Hibernate API</h4>
<div class="paragraph">
<p>Hibernate has a feature called contextual sessions, wherein Hibernate itself manages
one current <code>Session</code> per transaction. This is roughly equivalent to Spring&#8217;s
synchronization of one Hibernate <code>Session</code> per transaction. A corresponding DAO
implementation resembles the following example, based on the plain Hibernate API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ProductDaoImpl</span> <span class="directive">implements</span> ProductDao {

    <span class="directive">private</span> SessionFactory sessionFactory;

    <span class="directive">public</span> <span class="type">void</span> setSessionFactory(SessionFactory sessionFactory) {
        <span class="local-variable">this</span>.sessionFactory = sessionFactory;
    }

    <span class="directive">public</span> <span class="predefined-type">Collection</span> loadProductsByCategory(<span class="predefined-type">String</span> category) {
        <span class="keyword">return</span> <span class="local-variable">this</span>.sessionFactory.getCurrentSession()
                .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">from test.Product product where product.category=?</span><span class="delimiter">&quot;</span></span>)
                .setParameter(<span class="integer">0</span>, category)
                .list();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This style is similar to that of the Hibernate reference documentation and examples,
except for holding the <code>SessionFactory</code> in an instance variable. We strongly recommend
such an instance-based setup over the old-school <code>static</code> <code>HibernateUtil</code> class from
Hibernate&#8217;s CaveatEmptor sample application. (In general, do not keep any resources in
<code>static</code> variables unless <em>absolutely</em> necessary.)</p>
</div>
<div class="paragraph">
<p>The above DAO follows the dependency injection pattern: it fits nicely into a Spring IoC
container, just as it would if coded against Spring&#8217;s <code>HibernateTemplate</code>. Of course,
such a DAO can also be set up in plain Java (for example, in unit tests). Simply
instantiate it and call <code>setSessionFactory(..)</code> with the desired factory reference. As a
Spring bean definition, the DAO would resemble the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myProductDao</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">product.ProductDaoImpl</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessionFactory</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mySessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The main advantage of this DAO style is that it depends on Hibernate API only; no import
of any Spring class is required. This is of course appealing from a non-invasiveness
perspective, and will no doubt feel more natural to Hibernate developers.</p>
</div>
<div class="paragraph">
<p>However, the DAO throws plain <code>HibernateException</code> (which is unchecked, so does not have
to be declared or caught), which means that callers can only treat exceptions as
generally fatal - unless they want to depend on Hibernate&#8217;s own exception hierarchy.
Catching specific causes such as an optimistic locking failure is not possible without
tying the caller to the implementation strategy. This trade off might be acceptable to
applications that are strongly Hibernate-based and/or do not need any special exception
treatment.</p>
</div>
<div class="paragraph">
<p>Fortunately, Spring&#8217;s <code>LocalSessionFactoryBean</code> supports Hibernate&#8217;s
<code>SessionFactory.getCurrentSession()</code> method for any Spring transaction strategy,
returning the current Spring-managed transactional <code>Session</code> even with
<code>HibernateTransactionManager</code>. Of course, the standard behavior of that method remains
the return of the current <code>Session</code> associated with the ongoing JTA transaction, if any.
This behavior applies regardless of whether you are using Spring&#8217;s
<code>JtaTransactionManager</code>, EJB container managed transactions (CMTs), or JTA.</p>
</div>
<div class="paragraph">
<p>In summary: you can implement DAOs based on the plain Hibernate API, while still being
able to participate in Spring-managed transactions.</p>
</div>
</div>
<div class="sect3">
<h4 id="orm-hibernate-tx-declarative"><a class="anchor" href="data-access.html#orm-hibernate-tx-declarative"></a>4.3.3. Declarative transaction demarcation</h4>
<div class="paragraph">
<p>We recommend that you use Spring&#8217;s declarative transaction support, which enables you to
replace explicit transaction demarcation API calls in your Java code with an AOP
transaction interceptor. This transaction interceptor can be configured in a Spring
container using either Java annotations or XML. This declarative transaction capability
allows you to keep business services free of repetitive transaction demarcation code and
to focus on adding business logic, which is the real value of your application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Prior to continuing, you are <em>strongly</em> encouraged to read <a href="data-access.html#transaction-declarative">Declarative transaction management</a>
if you have not done so.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You may annotate the service layer with <code>@Transactional</code> annotations and instruct the
Spring container to find these annotations and provide transactional semantics for
these annotated methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ProductServiceImpl</span> <span class="directive">implements</span> ProductService {

    <span class="directive">private</span> ProductDao productDao;

    <span class="directive">public</span> <span class="type">void</span> setProductDao(ProductDao productDao) {
        <span class="local-variable">this</span>.productDao = productDao;
    }

    <span class="annotation">@Transactional</span>
    <span class="directive">public</span> <span class="type">void</span> increasePriceOfAllProductsInCategory(<span class="directive">final</span> <span class="predefined-type">String</span> category) {
        <span class="predefined-type">List</span> productsToChange = <span class="local-variable">this</span>.productDao.loadProductsByCategory(category);
        <span class="comment">// ...</span>
    }

    <span class="annotation">@Transactional</span>(readOnly = <span class="predefined-constant">true</span>)
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;Product&gt; findAllProducts() {
        <span class="keyword">return</span> <span class="local-variable">this</span>.productDao.findAllProducts();
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All you need to set up in the container is the <code>PlatformTransactionManager</code>
implementation as a bean as well as a "&lt;tx:annotation-driven/&gt;" entry,
opting into <code>@Transactional</code> processing at runtime.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:aop</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/aop</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:tx</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/tx</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
        <span class="content">http://www.springframework.org/schema/beans</span>
        <span class="content">http://www.springframework.org/schema/beans/spring-beans.xsd</span>
        <span class="content">http://www.springframework.org/schema/tx</span>
        <span class="content">http://www.springframework.org/schema/tx/spring-tx.xsd</span>
        <span class="content">http://www.springframework.org/schema/aop</span>
        <span class="content">http://www.springframework.org/schema/aop/spring-aop.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- SessionFactory, DataSource, etc. omitted --&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.orm.hibernate5.HibernateTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessionFactory</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;tx:annotation-driven</span><span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myProductService</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">product.SimpleProductService</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">productDao</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myProductDao</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="orm-hibernate-tx-programmatic"><a class="anchor" href="data-access.html#orm-hibernate-tx-programmatic"></a>4.3.4. Programmatic transaction demarcation</h4>
<div class="paragraph">
<p>You can demarcate transactions in a higher level of the application, on top of such
lower-level data access services spanning any number of operations. Nor do restrictions
exist on the implementation of the surrounding business service; it just needs a Spring
<code>PlatformTransactionManager</code>. Again, the latter can come from anywhere, but preferably
as a bean reference through a <code>setTransactionManager(..)</code> method, just as the
<code>productDAO</code> should be set by a <code>setProductDao(..)</code> method. The following snippets show
a transaction manager and a business service definition in a Spring application context,
and an example for a business method implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myTxManager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.orm.hibernate5.HibernateTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessionFactory</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mySessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myProductService</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">product.ProductServiceImpl</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myTxManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">productDao</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myProductDao</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ProductServiceImpl</span> <span class="directive">implements</span> ProductService {

    <span class="directive">private</span> TransactionTemplate transactionTemplate;
    <span class="directive">private</span> ProductDao productDao;

    <span class="directive">public</span> <span class="type">void</span> setTransactionManager(PlatformTransactionManager transactionManager) {
        <span class="local-variable">this</span>.transactionTemplate = <span class="keyword">new</span> TransactionTemplate(transactionManager);
    }

    <span class="directive">public</span> <span class="type">void</span> setProductDao(ProductDao productDao) {
        <span class="local-variable">this</span>.productDao = productDao;
    }

    <span class="directive">public</span> <span class="type">void</span> increasePriceOfAllProductsInCategory(<span class="directive">final</span> <span class="predefined-type">String</span> category) {
        <span class="local-variable">this</span>.transactionTemplate.execute(<span class="keyword">new</span> TransactionCallbackWithoutResult() {
            <span class="directive">public</span> <span class="type">void</span> doInTransactionWithoutResult(TransactionStatus status) {
                <span class="predefined-type">List</span> productsToChange = <span class="local-variable">this</span>.productDao.loadProductsByCategory(category);
                <span class="comment">// do the price increase...</span>
            }
        });
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Spring&#8217;s <code>TransactionInterceptor</code> allows any checked application exception to be thrown
with the callback code, while <code>TransactionTemplate</code> is restricted to unchecked
exceptions within the callback. <code>TransactionTemplate</code> triggers a rollback in case of an
unchecked application exception, or if the transaction is marked rollback-only by the
application (via <code>TransactionStatus</code>). <code>TransactionInterceptor</code> behaves the same way by
default but allows configurable rollback policies per method.</p>
</div>
</div>
<div class="sect3">
<h4 id="orm-hibernate-tx-strategies"><a class="anchor" href="data-access.html#orm-hibernate-tx-strategies"></a>4.3.5. Transaction management strategies</h4>
<div class="paragraph">
<p>Both <code>TransactionTemplate</code> and <code>TransactionInterceptor</code> delegate the actual transaction
handling to a <code>PlatformTransactionManager</code> instance, which can be a
<code>HibernateTransactionManager</code> (for a single Hibernate <code>SessionFactory</code>, using a
<code>ThreadLocal</code> <code>Session</code> under the hood) or a <code>JtaTransactionManager</code> (delegating to the
JTA subsystem of the container) for Hibernate applications. You can even use a custom
<code>PlatformTransactionManager</code> implementation. Switching from native Hibernate transaction
management to JTA, such as when facing distributed transaction requirements for certain
deployments of your application, is just a matter of configuration. Simply replace
the Hibernate transaction manager with Spring&#8217;s JTA transaction implementation. Both
transaction demarcation and data access code will work without changes, because they
just use the generic transaction management APIs.</p>
</div>
<div class="paragraph">
<p>For distributed transactions across multiple Hibernate session factories, simply combine
<code>JtaTransactionManager</code> as a transaction strategy with multiple
<code>LocalSessionFactoryBean</code> definitions. Each DAO then gets one specific <code>SessionFactory</code>
reference passed into its corresponding bean property. If all underlying JDBC data
sources are transactional container ones, a business service can demarcate transactions
across any number of DAOs and any number of session factories without special regard, as
long as it is using <code>JtaTransactionManager</code> as the strategy.</p>
</div>
<div class="paragraph">
<p>Both <code>HibernateTransactionManager</code> and <code>JtaTransactionManager</code> allow for proper
JVM-level cache handling with Hibernate, without container-specific transaction manager
lookup or a JCA connector (if you are not using EJB to initiate transactions).</p>
</div>
<div class="paragraph">
<p><code>HibernateTransactionManager</code> can export the Hibernate JDBC <code>Connection</code> to plain JDBC
access code, for a specific <code>DataSource</code>. This capability allows for high-level
transaction demarcation with mixed Hibernate and JDBC data access completely without
JTA, if you are accessing only one database. <code>HibernateTransactionManager</code> automatically
exposes the Hibernate transaction as a JDBC transaction if you have set up the passed-in
<code>SessionFactory</code> with a <code>DataSource</code> through the <code>dataSource</code> property of the
<code>LocalSessionFactoryBean</code> class. Alternatively, you can specify explicitly the
<code>DataSource</code> for which the transactions are supposed to be exposed through the
<code>dataSource</code> property of the <code>HibernateTransactionManager</code> class.</p>
</div>
</div>
<div class="sect3">
<h4 id="orm-hibernate-resources"><a class="anchor" href="data-access.html#orm-hibernate-resources"></a>4.3.6. Comparing container-managed and locally defined resources</h4>
<div class="paragraph">
<p>You can switch between a container-managed JNDI <code>SessionFactory</code> and a locally defined
one, without having to change a single line of application code. Whether to keep
resource definitions in the container or locally within the application is mainly a
matter of the transaction strategy that you use. Compared to a Spring-defined local
<code>SessionFactory</code>, a manually registered JNDI <code>SessionFactory</code> does not provide any
benefits. Deploying a <code>SessionFactory</code> through Hibernate&#8217;s JCA connector provides the
added value of participating in the Java EE server&#8217;s management infrastructure, but does
not add actual value beyond that.</p>
</div>
<div class="paragraph">
<p>Spring&#8217;s transaction support is not bound to a container. Configured with any strategy
other than JTA, transaction support also works in a stand-alone or test environment.
Especially in the typical case of single-database transactions, Spring&#8217;s single-resource
local transaction support is a lightweight and powerful alternative to JTA. When you use
local EJB stateless session beans to drive transactions, you depend both on an EJB
container and JTA, even if you access only a single database, and only use stateless
session beans to provide declarative transactions through container-managed
transactions. Also, direct use of JTA programmatically requires a Java EE environment as
well. JTA does not involve only container dependencies in terms of JTA itself and of
JNDI <code>DataSource</code> instances. For non-Spring, JTA-driven Hibernate transactions, you have
to use the Hibernate JCA connector, or extra Hibernate transaction code with the
<code>TransactionManagerLookup</code> configured for proper JVM-level caching.</p>
</div>
<div class="paragraph">
<p>Spring-driven transactions can work as well with a locally defined Hibernate
<code>SessionFactory</code> as they do with a local JDBC <code>DataSource</code> if they are accessing a
single database. Thus you only have to use Spring&#8217;s JTA transaction strategy when you
have distributed transaction requirements. A JCA connector requires container-specific
deployment steps, and obviously JCA support in the first place. This configuration
requires more work than deploying a simple web application with local resource
definitions and Spring-driven transactions. Also, you often need the Enterprise Edition
of your container if you are using, for example, WebLogic Express, which does not
provide JCA. A Spring application with local resources and transactions spanning one
single database works in any Java EE web container (without JTA, JCA, or EJB) such as
Tomcat, Resin, or even plain Jetty. Additionally, you can easily reuse such a middle
tier in desktop applications or test suites.</p>
</div>
<div class="paragraph">
<p>All things considered, if you do not use EJBs, stick with local <code>SessionFactory</code> setup
and Spring&#8217;s <code>HibernateTransactionManager</code> or <code>JtaTransactionManager</code>. You get all of
the benefits, including proper transactional JVM-level caching and distributed
transactions, without the inconvenience of container deployment. JNDI registration of a
Hibernate <code>SessionFactory</code> through the JCA connector only adds value when used in
conjunction with EJBs.</p>
</div>
</div>
<div class="sect3">
<h4 id="orm-hibernate-invalid-jdbc-access-error"><a class="anchor" href="data-access.html#orm-hibernate-invalid-jdbc-access-error"></a>4.3.7. Spurious application server warnings with Hibernate</h4>
<div class="paragraph">
<p>In some JTA environments with very strict <code>XADataSource</code> implementations&#8201;&#8212;&#8201;currently
only some WebLogic Server and WebSphere versions&#8201;&#8212;&#8201;when Hibernate is configured without
regard to the JTA <code>PlatformTransactionManager</code> object for that environment, it is
possible for spurious warning or exceptions to show up in the application server log.
These warnings or exceptions indicate that the connection being accessed is no longer
valid, or JDBC access is no longer valid, possibly because the transaction is no longer
active. As an example, here is an actual exception from WebLogic:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>java.sql.SQLException: The transaction is no longer active - status: 'Committed'. No
further JDBC access is allowed within this transaction.</pre>
</div>
</div>
<div class="paragraph">
<p>You resolve this warning by simply making Hibernate aware of the JTA
<code>PlatformTransactionManager</code> instance, to which it will synchronize (along with Spring).
You have two options for doing this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If in your application context you are already directly obtaining the JTA
<code>PlatformTransactionManager</code> object (presumably from JNDI through
<code>JndiObjectFactoryBean</code> or <code>&lt;jee:jndi-lookup&gt;</code>) and feeding it, for example, to
Spring&#8217;s <code>JtaTransactionManager</code>, then the easiest way is to specify a reference to
the bean defining this JTA <code>PlatformTransactionManager</code> instance as the value of the
<code>jtaTransactionManager</code> property for <code>LocalSessionFactoryBean.</code> Spring then makes the
object available to Hibernate.</p>
</li>
<li>
<p>More likely you do not already have the JTA <code>PlatformTransactionManager</code> instance,
because Spring&#8217;s <code>JtaTransactionManager</code> can find it itself. Thus you need to
configure Hibernate to look up JTA <code>PlatformTransactionManager</code> directly. You do this
by configuring an application server- specific <code>TransactionManagerLookup</code> class in the
Hibernate configuration, as described in the Hibernate manual.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The remainder of this section describes the sequence of events that occur with and
without Hibernate&#8217;s awareness of the JTA <code>PlatformTransactionManager</code>.</p>
</div>
<div class="paragraph">
<p>When Hibernate is not configured with any awareness of the JTA
<code>PlatformTransactionManager</code>, the following events occur when a JTA transaction commits:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The JTA transaction commits.</p>
</li>
<li>
<p>Spring&#8217;s <code>JtaTransactionManager</code> is synchronized to the JTA transaction, so it is
called back through an <em>afterCompletion</em> callback by the JTA transaction manager.</p>
</li>
<li>
<p>Among other activities, this synchronization can trigger a callback by Spring to
Hibernate, through Hibernate&#8217;s <code>afterTransactionCompletion</code> callback (used to clear
the Hibernate cache), followed by an explicit <code>close()</code> call on the Hibernate Session,
which causes Hibernate to attempt to <code>close()</code> the JDBC Connection.</p>
</li>
<li>
<p>In some environments, this <code>Connection.close()</code> call then triggers the warning or
error, as the application server no longer considers the <code>Connection</code> usable at all,
because the transaction has already been committed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When Hibernate is configured with awareness of the JTA <code>PlatformTransactionManager</code>, the
following events occur when a JTA transaction commits:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the JTA transaction is ready to commit.</p>
</li>
<li>
<p>Spring&#8217;s <code>JtaTransactionManager</code> is synchronized to the JTA transaction, so the
transaction is called back through a <em>beforeCompletion</em> callback by the JTA
transaction manager.</p>
</li>
<li>
<p>Spring is aware that Hibernate itself is synchronized to the JTA transaction, and
behaves differently than in the previous scenario. Assuming the Hibernate <code>Session</code>
needs to be closed at all, Spring will close it now.</p>
</li>
<li>
<p>The JTA transaction commits.</p>
</li>
<li>
<p>Hibernate is synchronized to the JTA transaction, so the transaction is called back
through an <em>afterCompletion</em> callback by the JTA transaction manager, and can
properly clear its cache.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="orm-jpa"><a class="anchor" href="data-access.html#orm-jpa"></a>4.4. JPA</h3>
<div class="paragraph">
<p>The Spring JPA, available under the <code>org.springframework.orm.jpa</code> package, offers
comprehensive support for the
<a href="http://www.oracle.com/technetwork/articles/javaee/jpa-137156.html">Java Persistence
API</a> in a similar manner to the integration with Hibernate, while being aware of
the underlying implementation in order to provide additional features.</p>
</div>
<div class="sect3">
<h4 id="orm-jpa-setup"><a class="anchor" href="data-access.html#orm-jpa-setup"></a>4.4.1. Three options for JPA setup in a Spring environment</h4>
<div class="paragraph">
<p>The Spring JPA support offers three ways of setting up the JPA <code>EntityManagerFactory</code>
that will be used by the application to obtain an entity manager.</p>
</div>
<div class="sect4">
<h5 id="orm-jpa-setup-lemfb"><a class="anchor" href="data-access.html#orm-jpa-setup-lemfb"></a>LocalEntityManagerFactoryBean</h5>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Only use this option in simple deployment environments such as stand-alone applications
and integration tests.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>LocalEntityManagerFactoryBean</code> creates an <code>EntityManagerFactory</code> suitable for
simple deployment environments where the application uses only JPA for data access. The
factory bean uses the JPA <code>PersistenceProvider</code> autodetection mechanism (according to
JPA&#8217;s Java SE bootstrapping) and, in most cases, requires you to specify only the
persistence unit name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myEmf</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.orm.jpa.LocalEntityManagerFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">persistenceUnitName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myPersistenceUnit</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This form of JPA deployment is the simplest and the most limited. You cannot refer to an
existing JDBC <code>DataSource</code> bean definition and no support for global transactions
exists. Furthermore, weaving (byte-code transformation) of persistent classes is
provider-specific, often requiring a specific JVM agent to specified on startup. This
option is sufficient only for stand-alone applications and test environments, for which
the JPA specification is designed.</p>
</div>
</div>
<div class="sect4">
<h5 id="orm-jpa-setup-jndi"><a class="anchor" href="data-access.html#orm-jpa-setup-jndi"></a>Obtaining an EntityManagerFactory from JNDI</h5>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use this option when deploying to a Java EE server. Check your server&#8217;s documentation
on how to deploy a custom JPA provider into your server, allowing for a different
provider than the server&#8217;s default.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Obtaining an <code>EntityManagerFactory</code> from JNDI (for example in a Java EE environment),
is simply a matter of changing the XML configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans&gt;</span>
    <span class="tag">&lt;jee:jndi-lookup</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myEmf</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">jndi-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">persistence/myPersistenceUnit</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This action assumes standard Java EE bootstrapping: the Java EE server autodetects
persistence units (in effect, <code>META-INF/persistence.xml</code> files in application jars) and
<code>persistence-unit-ref</code> entries in the Java EE deployment descriptor (for example,
<code>web.xml</code>) and defines environment naming context locations for those persistence units.</p>
</div>
<div class="paragraph">
<p>In such a scenario, the entire persistence unit deployment, including the weaving
(byte-code transformation) of persistent classes, is up to the Java EE server. The JDBC
<code>DataSource</code> is defined through a JNDI location in the <code>META-INF/persistence.xml</code> file;
EntityManager transactions are integrated with the server&#8217;s JTA subsystem. Spring merely
uses the obtained <code>EntityManagerFactory</code>, passing it on to application objects through
dependency injection, and managing transactions for the persistence unit, typically
through <code>JtaTransactionManager</code>.</p>
</div>
<div class="paragraph">
<p>If multiple persistence units are used in the same application, the bean names of such
JNDI-retrieved persistence units should match the persistence unit names that the
application uses to refer to them, for example, in <code>@PersistenceUnit</code> and
<code>@PersistenceContext</code> annotations.</p>
</div>
</div>
<div class="sect4">
<h5 id="orm-jpa-setup-lcemfb"><a class="anchor" href="data-access.html#orm-jpa-setup-lcemfb"></a>LocalContainerEntityManagerFactoryBean</h5>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use this option for full JPA capabilities in a Spring-based application environment.
This includes web containers such as Tomcat as well as stand-alone applications and
integration tests with sophisticated persistence requirements.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>LocalContainerEntityManagerFactoryBean</code> gives full control over
<code>EntityManagerFactory</code> configuration and is appropriate for environments where
fine-grained customization is required. The <code>LocalContainerEntityManagerFactoryBean</code>
creates a <code>PersistenceUnitInfo</code> instance based on the <code>persistence.xml</code> file, the
supplied <code>dataSourceLookup</code> strategy, and the specified <code>loadTimeWeaver</code>. It is thus
possible to work with custom data sources outside of JNDI and to control the weaving
process. The following example shows a typical bean definition for a
<code>LocalContainerEntityManagerFactoryBean</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myEmf</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">someDataSource</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loadTimeWeaver</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.instrument.classloading.InstrumentationLoadTimeWeaver</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example shows a typical <code>persistence.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/persistence</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;persistence-unit</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myUnit</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transaction-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RESOURCE_LOCAL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;mapping-file&gt;</span>META-INF/orm.xml<span class="tag">&lt;/mapping-file&gt;</span>
        <span class="tag">&lt;exclude-unlisted-classes</span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/persistence-unit&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>&lt;exclude-unlisted-classes/&gt;</code> shortcut indicates that <em>no</em> scanning for
annotated entity classes is supposed to occur. An explicit 'true' value specified -
<code>&lt;exclude-unlisted-classes&gt;true&lt;/exclude-unlisted-classes/&gt;</code> - also means no scan.
<code>&lt;exclude-unlisted-classes&gt;false&lt;/exclude-unlisted-classes/&gt;</code> does trigger a scan;
however, it is recommended to simply omit the <code>exclude-unlisted-classes</code> element
if you want entity class scanning to occur.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Using the <code>LocalContainerEntityManagerFactoryBean</code> is the most powerful JPA setup
option, allowing for flexible local configuration within the application. It supports
links to an existing JDBC <code>DataSource</code>, supports both local and global transactions, and
so on. However, it also imposes requirements on the runtime environment, such as the
availability of a weaving-capable class loader if the persistence provider demands
byte-code transformation.</p>
</div>
<div class="paragraph">
<p>This option may conflict with the built-in JPA capabilities of a Java EE server. In a
full Java EE environment, consider obtaining your <code>EntityManagerFactory</code> from JNDI.
Alternatively, specify a custom <code>persistenceXmlLocation</code> on your
<code>LocalContainerEntityManagerFactoryBean</code> definition, for example,
META-INF/my-persistence.xml, and only include a descriptor with that name in your
application jar files. Because the Java EE server only looks for default
<code>META-INF/persistence.xml</code> files, it ignores such custom persistence units and hence
avoid conflicts with a Spring-driven JPA setup upfront. (This applies to Resin 3.1, for
example.)</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">When is load-time weaving required?</div>
<div class="paragraph">
<p>Not all JPA providers require a JVM agent. Hibernate is an example of one that does not.
If your provider does not require an agent or you have other alternatives, such as
applying enhancements at build time through a custom compiler or an ant task, the
load-time weaver <em>should not</em> be used.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>LoadTimeWeaver</code> interface is a Spring-provided class that allows JPA
<code>ClassTransformer</code> instances to be plugged in a specific manner, depending whether the
environment is a web container or application server. Hooking <code>ClassTransformers</code>
through an
<a href="http://docs.oracle.com/javase/6/docs/api/java/lang/instrument/package-summary.html">agent</a>
typically is not efficient. The agents work against the <em>entire virtual machine</em> and
inspect <em>every</em> class that is loaded, which is usually undesirable in a production
server environment.</p>
</div>
<div class="paragraph">
<p>Spring provides a number of <code>LoadTimeWeaver</code> implementations for various environments,
allowing <code>ClassTransformer</code> instances to be applied only <em>per class loader</em> and not
per VM.</p>
</div>
<div class="paragraph">
<p>Refer to <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop-aj-ltw-spring">Spring configuration</a> in the AOP chapter for
more insight regarding the <code>LoadTimeWeaver</code> implementations and their setup, either
generic or customized to various platforms (such as Tomcat, WebLogic, GlassFish,
Resin and JBoss).</p>
</div>
<div class="paragraph">
<p>As described in the aforementioned section, you can configure a context-wide
<code>LoadTimeWeaver</code> using the <code>@EnableLoadTimeWeaving</code> annotation of
<code>context:load-time-weaver</code> XML element. Such a global weaver is picked up by all JPA
<code>LocalContainerEntityManagerFactoryBeans</code> automatically. This is the preferred way of
setting up a load-time weaver, delivering autodetection of the platform (WebLogic,
GlassFish, Tomcat, Resin, JBoss or VM agent) and automatic propagation of the weaver to
all weaver-aware beans:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;context:load-time-weaver</span><span class="tag">/&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">emf</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, if needed, one can manually specify a dedicated weaver through the
<code>loadTimeWeaver</code> property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">emf</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loadTimeWeaver</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.instrument.classloading.ReflectiveLoadTimeWeaver</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>No matter how the LTW is configured, using this technique, JPA applications relying on
instrumentation can run in the target platform (ex: Tomcat) without needing an agent.
This is important especially when the hosting applications rely on different JPA
implementations because the JPA transformers are applied only at class loader level and
thus are isolated from each other.</p>
</div>
</div>
<div class="sect4">
<h5 id="orm-jpa-multiple"><a class="anchor" href="data-access.html#orm-jpa-multiple"></a>Dealing with multiple persistence units</h5>
<div class="paragraph">
<p>For applications that rely on multiple persistence units locations, stored in various
JARS in the classpath, for example, Spring offers the <code>PersistenceUnitManager</code> to act as
a central repository and to avoid the persistence units discovery process, which can be
expensive. The default implementation allows multiple locations to be specified that are
parsed and later retrieved through the persistence unit name. (By default, the classpath
is searched for <code>META-INF/persistence.xml</code> files.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pum</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.orm.jpa.persistenceunit.DefaultPersistenceUnitManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">persistenceXmlLocations</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;list&gt;</span>
            <span class="tag">&lt;value&gt;</span>org/springframework/orm/jpa/domain/persistence-multi.xml<span class="tag">&lt;/value&gt;</span>
            <span class="tag">&lt;value&gt;</span>classpath:/my/package/**/custom-persistence.xml<span class="tag">&lt;/value&gt;</span>
            <span class="tag">&lt;value&gt;</span>classpath*:META-INF/persistence.xml<span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;/list&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSources</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;map&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">localDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">local-db</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remoteDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-db</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="comment">&lt;!-- if no datasource is specified, use this one --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">defaultDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remoteDataSource</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">emf</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">persistenceUnitManager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pum</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">persistenceUnitName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myCustomUnit</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The default implementation allows customization of the <code>PersistenceUnitInfo</code> instances,
before they are fed to the JPA provider, declaratively through its properties, which
affect <em>all</em> hosted units, or programmatically, through the
<code>PersistenceUnitPostProcessor</code>, which allows persistence unit selection. If no
<code>PersistenceUnitManager</code> is specified, one is created and used internally by
<code>LocalContainerEntityManagerFactoryBean</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="orm-jpa-dao"><a class="anchor" href="data-access.html#orm-jpa-dao"></a>4.4.2. Implementing DAOs based on JPA: EntityManagerFactory and EntityManager</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Although <code>EntityManagerFactory</code> instances are thread-safe, <code>EntityManager</code> instances are
not. The injected JPA <code>EntityManager</code> behaves like an <code>EntityManager</code> fetched from an
application server&#8217;s JNDI environment, as defined by the JPA specification. It delegates
all calls to the current transactional <code>EntityManager</code>, if any; otherwise, it falls back
to a newly created <code>EntityManager</code> per operation, in effect making its usage thread-safe.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is possible to write code against the plain JPA without any Spring dependencies, by
using an injected <code>EntityManagerFactory</code> or <code>EntityManager</code>. Spring can understand
<code>@PersistenceUnit</code> and <code>@PersistenceContext</code> annotations both at field and method level
if a <code>PersistenceAnnotationBeanPostProcessor</code> is enabled. A plain JPA DAO implementation
using the <code>@PersistenceUnit</code> annotation might look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ProductDaoImpl</span> <span class="directive">implements</span> ProductDao {

    <span class="directive">private</span> EntityManagerFactory emf;

    <span class="annotation">@PersistenceUnit</span>
    <span class="directive">public</span> <span class="type">void</span> setEntityManagerFactory(EntityManagerFactory emf) {
        <span class="local-variable">this</span>.emf = emf;
    }

    <span class="directive">public</span> <span class="predefined-type">Collection</span> loadProductsByCategory(<span class="predefined-type">String</span> category) {
        EntityManager em = <span class="local-variable">this</span>.emf.createEntityManager();
        <span class="keyword">try</span> {
            <span class="predefined-type">Query</span> query = em.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">from Product as p where p.category = ?1</span><span class="delimiter">&quot;</span></span>);
            query.setParameter(<span class="integer">1</span>, category);
            <span class="keyword">return</span> query.getResultList();
        }
        <span class="keyword">finally</span> {
            <span class="keyword">if</span> (em != <span class="predefined-constant">null</span>) {
                em.close();
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The DAO above has no dependency on Spring and still fits nicely into a Spring
application context. Moreover, the DAO takes advantage of annotations to require the
injection of the default <code>EntityManagerFactory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans&gt;</span>

    <span class="comment">&lt;!-- bean post-processor for JPA annotations --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.orm.jpa.support.PersistenceAnnotationBeanPostProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myProductDao</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">product.ProductDaoImpl</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As an alternative to defining a <code>PersistenceAnnotationBeanPostProcessor</code> explicitly,
consider using the Spring <code>context:annotation-config</code> XML element in your application
context configuration. Doing so automatically registers all Spring standard
post-processors for annotation-based configuration, including
<code>CommonAnnotationBeanPostProcessor</code> and so on.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans&gt;</span>

    <span class="comment">&lt;!-- post-processors for all standard config annotations --&gt;</span>
    <span class="tag">&lt;context:annotation-config</span><span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myProductDao</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">product.ProductDaoImpl</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The main problem with such a DAO is that it always creates a new <code>EntityManager</code> through
the factory. You can avoid this by requesting a transactional <code>EntityManager</code> (also
called "shared EntityManager" because it is a shared, thread-safe proxy for the actual
transactional EntityManager) to be injected instead of the factory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ProductDaoImpl</span> <span class="directive">implements</span> ProductDao {

    <span class="annotation">@PersistenceContext</span>
    <span class="directive">private</span> EntityManager em;

    <span class="directive">public</span> <span class="predefined-type">Collection</span> loadProductsByCategory(<span class="predefined-type">String</span> category) {
        <span class="predefined-type">Query</span> query = em.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">from Product as p where p.category = :category</span><span class="delimiter">&quot;</span></span>);
        query.setParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">category</span><span class="delimiter">&quot;</span></span>, category);
        <span class="keyword">return</span> query.getResultList();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@PersistenceContext</code> annotation has an optional attribute <code>type</code>, which defaults to
<code>PersistenceContextType.TRANSACTION</code>. This default is what you need to receive a shared
EntityManager proxy. The alternative, <code>PersistenceContextType.EXTENDED</code>, is a completely
different affair: This results in a so-called extended EntityManager, which is <em>not
thread-safe</em> and hence must not be used in a concurrently accessed component such as a
Spring-managed singleton bean. Extended EntityManagers are only supposed to be used in
stateful components that, for example, reside in a session, with the lifecycle of the
EntityManager not tied to a current transaction but rather being completely up to the
application.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Method- and field-level Injection</div>
<div class="paragraph">
<p>Annotations that indicate dependency injections (such as <code>@PersistenceUnit</code> and
<code>@PersistenceContext</code>) can be applied on field or methods inside a class, hence the
expressions <em>method-level injection</em> and <em>field-level injection</em>. Field-level
annotations are concise and easier to use while method-level allows for further
processing of the injected dependency. In both cases the member visibility (public,
protected, private) does not matter.</p>
</div>
<div class="paragraph">
<p>What about class-level annotations?</p>
</div>
<div class="paragraph">
<p>On the Java EE platform, they are used for dependency declaration and not for resource
injection.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The injected <code>EntityManager</code> is Spring-managed (aware of the ongoing transaction). It is
important to note that even though the new DAO implementation uses method level
injection of an <code>EntityManager</code> instead of an <code>EntityManagerFactory</code>, no change is
required in the application context XML due to annotation usage.</p>
</div>
<div class="paragraph">
<p>The main advantage of this DAO style is that it only depends on Java Persistence API; no
import of any Spring class is required. Moreover, as the JPA annotations are understood,
the injections are applied automatically by the Spring container. This is appealing from
a non-invasiveness perspective, and might feel more natural to JPA developers.</p>
</div>
</div>
<div class="sect3">
<h4 id="orm-jpa-tx"><a class="anchor" href="data-access.html#orm-jpa-tx"></a>4.4.3. Spring-driven JPA transactions</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You are <em>strongly</em> encouraged to read <a href="data-access.html#transaction-declarative">Declarative transaction management</a> if you have not done
so, to get a more detailed coverage of Spring&#8217;s declarative transaction support.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The recommended strategy for JPA is local transactions via JPA&#8217;s native transaction
support. Spring&#8217;s <code>JpaTransactionManager</code> provides many capabilities known from local
JDBC transactions, such as transaction-specific isolation levels and resource-level
read-only optimizations, against any regular JDBC connection pool (no XA requirement).</p>
</div>
<div class="paragraph">
<p>Spring JPA also allows a configured <code>JpaTransactionManager</code> to expose a JPA transaction
to JDBC access code that accesses the same <code>DataSource</code>, provided that the registered
<code>JpaDialect</code> supports retrieval of the underlying JDBC <code>Connection</code>. Out of the box,
Spring provides dialects for the EclipseLink and Hibernate JPA implementations.
See the next section for details on the <code>JpaDialect</code> mechanism.</p>
</div>
</div>
<div class="sect3">
<h4 id="orm-jpa-dialect"><a class="anchor" href="data-access.html#orm-jpa-dialect"></a>4.4.4. JpaDialect and JpaVendorAdapter</h4>
<div class="paragraph">
<p>As an advanced feature <code>JpaTransactionManager</code> and subclasses of
<code>AbstractEntityManagerFactoryBean</code> support a custom <code>JpaDialect</code>, to be passed into the
<code>jpaDialect</code> bean property. A <code>JpaDialect</code> implementation can enable some advanced
features supported by Spring, usually in a vendor-specific manner:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Applying specific transaction semantics such as custom isolation level or transaction
timeout)</p>
</li>
<li>
<p>Retrieving the transactional JDBC <code>Connection</code> for exposure to JDBC-based DAOs)</p>
</li>
<li>
<p>Advanced translation of <code>PersistenceExceptions</code> to Spring <code>DataAccessExceptions</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is particularly valuable for special transaction semantics and for advanced
translation of exception. The default implementation used (<code>DefaultJpaDialect</code>) does
not provide any special capabilities and if the above features are required, you have
to specify the appropriate dialect.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As an even broader provider adaptation facility primarily for Spring&#8217;s full-featured
<code>LocalContainerEntityManagerFactoryBean</code> setup, <code>JpaVendorAdapter</code> combines the
capabilities of <code>JpaDialect</code> with other provider-specific defaults. Specifying a
<code>HibernateJpaVendorAdapter</code> or <code>EclipseLinkJpaVendorAdapter</code> is the most convenient
way of auto-configuring an <code>EntityManagerFactory</code> setup for Hibernate or EclipseLink,
respectively. Note that those provider adapters are primarily designed for use with
Spring-driven transaction management, i.e. for use with <code>JpaTransactionManager</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See the <code>JpaDialect</code> and <code>JpaVendorAdapter</code> javadocs for more details of its operations
and how they are used within Spring&#8217;s JPA support.</p>
</div>
</div>
<div class="sect3">
<h4 id="orm-jpa-jta"><a class="anchor" href="data-access.html#orm-jpa-jta"></a>4.4.5. Setting up JPA with JTA transaction management</h4>
<div class="paragraph">
<p>As an alternative to <code>JpaTransactionManager</code>, Spring also allows for multi-resource
transaction coordination via JTA, either in a Java EE environment or with a
standalone transaction coordinator such as Atomikos. Aside from choosing Spring&#8217;s
<code>JtaTransactionManager</code> instead of <code>JpaTransactionManager</code>, there are a few further
steps to take:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The underlying JDBC connection pools need to be XA-capable and integrated with
your transaction coordinator. This is usually straightforward in a Java EE environment,
simply exposing a different kind of <code>DataSource</code> via JNDI. Check your application server
documentation for details. Analogously, a standalone transaction coordinator usually
comes with special XA-integrated <code>DataSource</code> implementations; again, check its docs.</p>
</li>
<li>
<p>The JPA <code>EntityManagerFactory</code> setup needs to be configured for JTA. This is
provider-specific, typically via special properties to be specified as "jpaProperties"
on <code>LocalContainerEntityManagerFactoryBean</code>. In the case of Hibernate, these properties
are even version-specific; please check your Hibernate documentation for details.</p>
</li>
<li>
<p>Spring&#8217;s <code>HibernateJpaVendorAdapter</code> enforces certain Spring-oriented defaults such
as the connection release mode "on-close" which matches Hibernate&#8217;s own default in
Hibernate 5.0 but not anymore in 5.1/5.2. For a JTA setup, either do not declare
<code>HibernateJpaVendorAdapter</code> to begin with, or turn off its <code>prepareConnection</code> flag.
Alternatively, set Hibernate 5.2&#8217;s "hibernate.connection.handling_mode" property to
"DELAYED_ACQUISITION_AND_RELEASE_AFTER_STATEMENT" to restore Hibernate&#8217;s own default.
See <a href="data-access.html#orm-hibernate-invalid-jdbc-access-error">Spurious application server warnings with Hibernate</a> for a related note about WebLogic.</p>
</li>
<li>
<p>Alternatively, consider obtaining the <code>EntityManagerFactory</code> from your application
server itself, i.e. via a JNDI lookup instead of a locally declared
<code>LocalContainerEntityManagerFactoryBean</code>. A server-provided <code>EntityManagerFactory</code>
might require special definitions in your server configuration, making the deployment
less portable, but will be set up for the server&#8217;s JTA environment out of the box.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="oxm"><a class="anchor" href="data-access.html#oxm"></a>5. Marshalling XML using O/X Mappers</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="oxm-introduction"><a class="anchor" href="data-access.html#oxm-introduction"></a>5.1. Introduction</h3>
<div class="paragraph">
<p>In this chapter, we will describe Spring&#8217;s Object/XML Mapping support. Object/XML
Mapping, or O/X mapping for short, is the act of converting an XML document to and from
an object. This conversion process is also known as XML Marshalling, or XML
Serialization. This chapter uses these terms interchangeably.</p>
</div>
<div class="paragraph">
<p>Within the field of O/X mapping, a <em>marshaller</em> is responsible for serializing an
object (graph) to XML. In similar fashion, an <em>unmarshaller</em> deserializes the XML to
an object graph. This XML can take the form of a DOM document, an input or output
stream, or a SAX handler.</p>
</div>
<div class="paragraph">
<p>Some of the benefits of using Spring for your O/X mapping needs are:</p>
</div>
<div class="sect3">
<h4 id="ease-of-configuration"><a class="anchor" href="data-access.html#ease-of-configuration"></a>5.1.1. Ease of configuration</h4>
<div class="paragraph">
<p>Spring&#8217;s bean factory makes it easy to configure marshallers, without needing to
construct JAXB context, JiBX binding factories, etc. The marshallers can be configured
as any other bean in your application context. Additionally, XML namespace-based
configuration is available for a number of marshallers, making the configuration even
simpler.</p>
</div>
</div>
<div class="sect3">
<h4 id="consistent-interfaces"><a class="anchor" href="data-access.html#consistent-interfaces"></a>5.1.2. Consistent interfaces</h4>
<div class="paragraph">
<p>Spring&#8217;s O/X mapping operates through two global interfaces: the <code>Marshaller</code> and
<code>Unmarshaller</code> interface. These abstractions allow you to switch O/X mapping frameworks
with relative ease, with little or no changes required on the classes that do the
marshalling. This approach has the additional benefit of making it possible to do XML
marshalling with a mix-and-match approach (e.g. some marshalling performed using JAXB,
other using Castor) in a non-intrusive fashion, leveraging the strength of each
technology.</p>
</div>
</div>
<div class="sect3">
<h4 id="consistent-exception-hierarchy"><a class="anchor" href="data-access.html#consistent-exception-hierarchy"></a>5.1.3. Consistent exception hierarchy</h4>
<div class="paragraph">
<p>Spring provides a conversion from exceptions from the underlying O/X mapping tool to its
own exception hierarchy with the <code>XmlMappingException</code> as the root exception. As can be
expected, these runtime exceptions wrap the original exception so no information is lost.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="oxm-marshaller-unmarshaller"><a class="anchor" href="data-access.html#oxm-marshaller-unmarshaller"></a>5.2. Marshaller and Unmarshaller</h3>
<div class="paragraph">
<p>As stated in the introduction, a <em>marshaller</em> serializes an object to XML, and an
<em>unmarshaller</em> deserializes XML stream to an object. In this section, we will describe
the two Spring interfaces used for this purpose.</p>
</div>
<div class="sect3">
<h4 id="oxm-marshaller"><a class="anchor" href="data-access.html#oxm-marshaller"></a>5.2.1. Marshaller</h4>
<div class="paragraph">
<p>Spring abstracts all marshalling operations behind the
<code>org.springframework.oxm.Marshaller</code> interface, the main method of which is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Marshaller</span> {

    <span class="comment">/**
     * Marshal the object graph with the given root into the provided Result.
     */</span>
    <span class="type">void</span> marshal(<span class="predefined-type">Object</span> graph, <span class="predefined-type">Result</span> result) <span class="directive">throws</span> XmlMappingException, <span class="exception">IOException</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Marshaller</code> interface has one main method, which marshals the given object to a
given <code>javax.xml.transform.Result</code>. Result is a tagging interface that basically
represents an XML output abstraction: concrete implementations wrap various XML
representations, as indicated in the table below.</p>
</div>
<table id="oxm-marshller-tbl" class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Result implementation</th>
<th class="tableblock halign-left valign-top">Wraps XML representation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DOMResult</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.w3c.dom.Node</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SAXResult</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.xml.sax.ContentHandler</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StreamResult</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.io.File</code>, <code>java.io.OutputStream</code>, or <code>java.io.Writer</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Although the <code>marshal()</code> method accepts a plain object as its first parameter, most
<code>Marshaller</code> implementations cannot handle arbitrary objects. Instead, an object class
must be mapped in a mapping file, marked with an annotation, registered with the
marshaller, or have a common base class. Refer to the further sections in this chapter
to determine how your O/X technology of choice manages this.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="oxm-unmarshaller"><a class="anchor" href="data-access.html#oxm-unmarshaller"></a>5.2.2. Unmarshaller</h4>
<div class="paragraph">
<p>Similar to the <code>Marshaller</code>, there is the <code>org.springframework.oxm.Unmarshaller</code>
interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Unmarshaller</span> {

    <span class="comment">/**
     * Unmarshal the given provided Source into an object graph.
     */</span>
    <span class="predefined-type">Object</span> unmarshal(<span class="predefined-type">Source</span> source) <span class="directive">throws</span> XmlMappingException, <span class="exception">IOException</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This interface also has one method, which reads from the given
<code>javax.xml.transform.Source</code> (an XML input abstraction), and returns the object read. As
with Result, Source is a tagging interface that has three concrete implementations. Each
wraps a different XML representation, as indicated in the table below.</p>
</div>
<table id="oxm-unmarshller-tbl" class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Source implementation</th>
<th class="tableblock halign-left valign-top">Wraps XML representation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DOMSource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.w3c.dom.Node</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SAXSource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.xml.sax.InputSource</code>, and <code>org.xml.sax.XMLReader</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StreamSource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.io.File</code>, <code>java.io.InputStream</code>, or <code>java.io.Reader</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Even though there are two separate marshalling interfaces ( <code>Marshaller</code> and
<code>Unmarshaller</code>), all implementations found in Spring-WS implement both in one class.
This means that you can wire up one marshaller class and refer to it both as a
marshaller and an unmarshaller in your <code>applicationContext.xml</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="oxm-xmlmappingexception"><a class="anchor" href="data-access.html#oxm-xmlmappingexception"></a>5.2.3. XmlMappingException</h4>
<div class="paragraph">
<p>Spring converts exceptions from the underlying O/X mapping tool to its own exception
hierarchy with the <code>XmlMappingException</code> as the root exception. As can be expected,
these runtime exceptions wrap the original exception so no information will be lost.</p>
</div>
<div class="paragraph">
<p>Additionally, the <code>MarshallingFailureException</code> and <code>UnmarshallingFailureException</code>
provide a distinction between marshalling and unmarshalling operations, even though the
underlying O/X mapping tool does not do so.</p>
</div>
<div class="paragraph">
<p>The O/X Mapping exception hierarchy is shown in the following figure:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oxm-exceptions.png" alt="oxm exceptions">
</div>
</div>
<div class="paragraph">
<p>O/X Mapping exception hierarchy</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="oxm-usage"><a class="anchor" href="data-access.html#oxm-usage"></a>5.3. Using Marshaller and Unmarshaller</h3>
<div class="paragraph">
<p>Spring&#8217;s OXM can be used for a wide variety of situations. In the following example, we
will use it to marshal the settings of a Spring-managed application as an XML file. We
will use a simple JavaBean to represent the settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Settings</span> {

    <span class="directive">private</span> <span class="type">boolean</span> fooEnabled;

    <span class="directive">public</span> <span class="type">boolean</span> isFooEnabled() {
        <span class="keyword">return</span> fooEnabled;
    }

    <span class="directive">public</span> <span class="type">void</span> setFooEnabled(<span class="type">boolean</span> fooEnabled) {
        <span class="local-variable">this</span>.fooEnabled = fooEnabled;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The application class uses this bean to store its settings. Besides a main method, the
class has two methods: <code>saveSettings()</code> saves the settings bean to a file named
<code>settings.xml</code>, and <code>loadSettings()</code> loads these settings again. A <code>main()</code> method
constructs a Spring application context, and calls these two methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.io.FileInputStream</span>;
<span class="keyword">import</span> <span class="include">java.io.FileOutputStream</span>;
<span class="keyword">import</span> <span class="include">java.io.IOException</span>;
<span class="keyword">import</span> <span class="include">javax.xml.transform.stream.StreamResult</span>;
<span class="keyword">import</span> <span class="include">javax.xml.transform.stream.StreamSource</span>;

<span class="keyword">import</span> <span class="include">org.springframework.context.ApplicationContext</span>;
<span class="keyword">import</span> <span class="include">org.springframework.context.support.ClassPathXmlApplicationContext</span>;
<span class="keyword">import</span> <span class="include">org.springframework.oxm.Marshaller</span>;
<span class="keyword">import</span> <span class="include">org.springframework.oxm.Unmarshaller</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Application</span> {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> FILE_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">settings.xml</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> Settings settings = <span class="keyword">new</span> Settings();
    <span class="directive">private</span> Marshaller marshaller;
    <span class="directive">private</span> Unmarshaller unmarshaller;

    <span class="directive">public</span> <span class="type">void</span> setMarshaller(Marshaller marshaller) {
        <span class="local-variable">this</span>.marshaller = marshaller;
    }

    <span class="directive">public</span> <span class="type">void</span> setUnmarshaller(Unmarshaller unmarshaller) {
        <span class="local-variable">this</span>.unmarshaller = unmarshaller;
    }

    <span class="directive">public</span> <span class="type">void</span> saveSettings() <span class="directive">throws</span> <span class="exception">IOException</span> {
        <span class="predefined-type">FileOutputStream</span> os = <span class="predefined-constant">null</span>;
        <span class="keyword">try</span> {
            os = <span class="keyword">new</span> <span class="predefined-type">FileOutputStream</span>(FILE_NAME);
            <span class="local-variable">this</span>.marshaller.marshal(settings, <span class="keyword">new</span> <span class="predefined-type">StreamResult</span>(os));
        } <span class="keyword">finally</span> {
            <span class="keyword">if</span> (os != <span class="predefined-constant">null</span>) {
                os.close();
            }
        }
    }

    <span class="directive">public</span> <span class="type">void</span> loadSettings() <span class="directive">throws</span> <span class="exception">IOException</span> {
        <span class="predefined-type">FileInputStream</span> is = <span class="predefined-constant">null</span>;
        <span class="keyword">try</span> {
            is = <span class="keyword">new</span> <span class="predefined-type">FileInputStream</span>(FILE_NAME);
            <span class="local-variable">this</span>.settings = (Settings) <span class="local-variable">this</span>.unmarshaller.unmarshal(<span class="keyword">new</span> <span class="predefined-type">StreamSource</span>(is));
        } <span class="keyword">finally</span> {
            <span class="keyword">if</span> (is != <span class="predefined-constant">null</span>) {
                is.close();
            }
        }
    }

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) <span class="directive">throws</span> <span class="exception">IOException</span> {
        ApplicationContext appContext =
                <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string"><span class="delimiter">&quot;</span><span class="content">applicationContext.xml</span><span class="delimiter">&quot;</span></span>);
        Application application = (Application) appContext.getBean(<span class="string"><span class="delimiter">&quot;</span><span class="content">application</span><span class="delimiter">&quot;</span></span>);
        application.saveSettings();
        application.loadSettings();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Application</code> requires both a <code>marshaller</code> and <code>unmarshaller</code> property to be set. We
can do so using the following <code>applicationContext.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Application</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">castorMarshaller</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unmarshaller</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">castorMarshaller</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">castorMarshaller</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.castor.CastorMarshaller</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This application context uses Castor, but we could have used any of the other marshaller
instances described later in this chapter. Note that Castor does not require any further
configuration by default, so the bean definition is rather simple. Also note that the
<code>CastorMarshaller</code> implements both <code>Marshaller</code> and <code>Unmarshaller</code>, so we can refer to the
<code>castorMarshaller</code> bean in both the <code>marshaller</code> and <code>unmarshaller</code> property of the
application.</p>
</div>
<div class="paragraph">
<p>This sample application produces the following <code>settings.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;settings</span> <span class="attribute-name">foo-enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="oxm-schema-based-config"><a class="anchor" href="data-access.html#oxm-schema-based-config"></a>5.4. XML configuration namespace</h3>
<div class="paragraph">
<p>Marshallers could be configured more concisely using tags from the OXM namespace. To
make these tags available, the appropriate schema has to be referenced first in the
preamble of the XML configuration file. Note the 'oxm' related text below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
    <span class="error"><strong></span><span class="error"></strong></span><span class="attribute-name">xmlns:oxm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/oxm</span><span class="delimiter">&quot;</span></span><span class="error"><strong></span><span class="error"></strong></span> <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd <strong>*http://www.springframework.org/schema/oxm http://www.springframework.org/schema/oxm/spring-oxm.xsd</span><span class="delimiter">&quot;</span></span><span class="error"></strong></span><span class="error">*</span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Currently, the following tags are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="data-access.html#oxm-jaxb2-xsd"><code>jaxb2-marshaller</code></a></p>
</li>
<li>
<p><a href="data-access.html#oxm-jibx-xsd"><code>jibx-marshaller</code></a></p>
</li>
<li>
<p><a href="data-access.html#oxm-castor-xsd"><code>castor-marshaller</code></a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each tag will be explained in its respective marshaller&#8217;s section. As an example though,
here is how the configuration of a JAXB2 marshaller might look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;oxm:jaxb2-marshaller</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">contextPath</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.ws.samples.airline.schema</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="oxm-jaxb"><a class="anchor" href="data-access.html#oxm-jaxb"></a>5.5. JAXB</h3>
<div class="paragraph">
<p>The JAXB binding compiler translates a W3C XML Schema into one or more Java classes, a
<code>jaxb.properties</code> file, and possibly some resource files. JAXB also offers a way to
generate a schema from annotated Java classes.</p>
</div>
<div class="paragraph">
<p>Spring supports the JAXB 2.0 API as XML marshalling strategies, following the
<code>Marshaller</code> and <code>Unmarshaller</code> interfaces described in <a href="data-access.html#oxm-marshaller-unmarshaller">Marshaller and Unmarshaller</a>.
The corresponding integration classes reside in the <code>org.springframework.oxm.jaxb</code>
package.</p>
</div>
<div class="sect3">
<h4 id="oxm-jaxb2"><a class="anchor" href="data-access.html#oxm-jaxb2"></a>5.5.1. Jaxb2Marshaller</h4>
<div class="paragraph">
<p>The <code>Jaxb2Marshaller</code> class implements both the Spring <code>Marshaller</code> and <code>Unmarshaller</code>
interface. It requires a context path to operate, which you can set using the
<code>contextPath</code> property. The context path is a list of colon (:) separated Java package
names that contain schema derived classes. It also offers a <code>classesToBeBound</code> property,
which allows you to set an array of classes to be supported by the marshaller. Schema
validation is performed by specifying one or more schema resource to the bean, like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jaxb2Marshaller</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.jaxb.Jaxb2Marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classesToBeBound</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;list&gt;</span>
                <span class="tag">&lt;value&gt;</span>org.springframework.oxm.jaxb.Flight<span class="tag">&lt;/value&gt;</span>
                <span class="tag">&lt;value&gt;</span>org.springframework.oxm.jaxb.Flights<span class="tag">&lt;/value&gt;</span>
            <span class="tag">&lt;/list&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">schema</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:org/springframework/oxm/schema.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    ...

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="oxm-jaxb2-xsd"><a class="anchor" href="data-access.html#oxm-jaxb2-xsd"></a>XML configuration namespace</h5>
<div class="paragraph">
<p>The <code>jaxb2-marshaller</code> tag configures a <code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code>.
Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;oxm:jaxb2-marshaller</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">contextPath</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.ws.samples.airline.schema</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, the list of classes to bind can be provided to the marshaller via the
<code>class-to-be-bound</code> child tag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;oxm:jaxb2-marshaller</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;oxm:class-to-be-bound</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.ws.samples.airline.schema.Airport</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;oxm:class-to-be-bound</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.ws.samples.airline.schema.Flight</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    ...
<span class="tag">&lt;/oxm:jaxb2-marshaller&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Available attributes are:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the id of the marshaller</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>contextPath</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the JAXB Context path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="oxm-castor"><a class="anchor" href="data-access.html#oxm-castor"></a>5.6. Castor</h3>
<div class="paragraph">
<p>Castor XML mapping is an open source XML binding framework. It allows you to transform
the data contained in a java object model into/from an XML document. By default, it does
not require any further configuration, though a mapping file can be used to have more
control over the behavior of Castor.</p>
</div>
<div class="paragraph">
<p>For more information on Castor, refer to the
<a href="https://castor-data-binding.github.io/castor"><em>Castor web site</em></a>. The Spring
integration classes reside in the <code>org.springframework.oxm.castor</code> package.</p>
</div>
<div class="sect3">
<h4 id="oxm-castor-marshaller"><a class="anchor" href="data-access.html#oxm-castor-marshaller"></a>5.6.1. CastorMarshaller</h4>
<div class="paragraph">
<p>As with JAXB, the <code>CastorMarshaller</code> implements both the <code>Marshaller</code> and <code>Unmarshaller</code>
interface. It can be wired up as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">castorMarshaller</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.castor.CastorMarshaller</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    ...
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="oxm-castor-mapping"><a class="anchor" href="data-access.html#oxm-castor-mapping"></a>5.6.2. Mapping</h4>
<div class="paragraph">
<p>Although it is possible to rely on Castor&#8217;s default marshalling behavior, it might be
necessary to have more control over it. This can be accomplished using a Castor mapping
file. For more information, refer to <a href="https://castor-data-binding.github.io/castor/reference-guides/1.3.3/html-single/index.html#xml.mapping">Castor
XML Mapping</a>.</p>
</div>
<div class="paragraph">
<p>The mapping can be set using the <code>mappingLocation</code> resource property, indicated below
with a classpath resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">castorMarshaller</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.castor.CastorMarshaller</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mappingLocation</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:mapping.xml</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="oxm-castor-xsd"><a class="anchor" href="data-access.html#oxm-castor-xsd"></a>XML configuration namespace</h5>
<div class="paragraph">
<p>The <code>castor-marshaller</code> tag configures a
<code>org.springframework.oxm.castor.CastorMarshaller</code>. Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;oxm:castor-marshaller</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mapping-location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:org/springframework/oxm/castor/mapping.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The marshaller instance can be configured in two ways, by specifying either the location
of a mapping file (through the <code>mapping-location</code> property), or by identifying Java
POJOs (through the <code>target-class</code> or <code>target-package</code> properties) for which there exist
corresponding XML descriptor classes. The latter way is usually used in conjunction with
XML code generation from XML schemas.</p>
</div>
<div class="paragraph">
<p>Available attributes are:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the id of the marshaller</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>encoding</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the encoding to use for unmarshalling from XML</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>target-class</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a Java class name for a POJO for which an XML class descriptor is available (as
generated through code generation)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>target-package</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a Java package name that identifies a package that contains POJOs and their
corresponding Castor XML descriptor classes (as generated through code generation from
XML schemas)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mapping-location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">location of a Castor XML mapping file</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="oxm-jibx"><a class="anchor" href="data-access.html#oxm-jibx"></a>5.7. JiBX</h3>
<div class="paragraph">
<p>The JiBX framework offers a solution similar to that which Hibernate provides for ORM: a
binding definition defines the rules for how your Java objects are converted to or from
XML. After preparing the binding and compiling the classes, a JiBX binding compiler
enhances the class files, and adds code to handle converting instances of the classes
from or to XML.</p>
</div>
<div class="paragraph">
<p>For more information on JiBX, refer to the <a href="http://jibx.sourceforge.net/"><em>JiBX web
site</em></a>. The Spring integration classes reside in the <code>org.springframework.oxm.jibx</code>
package.</p>
</div>
<div class="sect3">
<h4 id="oxm-jibx-marshaller"><a class="anchor" href="data-access.html#oxm-jibx-marshaller"></a>5.7.1. JibxMarshaller</h4>
<div class="paragraph">
<p>The <code>JibxMarshaller</code> class implements both the <code>Marshaller</code> and <code>Unmarshaller</code>
interface. To operate, it requires the name of the class to marshal in, which you can
set using the <code>targetClass</code> property. Optionally, you can set the binding name using the
<code>bindingName</code> property. In the next sample, we bind the <code>Flights</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jibxFlightsMarshaller</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.jibx.JibxMarshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">targetClass</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>org.springframework.oxm.jibx.Flights<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
    ...
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>JibxMarshaller</code> is configured for a single class. If you want to marshal multiple
classes, you have to configure multiple <code>JibxMarshaller</code>s with different <code>targetClass</code>
property values.</p>
</div>
<div class="sect4">
<h5 id="oxm-jibx-xsd"><a class="anchor" href="data-access.html#oxm-jibx-xsd"></a>XML configuration namespace</h5>
<div class="paragraph">
<p>The <code>jibx-marshaller</code> tag configures a <code>org.springframework.oxm.jibx.JibxMarshaller</code>.
Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;oxm:jibx-marshaller</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">target-class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.ws.samples.airline.schema.Flight</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Available attributes are:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the id of the marshaller</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>target-class</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the target class for this marshaller</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bindingName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the binding name used by this marshaller</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="oxm-xstream"><a class="anchor" href="data-access.html#oxm-xstream"></a>5.8. XStream</h3>
<div class="paragraph">
<p>XStream is a simple library to serialize objects to XML and back again. It does not
require any mapping, and generates clean XML.</p>
</div>
<div class="paragraph">
<p>For more information on XStream, refer to the <a href="https://x-stream.github.io/"><em>XStream
web site</em></a>. The Spring integration classes reside in the
<code>org.springframework.oxm.xstream</code> package.</p>
</div>
<div class="sect3">
<h4 id="oxm-xstream-marshaller"><a class="anchor" href="data-access.html#oxm-xstream-marshaller"></a>5.8.1. XStreamMarshaller</h4>
<div class="paragraph">
<p>The <code>XStreamMarshaller</code> does not require any configuration, and can be configured in an
application context directly. To further customize the XML, you can set an<em>alias map</em>,
which consists of string aliases mapped to classes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xstreamMarshaller</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.xstream.XStreamMarshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">aliases</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;props&gt;</span>
                <span class="tag">&lt;prop</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Flight</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>org.springframework.oxm.xstream.Flight<span class="tag">&lt;/prop&gt;</span>
            <span class="tag">&lt;/props&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
    ...
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default, XStream allows for arbitrary classes to be unmarshalled, which can lead to
unsafe Java serialization effects. As such, it is <em>not recommended to use the
<code>XStreamMarshaller</code> to unmarshal XML from external sources</em> (i.e. the Web), as this can
result in <em>security vulnerabilities</em>.</p>
</div>
<div class="paragraph">
<p>If you choose to use the <code>XStreamMarshaller</code> to unmarshal XML from an external source,
set the <code>supportedClasses</code> property on the <code>XStreamMarshaller</code>, like as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xstreamMarshaller</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.xstream.XStreamMarshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">supportedClasses</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.xstream.Flight</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    ...
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will make sure that only the registered classes are eligible for unmarshalling.</p>
</div>
<div class="paragraph">
<p>Additionally, you can register
<a href="https://docs.spring.io/spring-framework/docs/5.0.4.RELEASE/javadoc-api/org/springframework/oxm/xstream/XStreamMarshaller.html#setConverters(com.thoughtworks.xstream.converters.ConverterMatcher&#8230;&#8203;)">custom
converters</a> to make sure that only your supported classes can be unmarshalled. You might
want to add a <code>CatchAllConverter</code> as the last converter in the list, in addition to
converters that explicitly support the domain classes that should be supported. As a
result, default XStream converters with lower priorities and possible security
vulnerabilities do not get invoked.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that XStream is an XML serialization library, not a data binding library.
Therefore, it has limited namespace support. As such, it is rather unsuitable for usage
within Web services.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix"><a class="anchor" href="data-access.html#appendix"></a>6. Appendix</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="xsd-schemas"><a class="anchor" href="data-access.html#xsd-schemas"></a>6.1. XML Schemas</h3>
<div class="paragraph">
<p>This part of the appendix lists XML schemas for data access.</p>
</div>
<div class="sect3">
<h4 id="xsd-schemas-tx"><a class="anchor" href="data-access.html#xsd-schemas-tx"></a>6.1.1. The <code>tx</code> schema</h4>
<div class="paragraph">
<p>The <code>tx</code> tags deal with configuring all of those beans in Spring&#8217;s comprehensive support
for transactions. These tags are covered in the chapter entitled
<a href="data-access.html#transaction">Transaction Management</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You are strongly encouraged to look at the <code>'spring-tx.xsd'</code> file that ships with the
Spring distribution. This file is (of course), the XML Schema for Spring&#8217;s transaction
configuration, and covers all of the various tags in the <code>tx</code> namespace, including
attribute defaults and suchlike. This file is documented inline, and thus the
information is not repeated here in the interests of adhering to the DRY (Don&#8217;t Repeat
Yourself) principle.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the interest of completeness, to use the tags in the <code>tx</code> schema, you need to have
the following preamble at the top of your Spring XML configuration file; the text in the
following snippet references the correct schema so that the tags in the <code>tx</code> namespace
are available to you.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">xmlns:aop</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/aop</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name"><em>xmlns:tx</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/tx</span><span class="delimiter">&quot;</span></span><span class="attribute-name"></em></span> <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
        <span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
        <span class="content"><em>http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd</em></span>
        <span class="content">http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- bean definitions here --&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Often when using the tags in the <code>tx</code> namespace you will also be using the tags from the
<code>aop</code> namespace (since the declarative transaction support in Spring is implemented
using AOP). The above XML snippet contains the relevant lines needed to reference the
<code>aop</code> schema so that the tags in the <code>aop</code> namespace are available to you.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="xsd-schemas-jdbc"><a class="anchor" href="data-access.html#xsd-schemas-jdbc"></a>6.1.2. The <code>jdbc</code> schema</h4>
<div class="paragraph">
<p>The <code>jdbc</code> tags allow you to quickly configure an embedded database or initialize an
existing data source. These tags are documented in
<a href="data-access.html#jdbc-embedded-database-support">Embedded database support</a>
and <a href="data-access.html#jdbc-initializing-datasource">Initializing a DataSource</a> respectively.</p>
</div>
<div class="paragraph">
<p>To use the tags in the <code>jdbc</code> schema, you need to have the following preamble at the top
of your Spring XML configuration file; the text in the following snippet references the
correct schema so that the tags in the <code>jdbc</code> namespace are available to you.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name"><em>xmlns:jdbc</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/jdbc</span><span class="delimiter">&quot;</span></span><span class="attribute-name"></em></span> <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
        <span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
        <span class="content"><em>http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc.xsd</span><span class="delimiter">&quot;</span></span><span class="attribute-name"></em></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- bean definitions here --&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 5.0.4.RELEASE<br>
Last updated 2018-02-19 10:39:28 UTC
</div>
</div>
<script data-cfasync="false" src="../../../../cdn-cgi/scripts/d07b1474/cloudflare-static/email-decode.min.js"></script><script src="tocbot-3.0.2/tocbot.js"></script>
<script>var oldtoc=document.getElementById('toctitle').nextElementSibling;var newtoc=document.createElement('div');newtoc.setAttribute('id','tocbot');newtoc.setAttribute('class','js-toc');oldtoc.parentNode.replaceChild(newtoc,oldtoc);tocbot.init({contentSelector:'#content',headingSelector:'h1, h2, h3, h4, h5',smoothScroll:false});var handleTocOnResize=function(){var width=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;if(width<768){tocbot.refresh({contentSelector:'#content',headingSelector:'h1, h2, h3, h4, h5',collapseDepth:6,activeLinkClass:'ignoreactive',throttleTimeout:1000,smoothScroll:false});}else{tocbot.refresh({contentSelector:'#content',headingSelector:'h1, h2, h3, h4, h5',smoothScroll:false});}};window.addEventListener('resize',handleTocOnResize);handleTocOnResize();var link=document.createElement("a");link.setAttribute("href","index.html");link.innerHTML="<i class=\"fa fa-chevron-left\" aria-hidden=\"true\"></i>&nbsp;&nbsp;Back to index";var p=document.createElement("p");p.appendChild(link);var toc=document.getElementById('toc')
var next=document.getElementById('toctitle').nextElementSibling;toc.insertBefore(p,next);</script>
<script>if(window.parent==window){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-2728886-23','auto',{'siteSpeedSampleRate':100});ga('send','pageview');}</script></body>
</html>