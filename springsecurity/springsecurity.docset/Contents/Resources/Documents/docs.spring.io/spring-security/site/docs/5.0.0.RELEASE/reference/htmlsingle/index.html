<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Spring Security Reference</title><link rel="stylesheet" type="text/css" href="css/manual-singlepage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="en" class="book"><div class="titlepage"><div><div><h1 class="title"><a name="d5e1"></a>Spring Security Reference</h1></div><div><div class="authorgroup"><h2>Authors</h2>
<span class="author"><span class="firstname">Ben</span> <span class="surname">Alex</span></span>
, <span class="author"><span class="firstname">Luke</span> <span class="surname">Taylor</span></span>
, <span class="author"><span class="firstname">Rob</span> <span class="surname">Winch</span></span>
, <span class="author"><span class="firstname">Gunnar</span> <span class="surname">Hillert</span></span>
, <span class="author"><span class="firstname">Joe</span> <span class="surname">Grandja</span></span>
, <span class="author"><span class="firstname">Jay</span> <span class="surname">Bryant</span></span>
</div></div><div><p class="releaseinfo">5.0.0.RELEASE</p></div><div><p class="copyright">Copyright &copy; 2004-2017 </p></div><div><div class="legalnotice"><a name="d5e34" href="index.html#d5e34"></a>
<p>Copies of this document may be made for your own use and for distribution to
others, provided that you do not charge any fee for such copies and further provided
that each copy contains this Copyright Notice, whether distributed in print or
electronically.</p>
</div></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="preface"><a href="index.html#d5e36"></a></span></dt><dt><span class="part"><a href="index.html#preface">I. Preface</a></span></dt><dd><dl><dt><span class="chapter"><a href="index.html#getting-started">1. Getting Started</a></span></dt><dt><span class="chapter"><a href="index.html#introduction">2. Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#what-is-acegi-security">2.1. What is Spring Security?</a></span></dt><dt><span class="section"><a href="index.html#history">2.2. History</a></span></dt><dt><span class="section"><a href="index.html#release-numbering">2.3. Release Numbering</a></span></dt><dt><span class="section"><a href="index.html#get-spring-security">2.4. Getting Spring Security</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#maven">2.4.1. Usage with Maven</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#maven-repositories">Maven Repositories</a></span></dt><dt><span class="section"><a href="index.html#maven-bom">Spring Framework Bom</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#gradle">2.4.2. Gradle</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#gradle-repositories">Gradle Repositories</a></span></dt><dt><span class="section"><a href="index.html#gradle-resolutionStrategy">Using Spring 4.0.x and Gradle</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#modules">2.4.3. Project Modules</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#spring-security-core">Core - spring-security-core.jar</a></span></dt><dt><span class="section"><a href="index.html#spring-security-remoting">Remoting - spring-security-remoting.jar</a></span></dt><dt><span class="section"><a href="index.html#spring-security-web">Web - spring-security-web.jar</a></span></dt><dt><span class="section"><a href="index.html#spring-security-config">Config - spring-security-config.jar</a></span></dt><dt><span class="section"><a href="index.html#spring-security-ldap">LDAP - spring-security-ldap.jar</a></span></dt><dt><span class="section"><a href="index.html#spring-security-oauth2-core">OAuth 2.0 Core - spring-security-oauth2-core.jar</a></span></dt><dt><span class="section"><a href="index.html#spring-security-oauth2-client">OAuth 2.0 Client - spring-security-oauth2-client.jar</a></span></dt><dt><span class="section"><a href="index.html#spring-security-oauth2-jose">OAuth 2.0 JOSE - spring-security-oauth2-jose.jar</a></span></dt><dt><span class="section"><a href="index.html#spring-security-acl">ACL - spring-security-acl.jar</a></span></dt><dt><span class="section"><a href="index.html#spring-security-cas">CAS - spring-security-cas.jar</a></span></dt><dt><span class="section"><a href="index.html#spring-security-openid">OpenID - spring-security-openid.jar</a></span></dt><dt><span class="section"><a href="index.html#spring-security-test">Test - spring-security-test.jar</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#get-source">2.4.4. Checking out the Source</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="index.html#new">3. What&#8217;s New in Spring Security 5.0</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#new-features">3.1. New Features</a></span></dt></dl></dd><dt><span class="chapter"><a href="index.html#samples">4. Samples and Guides (Start Here)</a></span></dt><dt><span class="chapter"><a href="index.html#jc">5. Java Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#hello-web-security-java-configuration">5.1. Hello Web Security Java Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#abstractsecuritywebapplicationinitializer">5.1.1. AbstractSecurityWebApplicationInitializer</a></span></dt><dt><span class="section"><a href="index.html#abstractsecuritywebapplicationinitializer-without-existing-spring">5.1.2. AbstractSecurityWebApplicationInitializer without Existing Spring</a></span></dt><dt><span class="section"><a href="index.html#abstractsecuritywebapplicationinitializer-with-spring-mvc">5.1.3. AbstractSecurityWebApplicationInitializer with Spring MVC</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#jc-httpsecurity">5.2. HttpSecurity</a></span></dt><dt><span class="section"><a href="index.html#jc-form">5.3. Java Configuration and Form Login</a></span></dt><dt><span class="section"><a href="index.html#jc-authorize-requests">5.4. Authorize Requests</a></span></dt><dt><span class="section"><a href="index.html#jc-logout">5.5. Handling Logouts</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#jc-logout-handler">5.5.1. LogoutHandler</a></span></dt><dt><span class="section"><a href="index.html#jc-logout-success-handler">5.5.2. LogoutSuccessHandler</a></span></dt><dt><span class="section"><a href="index.html#jc-logout-references">5.5.3. Further Logout-Related References</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#jc-webflux">5.6. WebFlux Security</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#minimal-webflux-security-configuration">5.6.1. Minimal WebFlux Security Configuration</a></span></dt><dt><span class="section"><a href="index.html#explicit-webflux-security-configuration">5.6.2. Explicit WebFlux Security Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#jc-oauth2login">5.7. OAuth 2.0 Login</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#jc-oauth2login-sample-boot">5.7.1. Spring Boot 2.0 Sample</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#jc-oauth2login-sample-initial-setup">Initial setup</a></span></dt><dt><span class="section"><a href="index.html#jc-oauth2login-sample-redirect-uri">Setting the redirect URI</a></span></dt><dt><span class="section"><a href="index.html#jc-oauth2login-sample-application-config">Configure <code class="literal">application.yml</code></a></span></dt><dt><span class="section"><a href="index.html#jc-oauth2login-sample-boot-application">Boot up the application</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#jc-oauth2login-client-registration">5.7.2. ClientRegistration</a></span></dt><dt><span class="section"><a href="index.html#jc-oauth2login-boot-property-mappings">5.7.3. Spring Boot 2.0 Property Mappings</a></span></dt><dt><span class="section"><a href="index.html#jc-oauth2login-client-registration-repo">5.7.4. ClientRegistrationRepository</a></span></dt><dt><span class="section"><a href="index.html#jc-oauth2login-common-oauth2-provider">5.7.5. CommonOAuth2Provider</a></span></dt><dt><span class="section"><a href="index.html#jc-oauth2login-custom-provider-properties">5.7.6. Configuring Custom Provider Properties</a></span></dt><dt><span class="section"><a href="index.html#jc-oauth2login-override-boot-autoconfig">5.7.7. Overriding Spring Boot 2.0 Auto-configuration</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#jc-oauth2login-register-clientregistrationrepository-bean">Register a <code class="literal">ClientRegistrationRepository</code> <code class="literal">@Bean</code></a></span></dt><dt><span class="section"><a href="index.html#jc-oauth2login-provide-websecurityconfigureradapter">Provide a <code class="literal">WebSecurityConfigurerAdapter</code></a></span></dt><dt><span class="section"><a href="index.html#jc-oauth2login-completely-override-autoconfiguration">Completely Override the Auto-configuration</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#jc-oauth2login-javaconfig-wo-boot">5.7.8. Java Configuration without Spring Boot 2.0</a></span></dt><dt><span class="section"><a href="index.html#jc-oauth2login-authorized-client">5.7.9. OAuth2AuthorizedClient / OAuth2AuthorizedClientService</a></span></dt><dt><span class="section"><a href="index.html#jc-oauth2login-resources">5.7.10. Additional Resources</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#jc-authentication">5.8. Authentication</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#jc-authentication-inmemory">5.8.1. In-Memory Authentication</a></span></dt><dt><span class="section"><a href="index.html#jc-authentication-jdbc">5.8.2. JDBC Authentication</a></span></dt><dt><span class="section"><a href="index.html#ldap-authentication">5.8.3. LDAP Authentication</a></span></dt><dt><span class="section"><a href="index.html#jc-authentication-authenticationprovider">5.8.4. AuthenticationProvider</a></span></dt><dt><span class="section"><a href="index.html#jc-authentication-userdetailsservice">5.8.5. UserDetailsService</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#multiple-httpsecurity">5.9. Multiple HttpSecurity</a></span></dt><dt><span class="section"><a href="index.html#jc-method">5.10. Method Security</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#enableglobalmethodsecurity">5.10.1. EnableGlobalMethodSecurity</a></span></dt><dt><span class="section"><a href="index.html#globalmethodsecurityconfiguration">5.10.2. GlobalMethodSecurityConfiguration</a></span></dt><dt><span class="section"><a href="index.html#jc-erms">5.10.3. EnableReactiveMethodSecurity</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#post-processing-configured-objects">5.11. Post Processing Configured Objects</a></span></dt><dt><span class="section"><a href="index.html#jc-custom-dsls">5.12. Custom DSLs</a></span></dt></dl></dd><dt><span class="chapter"><a href="index.html#ns-config">6. Security Namespace Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#introduction-2">6.1. Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#design-of-the-namespace">6.1.1. Design of the Namespace</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#ns-getting-started">6.2. Getting Started with Security Namespace Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#ns-web-xml">6.2.1. web.xml Configuration</a></span></dt><dt><span class="section"><a href="index.html#ns-minimal">6.2.2. A Minimal &lt;http&gt; Configuration</a></span></dt><dt><span class="section"><a href="index.html#ns-form-and-basic">6.2.3. Form and Basic Login Options</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#ns-form-target">Setting a Default Post-Login Destination</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#ns-logout">6.2.4. Logout Handling</a></span></dt><dt><span class="section"><a href="index.html#ns-auth-providers">6.2.5. Using other Authentication Providers</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#ns-password-encoder">Adding a Password Encoder</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="index.html#ns-web-advanced">6.3. Advanced Web Features</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#ns-remember-me">6.3.1. Remember-Me Authentication</a></span></dt><dt><span class="section"><a href="index.html#ns-requires-channel">6.3.2. Adding HTTP/HTTPS Channel Security</a></span></dt><dt><span class="section"><a href="index.html#ns-session-mgmt">6.3.3. Session Management</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#detecting-timeouts">Detecting Timeouts</a></span></dt><dt><span class="section"><a href="index.html#ns-concurrent-sessions">Concurrent Session Control</a></span></dt><dt><span class="section"><a href="index.html#ns-session-fixation">Session Fixation Attack Protection</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#ns-openid">6.3.4. OpenID Support</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#attribute-exchange">Attribute Exchange</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#ns-headers">6.3.5. Response Headers</a></span></dt><dt><span class="section"><a href="index.html#ns-custom-filters">6.3.6. Adding in Your Own Filters</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#ns-entry-point-ref">Setting a Custom AuthenticationEntryPoint</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="index.html#ns-method-security">6.4. Method Security</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#ns-global-method">6.4.1. The &lt;global-method-security&gt; Element</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#ns-protect-pointcut">Adding Security Pointcuts using protect-pointcut</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="index.html#ns-access-manager">6.5. The Default AccessDecisionManager</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#ns-custom-access-mgr">6.5.1. Customizing the AccessDecisionManager</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#ns-auth-manager">6.6. The Authentication Manager and the Namespace</a></span></dt></dl></dd><dt><span class="chapter"><a href="index.html#sample-apps">7. Sample Applications</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#tutorial-sample">7.1. Tutorial Sample</a></span></dt><dt><span class="section"><a href="index.html#contacts-sample">7.2. Contacts</a></span></dt><dt><span class="section"><a href="index.html#ldap-sample">7.3. LDAP Sample</a></span></dt><dt><span class="section"><a href="index.html#openid-sample">7.4. OpenID Sample</a></span></dt><dt><span class="section"><a href="index.html#cas-sample">7.5. CAS Sample</a></span></dt><dt><span class="section"><a href="index.html#jaas-sample">7.6. JAAS Sample</a></span></dt><dt><span class="section"><a href="index.html#preauth-sample">7.7. Pre-Authentication Sample</a></span></dt></dl></dd><dt><span class="chapter"><a href="index.html#community">8. Spring Security Community</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#jira">8.1. Issue Tracking</a></span></dt><dt><span class="section"><a href="index.html#becoming-involved">8.2. Becoming Involved</a></span></dt><dt><span class="section"><a href="index.html#further-info">8.3. Further Information</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="index.html#overall-architecture">II. Architecture and Implementation</a></span></dt><dd><dl><dt><span class="chapter"><a href="index.html#technical-overview">9. Technical Overview</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#runtime-environment">9.1. Runtime Environment</a></span></dt><dt><span class="section"><a href="index.html#core-components">9.2. Core Components</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#securitycontextholder-securitycontext-and-authentication-objects">9.2.1. SecurityContextHolder, SecurityContext and Authentication Objects</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#obtaining-information-about-the-current-user">Obtaining information about the current user</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#tech-userdetailsservice">9.2.2. The UserDetailsService</a></span></dt><dt><span class="section"><a href="index.html#tech-granted-authority">9.2.3. GrantedAuthority</a></span></dt><dt><span class="section"><a href="index.html#summary">9.2.4. Summary</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#tech-intro-authentication">9.3. Authentication</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#what-is-authentication-in-spring-security">9.3.1. What is authentication in Spring Security?</a></span></dt><dt><span class="section"><a href="index.html#setting-the-securitycontextholder-contents-directly">9.3.2. Setting the SecurityContextHolder Contents Directly</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#tech-intro-web-authentication">9.4. Authentication in a Web Application</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#exceptiontranslationfilter">9.4.1. ExceptionTranslationFilter</a></span></dt><dt><span class="section"><a href="index.html#tech-intro-auth-entry-point">9.4.2. AuthenticationEntryPoint</a></span></dt><dt><span class="section"><a href="index.html#authentication-mechanism">9.4.3. Authentication Mechanism</a></span></dt><dt><span class="section"><a href="index.html#tech-intro-sec-context-persistence">9.4.4. Storing the SecurityContext between requests</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#tech-intro-access-control">9.5. Access-Control (Authorization) in Spring Security</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#security-and-aop-advice">9.5.1. Security and AOP Advice</a></span></dt><dt><span class="section"><a href="index.html#secure-objects">9.5.2. Secure Objects and the AbstractSecurityInterceptor</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#tech-intro-config-attributes">What are Configuration Attributes?</a></span></dt><dt><span class="section"><a href="index.html#runasmanager">RunAsManager</a></span></dt><dt><span class="section"><a href="index.html#afterinvocationmanager">AfterInvocationManager</a></span></dt><dt><span class="section"><a href="index.html#extending-the-secure-object-model">Extending the Secure Object Model</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="index.html#localization">9.6. Localization</a></span></dt></dl></dd><dt><span class="chapter"><a href="index.html#core-services">10. Core Services</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#core-services-authentication-manager">10.1. The AuthenticationManager, ProviderManager and AuthenticationProvider</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#core-services-erasing-credentials">10.1.1. Erasing Credentials on Successful Authentication</a></span></dt><dt><span class="section"><a href="index.html#core-services-dao-provider">10.1.2. DaoAuthenticationProvider</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#userdetailsservice-implementations">10.2. UserDetailsService Implementations</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#core-services-in-memory-service">10.2.1. In-Memory Authentication</a></span></dt><dt><span class="section"><a href="index.html#core-services-jdbc-user-service">10.2.2. JdbcDaoImpl</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#authority-groups">Authority Groups</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="index.html#core-services-password-encoding">10.3. Password Encoding</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#pe-history">10.3.1. Password History</a></span></dt><dt><span class="section"><a href="index.html#pe-dpe">10.3.2. DelegatingPasswordEncoder</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#pe-dpe-format">Password Storage Format</a></span></dt><dt><span class="section"><a href="index.html#password-encoding">Password Encoding</a></span></dt><dt><span class="section"><a href="index.html#password-matching">Password Matching</a></span></dt><dt><span class="section"><a href="index.html#getting-started-experience">Getting Started Experience</a></span></dt><dt><span class="section"><a href="index.html#troubleshooting">Troubleshooting</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#pe-bcpe">10.3.3. BCryptPasswordEncoder</a></span></dt><dt><span class="section"><a href="index.html#pe-pbkdf2pe">10.3.4. Pbkdf2PasswordEncoder</a></span></dt><dt><span class="section"><a href="index.html#pe-scpe">10.3.5. SCryptPasswordEncoder</a></span></dt><dt><span class="section"><a href="index.html#other-passwordencoders">10.3.6. Other PasswordEncoders</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#jackson">10.4. Jackson Support</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="index.html#test">III. Testing</a></span></dt><dd><dl><dt><span class="chapter"><a href="index.html#test-method">11. Testing Method Security</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#test-method-setup">11.1. Security Test Setup</a></span></dt><dt><span class="section"><a href="index.html#test-method-withmockuser">11.2. @WithMockUser</a></span></dt><dt><span class="section"><a href="index.html#test-method-withanonymoususer">11.3. @WithAnonymousUser</a></span></dt><dt><span class="section"><a href="index.html#test-method-withuserdetails">11.4. @WithUserDetails</a></span></dt><dt><span class="section"><a href="index.html#test-method-withsecuritycontext">11.5. @WithSecurityContext</a></span></dt><dt><span class="section"><a href="index.html#test-method-meta-annotations">11.6. Test Meta Annotations</a></span></dt></dl></dd><dt><span class="chapter"><a href="index.html#test-mockmvc">12. Spring MVC Test Integration</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#test-mockmvc-setup">12.1. Setting Up MockMvc and Spring Security</a></span></dt><dt><span class="section"><a href="index.html#test-mockmvc-smmrpp">12.2. SecurityMockMvcRequestPostProcessors</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#test-mockmvc-csrf">12.2.1. Testing with CSRF Protection</a></span></dt><dt><span class="section"><a href="index.html#test-mockmvc-securitycontextholder">12.2.2. Running a Test as a User in Spring MVC Test</a></span></dt><dt><span class="section"><a href="index.html#test-mockmvc-securitycontextholder-rpp">12.2.3. Running as a User in Spring MVC Test with RequestPostProcessor</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#running-as-a-user-in-spring-mvc-test-with-annotations">Running as a User in Spring MVC Test with Annotations</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#testing-http-basic-authentication">12.2.4. Testing HTTP Basic Authentication</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#securitymockmvcrequestbuilders">12.3. SecurityMockMvcRequestBuilders</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#testing-form-based-authentication">12.3.1. Testing Form Based Authentication</a></span></dt><dt><span class="section"><a href="index.html#test-logout">12.3.2. Testing Logout</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#securitymockmvcresultmatchers">12.4. SecurityMockMvcResultMatchers</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#unauthenticated-assertion">12.4.1. Unauthenticated Assertion</a></span></dt><dt><span class="section"><a href="index.html#authenticated-assertion">12.4.2. Authenticated Assertion</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="index.html#test-webflux">13. WebFlux Support</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#test-erms">13.1. Reactive Method Security</a></span></dt><dt><span class="section"><a href="index.html#test-webtestclient">13.2. WebTestClientSupport</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#authentication">13.2.1. Authentication</a></span></dt><dt><span class="section"><a href="index.html#csrf-support">13.2.2. CSRF Support</a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="part"><a href="index.html#web-app-security">IV. Web Application Security</a></span></dt><dd><dl><dt><span class="chapter"><a href="index.html#security-filter-chain">14. The Security Filter Chain</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#delegating-filter-proxy">14.1. DelegatingFilterProxy</a></span></dt><dt><span class="section"><a href="index.html#filter-chain-proxy">14.2. FilterChainProxy</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#bypassing-the-filter-chain">14.2.1. Bypassing the Filter Chain</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#filter-ordering">14.3. Filter Ordering</a></span></dt><dt><span class="section"><a href="index.html#request-matching">14.4. Request Matching and HttpFirewall</a></span></dt><dt><span class="section"><a href="index.html#use-with-other-filter-based-frameworks">14.5. Use with other Filter-Based Frameworks</a></span></dt><dt><span class="section"><a href="index.html#filter-chains-with-ns">14.6. Advanced Namespace Configuration</a></span></dt></dl></dd><dt><span class="chapter"><a href="index.html#core-web-filters">15. Core Security Filters</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#filter-security-interceptor">15.1. FilterSecurityInterceptor</a></span></dt><dt><span class="section"><a href="index.html#exception-translation-filter">15.2. ExceptionTranslationFilter</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#auth-entry-point">15.2.1. AuthenticationEntryPoint</a></span></dt><dt><span class="section"><a href="index.html#access-denied-handler">15.2.2. AccessDeniedHandler</a></span></dt><dt><span class="section"><a href="index.html#request-caching">15.2.3. SavedRequest s and the RequestCache Interface</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#security-context-persistence-filter">15.3. SecurityContextPersistenceFilter</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#security-context-repository">15.3.1. SecurityContextRepository</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#form-login-filter">15.4. UsernamePasswordAuthenticationFilter</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#form-login-flow-handling">15.4.1. Application Flow on Authentication Success and Failure</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="index.html#servletapi">16. Servlet API integration</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#servletapi-25">16.1. Servlet 2.5+ Integration</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#servletapi-remote-user">16.1.1. HttpServletRequest.getRemoteUser()</a></span></dt><dt><span class="section"><a href="index.html#servletapi-user-principal">16.1.2. HttpServletRequest.getUserPrincipal()</a></span></dt><dt><span class="section"><a href="index.html#servletapi-user-in-role">16.1.3. HttpServletRequest.isUserInRole(String)</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#servletapi-3">16.2. Servlet 3+ Integration</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#servletapi-authenticate">16.2.1. HttpServletRequest.authenticate(HttpServletRequest,HttpServletResponse)</a></span></dt><dt><span class="section"><a href="index.html#servletapi-login">16.2.2. HttpServletRequest.login(String,String)</a></span></dt><dt><span class="section"><a href="index.html#servletapi-logout">16.2.3. HttpServletRequest.logout()</a></span></dt><dt><span class="section"><a href="index.html#servletapi-start-runnable">16.2.4. AsyncContext.start(Runnable)</a></span></dt><dt><span class="section"><a href="index.html#servletapi-async">16.2.5. Async Servlet Support</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#servletapi-31">16.3. Servlet 3.1+ Integration</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#servletapi-change-session-id">16.3.1. HttpServletRequest#changeSessionId()</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="index.html#basic">17. Basic and Digest Authentication</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#basic-processing-filter">17.1. BasicAuthenticationFilter</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#basic-config">17.1.1. Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#digest-processing-filter">17.2. DigestAuthenticationFilter</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#digest-config">17.2.1. Configuration</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="index.html#remember-me">18. Remember-Me Authentication</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#remember-me-overview">18.1. Overview</a></span></dt><dt><span class="section"><a href="index.html#remember-me-hash-token">18.2. Simple Hash-Based Token Approach</a></span></dt><dt><span class="section"><a href="index.html#remember-me-persistent-token">18.3. Persistent Token Approach</a></span></dt><dt><span class="section"><a href="index.html#remember-me-impls">18.4. Remember-Me Interfaces and Implementations</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#tokenbasedremembermeservices">18.4.1. TokenBasedRememberMeServices</a></span></dt><dt><span class="section"><a href="index.html#persistenttokenbasedremembermeservices">18.4.2. PersistentTokenBasedRememberMeServices</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="index.html#csrf">19. Cross Site Request Forgery (CSRF)</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#csrf-attacks">19.1. CSRF Attacks</a></span></dt><dt><span class="section"><a href="index.html#synchronizer-token-pattern">19.2. Synchronizer Token Pattern</a></span></dt><dt><span class="section"><a href="index.html#when-to-use-csrf-protection">19.3. When to use CSRF protection</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#csrf-protection-and-json">19.3.1. CSRF protection and JSON</a></span></dt><dt><span class="section"><a href="index.html#csrf-and-stateless-browser-applications">19.3.2. CSRF and Stateless Browser Applications</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#csrf-using">19.4. Using Spring Security CSRF Protection</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#csrf-use-proper-verbs">19.4.1. Use proper HTTP verbs</a></span></dt><dt><span class="section"><a href="index.html#csrf-configure">19.4.2. Configure CSRF Protection</a></span></dt><dt><span class="section"><a href="index.html#csrf-include-csrf-token">19.4.3. Include the CSRF Token</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#csrf-include-csrf-token-form">Form Submissions</a></span></dt><dt><span class="section"><a href="index.html#csrf-include-csrf-token-ajax">Ajax and JSON Requests</a></span></dt><dt><span class="section"><a href="index.html#csrf-cookie">CookieCsrfTokenRepository</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="index.html#csrf-caveats">19.5. CSRF Caveats</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#csrf-timeouts">19.5.1. Timeouts</a></span></dt><dt><span class="section"><a href="index.html#csrf-login">19.5.2. Logging In</a></span></dt><dt><span class="section"><a href="index.html#csrf-logout">19.5.3. Logging Out</a></span></dt><dt><span class="section"><a href="index.html#csrf-multipart">19.5.4. Multipart (file upload)</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#csrf-multipartfilter">Placing MultipartFilter before Spring Security</a></span></dt><dt><span class="section"><a href="index.html#csrf-include-csrf-token-in-action">Include CSRF token in action</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#hiddenhttpmethodfilter">19.5.5. HiddenHttpMethodFilter</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#overriding-defaults">19.6. Overriding Defaults</a></span></dt></dl></dd><dt><span class="chapter"><a href="index.html#cors">20. CORS</a></span></dt><dt><span class="chapter"><a href="index.html#headers">21. Security HTTP Response Headers</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#default-security-headers">21.1. Default Security Headers</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#headers-cache-control">21.1.1. Cache Control</a></span></dt><dt><span class="section"><a href="index.html#headers-content-type-options">21.1.2. Content Type Options</a></span></dt><dt><span class="section"><a href="index.html#headers-hsts">21.1.3. HTTP Strict Transport Security (HSTS)</a></span></dt><dt><span class="section"><a href="index.html#headers-hpkp">21.1.4. HTTP Public Key Pinning (HPKP)</a></span></dt><dt><span class="section"><a href="index.html#headers-frame-options">21.1.5. X-Frame-Options</a></span></dt><dt><span class="section"><a href="index.html#headers-xss-protection">21.1.6. X-XSS-Protection</a></span></dt><dt><span class="section"><a href="index.html#headers-csp">21.1.7. Content Security Policy (CSP)</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#headers-csp-configure">Configuring Content Security Policy</a></span></dt><dt><span class="section"><a href="index.html#headers-csp-links">Additional Resources</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#headers-referrer">21.1.8. Referrer Policy</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#headers-referrer-configure">Configuring Referrer Policy</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="index.html#headers-custom">21.2. Custom Headers</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#headers-static">21.2.1. Static Headers</a></span></dt><dt><span class="section"><a href="index.html#headers-writer">21.2.2. Headers Writer</a></span></dt><dt><span class="section"><a href="index.html#headers-delegatingrequestmatcherheaderwriter">21.2.3. DelegatingRequestMatcherHeaderWriter</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="index.html#session-mgmt">22. Session Management</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#sessionmanagementfilter">22.1. SessionManagementFilter</a></span></dt><dt><span class="section"><a href="index.html#sessionauthenticationstrategy">22.2. SessionAuthenticationStrategy</a></span></dt><dt><span class="section"><a href="index.html#concurrent-sessions">22.3. Concurrency Control</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#list-authenticated-principals">22.3.1. Querying the SessionRegistry for currently authenticated users and their sessions</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="index.html#anonymous">23. Anonymous Authentication</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#anonymous-overview">23.1. Overview</a></span></dt><dt><span class="section"><a href="index.html#anonymous-config">23.2. Configuration</a></span></dt><dt><span class="section"><a href="index.html#anonymous-auth-trust-resolver">23.3. AuthenticationTrustResolver</a></span></dt></dl></dd><dt><span class="chapter"><a href="index.html#websocket">24. WebSocket Security</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#websocket-configuration">24.1. WebSocket Configuration</a></span></dt><dt><span class="section"><a href="index.html#websocket-authentication">24.2. WebSocket Authentication</a></span></dt><dt><span class="section"><a href="index.html#websocket-authorization">24.3. WebSocket Authorization</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#websocket-authorization-notes">24.3.1. WebSocket Authorization Notes</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#websocket-authorization-notes-messagetypes">WebSocket Authorization on Message Types</a></span></dt><dt><span class="section"><a href="index.html#websocket-authorization-notes-destinations">WebSocket Authorization on Destinations</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#websocket-authorization-notes-outbound">24.3.2. Outbound Messages</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#websocket-sameorigin">24.4. Enforcing Same Origin Policy</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#websocket-sameorigin-why">24.4.1. Why Same Origin?</a></span></dt><dt><span class="section"><a href="index.html#websocket-sameorigin-spring">24.4.2. Spring WebSocket Allowed Origin</a></span></dt><dt><span class="section"><a href="index.html#websocket-sameorigin-csrf">24.4.3. Adding CSRF to Stomp Headers</a></span></dt><dt><span class="section"><a href="index.html#websocket-sameorigin-disable">24.4.4. Disable CSRF within WebSockets</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#websocket-sockjs">24.5. Working with SockJS</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#websocket-sockjs-sameorigin">24.5.1. SockJS &amp; frame-options</a></span></dt><dt><span class="section"><a href="index.html#websocket-sockjs-csrf">24.5.2. SockJS &amp; Relaxing CSRF</a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="part"><a href="index.html#authorization">V. Authorization</a></span></dt><dd><dl><dt><span class="chapter"><a href="index.html#authz-arch">25. Authorization Architecture</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#authz-authorities">25.1. Authorities</a></span></dt><dt><span class="section"><a href="index.html#authz-pre-invocation">25.2. Pre-Invocation Handling</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#authz-access-decision-manager">25.2.1. The AccessDecisionManager</a></span></dt><dt><span class="section"><a href="index.html#authz-voting-based">25.2.2. Voting-Based AccessDecisionManager Implementations</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#authz-role-voter">RoleVoter</a></span></dt><dt><span class="section"><a href="index.html#authz-authenticated-voter">AuthenticatedVoter</a></span></dt><dt><span class="section"><a href="index.html#authz-custom-voter">Custom Voters</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="index.html#authz-after-invocation-handling">25.3. After Invocation Handling</a></span></dt><dt><span class="section"><a href="index.html#authz-hierarchical-roles">25.4. Hierarchical Roles</a></span></dt></dl></dd><dt><span class="chapter"><a href="index.html#secure-object-impls">26. Secure Object Implementations</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#aop-alliance">26.1. AOP Alliance (MethodInvocation) Security Interceptor</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#explicit-methodsecurityinterceptor-configuration">26.1.1. Explicit MethodSecurityInterceptor Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#aspectj">26.2. AspectJ (JoinPoint) Security Interceptor</a></span></dt></dl></dd><dt><span class="chapter"><a href="index.html#el-access">27. Expression-Based Access Control</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#overview">27.1. Overview</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#el-common-built-in">27.1.1. Common Built-In Expressions</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#el-access-web">27.2. Web Security Expressions</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#el-access-web-beans">27.2.1. Referring to Beans in Web Security Expressions</a></span></dt><dt><span class="section"><a href="index.html#el-access-web-path-variables">27.2.2. Path Variables in Web Security Expressions</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#method-security-expressions">27.3. Method Security Expressions</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#el-pre-post-annotations">27.3.1. @Pre and @Post Annotations</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#access-control-using-preauthorize-and-postauthorize">Access Control using @PreAuthorize and @PostAuthorize</a></span></dt><dt><span class="section"><a href="index.html#filtering-using-prefilter-and-postfilter">Filtering using @PreFilter and @PostFilter</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#el-method-built-in">27.3.2. Built-In Expressions</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#el-permission-evaluator">The PermissionEvaluator interface</a></span></dt><dt><span class="section"><a href="index.html#method-security-meta-annotations">Method Security Meta Annotations</a></span></dt></dl></dd></dl></dd></dl></dd></dl></dd><dt><span class="part"><a href="index.html#advanced-topics">VI. Additional Topics</a></span></dt><dd><dl><dt><span class="chapter"><a href="index.html#domain-acls">28. Domain Object Security (ACLs)</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#domain-acls-overview">28.1. Overview</a></span></dt><dt><span class="section"><a href="index.html#domain-acls-key-concepts">28.2. Key Concepts</a></span></dt><dt><span class="section"><a href="index.html#domain-acls-getting-started">28.3. Getting Started</a></span></dt></dl></dd><dt><span class="chapter"><a href="index.html#preauth">29. Pre-Authentication Scenarios</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#pre-authentication-framework-classes">29.1. Pre-Authentication Framework Classes</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#abstractpreauthenticatedprocessingfilter">29.1.1. AbstractPreAuthenticatedProcessingFilter</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#j2ee-preauth-details">J2eeBasedPreAuthenticatedWebAuthenticationDetailsSource</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#preauthenticatedauthenticationprovider">29.1.2. PreAuthenticatedAuthenticationProvider</a></span></dt><dt><span class="section"><a href="index.html#http403forbiddenentrypoint">29.1.3. Http403ForbiddenEntryPoint</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#concrete-implementations">29.2. Concrete Implementations</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#request-header-authentication-siteminder">29.2.1. Request-Header Authentication (Siteminder)</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#siteminder-example-configuration">Siteminder Example Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#java-ee-container-authentication">29.2.2. Java EE Container Authentication</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="index.html#ldap">30. LDAP Authentication</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#ldap-overview">30.1. Overview</a></span></dt><dt><span class="section"><a href="index.html#using-ldap-with-spring-security">30.2. Using LDAP with Spring Security</a></span></dt><dt><span class="section"><a href="index.html#ldap-server">30.3. Configuring an LDAP Server</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#using-an-embedded-test-server">30.3.1. Using an Embedded Test Server</a></span></dt><dt><span class="section"><a href="index.html#using-bind-authentication">30.3.2. Using Bind Authentication</a></span></dt><dt><span class="section"><a href="index.html#loading-authorities">30.3.3. Loading Authorities</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#implementation-classes">30.4. Implementation Classes</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#ldap-ldap-authenticators">30.4.1. LdapAuthenticator Implementations</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#ldap-ldap-authenticators-common">Common Functionality</a></span></dt><dt><span class="section"><a href="index.html#ldap-ldap-authenticators-bind">BindAuthenticator</a></span></dt><dt><span class="section"><a href="index.html#ldap-ldap-authenticators-password">PasswordComparisonAuthenticator</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#ldap-context-source">30.4.2. Connecting to the LDAP Server</a></span></dt><dt><span class="section"><a href="index.html#ldap-searchobjects">30.4.3. LDAP Search Objects</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#ldap-searchobjects-filter">FilterBasedLdapUserSearch</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#ldap-authorities">30.4.4. LdapAuthoritiesPopulator</a></span></dt><dt><span class="section"><a href="index.html#ldap-bean-config">30.4.5. Spring Bean Configuration</a></span></dt><dt><span class="section"><a href="index.html#ldap-custom-user-details">30.4.6. LDAP Attributes and Customized UserDetails</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#ldap-active-directory">30.5. Active Directory Authentication</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#activedirectoryldapauthenticationprovider">30.5.1. ActiveDirectoryLdapAuthenticationProvider</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#active-directory-error-codes">Active Directory Error Codes</a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="chapter"><a href="index.html#oauth2login-advanced">31. OAuth 2.0 Login&#8201;&#8212;&#8201;Advanced Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#oauth2login-advanced-login-page">31.1. OAuth 2.0 Login Page</a></span></dt><dt><span class="section"><a href="index.html#oauth2login-advanced-authorization-endpoint">31.2. Authorization Endpoint</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#oauth2login-advanced-authorization-request-repository">31.2.1. <code class="literal">AuthorizationRequestRepository</code></a></span></dt></dl></dd><dt><span class="section"><a href="index.html#oauth2login-advanced-redirection-endpoint">31.3. Redirection Endpoint</a></span></dt><dt><span class="section"><a href="index.html#oauth2login-advanced-token-endpoint">31.4. Token Endpoint</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#oauth2login-advanced-token-client">31.4.1. OAuth2AccessTokenResponseClient</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#oauth2login-advanced-userinfo-endpoint">31.5. UserInfo Endpoint</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#oauth2login-advanced-map-authorities">31.5.1. Mapping User Authorities</a></span></dt><dt><span class="section"><a href="index.html#oauth2login-advanced-custom-user">31.5.2. Configuring a Custom OAuth2User</a></span></dt><dt><span class="section"><a href="index.html#oauth2login-advanced-oauth2-user-service">31.5.3. OAuth 2.0 UserService</a></span></dt><dt><span class="section"><a href="index.html#oauth2login-advanced-oidc-user-service">31.5.4. OpenID Connect 1.0 UserService</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="index.html#taglibs">32. JSP Tag Libraries</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#declaring-the-taglib">32.1. Declaring the Taglib</a></span></dt><dt><span class="section"><a href="index.html#taglibs-authorize">32.2. The authorize Tag</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#disabling-tag-authorization-for-testing">32.2.1. Disabling Tag Authorization for Testing</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#the-authentication-tag">32.3. The authentication Tag</a></span></dt><dt><span class="section"><a href="index.html#the-accesscontrollist-tag">32.4. The accesscontrollist Tag</a></span></dt><dt><span class="section"><a href="index.html#the-csrfinput-tag">32.5. The csrfInput Tag</a></span></dt><dt><span class="section"><a href="index.html#the-csrfmetatags-tag">32.6. The csrfMetaTags Tag</a></span></dt></dl></dd><dt><span class="chapter"><a href="index.html#jaas">33. Java Authentication and Authorization Service (JAAS) Provider</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#overview-2">33.1. Overview</a></span></dt><dt><span class="section"><a href="index.html#jaas-abstractjaasauthenticationprovider">33.2. AbstractJaasAuthenticationProvider</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#jaas-callbackhandler">33.2.1. JAAS CallbackHandler</a></span></dt><dt><span class="section"><a href="index.html#jaas-authoritygranter">33.2.2. JAAS AuthorityGranter</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#jaas-defaultjaasauthenticationprovider">33.3. DefaultJaasAuthenticationProvider</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#jaas-inmemoryconfiguration">33.3.1. InMemoryConfiguration</a></span></dt><dt><span class="section"><a href="index.html#jaas-djap-config">33.3.2. DefaultJaasAuthenticationProvider Example Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#jaas-jaasauthenticationprovider">33.4. JaasAuthenticationProvider</a></span></dt><dt><span class="section"><a href="index.html#jaas-apiprovision">33.5. Running as a Subject</a></span></dt></dl></dd><dt><span class="chapter"><a href="index.html#cas">34. CAS Authentication</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#cas-overview">34.1. Overview</a></span></dt><dt><span class="section"><a href="index.html#cas-how-it-works">34.2. How CAS Works</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#cas-sequence">34.2.1. Spring Security and CAS Interaction Sequence</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#cas-client">34.3. Configuration of CAS Client</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#cas-st">34.3.1. Service Ticket Authentication</a></span></dt><dt><span class="section"><a href="index.html#cas-singlelogout">34.3.2. Single Logout</a></span></dt><dt><span class="section"><a href="index.html#cas-pt-client">34.3.3. Authenticating to a Stateless Service with CAS</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#cas-pt-client-config">Configuring CAS to Obtain Proxy Granting Tickets</a></span></dt><dt><span class="section"><a href="index.html#cas-pt-client-sample">Calling a Stateless Service Using a Proxy Ticket</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#cas-pt">34.3.4. Proxy Ticket Authentication</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="index.html#x509">35. X.509 Authentication</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#x509-overview">35.1. Overview</a></span></dt><dt><span class="section"><a href="index.html#adding-x-509-authentication-to-your-web-application">35.2. Adding X.509 Authentication to Your Web Application</a></span></dt><dt><span class="section"><a href="index.html#x509-ssl-config">35.3. Setting up SSL in Tomcat</a></span></dt></dl></dd><dt><span class="chapter"><a href="index.html#runas">36. Run-As Authentication Replacement</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#runas-overview">36.1. Overview</a></span></dt><dt><span class="section"><a href="index.html#runas-config">36.2. Configuration</a></span></dt></dl></dd><dt><span class="chapter"><a href="index.html#crypto">37. Spring Security Crypto Module</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#spring-security-crypto-introduction">37.1. Introduction</a></span></dt><dt><span class="section"><a href="index.html#spring-security-crypto-encryption">37.2. Encryptors</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#spring-security-crypto-encryption-bytes">37.2.1. BytesEncryptor</a></span></dt><dt><span class="section"><a href="index.html#spring-security-crypto-encryption-text">37.2.2. TextEncryptor</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#spring-security-crypto-keygenerators">37.3. Key Generators</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#byteskeygenerator">37.3.1. BytesKeyGenerator</a></span></dt><dt><span class="section"><a href="index.html#stringkeygenerator">37.3.2. StringKeyGenerator</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#spring-security-crypto-passwordencoders">37.4. Password Encoding</a></span></dt></dl></dd><dt><span class="chapter"><a href="index.html#concurrency">38. Concurrency Support</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#delegatingsecuritycontextrunnable">38.1. DelegatingSecurityContextRunnable</a></span></dt><dt><span class="section"><a href="index.html#delegatingsecuritycontextexecutor">38.2. DelegatingSecurityContextExecutor</a></span></dt><dt><span class="section"><a href="index.html#spring-security-concurrency-classes">38.3. Spring Security Concurrency Classes</a></span></dt></dl></dd><dt><span class="chapter"><a href="index.html#mvc">39. Spring MVC Integration</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#mvc-enablewebmvcsecurity">39.1. @EnableWebMvcSecurity</a></span></dt><dt><span class="section"><a href="index.html#mvc-requestmatcher">39.2. MvcRequestMatcher</a></span></dt><dt><span class="section"><a href="index.html#mvc-authentication-principal">39.3. @AuthenticationPrincipal</a></span></dt><dt><span class="section"><a href="index.html#mvc-async">39.4. Spring MVC Async Integration</a></span></dt><dt><span class="section"><a href="index.html#mvc-csrf">39.5. Spring MVC and CSRF Integration</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#automatic-token-inclusion">39.5.1. Automatic Token Inclusion</a></span></dt><dt><span class="section"><a href="index.html#mvc-csrf-resolver">39.5.2. Resolving the CsrfToken</a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="part"><a href="index.html#data">VII. Spring Data Integration</a></span></dt><dd><dl><dt><span class="chapter"><a href="index.html#data-configuration">40. Spring Data &amp; Spring Security Configuration</a></span></dt><dt><span class="chapter"><a href="index.html#data-query">41. Security Expressions within @Query</a></span></dt></dl></dd><dt><span class="part"><a href="index.html#appendix">VIII. Appendix</a></span></dt><dd><dl><dt><span class="chapter"><a href="index.html#appendix-schema">42. Security Database Schema</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#user-schema">42.1. User Schema</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#group-authorities">42.1.1. Group Authorities</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#persistent-login-remember-me-schema">42.2. Persistent Login (Remember-Me) Schema</a></span></dt><dt><span class="section"><a href="index.html#dbschema-acl">42.3. ACL Schema</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#hypersql">42.3.1. HyperSQL</a></span></dt><dt><span class="section"><a href="index.html#postgresql">42.3.2. PostgreSQL</a></span></dt><dt><span class="section"><a href="index.html#mysql-and-mariadb">42.3.3. MySQL and MariaDB</a></span></dt><dt><span class="section"><a href="index.html#microsoft-sql-server">42.3.4. Microsoft SQL Server</a></span></dt><dt><span class="section"><a href="index.html#oracle-database">42.3.5. Oracle Database</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="index.html#appendix-namespace">43. The Security Namespace</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-web">43.1. Web Application Security</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-debug">43.1.1. &lt;debug&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-http">43.1.2. &lt;http&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-http-attributes">&lt;http&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-http-children">Child Elements of &lt;http&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-access-denied-handler">43.1.3. &lt;access-denied-handler&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-access-denied-handler-parents">Parent Elements of &lt;access-denied-handler&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-access-denied-handler-attributes">&lt;access-denied-handler&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-cors">43.1.4. &lt;cors&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-cors-attributes">&lt;cors&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-cors-parents">Parent Elements of &lt;cors&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-headers">43.1.5. &lt;headers&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-headers-attributes">&lt;headers&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-headers-parents">Parent Elements of &lt;headers&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-headers-children">Child Elements of &lt;headers&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-cache-control">43.1.6. &lt;cache-control&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-cache-control-attributes">&lt;cache-control&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-cache-control-parents">Parent Elements of &lt;cache-control&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-hsts">43.1.7. &lt;hsts&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-hsts-attributes">&lt;hsts&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-hsts-parents">Parent Elements of &lt;hsts&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-hpkp">43.1.8. &lt;hpkp&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-hpkp-attributes">&lt;hpkp&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-hpkp-parents">Parent Elements of &lt;hpkp&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-pins">43.1.9. &lt;pins&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-pins-children">Child Elements of &lt;pins&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-pin">43.1.10. &lt;pin&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-pin-attributes">&lt;pin&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-pin-parents">Parent Elements of &lt;pin&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-content-security-policy">43.1.11. &lt;content-security-policy&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-content-security-policy-attributes">&lt;content-security-policy&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-content-security-policy-parents">Parent Elements of &lt;content-security-policy&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-referrer-policy">43.1.12. &lt;referrer-policy&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-referrer-policy-attributes">&lt;referrer-policy&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-referrer-policy-parents">Parent Elements of &lt;referrer-policy&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-frame-options">43.1.13. &lt;frame-options&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-frame-options-attributes">&lt;frame-options&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-frame-options-parents">Parent Elements of &lt;frame-options&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-xss-protection">43.1.14. &lt;xss-protection&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-xss-protection-attributes">&lt;xss-protection&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-xss-protection-parents">Parent Elements of &lt;xss-protection&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-content-type-options">43.1.15. &lt;content-type-options&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-content-type-options-attributes">&lt;content-type-options&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-content-type-options-parents">Parent Elements of &lt;content-type-options&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-header">43.1.16. &lt;header&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-header-attributes">&lt;header-attributes&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-header-parents">Parent Elements of &lt;header&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-anonymous">43.1.17. &lt;anonymous&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-anonymous-parents">Parent Elements of &lt;anonymous&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-anonymous-attributes">&lt;anonymous&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-csrf">43.1.18. &lt;csrf&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-csrf-parents">Parent Elements of &lt;csrf&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-csrf-attributes">&lt;csrf&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-custom-filter">43.1.19. &lt;custom-filter&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-custom-filter-parents">Parent Elements of &lt;custom-filter&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-custom-filter-attributes">&lt;custom-filter&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-expression-handler">43.1.20. &lt;expression-handler&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-expression-handler-parents">Parent Elements of &lt;expression-handler&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-expression-handler-attributes">&lt;expression-handler&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-form-login">43.1.21. &lt;form-login&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-form-login-parents">Parent Elements of &lt;form-login&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-form-login-attributes">&lt;form-login&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-http-basic">43.1.22. &lt;http-basic&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-http-basic-parents">Parent Elements of &lt;http-basic&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-http-basic-attributes">&lt;http-basic&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-http-firewall">43.1.23. &lt;http-firewall&gt; Element</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-http-firewall-attributes">&lt;http-firewall&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-intercept-url">43.1.24. &lt;intercept-url&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-intercept-url-parents">Parent Elements of &lt;intercept-url&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-intercept-url-attributes">&lt;intercept-url&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-jee">43.1.25. &lt;jee&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-jee-parents">Parent Elements of &lt;jee&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-jee-attributes">&lt;jee&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-logout">43.1.26. &lt;logout&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-logout-parents">Parent Elements of &lt;logout&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-logout-attributes">&lt;logout&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-openid-login">43.1.27. &lt;openid-login&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-openid-login-parents">Parent Elements of &lt;openid-login&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-openid-login-attributes">&lt;openid-login&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-openid-login-children">Child Elements of &lt;openid-login&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-attribute-exchange">43.1.28. &lt;attribute-exchange&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-attribute-exchange-parents">Parent Elements of &lt;attribute-exchange&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-attribute-exchange-attributes">&lt;attribute-exchange&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-attribute-exchange-children">Child Elements of &lt;attribute-exchange&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-openid-attribute">43.1.29. &lt;openid-attribute&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-openid-attribute-parents">Parent Elements of &lt;openid-attribute&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-openid-attribute-attributes">&lt;openid-attribute&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-port-mappings">43.1.30. &lt;port-mappings&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-port-mappings-parents">Parent Elements of &lt;port-mappings&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-port-mappings-children">Child Elements of &lt;port-mappings&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-port-mapping">43.1.31. &lt;port-mapping&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-port-mapping-parents">Parent Elements of &lt;port-mapping&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-port-mapping-attributes">&lt;port-mapping&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-remember-me">43.1.32. &lt;remember-me&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-remember-me-parents">Parent Elements of &lt;remember-me&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-remember-me-attributes">&lt;remember-me&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-request-cache">43.1.33. &lt;request-cache&gt; Element</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-request-cache-parents">Parent Elements of &lt;request-cache&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-request-cache-attributes">&lt;request-cache&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-session-management">43.1.34. &lt;session-management&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-session-management-parents">Parent Elements of &lt;session-management&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-session-management-attributes">&lt;session-management&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-session-management-children">Child Elements of &lt;session-management&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-concurrency-control">43.1.35. &lt;concurrency-control&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-concurrency-control-parents">Parent Elements of &lt;concurrency-control&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-concurrency-control-attributes">&lt;concurrency-control&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-x509">43.1.36. &lt;x509&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-x509-parents">Parent Elements of &lt;x509&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-x509-attributes">&lt;x509&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-filter-chain-map">43.1.37. &lt;filter-chain-map&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-filter-chain-map-attributes">&lt;filter-chain-map&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-filter-chain-map-children">Child Elements of &lt;filter-chain-map&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-filter-chain">43.1.38. &lt;filter-chain&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-filter-chain-parents">Parent Elements of &lt;filter-chain&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-filter-chain-attributes">&lt;filter-chain&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-filter-security-metadata-source">43.1.39. &lt;filter-security-metadata-source&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-filter-security-metadata-source-attributes">&lt;filter-security-metadata-source&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-filter-security-metadata-source-children">Child Elements of &lt;filter-security-metadata-source&gt;</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="index.html#nsa-websocket-security">43.2. WebSocket Security</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-websocket-message-broker">43.2.1. &lt;websocket-message-broker&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-websocket-message-broker-attributes">&lt;websocket-message-broker&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-websocket-message-broker-children">Child Elements of &lt;websocket-message-broker&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-intercept-message">43.2.2. &lt;intercept-message&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-intercept-message-parents">Parent Elements of &lt;intercept-message&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-intercept-message-attributes">&lt;intercept-message&gt; Attributes</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="index.html#nsa-authentication">43.3. Authentication Services</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-authentication-manager">43.3.1. &lt;authentication-manager&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-authentication-manager-attributes">&lt;authentication-manager&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-authentication-manager-children">Child Elements of &lt;authentication-manager&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-authentication-provider">43.3.2. &lt;authentication-provider&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-authentication-provider-parents">Parent Elements of &lt;authentication-provider&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-authentication-provider-attributes">&lt;authentication-provider&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-authentication-provider-children">Child Elements of &lt;authentication-provider&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-jdbc-user-service">43.3.3. &lt;jdbc-user-service&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-jdbc-user-service-attributes">&lt;jdbc-user-service&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-password-encoder">43.3.4. &lt;password-encoder&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-password-encoder-parents">Parent Elements of &lt;password-encoder&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-password-encoder-attributes">&lt;password-encoder&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-user-service">43.3.5. &lt;user-service&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-user-service-attributes">&lt;user-service&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-user-service-children">Child Elements of &lt;user-service&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-user">43.3.6. &lt;user&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-user-parents">Parent Elements of &lt;user&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-user-attributes">&lt;user&gt; Attributes</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="index.html#nsa-method-security">43.4. Method Security</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-global-method-security">43.4.1. &lt;global-method-security&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-global-method-security-attributes">&lt;global-method-security&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-global-method-security-children">Child Elements of &lt;global-method-security&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-after-invocation-provider">43.4.2. &lt;after-invocation-provider&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-after-invocation-provider-parents">Parent Elements of &lt;after-invocation-provider&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-after-invocation-provider-attributes">&lt;after-invocation-provider&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-pre-post-annotation-handling">43.4.3. &lt;pre-post-annotation-handling&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-pre-post-annotation-handling-parents">Parent Elements of &lt;pre-post-annotation-handling&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-pre-post-annotation-handling-children">Child Elements of &lt;pre-post-annotation-handling&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-invocation-attribute-factory">43.4.4. &lt;invocation-attribute-factory&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-invocation-attribute-factory-parents">Parent Elements of &lt;invocation-attribute-factory&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-invocation-attribute-factory-attributes">&lt;invocation-attribute-factory&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-post-invocation-advice">43.4.5. &lt;post-invocation-advice&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-post-invocation-advice-parents">Parent Elements of &lt;post-invocation-advice&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-post-invocation-advice-attributes">&lt;post-invocation-advice&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-pre-invocation-advice">43.4.6. &lt;pre-invocation-advice&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-pre-invocation-advice-parents">Parent Elements of &lt;pre-invocation-advice&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-pre-invocation-advice-attributes">&lt;pre-invocation-advice&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-protect-pointcut">43.4.7. Securing Methods using</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-protect-pointcut-parents">Parent Elements of &lt;protect-pointcut&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-protect-pointcut-attributes">&lt;protect-pointcut&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-intercept-methods">43.4.8. &lt;intercept-methods&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-intercept-methods-attributes">&lt;intercept-methods&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-intercept-methods-children">Child Elements of &lt;intercept-methods&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-method-security-metadata-source">43.4.9. &lt;method-security-metadata-source&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-method-security-metadata-source-attributes">&lt;method-security-metadata-source&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-method-security-metadata-source-children">Child Elements of &lt;method-security-metadata-source&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-protect">43.4.10. &lt;protect&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-protect-parents">Parent Elements of &lt;protect&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-protect-attributes">&lt;protect&gt; Attributes</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="index.html#nsa-ldap">43.5. LDAP Namespace Options</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-ldap-server">43.5.1. Defining the LDAP Server using the</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-ldap-server-attributes">&lt;ldap-server&gt; Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-ldap-authentication-provider">43.5.2. &lt;ldap-authentication-provider&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-ldap-authentication-provider-parents">Parent Elements of &lt;ldap-authentication-provider&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-ldap-authentication-provider-attributes">&lt;ldap-authentication-provider&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-ldap-authentication-provider-children">Child Elements of &lt;ldap-authentication-provider&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-password-compare">43.5.3. &lt;password-compare&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-password-compare-parents">Parent Elements of &lt;password-compare&gt;</a></span></dt><dt><span class="section"><a href="index.html#nsa-password-compare-attributes">&lt;password-compare&gt; Attributes</a></span></dt><dt><span class="section"><a href="index.html#nsa-password-compare-children">Child Elements of &lt;password-compare&gt;</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#nsa-ldap-user-service">43.5.4. &lt;ldap-user-service&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#nsa-ldap-user-service-attributes">&lt;ldap-user-service&gt; Attributes</a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="chapter"><a href="index.html#appendix-dependencies">44. Spring Security Dependencies</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#spring-security-core-2">44.1. spring-security-core</a></span></dt><dt><span class="section"><a href="index.html#spring-security-remoting-2">44.2. spring-security-remoting</a></span></dt><dt><span class="section"><a href="index.html#spring-security-web-2">44.3. spring-security-web</a></span></dt><dt><span class="section"><a href="index.html#spring-security-ldap-2">44.4. spring-security-ldap</a></span></dt><dt><span class="section"><a href="index.html#spring-security-config-2">44.5. spring-security-config</a></span></dt><dt><span class="section"><a href="index.html#spring-security-acl-2">44.6. spring-security-acl</a></span></dt><dt><span class="section"><a href="index.html#spring-security-cas-2">44.7. spring-security-cas</a></span></dt><dt><span class="section"><a href="index.html#spring-security-openid-2">44.8. spring-security-openid</a></span></dt><dt><span class="section"><a href="index.html#spring-security-taglibs">44.9. spring-security-taglibs</a></span></dt></dl></dd><dt><span class="chapter"><a href="index.html#appendix-proxy-server">45. Proxy Server Configuration</a></span></dt><dt><span class="chapter"><a href="index.html#appendix-faq">46. Spring Security FAQ</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#appendix-faq-general-questions">46.1. General Questions</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#appendix-faq-other-concerns">46.1.1. Will Spring Security take care of all my application security requirements?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-web-xml">46.1.2. Why not just use web.xml security?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-requirements">46.1.3. What Java and Spring Framework versions are required?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-start-simple">46.1.4. I&#8217;m new to Spring Security and I need to build an application that supports CAS single sign-on over HTTPS, while allowing Basic authentication locally for certain URLs, authenticating against multiple back end user information sources (LDAP and JDBC). I&#8217;ve copied some configuration files I found but it doesn&#8217;t work. What could be wrong?</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#appendix-faq-common-problems">46.2. Common Problems</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#appendix-faq-bad-credentials">46.2.1. When I try to log in, I get an error message that says "Bad Credentials". What&#8217;s wrong?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-login-loop">46.2.2. My application goes into an "endless loop" when I try to login, what&#8217;s going on?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-anon-access-denied">46.2.3. I get an exception with the message "Access is denied (user is anonymous);". What&#8217;s wrong?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-cached-secure-page">46.2.4. Why can I still see a secured page even after I&#8217;ve logged out of my application?</a></span></dt><dt><span class="section"><a href="index.html#auth-exception-credentials-not-found">46.2.5. I get an exception with the message "An Authentication object was not found in the SecurityContext". What&#8217;s wrong?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-ldap-authentication">46.2.6. I can&#8217;t get LDAP authentication to work. What&#8217;s wrong with my configuration?</a></span></dt><dt><span class="section"><a href="index.html#session-management">46.2.7. Session Management</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-concurrent-session-same-browser">46.2.8. I&#8217;m using Spring Security&#8217;s concurrent session control to prevent users from logging in more than once at a time. When I open another browser window after logging in, it doesn&#8217;t stop me from logging in again. Why can I log in more than once?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-new-session-on-authentication">46.2.9. Why does the session Id change when I authenticate through Spring Security?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-tomcat-https-session">46.2.10. I&#8217;m using Tomcat (or some other servlet container) and have enabled HTTPS for my login page, switching back to HTTP afterwards. It doesn&#8217;t work - I just end up back at the login page after authenticating.</a></span></dt><dt><span class="section"><a href="index.html#i-m-not-switching-between-http-and-https-but-my-session-is-still-getting-lost">46.2.11. I&#8217;m not switching between HTTP and HTTPS but my session is still getting lost</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-session-listener-missing">46.2.12. I&#8217;m trying to use the concurrent session-control support but it won&#8217;t let me log back in, even if I&#8217;m sure I&#8217;ve logged out and haven&#8217;t exceeded the allowed sessions.</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-unwanted-session-creation">46.2.13. Spring Security is creating a session somewhere, even though I&#8217;ve configured it not to, by setting the create-session attribute to never.</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-forbidden-csrf">46.2.14. I get a 403 Forbidden when performing a POST</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-no-security-on-forward">46.2.15. I&#8217;m forwarding a request to another URL using the RequestDispatcher, but my security constraints aren&#8217;t being applied.</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-method-security-in-web-context">46.2.16. I have added Spring Security&#8217;s &lt;global-method-security&gt; element to my application context but if I add security annotations to my Spring MVC controller beans (Struts actions etc.) then they don&#8217;t seem to have an effect.</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-no-filters-no-context">46.2.17. I have a user who has definitely been authenticated, but when I try to access the SecurityContextHolder during some requests, the Authentication is null. Why can&#8217;t I see the user information?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-method-security-with-taglib">46.2.18. The authorize JSP Tag doesn&#8217;t respect my method security annotations when using the URL attribute.</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#appendix-faq-architecture">46.3. Spring Security Architecture Questions</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#appendix-faq-where-is-class-x">46.3.1. How do I know which package class X is in?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-namespace-to-bean-mapping">46.3.2. How do the namespace elements map to conventional bean configurations?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-role-prefix">46.3.3. What does "ROLE_" mean and why do I need it on my role names?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-what-dependencies">46.3.4. How do I know which dependencies to add to my application to work with Spring Security?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-apacheds-deps">46.3.5. What dependencies are needed to run an embedded ApacheDS LDAP server?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-what-is-userdetailservice">46.3.6. What is a UserDetailsService and do I need one?</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#appendix-faq-howto">46.4. Common "Howto" Requests</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#appendix-faq-extra-login-fields">46.4.1. I need to login in with more information than just the username. How do I add support for extra login fields (e.g. a company name)?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-matching-url-fragments">46.4.2. How do I apply different intercept-url constraints where only the fragment value of the requested URLs differs (e.g./foo#bar and /foo#blah?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-request-details-in-user-service">46.4.3. How do I access the user&#8217;s IP Address (or other web-request data) in a UserDetailsService?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-access-session-from-user-service">46.4.4. How do I access the HttpSession from a UserDetailsService?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-password-in-user-service">46.4.5. How do I access the user&#8217;s password in a UserDetailsService?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-dynamic-url-metadata">46.4.6. How do I define the secured URLs within an application dynamically?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-ldap-authorities">46.4.7. How do I authenticate against LDAP but load user roles from a database?</a></span></dt><dt><span class="section"><a href="index.html#appendix-faq-namespace-post-processor">46.4.8. I want to modify the property of a bean that is created by the namespace, but there is nothing in the schema to support it. What can I do short of abandoning namespace use?</a></span></dt></dl></dd></dl></dd></dl></dd></dl></div>
<div class="preface"><div class="titlepage"><div><div><h1 class="title"><a name="d5e36" href="index.html#d5e36"></a></h1></div></div></div>
<p>Spring Security is a powerful and highly customizable authentication and access-control framework. It is the de-facto standard for securing Spring-based applications.</p>
</div>
<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="preface" href="index.html#preface"></a>Part&nbsp;I.&nbsp;Preface</h1></div></div></div>
<div class="partintro"><div></div>
<p>Spring Security provides a comprehensive security solution for Java EE-based enterprise software applications. As you will discover as you venture through this reference guide, we have tried to provide you a useful and highly configurable security system.</p>
<p>Security is an ever-moving target, and it&#8217;s important to pursue a comprehensive, system-wide approach. In security circles we encourage you to adopt "layers of security", so that each layer tries to be as secure as possible in its own right, with successive layers providing additional security. The "tighter" the security of each layer, the more robust and safe your application will be. At the bottom level you&#8217;ll need to deal with issues such as transport security and system identification, in order to mitigate man-in-the-middle attacks. Next you&#8217;ll generally utilise firewalls, perhaps with VPNs or IP security to ensure only authorised systems can attempt to connect. In corporate environments you may deploy a DMZ to separate public-facing servers from backend database and application servers. Your operating system will also play a critical part, addressing issues such as running processes as non-privileged users and maximising file system security. An operating system will usually also be configured with its own firewall. Hopefully somewhere along the way you&#8217;ll be trying to prevent denial of service and brute force attacks against the system. An intrusion detection system will also be especially useful for monitoring and responding to attacks, with such systems able to take protective action such as blocking offending TCP/IP addresses in real-time. Moving to the higher layers, your Java Virtual Machine will hopefully be configured to minimize the permissions granted to different Java types, and then your application will add its own problem domain-specific security configuration. Spring Security makes this latter area - application security - much easier.</p>
<p>Of course, you will need to properly address all security layers mentioned above, together with managerial factors that encompass every layer. A non-exhaustive list of such managerial factors would include security bulletin monitoring, patching, personnel vetting, audits, change control, engineering management systems, data backup, disaster recovery, performance benchmarking, load monitoring, centralised logging, incident response procedures etc.</p>
<p>With Spring Security being focused on helping you with the enterprise application security layer, you will find that there are as many different requirements as there are business problem domains. A banking application has different needs from an ecommerce application. An ecommerce application has different needs from a corporate sales force automation tool. These custom requirements make application security interesting, challenging and rewarding.</p>
<p>Please read <a class="xref" href="index.html#getting-started" title="1.&nbsp;Getting Started">Chapter&nbsp;1, <i>Getting Started</i></a>, in its entirety to begin with. This will introduce you to the framework and the namespace-based configuration system with which you can get up and running quite quickly. To get more of an understanding of how Spring Security works, and some of the classes you might need to use, you should then read <a class="xref" href="index.html#overall-architecture" title="Part&nbsp;II.&nbsp;Architecture and Implementation">Part&nbsp;II, &#8220;Architecture and Implementation&#8221;</a>. The remaining parts of this guide are structured in a more traditional reference style, designed to be read on an as-required basis. We&#8217;d also recommend that you read up as much as possible on application security issues in general. Spring Security is not a panacea which will solve all security issues. It is important that the application is designed with security in mind from the start. Attempting to retrofit it is not a good idea. In particular, if you are building a web application, you should be aware of the many potential vulnerabilities such as cross-site scripting, request-forgery and session-hijacking which you should be taking into account from the start. The OWASP web site (<a class="ulink" href="https://www.owasp.org/" target="_top">http://www.owasp.org/</a>) maintains a top ten list of web application vulnerabilities as well as a lot of useful reference information.</p>
<p>We hope that you find this reference guide useful, and we welcome your feedback and <a class="link" href="index.html#jira" title="8.1&nbsp;Issue Tracking">suggestions</a>.</p>
<p>Finally, welcome to the Spring Security <a class="link" href="index.html#community" title="8.&nbsp;Spring Security Community">community</a>.</p>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="getting-started" href="index.html#getting-started"></a>1.&nbsp;Getting Started</h2></div></div></div>
<p>The later parts of this guide provide an in-depth discussion of the framework architecture and implementation classes, which you need to understand if you want to do any serious customization. In this part, we&#8217;ll introduce Spring Security 4.0, give a brief overview of the project&#8217;s history and take a slightly gentler look at how to get started using the framework. In particular, we&#8217;ll look at namespace configuration which provides a much simpler way of securing your application compared to the traditional Spring bean approach where you have to wire up all the implementation classes individually.</p>
<p>We&#8217;ll also take a look at the sample applications that are available. It&#8217;s worth trying to run these and experimenting with them a bit even before you read the later sections - you can dip back into them as your understanding of the framework increases. Please also check out the <a class="ulink" href="https://spring.io/spring-security" target="_top">project website</a> as it has useful information on building the project, plus links to articles, videos and tutorials.</p>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="introduction" href="index.html#introduction"></a>2.&nbsp;Introduction</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="what-is-acegi-security" href="index.html#what-is-acegi-security"></a>2.1&nbsp;What is Spring Security?</h2></div></div></div>
<p>Spring Security provides comprehensive security services for Java EE-based enterprise software applications. There is a particular emphasis on supporting projects built using The Spring Framework, which is the leading Java EE solution for enterprise software development. If you&#8217;re not using Spring for developing enterprise applications, we warmly encourage you to take a closer look at it. Some familiarity with Spring - and in particular dependency injection principles - will help you get up to speed with Spring Security more easily.</p>
<p>People use Spring Security for many reasons, but most are drawn to the project after finding the security features of Java EE&#8217;s Servlet Specification or EJB Specification lack the depth required for typical enterprise application scenarios. Whilst mentioning these standards, it&#8217;s important to recognise that they are not portable at a WAR or EAR level. Therefore, if you switch server environments, it is typically a lot of work to reconfigure your application&#8217;s security in the new target environment. Using Spring Security overcomes these problems, and also brings you dozens of other useful, customisable security features.</p>
<p>As you probably know two major areas of application security are "authentication" and "authorization" (or "access-control"). These are the two main areas that Spring Security targets. "Authentication" is the process of establishing a principal is who they claim to be (a "principal" generally means a user, device or some other system which can perform an action in your application)."Authorization" refers to the process of deciding whether a principal is allowed to perform an action within your application. To arrive at the point where an authorization decision is needed, the identity of the principal has already been established by the authentication process. These concepts are common, and not at all specific to Spring Security.</p>
<p>At an authentication level, Spring Security supports a wide range of authentication models. Most of these authentication models are either provided by third parties, or are developed by relevant standards bodies such as the Internet Engineering Task Force. In addition, Spring Security provides its own set of authentication features. Specifically, Spring Security currently supports authentication integration with all of these technologies:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
HTTP BASIC authentication headers (an IETF RFC-based standard)
</li><li class="listitem">
HTTP Digest authentication headers (an IETF RFC-based standard)
</li><li class="listitem">
HTTP X.509 client certificate exchange (an IETF RFC-based standard)
</li><li class="listitem">
LDAP (a very common approach to cross-platform authentication needs, especially in large environments)
</li><li class="listitem">
Form-based authentication (for simple user interface needs)
</li><li class="listitem">
OpenID authentication
</li><li class="listitem">
Authentication based on pre-established request headers (such as Computer Associates Siteminder)
</li><li class="listitem">
Jasig Central Authentication Service (otherwise known as CAS, which is a popular open source single sign-on system)
</li><li class="listitem">
Transparent authentication context propagation for Remote Method Invocation (RMI) and HttpInvoker (a Spring remoting protocol)
</li><li class="listitem">
Automatic "remember-me" authentication (so you can tick a box to avoid re-authentication for a predetermined period of time)
</li><li class="listitem">
Anonymous authentication (allowing every unauthenticated call to automatically assume a particular security identity)
</li><li class="listitem">
Run-as authentication (which is useful if one call should proceed with a different security identity)
</li><li class="listitem">
Java Authentication and Authorization Service (JAAS)
</li><li class="listitem">
Java EE container authentication (so you can still use Container Managed Authentication if desired)
</li><li class="listitem">
Kerberos
</li><li class="listitem">
Java Open Source Single Sign-On (JOSSO) *
</li><li class="listitem">
OpenNMS Network Management Platform *
</li><li class="listitem">
AppFuse *
</li><li class="listitem">
AndroMDA *
</li><li class="listitem">
Mule ESB *
</li><li class="listitem">
Direct Web Request (DWR) *
</li><li class="listitem">
Grails *
</li><li class="listitem">
Tapestry *
</li><li class="listitem">
JTrac *
</li><li class="listitem">
Jasypt *
</li><li class="listitem">
Roller *
</li><li class="listitem">
Elastic Path *
</li><li class="listitem">
Atlassian Crowd *
</li><li class="listitem">
Your own authentication systems (see below)
</li></ul></div>
<p>(* Denotes provided by a third party)</p>
<p>Many independent software vendors (ISVs) adopt Spring Security because of this significant choice of flexible authentication models. Doing so allows them to quickly integrate their solutions with whatever their end clients need, without undertaking a lot of engineering or requiring the client to change their environment. If none of the above authentication mechanisms suit your needs, Spring Security is an open platform and it is quite simple to write your own authentication mechanism. Many corporate users of Spring Security need to integrate with "legacy" systems that don&#8217;t follow any particular security standards, and Spring Security is happy to "play nicely" with such systems.</p>
<p>Irrespective of the authentication mechanism, Spring Security provides a deep set of authorization capabilities. There are three main areas of interest: authorizing web requests, authorizing whether methods can be invoked and authorizing access to individual domain object instances. To help you understand the differences, consider the authorization capabilities found in the Servlet Specification web pattern security, EJB Container Managed Security and file system security respectively. Spring Security provides deep capabilities in all of these important areas, which we&#8217;ll explore later in this reference guide.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="history" href="index.html#history"></a>2.2&nbsp;History</h2></div></div></div>
<p>Spring Security began in late 2003 as "The Acegi Security System for Spring". A question was posed on the Spring Developers' mailing list asking whether there had been any consideration given to a Spring-based security implementation. At the time the Spring community was relatively small (especially compared with the size today!), and indeed Spring itself had only existed as a SourceForge project from early 2003. The response to the question was that it was a worthwhile area, although a lack of time currently prevented its exploration.</p>
<p>With that in mind, a simple security implementation was built and not released. A few weeks later another member of the Spring community inquired about security, and at the time this code was offered to them. Several other requests followed, and by January 2004 around twenty people were using the code. These pioneering users were joined by others who suggested a SourceForge project was in order, which was duly established in March 2004.</p>
<p>In those early days, the project didn&#8217;t have any of its own authentication modules. Container Managed Security was relied upon for the authentication process, with Acegi Security instead focusing on authorization. This was suitable at first, but as more and more users requested additional container support, the fundamental limitation of container-specific authentication realm interfaces became clear. There was also a related issue of adding new JARs to the container&#8217;s classpath, which was a common source of end user confusion and misconfiguration.</p>
<p>Acegi Security-specific authentication services were subsequently introduced. Around a year later, Acegi Security became an official Spring Framework subproject. The 1.0.0 final release was published in May 2006 - after more than two and a half years of active use in numerous production software projects and many hundreds of improvements and community contributions.</p>
<p>Acegi Security became an official Spring Portfolio project towards the end of 2007 and was rebranded as "Spring Security".</p>
<p>Today Spring Security enjoys a strong and active open source community. There are thousands of messages about Spring Security on the support forums. There is an active core of developers who work on the code itself and an active community which also regularly share patches and support their peers.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="release-numbering" href="index.html#release-numbering"></a>2.3&nbsp;Release Numbering</h2></div></div></div>
<p>It is useful to understand how Spring Security release numbers work, as it will help you identify the effort (or lack thereof) involved in migrating to future releases of the project. Each release uses a standard triplet of integers: MAJOR.MINOR.PATCH. The intent is that MAJOR versions are incompatible, large-scale upgrades of the API. MINOR versions should largely retain source and binary compatibility with older minor versions, thought there may be some design changes and incompatible updates. PATCH level should be perfectly compatible, forwards and backwards, with the possible exception of changes which are to fix bugs and defects.</p>
<p>The extent to which you are affected by changes will depend on how tightly integrated your code is. If you are doing a lot of customization you are more likely to be affected than if you are using a simple namespace configuration.</p>
<p>You should always test your application thoroughly before rolling out a new version.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="get-spring-security" href="index.html#get-spring-security"></a>2.4&nbsp;Getting Spring Security</h2></div></div></div>
<p>You can get hold of Spring Security in several ways. You can download a packaged distribution from the main <a class="ulink" href="https://spring.io/spring-security" target="_top">Spring Security</a> page, download individual jars from the Maven Central repository (or a Spring Maven repository for snapshot and milestone releases) or, alternatively, you can build the project from source yourself.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="maven" href="index.html#maven"></a>2.4.1&nbsp;Usage with Maven</h3></div></div></div>
<p>A minimal Spring Security Maven set of dependencies typically looks like the following:</p>
<p>
<b>pom.xml.&nbsp;</b>
</p><pre class="programlisting"><span class="hl-tag">&lt;dependencies&gt;</span>
<span class="hl-comment">&lt;!-- ... other dependency elements ... --&gt;</span>
<span class="hl-tag">&lt;dependency&gt;</span>
	<span class="hl-tag">&lt;groupId&gt;</span>org.springframework.security<span class="hl-tag">&lt;/groupId&gt;</span>
	<span class="hl-tag">&lt;artifactId&gt;</span>spring-security-web<span class="hl-tag">&lt;/artifactId&gt;</span>
	<span class="hl-tag">&lt;version&gt;</span>5.0.0.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span>
<span class="hl-tag">&lt;dependency&gt;</span>
	<span class="hl-tag">&lt;groupId&gt;</span>org.springframework.security<span class="hl-tag">&lt;/groupId&gt;</span>
	<span class="hl-tag">&lt;artifactId&gt;</span>spring-security-config<span class="hl-tag">&lt;/artifactId&gt;</span>
	<span class="hl-tag">&lt;version&gt;</span>5.0.0.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span>
<span class="hl-tag">&lt;/dependencies&gt;</span></pre><p>
</p>
<p>If you are using additional features like LDAP, OpenID, etc. you will need to also include the appropriate <a class="xref" href="index.html#modules" title="2.4.3&nbsp;Project Modules">Section&nbsp;2.4.3, &#8220;Project Modules&#8221;</a>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="maven-repositories" href="index.html#maven-repositories"></a>Maven Repositories</h4></div></div></div>
<p>All GA releases (i.e. versions ending in .RELEASE) are deployed to Maven Central, so no additional Maven repositories need to be declared in your pom.</p>
<p>If you are using a SNAPSHOT version, you will need to ensure you have the Spring Snapshot repository defined as shown below:</p>
<p>
<b>pom.xml.&nbsp;</b>
</p><pre class="programlisting"><span class="hl-tag">&lt;repositories&gt;</span>
<span class="hl-comment">&lt;!-- ... possibly other repository elements ... --&gt;</span>
<span class="hl-tag">&lt;repository&gt;</span>
	<span class="hl-tag">&lt;id&gt;</span>spring-snapshot<span class="hl-tag">&lt;/id&gt;</span>
	<span class="hl-tag">&lt;name&gt;</span>Spring Snapshot Repository<span class="hl-tag">&lt;/name&gt;</span>
	<span class="hl-tag">&lt;url&gt;</span>http://repo.spring.io/snapshot<span class="hl-tag">&lt;/url&gt;</span>
<span class="hl-tag">&lt;/repository&gt;</span>
<span class="hl-tag">&lt;/repositories&gt;</span></pre><p>
</p>
<p>If you are using a milestone or release candidate version, you will need to ensure you have the Spring Milestone repository defined as shown below:</p>
<p>
<b>pom.xml.&nbsp;</b>
</p><pre class="programlisting"><span class="hl-tag">&lt;repositories&gt;</span>
<span class="hl-comment">&lt;!-- ... possibly other repository elements ... --&gt;</span>
<span class="hl-tag">&lt;repository&gt;</span>
	<span class="hl-tag">&lt;id&gt;</span>spring-milestone<span class="hl-tag">&lt;/id&gt;</span>
	<span class="hl-tag">&lt;name&gt;</span>Spring Milestone Repository<span class="hl-tag">&lt;/name&gt;</span>
	<span class="hl-tag">&lt;url&gt;</span>http://repo.spring.io/milestone<span class="hl-tag">&lt;/url&gt;</span>
<span class="hl-tag">&lt;/repository&gt;</span>
<span class="hl-tag">&lt;/repositories&gt;</span></pre><p>
</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="maven-bom" href="index.html#maven-bom"></a>Spring Framework Bom</h4></div></div></div>
<p>Spring Security builds against Spring Framework 5.0.2.RELEASE, but should work with 4.0.x. The problem that many users will have is that Spring Security&#8217;s transitive dependencies resolve Spring Framework 5.0.2.RELEASE which can cause strange classpath problems.</p>
<p>One (tedious) way to circumvent this issue would be to include all the Spring Framework modules in a <a class="ulink" href="https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html#Dependency_Management" target="_top">&lt;dependencyManagement&gt;</a> section of your pom. An alternative approach is to include the <code class="literal">spring-framework-bom</code> within your <code class="literal">&lt;dependencyManagement&gt;</code> section of your <code class="literal">pom.xml</code> as shown below:</p>
<p>
<b>pom.xml.&nbsp;</b>
</p><pre class="programlisting"><span class="hl-tag">&lt;dependencyManagement&gt;</span>
	<span class="hl-tag">&lt;dependencies&gt;</span>
	<span class="hl-tag">&lt;dependency&gt;</span>
		<span class="hl-tag">&lt;groupId&gt;</span>org.springframework<span class="hl-tag">&lt;/groupId&gt;</span>
		<span class="hl-tag">&lt;artifactId&gt;</span>spring-framework-bom<span class="hl-tag">&lt;/artifactId&gt;</span>
		<span class="hl-tag">&lt;version&gt;</span>5.0.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
		<span class="hl-tag">&lt;type&gt;</span>pom<span class="hl-tag">&lt;/type&gt;</span>
		<span class="hl-tag">&lt;scope&gt;</span>import<span class="hl-tag">&lt;/scope&gt;</span>
	<span class="hl-tag">&lt;/dependency&gt;</span>
	<span class="hl-tag">&lt;/dependencies&gt;</span>
<span class="hl-tag">&lt;/dependencyManagement&gt;</span></pre><p>
</p>
<p>This will ensure that all the transitive dependencies of Spring Security use the Spring 5.0.2.RELEASE modules.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This approach uses Maven&#8217;s "bill of materials" (BOM) concept and is only available in Maven 2.0.9+. For additional details about how dependencies are resolved refer to <a class="ulink" href="https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html" target="_top">Maven&#8217;s Introduction to the Dependency Mechanism documentation</a>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="gradle" href="index.html#gradle"></a>2.4.2&nbsp;Gradle</h3></div></div></div>
<p>A minimal Spring Security Gradle set of dependencies typically looks like the following:</p>
<p>
<b>build.gradle.&nbsp;</b>
</p><pre class="programlisting">dependencies {
	compile <span class="hl-string">'org.springframework.security:spring-security-web:5.0.0.RELEASE'</span>
	compile <span class="hl-string">'org.springframework.security:spring-security-config:5.0.0.RELEASE'</span>
}</pre><p>
</p>
<p>If you are using additional features like LDAP, OpenID, etc. you will need to also include the appropriate <a class="xref" href="index.html#modules" title="2.4.3&nbsp;Project Modules">Section&nbsp;2.4.3, &#8220;Project Modules&#8221;</a>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="gradle-repositories" href="index.html#gradle-repositories"></a>Gradle Repositories</h4></div></div></div>
<p>All GA releases (i.e. versions ending in .RELEASE) are deployed to Maven Central, so using the mavenCentral() repository is sufficient for GA releases.</p>
<p>
<b>build.gradle.&nbsp;</b>
</p><pre class="programlisting">repositories {
	mavenCentral()
}</pre><p>
</p>
<p>If you are using a SNAPSHOT version, you will need to ensure you have the Spring Snapshot repository defined as shown below:</p>
<p>
<b>build.gradle.&nbsp;</b>
</p><pre class="programlisting">repositories {
	maven { url <span class="hl-string">'https://repo.spring.io/snapshot'</span> }
}</pre><p>
</p>
<p>If you are using a milestone or release candidate version, you will need to ensure you have the Spring Milestone repository defined as shown below:</p>
<p>
<b>build.gradle.&nbsp;</b>
</p><pre class="programlisting">repositories {
	maven { url <span class="hl-string">'https://repo.spring.io/milestone'</span> }
}</pre><p>
</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="gradle-resolutionStrategy" href="index.html#gradle-resolutionStrategy"></a>Using Spring 4.0.x and Gradle</h4></div></div></div>
<p>By default Gradle will use the newest version when resolving transitive versions. This means that often times no additional work is necessary when running Spring Security 5.0.0.RELEASE with Spring Framework 5.0.2.RELEASE. However, at times there can be issues that come up so it is best to mitigate this using <a class="ulink" href="http://www.gradle.org/docs/current/dsl/org.gradle.api.artifacts.ResolutionStrategy.html" target="_top">Gradle&#8217;s ResolutionStrategy</a> as shown below:</p>
<p>
<b>build.gradle.&nbsp;</b>
</p><pre class="programlisting">configurations.all {
	resolutionStrategy.eachDependency { DependencyResolveDetails details -&gt;
		<span class="hl-keyword">if</span> (details.requested.group == <span class="hl-string">'org.springframework'</span>) {
			details.useVersion <span class="hl-string">'5.0.2.RELEASE'</span>
		}
	}
}</pre><p>
</p>
<p>This will ensure that all the transitive dependencies of Spring Security use the Spring 5.0.2.RELEASE modules.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This example uses Gradle 1.9, but may need modifications to work in future versions of Gradle since this is an incubating feature within Gradle.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="modules" href="index.html#modules"></a>2.4.3&nbsp;Project Modules</h3></div></div></div>
<p>In Spring Security 3.0, the codebase has been sub-divided into separate jars which more clearly separate different functionality areas and third-party dependencies. If you are using Maven to build your project, then these are the modules you will add to your <code class="literal">pom.xml</code>. Even if you&#8217;re not using Maven, we&#8217;d recommend that you consult the <code class="literal">pom.xml</code> files to get an idea of third-party dependencies and versions. Alternatively, a good idea is to examine the libraries that are included in the sample applications.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="spring-security-core" href="index.html#spring-security-core"></a>Core - spring-security-core.jar</h4></div></div></div>
<p>Contains core authentication and access-contol classes and interfaces, remoting support and basic provisioning APIs. Required by any application which uses Spring Security. Supports standalone applications, remote clients, method (service layer) security and JDBC user provisioning. Contains the top-level packages:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">org.springframework.security.core</code>
</li><li class="listitem">
<code class="literal">org.springframework.security.access</code>
</li><li class="listitem">
<code class="literal">org.springframework.security.authentication</code>
</li><li class="listitem">
<code class="literal">org.springframework.security.provisioning</code>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="spring-security-remoting" href="index.html#spring-security-remoting"></a>Remoting - spring-security-remoting.jar</h4></div></div></div>
<p>Provides intergration with Spring Remoting. You don&#8217;t need this unless you are writing a remote client which uses Spring Remoting. The main package is <code class="literal">org.springframework.security.remoting</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="spring-security-web" href="index.html#spring-security-web"></a>Web - spring-security-web.jar</h4></div></div></div>
<p>Contains filters and related web-security infrastructure code. Anything with a servlet API dependency. You&#8217;ll need it if you require Spring Security web authentication services and URL-based access-control. The main package is <code class="literal">org.springframework.security.web</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="spring-security-config" href="index.html#spring-security-config"></a>Config - spring-security-config.jar</h4></div></div></div>
<p>Contains the security namespace parsing code &amp; Java configuration code.
You need it if you are using the Spring Security XML namespace for configuration or Spring Security&#8217;s Java Configuration support.
The main package is <code class="literal">org.springframework.security.config</code>.
None of the classes are intended for direct use in an application.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="spring-security-ldap" href="index.html#spring-security-ldap"></a>LDAP - spring-security-ldap.jar</h4></div></div></div>
<p>LDAP authentication and provisioning code. Required if you need to use LDAP authentication or manage LDAP user entries. The top-level package is <code class="literal">org.springframework.security.ldap</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="spring-security-oauth2-core" href="index.html#spring-security-oauth2-core"></a>OAuth 2.0 Core - spring-security-oauth2-core.jar</h4></div></div></div>
<p><code class="literal">spring-security-oauth2-core.jar</code> contains core classes and interfaces that provide support for the <span class="emphasis"><em>OAuth 2.0 Authorization Framework</em></span> and for <span class="emphasis"><em>OpenID Connect Core 1.0</em></span>. It is required by applications that use <span class="emphasis"><em>OAuth 2.0</em></span> or <span class="emphasis"><em>OpenID Connect Core 1.0</em></span>, such as Client, Resource Server, and Authorization Server. The top-level package is <code class="literal">org.springframework.security.oauth2.core</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="spring-security-oauth2-client" href="index.html#spring-security-oauth2-client"></a>OAuth 2.0 Client - spring-security-oauth2-client.jar</h4></div></div></div>
<p><code class="literal">spring-security-oauth2-client.jar</code> is Spring Security&#8217;s client support for <span class="emphasis"><em>OAuth 2.0 Authorization Framework</em></span> and <span class="emphasis"><em>OpenID Connect Core 1.0</em></span>. Required by applications leveraging <span class="strong"><strong>OAuth 2.0 Login</strong></span> and/or OAuth Client support. The top-level package is <code class="literal">org.springframework.security.oauth2.client</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="spring-security-oauth2-jose" href="index.html#spring-security-oauth2-jose"></a>OAuth 2.0 JOSE - spring-security-oauth2-jose.jar</h4></div></div></div>
<p><code class="literal">spring-security-oauth2-jose.jar</code> contains Spring Security&#8217;s support for the <span class="emphasis"><em>JOSE</em></span> (Javascript Object Signing and Encryption) framework. The <span class="emphasis"><em>JOSE</em></span> framework is intended to provide a method to securely transfer claims between parties. It is built from a collection of specifications:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
JSON Web Token (JWT)
</li><li class="listitem">
JSON Web Signature (JWS)
</li><li class="listitem">
JSON Web Encryption (JWE)
</li><li class="listitem">
JSON Web Key (JWK)
</li></ul></div>
<p>It contains the top-level packages:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">org.springframework.security.oauth2.jwt</code>
</li><li class="listitem">
<code class="literal">org.springframework.security.oauth2.jose</code>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="spring-security-acl" href="index.html#spring-security-acl"></a>ACL - spring-security-acl.jar</h4></div></div></div>
<p>Specialized domain object ACL implementation. Used to apply security to specific domain object instances within your application. The top-level package is <code class="literal">org.springframework.security.acls</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="spring-security-cas" href="index.html#spring-security-cas"></a>CAS - spring-security-cas.jar</h4></div></div></div>
<p>Spring Security&#8217;s CAS client integration. If you want to use Spring Security web authentication with a CAS single sign-on server. The top-level package is <code class="literal">org.springframework.security.cas</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="spring-security-openid" href="index.html#spring-security-openid"></a>OpenID - spring-security-openid.jar</h4></div></div></div>
<p>OpenID web authentication support. Used to authenticate users against an external OpenID server. <code class="literal">org.springframework.security.openid</code>. Requires OpenID4Java.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="spring-security-test" href="index.html#spring-security-test"></a>Test - spring-security-test.jar</h4></div></div></div>
<p>Support for testing with Spring Security.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="get-source" href="index.html#get-source"></a>2.4.4&nbsp;Checking out the Source</h3></div></div></div>
<p>Since Spring Security is an Open Source project, we&#8217;d strongly encourage you to check out the source code using git. This will give you full access to all the sample applications and you can build the most up to date version of the project easily. Having the source for a project is also a huge help in debugging. Exception stack traces are no longer obscure black-box issues but you can get straight to the line that&#8217;s causing the problem and work out what&#8217;s happening. The source is the ultimate documentation for a project and often the simplest place to find out how something actually works.</p>
<p>To obtain the source for the project, use the following git command:</p>
<pre class="programlisting">git clone https://github.com/spring-projects/spring-security.git</pre>
<p>This will give you access to the entire project history (including all releases and branches) on your local machine.</p>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="new" href="index.html#new"></a>3.&nbsp;What&#8217;s New in Spring Security 5.0</h2></div></div></div>
<p>Spring Security 5.0 provides a number of new features as well as support for Spring Framework 5.
In total there were 400+ enhancements and bugs resolved.
You can find the change log at
<a class="ulink" href="https://github.com/spring-projects/spring-security/milestone/90?closed=1" target="_top">5.0.0.M1</a>
<a class="ulink" href="https://github.com/spring-projects/spring-security/milestone/97?closed=1" target="_top">5.0.0.M2</a>
<a class="ulink" href="https://github.com/spring-projects/spring-security/milestone/100?closed=1" target="_top">5.0.0.M3</a>
<a class="ulink" href="https://github.com/spring-projects/spring-security/milestone/101?closed=1" target="_top">5.0.0.M4</a>
<a class="ulink" href="https://github.com/spring-projects/spring-security/milestone/102?closed=1" target="_top">5.0.0.M5</a>
<a class="ulink" href="https://github.com/spring-projects/spring-security/milestone/103?closed=1" target="_top">5.0.0.RC1</a>
<a class="ulink" href="https://github.com/spring-projects/spring-security/milestone/98?closed=1" target="_top">5.0.0.RELEASE</a>.
Below are the highlights of this milestone release.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="new-features" href="index.html#new-features"></a>3.1&nbsp;New Features</h2></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#jc-oauth2login" title="5.7&nbsp;OAuth 2.0 Login">OAuth 2.0 Login</a>
</li><li class="listitem">
<p class="simpara">Reactive Support</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<a class="link" href="index.html#jc-webflux" title="5.6&nbsp;WebFlux Security">@EnableWebFluxSecurity</a>
</li><li class="listitem">
<a class="link" href="index.html#jc-erms" title="5.10.3&nbsp;EnableReactiveMethodSecurity">@EnableReactiveMethodSecurity</a>
</li><li class="listitem">
<a class="link" href="index.html#test-webflux" title="13.&nbsp;WebFlux Support">WebFlux Testing Support</a>
</li></ul></div>
</li><li class="listitem">
Modernized <a class="link" href="index.html#core-services-password-encoding" title="10.3&nbsp;Password Encoding">Password Encoding</a>
</li></ul></div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="samples" href="index.html#samples"></a>4.&nbsp;Samples and Guides (Start Here)</h2></div></div></div>
<p>If you are looking to get started with Spring Security, the best place to start is our Sample Applications.</p>
<div class="table"><a name="d5e353" href="index.html#d5e353"></a><p class="title"><b>Table&nbsp;4.1.&nbsp;Sample Applications</b></p><div class="table-contents">
<table summary="Sample Applications" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Source</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Guide</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="ulink" href="https://github.com/spring-projects/spring-security/tree/5.0.0.RELEASE/samples/javaconfig/helloworld" target="_top">Hello Spring Security</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Demonstrates how to integrate Spring Security with an existing application using Java-based configuration.</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="ulink" href="https://docs.spring.io/spring-security/site/docs/5.0.0.RELEASE/guides/html5/helloworld-javaconfig.html" target="_top">Hello Spring Security Guide</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="ulink" href="https://github.com/spring-projects/spring-security/tree/5.0.0.RELEASE/samples/boot/helloworld" target="_top">Hello Spring Security Boot</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Demonstrates how to integrate Spring Security with an existing Spring Boot application.</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="ulink" href="https://docs.spring.io/spring-security/site/docs/5.0.0.RELEASE/guides/html5/helloworld-boot.html" target="_top">Hello Spring Security Boot Guide</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="ulink" href="https://github.com/spring-projects/spring-security/tree/5.0.0.RELEASE/samples/xml/helloworld" target="_top">Hello Spring Security XML</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Demonstrates how to integrate Spring Security with an existing application using XML-based configuration.</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="ulink" href="https://docs.spring.io/spring-security/site/docs/5.0.0.RELEASE/guides/html5/helloworld-xml.html" target="_top">Hello Spring Security XML Guide</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="ulink" href="https://github.com/spring-projects/spring-security/tree/5.0.0.RELEASE/samples/javaconfig/hellomvc" target="_top">Hello Spring MVC Security</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Demonstrates how to integrate Spring Security with an existing Spring MVC application.</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="ulink" href="https://docs.spring.io/spring-security/site/docs/5.0.0.RELEASE/guides/html5/hellomvc-javaconfig.html" target="_top">Hello Spring MVC Security Guide</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="ulink" href="https://github.com/spring-projects/spring-security/tree/5.0.0.RELEASE/samples/javaconfig/form" target="_top">Custom Login Form</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Demonstrates how to create a custom login form.</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="ulink" href="https://docs.spring.io/spring-security/site/docs/5.0.0.RELEASE/guides/html5/form-javaconfig.html" target="_top">Custom Login Form Guide</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><a class="ulink" href="https://github.com/spring-projects/spring-security/tree/5.0.0.RELEASE/samples/boot/oauth2login" target="_top">OAuth 2.0 Login</a></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Demonstrates how to integrate OAuth 2.0 Login with an OAuth 2.0 or OpenID Connect 1.0 Provider.</p></td><td style="" align="left" valign="top"><p><a class="ulink" href="https://github.com/spring-projects/spring-security/tree/5.0.0.RELEASE/samples/boot/oauth2login/README.adoc" target="_top">OAuth 2.0 Login Guide</a></p></td></tr></tbody></table>
</div></div><br class="table-break">
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="jc" href="index.html#jc"></a>5.&nbsp;Java Configuration</h2></div></div></div>
<p>General support for <a class="ulink" href="https://docs.spring.io/spring/docs/3.1.x/spring-framework-reference/html/beans.html#beans-java" target="_top">Java Configuration</a> was added to Spring Framework in Spring 3.1. Since Spring Security 3.2 there has been Spring Security Java Configuration support which enables users to easily configure Spring Security without the use of any XML.</p>
<p>If you are familiar with the <a class="xref" href="index.html#ns-config" title="6.&nbsp;Security Namespace Configuration">Chapter&nbsp;6, <i>Security Namespace Configuration</i></a> then you should find quite a few similarities between it and the Security Java Configuration support.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring Security provides <a class="ulink" href="https://github.com/spring-projects/spring-security/tree/master/samples/javaconfig" target="_top">lots of sample applications</a> which demonstrate the use of Spring Security Java Configuration.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="hello-web-security-java-configuration" href="index.html#hello-web-security-java-configuration"></a>5.1&nbsp;Hello Web Security Java Configuration</h2></div></div></div>
<p>The first step is to create our Spring Security Java Configuration. The configuration creates a Servlet Filter known as the <code class="literal">springSecurityFilterChain</code> which is responsible for all the security (protecting the application URLs, validating submitted username and passwords, redirecting to the log in form, etc) within your application. You can find the most basic example of a Spring Security Java Configuration below:</p>
<a name="jc-hello-wsca" href="index.html#jc-hello-wsca"></a><pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;

<span class="hl-keyword">import</span> org.springframework.context.annotation.*;
<span class="hl-keyword">import</span> org.springframework.security.config.annotation.authentication.builders.*;
<span class="hl-keyword">import</span> org.springframework.security.config.annotation.web.configuration.*;

<em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">implements</span> WebMvcConfigurer {

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<span class="hl-keyword">public</span> UserDetailsService userDetailsService() <span class="hl-keyword">throws</span> Exception {
		InMemoryUserDetailsManager manager = <span class="hl-keyword">new</span> InMemoryUserDetailsManager();
		manager.createUser(User.withDefaultPasswordEncoder().username(<span class="hl-string">"user"</span>).password(<span class="hl-string">"password"</span>).roles(<span class="hl-string">"USER"</span>).build());
		<span class="hl-keyword">return</span> manager;
	}
}</pre>
<p>There really isn&#8217;t much to this configuration, but it does a lot. You can find a summary of the features below:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Require authentication to every URL in your application
</li><li class="listitem">
Generate a login form for you
</li><li class="listitem">
Allow the user with the <span class="strong"><strong>Username</strong></span> <span class="emphasis"><em>user</em></span> and the <span class="strong"><strong>Password</strong></span> <span class="emphasis"><em>password</em></span> to authenticate with form based authentication
</li><li class="listitem">
Allow the user to logout
</li><li class="listitem">
<a class="ulink" href="https://en.wikipedia.org/wiki/Cross-site_request_forgery" target="_top">CSRF attack</a> prevention
</li><li class="listitem">
<a class="ulink" href="https://en.wikipedia.org/wiki/Session_fixation" target="_top">Session Fixation</a> protection
</li><li class="listitem">
<p class="simpara">Security Header integration</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<a class="ulink" href="https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security" target="_top">HTTP Strict Transport Security</a> for secure requests
</li><li class="listitem">
<a class="ulink" href="https://msdn.microsoft.com/en-us/library/ie/gg622941(v=vs.85).aspx" target="_top">X-Content-Type-Options</a> integration
</li><li class="listitem">
Cache Control (can be overridden later by your application to allow caching of your static resources)
</li><li class="listitem">
<a class="ulink" href="https://msdn.microsoft.com/en-us/library/dd565647(v=vs.85).aspx" target="_top">X-XSS-Protection</a> integration
</li><li class="listitem">
X-Frame-Options integration to help prevent <a class="ulink" href="https://en.wikipedia.org/wiki/Clickjacking" target="_top">Clickjacking</a>
</li></ul></div>
</li><li class="listitem">
<p class="simpara">Integrate with the following Servlet API methods</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#getRemoteUser()" target="_top">HttpServletRequest#getRemoteUser()</a>
</li><li class="listitem">
<a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#getUserPrincipal()" target="_top">HttpServletRequest.html#getUserPrincipal()</a>
</li><li class="listitem">
<a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#isUserInRole(java.lang.String)" target="_top">HttpServletRequest.html#isUserInRole(java.lang.String)</a>
</li><li class="listitem">
<a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#login(java.lang.String,%20java.lang.String)" target="_top">HttpServletRequest.html#login(java.lang.String, java.lang.String)</a>
</li><li class="listitem">
<a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#logout()" target="_top">HttpServletRequest.html#logout()</a>
</li></ul></div>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="abstractsecuritywebapplicationinitializer" href="index.html#abstractsecuritywebapplicationinitializer"></a>5.1.1&nbsp;AbstractSecurityWebApplicationInitializer</h3></div></div></div>
<p>The next step is to register the <code class="literal">springSecurityFilterChain</code> with the war. This can be done in Java Configuration with <a class="ulink" href="https://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/mvc.html#mvc-container-config" target="_top">Spring&#8217;s WebApplicationInitializer support</a> in a Servlet 3.0+ environment. Not suprisingly, Spring Security provides a base class <code class="literal">AbstractSecurityWebApplicationInitializer</code> that will ensure the <code class="literal">springSecurityFilterChain</code> gets registered for you. The way in which we use <code class="literal">AbstractSecurityWebApplicationInitializer</code> differs depending on if we are already using Spring or if Spring Security is the only Spring component in our application.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="index.html#abstractsecuritywebapplicationinitializer-without-existing-spring" title="5.1.2&nbsp;AbstractSecurityWebApplicationInitializer without Existing Spring">Section&nbsp;5.1.2, &#8220;AbstractSecurityWebApplicationInitializer without Existing Spring&#8221;</a> - Use these instructions if you are not using Spring already
</li><li class="listitem">
<a class="xref" href="index.html#abstractsecuritywebapplicationinitializer-with-spring-mvc" title="5.1.3&nbsp;AbstractSecurityWebApplicationInitializer with Spring MVC">Section&nbsp;5.1.3, &#8220;AbstractSecurityWebApplicationInitializer with Spring MVC&#8221;</a> - Use these instructions if you are already using Spring
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="abstractsecuritywebapplicationinitializer-without-existing-spring" href="index.html#abstractsecuritywebapplicationinitializer-without-existing-spring"></a>5.1.2&nbsp;AbstractSecurityWebApplicationInitializer without Existing Spring</h3></div></div></div>
<p>If you are not using Spring or Spring MVC, you will need to pass in the <code class="literal">WebSecurityConfig</code> into the superclass to ensure the configuration is picked up. You can find an example below:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.security.web.context.*;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SecurityWebApplicationInitializer
	<span class="hl-keyword">extends</span> AbstractSecurityWebApplicationInitializer {

	<span class="hl-keyword">public</span> SecurityWebApplicationInitializer() {
		<span class="hl-keyword">super</span>(WebSecurityConfig.<span class="hl-keyword">class</span>);
	}
}</pre>
<p>The <code class="literal">SecurityWebApplicationInitializer</code> will do the following things:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Automatically register the springSecurityFilterChain Filter for every URL in your application
</li><li class="listitem">
Add a ContextLoaderListener that loads the <a class="link" href="index.html#jc-hello-wsca">WebSecurityConfig</a>.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="abstractsecuritywebapplicationinitializer-with-spring-mvc" href="index.html#abstractsecuritywebapplicationinitializer-with-spring-mvc"></a>5.1.3&nbsp;AbstractSecurityWebApplicationInitializer with Spring MVC</h3></div></div></div>
<p>If we were using Spring elsewhere in our application we probably already had a <code class="literal">WebApplicationInitializer</code> that is loading our Spring Configuration. If we use the previous configuration we would get an error. Instead, we should register Spring Security with the existing <code class="literal">ApplicationContext</code>. For example, if we were using Spring MVC our <code class="literal">SecurityWebApplicationInitializer</code> would look something like the following:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.security.web.context.*;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SecurityWebApplicationInitializer
	<span class="hl-keyword">extends</span> AbstractSecurityWebApplicationInitializer {

}</pre>
<p>This would simply only register the springSecurityFilterChain Filter for every URL in your application. After that we would ensure that <code class="literal">WebSecurityConfig</code> was loaded in our existing ApplicationInitializer. For example, if we were using Spring MVC it would be added in the <code class="literal">getRootConfigClasses()</code></p>
<a name="message-web-application-inititializer-java" href="index.html#message-web-application-inititializer-java"></a><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MvcWebApplicationInitializer <span class="hl-keyword">extends</span>
		AbstractAnnotationConfigDispatcherServletInitializer {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Class[] { WebSecurityConfig.<span class="hl-keyword">class</span> };
	}

	<span class="hl-comment">// ... other overrides ...</span>
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jc-httpsecurity" href="index.html#jc-httpsecurity"></a>5.2&nbsp;HttpSecurity</h2></div></div></div>
<p>Thus far our <a class="link" href="index.html#jc-hello-wsca">WebSecurityConfig</a> only contains information about how to authenticate our users. How does Spring Security know that we want to require all users to be authenticated? How does Spring Security know we want to support form based authentication? The reason for this is that the <code class="literal">WebSecurityConfigurerAdapter</code> provides a default configuration in the <code class="literal">configure(HttpSecurity http)</code> method that looks like:</p>
<pre class="programlisting"><span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
		.authorizeRequests()
			.anyRequest().authenticated()
			.and()
		.formLogin()
			.and()
		.httpBasic();
}</pre>
<p>The default configuration above:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Ensures that any request to our application requires the user to be authenticated
</li><li class="listitem">
Allows users to authenticate with form based login
</li><li class="listitem">
Allows users to authenticate with HTTP Basic authentication
</li></ul></div>
<p>You will notice that this configuration is quite similar the XML Namespace configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-tag">&lt;intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/**"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"authenticated"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;form-login /&gt;</span>
	<span class="hl-tag">&lt;http-basic /&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>The Java Configuration equivalent of closing an XML tag is expressed using the <code class="literal">and()</code> method which allows us to continue configuring the parent. If you read the code it also makes sense. I want to configure authorized requests <span class="emphasis"><em>and</em></span> configure form login <span class="emphasis"><em>and</em></span> configure HTTP Basic authentication.</p>
<p>However, Java Configuration has different defaults URLs and parameters. Keep this in mind when creating custom login pages. The result is that our URLs are more RESTful. Additionally, it is not quite so obvious we are using Spring Security which helps to prevent <a class="ulink" href="https://www.owasp.org/index.php/Information_Leak_(information_disclosure)" target="_top">information leaks</a>. For example:</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jc-form" href="index.html#jc-form"></a>5.3&nbsp;Java Configuration and Form Login</h2></div></div></div>
<p>You might be wondering where the login form came from when you were prompted to log in, since we made no mention of any HTML files or JSPs. Since Spring Security&#8217;s default configuration does not explicitly set a URL for the login page, Spring Security generates one automatically, based on the features that are enabled and using standard values for the URL which processes the submitted login, the default target URL the user will be sent to after logging in and so on.</p>
<p>While the automatically generated log in page is convenient to get up and running quickly, most applications will want to provide their own log in page. To do so we can update our configuration as seen below:</p>
<pre class="programlisting"><span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
		.authorizeRequests()
			.anyRequest().authenticated()
			.and()
		.formLogin()
			.loginPage(<span class="hl-string">"/login"</span>) <a name="CO1-1" href="index.html#CO1-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
			.permitAll();        <a name="CO1-2" href="index.html#CO1-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO1-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The updated configuration specifies the location of the log in page.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO1-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>We must grant all users (i.e. unauthenticated users) access to our log in page. The <code class="literal">formLogin().permitAll()</code> method allows granting access to all users for all URLs associated with form based log in.</p>
</td></tr></table></div>
<p>An example log in page implemented with JSPs for our current configuration can be seen below:</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The login page below represents our current configuration. We could easily update our configuration if some of the defaults do not meet our needs.</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;c:url</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/login"</span> <span class="hl-attribute">var</span>=<span class="hl-value">"loginUrl"</span><span class="hl-tag">/&gt;</span>
&lt;form <span class="hl-attribute">action</span>=<span class="hl-value">"${loginUrl}"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"post"</span>&gt;       <a name="CO2-1" href="index.html#CO2-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
	<span class="hl-tag">&lt;c:if</span> <span class="hl-attribute">test</span>=<span class="hl-value">"${param.error != null}"</span><span class="hl-tag">&gt;</span>        <a name="CO2-2" href="index.html#CO2-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
		&lt;p&gt;
			Invalid username and password.
		&lt;/p&gt;
	<span class="hl-tag">&lt;/c:if&gt;</span>
	<span class="hl-tag">&lt;c:if</span> <span class="hl-attribute">test</span>=<span class="hl-value">"${param.logout != null}"</span><span class="hl-tag">&gt;</span>       <a name="CO2-3" href="index.html#CO2-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
		&lt;p&gt;
			You have been logged out.
		&lt;/p&gt;
	<span class="hl-tag">&lt;/c:if&gt;</span>
	&lt;p&gt;
		&lt;label <span class="hl-attribute">for</span>=<span class="hl-value">"username"</span>&gt;Username&lt;/label&gt;
		&lt;input <span class="hl-attribute">type</span>=<span class="hl-value">"text"</span> <span class="hl-attribute">id</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span>/&gt;	<a name="CO2-4" href="index.html#CO2-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
	&lt;/p&gt;
	&lt;p&gt;
		&lt;label <span class="hl-attribute">for</span>=<span class="hl-value">"password"</span>&gt;Password&lt;/label&gt;
		&lt;input <span class="hl-attribute">type</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">id</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span>/&gt;	<a name="CO2-5" href="index.html#CO2-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
	&lt;/p&gt;
	&lt;input <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span>                        <a name="CO2-6" href="index.html#CO2-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
		name="${_csrf.parameterName}"
		value="${_csrf.token}"/&gt;
	&lt;button <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"btn"</span>&gt;Log in&lt;/button&gt;
&lt;/form&gt;</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO2-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A POST to the <code class="literal">/login</code> URL will attempt to authenticate the user</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO2-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>If the query parameter <code class="literal">error</code> exists, authentication was attempted and failed</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO2-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>If the query parameter <code class="literal">logout</code> exists, the user was successfully logged out</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO2-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The username must be present as the HTTP parameter named <span class="emphasis"><em>username</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO2-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The password must be present as the HTTP parameter named <span class="emphasis"><em>password</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO2-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>We must <a class="xref" href="index.html#csrf-include-csrf-token" title="19.4.3&nbsp;Include the CSRF Token">Section&nbsp;19.4.3, &#8220;Include the CSRF Token&#8221;</a> To learn more read the <a class="xref" href="index.html#csrf" title="19.&nbsp;Cross Site Request Forgery (CSRF)">Chapter&nbsp;19, <i>Cross Site Request Forgery (CSRF)</i></a> section of the reference</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jc-authorize-requests" href="index.html#jc-authorize-requests"></a>5.4&nbsp;Authorize Requests</h2></div></div></div>
<p>Our examples have only required users to be authenticated and have done so for every URL in our application. We can specify custom requirements for our URLs by adding multiple children to our <code class="literal">http.authorizeRequests()</code> method. For example:</p>
<pre class="programlisting"><span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
		.authorizeRequests()                                                                <a name="CO3-1" href="index.html#CO3-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
			.antMatchers(<span class="hl-string">"/resources/**"</span>, <span class="hl-string">"/signup"</span>, <span class="hl-string">"/about"</span>).permitAll()                  <a name="CO3-2" href="index.html#CO3-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
			.antMatchers(<span class="hl-string">"/admin/**"</span>).hasRole(<span class="hl-string">"ADMIN"</span>)                                      <a name="CO3-3" href="index.html#CO3-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
			.antMatchers(<span class="hl-string">"/db/**"</span>).access(<span class="hl-string">"hasRole('ADMIN') and hasRole('DBA')"</span>)            <a name="CO3-4" href="index.html#CO3-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
			.anyRequest().authenticated()                                                   <a name="CO3-5" href="index.html#CO3-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
			.and()
		<span class="hl-comment">// ...</span>
		.formLogin();
}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO3-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>There are multiple children to the <code class="literal">http.authorizeRequests()</code> method each matcher is considered in the order they were declared.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO3-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>We specified multiple URL patterns that any user can access. Specifically, any user can access a request if the URL starts with "/resources/", equals "/signup", or equals "/about".</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO3-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Any URL that starts with "/admin/" will be restricted to users who have the role "ROLE_ADMIN". You will notice that since we are invoking the <code class="literal">hasRole</code> method we do not need to specify the "ROLE_" prefix.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO3-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Any URL that starts with "/db/" requires the user to have both "ROLE_ADMIN" and "ROLE_DBA". You will notice that since we are using the <code class="literal">hasRole</code> expression we do not need to specify the "ROLE_" prefix.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO3-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Any URL that has not already been matched on only requires that the user be authenticated</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jc-logout" href="index.html#jc-logout"></a>5.5&nbsp;Handling Logouts</h2></div></div></div>
<p>When using the <code class="literal"><a class="ulink" href="https://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/config/annotation/web/configuration/WebSecurityConfigurerAdapter.html" target="_top">WebSecurityConfigurerAdapter</a></code>, logout capabilities are automatically applied. The default is that accessing the URL <code class="literal">/logout</code> will log the user out by:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Invalidating the HTTP Session
</li><li class="listitem">
Cleaning up any RememberMe authentication that was configured
</li><li class="listitem">
Clearing the <code class="literal">SecurityContextHolder</code>
</li><li class="listitem">
Redirect to <code class="literal">/login?logout</code>
</li></ul></div>
<p>Similar to configuring login capabilities, however, you also have various options to further customize your logout requirements:</p>
<pre class="programlisting"><span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
		.logout()                                                                <a name="CO4-1" href="index.html#CO4-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
			.logoutUrl(<span class="hl-string">"/my/logout"</span>)                                                 <a name="CO4-2" href="index.html#CO4-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
			.logoutSuccessUrl(<span class="hl-string">"/my/index"</span>)                                           <a name="CO4-3" href="index.html#CO4-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
			.logoutSuccessHandler(logoutSuccessHandler)                              <a name="CO4-4" href="index.html#CO4-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
			.invalidateHttpSession(true)                                             <a name="CO4-5" href="index.html#CO4-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
			.addLogoutHandler(logoutHandler)                                         <a name="CO4-6" href="index.html#CO4-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
			.deleteCookies(cookieNamesToClear)                                       <a name="CO4-7" href="index.html#CO4-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
			.and()
		...
}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO4-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Provides logout support. This is automatically applied when using <code class="literal">WebSecurityConfigurerAdapter</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO4-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The URL that triggers log out to occur (default is <code class="literal">/logout</code>). If CSRF protection is enabled (default), then the request must also be a POST. For more information, please consult the <a class="ulink" href="https://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/config/annotation/web/configurers/LogoutConfigurer.html#logoutUrl-java.lang.String-" target="_top">JavaDoc</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO4-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The URL to redirect to after logout has occurred. The default is <code class="literal">/login?logout</code>. For more information, please consult the <a class="ulink" href="https://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/config/annotation/web/configurers/LogoutConfigurer.html#logoutSuccessUrl-java.lang.String-" target="_top">JavaDoc</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO4-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Let&#8217;s you specify a custom <code class="literal">LogoutSuccessHandler</code>. If this is specified, <code class="literal">logoutSuccessUrl()</code> is ignored. For more information, please consult the <a class="ulink" href="https://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/config/annotation/web/configurers/LogoutConfigurer.html#logoutSuccessHandler-org.springframework.security.web.authentication.logout.LogoutSuccessHandler-" target="_top">JavaDoc</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO4-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify whether to invalidate the <code class="literal">HttpSession</code> at the time of logout. This is <span class="strong"><strong>true</strong></span> by default. Configures the <code class="literal">SecurityContextLogoutHandler</code> under the covers. For more information, please consult the <a class="ulink" href="https://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/config/annotation/web/configurers/LogoutConfigurer.html#invalidateHttpSession-boolean-" target="_top">JavaDoc</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO4-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Adds a <code class="literal">LogoutHandler</code>. <code class="literal">SecurityContextLogoutHandler</code> is added as the last <code class="literal">LogoutHandler</code> by default.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO4-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Allows specifying the names of cookies to be removed on logout success. This is a shortcut for adding a <code class="literal">CookieClearingLogoutHandler</code> explicitly.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Logouts can of course also be configured using the XML Namespace notation. Please see the documentation for the <a class="link" href="index.html#nsa-logout" title="43.1.26&nbsp;<logout&gt;">logout element</a> in the Spring Security XML Namespace section for further details.</p>
</td></tr></table></div>
<p>Generally, in order to customize logout functionality, you can add
<code class="literal"><a class="ulink" href="https://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/web/authentication/logout/LogoutHandler.html" target="_top">LogoutHandler</a></code>
and/or
<code class="literal"><a class="ulink" href="https://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/web/authentication/logout/LogoutSuccessHandler.html" target="_top">LogoutSuccessHandler</a></code>
implementations. For many common scenarios, these handlers are applied under the
covers when using the fluent API.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-logout-handler" href="index.html#jc-logout-handler"></a>5.5.1&nbsp;LogoutHandler</h3></div></div></div>
<p>Generally, <code class="literal"><a class="ulink" href="https://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/web/authentication/logout/LogoutHandler.html" target="_top">LogoutHandler</a></code>
implementations indicate classes that are able to participate in logout handling.
They are expected to be invoked to perform necessary clean-up. As such they should
not throw exceptions. Various implementations are provided:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/web/authentication/rememberme/PersistentTokenBasedRememberMeServices.html" target="_top">PersistentTokenBasedRememberMeServices</a>
</li><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/web/authentication/rememberme/TokenBasedRememberMeServices.html" target="_top">TokenBasedRememberMeServices</a>
</li><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/web/authentication/logout/CookieClearingLogoutHandler.html" target="_top">CookieClearingLogoutHandler</a>
</li><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/web/csrf/CsrfLogoutHandler.html" target="_top">CsrfLogoutHandler</a>
</li><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/web/authentication/logout/SecurityContextLogoutHandler.html" target="_top">SecurityContextLogoutHandler</a>
</li></ul></div>
<p>Please see <a class="xref" href="index.html#remember-me-impls" title="18.4&nbsp;Remember-Me Interfaces and Implementations">Section&nbsp;18.4, &#8220;Remember-Me Interfaces and Implementations&#8221;</a> for details.</p>
<p>Instead of providing <code class="literal">LogoutHandler</code> implementations directly, the fluent API
also provides shortcuts that provide the respective <code class="literal">LogoutHandler</code> implementations
under the covers. E.g. <code class="literal">deleteCookies()</code> allows specifying the names of one or
more cookies to be removed on logout success. This is a shortcut compared to adding a
<code class="literal">CookieClearingLogoutHandler</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-logout-success-handler" href="index.html#jc-logout-success-handler"></a>5.5.2&nbsp;LogoutSuccessHandler</h3></div></div></div>
<p>The <code class="literal">LogoutSuccessHandler</code> is called after a successful logout by the <code class="literal">LogoutFilter</code>,
to handle e.g. redirection or forwarding to the appropriate destination. Note that the
interface is almost the same as the <code class="literal">LogoutHandler</code> but may raise an exception.</p>
<p>The following implementations are provided:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/web/authentication/logout/SimpleUrlLogoutSuccessHandler.html" target="_top">SimpleUrlLogoutSuccessHandler</a>
</li><li class="listitem">
HttpStatusReturningLogoutSuccessHandler
</li></ul></div>
<p>As mentioned above, you don&#8217;t need to specify the <code class="literal">SimpleUrlLogoutSuccessHandler</code> directly.
Instead, the fluent API provides a shortcut by setting the <code class="literal">logoutSuccessUrl()</code>.
This will setup the <code class="literal">SimpleUrlLogoutSuccessHandler</code> under the covers. The provided URL will
be redirected to after a logout has occurred. The default is <code class="literal">/login?logout</code>.</p>
<p>The <code class="literal">HttpStatusReturningLogoutSuccessHandler</code> can be interesting in REST API type
scenarios. Instead of redirecting to a URL upon the successful logout, this <code class="literal">LogoutSuccessHandler</code>
allows you to provide a plain HTTP status code to be returned. If not configured
a status code 200 will be returned by default.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-logout-references" href="index.html#jc-logout-references"></a>5.5.3&nbsp;Further Logout-Related References</h3></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#ns-logout" title="6.2.4&nbsp;Logout Handling">Logout Handling</a>
</li><li class="listitem">
<a class="link" href="index.html#test-logout" title="12.3.2&nbsp;Testing Logout">Testing Logout</a>
</li><li class="listitem">
<a class="link" href="index.html#servletapi-logout" title="16.2.3&nbsp;HttpServletRequest.logout()">HttpServletRequest.logout()</a>
</li><li class="listitem">
<a class="xref" href="index.html#remember-me-impls" title="18.4&nbsp;Remember-Me Interfaces and Implementations">Section&nbsp;18.4, &#8220;Remember-Me Interfaces and Implementations&#8221;</a>
</li><li class="listitem">
<a class="link" href="index.html#csrf-logout" title="19.5.3&nbsp;Logging Out">Logging Out</a> in section CSRF Caveats
</li><li class="listitem">
Section <a class="link" href="index.html#cas-singlelogout" title="34.3.2&nbsp;Single Logout">Single Logout</a> (CAS protocol)
</li><li class="listitem">
Documentation for the <a class="link" href="index.html#nsa-logout" title="43.1.26&nbsp;<logout&gt;">logout element</a> in the Spring Security XML Namespace section
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jc-webflux" href="index.html#jc-webflux"></a>5.6&nbsp;WebFlux Security</h2></div></div></div>
<p>Spring Security&#8217;s WebFlux support relies on a <code class="literal">WebFilter</code> and works the same for Spring WebFlux
and Spring WebFlux.Fn. You can find a few sample applications that demonstrate the code below:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Hello WebFlux <a class="ulink" href="https://github.com/spring-projects/spring-security/tree/5.0.0.RELEASE/samples/javaconfig/hellowebflux" target="_top">hellowebflux</a>
</li><li class="listitem">
Hello WebFlux.Fn <a class="ulink" href="https://github.com/spring-projects/spring-security/tree/5.0.0.RELEASE/samples/javaconfig/hellowebfluxfn" target="_top">hellowebfluxfn</a>
</li><li class="listitem">
Hello WebFlux Method <a class="ulink" href="https://github.com/spring-projects/spring-security/tree/5.0.0.RELEASE/samples/javaconfig/hellowebflux-method" target="_top">hellowebflux-method</a>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="minimal-webflux-security-configuration" href="index.html#minimal-webflux-security-configuration"></a>5.6.1&nbsp;Minimal WebFlux Security Configuration</h3></div></div></div>
<p>You can find a minimal WebFlux Security configuration below:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebFluxSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> HelloWebfluxSecurityConfig {

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<span class="hl-keyword">public</span> MapReactiveUserDetailsService userDetailsRepository() {
		UserDetails user = User.withDefaultPasswordEncoder()
			.username(<span class="hl-string">"user"</span>)
			.password(<span class="hl-string">"user"</span>)
			.roles(<span class="hl-string">"USER"</span>)
			.build();
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MapReactiveUserDetailsService(user);
	}
}</pre>
<p>This configuration provides form and http basic authentication, sets up authorization to
require an authenticated user for accessing any page, sets up a default log in page and
a default log out page, sets up security related HTTP headers, CSRF protection, and more.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="explicit-webflux-security-configuration" href="index.html#explicit-webflux-security-configuration"></a>5.6.2&nbsp;Explicit WebFlux Security Configuration</h3></div></div></div>
<p>You can find an explicit version of the minimal WebFlux Security configuration below:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebFluxSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> HelloWebfluxSecurityConfig {

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<span class="hl-keyword">public</span> MapReactiveUserDetailsService userDetailsRepository() {
		UserDetails user = User.withDefaultPasswordEncoder()
			.username(<span class="hl-string">"user"</span>)
			.password(<span class="hl-string">"user"</span>)
			.roles(<span class="hl-string">"USER"</span>)
			.build();
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MapReactiveUserDetailsService(user);
	}

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<span class="hl-keyword">public</span> SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
		http
			.authorizeExchange()
				.anyExchange().authenticated()
				.and()
			.httpBasic().and()
			.formLogin();
		<span class="hl-keyword">return</span> http.build();
	}
}</pre>
<p>This configuration explicitly sets up all the sames things as our minimal configuration.
From here you can easily make the changes to the defaults.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jc-oauth2login" href="index.html#jc-oauth2login"></a>5.7&nbsp;OAuth 2.0 Login</h2></div></div></div>
<p>The OAuth 2.0 Login feature provides an application with the capability to have users log in to the application
by using their existing account at an OAuth 2.0 Provider (e.g. GitHub) or OpenID Connect 1.0 Provider (such as Google).
OAuth 2.0 Login implements the use cases: "Login with Google" or "Login with GitHub".</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>OAuth 2.0 Login is implemented by using the <span class="strong"><strong>Authorization Code Grant</strong></span>, as specified in the <a class="ulink" href="https://tools.ietf.org/html/rfc6749#section-4.1" target="_top">OAuth 2.0 Authorization Framework</a>
and <a class="ulink" href="https://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth" target="_top">OpenID Connect Core 1.0</a>.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-oauth2login-sample-boot" href="index.html#jc-oauth2login-sample-boot"></a>5.7.1&nbsp;Spring Boot 2.0 Sample</h3></div></div></div>
<p>Spring Boot 2.0 brings full auto-configuration capabilities for OAuth 2.0 Login.</p>
<p>This section shows how to configure the <a class="ulink" href="https://github.com/spring-projects/spring-security/tree/5.0.0.RELEASE/samples/boot/oauth2login" target="_top"><span class="strong"><strong>OAuth 2.0 Login sample</strong></span></a> using <span class="emphasis"><em>Google</em></span> as the <span class="emphasis"><em>Authentication Provider</em></span> and covers the following topics:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#jc-oauth2login-sample-initial-setup" title="Initial setup">Initial setup</a>
</li><li class="listitem">
<a class="link" href="index.html#jc-oauth2login-sample-redirect-uri" title="Setting the redirect URI">Setting the redirect URI</a>
</li><li class="listitem">
<a class="link" href="index.html#jc-oauth2login-sample-application-config" title="Configure application.yml">Configure <code class="literal">application.yml</code></a>
</li><li class="listitem">
<a class="link" href="index.html#jc-oauth2login-sample-boot-application" title="Boot up the application">Boot up the application</a>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jc-oauth2login-sample-initial-setup" href="index.html#jc-oauth2login-sample-initial-setup"></a>Initial setup</h4></div></div></div>
<p>To use Google&#8217;s OAuth 2.0 authentication system for login, you must set up a project in the Google API Console to obtain OAuth 2.0 credentials.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><a class="ulink" href="https://developers.google.com/identity/protocols/OpenIDConnect" target="_top">Google&#8217;s OAuth 2.0 implementation</a> for authentication conforms to the
<a class="ulink" href="https://openid.net/connect/" target="_top">OpenID Connect 1.0</a> specification and is <a class="ulink" href="https://openid.net/certification/" target="_top">OpenID Certified</a>.</p>
</td></tr></table></div>
<p>Follow the instructions on the <a class="ulink" href="https://developers.google.com/identity/protocols/OpenIDConnect" target="_top">OpenID Connect</a> page, starting in the section, "Setting up OAuth 2.0".</p>
<p>After completing the "Obtain OAuth 2.0 credentials" instructions, you should have a new OAuth Client with credentials consisting of a Client ID and a Client Secret.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jc-oauth2login-sample-redirect-uri" href="index.html#jc-oauth2login-sample-redirect-uri"></a>Setting the redirect URI</h4></div></div></div>
<p>The redirect URI is the path in the application that the end-user&#8217;s user-agent is redirected back to after they have authenticated with Google
and have granted access to the OAuth Client <span class="emphasis"><em>(<a class="link" href="index.html#jc-oauth2login-sample-initial-setup" title="Initial setup">created in the previous step</a>)</em></span> on the Consent page.</p>
<p>In the "Set a redirect URI" sub-section, ensure that the <span class="strong"><strong>Authorized redirect URIs</strong></span> field is set to <code class="literal"><a class="ulink" href="http://localhost:8080/login/oauth2/code/google" target="_top">http://localhost:8080/login/oauth2/code/google</a></code>.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The default redirect URI template is <code class="literal">{baseUrl}/login/oauth2/code/{registrationId}</code>.
The <span class="strong"><strong><span class="emphasis"><em>registrationId</em></span></strong></span> is a unique identifier for the <a class="link" href="index.html#jc-oauth2login-client-registration" title="5.7.2&nbsp;ClientRegistration">ClientRegistration</a>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jc-oauth2login-sample-application-config" href="index.html#jc-oauth2login-sample-application-config"></a>Configure <code class="literal">application.yml</code></h4></div></div></div>
<p>Now that you have a new OAuth Client with Google, you need to configure the application to use the OAuth Client for the <span class="emphasis"><em>authentication flow</em></span>. To do so:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<p class="simpara">Go to <code class="literal">application.yml</code> and set the following configuration:</p>
<pre class="programlisting"><span class="hl-attribute">spring</span>:
<span class="hl-attribute">  security</span>:
<span class="hl-attribute">    oauth2</span>:
<span class="hl-attribute">      client</span>:
<span class="hl-attribute">        registration</span>:	<a name="CO5-1" href="index.html#CO5-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
<span class="hl-attribute">          google</span>:	<a name="CO5-2" href="index.html#CO5-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
<span class="hl-attribute">            client-id</span>: google-client-id
<span class="hl-attribute">            client-secret</span>: google-client-secret</pre>
<div class="example"><a name="d5e847" href="index.html#d5e847"></a><p class="title"><b>Example&nbsp;5.1.&nbsp;OAuth Client properties</b></p><div class="example-contents">
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO5-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p><code class="literal">spring.security.oauth2.client.registration</code> is the base property prefix for OAuth Client properties.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO5-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Following the base property prefix is the ID for the <a class="link" href="index.html#jc-oauth2login-client-registration" title="5.7.2&nbsp;ClientRegistration">ClientRegistration</a>, such as google.</p>
</td></tr></table></div>
</div></div><br class="example-break">
</li><li class="listitem">
Replace the values in the <code class="literal">client-id</code> and <code class="literal">client-secret</code> property with the OAuth 2.0 credentials you created earlier.
</li></ol></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jc-oauth2login-sample-boot-application" href="index.html#jc-oauth2login-sample-boot-application"></a>Boot up the application</h4></div></div></div>
<p>Launch the Spring Boot 2.0 sample and go to <code class="literal"><a class="ulink" href="http://localhost:8080" target="_top">http://localhost:8080</a></code>.
You are then redirected to the default <span class="emphasis"><em>auto-generated</em></span> login page, which displays a link for Google.</p>
<p>Click on the Google link, and you are then redirected to Google for authentication.</p>
<p>After authenticating with your Google account credentials, the next page presented to you is the Consent screen.
The Consent screen asks you to either allow or deny access to the OAuth Client you created earlier.
Click <span class="strong"><strong>Allow</strong></span> to authorize the OAuth Client to access your email address and basic profile information.</p>
<p>At this point, the OAuth Client retrieves your email address and basic profile information
from the <a class="ulink" href="https://openid.net/specs/openid-connect-core-1_0.html#UserInfo" target="_top">UserInfo Endpoint</a> and establishes an authenticated session.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-oauth2login-client-registration" href="index.html#jc-oauth2login-client-registration"></a>5.7.2&nbsp;ClientRegistration</h3></div></div></div>
<p><code class="literal">ClientRegistration</code> is a representation of a client registered with an OAuth 2.0 or OpenID Connect 1.0 Provider.</p>
<p>A client registration holds information, such as client id, client secret,
authorization grant type, redirect URI, scope(s), authorization URI, token URI, and other details.</p>
<p><code class="literal">ClientRegistration</code> and its properties are defined as follows:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> ClientRegistration {
	<span class="hl-keyword">private</span> String registrationId;	<a name="CO6-1" href="index.html#CO6-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
	<span class="hl-keyword">private</span> String clientId;	<a name="CO6-2" href="index.html#CO6-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
	<span class="hl-keyword">private</span> String clientSecret;	<a name="CO6-3" href="index.html#CO6-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
	<span class="hl-keyword">private</span> ClientAuthenticationMethod clientAuthenticationMethod;	<a name="CO6-4" href="index.html#CO6-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
	<span class="hl-keyword">private</span> AuthorizationGrantType authorizationGrantType;	<a name="CO6-5" href="index.html#CO6-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
	<span class="hl-keyword">private</span> String redirectUriTemplate;	<a name="CO6-6" href="index.html#CO6-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
	<span class="hl-keyword">private</span> Set&lt;String&gt; scopes;	<a name="CO6-7" href="index.html#CO6-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
	<span class="hl-keyword">private</span> ProviderDetails providerDetails;
	<span class="hl-keyword">private</span> String clientName;	<a name="CO6-8" href="index.html#CO6-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>

	<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProviderDetails {
		<span class="hl-keyword">private</span> String authorizationUri;	<a name="CO6-9" href="index.html#CO6-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
		<span class="hl-keyword">private</span> String tokenUri;	<a name="CO6-10" href="index.html#CO6-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
		<span class="hl-keyword">private</span> UserInfoEndpoint userInfoEndpoint;
		<span class="hl-keyword">private</span> String jwkSetUri;	<a name="CO6-11" href="index.html#CO6-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>

		<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> UserInfoEndpoint {
			<span class="hl-keyword">private</span> String uri;	<a name="CO6-12" href="index.html#CO6-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
			<span class="hl-keyword">private</span> String userNameAttributeName;	<a name="CO6-13" href="index.html#CO6-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>

		}
	}
}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO6-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p><code class="literal">registrationId</code>: The ID that uniquely identifies the <code class="literal">ClientRegistration</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO6-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p><code class="literal">clientId</code>: The client identifier.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO6-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p><code class="literal">clientSecret</code>: The client secret.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO6-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p><code class="literal">clientAuthenticationMethod</code>: The method used to authenticate the Client with the Provider. The supported values are <span class="strong"><strong>basic</strong></span> and <span class="strong"><strong>post</strong></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO6-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p><code class="literal">authorizationGrantType</code>: The OAuth 2.0 Authorization Framework defines four <a class="ulink" href="https://tools.ietf.org/html/rfc6749#section-1.3" target="_top">Authorization Grant</a> types.
The supported values are authorization_code and implicit.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO6-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p><code class="literal">redirectUriTemplate</code>: The client&#8217;s registered redirect URI that the <span class="emphasis"><em>Authorization Server</em></span> redirects the end-user&#8217;s user-agent
to after the end-user has authenticated and authorized access to the client.
The default redirect URI template is <code class="literal">{baseUrl}/login/oauth2/code/{registrationId}</code>, which supports URI template variables.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO6-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p><code class="literal">scopes</code>: The scope(s) requested by the client during the Authorization Request flow, such as openid, email, or profile.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO6-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p><code class="literal">clientName</code>: A descriptive name used for the client. The name may be used in certain scenarios, such as when displaying the name of the client in the auto-generated login page.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO6-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p><code class="literal">authorizationUri</code>: The Authorization Endpoint URI for the Authorization Server.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO6-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p><code class="literal">tokenUri</code>: The Token Endpoint URI for the Authorization Server.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO6-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p><code class="literal">jwkSetUri</code>: The URI used to retrieve the <a class="ulink" href="https://tools.ietf.org/html/rfc7517" target="_top">JSON Web Key (JWK)</a> Set from the Authorization Server,
which contains the cryptographic key(s) used to verify the <a class="ulink" href="https://tools.ietf.org/html/rfc7515" target="_top">JSON Web Signature (JWS)</a> of the ID Token and optionally the UserInfo Response.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO6-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p><code class="literal">(userInfoEndpoint)uri</code>: The UserInfo Endpoint URI used to access the claims/attributes of the authenticated end-user.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO6-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p><code class="literal">userNameAttributeName</code>: The name of the attribute returned in the UserInfo Response that references the Name or Identifier of the end-user.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-oauth2login-boot-property-mappings" href="index.html#jc-oauth2login-boot-property-mappings"></a>5.7.3&nbsp;Spring Boot 2.0 Property Mappings</h3></div></div></div>
<p>The following table outlines the mapping of the Spring Boot 2.0 OAuth Client properties to the <code class="literal">ClientRegistration</code> properties.</p>
<div class="informaltable">
<table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Spring Boot 2.0</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">ClientRegistration</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.security.oauth2.client.registration.<span class="emphasis"><em>[registrationId]</em></span></code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">registrationId</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.security.oauth2.client.registration.<span class="emphasis"><em>[registrationId]</em></span>.client-id</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">clientId</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.security.oauth2.client.registration.<span class="emphasis"><em>[registrationId]</em></span>.client-secret</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">clientSecret</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.security.oauth2.client.registration.<span class="emphasis"><em>[registrationId]</em></span>.client-authentication-method</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">clientAuthenticationMethod</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.security.oauth2.client.registration.<span class="emphasis"><em>[registrationId]</em></span>.authorization-grant-type</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">authorizationGrantType</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.security.oauth2.client.registration.<span class="emphasis"><em>[registrationId]</em></span>.redirect-uri-template</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">redirectUriTemplate</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.security.oauth2.client.registration.<span class="emphasis"><em>[registrationId]</em></span>.scope</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">scopes</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.security.oauth2.client.registration.<span class="emphasis"><em>[registrationId]</em></span>.client-name</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">clientName</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.security.oauth2.client.provider.<span class="emphasis"><em>[providerId]</em></span>.authorization-uri</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">providerDetails.authorizationUri</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.security.oauth2.client.provider.<span class="emphasis"><em>[providerId]</em></span>.token-uri</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">providerDetails.tokenUri</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.security.oauth2.client.provider.<span class="emphasis"><em>[providerId]</em></span>.jwk-set-uri</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">providerDetails.jwkSetUri</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.security.oauth2.client.provider.<span class="emphasis"><em>[providerId]</em></span>.user-info-uri</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">providerDetails.userInfoEndpoint.uri</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">spring.security.oauth2.client.provider.<span class="emphasis"><em>[providerId]</em></span>.userNameAttribute</code></p></td><td style="" align="left" valign="top"><p><code class="literal">providerDetails.userInfoEndpoint.userNameAttributeName</code></p></td></tr></tbody></table>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-oauth2login-client-registration-repo" href="index.html#jc-oauth2login-client-registration-repo"></a>5.7.4&nbsp;ClientRegistrationRepository</h3></div></div></div>
<p>The <code class="literal">ClientRegistrationRepository</code> serves as a repository for OAuth 2.0 / OpenID Connect 1.0 <code class="literal">ClientRegistration</code>(s).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Client registration information is ultimately stored and owned by the associated Authorization Server.
This repository provides the ability to retrieve a sub-set of the primary client registration information,
which is stored with the Authorization Server.</p>
</td></tr></table></div>
<p>Spring Boot 2.0 auto-configuration binds each of the properties under <code class="literal">spring.security.oauth2.client.registration.<span class="emphasis"><em>[registrationId]</em></span></code>
to an instance of <code class="literal">ClientRegistration</code> and then composes each of the <code class="literal">ClientRegistration</code> instance(s) within a <code class="literal">ClientRegistrationRepository</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The default implementation of <code class="literal">ClientRegistrationRepository</code> is <code class="literal">InMemoryClientRegistrationRepository</code>.</p>
</td></tr></table></div>
<p>The auto-configuration also registers the <code class="literal">ClientRegistrationRepository</code> as a <code class="literal">@Bean</code> in the <code class="literal">ApplicationContext</code>
so that it is available for dependency-injection, if needed by the application.</p>
<p>The following listing shows an example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Controller</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MainController {

	<em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
	<span class="hl-keyword">private</span> ClientRegistrationRepository clientRegistrationRepository;

	<em><span class="hl-annotation" style="color: gray">@RequestMapping("/")</span></em>
	<span class="hl-keyword">public</span> String index() {
		ClientRegistration googleRegistration =
			<span class="hl-keyword">this</span>.clientRegistrationRepository.findByRegistrationId(<span class="hl-string">"google"</span>);

		...

		<span class="hl-keyword">return</span> <span class="hl-string">"index"</span>;
	}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-oauth2login-common-oauth2-provider" href="index.html#jc-oauth2login-common-oauth2-provider"></a>5.7.5&nbsp;CommonOAuth2Provider</h3></div></div></div>
<p><code class="literal">CommonOAuth2Provider</code> pre-defines a set of default client properties for a number of well known providers: Google, GitHub, Facebook, and Okta.</p>
<p>For example, the <code class="literal">authorization-uri</code>, <code class="literal">token-uri</code>, and <code class="literal">user-info-uri</code> do not change often for a Provider. Therefore, it makes sense to
provide default values in order to reduce the required configuration.</p>
<p>As demonstrated previously, when we <a class="link" href="index.html#jc-oauth2login-sample-application-config" title="Configure application.yml">configured a Google client</a>, only the <code class="literal">client-id</code> and <code class="literal">client-secret</code> properties are required.</p>
<p>The following listing shows an example:</p>
<pre class="programlisting"><span class="hl-attribute">spring</span>:
<span class="hl-attribute">  security</span>:
<span class="hl-attribute">    oauth2</span>:
<span class="hl-attribute">      client</span>:
<span class="hl-attribute">        registration</span>:
<span class="hl-attribute">          google</span>:
<span class="hl-attribute">            client-id</span>: google-client-id
<span class="hl-attribute">            client-secret</span>: google-client-secret</pre>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The auto-defaulting of client properties works seamlessly here because the <code class="literal">registrationId</code> (<code class="literal">google</code>) matches the <code class="literal">GOOGLE</code> <code class="literal">enum</code> (case-insensitive) in <code class="literal">CommonOAuth2Provider</code>.</p>
</td></tr></table></div>
<p>For cases where you may want to specify a different <code class="literal">registrationId</code>, such as <code class="literal">google-login</code>,
you can still leverage auto-defaulting of client properties by configuring the <code class="literal">provider</code> property.</p>
<p>The following listing shows an example:</p>
<pre class="programlisting"><span class="hl-attribute">spring</span>:
<span class="hl-attribute">  security</span>:
<span class="hl-attribute">    oauth2</span>:
<span class="hl-attribute">      client</span>:
<span class="hl-attribute">        registration</span>:
<span class="hl-attribute">          google-login</span>:	<a name="CO7-1" href="index.html#CO7-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
<span class="hl-attribute">            provider</span>: google	<a name="CO7-2" href="index.html#CO7-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
<span class="hl-attribute">            client-id</span>: google-client-id
<span class="hl-attribute">            client-secret</span>: google-client-secret</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO7-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">registrationId</code> is set to <code class="literal">google-login</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO7-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">provider</code> property is set to <code class="literal">google</code>, which will leverage the auto-defaulting of client properties set in <code class="literal">CommonOAuth2Provider.GOOGLE.getBuilder()</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-oauth2login-custom-provider-properties" href="index.html#jc-oauth2login-custom-provider-properties"></a>5.7.6&nbsp;Configuring Custom Provider Properties</h3></div></div></div>
<p>There are some OAuth 2.0 Providers that support multi-tenancy, which results in different protocol endpoints for each tenant (or sub-domain).</p>
<p>For example, an OAuth Client registered with Okta is assigned to a specific sub-domain and have their own protocol endpoints.</p>
<p>For these cases, Spring Boot 2.0 provides the following base property for configuring custom provider properties: <code class="literal">spring.security.oauth2.client.provider.<span class="emphasis"><em>[providerId]</em></span></code>.</p>
<p>The following listing shows an example:</p>
<pre class="programlisting"><span class="hl-attribute">spring</span>:
<span class="hl-attribute">  security</span>:
<span class="hl-attribute">    oauth2</span>:
<span class="hl-attribute">      client</span>:
<span class="hl-attribute">        registration</span>:
<span class="hl-attribute">          okta</span>:
<span class="hl-attribute">            client-id</span>: okta-client-id
<span class="hl-attribute">            client-secret</span>: okta-client-secret
<span class="hl-attribute">        provider</span>:
<span class="hl-attribute">          okta</span>:	<a name="CO8-1" href="index.html#CO8-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
<span class="hl-attribute">            authorization-uri</span>: https://your-subdomain.oktapreview.com/oauth2/v1/authorize
<span class="hl-attribute">            token-uri</span>: https://your-subdomain.oktapreview.com/oauth2/v1/token
<span class="hl-attribute">            user-info-uri</span>: https://your-subdomain.oktapreview.com/oauth2/v1/userinfo
<span class="hl-attribute">            user-name-attribute</span>: sub
<span class="hl-attribute">            jwk-set-uri</span>: https://your-subdomain.oktapreview.com/oauth2/v1/keys</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO8-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The base property (<code class="literal">spring.security.oauth2.client.provider.okta</code>) allows for custom configuration of protocol endpoint locations.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-oauth2login-override-boot-autoconfig" href="index.html#jc-oauth2login-override-boot-autoconfig"></a>5.7.7&nbsp;Overriding Spring Boot 2.0 Auto-configuration</h3></div></div></div>
<p>The Spring Boot 2.0 Auto-configuration class for OAuth Client support is <code class="literal">OAuth2ClientAutoConfiguration</code>.</p>
<p>It performs the following tasks:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Registers a <code class="literal">ClientRegistrationRepository</code> <code class="literal">@Bean</code> composed of <code class="literal">ClientRegistration</code>(s) from the configured OAuth Client properties.
</li><li class="listitem">
Provides a <code class="literal">WebSecurityConfigurerAdapter</code> <code class="literal">@Configuration</code> and enables OAuth 2.0 Login through <code class="literal">httpSecurity.oauth2Login()</code>.
</li></ul></div>
<p>If you need to override the auto-configuration based on your specific requirements, you may do so in the following ways:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#jc-oauth2login-register-clientregistrationrepository-bean" title="Register a ClientRegistrationRepository @Bean">Register a <code class="literal">ClientRegistrationRepository</code> <code class="literal">@Bean</code></a>
</li><li class="listitem">
<a class="link" href="index.html#jc-oauth2login-provide-websecurityconfigureradapter" title="Provide a WebSecurityConfigurerAdapter">Provide a <code class="literal">WebSecurityConfigurerAdapter</code></a>
</li><li class="listitem">
<a class="link" href="index.html#jc-oauth2login-completely-override-autoconfiguration" title="Completely Override the Auto-configuration">Completely Override the Auto-configuration</a>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jc-oauth2login-register-clientregistrationrepository-bean" href="index.html#jc-oauth2login-register-clientregistrationrepository-bean"></a>Register a <code class="literal">ClientRegistrationRepository</code> <code class="literal">@Bean</code></h4></div></div></div>
<p>The following example shows how to register a <code class="literal">ClientRegistrationRepository</code> <code class="literal">@Bean</code>:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OAuth2LoginConfig {

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<span class="hl-keyword">public</span> ClientRegistrationRepository clientRegistrationRepository() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> InMemoryClientRegistrationRepository(<span class="hl-keyword">this</span>.googleClientRegistration());
	}

	<span class="hl-keyword">private</span> ClientRegistration googleClientRegistration() {
		<span class="hl-keyword">return</span> ClientRegistration.withRegistrationId(<span class="hl-string">"google"</span>)
			.clientId(<span class="hl-string">"google-client-id"</span>)
			.clientSecret(<span class="hl-string">"google-client-secret"</span>)
			.clientAuthenticationMethod(ClientAuthenticationMethod.BASIC)
			.authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)
			.redirectUriTemplate(<span class="hl-string">"{baseUrl}/login/oauth2/code/{registrationId}"</span>)
			.scope(<span class="hl-string">"openid"</span>, <span class="hl-string">"profile"</span>, <span class="hl-string">"email"</span>, <span class="hl-string">"address"</span>, <span class="hl-string">"phone"</span>)
			.authorizationUri(<span class="hl-string">"https://accounts.google.com/o/oauth2/v2/auth"</span>)
			.tokenUri(<span class="hl-string">"https://www.googleapis.com/oauth2/v4/token"</span>)
			.userInfoUri(<span class="hl-string">"https://www.googleapis.com/oauth2/v3/userinfo"</span>)
			.userNameAttributeName(IdTokenClaimNames.SUB)
			.jwkSetUri(<span class="hl-string">"https://www.googleapis.com/oauth2/v3/certs"</span>)
			.clientName(<span class="hl-string">"Google"</span>)
			.build();
	}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jc-oauth2login-provide-websecurityconfigureradapter" href="index.html#jc-oauth2login-provide-websecurityconfigureradapter"></a>Provide a <code class="literal">WebSecurityConfigurerAdapter</code></h4></div></div></div>
<p>The following example shows how to provide a <code class="literal">WebSecurityConfigurerAdapter</code> with <code class="literal">@EnableWebSecurity</code> and enable OAuth 2.0 login through <code class="literal">httpSecurity.oauth2Login()</code>:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OAuth2LoginSecurityConfig <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			.authorizeRequests()
				.anyRequest().authenticated()
				.and()
			.oauth2Login();
	}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jc-oauth2login-completely-override-autoconfiguration" href="index.html#jc-oauth2login-completely-override-autoconfiguration"></a>Completely Override the Auto-configuration</h4></div></div></div>
<p>The following example shows how to completely override the auto-configuration by both registering a <code class="literal">ClientRegistrationRepository</code> <code class="literal">@Bean</code> and providing a <code class="literal">WebSecurityConfigurerAdapter</code>, both of which were described in the two preceding sections.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OAuth2LoginConfig {

	<em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
	<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> OAuth2LoginSecurityConfig <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

		<em><span class="hl-annotation" style="color: gray">@Override</span></em>
		<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
			http
				.authorizeRequests()
					.anyRequest().authenticated()
					.and()
				.oauth2Login();
		}
	}

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<span class="hl-keyword">public</span> ClientRegistrationRepository clientRegistrationRepository() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> InMemoryClientRegistrationRepository(<span class="hl-keyword">this</span>.googleClientRegistration());
	}

	<span class="hl-keyword">private</span> ClientRegistration googleClientRegistration() {
		<span class="hl-keyword">return</span> ClientRegistration.withRegistrationId(<span class="hl-string">"google"</span>)
			.clientId(<span class="hl-string">"google-client-id"</span>)
			.clientSecret(<span class="hl-string">"google-client-secret"</span>)
			.clientAuthenticationMethod(ClientAuthenticationMethod.BASIC)
			.authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)
			.redirectUriTemplate(<span class="hl-string">"{baseUrl}/login/oauth2/code/{registrationId}"</span>)
			.scope(<span class="hl-string">"openid"</span>, <span class="hl-string">"profile"</span>, <span class="hl-string">"email"</span>, <span class="hl-string">"address"</span>, <span class="hl-string">"phone"</span>)
			.authorizationUri(<span class="hl-string">"https://accounts.google.com/o/oauth2/v2/auth"</span>)
			.tokenUri(<span class="hl-string">"https://www.googleapis.com/oauth2/v4/token"</span>)
			.userInfoUri(<span class="hl-string">"https://www.googleapis.com/oauth2/v3/userinfo"</span>)
			.userNameAttributeName(IdTokenClaimNames.SUB)
			.jwkSetUri(<span class="hl-string">"https://www.googleapis.com/oauth2/v3/certs"</span>)
			.clientName(<span class="hl-string">"Google"</span>)
			.build();
	}
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-oauth2login-javaconfig-wo-boot" href="index.html#jc-oauth2login-javaconfig-wo-boot"></a>5.7.8&nbsp;Java Configuration without Spring Boot 2.0</h3></div></div></div>
<p>If you are not able to use Spring Boot 2.0 and would like to configure one of the pre-defined providers in <code class="literal">CommonOAuth2Provider</code>
(for example, Google), apply the following configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OAuth2LoginConfig {

	<em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
	<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> OAuth2LoginSecurityConfig <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

		<em><span class="hl-annotation" style="color: gray">@Override</span></em>
		<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
			http
				.authorizeRequests()
					.anyRequest().authenticated()
					.and()
				.oauth2Login();
		}
	}

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<span class="hl-keyword">public</span> ClientRegistrationRepository clientRegistrationRepository() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> InMemoryClientRegistrationRepository(<span class="hl-keyword">this</span>.googleClientRegistration());
	}

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<span class="hl-keyword">public</span> OAuth2AuthorizedClientService authorizedClientService() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> InMemoryOAuth2AuthorizedClientService(<span class="hl-keyword">this</span>.clientRegistrationRepository());
	}

	<span class="hl-keyword">private</span> ClientRegistration googleClientRegistration() {
		<span class="hl-keyword">return</span> CommonOAuth2Provider.GOOGLE.getBuilder(<span class="hl-string">"google"</span>)
			.clientId(<span class="hl-string">"google-client-id"</span>)
			.clientSecret(<span class="hl-string">"google-client-secret"</span>)
			.build();
	}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-oauth2login-authorized-client" href="index.html#jc-oauth2login-authorized-client"></a>5.7.9&nbsp;OAuth2AuthorizedClient / OAuth2AuthorizedClientService</h3></div></div></div>
<p><code class="literal">OAuth2AuthorizedClient</code> is a representation of an Authorized Client.
A client is considered to be authorized when the end-user (Resource Owner) has granted authorization to the client to access its protected resources.</p>
<p><code class="literal">OAuth2AuthorizedClient</code> serves the purpose of associating an <code class="literal">OAuth2AccessToken</code> to a <code class="literal">ClientRegistration</code> (client) and resource owner,
who is the <code class="literal">Principal</code> end-user that granted the authorization.</p>
<p>The primary role of the <code class="literal">OAuth2AuthorizedClientService</code> is to manage <code class="literal">OAuth2AuthorizedClient</code> instances.
From a developer perspective, it provides the capability to lookup an <code class="literal">OAuth2AccessToken</code> associated with a client
so that it may be used to initiate a request to a resource server.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring Boot 2.0 Auto-configuration registers an <code class="literal">OAuth2AuthorizedClientService</code> <code class="literal">@Bean</code> in the <code class="literal">ApplicationContext</code>.</p>
</td></tr></table></div>
<p>The developer may also register an <code class="literal">OAuth2AuthorizedClientService</code> <code class="literal">@Bean</code> in the <code class="literal">ApplicationContext</code> (overriding Spring Boot 2.0 Auto-configuration)
in order to have the ability to lookup an <code class="literal">OAuth2AccessToken</code> associated with a specific <code class="literal">ClientRegistration</code> (client).</p>
<p>The following listing shows an example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Controller</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MainController {

	<em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
	<span class="hl-keyword">private</span> OAuth2AuthorizedClientService authorizedClientService;

	<em><span class="hl-annotation" style="color: gray">@RequestMapping("/userinfo")</span></em>
	<span class="hl-keyword">public</span> String userinfo(OAuth2AuthenticationToken authentication) {
		<span class="hl-comment">// authentication.getAuthorizedClientRegistrationId() returns the</span>
		<span class="hl-comment">// registrationId of the Client that was authorized during the Login flow</span>
		OAuth2AuthorizedClient authorizedClient =
			<span class="hl-keyword">this</span>.authorizedClientService.loadAuthorizedClient(
				authentication.getAuthorizedClientRegistrationId(),
				authentication.getName());

		OAuth2AccessToken accessToken = authorizedClient.getAccessToken();

		...

		<span class="hl-keyword">return</span> <span class="hl-string">"userinfo"</span>;
	}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-oauth2login-resources" href="index.html#jc-oauth2login-resources"></a>5.7.10&nbsp;Additional Resources</h3></div></div></div>
<p>The following additional resources describe advanced configuration options:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#oauth2login-advanced-login-page" title="31.1&nbsp;OAuth 2.0 Login Page">OAuth 2.0 Login Page</a>
</li><li class="listitem">
<p class="simpara">Authorization Endpoint:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<a class="link" href="index.html#oauth2login-advanced-authorization-request-repository" title="31.2.1&nbsp;AuthorizationRequestRepository">AuthorizationRequestRepository</a>
</li></ul></div>
</li><li class="listitem">
<a class="link" href="index.html#oauth2login-advanced-redirection-endpoint" title="31.3&nbsp;Redirection Endpoint">Redirection Endpoint</a>
</li><li class="listitem">
<p class="simpara">Token Endpoint:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<a class="link" href="index.html#oauth2login-advanced-token-client" title="31.4.1&nbsp;OAuth2AccessTokenResponseClient">OAuth2AccessTokenResponseClient</a>
</li></ul></div>
</li><li class="listitem">
<p class="simpara">UserInfo Endpoint:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<a class="link" href="index.html#oauth2login-advanced-map-authorities" title="31.5.1&nbsp;Mapping User Authorities">Mapping User Authorities</a>
</li><li class="listitem">
<a class="link" href="index.html#oauth2login-advanced-custom-user" title="31.5.2&nbsp;Configuring a Custom OAuth2User">Configuring a Custom OAuth2User</a>
</li><li class="listitem">
<a class="link" href="index.html#oauth2login-advanced-oauth2-user-service" title="31.5.3&nbsp;OAuth 2.0 UserService">OAuth 2.0 UserService</a>
</li><li class="listitem">
<a class="link" href="index.html#oauth2login-advanced-oidc-user-service" title="31.5.4&nbsp;OpenID Connect 1.0 UserService">OpenID Connect 1.0 UserService</a>
</li></ul></div>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jc-authentication" href="index.html#jc-authentication"></a>5.8&nbsp;Authentication</h2></div></div></div>
<p>Thus far we have only taken a look at the most basic authentication configuration. Let&#8217;s take a look at a few slightly more advanced options for configuring authentication.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-authentication-inmemory" href="index.html#jc-authentication-inmemory"></a>5.8.1&nbsp;In-Memory Authentication</h3></div></div></div>
<p>We have already seen an example of configuring in-memory authentication for a single user. Below is an example to configure multiple users:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> UserDetailsService userDetailsService() <span class="hl-keyword">throws</span> Exception {
	<span class="hl-comment">// ensure the passwords are encoded properly</span>
	UserBuilder users = User.withDefaultPasswordEncoder();
	InMemoryUserDetailsManager manager = <span class="hl-keyword">new</span> InMemoryUserDetailsManager();
	manager.createUser(users.username(<span class="hl-string">"user"</span>).password(<span class="hl-string">"password"</span>).roles(<span class="hl-string">"USER"</span>).build());
	manager.createUser(users.username(<span class="hl-string">"admin"</span>).password(<span class="hl-string">"password"</span>).roles(<span class="hl-string">"USER"</span>,<span class="hl-string">"ADMIN"</span>).build());
	<span class="hl-keyword">return</span> manager;
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-authentication-jdbc" href="index.html#jc-authentication-jdbc"></a>5.8.2&nbsp;JDBC Authentication</h3></div></div></div>
<p>You can find the updates to support JDBC based authentication. The example below assumes that you have already defined a <code class="literal">DataSource</code> within your application. The <a class="ulink" href="https://github.com/spring-projects/spring-security/tree/master/samples/javaconfig/jdbc" target="_top">jdbc-javaconfig</a> sample provides a complete example of using JDBC based authentication.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
<span class="hl-keyword">private</span> DataSource dataSource;

<em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> configureGlobal(AuthenticationManagerBuilder auth) <span class="hl-keyword">throws</span> Exception {
	<span class="hl-comment">// ensure the passwords are encoded properly</span>
	UserBuilder users = User.withDefaultPasswordEncoder();
	auth
		.jdbcAuthentication()
			.dataSource(dataSource)
			.withDefaultSchema()
			.withUser(users.username(<span class="hl-string">"user"</span>).password(<span class="hl-string">"password"</span>).roles(<span class="hl-string">"USER"</span>))
			.withUser(users.username(<span class="hl-string">"admin"</span>).password(<span class="hl-string">"password"</span>).roles(<span class="hl-string">"USER"</span>,<span class="hl-string">"ADMIN"</span>));
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ldap-authentication" href="index.html#ldap-authentication"></a>5.8.3&nbsp;LDAP Authentication</h3></div></div></div>
<p>You can find the updates to support LDAP based authentication. The <a class="ulink" href="https://github.com/spring-projects/spring-security/tree/master/samples/javaconfig/ldap" target="_top">ldap-javaconfig</a> sample provides a complete example of using LDAP based authentication.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
<span class="hl-keyword">private</span> DataSource dataSource;

<em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> configureGlobal(AuthenticationManagerBuilder auth) <span class="hl-keyword">throws</span> Exception {
	auth
		.ldapAuthentication()
			.userDnPatterns(<span class="hl-string">"uid={0},ou=people"</span>)
			.groupSearchBase(<span class="hl-string">"ou=groups"</span>);
}</pre>
<p>The example above uses the following LDIF and an embedded Apache DS LDAP instance.</p>
<p>
<b>users.ldif.&nbsp;</b>
</p><pre class="screen">dn: ou=groups,dc=springframework,dc=org
objectclass: top
objectclass: organizationalUnit
ou: groups

dn: ou=people,dc=springframework,dc=org
objectclass: top
objectclass: organizationalUnit
ou: people

dn: uid=admin,ou=people,dc=springframework,dc=org
objectclass: top
objectclass: person
objectclass: organizationalPerson
objectclass: inetOrgPerson
cn: Rod Johnson
sn: Johnson
uid: admin
userPassword: password

dn: uid=user,ou=people,dc=springframework,dc=org
objectclass: top
objectclass: person
objectclass: organizationalPerson
objectclass: inetOrgPerson
cn: Dianne Emu
sn: Emu
uid: user
userPassword: password

dn: cn=user,ou=groups,dc=springframework,dc=org
objectclass: top
objectclass: groupOfNames
cn: user
uniqueMember: uid=admin,ou=people,dc=springframework,dc=org
uniqueMember: uid=user,ou=people,dc=springframework,dc=org

dn: cn=admin,ou=groups,dc=springframework,dc=org
objectclass: top
objectclass: groupOfNames
cn: admin
uniqueMember: uid=admin,ou=people,dc=springframework,dc=org</pre><p>
</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-authentication-authenticationprovider" href="index.html#jc-authentication-authenticationprovider"></a>5.8.4&nbsp;AuthenticationProvider</h3></div></div></div>
<p>You can define custom authentication by exposing a custom <code class="literal">AuthenticationProvider</code> as a bean.
For example, the following will customize authentication assuming that <code class="literal">SpringAuthenticationProvider</code> implements <code class="literal">AuthenticationProvider</code>:</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This is only used if the <code class="literal">AuthenticationManagerBuilder</code> has not been populated</p>
</td></tr></table></div>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> SpringAuthenticationProvider springAuthenticationProvider() {
	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SpringAuthenticationProvider();
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-authentication-userdetailsservice" href="index.html#jc-authentication-userdetailsservice"></a>5.8.5&nbsp;UserDetailsService</h3></div></div></div>
<p>You can define custom authentication by exposing a custom <code class="literal">UserDetailsService</code> as a bean.
For example, the following will customize authentication assuming that <code class="literal">SpringDataUserDetailsService</code> implements <code class="literal">UserDetailsService</code>:</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This is only used if the <code class="literal">AuthenticationManagerBuilder</code> has not been populated and no <code class="literal">AuthenticationProviderBean</code> is defined.</p>
</td></tr></table></div>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> SpringDataUserDetailsService springDataUserDetailsService() {
	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SpringDataUserDetailsService();
}</pre>
<p>You can also customize how passwords are encoded by exposing a <code class="literal">PasswordEncoder</code> as a bean.
For example, if you use bcrypt you can add a bean definition as shown below:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> BCryptPasswordEncoder passwordEncoder() {
	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> BCryptPasswordEncoder();
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="multiple-httpsecurity" href="index.html#multiple-httpsecurity"></a>5.9&nbsp;Multiple HttpSecurity</h2></div></div></div>
<p>We can configure multiple HttpSecurity instances just as we can have multiple <code class="literal">&lt;http&gt;</code> blocks. The key is to extend the <code class="literal">WebSecurityConfigurationAdapter</code> multiple times. For example, the following is an example of having a different configuration for URL&#8217;s that start with <code class="literal">/api/</code>.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MultiHttpSecurityConfig {
	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>                                                             <a name="CO9-1" href="index.html#CO9-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
	<span class="hl-keyword">public</span> UserDetailsService userDetailsService() <span class="hl-keyword">throws</span> Exception {
		<span class="hl-comment">// ensure the passwords are encoded properly</span>
		UserBuilder users = User.withDefaultPasswordEncoder();
		InMemoryUserDetailsManager manager = <span class="hl-keyword">new</span> InMemoryUserDetailsManager();
		manager.createUser(users.username(<span class="hl-string">"user"</span>).password(<span class="hl-string">"password"</span>).roles(<span class="hl-string">"USER"</span>).build());
		manager.createUser(users.username(<span class="hl-string">"admin"</span>).password(<span class="hl-string">"password"</span>).roles(<span class="hl-string">"USER"</span>,<span class="hl-string">"ADMIN"</span>).build());
		<span class="hl-keyword">return</span> manager;
	}

	<em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
	<em><span class="hl-annotation" style="color: gray">@Order(1)</span></em>                                                        <a name="CO9-2" href="index.html#CO9-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
	<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> ApiWebSecurityConfigurationAdapter <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {
		<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
			http
				.antMatcher(<span class="hl-string">"/api/**"</span>)                               <a name="CO9-3" href="index.html#CO9-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
				.authorizeRequests()
					.anyRequest().hasRole(<span class="hl-string">"ADMIN"</span>)
					.and()
				.httpBasic();
		}
	}

	<em><span class="hl-annotation" style="color: gray">@Configuration</span></em>                                                   <a name="CO9-4" href="index.html#CO9-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
	<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> FormLoginWebSecurityConfigurerAdapter <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

		<em><span class="hl-annotation" style="color: gray">@Override</span></em>
		<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
			http
				.authorizeRequests()
					.anyRequest().authenticated()
					.and()
				.formLogin();
		}
	}
}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO9-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Configure Authentication as normal</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO9-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Create an instance of <code class="literal">WebSecurityConfigurerAdapter</code> that contains <code class="literal">@Order</code> to specify which <code class="literal">WebSecurityConfigurerAdapter</code> should be considered first.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO9-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">http.antMatcher</code> states that this <code class="literal">HttpSecurity</code> will only be applicable to URLs that start with <code class="literal">/api/</code></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO9-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Create another instance of <code class="literal">WebSecurityConfigurerAdapter</code>. If the URL does not start with <code class="literal">/api/</code> this configuration will be used. This configuration is considered after <code class="literal">ApiWebSecurityConfigurationAdapter</code> since it has an <code class="literal">@Order</code> value after <code class="literal">1</code> (no <code class="literal">@Order</code> defaults to last).</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jc-method" href="index.html#jc-method"></a>5.10&nbsp;Method Security</h2></div></div></div>
<p>From version 2.0 onwards Spring Security has improved support substantially for adding security to your service layer methods. It provides support for JSR-250 annotation security as well as the framework&#8217;s original <code class="literal">@Secured</code> annotation. From 3.0 you can also make use of new <a class="link" href="index.html#el-access" title="27.&nbsp;Expression-Based Access Control">expression-based annotations</a>. You can apply security to a single bean, using the <code class="literal">intercept-methods</code> element to decorate the bean declaration, or you can secure multiple beans across the entire service layer using the AspectJ style pointcuts.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="enableglobalmethodsecurity" href="index.html#enableglobalmethodsecurity"></a>5.10.1&nbsp;EnableGlobalMethodSecurity</h3></div></div></div>
<p>We can enable annotation-based security using the <code class="literal">@EnableGlobalMethodSecurity</code> annotation on any <code class="literal">@Configuration</code> instance. For example, the following would enable Spring Security&#8217;s <code class="literal">@Secured</code> annotation.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableGlobalMethodSecurity(securedEnabled = true)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MethodSecurityConfig {
<span class="hl-comment">// ...</span>
}</pre>
<p>Adding an annotation to a method (on a class or interface) would then limit the access to that method accordingly. Spring Security&#8217;s native annotation support defines a set of attributes for the method. These will be passed to the AccessDecisionManager for it to make the actual decision:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> BankService {

<em><span class="hl-annotation" style="color: gray">@Secured("IS_AUTHENTICATED_ANONYMOUSLY")</span></em>
<span class="hl-keyword">public</span> Account readAccount(Long id);

<em><span class="hl-annotation" style="color: gray">@Secured("IS_AUTHENTICATED_ANONYMOUSLY")</span></em>
<span class="hl-keyword">public</span> Account[] findAccounts();

<em><span class="hl-annotation" style="color: gray">@Secured("ROLE_TELLER")</span></em>
<span class="hl-keyword">public</span> Account post(Account account, <span class="hl-keyword">double</span> amount);
}</pre>
<p>Support for JSR-250 annotations can be enabled using</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableGlobalMethodSecurity(jsr250Enabled = true)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MethodSecurityConfig {
<span class="hl-comment">// ...</span>
}</pre>
<p>These are standards-based and allow simple role-based constraints to be applied but do not have the power Spring Security&#8217;s native annotations. To use the new expression-based syntax, you would use</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MethodSecurityConfig {
<span class="hl-comment">// ...</span>
}</pre>
<p>and the equivalent Java code would be</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> BankService {

<em><span class="hl-annotation" style="color: gray">@PreAuthorize("isAnonymous()")</span></em>
<span class="hl-keyword">public</span> Account readAccount(Long id);

<em><span class="hl-annotation" style="color: gray">@PreAuthorize("isAnonymous()")</span></em>
<span class="hl-keyword">public</span> Account[] findAccounts();

<em><span class="hl-annotation" style="color: gray">@PreAuthorize("hasAuthority('ROLE_TELLER')")</span></em>
<span class="hl-keyword">public</span> Account post(Account account, <span class="hl-keyword">double</span> amount);
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="globalmethodsecurityconfiguration" href="index.html#globalmethodsecurityconfiguration"></a>5.10.2&nbsp;GlobalMethodSecurityConfiguration</h3></div></div></div>
<p>Sometimes you may need to perform operations that are more complicated than are possible with the <code class="literal">@EnableGlobalMethodSecurity</code> annotation allow. For these instances, you can extend the <code class="literal">GlobalMethodSecurityConfiguration</code> ensuring that the <code class="literal">@EnableGlobalMethodSecurity</code> annotation is present on your subclass. For example, if you wanted to provide a custom <code class="literal">MethodSecurityExpressionHandler</code>, you could use the following configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MethodSecurityConfig <span class="hl-keyword">extends</span> GlobalMethodSecurityConfiguration {
	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> MethodSecurityExpressionHandler createExpressionHandler() {
		<span class="hl-comment">// ... create and return custom MethodSecurityExpressionHandler ...</span>
		<span class="hl-keyword">return</span> expressionHandler;
	}
}</pre>
<p>For additional information about methods that can be overridden, refer to the <code class="literal">GlobalMethodSecurityConfiguration</code> Javadoc.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jc-erms" href="index.html#jc-erms"></a>5.10.3&nbsp;EnableReactiveMethodSecurity</h3></div></div></div>
<p>Spring Security supports method security using <a class="ulink" href="https://projectreactor.io/docs/core/release/reference/#context" target="_top">Reactor&#8217;s Context</a> which is setup using <code class="literal">ReactiveSecurityContextHolder</code>.
For example, this demonstrates how to retrieve the currently logged in user&#8217;s message.</p>
<pre class="programlisting">Authentication authentication = <span class="hl-keyword">new</span> TestingAuthenticationToken(<span class="hl-string">"user"</span>, <span class="hl-string">"password"</span>, <span class="hl-string">"ROLE_USER"</span>);

Mono&lt;String&gt; messageByUsername = ReactiveSecurityContextHolder.getContext()
	.map(SecurityContext::getAuthentication)
	.map(Authentication::getName)
	.flatMap(<span class="hl-keyword">this</span>::findMessageByUsername)
	<span class="hl-comment">// In a WebFlux application the `subscriberContext` is automatically setup using `ReactorContextWebFilter`</span>
	.subscriberContext(ReactiveSecurityContextHolder.withAuthentication(authentication));

StepVerifier.create(messageByUsername)
	.expectNext(<span class="hl-string">"Hi user"</span>)
	.verifyComplete();</pre>
<p>with <code class="literal">this::findMessageByUsername</code> defined as:</p>
<pre class="programlisting">Mono&lt;String&gt; findMessageByUsername(String username) {
	<span class="hl-keyword">return</span> Mono.just(<span class="hl-string">"Hi "</span> + username);
}</pre>
<p>Below is a minimal method security configuration when using method security in reactive applications.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableReactiveMethodSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SecurityConfig {
	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<span class="hl-keyword">public</span> MapReactiveUserDetailsService userDetailsRepository() {
		User.UserBuilder userBuilder = User.withDefaultPasswordEncoder();
		UserDetails rob = userBuilder.username(<span class="hl-string">"rob"</span>).password(<span class="hl-string">"rob"</span>).roles(<span class="hl-string">"USER"</span>).build();
		UserDetails admin = userBuilder.username(<span class="hl-string">"admin"</span>).password(<span class="hl-string">"admin"</span>).roles(<span class="hl-string">"USER"</span>,<span class="hl-string">"ADMIN"</span>).build();
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MapReactiveUserDetailsService(rob, admin);
	}
}</pre>
<p>Consider the following class:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Component</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> HelloWorldMessageService {
	<em><span class="hl-annotation" style="color: gray">@PreAuthorize("hasRole('ADMIN')")</span></em>
	<span class="hl-keyword">public</span> Mono&lt;String&gt; findMessage() {
		<span class="hl-keyword">return</span> Mono.just(<span class="hl-string">"Hello World!"</span>);
	}
}</pre>
<p>Combined with our configuration above, <code class="literal">@PreAuthorize("hasRole('ADMIN')")</code> will ensure that <code class="literal">findByMessage</code> is only invoked by a user with the role <code class="literal">ADMIN</code>.
It is important to note that any of the expressions in standard method security work for <code class="literal">@EnableReactiveMethodSecurity</code>.
However, at this time we only support return type of <code class="literal">Boolean</code> or <code class="literal">boolean</code> of the expression.
This means that the expression must not block.</p>
<p>When integrating with <a class="xref" href="index.html#jc-webflux" title="5.6&nbsp;WebFlux Security">Section&nbsp;5.6, &#8220;WebFlux Security&#8221;</a>, the Reactor Context is automatically established by Spring Security according to the authenticated user.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebFluxSecurity</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableReactiveMethodSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SecurityConfig {

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	SecurityWebFilterChain springWebFilterChain(ServerHttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		<span class="hl-keyword">return</span> http
			<span class="hl-comment">// Demonstrate that method security works</span>
			<span class="hl-comment">// Best practice to use both for defense in depth</span>
			.authorizeExchange()
				.anyExchange().permitAll()
				.and()
			.httpBasic().and()
			.build();
	}

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	MapReactiveUserDetailsService userDetailsRepository() {
		User.UserBuilder userBuilder = User.withDefaultPasswordEncoder();
		UserDetails rob = userBuilder.username(<span class="hl-string">"rob"</span>).password(<span class="hl-string">"rob"</span>).roles(<span class="hl-string">"USER"</span>).build();
		UserDetails admin = userBuilder.username(<span class="hl-string">"admin"</span>).password(<span class="hl-string">"admin"</span>).roles(<span class="hl-string">"USER"</span>,<span class="hl-string">"ADMIN"</span>).build();
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MapReactiveUserDetailsService(rob, admin);
	}
}</pre>
<p>You can find a complete sample in <a class="ulink" href="https://github.com/spring-projects/spring-security/tree/5.0.0.RELEASE/samples/javaconfig/hellowebflux-method" target="_top">hellowebflux-method</a></p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="post-processing-configured-objects" href="index.html#post-processing-configured-objects"></a>5.11&nbsp;Post Processing Configured Objects</h2></div></div></div>
<p>Spring Security&#8217;s Java Configuration does not expose every property of every object that it configures. This simplifies the configuration for a majority of users. Afterall, if every property was exposed, users could use standard bean configuration.</p>
<p>While there are good reasons to not directly expose every property, users may still need more advanced configuration options. To address this Spring Security introduces the concept of an <code class="literal">ObjectPostProcessor</code> which can be used to modify or replace many of the Object instances created by the Java Configuration. For example, if you wanted to configure the <code class="literal">filterSecurityPublishAuthorizationSuccess</code> property on <code class="literal">FilterSecurityInterceptor</code> you could use the following:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Override</span></em>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
		.authorizeRequests()
			.anyRequest().authenticated()
			.withObjectPostProcessor(<span class="hl-keyword">new</span> ObjectPostProcessor&lt;FilterSecurityInterceptor&gt;() {
				<span class="hl-keyword">public</span> &lt;O <span class="hl-keyword">extends</span> FilterSecurityInterceptor&gt; O postProcess(
						O fsi) {
					fsi.setPublishAuthorizationSuccess(true);
					<span class="hl-keyword">return</span> fsi;
				}
			});
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jc-custom-dsls" href="index.html#jc-custom-dsls"></a>5.12&nbsp;Custom DSLs</h2></div></div></div>
<p>You can provide your own custom DSLs in Spring Security.
For example, you might have something that looks like this:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyCustomDsl <span class="hl-keyword">extends</span> AbstractHttpConfigurer&lt;MyCustomDsl, HttpSecurity&gt; {
	<span class="hl-keyword">private</span> <span class="hl-keyword">boolean</span> flag;

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> init(H http) <span class="hl-keyword">throws</span> Exception {
		<span class="hl-comment">// any method that adds another configurer</span>
		<span class="hl-comment">// must be done in the init method</span>
		http.csrf().disable();
	}

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> configure(H http) <span class="hl-keyword">throws</span> Exception {
		ApplicationContext context = http.getSharedObject(ApplicationContext.<span class="hl-keyword">class</span>);

		<span class="hl-comment">// here we lookup from the ApplicationContext. You can also just create a new instance.</span>
		MyFilter myFilter = context.getBean(MyFilter.<span class="hl-keyword">class</span>);
		myFilter.setFlag(flag);
		http.addFilterBefore(myFilter, UsernamePasswordAuthenticationFilter.<span class="hl-keyword">class</span>);
	}

	<span class="hl-keyword">public</span> MyCustomDsl flag(<span class="hl-keyword">boolean</span> value) {
		<span class="hl-keyword">this</span>.flag = value;
		<span class="hl-keyword">return</span> <span class="hl-keyword">this</span>;
	}

	<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> MyCustomDsl customDsl() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MyCustomDsl();
	}
}</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This is actually how methods like <code class="literal">HttpSecurity.authorizeRequests()</code> are implemented.</p>
</td></tr></table></div>
<p>The custom DSL can then be used like this:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Config <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {
	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			.apply(customDsl())
				.flag(true)
				.and()
			...;
	}
}</pre>
<p>The code is invoked in the following order:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Code in `Config`s configure method is invoked
</li><li class="listitem">
Code in `MyCustomDsl`s init method is invoked
</li><li class="listitem">
Code in `MyCustomDsl`s configure method is invoked
</li></ul></div>
<p>If you want, you can have <code class="literal">WebSecurityConfiguerAdapter</code> add <code class="literal">MyCustomDsl</code> by default by using <code class="literal">SpringFactories</code>.
For example, you would create a resource on the classpath named <code class="literal">META-INF/spring.factories</code> with the following contents:</p>
<p>
<b>META-INF/spring.factories.&nbsp;</b>
</p><pre class="screen">org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer = sample.MyCustomDsl</pre><p>
</p>
<p>Users wishing to disable the default can do so explicitly.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Config <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {
	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			.apply(customDsl()).disable()
			...;
	}
}</pre>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ns-config" href="index.html#ns-config"></a>6.&nbsp;Security Namespace Configuration</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="introduction-2" href="index.html#introduction-2"></a>6.1&nbsp;Introduction</h2></div></div></div>
<p>Namespace configuration has been available since version 2.0 of the Spring Framework. It allows you to supplement the traditional Spring beans application context syntax with elements from additional XML schema. You can find more information in the Spring <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/" target="_top">Reference Documentation</a>. A namespace element can be used simply to allow a more concise way of configuring an individual bean or, more powerfully, to define an alternative configuration syntax which more closely matches the problem domain and hides the underlying complexity from the user. A simple element may conceal the fact that multiple beans and processing steps are being added to the application context. For example, adding the following element from the security namespace to an application context will start up an embedded LDAP server for testing use within the application:</p>
<pre class="programlisting"><span class="hl-tag">&lt;security:ldap-server /&gt;</span></pre>
<p>This is much simpler than wiring up the equivalent Apache Directory Server beans. The most common alternative configuration requirements are supported by attributes on the <code class="literal">ldap-server</code> element and the user is isolated
from worrying about which beans they need to create and what the bean property names are. <a href="index.html#ftn.d5e1434" class="footnote" name="d5e1434"><sup class="footnote">[1]</sup></a>. Use of a good XML
editor while editing the application context file should provide information on the attributes and elements that are available. We would recommend that you try out the
<a class="ulink" href="https://spring.io/tools/sts" target="_top">Spring Tool Suite</a> as it has special features for working with standard Spring namespaces.</p>
<p>To start using the security namespace in your application context, you need to have the <code class="literal">spring-security-config</code> jar on your classpath. Then all you need to do is add the schema declaration to your application context file:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
<span class="hl-attribute">xmlns:security</span>=<span class="hl-value">"http://www.springframework.org/schema/security"</span>
<span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
<span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
		http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
		http://www.springframework.org/schema/security
		http://www.springframework.org/schema/security/spring-security.xsd"</span><span class="hl-tag">&gt;</span>
	...
<span class="hl-tag">&lt;/beans&gt;</span></pre>
<p>In many of the examples you will see (and in the sample applications), we
will often use "security" as the default namespace rather than "beans", which means we
can omit the prefix on all the security namespace elements, making the content easier to
read. You may also want to do this if you have your application context divided up into
separate files and have most of your security configuration in one of them. Your
security application context file would then start like this</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans:beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/security"</span>
<span class="hl-attribute">xmlns:beans</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
<span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
<span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
		http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
		http://www.springframework.org/schema/security
		http://www.springframework.org/schema/security/spring-security.xsd"</span><span class="hl-tag">&gt;</span>
	...
<span class="hl-tag">&lt;/beans:beans&gt;</span></pre>
<p>We&#8217;ll assume this syntax is being used from now on in this chapter.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="design-of-the-namespace" href="index.html#design-of-the-namespace"></a>6.1.1&nbsp;Design of the Namespace</h3></div></div></div>
<p>The namespace is designed to capture the most common uses of the framework and provide a simplified and concise syntax for enabling them within an application. The design is based around the large-scale dependencies within the framework, and can be divided up into the following areas:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>Web/HTTP Security</em></span> - the most complex part. Sets up the filters and related service beans used to apply the framework authentication mechanisms, to secure URLs, render login and error pages and much more.
</li><li class="listitem">
<span class="emphasis"><em>Business Object (Method) Security</em></span> - options for securing the service layer.
</li><li class="listitem">
<span class="emphasis"><em>AuthenticationManager</em></span> - handles authentication requests from other parts of the framework.
</li><li class="listitem">
<span class="emphasis"><em>AccessDecisionManager</em></span> - provides access decisions for web and method security. A default one will be registered, but you can also choose to use a custom one, declared using normal Spring bean syntax.
</li><li class="listitem">
<span class="emphasis"><em>AuthenticationProvider</em></span>s - mechanisms against which the authentication manager authenticates users. The namespace provides supports for several standard options and also a means of adding custom beans declared using a traditional syntax.
</li><li class="listitem">
<span class="emphasis"><em>UserDetailsService</em></span> - closely related to authentication providers, but often also required by other beans.
</li></ul></div>
<p>We&#8217;ll see how to configure these in the following sections.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ns-getting-started" href="index.html#ns-getting-started"></a>6.2&nbsp;Getting Started with Security Namespace Configuration</h2></div></div></div>
<p>In this section, we&#8217;ll look at how you can build up a namespace configuration to use some of the main features of the framework. Let&#8217;s assume you initially want to get up and running as quickly as possible and add authentication support and access control to an existing web application, with a few test logins. Then we&#8217;ll look at how to change over to authenticating against a database or other security repository. In later sections we&#8217;ll introduce more advanced namespace configuration options.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ns-web-xml" href="index.html#ns-web-xml"></a>6.2.1&nbsp;web.xml Configuration</h3></div></div></div>
<p>The first thing you need to do is add the following filter declaration to your <code class="literal">web.xml</code> file:</p>
<pre class="programlisting"><span class="hl-tag">&lt;filter&gt;</span>
<span class="hl-tag">&lt;filter-name&gt;</span>springSecurityFilterChain<span class="hl-tag">&lt;/filter-name&gt;</span>
<span class="hl-tag">&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="hl-tag">&lt;/filter-class&gt;</span>
<span class="hl-tag">&lt;/filter&gt;</span>

<span class="hl-tag">&lt;filter-mapping&gt;</span>
<span class="hl-tag">&lt;filter-name&gt;</span>springSecurityFilterChain<span class="hl-tag">&lt;/filter-name&gt;</span>
<span class="hl-tag">&lt;url-pattern&gt;</span>/*<span class="hl-tag">&lt;/url-pattern&gt;</span>
<span class="hl-tag">&lt;/filter-mapping&gt;</span></pre>
<p>This provides a hook into the Spring Security web infrastructure. <code class="literal">DelegatingFilterProxy</code> is a Spring Framework class which delegates to a filter implementation which is defined as a Spring bean in your application
context. In this case, the bean is named "springSecurityFilterChain", which is an internal infrastructure bean created by the namespace to handle web security. Note that you should not use this bean name yourself. Once
you&#8217;ve added this to your <code class="literal">web.xml</code>, you&#8217;re ready to start editing your application context file. Web security services are configured using the <code class="literal">&lt;http&gt;</code> element.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ns-minimal" href="index.html#ns-minimal"></a>6.2.2&nbsp;A Minimal &lt;http&gt; Configuration</h3></div></div></div>
<p>All you need to enable web security to begin with is</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
<span class="hl-tag">&lt;intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/**"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"hasRole('USER')"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;form-login /&gt;</span>
<span class="hl-tag">&lt;logout /&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>Which says that we want all URLs within our application to be secured, requiring the role <code class="literal">ROLE_USER</code> to access them, we want to log in to the application using a form with username and password, and that we want a
logout URL registered which will allow us to log out of the application. <code class="literal">&lt;http&gt;</code> element is the parent for all web-related namespace functionality. The <code class="literal">&lt;intercept-url&gt;</code> element defines a <code class="literal">pattern</code> which is matched
against the URLs of incoming requests using an ant path style syntax <a href="index.html#ftn.d5e1489" class="footnote" name="d5e1489"><sup class="footnote">[2]</sup></a>. You can also use regular-expression matching as an alternative (see the namespace appendix for more details). The <code class="literal">access</code> attribute defines the access requirements for requests matching
the given pattern. With the default configuration, this is typically a comma-separated list of roles, one of which a user must have to be allowed to make the request. The prefix"ROLE_" is a marker which indicates that a
simple comparison with the user&#8217;s authorities should be made. In other words, a normal role-based check should be used. Access-control in Spring Security is not limited to the use of simple roles (hence the use of the
prefix to differentiate between different types of security attributes). We&#8217;ll see later how the interpretation can vary footnote:[The interpretation of the comma-separated values in the <code class="literal">access</code> attribute depends on the
implementation of the &#150;1&#151; which is used. In Spring Security 3.0, the attribute can also be populated with an &#150;2&#151;.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You can use multiple <code class="literal">&lt;intercept-url&gt;</code> elements to define different access requirements for different sets of URLs, but they will be evaluated in the order listed and the first match will be used. So you must put the most specific matches at the top. You can also add a <code class="literal">method</code> attribute to limit the match to a particular HTTP method (<code class="literal">GET</code>, <code class="literal">POST</code>, <code class="literal">PUT</code> etc.).</p>
</td></tr></table></div>
<p>To add some users, you can define a set of test data directly in the namespace:</p>
<pre class="programlisting"><span class="hl-tag">&lt;authentication-manager&gt;</span>
<span class="hl-tag">&lt;authentication-provider&gt;</span>
	<span class="hl-tag">&lt;user-service&gt;</span>
	<span class="hl-comment">&lt;!-- Password is prefixed with {noop} to indicate to DelegatingPasswordEncoder that
	NoOpPasswordEncoder should be used. This is not safe for production, but makes reading
	in samples easier. Normally passwords should be hashed using BCrypt --&gt;</span>
	<span class="hl-tag">&lt;user</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jimi"</span> <span class="hl-attribute">password</span>=<span class="hl-value">"{noop}jimispassword"</span> <span class="hl-attribute">authorities</span>=<span class="hl-value">"ROLE_USER, ROLE_ADMIN"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;user</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bob"</span> <span class="hl-attribute">password</span>=<span class="hl-value">"{noop}bobspassword"</span> <span class="hl-attribute">authorities</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/user-service&gt;</span>
<span class="hl-tag">&lt;/authentication-provider&gt;</span>
<span class="hl-tag">&lt;/authentication-manager&gt;</span></pre>
<p>This is an example of a secure way of storing the same passwords. The password is prefixed
with <code class="literal">{bcrypt}</code> to instruct <code class="literal">DelegatingPasswordEncoder</code>, which supports any configured
<code class="literal">PasswordEncoder</code> for matching, that the passwords are hashed using
BCrypt:</p>
<pre class="programlisting"><span class="hl-tag">&lt;authentication-manager&gt;</span>
<span class="hl-tag">&lt;authentication-provider&gt;</span>
	<span class="hl-tag">&lt;user-service&gt;</span>
	<span class="hl-tag">&lt;user</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jimi"</span> <span class="hl-attribute">password</span>=<span class="hl-value">"{bcrypt}$2a$10$ddEWZUl8aU0GdZPPpy7wbu82dvEw/pBpbRvDQRqA41y6mK1CoH00m"</span>
			<span class="hl-attribute">authorities</span>=<span class="hl-value">"ROLE_USER, ROLE_ADMIN"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;user</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bob"</span> <span class="hl-attribute">password</span>=<span class="hl-value">"{bcrypt}$2a$10$/elFpMBnAYYig6KRR5bvOOYeZr1ie1hSogJryg9qDlhza4oCw1Qka"</span>
			<span class="hl-attribute">authorities</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;user</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jimi"</span> <span class="hl-attribute">password</span>=<span class="hl-value">"{noop}jimispassword"</span> <span class="hl-attribute">authorities</span>=<span class="hl-value">"ROLE_USER, ROLE_ADMIN"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;user</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bob"</span> <span class="hl-attribute">password</span>=<span class="hl-value">"{noop}bobspassword"</span> <span class="hl-attribute">authorities</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/user-service&gt;</span>
<span class="hl-tag">&lt;/authentication-provider&gt;</span>
<span class="hl-tag">&lt;/authentication-manager&gt;</span></pre>
<div class="sidebar"><div class="titlepage"></div>
<p>If you are familiar with pre-namespace versions of the framework, you can probably already guess roughly what&#8217;s going on here. The <code class="literal">&lt;http&gt;</code> element is responsible for creating a <code class="literal">FilterChainProxy</code> and the filter beans which it uses. Common problems like incorrect filter ordering are no longer an issue as the filter positions are predefined.</p>
<p>The <code class="literal">&lt;authentication-provider&gt;</code> element creates a <code class="literal">DaoAuthenticationProvider</code> bean and the <code class="literal">&lt;user-service&gt;</code> element creates an <code class="literal">InMemoryDaoImpl</code>. All <code class="literal">authentication-provider</code> elements must be children of the <code class="literal">&lt;authentication-manager&gt;</code> element, which creates a <code class="literal">ProviderManager</code> and registers the authentication providers with it. You can find more detailed information on the beans that are created in the <a class="link" href="index.html#appendix-namespace" title="43.&nbsp;The Security Namespace">namespace appendix</a>. It&#8217;s worth cross-checking this if you want to start understanding what the important classes in the framework are and how they are used, particularly if you want to customise things later.</p>
</div>
<p>The configuration above defines two users, their passwords and their roles within the application (which will be used for access control). It is also possible to load user information from a standard properties file using the <code class="literal">properties</code> attribute on <code class="literal">user-service</code>. See the section on <a class="link" href="index.html#core-services-in-memory-service" title="10.2.1&nbsp;In-Memory Authentication">in-memory authentication</a> for more details on the file format. Using the <code class="literal">&lt;authentication-provider&gt;</code> element means that the user information will be used by the authentication manager to process authentication requests. You can have multiple <code class="literal">&lt;authentication-provider&gt;</code> elements to define different authentication sources and each will be consulted in turn.</p>
<p>At this point you should be able to start up your application and you will be required to log in to proceed. Try it out, or try experimenting with the "tutorial" sample application that comes with the project.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ns-form-and-basic" href="index.html#ns-form-and-basic"></a>6.2.3&nbsp;Form and Basic Login Options</h3></div></div></div>
<p>You might be wondering where the login form came from when you were prompted to log in, since we made no mention of any HTML files or JSPs. In fact, since we didn&#8217;t explicitly set a URL for the login page, Spring Security generates one automatically, based on the features that are enabled and using standard values for the URL which processes the submitted login, the default target URL the user will be sent to after logging in and so on. However, the namespace offers plenty of support to allow you to customize these options. For example, if you want to supply your own login page, you could use:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
<span class="hl-tag">&lt;intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/login.jsp*"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"IS_AUTHENTICATED_ANONYMOUSLY"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/**"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;form-login</span> <span class="hl-attribute">login-page</span>=<span class="hl-value">'/login.jsp'</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>Also note that we&#8217;ve added an extra <code class="literal">intercept-url</code> element to say that any requests for the login page should be available to anonymous users <a href="index.html#ftn.d5e1534" class="footnote" name="d5e1534"><sup class="footnote">[3]</sup></a> and also
the <a class="link" href="index.html#authz-authenticated-voter" title="AuthenticatedVoter">AuthenticatedVoter</a> class for more details on how the value <code class="literal">IS_AUTHENTICATED_ANONYMOUSLY</code> is processed.]. Otherwise the request would be matched by the pattern /** and it wouldn&#8217;t be
possible to access the login page itself! This is a common configuration error and will result in an infinite loop in the application. Spring Security will emit a warning in the log if your login page appears to be
secured. It is also possible to have all requests matching a particular pattern bypass the security filter chain completely, by defining a separate <code class="literal">http</code> element for the pattern like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/css/**"</span> <span class="hl-attribute">security</span>=<span class="hl-value">"none"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;http</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/login.jsp*"</span> <span class="hl-attribute">security</span>=<span class="hl-value">"none"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;http</span> <span class="hl-attribute">use-expressions</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/**"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;form-login</span> <span class="hl-attribute">login-page</span>=<span class="hl-value">'/login.jsp'</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>From Spring Security 3.1 it is now possible to use multiple <code class="literal">http</code> elements to define separate security filter chain configurations for different request patterns. If the <code class="literal">pattern</code> attribute is omitted from an <code class="literal">http</code> element, it matches all requests. Creating an unsecured pattern is a simple example of this syntax, where the pattern is mapped to an empty filter chain <a href="index.html#ftn.d5e1545" class="footnote" name="d5e1545"><sup class="footnote">[4]</sup></a>. We&#8217;ll look at this new syntax in more detail in the chapter on the <a class="link" href="index.html#filter-chains-with-ns" title="14.6&nbsp;Advanced Namespace Configuration">Security Filter Chain</a>.</p>
<p>It&#8217;s important to realise that these unsecured requests will be completely oblivious to any Spring Security web-related configuration or additional attributes such as <code class="literal">requires-channel</code>, so you will not be able to access information on the current user or call secured methods during the request. Use <code class="literal">access='IS_AUTHENTICATED_ANONYMOUSLY'</code> as an alternative if you still want the security filter chain to be applied.</p>
<p>If you want to use basic authentication instead of form login, then change the configuration to</p>
<pre class="programlisting"><span class="hl-tag">&lt;http</span> <span class="hl-attribute">use-expressions</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/**"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;http-basic /&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>Basic authentication will then take precedence and will be used to prompt for a login when a user attempts to access a protected resource. Form login is still available in this configuration if you wish to use it, for example through a login form embedded in another web page.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="ns-form-target" href="index.html#ns-form-target"></a>Setting a Default Post-Login Destination</h4></div></div></div>
<p>If a form login isn&#8217;t prompted by an attempt to access a protected resource, the <code class="literal">default-target-url</code> option comes into play. This is the URL the user will be taken to after successfully logging in, and defaults to "/". You can also configure things so that the user <span class="emphasis"><em>always</em></span> ends up at this page (regardless of whether the login was "on-demand" or they explicitly chose to log in) by setting the <code class="literal">always-use-default-target</code> attribute to "true". This is useful if your application always requires that the user starts at a "home" page, for example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/login.htm*"</span> <span class="hl-attribute">security</span>=<span class="hl-value">"none"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;http</span> <span class="hl-attribute">use-expressions</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">'/**'</span> <span class="hl-attribute">access</span>=<span class="hl-value">'ROLE_USER'</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;form-login</span> <span class="hl-attribute">login-page</span>=<span class="hl-value">'/login.htm'</span> <span class="hl-attribute">default-target-url</span>=<span class="hl-value">'/home.htm'</span>
		<span class="hl-attribute">always-use-default-target</span>=<span class="hl-value">'true'</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>For even more control over the destination, you can use the <code class="literal">authentication-success-handler-ref</code> attribute as an alternative to <code class="literal">default-target-url</code>. The referenced bean should be an instance of <code class="literal">AuthenticationSuccessHandler</code>. You&#8217;ll find more on this in the <a class="link" href="index.html#form-login-flow-handling" title="15.4.1&nbsp;Application Flow on Authentication Success and Failure">Core Filters</a> chapter and also in the namespace appendix, as well as information on how to customize the flow when authentication fails.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ns-logout" href="index.html#ns-logout"></a>6.2.4&nbsp;Logout Handling</h3></div></div></div>
<p>The <code class="literal">logout</code> element adds support for logging out by navigating to a particular URL. The default logout URL is <code class="literal">/logout</code>, but you can set it to something else using the <code class="literal">logout-url</code> attribute. More information on other available attributes may be found in the namespace appendix.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ns-auth-providers" href="index.html#ns-auth-providers"></a>6.2.5&nbsp;Using other Authentication Providers</h3></div></div></div>
<p>In practice you will need a more scalable source of user information than a few names added to the application context file. Most likely you will want to store your user information in something like a database or an LDAP server. LDAP namespace configuration is dealt with in the <a class="link" href="index.html#ldap" title="30.&nbsp;LDAP Authentication">LDAP chapter</a>, so we won&#8217;t cover it here. If you have a custom implementation of Spring Security&#8217;s <code class="literal">UserDetailsService</code>, called "myUserDetailsService" in your application context, then you can authenticate against this using</p>
<pre class="programlisting"><span class="hl-tag">&lt;authentication-manager&gt;</span>
	<span class="hl-tag">&lt;authentication-provider</span> <span class="hl-attribute">user-service-ref</span>=<span class="hl-value">'myUserDetailsService'</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/authentication-manager&gt;</span></pre>
<p>If you want to use a database, then you can use</p>
<pre class="programlisting"><span class="hl-tag">&lt;authentication-manager&gt;</span>
<span class="hl-tag">&lt;authentication-provider&gt;</span>
	<span class="hl-tag">&lt;jdbc-user-service</span> <span class="hl-attribute">data-source-ref</span>=<span class="hl-value">"securityDataSource"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/authentication-provider&gt;</span>
<span class="hl-tag">&lt;/authentication-manager&gt;</span></pre>
<p>Where "securityDataSource" is the name of a <code class="literal">DataSource</code> bean in the application context, pointing at a database containing the standard Spring Security <a class="link" href="index.html#user-schema" title="42.1&nbsp;User Schema">user data tables</a>. Alternatively, you could configure a Spring Security <code class="literal">JdbcDaoImpl</code> bean and point at that using the <code class="literal">user-service-ref</code> attribute:</p>
<pre class="programlisting"><span class="hl-tag">&lt;authentication-manager&gt;</span>
<span class="hl-tag">&lt;authentication-provider</span> <span class="hl-attribute">user-service-ref</span>=<span class="hl-value">'myUserDetailsService'</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/authentication-manager&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myUserDetailsService"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans:bean&gt;</span></pre>
<p>You can also use standard <code class="literal">AuthenticationProvider</code> beans as follows</p>
<pre class="programlisting"><span class="hl-tag">&lt;authentication-manager&gt;</span>
	<span class="hl-tag">&lt;authentication-provider</span> <span class="hl-attribute">ref</span>=<span class="hl-value">'myAuthenticationProvider'</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/authentication-manager&gt;</span></pre>
<p>where <code class="literal">myAuthenticationProvider</code> is the name of a bean in your application context which implements <code class="literal">AuthenticationProvider</code>. You can use multiple <code class="literal">authentication-provider</code> elements, in which case the providers will be queried in the order they are declared. See <a class="xref" href="index.html#ns-auth-manager" title="6.6&nbsp;The Authentication Manager and the Namespace">Section&nbsp;6.6, &#8220;The Authentication Manager and the Namespace&#8221;</a> for more on information on how the Spring Security <code class="literal">AuthenticationManager</code> is configured using the namespace.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="ns-password-encoder" href="index.html#ns-password-encoder"></a>Adding a Password Encoder</h4></div></div></div>
<p>Passwords should always be encoded using a secure hashing algorithm designed for the purpose (not a standard algorithm like SHA or MD5). This is supported by the <code class="literal">&lt;password-encoder&gt;</code> element. With bcrypt encoded passwords, the original authentication provider configuration would look like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bcryptEncoder"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;authentication-manager&gt;</span>
<span class="hl-tag">&lt;authentication-provider&gt;</span>
	<span class="hl-tag">&lt;password-encoder</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"bcryptEncoder"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;user-service&gt;</span>
	<span class="hl-tag">&lt;user</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jimi"</span> <span class="hl-attribute">password</span>=<span class="hl-value">"$2a$10$ddEWZUl8aU0GdZPPpy7wbu82dvEw/pBpbRvDQRqA41y6mK1CoH00m"</span>
			<span class="hl-attribute">authorities</span>=<span class="hl-value">"ROLE_USER, ROLE_ADMIN"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;user</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bob"</span> <span class="hl-attribute">password</span>=<span class="hl-value">"$2a$10$/elFpMBnAYYig6KRR5bvOOYeZr1ie1hSogJryg9qDlhza4oCw1Qka"</span>
			<span class="hl-attribute">authorities</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/user-service&gt;</span>
<span class="hl-tag">&lt;/authentication-provider&gt;</span>
<span class="hl-tag">&lt;/authentication-manager&gt;</span></pre>
<p>bcrypt is a good choice for most cases, unless you have a legacy system which forces you to use a different algorithm. If you are using a simple hashing algorithm or, even worse, storing plain text passwords, then you should consider migrating to a more secure option like bcrypt.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ns-web-advanced" href="index.html#ns-web-advanced"></a>6.3&nbsp;Advanced Web Features</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ns-remember-me" href="index.html#ns-remember-me"></a>6.3.1&nbsp;Remember-Me Authentication</h3></div></div></div>
<p>See the separate <a class="link" href="index.html#remember-me" title="18.&nbsp;Remember-Me Authentication">Remember-Me chapter</a> for information on remember-me namespace configuration.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ns-requires-channel" href="index.html#ns-requires-channel"></a>6.3.2&nbsp;Adding HTTP/HTTPS Channel Security</h3></div></div></div>
<p>If your application supports both HTTP and HTTPS, and you require that particular URLs can only be accessed over HTTPS, then this is directly supported using the <code class="literal">requires-channel</code> attribute on <code class="literal">&lt;intercept-url&gt;</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
<span class="hl-tag">&lt;intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/secure/**"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_USER"</span> <span class="hl-attribute">requires-channel</span>=<span class="hl-value">"https"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/**"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_USER"</span> <span class="hl-attribute">requires-channel</span>=<span class="hl-value">"any"</span><span class="hl-tag">/&gt;</span>
...
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>With this configuration in place, if a user attempts to access anything matching the "/secure/**" pattern using HTTP, they will first be redirected to an HTTPS URL <a href="index.html#ftn.d5e1617" class="footnote" name="d5e1617"><sup class="footnote">[5]</sup></a>. The available options are "http", "https" or "any". Using the value "any" means that either HTTP or HTTPS can be used.</p>
<p>If your application uses non-standard ports for HTTP and/or HTTPS, you can specify a list of port mappings as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
...
<span class="hl-tag">&lt;port-mappings&gt;</span>
	<span class="hl-tag">&lt;port-mapping</span> <span class="hl-attribute">http</span>=<span class="hl-value">"9080"</span> <span class="hl-attribute">https</span>=<span class="hl-value">"9443"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/port-mappings&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>Note that in order to be truly secure, an application should not use HTTP at all or switch between HTTP and HTTPS. It should start in HTTPS (with the user entering an HTTPS URL) and use a secure connection throughout to avoid any possibility of man-in-the-middle attacks.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ns-session-mgmt" href="index.html#ns-session-mgmt"></a>6.3.3&nbsp;Session Management</h3></div></div></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="detecting-timeouts" href="index.html#detecting-timeouts"></a>Detecting Timeouts</h4></div></div></div>
<p>You can configure Spring Security to detect the submission of an invalid session ID and redirect the user to an appropriate URL. This is achieved through the <code class="literal">session-management</code> element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
...
<span class="hl-tag">&lt;session-management</span> <span class="hl-attribute">invalid-session-url</span>=<span class="hl-value">"/invalidSession.htm"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>Note that if you use this mechanism to detect session timeouts, it may falsely report an error if the user logs out and then logs back in without closing the browser. This is because the session cookie is not cleared when you invalidate the session and will be resubmitted even if the user has logged out. You may be able to explicitly delete the JSESSIONID cookie on logging out, for example by using the following syntax in the logout handler:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
<span class="hl-tag">&lt;logout</span> <span class="hl-attribute">delete-cookies</span>=<span class="hl-value">"JSESSIONID"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>Unfortunately this can&#8217;t be guaranteed to work with every servlet container, so you will need to test it in your environment</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you are running your application behind a proxy, you may also be able to remove the session cookie by configuring the proxy server. For example, using Apache HTTPD&#8217;s mod_headers, the following directive would delete the <code class="literal">JSESSIONID</code> cookie by expiring it in the response to a logout request (assuming the application is deployed under the path <code class="literal">/tutorial</code>):</p>
<pre class="programlisting"><span class="hl-tag">&lt;LocationMatch</span> <span class="hl-attribute">"/tutorial/logout"&gt;</span>
<span class="hl-attribute">Header</span> <span class="hl-attribute">always</span> <span class="hl-attribute">set</span> <span class="hl-attribute">Set-Cookie</span> <span class="hl-attribute">"JSESSIONID</span>=<span class="hl-value">;Path=</span><span class="hl-tag">/t</span>utorial;Expires=Thu, 01 Jan 1970 00:00:00 GMT"
<span class="hl-tag">&lt;/LocationMatch&gt;</span></pre>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="ns-concurrent-sessions" href="index.html#ns-concurrent-sessions"></a>Concurrent Session Control</h4></div></div></div>
<p>If you wish to place constraints on a single user&#8217;s ability to log in to your application, Spring Security supports this out of the box with the following simple additions. First you need to add the following listener to your <code class="literal">web.xml</code> file to keep Spring Security updated about session lifecycle events:</p>
<pre class="programlisting"><span class="hl-tag">&lt;listener&gt;</span>
<span class="hl-tag">&lt;listener-class&gt;</span>
	org.springframework.security.web.session.HttpSessionEventPublisher
<span class="hl-tag">&lt;/listener-class&gt;</span>
<span class="hl-tag">&lt;/listener&gt;</span></pre>
<p>Then add the following lines to your application context:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
...
<span class="hl-tag">&lt;session-management&gt;</span>
	<span class="hl-tag">&lt;concurrency-control</span> <span class="hl-attribute">max-sessions</span>=<span class="hl-value">"1"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/session-management&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>This will prevent a user from logging in multiple times - a second login will cause the first to be invalidated. Often you would prefer to prevent a second login, in which case you can use</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
...
<span class="hl-tag">&lt;session-management&gt;</span>
	<span class="hl-tag">&lt;concurrency-control</span> <span class="hl-attribute">max-sessions</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">error-if-maximum-exceeded</span>=<span class="hl-value">"true"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/session-management&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>The second login will then be rejected. By "rejected", we mean that the user will be sent to the <code class="literal">authentication-failure-url</code> if form-based login is being used. If the second authentication takes place through another non-interactive mechanism, such as "remember-me", an "unauthorized" (401) error will be sent to the client. If instead you want to use an error page, you can add the attribute <code class="literal">session-authentication-error-url</code> to the <code class="literal">session-management</code> element.</p>
<p>If you are using a customized authentication filter for form-based login, then you have to configure concurrent session control support explicitly. More details can be found in the <a class="link" href="index.html#session-mgmt" title="22.&nbsp;Session Management">Session Management chapter</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="ns-session-fixation" href="index.html#ns-session-fixation"></a>Session Fixation Attack Protection</h4></div></div></div>
<p><a class="ulink" href="https://en.wikipedia.org/wiki/Session_fixation" target="_top">Session fixation</a> attacks are a potential risk where it is possible for a malicious attacker to create a session by accessing a site, then persuade another user to log in with the same session (by sending them a link containing the session identifier as a parameter, for example). Spring Security protects against this automatically by creating a new session or otherwise changing the session ID when a user logs in. If you don&#8217;t require this protection, or it conflicts with some other requirement, you can control the behavior using the <code class="literal">session-fixation-protection</code> attribute on <code class="literal">&lt;session-management&gt;</code>, which has four options</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">none</code> - Don&#8217;t do anything. The original session will be retained.
</li><li class="listitem">
<code class="literal">newSession</code> - Create a new "clean" session, without copying the existing session data (Spring Security-related attributes will still be copied).
</li><li class="listitem">
<code class="literal">migrateSession</code> - Create a new session and copy all existing session attributes to the new session. This is the default in Servlet 3.0 or older containers.
</li><li class="listitem">
<code class="literal">changeSessionId</code> - Do not create a new session. Instead, use the session fixation protection provided by the Servlet container (<code class="literal">HttpServletRequest#changeSessionId()</code>). This option is only available in Servlet 3.1 (Java EE 7) and newer containers. Specifying it in older containers will result in an exception. This is the default in Servlet 3.1 and newer containers.
</li></ul></div>
<p>When session fixation protection occurs, it results in a <code class="literal">SessionFixationProtectionEvent</code> being published in the application context. If you use <code class="literal">changeSessionId</code>, this protection will <span class="emphasis"><em>also</em></span> result in any <code class="literal">javax.servlet.http.HttpSessionIdListener</code> s being notified, so use caution if your code listens for both events. See the <a class="link" href="index.html#session-mgmt" title="22.&nbsp;Session Management">Session Management</a> chapter for additional information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ns-openid" href="index.html#ns-openid"></a>6.3.4&nbsp;OpenID Support</h3></div></div></div>
<p>The namespace supports <a class="ulink" href="https://openid.net/" target="_top">OpenID</a> login either instead of, or in addition to normal form-based login, with a simple change:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
<span class="hl-tag">&lt;intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/**"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;openid-login /&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>You should then register yourself with an OpenID provider (such as myopenid.com), and add the user information to your in-memory <code class="literal">&lt;user-service&gt;</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;user</span> <span class="hl-attribute">name</span>=<span class="hl-value">"http://jimi.hendrix.myopenid.com/"</span> <span class="hl-attribute">authorities</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag"> /&gt;</span></pre>
<p>You should be able to login using the <code class="literal">myopenid.com</code> site to authenticate. It is also possible to select a specific <code class="literal">UserDetailsService</code> bean for use OpenID by setting the <code class="literal">user-service-ref</code> attribute on the <code class="literal">openid-login</code> element. See the previous section on <a class="link" href="index.html#ns-auth-providers" title="6.2.5&nbsp;Using other Authentication Providers">authentication providers</a> for more information. Note that we have omitted the password attribute from the above user configuration, since this set of user data is only being used to load the authorities for the user. A random password will be generated internally, preventing you from accidentally using this user data as an authentication source elsewhere in your configuration.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="attribute-exchange" href="index.html#attribute-exchange"></a>Attribute Exchange</h4></div></div></div>
<p>Support for OpenID <a class="ulink" href="https://openid.net/specs/openid-attribute-exchange-1_0.html" target="_top">attribute exchange</a>. As an example, the following configuration would attempt to retrieve the email and full name from the OpenID provider, for use by the application:</p>
<pre class="programlisting"><span class="hl-tag">&lt;openid-login&gt;</span>
<span class="hl-tag">&lt;attribute-exchange&gt;</span>
	<span class="hl-tag">&lt;openid-attribute</span> <span class="hl-attribute">name</span>=<span class="hl-value">"email"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"http://axschema.org/contact/email"</span> <span class="hl-attribute">required</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;openid-attribute</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"http://axschema.org/namePerson"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/attribute-exchange&gt;</span>
<span class="hl-tag">&lt;/openid-login&gt;</span></pre>
<p>The "type" of each OpenID attribute is a URI, determined by a particular schema, in this case <a class="ulink" href="http://axschema.org/" target="_top">http://axschema.org/</a>. If an attribute must be retrieved for successful authentication, the <code class="literal">required</code> attribute can be set. The exact schema and attributes supported will depend on your OpenID provider. The attribute values are returned as part of the authentication process and can be accessed afterwards using the following code:</p>
<pre class="programlisting">OpenIDAuthenticationToken token =
	(OpenIDAuthenticationToken)SecurityContextHolder.getContext().getAuthentication();
List&lt;OpenIDAttribute&gt; attributes = token.getAttributes();</pre>
<p>The <code class="literal">OpenIDAttribute</code> contains the attribute type and the retrieved value (or values in the case of multi-valued attributes). We&#8217;ll see more about how the <code class="literal">SecurityContextHolder</code> class is used when we look at core Spring Security components in the <a class="link" href="index.html#core-components" title="9.2&nbsp;Core Components">technical overview</a> chapter. Multiple attribute exchange configurations are also be supported, if you wish to use multiple identity providers. You can supply multiple <code class="literal">attribute-exchange</code> elements, using an <code class="literal">identifier-matcher</code> attribute on each. This contains a regular expression which will be matched against the OpenID identifier supplied by the user. See the OpenID sample application in the codebase for an example configuration, providing different attribute lists for the Google, Yahoo and MyOpenID providers.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ns-headers" href="index.html#ns-headers"></a>6.3.5&nbsp;Response Headers</h3></div></div></div>
<p>For additional information on how to customize the headers element refer to the <a class="xref" href="index.html#headers" title="21.&nbsp;Security HTTP Response Headers">Chapter&nbsp;21, <i>Security HTTP Response Headers</i></a> section of the reference.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ns-custom-filters" href="index.html#ns-custom-filters"></a>6.3.6&nbsp;Adding in Your Own Filters</h3></div></div></div>
<p>If you&#8217;ve used Spring Security before, you&#8217;ll know that the framework maintains a chain of filters in order to apply its services. You may want to add your own filters to the stack at particular locations or use a Spring Security filter for which there isn&#8217;t currently a namespace configuration option (CAS, for example). Or you might want to use a customized version of a standard namespace filter, such as the <code class="literal">UsernamePasswordAuthenticationFilter</code> which is created by the <code class="literal">&lt;form-login&gt;</code> element, taking advantage of some of the extra configuration options which are available by using the bean explicitly. How can you do this with namespace configuration, since the filter chain is not directly exposed?</p>
<p>The order of the filters is always strictly enforced when using the namespace. When the application context is being created, the filter beans are sorted by the namespace handling code and the standard Spring Security filters each have an alias in the namespace and a well-known position.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In previous versions, the sorting took place after the filter instances had been created, during post-processing of the application context. In version 3.0+ the sorting is now done at the bean metadata level, before the classes have been instantiated. This has implications for how you add your own filters to the stack as the entire filter list must be known during the parsing of the <code class="literal">&lt;http&gt;</code> element, so the syntax has changed slightly in 3.0.</p>
</td></tr></table></div>
<p>The filters, aliases and namespace elements/attributes which create the filters are shown in <a class="xref" href="index.html#filter-stack" title="Table&nbsp;6.1.&nbsp;Standard Filter Aliases and Ordering">Table&nbsp;6.1, &#8220;Standard Filter Aliases and Ordering&#8221;</a>. The filters are listed in the order in which they occur in the filter chain.</p>
<div class="table"><a name="filter-stack" href="index.html#filter-stack"></a><p class="title"><b>Table&nbsp;6.1.&nbsp;Standard Filter Aliases and Ordering</b></p><div class="table-contents">
<table summary="Standard Filter Aliases and Ordering" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Alias</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Filter Class</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Namespace Element or Attribute</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>CHANNEL_FILTER</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ChannelProcessingFilter</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">http/<a href="https://docs.spring.io/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="4d242339283f2e283d3960383f210d3f283c38243f283e602e252c23232821">[email&#160;protected]</a></code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>SECURITY_CONTEXT_FILTER</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">SecurityContextPersistenceFilter</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">http</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>CONCURRENT_SESSION_FILTER</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ConcurrentSessionFilter</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">session-management/concurrency-control</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HEADERS_FILTER</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">HeaderWriterFilter</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">http/headers</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>CSRF_FILTER</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">CsrfFilter</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">http/csrf</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>LOGOUT_FILTER</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">LogoutFilter</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">http/logout</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>X509_FILTER</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">X509AuthenticationFilter</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">http/x509</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PRE_AUTH_FILTER</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">AbstractPreAuthenticatedProcessingFilter</code> Subclasses</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N/A</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>CAS_FILTER</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">CasAuthenticationFilter</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N/A</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>FORM_LOGIN_FILTER</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">UsernamePasswordAuthenticationFilter</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">http/form-login</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>BASIC_AUTH_FILTER</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">BasicAuthenticationFilter</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">http/http-basic</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>SERVLET_API_SUPPORT_FILTER</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">SecurityContextHolderAwareRequestFilter</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">http/@servlet-api-provision</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>JAAS_API_SUPPORT_FILTER</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">JaasApiIntegrationFilter</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">http/@jaas-api-provision</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>REMEMBER_ME_FILTER</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">RememberMeAuthenticationFilter</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">http/remember-me</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ANONYMOUS_FILTER</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">AnonymousAuthenticationFilter</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">http/anonymous</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>SESSION_MANAGEMENT_FILTER</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">SessionManagementFilter</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">session-management</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>EXCEPTION_TRANSLATION_FILTER</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ExceptionTranslationFilter</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">http</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>FILTER_SECURITY_INTERCEPTOR</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">FilterSecurityInterceptor</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">http</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>SWITCH_USER_FILTER</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">SwitchUserFilter</code></p></td><td style="" align="left" valign="top"><p>N/A</p></td></tr></tbody></table>
</div></div><br class="table-break">
<p>You can add your own filter to the stack, using the <code class="literal">custom-filter</code> element and one of these names to specify the position your filter should appear at:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
<span class="hl-tag">&lt;custom-filter</span> <span class="hl-attribute">position</span>=<span class="hl-value">"FORM_LOGIN_FILTER"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myFilter"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myFilter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.MySpecialAuthenticationFilter"</span><span class="hl-tag">/&gt;</span></pre>
<p>You can also use the <code class="literal">after</code> or <code class="literal">before</code> attributes if you want your filter to be inserted before or after another filter in the stack. The names "FIRST" and "LAST" can be used with the <code class="literal">position</code> attribute to indicate that you want your filter to appear before or after the entire stack, respectively.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip: Avoiding filter position conflicts"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Avoiding filter position conflicts</th></tr><tr><td align="left" valign="top">
<p>If you are inserting a custom filter which may occupy the same position as one of the standard filters created by the namespace then it&#8217;s important that you don&#8217;t include the namespace versions by mistake. Remove any elements which create filters whose functionality you want to replace.</p>
<p>Note that you can&#8217;t replace filters which are created by the use of the <code class="literal">&lt;http&gt;</code> element itself - <code class="literal">SecurityContextPersistenceFilter</code>, <code class="literal">ExceptionTranslationFilter</code> or <code class="literal">FilterSecurityInterceptor</code>. Some other filters are added by default, but you can disable them. An <code class="literal">AnonymousAuthenticationFilter</code> is added by default and unless you have <a class="link" href="index.html#ns-session-fixation" title="Session Fixation Attack Protection">session-fixation protection</a> disabled, a <code class="literal">SessionManagementFilter</code> will also be added to the filter chain.</p>
</td></tr></table></div>
<p>If you&#8217;re replacing a namespace filter which requires an authentication entry point (i.e. where the authentication process is triggered by an attempt by an unauthenticated user to access to a secured resource), you will need to add a custom entry point bean too.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="ns-entry-point-ref" href="index.html#ns-entry-point-ref"></a>Setting a Custom AuthenticationEntryPoint</h4></div></div></div>
<p>If you aren&#8217;t using form login, OpenID or basic authentication through the namespace, you may want to define an authentication filter and entry point using a traditional bean syntax and link them into the namespace, as we&#8217;ve just seen. The corresponding <code class="literal">AuthenticationEntryPoint</code> can be set using the <code class="literal">entry-point-ref</code> attribute on the <code class="literal">&lt;http&gt;</code> element.</p>
<p>The CAS sample application is a good example of the use of custom beans with the namespace, including this syntax. If you aren&#8217;t familiar with authentication entry points, they are discussed in the <a class="link" href="index.html#tech-intro-auth-entry-point" title="9.4.2&nbsp;AuthenticationEntryPoint">technical overview</a> chapter.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ns-method-security" href="index.html#ns-method-security"></a>6.4&nbsp;Method Security</h2></div></div></div>
<p>From version 2.0 onwards Spring Security has improved support substantially for adding security to your service layer methods. It provides support for JSR-250 annotation security as well as the framework&#8217;s original <code class="literal">@Secured</code> annotation. From 3.0 you can also make use of new <a class="link" href="index.html#el-access" title="27.&nbsp;Expression-Based Access Control">expression-based annotations</a>. You can apply security to a single bean, using the <code class="literal">intercept-methods</code> element to decorate the bean declaration, or you can secure multiple beans across the entire service layer using the AspectJ style pointcuts.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ns-global-method" href="index.html#ns-global-method"></a>6.4.1&nbsp;The &lt;global-method-security&gt; Element</h3></div></div></div>
<p>This element is used to enable annotation-based security in your application (by setting the appropriate attributes on the element), and also to group together security pointcut declarations which will be applied across your entire application context. You should only declare one <code class="literal">&lt;global-method-security&gt;</code> element. The following declaration would enable support for Spring Security&#8217;s <code class="literal">@Secured</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;global-method-security</span> <span class="hl-attribute">secured-annotations</span>=<span class="hl-value">"enabled"</span><span class="hl-tag"> /&gt;</span></pre>
<p>Adding an annotation to a method (on an class or interface) would then limit the access to that method accordingly. Spring Security&#8217;s native annotation support defines a set of attributes for the method. These will be passed to the <code class="literal">AccessDecisionManager</code> for it to make the actual decision:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> BankService {

<em><span class="hl-annotation" style="color: gray">@Secured("IS_AUTHENTICATED_ANONYMOUSLY")</span></em>
<span class="hl-keyword">public</span> Account readAccount(Long id);

<em><span class="hl-annotation" style="color: gray">@Secured("IS_AUTHENTICATED_ANONYMOUSLY")</span></em>
<span class="hl-keyword">public</span> Account[] findAccounts();

<em><span class="hl-annotation" style="color: gray">@Secured("ROLE_TELLER")</span></em>
<span class="hl-keyword">public</span> Account post(Account account, <span class="hl-keyword">double</span> amount);
}</pre>
<p>Support for JSR-250 annotations can be enabled using</p>
<pre class="programlisting"><span class="hl-tag">&lt;global-method-security</span> <span class="hl-attribute">jsr250-annotations</span>=<span class="hl-value">"enabled"</span><span class="hl-tag"> /&gt;</span></pre>
<p>These are standards-based and allow simple role-based constraints to be applied but do not have the power Spring Security&#8217;s native annotations. To use the new expression-based syntax, you would use</p>
<pre class="programlisting"><span class="hl-tag">&lt;global-method-security</span> <span class="hl-attribute">pre-post-annotations</span>=<span class="hl-value">"enabled"</span><span class="hl-tag"> /&gt;</span></pre>
<p>and the equivalent Java code would be</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> BankService {

<em><span class="hl-annotation" style="color: gray">@PreAuthorize("isAnonymous()")</span></em>
<span class="hl-keyword">public</span> Account readAccount(Long id);

<em><span class="hl-annotation" style="color: gray">@PreAuthorize("isAnonymous()")</span></em>
<span class="hl-keyword">public</span> Account[] findAccounts();

<em><span class="hl-annotation" style="color: gray">@PreAuthorize("hasAuthority('ROLE_TELLER')")</span></em>
<span class="hl-keyword">public</span> Account post(Account account, <span class="hl-keyword">double</span> amount);
}</pre>
<p>Expression-based annotations are a good choice if you need to define simple rules that go beyond checking the role names against the user&#8217;s list of authorities.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The annotated methods will only be secured for instances which are defined as Spring beans (in the same application context in which method-security is enabled). If you want to secure instances which are not created by Spring (using the <code class="literal">new</code> operator, for example) then you need to use AspectJ.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You can enable more than one type of annotation in the same application, but only one type should be used for any interface or class as the behaviour will not be well-defined otherwise. If two annotations are found which apply to a particular method, then only one of them will be applied.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="ns-protect-pointcut" href="index.html#ns-protect-pointcut"></a>Adding Security Pointcuts using protect-pointcut</h4></div></div></div>
<p>The use of <code class="literal">protect-pointcut</code> is particularly powerful, as it allows you to apply security to many beans with only a simple declaration. Consider the following example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;global-method-security&gt;</span>
<span class="hl-tag">&lt;protect-pointcut</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* com.mycompany.*Service.*(..))"</span>
	<span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/global-method-security&gt;</span></pre>
<p>This will protect all methods on beans declared in the application context whose classes are in the <code class="literal">com.mycompany</code> package and whose class names end in "Service". Only users with the <code class="literal">ROLE_USER</code> role will be able to invoke these methods. As with URL matching, the most specific matches must come first in the list of pointcuts, as the first matching expression will be used. Security annotations take precedence over pointcuts.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ns-access-manager" href="index.html#ns-access-manager"></a>6.5&nbsp;The Default AccessDecisionManager</h2></div></div></div>
<p>This section assumes you have some knowledge of the underlying architecture for access-control within Spring Security. If you don&#8217;t you can skip it and come back to it later, as this section is only really relevant for people who need to do some customization in order to use more than simple role-based security.</p>
<p>When you use a namespace configuration, a default instance of <code class="literal">AccessDecisionManager</code> is automatically registered for you and will be used for making access decisions for method invocations and web URL access, based on the access attributes you specify in your <code class="literal">intercept-url</code> and <code class="literal">protect-pointcut</code> declarations (and in annotations if you are using annotation secured methods).</p>
<p>The default strategy is to use an <code class="literal">AffirmativeBased</code> <code class="literal">AccessDecisionManager</code> with a <code class="literal">RoleVoter</code> and an <code class="literal">AuthenticatedVoter</code>. You can find out more about these in the chapter on <a class="link" href="index.html#authz-arch" title="25.&nbsp;Authorization Architecture">authorization</a>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ns-custom-access-mgr" href="index.html#ns-custom-access-mgr"></a>6.5.1&nbsp;Customizing the AccessDecisionManager</h3></div></div></div>
<p>If you need to use a more complicated access control strategy then it is easy to set an alternative for both method and web security.</p>
<p>For method security, you do this by setting the <code class="literal">access-decision-manager-ref</code> attribute on <code class="literal">global-method-security</code> to the <code class="literal">id</code> of the appropriate <code class="literal">AccessDecisionManager</code> bean in the application context:</p>
<pre class="programlisting"><span class="hl-tag">&lt;global-method-security</span> <span class="hl-attribute">access-decision-manager-ref</span>=<span class="hl-value">"myAccessDecisionManagerBean"</span><span class="hl-tag">&gt;</span>
...
<span class="hl-tag">&lt;/global-method-security&gt;</span></pre>
<p>The syntax for web security is the same, but on the <code class="literal">http</code> element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http</span> <span class="hl-attribute">access-decision-manager-ref</span>=<span class="hl-value">"myAccessDecisionManagerBean"</span><span class="hl-tag">&gt;</span>
...
<span class="hl-tag">&lt;/http&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ns-auth-manager" href="index.html#ns-auth-manager"></a>6.6&nbsp;The Authentication Manager and the Namespace</h2></div></div></div>
<p>The main interface which provides authentication services in Spring Security is the <code class="literal">AuthenticationManager</code>. This is usually an instance of Spring Security&#8217;s <code class="literal">ProviderManager</code> class, which you may already be familiar with if you&#8217;ve used the framework before. If not, it will be covered later, in the <a class="link" href="index.html#tech-intro-authentication" title="9.3&nbsp;Authentication">technical overview chapter</a>. The bean instance is registered using the <code class="literal">authentication-manager</code> namespace element. You can&#8217;t use a custom <code class="literal">AuthenticationManager</code> if you are using either HTTP or method security through the namespace, but this should not be a problem as you have full control over the <code class="literal">AuthenticationProvider</code> s that are used.</p>
<p>You may want to register additional <code class="literal">AuthenticationProvider</code> beans with the <code class="literal">ProviderManager</code> and you can do this using the <code class="literal">&lt;authentication-provider&gt;</code> element with the <code class="literal">ref</code> attribute, where the value of the attribute is the name of the provider bean you want to add. For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;authentication-manager&gt;</span>
<span class="hl-tag">&lt;authentication-provider</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"casAuthenticationProvider"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/authentication-manager&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"casAuthenticationProvider"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.cas.authentication.CasAuthenticationProvider"</span><span class="hl-tag">&gt;</span>
...
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>Another common requirement is that another bean in the context may require a reference to the <code class="literal">AuthenticationManager</code>. You can easily register an alias for the <code class="literal">AuthenticationManager</code> and use this name elsewhere in your application context.</p>
<pre class="programlisting"><span class="hl-tag">&lt;security:authentication-manager</span> <span class="hl-attribute">alias</span>=<span class="hl-value">"authenticationManager"</span><span class="hl-tag">&gt;</span>
...
<span class="hl-tag">&lt;/security:authentication-manager&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customizedFormLoginFilter"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"com.somecompany.security.web.CustomFormLoginFilter"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authenticationManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"authenticationManager"</span><span class="hl-tag">/&gt;</span>
...
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.d5e1434" class="footnote"><p><a href="index.html#d5e1434" class="simpara"><sup class="simpara">[1] </sup></a>You can find out more about the use of the <code class="literal">ldap-server</code> element in the chapter on <a class="xref" href="index.html#ldap" title="30.&nbsp;LDAP Authentication">Chapter&nbsp;30, <i>LDAP Authentication</i></a>.</p></div><div id="ftn.d5e1489" class="footnote"><p><a href="index.html#d5e1489" class="simpara"><sup class="simpara">[2] </sup></a>See the section on <a class="xref" href="index.html#request-matching" title="14.4&nbsp;Request Matching and HttpFirewall">Section&nbsp;14.4, &#8220;Request Matching and HttpFirewall&#8221;</a> in the Web Application Infrastructure chapter for more details on how matches are actually performed.</p></div><div id="ftn.d5e1534" class="footnote"><p><a href="index.html#d5e1534" class="simpara"><sup class="simpara">[3] </sup></a>See the chapter on <a class="xref" href="index.html#anonymous" title="23.&nbsp;Anonymous Authentication">Chapter&nbsp;23, <i>Anonymous Authentication</i></a></p></div><div id="ftn.d5e1545" class="footnote"><p><a href="index.html#d5e1545" class="simpara"><sup class="simpara">[4] </sup></a>The use of multiple <code class="literal">&lt;http&gt;</code> elements is an important feature, allowing the namespace to simultaneously support both stateful and stateless paths within the same application, for example. The previous syntax, using the attribute <code class="literal">filters="none"</code> on an <code class="literal">intercept-url</code> element is incompatible with this change and is no longer supported in 3.1.</p></div><div id="ftn.d5e1617" class="footnote"><p><a href="index.html#d5e1617" class="simpara"><sup class="simpara">[5] </sup></a>For more details on how channel-processing is implemented, see the Javadoc for <code class="literal">ChannelProcessingFilter</code> and related classes.</p></div></div></div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="sample-apps" href="index.html#sample-apps"></a>7.&nbsp;Sample Applications</h2></div></div></div>
<p>There are several sample web applications that are available with the project. To avoid an overly large download, only the "tutorial" and "contacts" samples are included in the distribution zip file. The others can be built directly from the source which you can obtain as described in <a class="link" href="index.html#get-source" title="2.4.4&nbsp;Checking out the Source">the introduction</a>. It&#8217;s easy to build the project yourself and there&#8217;s more information on the project web site at <a class="ulink" href="https://spring.io/spring-security/" target="_top">http://spring.io/spring-security/</a>. All paths referred to in this chapter are relative to the project source directory.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tutorial-sample" href="index.html#tutorial-sample"></a>7.1&nbsp;Tutorial Sample</h2></div></div></div>
<p>The tutorial sample is a nice basic example to get you started. It uses simple namespace configuration throughout. The compiled application is included in the distribution zip file, ready to be deployed into your web container (<code class="literal">spring-security-samples-tutorial-3.1.x.war</code>). The <a class="link" href="index.html#ns-form-and-basic" title="6.2.3&nbsp;Form and Basic Login Options">form-based</a> authentication mechanism is used in combination with the commonly-used <a class="link" href="index.html#remember-me" title="18.&nbsp;Remember-Me Authentication">remember-me</a> authentication provider to automatically remember the login using cookies.</p>
<p>We recommend you start with the tutorial sample, as the XML is minimal and easy to follow. Most importantly, you can easily add this one XML file (and its corresponding <code class="literal">web.xml</code> entries) to your existing application. Only when this basic integration is achieved do we suggest you attempt adding in method authorization or domain object security.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="contacts-sample" href="index.html#contacts-sample"></a>7.2&nbsp;Contacts</h2></div></div></div>
<p>The Contacts Sample is an advanced example in that it illustrates the more powerful features of domain object access control lists (ACLs) in addition to basic application security. The application provides an interface with which the users are able to administer a simple database of contacts (the domain objects).</p>
<p>To deploy, simply copy the WAR file from Spring Security distribution into your container&#8217;s <code class="literal">webapps</code> directory. The war should be called <code class="literal">spring-security-samples-contacts-3.1.x.war</code> (the appended version number will vary depending on what release you are using).</p>
<p>After starting your container, check the application can load. Visit <a class="ulink" href="http://localhost:8080/contacts" target="_top">http://localhost:8080/contacts</a> (or whichever URL is appropriate for your web container and the WAR you deployed).</p>
<p>Next, click "Debug". You will be prompted to authenticate, and a series of usernames and passwords are suggested on that page. Simply authenticate with any of these and view the resulting page. It should contain a success message similar to the following:</p>
<pre class="screen">Security Debug Information

Authentication object is of type:
org.springframework.security.authentication.UsernamePasswordAuthenticationToken

Authentication object as a String:

org.springframew<a href="https://docs.spring.io/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="ff908d94d18c9a9c8a8d968b86d19e8a8b979a918b969c9e8b969091d1aa8c9a8d919e929aaf9e8c8c88908d9bbe8a8b979a918b969c9e8b969091ab90949a91bf">[email&#160;protected]</a>1f127853:
Principal: <a href="https://docs.spring.io/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d1bea3b6ffa2a1a3b8bfb6b7a3b0bcb4a6bea3baffa2b4b2a4a3b8a5a8ffb2bea3b4ffa4a2b4a3b5b4a5b0b8bda2ff84a2b4a391b3e1e6b4b5e1e1">[email&#160;protected]</a>: Username: rod; \
Password: [PROTECTED]; Enabled: true; AccountNonExpired: true;
credentialsNonExpired: true; AccountNonLocked: true; \
Granted Authorities: ROLE_SUPERVISOR, ROLE_USER; \
Password: [PROTECTED]; Authenticated: true; \
Details: org.sprin<a href="https://docs.spring.io/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="0d6a6b7f6c60687a627f66237e686e787f647974237a686f236c787965686379646e6c79646263235a686f4c787965686379646e6c796462634968796c64617e4d">[email&#160;protected]</a>0: \
RemoteIpAddress: 127.0.0.1; SessionId: 8fkp8t83ohar; \
Granted Authorities: ROLE_SUPERVISOR, ROLE_USER

Authentication object holds the following granted authorities:

ROLE_SUPERVISOR (getAuthority(): ROLE_SUPERVISOR)
ROLE_USER (getAuthority(): ROLE_USER)

Success! Your web filters appear to be properly configured!</pre>
<p>Once you successfully receive the above message, return to the sample application&#8217;s home page and click "Manage". You can then try out the application. Notice that only the contacts available to the currently logged on user are displayed, and only users with <code class="literal">ROLE_SUPERVISOR</code> are granted access to delete their contacts. Behind the scenes, the <code class="literal">MethodSecurityInterceptor</code> is securing the business objects.</p>
<p>The application allows you to modify the access control lists associated with different contacts. Be sure to give this a try and understand how it works by reviewing the application context XML files.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ldap-sample" href="index.html#ldap-sample"></a>7.3&nbsp;LDAP Sample</h2></div></div></div>
<p>The LDAP sample application provides a basic configuration and sets up both a namespace configuration and an equivalent configuration using traditional beans, both in the same application context file. This means there are actually two identical authentication providers configured in this application.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="openid-sample" href="index.html#openid-sample"></a>7.4&nbsp;OpenID Sample</h2></div></div></div>
<p>The OpenID sample demonstrates how to use the namespace to configure OpenID and how to set up <a class="ulink" href="https://openid.net/specs/openid-attribute-exchange-1_0.html" target="_top">attribute exchange</a> configurations for Google, Yahoo and MyOpenID identity providers (you can experiment with adding others if you wish). It uses the JQuery-based <a class="ulink" href="https://code.google.com/p/openid-selector/" target="_top">openid-selector</a> project to provide a user-friendly login page which allows the user to easily select a provider, rather than typing in the full OpenID identifier.</p>
<p>The application differs from normal authentication scenarios in that it allows any user to access the site (provided their OpenID authentication is successful). The first time you login, you will get a "Welcome [your name]"" message. If you logout and log back in (with the same OpenID identity) then this should change to "Welcome Back". This is achieved by using a custom <code class="literal">UserDetailsService</code> which assigns a standard role to any user and stores the identities internally in a map. Obviously a real application would use a database instead. Have a look at the source form more information. This class also takes into account the fact that different attributes may be returned from different providers and builds the name with which it addresses the user accordingly.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="cas-sample" href="index.html#cas-sample"></a>7.5&nbsp;CAS Sample</h2></div></div></div>
<p>The CAS sample requires that you run both a CAS server and CAS client. It isn&#8217;t included in the distribution so you should check out the project code as described in <a class="link" href="index.html#get-source" title="2.4.4&nbsp;Checking out the Source">the introduction</a>. You&#8217;ll find the relevant files under the <code class="literal">sample/cas</code> directory. There&#8217;s also a <code class="literal">Readme.txt</code> file in there which explains how to run both the server and the client directly from the source tree, complete with SSL support.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jaas-sample" href="index.html#jaas-sample"></a>7.6&nbsp;JAAS Sample</h2></div></div></div>
<p>The JAAS sample is very simple example of how to use a JAAS LoginModule with Spring Security. The provided LoginModule will successfully authenticate a user if the username equals the password otherwise a LoginException is thrown. The AuthorityGranter used in this example always grants the role ROLE_USER. The sample application also demonstrates how to run as the JAAS Subject returned by the LoginModule by setting <a class="link" href="index.html#nsa-http-jaas-api-provision">jaas-api-provision</a> equal to "true".</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="preauth-sample" href="index.html#preauth-sample"></a>7.7&nbsp;Pre-Authentication Sample</h2></div></div></div>
<p>This sample application demonstrates how to wire up beans from the <a class="link" href="index.html#preauth" title="29.&nbsp;Pre-Authentication Scenarios">pre-authentication</a> framework to make use of login information from a Java EE container. The user name and roles are those setup by the container.</p>
<p>The code is in <code class="literal">samples/preauth</code>.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="community" href="index.html#community"></a>8.&nbsp;Spring Security Community</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jira" href="index.html#jira"></a>8.1&nbsp;Issue Tracking</h2></div></div></div>
<p>Spring Security uses JIRA to manage bug reports and enhancement requests. If you find a bug, please log a report using JIRA. Do not log it on the support forum, mailing list or by emailing the project&#8217;s developers. Such approaches are ad-hoc and we prefer to manage bugs using a more formal process.</p>
<p>If possible, in your issue report please provide a JUnit test that demonstrates any incorrect behaviour. Or, better yet, provide a patch that corrects the issue. Similarly, enhancements are welcome to be logged in the issue tracker, although we only accept enhancement requests if you include corresponding unit tests. This is necessary to ensure project test coverage is adequately maintained.</p>
<p>You can access the issue tracker at <a class="ulink" href="https://github.com/spring-projects/spring-security/issues" target="_top">https://github.com/spring-projects/spring-security/issues</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="becoming-involved" href="index.html#becoming-involved"></a>8.2&nbsp;Becoming Involved</h2></div></div></div>
<p>We welcome your involvement in the Spring Security project. There are many ways of contributing, including reading the forum and responding to questions from other people, writing new code, improving existing code, assisting with documentation, developing samples or tutorials, or simply making suggestions.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="further-info" href="index.html#further-info"></a>8.3&nbsp;Further Information</h2></div></div></div>
<p>Questions and comments on Spring Security are welcome. You can use the Spring at Stack Overflow web site at <a class="ulink" href="https://spring.io/questions" target="_top">http://spring.io/questions</a> to discuss Spring Security with other users of the framework. Remember to use JIRA for bug reports, as explained above.</p>
</div>
</div>
</div>
<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="overall-architecture" href="index.html#overall-architecture"></a>Part&nbsp;II.&nbsp;Architecture and Implementation</h1></div></div></div>
<div class="partintro"><div></div>
<p>Once you are familiar with setting up and running some namespace-configuration based applications, you may wish to develop more of an understanding of how the framework actually works behind the namespace facade. Like most software, Spring Security has certain central interfaces, classes and conceptual abstractions that are commonly used throughout the framework. In this part of the reference guide we will look at some of these and see how they work together to support authentication and access-control within Spring Security.</p>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="technical-overview" href="index.html#technical-overview"></a>9.&nbsp;Technical Overview</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="runtime-environment" href="index.html#runtime-environment"></a>9.1&nbsp;Runtime Environment</h2></div></div></div>
<p>Spring Security 3.0 requires a Java 5.0 Runtime Environment or higher. As Spring Security aims to operate in a self-contained manner, there is no need to place any special configuration files into your Java Runtime Environment. In particular, there is no need to configure a special Java Authentication and Authorization Service (JAAS) policy file or place Spring Security into common classpath locations.</p>
<p>Similarly, if you are using an EJB Container or Servlet Container there is no need to put any special configuration files anywhere, nor include Spring Security in a server classloader. All the required files will be contained within your application.</p>
<p>This design offers maximum deployment time flexibility, as you can simply copy your target artifact (be it a JAR, WAR or EAR) from one system to another and it will immediately work.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="core-components" href="index.html#core-components"></a>9.2&nbsp;Core Components</h2></div></div></div>
<p>In Spring Security 3.0, the contents of the <code class="literal">spring-security-core</code> jar were stripped down to the bare minimum. It no longer contains any code related to web-application security, LDAP or namespace configuration. We&#8217;ll take a look here at some of the Java types that you&#8217;ll find in the core module. They represent the building blocks of the framework, so if you ever need to go beyond a simple namespace configuration then it&#8217;s important that you understand what they are, even if you don&#8217;t actually need to interact with them directly.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="securitycontextholder-securitycontext-and-authentication-objects" href="index.html#securitycontextholder-securitycontext-and-authentication-objects"></a>9.2.1&nbsp;SecurityContextHolder, SecurityContext and Authentication Objects</h3></div></div></div>
<p>The most fundamental object is <code class="literal">SecurityContextHolder</code>. This is where we store details of the present security context of the application, which includes details of the principal currently using the application. By default the <code class="literal">SecurityContextHolder</code> uses a <code class="literal">ThreadLocal</code> to store these details, which means that the security context is always available to methods in the same thread of execution, even if the security context is not explicitly passed around as an argument to those methods. Using a <code class="literal">ThreadLocal</code> in this way is quite safe if care is taken to clear the thread after the present principal&#8217;s request is processed. Of course, Spring Security takes care of this for you automatically so there is no need to worry about it.</p>
<p>Some applications aren&#8217;t entirely suitable for using a <code class="literal">ThreadLocal</code>, because of the specific way they work with threads. For example, a Swing client might want all threads in a Java Virtual Machine to use the same security context. <code class="literal">SecurityContextHolder</code> can be configured with a strategy on startup to specify how you would like the context to be stored. For a standalone application you would use the <code class="literal">SecurityContextHolder.MODE_GLOBAL</code> strategy. Other applications might want to have threads spawned by the secure thread also assume the same security identity. This is achieved by using <code class="literal">SecurityContextHolder.MODE_INHERITABLETHREADLOCAL</code>. You can change the mode from the default <code class="literal">SecurityContextHolder.MODE_THREADLOCAL</code> in two ways. The first is to set a system property, the second is to call a static method on <code class="literal">SecurityContextHolder</code>. Most applications won&#8217;t need to change from the default, but if you do, take a look at the JavaDoc for <code class="literal">SecurityContextHolder</code> to learn more.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="obtaining-information-about-the-current-user" href="index.html#obtaining-information-about-the-current-user"></a>Obtaining information about the current user</h4></div></div></div>
<p>Inside the <code class="literal">SecurityContextHolder</code> we store details of the principal currently interacting with the application. Spring Security uses an <code class="literal">Authentication</code> object to represent this information. You won&#8217;t normally need to create an <code class="literal">Authentication</code> object yourself, but it is fairly common for users to query the <code class="literal">Authentication</code> object. You can use the following code block - from anywhere in your application - to obtain the name of the currently authenticated user, for example:</p>
<pre class="programlisting">Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();

<span class="hl-keyword">if</span> (principal <span class="hl-keyword">instanceof</span> UserDetails) {
String username = ((UserDetails)principal).getUsername();
} <span class="hl-keyword">else</span> {
String username = principal.toString();
}</pre>
<p>The object returned by the call to <code class="literal">getContext()</code> is an instance of the <code class="literal">SecurityContext</code> interface. This is the object that is kept in thread-local storage. As we&#8217;ll see below, most authentication mechanisms within Spring Security return an instance of <code class="literal">UserDetails</code> as the principal.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tech-userdetailsservice" href="index.html#tech-userdetailsservice"></a>9.2.2&nbsp;The UserDetailsService</h3></div></div></div>
<p>Another item to note from the above code fragment is that you can obtain a principal from the <code class="literal">Authentication</code> object. The principal is just an <code class="literal">Object</code>. Most of the time this can be cast into a <code class="literal">UserDetails</code> object. <code class="literal">UserDetails</code> is a core interface in Spring Security. It represents a principal, but in an extensible and application-specific way. Think of <code class="literal">UserDetails</code> as the adapter between your own user database and what Spring Security needs inside the <code class="literal">SecurityContextHolder</code>. Being a representation of something from your own user database, quite often you will cast the <code class="literal">UserDetails</code> to the original object that your application provided, so you can call business-specific methods (like <code class="literal">getEmail()</code>, <code class="literal">getEmployeeNumber()</code> and so on).</p>
<p>By now you&#8217;re probably wondering, so when do I provide a <code class="literal">UserDetails</code> object? How do I do that? I thought you said this thing was declarative and I didn&#8217;t need to write any Java code - what gives? The short answer is that there is a special interface called <code class="literal">UserDetailsService</code>. The only method on this interface accepts a <code class="literal">String</code>-based username argument and returns a <code class="literal">UserDetails</code>:</p>
<pre class="programlisting">UserDetails loadUserByUsername(String username) <span class="hl-keyword">throws</span> UsernameNotFoundException;</pre>
<p>This is the most common approach to loading information for a user within Spring
Security and you will see it used throughout the framework whenever information on a
user is required.</p>
<p>On successful authentication, <code class="literal">UserDetails</code> is used to build the <code class="literal">Authentication</code> object that is stored in the <code class="literal">SecurityContextHolder</code> (more on this <a class="link" href="index.html#tech-intro-authentication" title="9.3&nbsp;Authentication">below</a>). The good news is that we provide a number of <code class="literal">UserDetailsService</code> implementations, including one that uses an in-memory map (<code class="literal">InMemoryDaoImpl</code>) and another that uses JDBC (<code class="literal">JdbcDaoImpl</code>). Most users tend to write their own, though, with their implementations often simply sitting on top of an existing Data Access Object (DAO) that represents their employees, customers, or other users of the application. Remember the advantage that whatever your <code class="literal">UserDetailsService</code> returns can always be obtained from the <code class="literal">SecurityContextHolder</code> using the above code fragment.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>There is often some confusion about <code class="literal">UserDetailsService</code>. It is purely a DAO for user data and performs no other function other than to supply that data to other components within the framework. In particular, it <span class="emphasis"><em>does not</em></span> authenticate the user, which is done by the <code class="literal">AuthenticationManager</code>. In many cases it makes more sense to <a class="link" href="index.html#core-services-authentication-manager" title="10.1&nbsp;The AuthenticationManager, ProviderManager and AuthenticationProvider">implement <code class="literal">AuthenticationProvider</code></a> directly if you require a custom authentication process.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tech-granted-authority" href="index.html#tech-granted-authority"></a>9.2.3&nbsp;GrantedAuthority</h3></div></div></div>
<p>Besides the principal, another important method provided by <code class="literal">Authentication</code> is <code class="literal">getAuthorities()</code>. This method provides an array of <code class="literal">GrantedAuthority</code> objects. A <code class="literal">GrantedAuthority</code> is, not surprisingly, an authority that is granted to the principal. Such authorities are usually "roles", such as <code class="literal">ROLE_ADMINISTRATOR</code> or <code class="literal">ROLE_HR_SUPERVISOR</code>. These roles are later on configured for web authorization, method authorization and domain object authorization. Other parts of Spring Security are capable of interpreting these authorities, and expect them to be present. <code class="literal">GrantedAuthority</code> objects are usually loaded by the <code class="literal">UserDetailsService</code>.</p>
<p>Usually the <code class="literal">GrantedAuthority</code> objects are application-wide permissions. They are not specific to a given domain object. Thus, you wouldn&#8217;t likely have a <code class="literal">GrantedAuthority</code> to represent a permission to <code class="literal">Employee</code> object number 54, because if there are thousands of such authorities you would quickly run out of memory (or, at the very least, cause the application to take a long time to authenticate a user). Of course, Spring Security is expressly designed to handle this common requirement, but you&#8217;d instead use the project&#8217;s domain object security capabilities for this purpose.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="summary" href="index.html#summary"></a>9.2.4&nbsp;Summary</h3></div></div></div>
<p>Just to recap, the major building blocks of Spring Security that we&#8217;ve seen so far are:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">SecurityContextHolder</code>, to provide access to the <code class="literal">SecurityContext</code>.
</li><li class="listitem">
<code class="literal">SecurityContext</code>, to hold the <code class="literal">Authentication</code> and possibly request-specific security information.
</li><li class="listitem">
<code class="literal">Authentication</code>, to represent the principal in a Spring Security-specific manner.
</li><li class="listitem">
<code class="literal">GrantedAuthority</code>, to reflect the application-wide permissions granted to a principal.
</li><li class="listitem">
<code class="literal">UserDetails</code>, to provide the necessary information to build an Authentication object from your application&#8217;s DAOs or other source of security data.
</li><li class="listitem">
<code class="literal">UserDetailsService</code>, to create a <code class="literal">UserDetails</code> when passed in a <code class="literal">String</code>-based username (or certificate ID or the like).
</li></ul></div>
<p>Now that you&#8217;ve gained an understanding of these repeatedly-used components, let&#8217;s take a closer look at the process of authentication.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tech-intro-authentication" href="index.html#tech-intro-authentication"></a>9.3&nbsp;Authentication</h2></div></div></div>
<p>Spring Security can participate in many different authentication environments. While we recommend people use Spring Security for authentication and not integrate with existing Container Managed Authentication, it is nevertheless supported - as is integrating with your own proprietary authentication system.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="what-is-authentication-in-spring-security" href="index.html#what-is-authentication-in-spring-security"></a>9.3.1&nbsp;What is authentication in Spring Security?</h3></div></div></div>
<p>Let&#8217;s consider a standard authentication scenario that everyone is familiar with.</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
A user is prompted to log in with a username and password.
</li><li class="listitem">
The system (successfully) verifies that the password is correct for the username.
</li><li class="listitem">
The context information for that user is obtained (their list of roles and so on).
</li><li class="listitem">
A security context is established for the user
</li><li class="listitem">
The user proceeds, potentially to perform some operation which is potentially protected by an access control mechanism which checks the required permissions for the operation against the current security context information.
</li></ol></div>
<p>The first three items constitute the authentication process so we&#8217;ll take a look at how these take place within Spring Security.</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
The username and password are obtained and combined into an instance of <code class="literal">UsernamePasswordAuthenticationToken</code> (an instance of the <code class="literal">Authentication</code> interface, which we saw earlier).
</li><li class="listitem">
The token is passed to an instance of <code class="literal">AuthenticationManager</code> for validation.
</li><li class="listitem">
The <code class="literal">AuthenticationManager</code> returns a fully populated <code class="literal">Authentication</code> instance on successful authentication.
</li><li class="listitem">
The security context is established by calling <code class="literal">SecurityContextHolder.getContext().setAuthentication(&#8230;&#8203;)</code>, passing in the returned authentication object.
</li></ol></div>
<p>From that point on, the user is considered to be authenticated. Let&#8217;s look at some code as an example.</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.security.authentication.*;
<span class="hl-keyword">import</span> org.springframework.security.core.*;
<span class="hl-keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;
<span class="hl-keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AuthenticationExample {
<span class="hl-keyword">private</span> <span class="hl-keyword">static</span> AuthenticationManager am = <span class="hl-keyword">new</span> SampleAuthenticationManager();

<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) <span class="hl-keyword">throws</span> Exception {
	BufferedReader in = <span class="hl-keyword">new</span> BufferedReader(<span class="hl-keyword">new</span> InputStreamReader(System.in));

	<span class="hl-keyword">while</span>(true) {
	System.out.println(<span class="hl-string">"Please enter your username:"</span>);
	String name = in.readLine();
	System.out.println(<span class="hl-string">"Please enter your password:"</span>);
	String password = in.readLine();
	<span class="hl-keyword">try</span> {
		Authentication request = <span class="hl-keyword">new</span> UsernamePasswordAuthenticationToken(name, password);
		Authentication result = am.authenticate(request);
		SecurityContextHolder.getContext().setAuthentication(result);
		<span class="hl-keyword">break</span>;
	} <span class="hl-keyword">catch</span>(AuthenticationException e) {
		System.out.println(<span class="hl-string">"Authentication failed: "</span> + e.getMessage());
	}
	}
	System.out.println(<span class="hl-string">"Successfully authenticated. Security context contains: "</span> +
			SecurityContextHolder.getContext().getAuthentication());
}
}

<span class="hl-keyword">class</span> SampleAuthenticationManager <span class="hl-keyword">implements</span> AuthenticationManager {
<span class="hl-keyword">static</span> <span class="hl-keyword">final</span> List&lt;GrantedAuthority&gt; AUTHORITIES = <span class="hl-keyword">new</span> ArrayList&lt;GrantedAuthority&gt;();

<span class="hl-keyword">static</span> {
	AUTHORITIES.add(<span class="hl-keyword">new</span> SimpleGrantedAuthority(<span class="hl-string">"ROLE_USER"</span>));
}

<span class="hl-keyword">public</span> Authentication authenticate(Authentication auth) <span class="hl-keyword">throws</span> AuthenticationException {
	<span class="hl-keyword">if</span> (auth.getName().equals(auth.getCredentials())) {
	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> UsernamePasswordAuthenticationToken(auth.getName(),
		auth.getCredentials(), AUTHORITIES);
	}
	<span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> BadCredentialsException(<span class="hl-string">"Bad Credentials"</span>);
}
}</pre>
<p>Here
we have written a little program that asks the user to enter a username and password
and performs the above sequence. The
<code class="literal">AuthenticationManager</code> which we&#8217;ve implemented here will authenticate any user whose username and password are the same. It assigns a single role to every user. The output from the above will be something like:</p>
<pre class="programlisting">Please enter your username:
bob
Please enter your password:
password
Authentication failed: Bad Credentials
Please enter your username:
bob
Please enter your password:
bob
Successfully authenticated. Security context contains: \
org.springframew<a href="https://docs.spring.io/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="dfb0adb4f1acbabcaaadb6aba6f1beaaabb7bab1abb6bcbeabb6b0b1f18aacbaadb1beb2ba8fbeacaca8b0adbb9eaaabb7bab1abb6bcbeabb6b0b18bb0b4bab19f">[email&#160;protected]</a>441d0230: \
Principal: bob; Password: [PROTECTED]; \
Authenticated: true; Details: null; \
Granted Authorities: ROLE_USER</pre>
<p>Note that you don&#8217;t normally need to write any code like this. The process will normally occur internally, in a web authentication filter for example. We&#8217;ve just included the code here to show that the question of what actually constitutes authentication in Spring Security has quite a simple answer. A user is authenticated when the <code class="literal">SecurityContextHolder</code> contains a fully populated <code class="literal">Authentication</code> object.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="setting-the-securitycontextholder-contents-directly" href="index.html#setting-the-securitycontextholder-contents-directly"></a>9.3.2&nbsp;Setting the SecurityContextHolder Contents Directly</h3></div></div></div>
<p>In fact, Spring Security doesn&#8217;t mind how you put the <code class="literal">Authentication</code> object inside the <code class="literal">SecurityContextHolder</code>. The only critical requirement is that the <code class="literal">SecurityContextHolder</code> contains an <code class="literal">Authentication</code> which represents a principal before the <code class="literal">AbstractSecurityInterceptor</code> (which we&#8217;ll see more about later) needs to authorize a user operation.</p>
<p>You can (and many users do) write their own filters or MVC controllers to provide interoperability with authentication systems that are not based on Spring Security. For example, you might be using Container-Managed Authentication which makes the current user available from a ThreadLocal or JNDI location. Or you might work for a company that has a legacy proprietary authentication system, which is a corporate "standard" over which you have little control. In situations like this it&#8217;s quite easy to get Spring Security to work, and still provide authorization capabilities. All you need to do is write a filter (or equivalent) that reads the third-party user information from a location, build a Spring Security-specific <code class="literal">Authentication</code> object, and put it into the <code class="literal">SecurityContextHolder</code>. In this case you also need to think about things which are normally taken care of automatically by the built-in authentication infrastructure. For example, you might need to pre-emptively create an HTTP session to <a class="link" href="index.html#tech-intro-sec-context-persistence" title="9.4.4&nbsp;Storing the SecurityContext between requests">cache the context between requests</a>, before you write the response to the client footnote:[It isn&#8217;t possible to create a session once the response has been committed.</p>
<p>If you&#8217;re wondering how the <code class="literal">AuthenticationManager</code> is implemented in a real world example, we&#8217;ll look at that in the <a class="link" href="index.html#core-services-authentication-manager" title="10.1&nbsp;The AuthenticationManager, ProviderManager and AuthenticationProvider">core services chapter</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tech-intro-web-authentication" href="index.html#tech-intro-web-authentication"></a>9.4&nbsp;Authentication in a Web Application</h2></div></div></div>
<p>Now let&#8217;s explore the situation where you are using Spring Security in a web application (without <code class="literal">web.xml</code> security enabled). How is a user authenticated and the security context established?</p>
<p>Consider a typical web application&#8217;s authentication process:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
You visit the home page, and click on a link.
</li><li class="listitem">
A request goes to the server, and the server decides that you&#8217;ve asked for a protected resource.
</li><li class="listitem">
As you&#8217;re not presently authenticated, the server sends back a response indicating that you must authenticate. The response will either be an HTTP response code, or a redirect to a particular web page.
</li><li class="listitem">
Depending on the authentication mechanism, your browser will either redirect to the specific web page so that you can fill out the form, or the browser will somehow retrieve your identity (via a BASIC authentication dialogue box, a cookie, a X.509 certificate etc.).
</li><li class="listitem">
The browser will send back a response to the server. This will either be an HTTP POST containing the contents of the form that you filled out, or an HTTP header containing your authentication details.
</li><li class="listitem">
Next the server will decide whether or not the presented credentials are valid. If they&#8217;re valid, the next step will happen. If they&#8217;re invalid, usually your browser will be asked to try again (so you return to step two above).
</li><li class="listitem">
The original request that you made to cause the authentication process will be retried. Hopefully you&#8217;ve authenticated with sufficient granted authorities to access the protected resource. If you have sufficient access, the request will be successful. Otherwise, you&#8217;ll receive back an HTTP error code 403, which means "forbidden".
</li></ol></div>
<p>Spring Security has distinct classes responsible for most of the steps described above. The main participants (in the order that they are used) are the <code class="literal">ExceptionTranslationFilter</code>, an <code class="literal">AuthenticationEntryPoint</code> and an "authentication mechanism", which is responsible for calling the <code class="literal">AuthenticationManager</code> which we saw in the previous section.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="exceptiontranslationfilter" href="index.html#exceptiontranslationfilter"></a>9.4.1&nbsp;ExceptionTranslationFilter</h3></div></div></div>
<p><code class="literal">ExceptionTranslationFilter</code> is a Spring Security filter that has responsibility for detecting any Spring Security exceptions that are thrown. Such exceptions will generally be thrown by an <code class="literal">AbstractSecurityInterceptor</code>, which is the main provider of authorization services. We will discuss <code class="literal">AbstractSecurityInterceptor</code> in the next section, but for now we just need to know that it produces Java exceptions and knows nothing about HTTP or how to go about authenticating a principal. Instead the <code class="literal">ExceptionTranslationFilter</code> offers this service, with specific responsibility for either returning error code 403 (if the principal has been authenticated and therefore simply lacks sufficient access - as per step seven above), or launching an <code class="literal">AuthenticationEntryPoint</code> (if the principal has not been authenticated and therefore we need to go commence step three).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tech-intro-auth-entry-point" href="index.html#tech-intro-auth-entry-point"></a>9.4.2&nbsp;AuthenticationEntryPoint</h3></div></div></div>
<p>The <code class="literal">AuthenticationEntryPoint</code> is responsible for step three in the above list. As you can imagine, each web application will have a default authentication strategy (well, this can be configured like nearly everything else in Spring Security, but let&#8217;s keep it simple for now). Each major authentication system will have its own <code class="literal">AuthenticationEntryPoint</code> implementation, which typically performs one of the actions described in step 3.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="authentication-mechanism" href="index.html#authentication-mechanism"></a>9.4.3&nbsp;Authentication Mechanism</h3></div></div></div>
<p>Once your browser submits your authentication credentials (either as an HTTP form post or HTTP header) there needs to be something on the server that "collects" these authentication details. By now we&#8217;re at step six in the above list. In Spring Security we have a special name for the function of collecting authentication details from a user agent (usually a web browser), referring to it as the "authentication mechanism". Examples are form-base login and Basic authentication. Once the authentication details have been collected from the user agent, an <code class="literal">Authentication</code> "request" object is built and then presented to the <code class="literal">AuthenticationManager</code>.</p>
<p>After the authentication mechanism receives back the fully-populated <code class="literal">Authentication</code> object, it will deem the request valid, put the <code class="literal">Authentication</code> into the <code class="literal">SecurityContextHolder</code>, and cause the original request to be retried (step seven above). If, on the other hand, the <code class="literal">AuthenticationManager</code> rejected the request, the authentication mechanism will ask the user agent to retry (step two above).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tech-intro-sec-context-persistence" href="index.html#tech-intro-sec-context-persistence"></a>9.4.4&nbsp;Storing the SecurityContext between requests</h3></div></div></div>
<p>Depending on the type of application, there may need to be a strategy in place to store the security context between user operations. In a typical web application, a user logs in once and is subsequently identified by their session Id. The server caches the principal information for the duration session. In Spring Security, the responsibility for storing the <code class="literal">SecurityContext</code> between requests falls to the <code class="literal">SecurityContextPersistenceFilter</code>, which by default stores the context as an <code class="literal">HttpSession</code> attribute between HTTP requests. It restores the context to the <code class="literal">SecurityContextHolder</code> for each request and, crucially, clears the <code class="literal">SecurityContextHolder</code> when the request completes. You shouldn&#8217;t interact directly with the <code class="literal">HttpSession</code> for security purposes. There is simply no justification for doing so - always use the <code class="literal">SecurityContextHolder</code> instead.</p>
<p>Many other types of application (for example, a stateless RESTful web service) do not use HTTP sessions and will re-authenticate on every request. However, it is still important that the <code class="literal">SecurityContextPersistenceFilter</code> is included in the chain to make sure that the <code class="literal">SecurityContextHolder</code> is cleared after each request.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In an application which receives concurrent requests in a single session, the same <code class="literal">SecurityContext</code> instance will be shared between threads. Even though a <code class="literal">ThreadLocal</code> is being used, it is the same instance that is retrieved from the <code class="literal">HttpSession</code> for each thread. This has implications if you wish to temporarily change the context under which a thread is running. If you just use <code class="literal">SecurityContextHolder.getContext()</code>, and call <code class="literal">setAuthentication(anAuthentication)</code> on the returned context object, then the <code class="literal">Authentication</code> object will change in <span class="emphasis"><em>all</em></span> concurrent threads which share the same <code class="literal">SecurityContext</code> instance. You can customize the behaviour of <code class="literal">SecurityContextPersistenceFilter</code> to create a completely new <code class="literal">SecurityContext</code> for each request, preventing changes in one thread from affecting another. Alternatively you can create a new instance just at the point where you temporarily change the context. The method <code class="literal">SecurityContextHolder.createEmptyContext()</code> always returns a new context instance.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tech-intro-access-control" href="index.html#tech-intro-access-control"></a>9.5&nbsp;Access-Control (Authorization) in Spring Security</h2></div></div></div>
<p>The main interface responsible for making access-control decisions in Spring Security is the <code class="literal">AccessDecisionManager</code>. It has a <code class="literal">decide</code> method which takes an <code class="literal">Authentication</code> object representing the principal requesting access, a "secure object" (see below) and a list of security metadata attributes which apply for the object (such as a list of roles which are required for access to be granted).</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="security-and-aop-advice" href="index.html#security-and-aop-advice"></a>9.5.1&nbsp;Security and AOP Advice</h3></div></div></div>
<p>If you&#8217;re familiar with AOP, you&#8217;d be aware there are different types of advice available: before, after, throws and around. An around advice is very useful, because an advisor can elect whether or not to proceed with a method invocation, whether or not to modify the response, and whether or not to throw an exception. Spring Security provides an around advice for method invocations as well as web requests. We achieve an around advice for method invocations using Spring&#8217;s standard AOP support and we achieve an around advice for web requests using a standard Filter.</p>
<p>For those not familiar with AOP, the key point to understand is that Spring Security can help you protect method invocations as well as web requests. Most people are interested in securing method invocations on their services layer. This is because the services layer is where most business logic resides in current-generation Java EE applications. If you just need to secure method invocations in the services layer, Spring&#8217;s standard AOP will be adequate. If you need to secure domain objects directly, you will likely find that AspectJ is worth considering.</p>
<p>You can elect to perform method authorization using AspectJ or Spring AOP, or you can elect to perform web request authorization using filters. You can use zero, one, two or three of these approaches together. The mainstream usage pattern is to perform some web request authorization, coupled with some Spring AOP method invocation authorization on the services layer.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="secure-objects" href="index.html#secure-objects"></a>9.5.2&nbsp;Secure Objects and the AbstractSecurityInterceptor</h3></div></div></div>
<p>So what <span class="emphasis"><em>is</em></span> a "secure object" anyway? Spring Security uses the term to refer to any object that can have security (such as an authorization decision) applied to it. The most common examples are method invocations and web requests.</p>
<p>Each supported secure object type has its own interceptor class, which is a subclass of <code class="literal">AbstractSecurityInterceptor</code>. Importantly, by the time the <code class="literal">AbstractSecurityInterceptor</code> is called, the <code class="literal">SecurityContextHolder</code> will contain a valid <code class="literal">Authentication</code> if the principal has been authenticated.</p>
<p><code class="literal">AbstractSecurityInterceptor</code> provides a consistent workflow for handling secure object requests, typically:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Look up the "configuration attributes" associated with the present request
</li><li class="listitem">
Submitting the secure object, current <code class="literal">Authentication</code> and configuration attributes to the <code class="literal">AccessDecisionManager</code> for an authorization decision
</li><li class="listitem">
Optionally change the <code class="literal">Authentication</code> under which the invocation takes place
</li><li class="listitem">
Allow the secure object invocation to proceed (assuming access was granted)
</li><li class="listitem">
Call the <code class="literal">AfterInvocationManager</code> if configured, once the invocation has returned. If the invocation raised an exception, the <code class="literal">AfterInvocationManager</code> will not be invoked.
</li></ol></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="tech-intro-config-attributes" href="index.html#tech-intro-config-attributes"></a>What are Configuration Attributes?</h4></div></div></div>
<p>A "configuration attribute" can be thought of as a String that has special meaning to the classes used by <code class="literal">AbstractSecurityInterceptor</code>. They are represented by the interface <code class="literal">ConfigAttribute</code> within the framework. They may be simple role names or have more complex meaning, depending on the how sophisticated the <code class="literal">AccessDecisionManager</code> implementation is. The <code class="literal">AbstractSecurityInterceptor</code> is configured with a <code class="literal">SecurityMetadataSource</code> which it uses to look up the attributes for a secure object. Usually this configuration will be hidden from the user. Configuration attributes will be entered as annotations on secured methods or as access attributes on secured URLs. For example, when we saw something like <code class="literal">&lt;intercept-url pattern='/secure/**' access='ROLE_A,ROLE_B'/&gt;</code> in the namespace introduction, this is saying that the configuration attributes <code class="literal">ROLE_A</code> and <code class="literal">ROLE_B</code> apply to web requests matching the given pattern. In practice, with the default <code class="literal">AccessDecisionManager</code> configuration, this means that anyone who has a <code class="literal">GrantedAuthority</code> matching either of these two attributes will be allowed access. Strictly speaking though, they are just attributes and the interpretation is dependent on the <code class="literal">AccessDecisionManager</code> implementation. The use of the prefix <code class="literal">ROLE_</code> is a marker to indicate that these attributes are roles and should be consumed by Spring Security&#8217;s <code class="literal">RoleVoter</code>. This is only relevant when a voter-based <code class="literal">AccessDecisionManager</code> is in use. We&#8217;ll see how the <code class="literal">AccessDecisionManager</code> is implemented in the <a class="link" href="index.html#authz-arch" title="25.&nbsp;Authorization Architecture">authorization chapter</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="runasmanager" href="index.html#runasmanager"></a>RunAsManager</h4></div></div></div>
<p>Assuming <code class="literal">AccessDecisionManager</code> decides to allow the request, the <code class="literal">AbstractSecurityInterceptor</code> will normally just proceed with the request. Having said that, on rare occasions users may want to replace the <code class="literal">Authentication</code> inside the <code class="literal">SecurityContext</code> with a different <code class="literal">Authentication</code>, which is handled by the <code class="literal">AccessDecisionManager</code> calling a <code class="literal">RunAsManager</code>. This might be useful in reasonably unusual situations, such as if a services layer method needs to call a remote system and present a different identity. Because Spring Security automatically propagates security identity from one server to another (assuming you&#8217;re using a properly-configured RMI or HttpInvoker remoting protocol client), this may be useful.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="afterinvocationmanager" href="index.html#afterinvocationmanager"></a>AfterInvocationManager</h4></div></div></div>
<p>Following the secure object invocation proceeding and then returning - which may mean a method invocation completing or a filter chain proceeding - the <code class="literal">AbstractSecurityInterceptor</code> gets one final chance to handle the invocation. At this stage the <code class="literal">AbstractSecurityInterceptor</code> is interested in possibly modifying the return object. We might want this to happen because an authorization decision couldn&#8217;t be made "on the way in" to a secure object invocation. Being highly pluggable, <code class="literal">AbstractSecurityInterceptor</code> will pass control to an <code class="literal">AfterInvocationManager</code> to actually modify the object if needed. This class can even entirely replace the object, or throw an exception, or not change it in any way as it chooses. The after-invocation checks will only be executed if the invocation is successful. If an exception occurs, the additional checks will be skipped.</p>
<p><code class="literal">AbstractSecurityInterceptor</code> and its related objects are shown in <a class="xref" href="index.html#abstract-security-interceptor" title="Figure&nbsp;9.1.&nbsp;Security interceptors and the &#34;secure object&#34; model">Figure&nbsp;9.1, &#8220;Security interceptors and the "secure object" model&#8221;</a></p>
<div class="figure"><a name="abstract-security-interceptor" href="index.html#abstract-security-interceptor"></a><p class="title"><b>Figure&nbsp;9.1.&nbsp;Security interceptors and the "secure object" model</b></p><div class="figure-contents">
<div class="mediaobject"><img src="images/security-interception.png" alt="Abstract Security Interceptor"></div>
</div></div><br class="figure-break">
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="extending-the-secure-object-model" href="index.html#extending-the-secure-object-model"></a>Extending the Secure Object Model</h4></div></div></div>
<p>Only developers contemplating an entirely new way of intercepting and authorizing requests would need to use secure objects directly. For example, it would be possible to build a new secure object to secure calls to a messaging system. Anything that requires security and also provides a way of intercepting a call (like the AOP around advice semantics) is capable of being made into a secure object. Having said that, most Spring applications will simply use the three currently supported secure object types (AOP Alliance <code class="literal">MethodInvocation</code>, AspectJ <code class="literal">JoinPoint</code> and web request <code class="literal">FilterInvocation</code>) with complete transparency.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="localization" href="index.html#localization"></a>9.6&nbsp;Localization</h2></div></div></div>
<p>Spring Security supports localization of exception messages that end users are likely to see. If your application is designed for English-speaking users, you don&#8217;t need to do anything as by default all Security messages are in English. If you need to support other locales, everything you need to know is contained in this section.</p>
<p>All exception messages can be localized, including messages related to authentication failures and access being denied (authorization failures). Exceptions and logging messages that are focused on developers or system deployers (including incorrect attributes, interface contract violations, using incorrect constructors, startup time validation, debug-level logging) are not localized and instead are hard-coded in English within Spring Security&#8217;s code.</p>
<p>Shipping in the <code class="literal">spring-security-core-xx.jar</code> you will find an <code class="literal">org.springframework.security</code> package that in turn contains a <code class="literal">messages.properties</code> file, as well as localized versions for some common languages. This should be referred to by your <code class="literal">ApplicationContext</code>, as Spring Security classes implement Spring&#8217;s <code class="literal">MessageSourceAware</code> interface and expect the message resolver to be dependency injected at application context startup time. Usually all you need to do is register a bean inside your application context to refer to the messages. An example is shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messageSource"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.context.support.ReloadableResourceBundleMessageSource"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"basename"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"classpath:org/springframework/security/messages"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>The <code class="literal">messages.properties</code> is named in accordance with standard resource bundles and represents the default language supported by Spring Security messages. This default file is in English.</p>
<p>If you wish to customize the <code class="literal">messages.properties</code> file, or support other languages, you should copy the file, rename it accordingly, and register it inside the above bean definition. There are not a large number of message keys inside this file, so localization should not be considered a major initiative. If you do perform localization of this file, please consider sharing your work with the community by logging a JIRA task and attaching your appropriately-named localized version of <code class="literal">messages.properties</code>.</p>
<p>Spring Security relies on Spring&#8217;s localization support in order to actually lookup the appropriate message. In order for this to work, you have to make sure that the locale from the incoming request is stored in Spring&#8217;s <code class="literal">org.springframework.context.i18n.LocaleContextHolder</code>. Spring MVC&#8217;s <code class="literal">DispatcherServlet</code> does this for your application automatically, but since Spring Security&#8217;s filters are invoked before this, the <code class="literal">LocaleContextHolder</code> needs to be set up to contain the correct <code class="literal">Locale</code> before the filters are called. You can either do this in a filter yourself (which must come before the Spring Security filters in <code class="literal">web.xml</code>) or you can use Spring&#8217;s <code class="literal">RequestContextFilter</code>. Please refer to the Spring Framework documentation for further details on using localization with Spring.</p>
<p>The "contacts" sample application is set up to use localized messages.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="core-services" href="index.html#core-services"></a>10.&nbsp;Core Services</h2></div></div></div>
<p>Now that we have a high-level overview of the Spring Security architecture and its core classes, let&#8217;s take a closer look at one or two of the core interfaces and their implementations, in particular the <code class="literal">AuthenticationManager</code>, <code class="literal">UserDetailsService</code> and the <code class="literal">AccessDecisionManager</code>. These crop up regularly throughout the remainder of this document so it&#8217;s important you know how they are configured and how they operate.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="core-services-authentication-manager" href="index.html#core-services-authentication-manager"></a>10.1&nbsp;The AuthenticationManager, ProviderManager and AuthenticationProvider</h2></div></div></div>
<p>The <code class="literal">AuthenticationManager</code> is just an interface, so the implementation can be anything we choose, but how does it work in practice? What if we need to check multiple authentication databases or a combination of different authentication services such as a database and an LDAP server?</p>
<p>The default implementation in Spring Security is called <code class="literal">ProviderManager</code> and rather than handling the authentication request itself, it delegates to a list of configured <code class="literal">AuthenticationProvider</code> s, each of which is queried in turn to see if it can perform the authentication. Each provider will either throw an exception or return a fully populated <code class="literal">Authentication</code> object. Remember our good friends, <code class="literal">UserDetails</code> and <code class="literal">UserDetailsService</code>? If not, head back to the previous chapter and refresh your memory. The most common approach to verifying an authentication request is to load the corresponding <code class="literal">UserDetails</code> and check the loaded password against the one that has been entered by the user. This is the approach used by the <code class="literal">DaoAuthenticationProvider</code> (see below). The loaded <code class="literal">UserDetails</code> object - and particularly the <code class="literal">GrantedAuthority</code> s it contains - will be used when building the fully populated <code class="literal">Authentication</code> object which is returned from a successful authentication and stored in the <code class="literal">SecurityContext</code>.</p>
<p>If you are using the namespace, an instance of <code class="literal">ProviderManager</code> is created and maintained internally, and you add providers to it by using the namespace authentication provider elements (see <a class="link" href="index.html#ns-auth-manager" title="6.6&nbsp;The Authentication Manager and the Namespace">the namespace chapter</a>). In this case, you should not declare a <code class="literal">ProviderManager</code> bean in your application context. However, if you are not using the namespace then you would declare it like so:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"authenticationManager"</span>
		<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.authentication.ProviderManager"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;constructor-arg&gt;</span>
		<span class="hl-tag">&lt;list&gt;</span>
			<span class="hl-tag">&lt;ref</span> <span class="hl-attribute">local</span>=<span class="hl-value">"daoAuthenticationProvider"</span><span class="hl-tag">/&gt;</span>
			<span class="hl-tag">&lt;ref</span> <span class="hl-attribute">local</span>=<span class="hl-value">"anonymousAuthenticationProvider"</span><span class="hl-tag">/&gt;</span>
			<span class="hl-tag">&lt;ref</span> <span class="hl-attribute">local</span>=<span class="hl-value">"ldapAuthenticationProvider"</span><span class="hl-tag">/&gt;</span>
		<span class="hl-tag">&lt;/list&gt;</span>
	<span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>In the above example we have three providers. They are tried in the order shown (which is implied by the use of a <code class="literal">List</code>), with each provider able to attempt authentication, or skip authentication by simply returning <code class="literal">null</code>. If all implementations return null, the <code class="literal">ProviderManager</code> will throw a <code class="literal">ProviderNotFoundException</code>. If you&#8217;re interested in learning more about chaining providers, please refer to the <code class="literal">ProviderManager</code> Javadoc.</p>
<p>Authentication mechanisms such as a web form-login processing filter are injected with a reference to the <code class="literal">ProviderManager</code> and will call it to handle their authentication requests. The providers you require will sometimes be interchangeable with the authentication mechanisms, while at other times they will depend on a specific authentication mechanism. For example, <code class="literal">DaoAuthenticationProvider</code> and <code class="literal">LdapAuthenticationProvider</code> are compatible with any mechanism which submits a simple username/password authentication request and so will work with form-based logins or HTTP Basic authentication. On the other hand, some authentication mechanisms create an authentication request object which can only be interpreted by a single type of <code class="literal">AuthenticationProvider</code>. An example of this would be JA-SIG CAS, which uses the notion of a service ticket and so can therefore only be authenticated by a <code class="literal">CasAuthenticationProvider</code>. You needn&#8217;t be too concerned about this, because if you forget to register a suitable provider, you&#8217;ll simply receive a <code class="literal">ProviderNotFoundException</code> when an attempt to authenticate is made.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="core-services-erasing-credentials" href="index.html#core-services-erasing-credentials"></a>10.1.1&nbsp;Erasing Credentials on Successful Authentication</h3></div></div></div>
<p>By default (from Spring Security 3.1 onwards) the <code class="literal">ProviderManager</code> will attempt to clear any sensitive credentials information from the <code class="literal">Authentication</code> object which is returned by a successful authentication request. This prevents information like passwords being retained longer than necessary.</p>
<p>This may cause issues when you are using a cache of user objects, for example, to improve performance in a stateless application. If the <code class="literal">Authentication</code> contains a reference to an object in the cache (such as a <code class="literal">UserDetails</code> instance) and this has its credentials removed, then it will no longer be possible to authenticate against the cached value. You need to take this into account if you are using a cache. An obvious solution is to make a copy of the object first, either in the cache implementation or in the <code class="literal">AuthenticationProvider</code> which creates the returned <code class="literal">Authentication</code> object. Alternatively, you can disable the <code class="literal">eraseCredentialsAfterAuthentication</code> property on <code class="literal">ProviderManager</code>. See the Javadoc for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="core-services-dao-provider" href="index.html#core-services-dao-provider"></a>10.1.2&nbsp;DaoAuthenticationProvider</h3></div></div></div>
<p>The simplest <code class="literal">AuthenticationProvider</code> implemented by Spring Security is <code class="literal">DaoAuthenticationProvider</code>, which is also one of the earliest supported by the framework. It leverages a <code class="literal">UserDetailsService</code> (as a DAO) in order to lookup the username, password and <code class="literal">GrantedAuthority</code> s. It authenticates the user simply by comparing the password submitted in a <code class="literal">UsernamePasswordAuthenticationToken</code> against the one loaded by the <code class="literal">UserDetailsService</code>. Configuring the provider is quite simple:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"daoAuthenticationProvider"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.authentication.dao.DaoAuthenticationProvider"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"userDetailsService"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"inMemoryDaoImpl"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"passwordEncoder"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"passwordEncoder"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>The <code class="literal">PasswordEncoder</code> is optional. A <code class="literal">PasswordEncoder</code> provides encoding and decoding of passwords presented in the <code class="literal">UserDetails</code> object that is returned from the configured <code class="literal">UserDetailsService</code>. This will be discussed in more detail <a class="link" href="index.html#core-services-password-encoding" title="10.3&nbsp;Password Encoding">below</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="userdetailsservice-implementations" href="index.html#userdetailsservice-implementations"></a>10.2&nbsp;UserDetailsService Implementations</h2></div></div></div>
<p>As mentioned in the earlier in this reference guide, most authentication providers take advantage of the <code class="literal">UserDetails</code> and <code class="literal">UserDetailsService</code> interfaces. Recall that the contract for <code class="literal">UserDetailsService</code> is a single method:</p>
<pre class="programlisting">UserDetails loadUserByUsername(String username) <span class="hl-keyword">throws</span> UsernameNotFoundException;</pre>
<p>The returned <code class="literal">UserDetails</code> is an interface that provides getters that guarantee non-null provision of authentication information such as the username, password, granted authorities and whether the user account is enabled or disabled. Most authentication providers will use a <code class="literal">UserDetailsService</code>, even if the username and password are not actually used as part of the authentication decision. They may use the returned <code class="literal">UserDetails</code> object just for its <code class="literal">GrantedAuthority</code> information, because some other system (like LDAP or X.509 or CAS etc) has undertaken the responsibility of actually validating the credentials.</p>
<p>Given <code class="literal">UserDetailsService</code> is so simple to implement, it should be easy for users to retrieve authentication information using a persistence strategy of their choice. Having said that, Spring Security does include a couple of useful base implementations, which we&#8217;ll look at below.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="core-services-in-memory-service" href="index.html#core-services-in-memory-service"></a>10.2.1&nbsp;In-Memory Authentication</h3></div></div></div>
<p>Is easy to use create a custom <code class="literal">UserDetailsService</code> implementation that extracts information from a persistence engine of choice, but many applications do not require such complexity. This is particularly true if you&#8217;re building a prototype application or just starting integrating Spring Security, when you don&#8217;t really want to spend time configuring databases or writing <code class="literal">UserDetailsService</code> implementations. For this sort of situation, a simple option is to use the <code class="literal">user-service</code> element from the security <a class="link" href="index.html#ns-minimal" title="6.2.2&nbsp;A Minimal <http&gt; Configuration">namespace</a>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;user-service</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userDetailsService"</span><span class="hl-tag">&gt;</span>
<span class="hl-comment">&lt;!-- Password is prefixed with {noop} to indicate to DelegatingPasswordEncoder that
NoOpPasswordEncoder should be used. This is not safe for production, but makes reading
in samples easier. Normally passwords should be hashed using BCrypt --&gt;</span>
<span class="hl-tag">&lt;user</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jimi"</span> <span class="hl-attribute">password</span>=<span class="hl-value">"{noop}jimispassword"</span> <span class="hl-attribute">authorities</span>=<span class="hl-value">"ROLE_USER, ROLE_ADMIN"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;user</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bob"</span> <span class="hl-attribute">password</span>=<span class="hl-value">"{noop}bobspassword"</span> <span class="hl-attribute">authorities</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/user-service&gt;</span></pre>
<p>This also supports the use of an external properties file:</p>
<pre class="programlisting"><span class="hl-tag">&lt;user-service</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userDetailsService"</span> <span class="hl-attribute">properties</span>=<span class="hl-value">"users.properties"</span><span class="hl-tag">/&gt;</span></pre>
<p>The properties file should contain entries in the form</p>
<pre class="programlisting">username=password,grantedAuthority[,grantedAuthority][,enabled|disabled]</pre>
<p>For example</p>
<pre class="programlisting">jimi=jimispassword,ROLE_USER,ROLE_ADMIN,enabled
bob=bobspassword,ROLE_USER,enabled</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="core-services-jdbc-user-service" href="index.html#core-services-jdbc-user-service"></a>10.2.2&nbsp;JdbcDaoImpl</h3></div></div></div>
<p>Spring Security also includes a <code class="literal">UserDetailsService</code> that can obtain authentication information from a JDBC data source. Internally Spring JDBC is used, so it avoids the complexity of a fully-featured object relational mapper (ORM) just to store user details. If your application does use an ORM tool, you might prefer to write a custom <code class="literal">UserDetailsService</code> to reuse the mapping files you&#8217;ve probably already created. Returning to <code class="literal">JdbcDaoImpl</code>, an example configuration is shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"driverClassName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.hsqldb.jdbcDriver"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"url"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"jdbc:hsqldb:hsql://localhost:9001"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"sa"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userDetailsService"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>You can use different relational database management systems by modifying the <code class="literal">DriverManagerDataSource</code> shown above. You can also use a global data source obtained from JNDI, as with any other Spring configuration.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="authority-groups" href="index.html#authority-groups"></a>Authority Groups</h4></div></div></div>
<p>By default, <code class="literal">JdbcDaoImpl</code> loads the authorities for a single user with the assumption that the authorities are mapped directly to users (see the <a class="link" href="index.html#appendix-schema" title="42.&nbsp;Security Database Schema">database schema appendix</a>). An alternative approach is to partition the authorities into groups and assign groups to the user. Some people prefer this approach as a means of administering user rights. See the <code class="literal">JdbcDaoImpl</code> Javadoc for more information on how to enable the use of group authorities. The group schema is also included in the appendix.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="core-services-password-encoding" href="index.html#core-services-password-encoding"></a>10.3&nbsp;Password Encoding</h2></div></div></div>
<p>Spring Security&#8217;s <code class="literal">PasswordEncoder</code> interface is used to perform a one way transformation of a password to allow the password to be stored securely.
Given <code class="literal">PasswordEncoder</code> is a one way transformation, it is not intended when the password transformation needs to be two way (i.e. storing credentials used to authenticate to a database).
Typically <code class="literal">PasswordEncoder</code> is used for storing a password that needs to be compared to a user provided password at the time of authentication.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="pe-history" href="index.html#pe-history"></a>10.3.1&nbsp;Password History</h3></div></div></div>
<p>Throughout the years the standard mechanism for storing passwords has evolved.
In the beginning passwords were stored in plain text.
The passwords were assumed to be safe because the data store the passwords were saved in required credentials to access it.
However, malicious users were able to find ways to get large "data dumps" of usernames and passwords using attacks like SQL Injection.
As more and more user credentials became public security experts realized we needed to do more to protect users passwords.</p>
<p>Developers were then encouraged to store passwords after running them through a one way hash such as SHA-256.
When a user tried to authenticate, the hashed password would be compared to the hash of the password that they typed.
This meant that the system only needed to store the one way hash of the password.
If a breach occurred, then only the one way hashes of the passwords were exposed.
Since the hashes were one way and it was computationally difficult to guess the passwords given the hash, it would not be worth the effort to figure out each password in the system.
To defeat this new system malicious users decided to create lookup tables known as <a class="ulink" href="https://en.wikipedia.org/wiki/Rainbow_table" target="_top">Rainbow Tables</a>.
Rather than doing the work of guessing each password every time, they computed the password once and stored it in a lookup table.</p>
<p>To mitigate the effectiveness of Rainbow Tables, developers were encouraged to use salted passwords.
Instead of using just the password as input to the hash function, random bytes (known as salt) would be generated for every users' password.
The salt and the user&#8217;s password would be ran through the hash function which produced a unique hash.
The salt would be stored alongside the user&#8217;s password in clear text.
Then when a user tried to authenticate, the hashed password would be compared to the hash of the stored salt and the password that they typed.
The unique salt meant that Rainbow Tables were no longer effective because the hash was different for every salt and password combination.</p>
<p>In modern times we realize that cryptographic hashes (like SHA-256) are no longer secure.
The reason is that with modern hardware we can perform billions of hash calculations a second.
This means that we can crack each password individually with ease.</p>
<p>Developers are now encouraged to leverage adaptive one-way functions to store a password.
An adaptive one-way function allows configuring a "work factor" which can grow as hardware gets better.
It is recommended that the "work factor" be tuned to take about 1 second to verify a password on your system.
This trade off is to make it difficult for attackers to crack the password, but not so costly it puts excessive burden on your own system.
Examples of adaptive one-way functions that should be used include
<a class="ulink" href="https://en.wikipedia.org/wiki/Bcrypt" target="_top">bcrypt</a>,
<a class="ulink" href="https://en.wikipedia.org/wiki/PBKDF2" target="_top">PBKDF2</a>,
<a class="ulink" href="https://en.wikipedia.org/wiki/Scrypt" target="_top">scrypt</a>,
and <a class="ulink" href="https://en.wikipedia.org/wiki/Argon2" target="_top">Argon2</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="pe-dpe" href="index.html#pe-dpe"></a>10.3.2&nbsp;DelegatingPasswordEncoder</h3></div></div></div>
<p>Prior to Spring Security 5.0 the default <code class="literal">PasswordEncoder</code> was <code class="literal">NoOpPasswordEncoder</code> which required plain text passwords.
Based upon the <a class="link" href="index.html#">Password History</a> section you might expect that the default <code class="literal">PasswordEncoder</code> is now something like <code class="literal">BCryptPasswordEncoder</code>.
However, this ignores three real world problems:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
There are many applications using old password encodings that cannot easily migrate
</li><li class="listitem">
The best practice for password storage will change again.
</li><li class="listitem">
As a framework Spring Security cannot make breaking changes frequently
</li></ul></div>
<p>Instead Spring Security introduces <code class="literal">DelegatingPasswordEncoder</code> which solves all of the problems by:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Ensuring that passwords are encoded using the current password storage recommendations
</li><li class="listitem">
Allowing for validating passwords in modern and legacy formats
</li><li class="listitem">
Allowing for upgrading the encoding in the future
</li></ul></div>
<p>You can easily construct an instance of <code class="literal">DelegatingPasswordEncoder</code> using <code class="literal">PasswordEncoderFactories</code>.</p>
<pre class="programlisting">PasswordEncoder passwordEncoder =
    PasswordEncoderFactories.createDelegatingPasswordEncoder();</pre>
<p>Alternatively, you may create your own custom instance. For example:</p>
<pre class="programlisting">String idForEncode = <span class="hl-string">"bcrypt"</span>;
Map encoders = <span class="hl-keyword">new</span> HashMap&lt;&gt;();
encoders.put(idForEncode, <span class="hl-keyword">new</span> BCryptPasswordEncoder());
encoders.put(<span class="hl-string">"noop"</span>, NoOpPasswordEncoder.getInstance());
encoders.put(<span class="hl-string">"pbkdf2"</span>, <span class="hl-keyword">new</span> Pbkdf2PasswordEncoder());
encoders.put(<span class="hl-string">"scrypt"</span>, <span class="hl-keyword">new</span> SCryptPasswordEncoder());
encoders.put(<span class="hl-string">"sha256"</span>, <span class="hl-keyword">new</span> StandardPasswordEncoder());

PasswordEncoder passwordEncoder =
    <span class="hl-keyword">new</span> DelegatingPasswordEncoder(idForEncode, encoders);</pre>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="pe-dpe-format" href="index.html#pe-dpe-format"></a>Password Storage Format</h4></div></div></div>
<p>The general format for a password is:</p>
<pre class="programlisting">{id}encodedPassword</pre>
<p>Such that <code class="literal">id</code> is an identifier used to look up which <code class="literal">PasswordEncoder</code> should be used and <code class="literal">encodedPassword</code> is the original encoded password for the selected <code class="literal">PasswordEncoder</code>.
The <code class="literal">id</code> must be at the beginning of the password, start with <code class="literal">{</code> and end with <code class="literal">}</code>.
If the <code class="literal">id</code> cannot be found, the <code class="literal">id</code> will be null.
For example, the following might be a list of passwords encoded using different <code class="literal">id</code>.
All of the original passwords are "password".</p>
<pre class="programlisting">{bcrypt}$2a$10$dXJ3SW6G7P50lGmMkkmwe.20cQQubK3.HZWzG3YB1tlRy.fqvM/BG <a name="CO10-1" href="index.html#CO10-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
{noop}password <a name="CO10-2" href="index.html#CO10-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
{pbkdf2}5d923b44a6d129f3ddf3e3c8d29412723dcbde72445e8ef6bf3b508fbf17fa4ed4d6b99ca763d8dc <a name="CO10-3" href="index.html#CO10-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
{scrypt}$e0801$8bWJaSu2IKSn9Z9kM+TPXfOc/9bdYSrN1oD9qfVThWEwdRTnO7re7Ei+fUZRJ68k9lTyuTeUp4of4g24hHnazw==$OAOec05+bXxvuu/1qZ6NUR+xQYvYv7BeL1QxwRpY5Pc=  <a name="CO10-4" href="index.html#CO10-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
{sha256}97cde38028ad898ebc02e690819fa220e88c62e0699403e94fff291cfffaf8410849f27605abcbc0 <a name="CO10-5" href="index.html#CO10-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO10-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The first password would have a <code class="literal">PasswordEncoder</code> id of <code class="literal">bcrypt</code> and encodedPassword of <code class="literal">$2a$10$dXJ3SW6G7P50lGmMkkmwe.20cQQubK3.HZWzG3YB1tlRy.fqvM/BG</code>.
When matching it would delegate to <code class="literal">BCryptPasswordEncoder</code></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO10-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The second password would have a <code class="literal">PasswordEncoder</code> id of <code class="literal">noop</code> and encodedPassword of <code class="literal">password</code>.
When matching it would delegate to <code class="literal">NoOpPasswordEncoder</code></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO10-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The third password would have a <code class="literal">PasswordEncoder</code> id of <code class="literal">pbkdf2</code> and encodedPassword of <code class="literal">5d923b44a6d129f3ddf3e3c8d29412723dcbde72445e8ef6bf3b508fbf17fa4ed4d6b99ca763d8dc</code>.
When matching it would delegate to <code class="literal">Pbkdf2PasswordEncoder</code></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO10-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The fourth password would have a <code class="literal">PasswordEncoder</code> id of <code class="literal">scrypt</code> and encodedPassword of <code class="literal">$e0801$8bWJaSu2IKSn9Z9kM+TPXfOc/9bdYSrN1oD9qfVThWEwdRTnO7re7Ei+fUZRJ68k9lTyuTeUp4of4g24hHnazw==$OAOec05+bXxvuu/1qZ6NUR+xQYvYv7BeL1QxwRpY5Pc=</code>
When matching it would delegate to <code class="literal">SCryptPasswordEncoder</code></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO10-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The final password would have a <code class="literal">PasswordEncoder</code> id of <code class="literal">sha256</code> and encodedPassword of <code class="literal">97cde38028ad898ebc02e690819fa220e88c62e0699403e94fff291cfffaf8410849f27605abcbc0</code>.
When matching it would delegate to <code class="literal">StandardPasswordEncoder</code></p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Some users might be concerned that the storage format is provided for a potential hacker.
This is not a concern because the storage of the password does not rely on the algorithm being a secret.
Additionally, most formats are easy for an attacker to figure out without the prefix.
For example, BCrypt passwords often start with <code class="literal">$2a$</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="password-encoding" href="index.html#password-encoding"></a>Password Encoding</h4></div></div></div>
<p>The <code class="literal">idForEncode</code> passed into the constructor determines which <code class="literal">PasswordEncoder</code> will be used for encoding passwords.
In the <code class="literal">DelegatingPasswordEncoder</code> we constructed above, that means that the result of encoding <code class="literal">password</code> would be delegated to <code class="literal">BCryptPasswordEncoder</code> and be prefixed with <code class="literal">{bcrypt}</code>.
The end result would look like:</p>
<pre class="programlisting">{bcrypt}$2a$10$dXJ3SW6G7P50lGmMkkmwe.20cQQubK3.HZWzG3YB1tlRy.fqvM/BG</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="password-matching" href="index.html#password-matching"></a>Password Matching</h4></div></div></div>
<p>Matching is done based upon the <code class="literal">{id}</code> and the mapping of the <code class="literal">id</code> to the <code class="literal">PasswordEncoder</code> provided in the constructor.
Our example in <a class="xref" href="index.html#pe-dpe-format" title="Password Storage Format">the section called &#8220;Password Storage Format&#8221;</a> provides a working example of how this is done.
By default, the result of invoking <code class="literal">matches(CharSequence, String)</code> with a password and an <code class="literal">id</code> that is not mapped (including a null id) will result in an <code class="literal">IllegalArgumentException</code>.
This behavior can be customized using <code class="literal">DelegatingPasswordEncoder.setDefaultPasswordEncoderForMatches(PasswordEncoder)</code>.</p>
<p>By using the <code class="literal">id</code> we can match on any password encoding, but encode passwords using the most modern password encoding.
This is important, because unlike encryption, password hashes are designed so that there is no simple way to recover the plaintext.
Since there is no way to recover the plaintext, it makes it difficult to migrate the passwords.
While it is simple for users to migrate <code class="literal">NoOpPasswordEncoder</code>, we chose to include it by default to make it simple for the getting started experience.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="getting-started-experience" href="index.html#getting-started-experience"></a>Getting Started Experience</h4></div></div></div>
<p>If you are putting together a demo or a sample, it is a bit cumbersome to take time to hash the passwords of your users.
There are convenience mechanisms to make this easier, but this is still not intended for production.</p>
<pre class="programlisting">User user = User.withDefaultPasswordEncoder()
  .username(<span class="hl-string">"user"</span>)
  .password(<span class="hl-string">"password"</span>)
  .roles(<span class="hl-string">"user"</span>)
  .build();
System.out.println(user.getPassword());
<span class="hl-comment">// {bcrypt}$2a$10$dXJ3SW6G7P50lGmMkkmwe.20cQQubK3.HZWzG3YB1tlRy.fqvM/BG</span></pre>
<p>If you are creating multiple users, you can also reuse the builder.</p>
<pre class="programlisting">UserBuilder users = User.withDefaultPasswordEncoder();
User user = users
  .username(<span class="hl-string">"user"</span>)
  .password(<span class="hl-string">"password"</span>)
  .roles(<span class="hl-string">"USER"</span>)
  .build();
User admin = users
  .username(<span class="hl-string">"admin"</span>)
  .password(<span class="hl-string">"password"</span>)
  .roles(<span class="hl-string">"USER"</span>,<span class="hl-string">"ADMIN"</span>)
  .build();</pre>
<p>This does hash the password that is stored, but the passwords are still exposed in memory and in the compiled source code.
Therefore, it is still not considered secure for a production environment.
For production, you should hash your passwords externally.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="troubleshooting" href="index.html#troubleshooting"></a>Troubleshooting</h4></div></div></div>
<p>The following error occurs when one of the passwords that are stored has no id as described in <a class="xref" href="index.html#pe-dpe-format" title="Password Storage Format">the section called &#8220;Password Storage Format&#8221;</a>.</p>
<pre class="screen">java.lang.IllegalArgumentException: There is no PasswordEncoder mapped for the id "null"
	at org.springframework.security.crypto.password.DelegatingPasswordEncoder$UnmappedIdPasswordEncoder.matches(DelegatingPasswordEncoder.java:233)
	at org.springframework.security.crypto.password.DelegatingPasswordEncoder.matches(DelegatingPasswordEncoder.java:196)</pre>
<p>The easiest way to resolve the error is to switch to explicitly provide the <code class="literal">PasswordEncoder</code> that you passwords are encoded with.
The easiest way to resolve it is to figure out how your passwords are currently being stored and explicitly provide the correct <code class="literal">PasswordEncoder</code>.
If you are migrating from Spring Security 4.2.x you can revert to the previous behavior by exposing a <code class="literal">NoOpPasswordEncoder</code> bean.
For example, if you are using Java Configuration, you can create a configuration that looks like:</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>Reverting to <code class="literal">NoOpPasswordEncoder</code> is not considered to be secure.
You should instead migrate to using <code class="literal">DelegatingPasswordEncoder</code> to support secure password encoding.</p>
</td></tr></table></div>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> NoOpPasswordEncoder passwordEncoder() {
    <span class="hl-keyword">return</span> NoOpPasswordEncoder.getInstance();
}</pre>
<p>if you are using XML configuration, you can expose a <code class="literal">PasswordEncoder</code> with the id <code class="literal">passwordEncoder</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;b:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"passwordEncoder"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.crypto.NoOpPasswordEncoder"</span> <span class="hl-attribute">factory-method</span>=<span class="hl-value">"getInstance"</span><span class="hl-tag">/&gt;</span></pre>
<p>Alternatively, you can prefix all of your passwords with the correct id and continue to use <code class="literal">DelegatingPasswordEncoder</code>.
For example, if you are using BCrypt, you would migrate your password from something like:</p>
<pre class="screen">$2a$10$dXJ3SW6G7P50lGmMkkmwe.20cQQubK3.HZWzG3YB1tlRy.fqvM/BG</pre>
<p>to</p>
<pre class="screen">{bcrypt}$2a$10$dXJ3SW6G7P50lGmMkkmwe.20cQQubK3.HZWzG3YB1tlRy.fqvM/BG</pre>
<p>For a complete listing of the mappings refer to the Javadoc on
<a class="ulink" href="https://docs.spring.io/spring-security/site/docs/5.0.x/api/org/springframework/security/crypto/factory/PasswordEncoderFactories.html" target="_top">PasswordEncoderFactories</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="pe-bcpe" href="index.html#pe-bcpe"></a>10.3.3&nbsp;BCryptPasswordEncoder</h3></div></div></div>
<p>The <code class="literal">BCryptPasswordEncoder</code> implementation uses the widely supported <a class="ulink" href="https://en.wikipedia.org/wiki/Bcrypt" target="_top">bcrypt</a> algorithm to hash the passwords.
In order to make it more resistent to password cracking, bcrypt is deliberately slow.
Like other adaptive one-way functions, it should be tuned to take about 1 second to verify a password on your system.</p>
<pre class="programlisting"><span class="hl-comment">// Create an encoder with strength 16</span>
BCryptPasswordEncoder encoder = <span class="hl-keyword">new</span> BCryptPasswordEncoder(<span class="hl-number">16</span>);
String result = encoder.encode(<span class="hl-string">"myPassword"</span>);
assertTrue(encoder.matches(<span class="hl-string">"myPassword"</span>, result));</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="pe-pbkdf2pe" href="index.html#pe-pbkdf2pe"></a>10.3.4&nbsp;Pbkdf2PasswordEncoder</h3></div></div></div>
<p>The <code class="literal">Pbkdf2PasswordEncoder</code> implementation uses the <a class="ulink" href="https://en.wikipedia.org/wiki/PBKDF2" target="_top">PBKDF2</a> algorithm to hash the passwords.
In order to defeat password cracking PBKDF2 is a deliberately slow algorithm.
Like other adaptive one-way functions, it should be tuned to take about 1 second to verify a password on your system.
This algorithm is a good choice when FIPS certification is required.</p>
<pre class="programlisting"><span class="hl-comment">// Create an encoder with all the defaults</span>
Pbkdf2PasswordEncoder encoder = <span class="hl-keyword">new</span> Pbkdf2PasswordEncoder();
String result = encoder.encode(<span class="hl-string">"myPassword"</span>);
assertTrue(encoder.matches(<span class="hl-string">"myPassword"</span>, result));</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="pe-scpe" href="index.html#pe-scpe"></a>10.3.5&nbsp;SCryptPasswordEncoder</h3></div></div></div>
<p>The <code class="literal">SCryptPasswordEncoder</code> implementation uses <a class="ulink" href="https://en.wikipedia.org/wiki/Scrypt" target="_top">scrypt</a> algorithm to hash the passwords.
In order to defeat password cracking on custom hardware scrypt is a deliberately slow algorithm that requires large amounts of memory.
Like other adaptive one-way functions, it should be tuned to take about 1 second to verify a password on your system.</p>
<pre class="programlisting"><span class="hl-comment">// Create an encoder with all the defaults</span>
SCryptPasswordEncoder encoder = <span class="hl-keyword">new</span> SCryptPasswordEncoder();
String result = encoder.encode(<span class="hl-string">"myPassword"</span>);
assertTrue(encoder.matches(<span class="hl-string">"myPassword"</span>, result));</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="other-passwordencoders" href="index.html#other-passwordencoders"></a>10.3.6&nbsp;Other PasswordEncoders</h3></div></div></div>
<p>There are a significant number of other <code class="literal">PasswordEncoder</code> implementations that exist entirely for backward compatibility.
They are all deprecated to indicate that they are no longer considered secure.
However, there are no plans to remove them since it is difficult to migrate existing legacy systems.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jackson" href="index.html#jackson"></a>10.4&nbsp;Jackson Support</h2></div></div></div>
<p>Spring Security has added Jackson Support for persisting Spring Security related classes.
This can improve the performance of serializing Spring Security related classes when working with distributed sessions (i.e. session replication, Spring Session, etc).</p>
<p>To use it, register the <code class="literal">JacksonJacksonModules.getModules(ClassLoader)</code> as <a class="ulink" href="http://wiki.fasterxml.com/JacksonFeatureModules" target="_top">Jackson Modules</a>.</p>
<pre class="programlisting">ObjectMapper mapper = <span class="hl-keyword">new</span> ObjectMapper();
ClassLoader loader = getClass().getClassLoader();
List&lt;Module&gt; modules = SecurityJackson2Modules.getModules(loader);
mapper.registerModules(modules);

<span class="hl-comment">// ... use ObjectMapper as normally ...</span>
SecurityContext context = <span class="hl-keyword">new</span> SecurityContextImpl();
<span class="hl-comment">// ...</span>
String json = mapper.writeValueAsString(context);</pre>
</div>
</div>
</div>
<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="test" href="index.html#test"></a>Part&nbsp;III.&nbsp;Testing</h1></div></div></div>
<div class="partintro"><div></div>
<p>This section describes the testing support provided by Spring Security.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>To use the Spring Security test support, you must include <code class="literal">spring-security-test-5.0.0.RELEASE.jar</code> as a dependency of your project.</p>
</td></tr></table></div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="test-method" href="index.html#test-method"></a>11.&nbsp;Testing Method Security</h2></div></div></div>
<p>This section demonstrates how to use Spring Security&#8217;s Test support to test method based security.
We first introduce a <code class="literal">MessageService</code> that requires the user to be authenticated in order to access it.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> HelloMessageService <span class="hl-keyword">implements</span> MessageService {

	<em><span class="hl-annotation" style="color: gray">@PreAuthorize("authenticated")</span></em>
	<span class="hl-keyword">public</span> String getMessage() {
		Authentication authentication = SecurityContextHolder.getContext()
															.getAuthentication();
		<span class="hl-keyword">return</span> <span class="hl-string">"Hello "</span> + authentication;
	}
}</pre>
<p>The result of <code class="literal">getMessage</code> is a String saying "Hello" to the current Spring Security <code class="literal">Authentication</code>.
An example of the output is displayed below.</p>
<pre class="programlisting">Hello org.springframew<a href="https://docs.spring.io/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="8fe0fde4a1fceaecfafde6fbf6a1eefafbe7eae1fbe6eceefbe6e0e1a1dafceafde1eee2eadfeefcfcf8e0fdebcefafbe7eae1fbe6eceefbe6e0e1dbe0e4eae1cf">[email&#160;protected]</a>ca25360: Principal: <a href="https://docs.spring.io/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="bdd2cfda93cecdcfd4d3dadbcfdcd0d8cad2cfd693ced8dec8cfd4c9c493ded2cfd893c8ced8cfd9d8c9dcd4d1ce93e8ced8cffd8e8bd8dfdedf">[email&#160;protected]</a>: Username: user; Password: [PROTECTED]; Enabled: true; AccountNonExpired: true; credentialsNonExpired: true; AccountNonLocked: true; Granted Authorities: ROLE_USER; Credentials: [PROTECTED]; Authenticated: true; Details: null; Granted Authorities: ROLE_USER</pre>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="test-method-setup" href="index.html#test-method-setup"></a>11.1&nbsp;Security Test Setup</h2></div></div></div>
<p>Before we can use Spring Security Test support, we must perform some setup. An example can be seen below:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em> <a name="CO11-1" href="index.html#CO11-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em> <a name="CO11-2" href="index.html#CO11-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WithMockUserTests {</pre>
<p>This is a basic example of how to setup Spring Security Test. The highlights are:</p>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO11-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p><code class="literal">@RunWith</code> instructs the spring-test module that it should create an <code class="literal">ApplicationContext</code>. This is no different than using the existing Spring Test support. For additional information, refer to the <a class="ulink" href="https://docs.spring.io/spring-framework/docs/4.0.x/spring-framework-reference/htmlsingle/#integration-testing-annotations-standard" target="_top">Spring Reference</a></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO11-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p><code class="literal">@ContextConfiguration</code> instructs the spring-test the configuration to use to create the <code class="literal">ApplicationContext</code>. Since no configuration is specified, the default configuration locations will be tried. This is no different than using the existing Spring Test support. For additional information, refer to the <a class="ulink" href="https://docs.spring.io/spring-framework/docs/4.0.x/spring-framework-reference/htmlsingle/#testcontext-ctx-management" target="_top">Spring Reference</a></p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring Security hooks into Spring Test support using the <code class="literal">WithSecurityContextTestExecutionListener</code> which will ensure our tests are ran with the correct user.
It does this by populating the <code class="literal">SecurityContextHolder</code> prior to running our tests.
After the test is done, it will clear out the <code class="literal">SecurityContextHolder</code>.
If you only need Spring Security related support, you can replace <code class="literal">@ContextConfiguration</code> with <code class="literal">@SecurityTestExecutionListeners</code>.</p>
</td></tr></table></div>
<p>Remember we added the <code class="literal">@PreAuthorize</code> annotation to our <code class="literal">HelloMessageService</code> and so it requires an authenticated user to invoke it.
If we ran the following test, we would expect the following test will pass:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test(expected = AuthenticationCredentialsNotFoundException.class)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> getMessageUnauthenticated() {
	messageService.getMessage();
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="test-method-withmockuser" href="index.html#test-method-withmockuser"></a>11.2&nbsp;@WithMockUser</h2></div></div></div>
<p>The question is "How could we most easily run the test as a specific user?"
The answer is to use <code class="literal">@WithMockUser</code>.
The following test will be run as a user with the username "user", the password "password", and the roles "ROLE_USER".</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<em><span class="hl-annotation" style="color: gray">@WithMockUser</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> getMessageWithMockUser() {
String message = messageService.getMessage();
...
}</pre>
<p>Specifically the following is true:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The user with the username "user" does not have to exist since we are mocking the user
</li><li class="listitem">
The <code class="literal">Authentication</code> that is populated in the <code class="literal">SecurityContext</code> is of type <code class="literal">UsernamePasswordAuthenticationToken</code>
</li><li class="listitem">
The principal on the <code class="literal">Authentication</code> is Spring Security&#8217;s <code class="literal">User</code> object
</li><li class="listitem">
The <code class="literal">User</code> will have the username of "user", the password "password", and a single <code class="literal">GrantedAuthority</code> named "ROLE_USER" is used.
</li></ul></div>
<p>Our example is nice because we are able to leverage a lot of defaults.
What if we wanted to run the test with a different username?
The following test would run with the username "customUser". Again, the user does not need to actually exist.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<em><span class="hl-annotation" style="color: gray">@WithMockUser("customUsername")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> getMessageWithMockUserCustomUsername() {
	String message = messageService.getMessage();
...
}</pre>
<p>We can also easily customize the roles.
For example, this test will be invoked with the username "admin" and the roles "ROLE_USER" and "ROLE_ADMIN".</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<em><span class="hl-annotation" style="color: gray">@WithMockUser(username="admin",roles={"USER","ADMIN"})</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> getMessageWithMockUserCustomUser() {
	String message = messageService.getMessage();
	...
}</pre>
<p>If we do not want the value to automatically be prefixed with ROLE_ we can leverage the authorities attribute.
For example, this test will be invoked with the username "admin" and the authorities "USER" and "ADMIN".</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<em><span class="hl-annotation" style="color: gray">@WithMockUser(username = "admin", authorities = { "ADMIN", "USER" })</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> getMessageWithMockUserCustomAuthorities() {
	String message = messageService.getMessage();
	...
}</pre>
<p>Of course it can be a bit tedious placing the annotation on every test method.
Instead, we can place the annotation at the class level and every test will use the specified user.
For example, the following would run every test with a user with the username "admin", the password "password", and the roles "ROLE_USER" and "ROLE_ADMIN".</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@WithMockUser(username="admin",roles={"USER","ADMIN"})</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WithMockUserTests {</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="test-method-withanonymoususer" href="index.html#test-method-withanonymoususer"></a>11.3&nbsp;@WithAnonymousUser</h2></div></div></div>
<p>Using <code class="literal">@WithAnonymousUser</code> allows running as an anonymous user.
This is especially convenient when you wish to run most of your tests with a specific user, but want to run a few tests as an anonymous user.
For example, the following will run withMockUser1 and withMockUser2 using <a class="link" href="index.html#test-method-withmockuser" title="11.2&nbsp;@WithMockUser">@WithMockUser</a> and anonymous as an anonymous user.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@WithMockUser</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WithUserClassLevelAuthenticationTests {

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> withMockUser1() {
	}

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> withMockUser2() {
	}

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<em><span class="hl-annotation" style="color: gray">@WithAnonymousUser</span></em>
	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> anonymous() <span class="hl-keyword">throws</span> Exception {
		<span class="hl-comment">// override default to run as anonymous user</span>
	}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="test-method-withuserdetails" href="index.html#test-method-withuserdetails"></a>11.4&nbsp;@WithUserDetails</h2></div></div></div>
<p>While <code class="literal">@WithMockUser</code> is a very convenient way to get started, it may not work in all instances.
For example, it is common for applications to expect that the <code class="literal">Authentication</code> principal be of a specific type.
This is done so that the application can refer to the principal as the custom type and reduce coupling on Spring Security.</p>
<p>The custom principal is often times returned by a custom <code class="literal">UserDetailsService</code> that returns an object that implements both <code class="literal">UserDetails</code> and the custom type.
For situations like this, it is useful to create the test user using the custom <code class="literal">UserDetailsService</code>.
That is exactly what <code class="literal">@WithUserDetails</code> does.</p>
<p>Assuming we have a <code class="literal">UserDetailsService</code> exposed as a bean, the following test will be invoked with an <code class="literal">Authentication</code> of type <code class="literal">UsernamePasswordAuthenticationToken</code> and a principal that is returned from the <code class="literal">UserDetailsService</code> with the username of "user".</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<em><span class="hl-annotation" style="color: gray">@WithUserDetails</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> getMessageWithUserDetails() {
	String message = messageService.getMessage();
	...
}</pre>
<p>We can also customize the username used to lookup the user from our <code class="literal">UserDetailsService</code>.
For example, this test would be executed with a principal that is returned from the <code class="literal">UserDetailsService</code> with the username of "customUsername".</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<em><span class="hl-annotation" style="color: gray">@WithUserDetails("customUsername")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> getMessageWithUserDetailsCustomUsername() {
	String message = messageService.getMessage();
	...
}</pre>
<p>We can also provide an explicit bean name to look up the <code class="literal">UserDetailsService</code>.
For example, this test would look up the username of "customUsername" using the <code class="literal">UserDetailsService</code> with the bean name "myUserDetailsService".</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<em><span class="hl-annotation" style="color: gray">@WithUserDetails(value="customUsername", userDetailsServiceBeanName="myUserDetailsService")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> getMessageWithUserDetailsServiceBeanName() {
	String message = messageService.getMessage();
	...
}</pre>
<p>Like <code class="literal">@WithMockUser</code> we can also place our annotation at the class level so that every test uses the same user.
However unlike <code class="literal">@WithMockUser</code>, <code class="literal">@WithUserDetails</code> requires the user to exist.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="test-method-withsecuritycontext" href="index.html#test-method-withsecuritycontext"></a>11.5&nbsp;@WithSecurityContext</h2></div></div></div>
<p>We have seen that <code class="literal">@WithMockUser</code> is an excellent choice if we are not using a custom <code class="literal">Authentication</code> principal.
Next we discovered that <code class="literal">@WithUserDetails</code> would allow us to use a custom <code class="literal">UserDetailsService</code> to create our <code class="literal">Authentication</code> principal but required the user to exist.
We will now see an option that allows the most flexibility.</p>
<p>We can create our own annotation that uses the <code class="literal">@WithSecurityContext</code> to create any <code class="literal">SecurityContext</code> we want.
For example, we might create an annotation named <code class="literal">@WithMockCustomUser</code> as shown below:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></em>
<em><span class="hl-annotation" style="color: gray">@WithSecurityContext(factory = WithMockCustomUserSecurityContextFactory.class)</span></em>
<span class="hl-keyword">public</span> <em><span class="hl-annotation" style="color: gray">@interface</span></em> WithMockCustomUser {

	String username() <span class="hl-keyword">default</span> <span class="hl-string">"rob"</span>;

	String name() <span class="hl-keyword">default</span> <span class="hl-string">"Rob Winch"</span>;
}</pre>
<p>You can see that <code class="literal">@WithMockCustomUser</code> is annotated with the <code class="literal">@WithSecurityContext</code> annotation.
This is what signals to Spring Security Test support that we intend to create a <code class="literal">SecurityContext</code> for the test.
The <code class="literal">@WithSecurityContext</code> annotation requires we specify a <code class="literal">SecurityContextFactory</code> that will create a new <code class="literal">SecurityContext</code> given our <code class="literal">@WithMockCustomUser</code> annotation.
You can find our <code class="literal">WithMockCustomUserSecurityContextFactory</code> implementation below:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WithMockCustomUserSecurityContextFactory
	<span class="hl-keyword">implements</span> WithSecurityContextFactory&lt;WithMockCustomUser&gt; {
	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">public</span> SecurityContext createSecurityContext(WithMockCustomUser customUser) {
		SecurityContext context = SecurityContextHolder.createEmptyContext();

		CustomUserDetails principal =
			<span class="hl-keyword">new</span> CustomUserDetails(customUser.name(), customUser.username());
		Authentication auth =
			<span class="hl-keyword">new</span> UsernamePasswordAuthenticationToken(principal, <span class="hl-string">"password"</span>, principal.getAuthorities());
		context.setAuthentication(auth);
		<span class="hl-keyword">return</span> context;
	}
}</pre>
<p>We can now annotate a test class or a test method with our new annotation and Spring Security&#8217;s <code class="literal">WithSecurityContextTestExecutionListener</code> will ensure that our <code class="literal">SecurityContext</code> is populated appropriately.</p>
<p>When creating your own <code class="literal">WithSecurityContextFactory</code> implementations, it is nice to know that they can be annotated with standard Spring annotations.
For example, the <code class="literal">WithUserDetailsSecurityContextFactory</code> uses the <code class="literal">@Autowired</code> annotation to acquire the <code class="literal">UserDetailsService</code>:</p>
<pre class="programlisting"><span class="hl-keyword">final</span> <span class="hl-keyword">class</span> WithUserDetailsSecurityContextFactory
	<span class="hl-keyword">implements</span> WithSecurityContextFactory&lt;WithUserDetails&gt; {

	<span class="hl-keyword">private</span> UserDetailsService userDetailsService;

	<em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
	<span class="hl-keyword">public</span> WithUserDetailsSecurityContextFactory(UserDetailsService userDetailsService) {
		<span class="hl-keyword">this</span>.userDetailsService = userDetailsService;
	}

	<span class="hl-keyword">public</span> SecurityContext createSecurityContext(WithUserDetails withUser) {
		String username = withUser.value();
		Assert.hasLength(username, <span class="hl-string">"value() must be non-empty String"</span>);
		UserDetails principal = userDetailsService.loadUserByUsername(username);
		Authentication authentication = <span class="hl-keyword">new</span> UsernamePasswordAuthenticationToken(principal, principal.getPassword(), principal.getAuthorities());
		SecurityContext context = SecurityContextHolder.createEmptyContext();
		context.setAuthentication(authentication);
		<span class="hl-keyword">return</span> context;
	}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="test-method-meta-annotations" href="index.html#test-method-meta-annotations"></a>11.6&nbsp;Test Meta Annotations</h2></div></div></div>
<p>If you reuse the same user within your tests often, it is not ideal to have to repeatedly specify the attributes.
For example, if there are many tests related to an administrative user with the username "admin" and the roles <code class="literal">ROLE_USER</code> and <code class="literal">ROLE_ADMIN</code> you would have to write:</p>
<pre class="programlisting">@WithMockUser(username=<span class="hl-string">"admin"</span>,roles={<span class="hl-string">"USER"</span>,<span class="hl-string">"ADMIN"</span>})</pre>
<p>Rather than repeating this everywhere, we can use a meta annotation.
For example, we could create a meta annotation named <code class="literal">WithMockAdmin</code>:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></em>
<em><span class="hl-annotation" style="color: gray">@WithMockUser(value="rob",roles="ADMIN")</span></em>
<span class="hl-keyword">public</span> <em><span class="hl-annotation" style="color: gray">@interface</span></em> WithMockAdmin { }</pre>
<p>Now we can use <code class="literal">@WithMockAdmin</code> in the same way as the more verbose <code class="literal">@WithMockUser</code>.</p>
<p>Meta annotations work with any of the testing annotations described above.
For example, this means we could create a meta annotation for <code class="literal">@WithUserDetails("admin")</code> as well.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="test-mockmvc" href="index.html#test-mockmvc"></a>12.&nbsp;Spring MVC Test Integration</h2></div></div></div>
<p>Spring Security provides comprehensive integration with <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/testing.html#spring-mvc-test-framework" target="_top">Spring MVC Test</a></p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="test-mockmvc-setup" href="index.html#test-mockmvc-setup"></a>12.1&nbsp;Setting Up MockMvc and Spring Security</h2></div></div></div>
<p>In order to use Spring Security with Spring MVC Test it is necessary to add the Spring Security <code class="literal">FilterChainProxy</code> as a <code class="literal">Filter</code>.
It is also necessary to add Spring Security&#8217;s <code class="literal">TestSecurityContextHolderPostProcessor</code> to support <a class="link" href="index.html#running-as-a-user-in-spring-mvc-test-with-annotations" title="Running as a User in Spring MVC Test with Annotations">Running as a User in Spring MVC Test with Annotations</a>.
This can be done using Spring Security&#8217;s <code class="literal">SecurityMockMvcConfigurers.springSecurity()</code>.
For example:</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring Security&#8217;s testing support requires spring-test-4.1.3.RELEASE or greater.</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-keyword">import</span> <span class="hl-keyword">static</span> org.springframework.security.test.web.servlet.setup.SecurityMockMvcConfigurers.*;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CsrfShowcaseTests {

	<em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
	<span class="hl-keyword">private</span> WebApplicationContext context;

	<span class="hl-keyword">private</span> MockMvc mvc;

	<em><span class="hl-annotation" style="color: gray">@Before</span></em>
	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setup() {
		mvc = MockMvcBuilders
				.webAppContextSetup(context)
				.apply(springSecurity()) <a name="CO12-1" href="index.html#CO12-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
				.build();
	}

...</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO12-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p><code class="literal">SecurityMockMvcConfigurers.springSecurity()</code> will perform all of the initial setup we need to integrate Spring Security with Spring MVC Test</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="test-mockmvc-smmrpp" href="index.html#test-mockmvc-smmrpp"></a>12.2&nbsp;SecurityMockMvcRequestPostProcessors</h2></div></div></div>
<p>Spring MVC Test provides a convenient interface called a <code class="literal">RequestPostProcessor</code> that can be used to modify a request.
Spring Security provides a number of <code class="literal">RequestPostProcessor</code> implementations that make testing easier.
In order to use Spring Security&#8217;s <code class="literal">RequestPostProcessor</code> implementations ensure the following static import is used:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> <span class="hl-keyword">static</span> org.springframework.security.test.web.servlet.request.SecurityMockMvcRequestPostProcessors.*;</pre>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="test-mockmvc-csrf" href="index.html#test-mockmvc-csrf"></a>12.2.1&nbsp;Testing with CSRF Protection</h3></div></div></div>
<p>When testing any non-safe HTTP methods and using Spring Security&#8217;s CSRF protection, you must be sure to include a valid CSRF Token in the request.
To specify a valid CSRF token as a request parameter using the following:</p>
<pre class="programlisting">mvc
	.perform(post(<span class="hl-string">"/"</span>).with(csrf()))</pre>
<p>If you like you can include CSRF token in the header instead:</p>
<pre class="programlisting">mvc
	.perform(post(<span class="hl-string">"/"</span>).with(csrf().asHeader()))</pre>
<p>You can also test providing an invalid CSRF token using the following:</p>
<pre class="programlisting">mvc
	.perform(post(<span class="hl-string">"/"</span>).with(csrf().useInvalidToken()))</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="test-mockmvc-securitycontextholder" href="index.html#test-mockmvc-securitycontextholder"></a>12.2.2&nbsp;Running a Test as a User in Spring MVC Test</h3></div></div></div>
<p>It is often desirable to run tests as a specific user.
There are two simple ways of populating the user:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#test-mockmvc-securitycontextholder-rpp" title="12.2.3&nbsp;Running as a User in Spring MVC Test with RequestPostProcessor">Running as a User in Spring MVC Test with RequestPostProcessor</a>
</li><li class="listitem">
<a class="link" href="index.html#running-as-a-user-in-spring-mvc-test-with-annotations" title="Running as a User in Spring MVC Test with Annotations">Running as a User in Spring MVC Test with Annotations</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="test-mockmvc-securitycontextholder-rpp" href="index.html#test-mockmvc-securitycontextholder-rpp"></a>12.2.3&nbsp;Running as a User in Spring MVC Test with RequestPostProcessor</h3></div></div></div>
<p>There are a number of options available to associate a user to the current <code class="literal">HttpServletRequest</code>.
For example, the following will run as a user (which does not need to exist) with the username "user", the password "password", and the role "ROLE_USER":</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The support works by associating the user to the <code class="literal">HttpServletRequest</code>.
To associate the request to the <code class="literal">SecurityContextHolder</code> you need to ensure that the <code class="literal">SecurityContextPersistenceFilter</code> is associated with the <code class="literal">MockMvc</code> instance.
A few ways to do this are:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Invoking <a class="link" href="index.html#test-mockmvc-setup" title="12.1&nbsp;Setting Up MockMvc and Spring Security">apply(springSecurity())</a>
</li><li class="listitem">
Adding Spring Security&#8217;s <code class="literal">FilterChainProxy</code> to <code class="literal">MockMvc</code>
</li><li class="listitem">
Manually adding <code class="literal">SecurityContextPersistenceFilter</code> to the <code class="literal">MockMvc</code> instance may make sense when using <code class="literal">MockMvcBuilders.standaloneSetup</code>
</li></ul></div>
</td></tr></table></div>
<pre class="programlisting">mvc
	.perform(get(<span class="hl-string">"/"</span>).with(user(<span class="hl-string">"user"</span>)))</pre>
<p>You can easily make customizations.
For example, the following will run as a user (which does not need to exist) with the username "admin", the password "pass", and the roles "ROLE_USER" and "ROLE_ADMIN".</p>
<pre class="programlisting">mvc
	.perform(get(<span class="hl-string">"/admin"</span>).with(user(<span class="hl-string">"admin"</span>).password(<span class="hl-string">"pass"</span>).roles(<span class="hl-string">"USER"</span>,<span class="hl-string">"ADMIN"</span>)))</pre>
<p>If you have a custom <code class="literal">UserDetails</code> that you would like to use, you can easily specify that as well.
For example, the following will use the specified <code class="literal">UserDetails</code> (which does not need to exist) to run with a <code class="literal">UsernamePasswordAuthenticationToken</code> that has a principal of the specified <code class="literal">UserDetails</code>:</p>
<pre class="programlisting">mvc
	.perform(get(<span class="hl-string">"/"</span>).with(user(userDetails)))</pre>
<p>You can run as anonymous user using the following:</p>
<pre class="programlisting">mvc
	.perform(get(<span class="hl-string">"/"</span>).with(anonymous()))</pre>
<p>This is especially useful if you are running with a default user and wish to execute a few requests as an anonymous user.</p>
<p>If you want a custom <code class="literal">Authentication</code> (which does not need to exist) you can do so using the following:</p>
<pre class="programlisting">mvc
	.perform(get(<span class="hl-string">"/"</span>).with(authentication(authentication)))</pre>
<p>You can even customize the <code class="literal">SecurityContext</code> using the following:</p>
<pre class="programlisting">mvc
	.perform(get(<span class="hl-string">"/"</span>).with(securityContext(securityContext)))</pre>
<p>We can also ensure to run as a specific user for every request by using <code class="literal">MockMvcBuilders</code>'s default request.
For example, the following will run as a user (which does not need to exist) with the username "admin", the password "password", and the role "ROLE_ADMIN":</p>
<pre class="programlisting">mvc = MockMvcBuilders
		.webAppContextSetup(context)
		.defaultRequest(get(<span class="hl-string">"/"</span>).with(user(<span class="hl-string">"user"</span>).roles(<span class="hl-string">"ADMIN"</span>)))
		.apply(springSecurity())
		.build();</pre>
<p>If you find you are using the same user in many of your tests, it is recommended to move the user to a method.
For example, you can specify the following in your own class named <code class="literal">CustomSecurityMockMvcRequestPostProcessors</code>:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> RequestPostProcessor rob() {
	<span class="hl-keyword">return</span> user(<span class="hl-string">"rob"</span>).roles(<span class="hl-string">"ADMIN"</span>);
}</pre>
<p>Now you can perform a static import on <code class="literal">SecurityMockMvcRequestPostProcessors</code> and use that within your tests:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> <span class="hl-keyword">static</span> sample.CustomSecurityMockMvcRequestPostProcessors.*;

...

mvc
	.perform(get(<span class="hl-string">"/"</span>).with(rob()))</pre>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="running-as-a-user-in-spring-mvc-test-with-annotations" href="index.html#running-as-a-user-in-spring-mvc-test-with-annotations"></a>Running as a User in Spring MVC Test with Annotations</h4></div></div></div>
<p>As an alternative to using a <code class="literal">RequestPostProcessor</code> to create your user, you can use annotations described in <a class="xref" href="index.html#test-method" title="11.&nbsp;Testing Method Security">Chapter&nbsp;11, <i>Testing Method Security</i></a>.
For example, the following will run the test with the user with username "user", password "password", and role "ROLE_USER":</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<em><span class="hl-annotation" style="color: gray">@WithMockUser</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> requestProtectedUrlWithUser() <span class="hl-keyword">throws</span> Exception {
mvc
		.perform(get(<span class="hl-string">"/"</span>))
		...
}</pre>
<p>Alternatively, the following will run the test with the user with username "user", password "password", and role "ROLE_ADMIN":</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<em><span class="hl-annotation" style="color: gray">@WithMockUser(roles="ADMIN")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> requestProtectedUrlWithUser() <span class="hl-keyword">throws</span> Exception {
mvc
		.perform(get(<span class="hl-string">"/"</span>))
		...
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="testing-http-basic-authentication" href="index.html#testing-http-basic-authentication"></a>12.2.4&nbsp;Testing HTTP Basic Authentication</h3></div></div></div>
<p>While it has always been possible to authenticate with HTTP Basic, it was a bit tedious to remember the header name, format, and encode the values.
Now this can be done using Spring Security&#8217;s <code class="literal">httpBasic</code> <code class="literal">RequestPostProcessor</code>.
For example, the snippet below:</p>
<pre class="programlisting">mvc
	.perform(get(<span class="hl-string">"/"</span>).with(httpBasic(<span class="hl-string">"user"</span>,<span class="hl-string">"password"</span>)))</pre>
<p>will attempt to use HTTP Basic to authenticate a user with the username "user" and the password "password" by ensuring the following header is populated on the HTTP Request:</p>
<pre class="programlisting">Authorization: Basic dXNlcjpwYXNzd29yZA==</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="securitymockmvcrequestbuilders" href="index.html#securitymockmvcrequestbuilders"></a>12.3&nbsp;SecurityMockMvcRequestBuilders</h2></div></div></div>
<p>Spring MVC Test also provides a <code class="literal">RequestBuilder</code> interface that can be used to create the <code class="literal">MockHttpServletRequest</code> used in your test.
Spring Security provides a few <code class="literal">RequestBuilder</code> implementations that can be used to make testing easier.
In order to use Spring Security&#8217;s <code class="literal">RequestBuilder</code> implementations ensure the following static import is used:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> <span class="hl-keyword">static</span> org.springframework.security.test.web.servlet.request.SecurityMockMvcRequestBuilders.*;</pre>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="testing-form-based-authentication" href="index.html#testing-form-based-authentication"></a>12.3.1&nbsp;Testing Form Based Authentication</h3></div></div></div>
<p>You can easily create a request to test a form based authentication using Spring Security&#8217;s testing support.
For example, the following will submit a POST to "/login" with the username "user", the password "password", and a valid CSRF token:</p>
<pre class="programlisting">mvc
	.perform(formLogin())</pre>
<p>It is easy to customize the request.
For example, the following will submit a POST to "/auth" with the username "admin", the password "pass", and a valid CSRF token:</p>
<pre class="programlisting">mvc
	.perform(formLogin(<span class="hl-string">"/auth"</span>).user(<span class="hl-string">"admin"</span>).password(<span class="hl-string">"pass"</span>))</pre>
<p>We can also customize the parameters names that the username and password are included on.
For example, this is the above request modified to include the username on the HTTP parameter "u" and the password on the HTTP parameter "p".</p>
<pre class="programlisting">mvc
	.perform(formLogin(<span class="hl-string">"/auth"</span>).user(<span class="hl-string">"u"</span>,<span class="hl-string">"admin"</span>).password(<span class="hl-string">"p"</span>,<span class="hl-string">"pass"</span>))</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="test-logout" href="index.html#test-logout"></a>12.3.2&nbsp;Testing Logout</h3></div></div></div>
<p>While fairly trivial using standard Spring MVC Test, you can use Spring Security&#8217;s testing support to make testing log out easier.
For example, the following will submit a POST to "/logout" with a valid CSRF token:</p>
<pre class="programlisting">mvc
	.perform(logout())</pre>
<p>You can also customize the URL to post to.
For example, the snippet below will submit a POST to "/signout" with a valid CSRF token:</p>
<pre class="programlisting">mvc
	.perform(logout(<span class="hl-string">"/signout"</span>))</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="securitymockmvcresultmatchers" href="index.html#securitymockmvcresultmatchers"></a>12.4&nbsp;SecurityMockMvcResultMatchers</h2></div></div></div>
<p>At times it is desirable to make various security related assertions about a request.
To accommodate this need, Spring Security Test support implements Spring MVC Test&#8217;s <code class="literal">ResultMatcher</code> interface.
In order to use Spring Security&#8217;s <code class="literal">ResultMatcher</code> implementations ensure the following static import is used:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> <span class="hl-keyword">static</span> org.springframework.security.test.web.servlet.response.SecurityMockMvcResultMatchers.*;</pre>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="unauthenticated-assertion" href="index.html#unauthenticated-assertion"></a>12.4.1&nbsp;Unauthenticated Assertion</h3></div></div></div>
<p>At times it may be valuable to assert that there is no authenticated user associated with the result of a <code class="literal">MockMvc</code> invocation.
For example, you might want to test submitting an invalid username and password and verify that no user is authenticated.
You can easily do this with Spring Security&#8217;s testing support using something like the following:</p>
<pre class="programlisting">mvc
	.perform(formLogin().password(<span class="hl-string">"invalid"</span>))
	.andExpect(unauthenticated());</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="authenticated-assertion" href="index.html#authenticated-assertion"></a>12.4.2&nbsp;Authenticated Assertion</h3></div></div></div>
<p>It is often times that we must assert that an authenticated user exists.
For example, we may want to verify that we authenticated successfully.
We could verify that a form based login was successful with the following snippet of code:</p>
<pre class="programlisting">mvc
	.perform(formLogin())
	.andExpect(authenticated());</pre>
<p>If we wanted to assert the roles of the user, we could refine our previous code as shown below:</p>
<pre class="programlisting">mvc
	.perform(formLogin().user(<span class="hl-string">"admin"</span>))
	.andExpect(authenticated().withRoles(<span class="hl-string">"USER"</span>,<span class="hl-string">"ADMIN"</span>));</pre>
<p>Alternatively, we could verify the username:</p>
<pre class="programlisting">mvc
	.perform(formLogin().user(<span class="hl-string">"admin"</span>))
	.andExpect(authenticated().withUsername(<span class="hl-string">"admin"</span>));</pre>
<p>We can also combine the assertions:</p>
<pre class="programlisting">mvc
	.perform(formLogin().user(<span class="hl-string">"admin"</span>).roles(<span class="hl-string">"USER"</span>,<span class="hl-string">"ADMIN"</span>))
	.andExpect(authenticated().withUsername(<span class="hl-string">"admin"</span>));</pre>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="test-webflux" href="index.html#test-webflux"></a>13.&nbsp;WebFlux Support</h2></div></div></div>
<p>Spring Security provides test integration with Spring WebFlux for both method security and WebFlux.
You can find a complete working sample at <a class="ulink" href="https://github.com/spring-projects/spring-security/tree/5.0.0.RELEASE/samples/javaconfig/hellowebflux-method" target="_top">hellowebflux-method</a></p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="test-erms" href="index.html#test-erms"></a>13.1&nbsp;Reactive Method Security</h2></div></div></div>
<p>For example, we can test our example from <a class="xref" href="index.html#jc-erms" title="5.10.3&nbsp;EnableReactiveMethodSecurity">Section&nbsp;5.10.3, &#8220;EnableReactiveMethodSecurity&#8221;</a> using the same setup and annotations we did in <a class="xref" href="index.html#test-method" title="11.&nbsp;Testing Method Security">Chapter&nbsp;11, <i>Testing Method Security</i></a>.
Here is a minimal sample of what we can do:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration(classes = HelloWebfluxMethodApplication.class)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> HelloWorldMessageServiceTests {
	<em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
	HelloWorldMessageService messages;

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> messagesWhenNotAuthenticatedThenDenied() {
		StepVerifier.create(<span class="hl-keyword">this</span>.messages.findMessage())
			.expectError(AccessDeniedException.<span class="hl-keyword">class</span>)
			.verify();
	}

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<em><span class="hl-annotation" style="color: gray">@WithMockUser</span></em>
	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> messagesWhenUserThenDenied() {
		StepVerifier.create(<span class="hl-keyword">this</span>.messages.findMessage())
			.expectError(AccessDeniedException.<span class="hl-keyword">class</span>)
			.verify();
	}

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<em><span class="hl-annotation" style="color: gray">@WithMockUser(roles = "ADMIN")</span></em>
	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> messagesWhenAdminThenOk() {
		StepVerifier.create(<span class="hl-keyword">this</span>.messages.findMessage())
			.expectNext(<span class="hl-string">"Hello World!"</span>)
			.verifyComplete();
	}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="test-webtestclient" href="index.html#test-webtestclient"></a>13.2&nbsp;WebTestClientSupport</h2></div></div></div>
<p>Spring Security provides integration with <code class="literal">WebTestClient</code>.
The basic setup looks like this:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration(classes = HelloWebfluxMethodApplication.class)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> HelloWebfluxMethodApplicationTests {
	<em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
	ApplicationContext context;

	WebTestClient rest;

	<em><span class="hl-annotation" style="color: gray">@Before</span></em>
	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setup() {
		<span class="hl-keyword">this</span>.rest = WebTestClient
			.bindToApplicationContext(<span class="hl-keyword">this</span>.context)
			<span class="hl-comment">// add Spring Security test Support</span>
			.apply(springSecurity())
			.configureClient()
			.filter(basicAuthentication())
			.build();
	}
	<span class="hl-comment">// ...</span>
}</pre>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="authentication" href="index.html#authentication"></a>13.2.1&nbsp;Authentication</h3></div></div></div>
<p>After applying the Spring Security support to <code class="literal">WebTestClient</code> we can use either annotations or <code class="literal">mutateWith</code> support.
For example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> messageWhenNotAuthenticated() <span class="hl-keyword">throws</span> Exception {
	<span class="hl-keyword">this</span>.rest
		.get()
		.uri(<span class="hl-string">"/message"</span>)
		.exchange()
		.expectStatus().isUnauthorized();
}

<span class="hl-comment">// --- WithMockUser ---</span>

<em><span class="hl-annotation" style="color: gray">@Test</span></em>
<em><span class="hl-annotation" style="color: gray">@WithMockUser</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> messageWhenWithMockUserThenForbidden() <span class="hl-keyword">throws</span> Exception {
	<span class="hl-keyword">this</span>.rest
		.get()
		.uri(<span class="hl-string">"/message"</span>)
		.exchange()
		.expectStatus().isEqualTo(HttpStatus.FORBIDDEN);
}

<em><span class="hl-annotation" style="color: gray">@Test</span></em>
<em><span class="hl-annotation" style="color: gray">@WithMockUser(roles = "ADMIN")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> messageWhenWithMockAdminThenOk() <span class="hl-keyword">throws</span> Exception {
	<span class="hl-keyword">this</span>.rest
		.get()
		.uri(<span class="hl-string">"/message"</span>)
		.exchange()
		.expectStatus().isOk()
		.expectBody(String.<span class="hl-keyword">class</span>).isEqualTo(<span class="hl-string">"Hello World!"</span>);
}

<span class="hl-comment">// --- mutateWith mockUser ---</span>

<em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> messageWhenMutateWithMockUserThenForbidden() <span class="hl-keyword">throws</span> Exception {
	<span class="hl-keyword">this</span>.rest
		.mutateWith(mockUser())
		.get()
		.uri(<span class="hl-string">"/message"</span>)
		.exchange()
		.expectStatus().isEqualTo(HttpStatus.FORBIDDEN);
}

<em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> messageWhenMutateWithMockAdminThenOk() <span class="hl-keyword">throws</span> Exception {
	<span class="hl-keyword">this</span>.rest
		.mutateWith(mockUser().roles(<span class="hl-string">"ADMIN"</span>))
		.get()
		.uri(<span class="hl-string">"/message"</span>)
		.exchange()
		.expectStatus().isOk()
		.expectBody(String.<span class="hl-keyword">class</span>).isEqualTo(<span class="hl-string">"Hello World!"</span>);
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="csrf-support" href="index.html#csrf-support"></a>13.2.2&nbsp;CSRF Support</h3></div></div></div>
<p>Spring Security also provides support for CSRF testing with <code class="literal">WebTestClient</code>.
For example:</p>
<pre class="programlisting"><span class="hl-keyword">this</span>.rest
	<span class="hl-comment">// provide a valid CSRF token</span>
	.mutateWith(csrf())
	.post()
	.uri(<span class="hl-string">"/login"</span>)
	...</pre>
</div>
</div>
</div>
</div>
<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="web-app-security" href="index.html#web-app-security"></a>Part&nbsp;IV.&nbsp;Web Application Security</h1></div></div></div>
<div class="partintro"><div></div>
<p>Most Spring Security users will be using the framework in applications which make user of HTTP and the Servlet API. In this part, we&#8217;ll take a look at how Spring Security provides authentication and access-control features for the web layer of an application. We&#8217;ll look behind the facade of the namespace and see which classes and interfaces are actually assembled to provide web-layer security. In some situations it is necessary to use traditional bean configuration to provide full control over the configuration, so we&#8217;ll also see how to configure these classes directly without the namespace.</p>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="security-filter-chain" href="index.html#security-filter-chain"></a>14.&nbsp;The Security Filter Chain</h2></div></div></div>
<p>Spring Security&#8217;s web infrastructure is based entirely on standard servlet filters. It doesn&#8217;t use servlets or any other servlet-based frameworks (such as Spring MVC) internally, so it has no strong links to any particular web technology. It deals in <code class="literal">HttpServletRequest</code> s and <code class="literal">HttpServletResponse</code> s and doesn&#8217;t care whether the requests come from a browser, a web service client, an <code class="literal">HttpInvoker</code> or an AJAX application.</p>
<p>Spring Security maintains a filter chain internally where each of the filters has a particular responsibility and filters are added or removed from the configuration depending on which services are required. The ordering of the filters is important as there are dependencies between them. If you have been using <a class="link" href="index.html#ns-config" title="6.&nbsp;Security Namespace Configuration">namespace configuration</a>, then the filters are automatically configured for you and you don&#8217;t have to define any Spring beans explicitly but here may be times when you want full control over the security filter chain, either because you are using features which aren&#8217;t supported in the namespace, or you are using your own customized versions of classes.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="delegating-filter-proxy" href="index.html#delegating-filter-proxy"></a>14.1&nbsp;DelegatingFilterProxy</h2></div></div></div>
<p>When using servlet filters, you obviously need to declare them in your <code class="literal">web.xml</code>, or they will be ignored by the servlet container. In Spring Security, the filter classes are also Spring beans defined in the application context and thus able to take advantage of Spring&#8217;s rich dependency-injection facilities and lifecycle interfaces. Spring&#8217;s <code class="literal">DelegatingFilterProxy</code> provides the link between <code class="literal">web.xml</code> and the application context.</p>
<p>When using <code class="literal">DelegatingFilterProxy</code>, you will see something like this in the <code class="literal">web.xml</code> file:</p>
<pre class="programlisting"><span class="hl-tag">&lt;filter&gt;</span>
<span class="hl-tag">&lt;filter-name&gt;</span>myFilter<span class="hl-tag">&lt;/filter-name&gt;</span>
<span class="hl-tag">&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="hl-tag">&lt;/filter-class&gt;</span>
<span class="hl-tag">&lt;/filter&gt;</span>

<span class="hl-tag">&lt;filter-mapping&gt;</span>
<span class="hl-tag">&lt;filter-name&gt;</span>myFilter<span class="hl-tag">&lt;/filter-name&gt;</span>
<span class="hl-tag">&lt;url-pattern&gt;</span>/*<span class="hl-tag">&lt;/url-pattern&gt;</span>
<span class="hl-tag">&lt;/filter-mapping&gt;</span></pre>
<p>Notice that the filter is actually a <code class="literal">DelegatingFilterProxy</code>, and not the class that will actually implement the logic of the filter. What <code class="literal">DelegatingFilterProxy</code> does is delegate the <code class="literal">Filter</code> 's methods through to a bean which is obtained from the Spring application context. This enables the bean to benefit from the Spring web application context lifecycle support and configuration flexibility. The bean must implement <code class="literal">javax.servlet.Filter</code> and it must have the same name as that in the <code class="literal">filter-name</code> element. Read the Javadoc for <code class="literal">DelegatingFilterProxy</code> for more information</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="filter-chain-proxy" href="index.html#filter-chain-proxy"></a>14.2&nbsp;FilterChainProxy</h2></div></div></div>
<p>Spring Security&#8217;s web infrastructure should only be used by delegating to an instance of <code class="literal">FilterChainProxy</code>. The security filters should not be used by themselves. In theory you could declare each Spring Security filter bean that you require in your application context file and add a corresponding <code class="literal">DelegatingFilterProxy</code> entry to <code class="literal">web.xml</code> for each filter, making sure that they are ordered correctly, but this would be cumbersome and would clutter up the <code class="literal">web.xml</code> file quickly if you have a lot of filters. <code class="literal">FilterChainProxy</code> lets us add a single entry to <code class="literal">web.xml</code> and deal entirely with the application context file for managing our web security beans. It is wired using a <code class="literal">DelegatingFilterProxy</code>, just like in the example above, but with the <code class="literal">filter-name</code> set to the bean name "filterChainProxy". The filter chain is then declared in the application context with the same bean name. Here&#8217;s an example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filterChainProxy"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.FilterChainProxy"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;constructor-arg&gt;</span>
	<span class="hl-tag">&lt;list&gt;</span>
	<span class="hl-tag">&lt;sec:filter-chain</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/restful/**"</span> <span class="hl-attribute">filters</span>=<span class="hl-value">"
		securityContextPersistenceFilterWithASCFalse,
		basicAuthenticationFilter,
		exceptionTranslationFilter,
		filterSecurityInterceptor"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;sec:filter-chain</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/**"</span> <span class="hl-attribute">filters</span>=<span class="hl-value">"
		securityContextPersistenceFilterWithASCTrue,
		formLoginFilter,
		exceptionTranslationFilter,
		filterSecurityInterceptor"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/list&gt;</span>
<span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>The namespace element <code class="literal">filter-chain</code> is used for convenience to set up the security filter chain(s) which are required within the application. <a href="index.html#ftn.d5e3117" class="footnote" name="d5e3117"><sup class="footnote">[6]</sup></a>. It maps a particular URL pattern to a list of filters built up from the bean names specified in the <code class="literal">filters</code> element, and combines them in a bean of type <code class="literal">SecurityFilterChain</code>. The <code class="literal">pattern</code> attribute takes an Ant Paths and the most specific URIs should appear first <a href="index.html#ftn.d5e3123" class="footnote" name="d5e3123"><sup class="footnote">[7]</sup></a>. At runtime the <code class="literal">FilterChainProxy</code> will locate the first URI pattern that matches the current web request and the list of filter beans specified by the <code class="literal">filters</code> attribute will be applied to that request. The filters will be invoked in the order they are defined, so you have complete control over the filter chain which is applied to a particular URL.</p>
<p>You may have noticed we have declared two <code class="literal">SecurityContextPersistenceFilter</code> s in the filter chain (<code class="literal">ASC</code> is short for <code class="literal">allowSessionCreation</code>, a property of <code class="literal">SecurityContextPersistenceFilter</code>). As web services will never present a <code class="literal">jsessionid</code> on future requests, creating <code class="literal">HttpSession</code> s for such user agents would be wasteful. If you had a high-volume application which required maximum scalability, we recommend you use the approach shown above. For smaller applications, using a single <code class="literal">SecurityContextPersistenceFilter</code> (with its default <code class="literal">allowSessionCreation</code> as <code class="literal">true</code>) would likely be sufficient.</p>
<p>Note that <code class="literal">FilterChainProxy</code> does not invoke standard filter lifecycle methods on the filters it is configured with. We recommend you use Spring&#8217;s application context lifecycle interfaces as an alternative, just as you would for any other Spring bean.</p>
<p>When we looked at how to set up web security using <a class="link" href="index.html#ns-web-xml" title="6.2.1&nbsp;web.xml Configuration">namespace configuration</a>, we used a <code class="literal">DelegatingFilterProxy</code> with the name "springSecurityFilterChain". You should now be able to see that this is the name of the <code class="literal">FilterChainProxy</code> which is created by the namespace.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="bypassing-the-filter-chain" href="index.html#bypassing-the-filter-chain"></a>14.2.1&nbsp;Bypassing the Filter Chain</h3></div></div></div>
<p>You can use the attribute <code class="literal">filters = "none"</code> as an alternative to supplying a filter bean list. This will omit the request pattern from the security filter chain entirely. Note that anything matching this path will then have no authentication or authorization services applied and will be freely accessible. If you want to make use of the contents of the <code class="literal">SecurityContext</code> contents during a request, then it must have passed through the security filter chain. Otherwise the <code class="literal">SecurityContextHolder</code> will not have been populated and the contents will be null.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="filter-ordering" href="index.html#filter-ordering"></a>14.3&nbsp;Filter Ordering</h2></div></div></div>
<p>The order that filters are defined in the chain is very important. Irrespective of which filters you are actually using, the order should be as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">ChannelProcessingFilter</code>, because it might need to redirect to a different protocol
</li><li class="listitem">
<code class="literal">SecurityContextPersistenceFilter</code>, so a <code class="literal">SecurityContext</code> can be set up in the <code class="literal">SecurityContextHolder</code> at the beginning of a web request, and any changes to the <code class="literal">SecurityContext</code> can be copied to the <code class="literal">HttpSession</code> when the web request ends (ready for use with the next web request)
</li><li class="listitem">
<code class="literal">ConcurrentSessionFilter</code>, because it uses the <code class="literal">SecurityContextHolder</code> functionality and needs to update the <code class="literal">SessionRegistry</code> to reflect ongoing requests from the principal
</li><li class="listitem">
Authentication processing mechanisms - <code class="literal">UsernamePasswordAuthenticationFilter</code>, <code class="literal">CasAuthenticationFilter</code>, <code class="literal">BasicAuthenticationFilter</code> etc - so that the <code class="literal">SecurityContextHolder</code> can be modified to contain a valid <code class="literal">Authentication</code> request token
</li><li class="listitem">
The <code class="literal">SecurityContextHolderAwareRequestFilter</code>, if you are using it to install a Spring Security aware <code class="literal">HttpServletRequestWrapper</code> into your servlet container
</li><li class="listitem">
The <code class="literal">JaasApiIntegrationFilter</code>, if a <code class="literal">JaasAuthenticationToken</code> is in the <code class="literal">SecurityContextHolder</code> this will process the <code class="literal">FilterChain</code> as the <code class="literal">Subject</code> in the <code class="literal">JaasAuthenticationToken</code>
</li><li class="listitem">
<code class="literal">RememberMeAuthenticationFilter</code>, so that if no earlier authentication processing mechanism updated the <code class="literal">SecurityContextHolder</code>, and the request presents a cookie that enables remember-me services to take place, a suitable remembered <code class="literal">Authentication</code> object will be put there
</li><li class="listitem">
<code class="literal">AnonymousAuthenticationFilter</code>, so that if no earlier authentication processing mechanism updated the <code class="literal">SecurityContextHolder</code>, an anonymous <code class="literal">Authentication</code> object will be put there
</li><li class="listitem">
<code class="literal">ExceptionTranslationFilter</code>, to catch any Spring Security exceptions so that either an HTTP error response can be returned or an appropriate <code class="literal">AuthenticationEntryPoint</code> can be launched
</li><li class="listitem">
<code class="literal">FilterSecurityInterceptor</code>, to protect web URIs and raise exceptions when access is denied
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="request-matching" href="index.html#request-matching"></a>14.4&nbsp;Request Matching and HttpFirewall</h2></div></div></div>
<p>Spring Security has several areas where patterns you have defined are tested against incoming requests in order to decide how the request should be handled. This occurs when the <code class="literal">FilterChainProxy</code> decides which filter chain a request should be passed through and also when the <code class="literal">FilterSecurityInterceptor</code> decides which security constraints apply to a request. It&#8217;s important to understand what the mechanism is and what URL value is used when testing against the patterns that you define.</p>
<p>The Servlet Specification defines several properties for the <code class="literal">HttpServletRequest</code> which are accessible via getter methods, and which we might want to match against. These are the <code class="literal">contextPath</code>, <code class="literal">servletPath</code>, <code class="literal">pathInfo</code> and <code class="literal">queryString</code>. Spring Security is only interested in securing paths within the application, so the <code class="literal">contextPath</code> is ignored. Unfortunately, the servlet spec does not define exactly what the values of <code class="literal">servletPath</code> and <code class="literal">pathInfo</code> will contain for a particular request URI. For example, each path segment of a URL may contain parameters, as defined in <a class="ulink" href="https://www.ietf.org/rfc/rfc2396.txt" target="_top">RFC 2396</a> <a href="index.html#ftn.d5e3221" class="footnote" name="d5e3221"><sup class="footnote">[8]</sup></a>. The Specification does not clearly state whether these should be included in the <code class="literal">servletPath</code> and <code class="literal">pathInfo</code> values and the behaviour varies between different servlet containers. There is a danger that when an application is deployed in a container which does not strip path parameters from these values, an attacker could add them to the requested URL in order to cause a pattern match to succeed or fail unexpectedly. <a href="index.html#ftn.d5e3226" class="footnote" name="d5e3226"><sup class="footnote">[9]</sup></a>. Other variations in the incoming URL are also possible. For example, it could contain path-traversal sequences (like <code class="literal">/../</code>) or multiple forward slashes (<code class="literal">//</code>) which could also cause pattern-matches to fail. Some containers normalize these out before performing the servlet mapping, but others don&#8217;t. To protect against issues like these, <code class="literal">FilterChainProxy</code> uses an <code class="literal">HttpFirewall</code> strategy to check and wrap the request. Un-normalized requests are automatically rejected by default, and path parameters and duplicate slashes are removed for matching purposes. <a href="index.html#ftn.d5e3233" class="footnote" name="d5e3233"><sup class="footnote">[10]</sup></a>. It is therefore essential that a <code class="literal">FilterChainProxy</code> is used to manage the security filter chain. Note that the <code class="literal">servletPath</code> and <code class="literal">pathInfo</code> values are decoded by the container, so your application should not have any valid paths which contain semi-colons, as these parts will be removed for matching purposes.</p>
<p>As mentioned above, the default strategy is to use Ant-style paths for matching and this is likely to be the best choice for most users. The strategy is implemented in the class <code class="literal">AntPathRequestMatcher</code> which uses Spring&#8217;s <code class="literal">AntPathMatcher</code> to perform a case-insensitive match of the pattern against the concatenated <code class="literal">servletPath</code> and <code class="literal">pathInfo</code>, ignoring the <code class="literal">queryString</code>.</p>
<p>If for some reason, you need a more powerful matching strategy, you can use regular expressions. The strategy implementation is then <code class="literal">RegexRequestMatcher</code>. See the Javadoc for this class for more information.</p>
<p>In practice we recommend that you use method security at your service layer, to control access to your application, and do not rely entirely on the use of security constraints defined at the web-application level. URLs change and it is difficult to take account of all the possible URLs that an application might support and how requests might be manipulated. You should try and restrict yourself to using a few simple ant paths which are simple to understand. Always try to use a "deny-by-default" approach where you have a catch-all wildcard ( /<span class="strong"><strong> or </strong></span>) defined last and denying access.</p>
<p>Security defined at the service layer is much more robust and harder to bypass, so you should always take advantage of Spring Security&#8217;s method security options.</p>
<p>The <code class="literal">HttpFirewall</code> also prevents <a class="ulink" href="https://www.owasp.org/index.php/HTTP_Response_Splitting" target="_top">HTTP Response Splitting</a> by rejecting new line characters in the HTTP Response headers.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="use-with-other-filter-based-frameworks" href="index.html#use-with-other-filter-based-frameworks"></a>14.5&nbsp;Use with other Filter-Based Frameworks</h2></div></div></div>
<p>If you&#8217;re using some other framework that is also filter-based, then you need to make sure that the Spring Security filters come first. This enables the <code class="literal">SecurityContextHolder</code> to be populated in time for use by the other filters. Examples are the use of SiteMesh to decorate your web pages or a web framework like Wicket which uses a filter to handle its requests.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="filter-chains-with-ns" href="index.html#filter-chains-with-ns"></a>14.6&nbsp;Advanced Namespace Configuration</h2></div></div></div>
<p>As we saw earlier in the namespace chapter, it&#8217;s possible to use multiple <code class="literal">http</code> elements to define different security configurations for different URL patterns. Each element creates a filter chain within the internal <code class="literal">FilterChainProxy</code> and the URL pattern that should be mapped to it. The elements will be added in the order they are declared, so the most specific patterns must again be declared first. Here&#8217;s another example, for a similar situation to that above, where the application supports both a stateless RESTful API and also a normal web application which users log into using a form.</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- Stateless RESTful service using Basic authentication --&gt;</span>
<span class="hl-tag">&lt;http</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/restful/**"</span> <span class="hl-attribute">create-session</span>=<span class="hl-value">"stateless"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">'/**'</span> <span class="hl-attribute">access</span>=<span class="hl-value">"hasRole('REMOTE')"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;http-basic /&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span>

<span class="hl-comment">&lt;!-- Empty filter chain for the login page --&gt;</span>
<span class="hl-tag">&lt;http</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/login.htm*"</span> <span class="hl-attribute">security</span>=<span class="hl-value">"none"</span><span class="hl-tag">/&gt;</span>

<span class="hl-comment">&lt;!-- Additional filter chain for normal users, matching all other requests --&gt;</span>
<span class="hl-tag">&lt;http&gt;</span>
<span class="hl-tag">&lt;intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">'/**'</span> <span class="hl-attribute">access</span>=<span class="hl-value">"hasRole('USER')"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;form-login</span> <span class="hl-attribute">login-page</span>=<span class="hl-value">'/login.htm'</span> <span class="hl-attribute">default-target-url</span>=<span class="hl-value">"/home.htm"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;logout /&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
</div>
<div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.d5e3117" class="footnote"><p><a href="index.html#d5e3117" class="simpara"><sup class="simpara">[6] </sup></a>Note that you&#8217;ll need to include the security namespace in your application context XML file in order to use this syntax. The older syntax which used a <code class="literal">filter-chain-map</code> is still supported, but is deprecated in favour of the constructor argument injection.</p></div><div id="ftn.d5e3123" class="footnote"><p><a href="index.html#d5e3123" class="simpara"><sup class="simpara">[7] </sup></a>Instead of a path pattern, the <code class="literal">request-matcher-ref</code> attribute can be used to specify a <code class="literal">RequestMatcher</code> instance for more powerful matching</p></div><div id="ftn.d5e3221" class="footnote"><p><a href="index.html#d5e3221" class="simpara"><sup class="simpara">[8] </sup></a>You have probably seen this when a browser doesn&#8217;t support cookies and the <code class="literal">jsessionid</code> parameter is appended to the URL after a semi-colon. However the RFC allows the presence of these parameters in any path segment of the URL</p></div><div id="ftn.d5e3226" class="footnote"><p><a href="index.html#d5e3226" class="simpara"><sup class="simpara">[9] </sup></a>The original values will be returned once the request leaves the <code class="literal">FilterChainProxy</code>, so will still be available to the application.</p></div><div id="ftn.d5e3233" class="footnote"><p><a href="index.html#d5e3233" class="simpara"><sup class="simpara">[10] </sup></a>So, for example, an original request path <code class="literal">/secure;hack=1/somefile.html;hack=2</code> will be returned as <code class="literal">/secure/somefile.html</code>.</p></div></div></div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="core-web-filters" href="index.html#core-web-filters"></a>15.&nbsp;Core Security Filters</h2></div></div></div>
<p>There are some key filters which will always be used in a web application which uses Spring Security, so we&#8217;ll look at these and their supporting classes and interfaces first. We won&#8217;t cover every feature, so be sure to look at the Javadoc for them if you want to get the complete picture.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="filter-security-interceptor" href="index.html#filter-security-interceptor"></a>15.1&nbsp;FilterSecurityInterceptor</h2></div></div></div>
<p>We&#8217;ve already seen <code class="literal">FilterSecurityInterceptor</code> briefly when discussing <a class="link" href="index.html#tech-intro-access-control" title="9.5&nbsp;Access-Control (Authorization) in Spring Security">access-control in general</a>, and we&#8217;ve already used it with the namespace where the <code class="literal">&lt;intercept-url&gt;</code> elements are combined to configure it internally. Now we&#8217;ll see how to explicitly configure it for use with a <code class="literal">FilterChainProxy</code>, along with its companion filter <code class="literal">ExceptionTranslationFilter</code>. A typical configuration example is shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filterSecurityInterceptor"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.access.intercept.FilterSecurityInterceptor"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authenticationManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"authenticationManager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"accessDecisionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"accessDecisionManager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"securityMetadataSource"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;security:filter-security-metadata-source&gt;</span>
	<span class="hl-tag">&lt;security:intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/secure/super/**"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_WE_DONT_HAVE"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;security:intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/secure/**"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_SUPERVISOR,ROLE_TELLER"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/security:filter-security-metadata-source&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p><code class="literal">FilterSecurityInterceptor</code> is responsible for handling the security of HTTP resources. It requires a reference to an <code class="literal">AuthenticationManager</code> and an <code class="literal">AccessDecisionManager</code>. It is also supplied with configuration attributes that apply to different HTTP URL requests. Refer back to <a class="link" href="index.html#tech-intro-config-attributes" title="What are Configuration Attributes?">the original discussion on these</a> in the technical introduction.</p>
<p>The <code class="literal">FilterSecurityInterceptor</code> can be configured with configuration attributes in two ways. The first, which is shown above, is using the <code class="literal">&lt;filter-security-metadata-source&gt;</code> namespace element. This is similar to the <code class="literal">&lt;http&gt;</code> element from the namespace chapter but the <code class="literal">&lt;intercept-url&gt;</code> child elements only use the <code class="literal">pattern</code> and <code class="literal">access</code> attributes. Commas are used to delimit the different configuration attributes that apply to each HTTP URL. The second option is to write your own <code class="literal">SecurityMetadataSource</code>, but this is beyond the scope of this document. Irrespective of the approach used, the <code class="literal">SecurityMetadataSource</code> is responsible for returning a <code class="literal">List&lt;ConfigAttribute&gt;</code> containing all of the configuration attributes associated with a single secure HTTP URL.</p>
<p>It should be noted that the <code class="literal">FilterSecurityInterceptor.setSecurityMetadataSource()</code> method actually expects an instance of <code class="literal">FilterInvocationSecurityMetadataSource</code>. This is a marker interface which subclasses <code class="literal">SecurityMetadataSource</code>. It simply denotes the <code class="literal">SecurityMetadataSource</code> understands <code class="literal">FilterInvocation</code> s. In the interests of simplicity we&#8217;ll continue to refer to the <code class="literal">FilterInvocationSecurityMetadataSource</code> as a <code class="literal">SecurityMetadataSource</code>, as the distinction is of little relevance to most users.</p>
<p>The <code class="literal">SecurityMetadataSource</code> created by the namespace syntax obtains the configuration attributes for a particular <code class="literal">FilterInvocation</code> by matching the request URL against the configured <code class="literal">pattern</code> attributes. This behaves in the same way as it does for namespace configuration. The default is to treat all expressions as Apache Ant paths and regular expressions are also supported for more complex cases. The <code class="literal">request-matcher</code> attribute is used to specify the type of pattern being used. It is not possible to mix expression syntaxes within the same definition. As an example, the previous configuration using regular expressions instead of Ant paths would be written as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filterInvocationInterceptor"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.access.intercept.FilterSecurityInterceptor"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authenticationManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"authenticationManager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"accessDecisionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"accessDecisionManager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"runAsManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"runAsManager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"securityMetadataSource"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;security:filter-security-metadata-source</span> <span class="hl-attribute">request-matcher</span>=<span class="hl-value">"regex"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;security:intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"\A/secure/super/.*\Z"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_WE_DONT_HAVE"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;security:intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"\A/secure/.*\"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_SUPERVISOR,ROLE_TELLER"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/security:filter-security-metadata-source&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>Patterns are always evaluated in the order they are defined. Thus it is important that more specific patterns are defined higher in the list than less specific patterns. This is reflected in our example above, where the more specific <code class="literal">/secure/super/</code> pattern appears higher than the less specific <code class="literal">/secure/</code> pattern. If they were reversed, the <code class="literal">/secure/</code> pattern would always match and the <code class="literal">/secure/super/</code> pattern would never be evaluated.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="exception-translation-filter" href="index.html#exception-translation-filter"></a>15.2&nbsp;ExceptionTranslationFilter</h2></div></div></div>
<p>The <code class="literal">ExceptionTranslationFilter</code> sits above the <code class="literal">FilterSecurityInterceptor</code> in the security filter stack. It doesn&#8217;t do any actual security enforcement itself, but handles exceptions thrown by the security interceptors and provides suitable and HTTP responses.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exceptionTranslationFilter"</span>
<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.access.ExceptionTranslationFilter"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authenticationEntryPoint"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"authenticationEntryPoint"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"accessDeniedHandler"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"accessDeniedHandler"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"authenticationEntryPoint"</span>
<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"loginFormUrl"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/login.jsp"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accessDeniedHandler"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.access.AccessDeniedHandlerImpl"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"errorPage"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/accessDenied.htm"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="auth-entry-point" href="index.html#auth-entry-point"></a>15.2.1&nbsp;AuthenticationEntryPoint</h3></div></div></div>
<p>The <code class="literal">AuthenticationEntryPoint</code> will be called if the user requests a secure HTTP resource but they are not authenticated. An appropriate <code class="literal">AuthenticationException</code> or <code class="literal">AccessDeniedException</code> will be thrown by a security interceptor further down the call stack, triggering the <code class="literal">commence</code> method on the entry point. This does the job of presenting the appropriate response to the user so that authentication can begin. The one we&#8217;ve used here is <code class="literal">LoginUrlAuthenticationEntryPoint</code>, which redirects the request to a different URL (typically a login page). The actual implementation used will depend on the authentication mechanism you want to be used in your application.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="access-denied-handler" href="index.html#access-denied-handler"></a>15.2.2&nbsp;AccessDeniedHandler</h3></div></div></div>
<p>What happens if a user is already authenticated and they try to access a protected resource? In normal usage, this shouldn&#8217;t happen because the application workflow should be restricted to operations to which a user has access. For example, an HTML link to an administration page might be hidden from users who do not have an admin role. You can&#8217;t rely on hiding links for security though, as there&#8217;s always a possibility that a user will just enter the URL directly in an attempt to bypass the restrictions. Or they might modify a RESTful URL to change some of the argument values. Your application must be protected against these scenarios or it will definitely be insecure. You will typically use simple web layer security to apply constraints to basic URLs and use more specific method-based security on your service layer interfaces to really nail down what is permissible.</p>
<p>If an <code class="literal">AccessDeniedException</code> is thrown and a user has already been authenticated, then this means that an operation has been attempted for which they don&#8217;t have enough permissions. In this case, <code class="literal">ExceptionTranslationFilter</code> will invoke a second strategy, the <code class="literal">AccessDeniedHandler</code>. By default, an <code class="literal">AccessDeniedHandlerImpl</code> is used, which just sends a 403 (Forbidden) response to the client. Alternatively you can configure an instance explicitly (as in the above example) and set an error page URL which it will forwards the request to <a href="index.html#ftn.d5e3332" class="footnote" name="d5e3332"><sup class="footnote">[11]</sup></a>. This can be a simple "access denied" page, such as a JSP, or it could be a more complex handler such as an MVC controller. And of course, you can implement the interface yourself and use your own implementation.</p>
<p>It&#8217;s also possible to supply a custom <code class="literal">AccessDeniedHandler</code> when you&#8217;re using the namespace to configure your application. See <a class="link" href="index.html#nsa-access-denied-handler" title="43.1.3&nbsp;<access-denied-handler&gt;">the namespace appendix</a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="request-caching" href="index.html#request-caching"></a>15.2.3&nbsp;SavedRequest s and the RequestCache Interface</h3></div></div></div>
<p>Another responsibility of <code class="literal">ExceptionTranslationFilter</code> responsibilities is to save the current request before invoking the <code class="literal">AuthenticationEntryPoint</code>. This allows the request to be restored after the user has authenticated (see previous overview of <a class="link" href="index.html#tech-intro-web-authentication" title="9.4&nbsp;Authentication in a Web Application">web authentication</a>). A typical example would be where the user logs in with a form, and is then redirected to the original URL by the default <code class="literal">SavedRequestAwareAuthenticationSuccessHandler</code> (see <a class="link" href="index.html#form-login-flow-handling" title="15.4.1&nbsp;Application Flow on Authentication Success and Failure">below</a>).</p>
<p>The <code class="literal">RequestCache</code> encapsulates the functionality required for storing and retrieving <code class="literal">HttpServletRequest</code> instances. By default the <code class="literal">HttpSessionRequestCache</code> is used, which stores the request in the <code class="literal">HttpSession</code>. The <code class="literal">RequestCacheFilter</code> has the job of actually restoring the saved request from the cache when the user is redirected to the original URL.</p>
<p>Under normal circumstances, you shouldn&#8217;t need to modify any of this functionality, but the saved-request handling is a "best-effort" approach and there may be situations which the default configuration isn&#8217;t able to handle. The use of these interfaces makes it fully pluggable from Spring Security 3.0 onwards.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="security-context-persistence-filter" href="index.html#security-context-persistence-filter"></a>15.3&nbsp;SecurityContextPersistenceFilter</h2></div></div></div>
<p>We covered the purpose of this all-important filter in the <a class="link" href="index.html#tech-intro-sec-context-persistence" title="9.4.4&nbsp;Storing the SecurityContext between requests">Technical Overview</a> chapter so you might want to re-read that section at this point. Let&#8217;s first take a look at how you would configure it for use with a <code class="literal">FilterChainProxy</code>. A basic configuration only requires the bean itself</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"securityContextPersistenceFilter"</span>
<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.context.SecurityContextPersistenceFilter"</span><span class="hl-tag">/&gt;</span></pre>
<p>As we saw previously, this filter has two main tasks. It is responsible for storage of the <code class="literal">SecurityContext</code> contents between HTTP requests and for clearing the <code class="literal">SecurityContextHolder</code> when a request is completed. Clearing the <code class="literal">ThreadLocal</code> in which the context is stored is essential, as it might otherwise be possible for a thread to be replaced into the servlet container&#8217;s thread pool, with the security context for a particular user still attached. This thread might then be used at a later stage, performing operations with the wrong credentials.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="security-context-repository" href="index.html#security-context-repository"></a>15.3.1&nbsp;SecurityContextRepository</h3></div></div></div>
<p>From Spring Security 3.0, the job of loading and storing the security context is now delegated to a separate strategy interface:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> SecurityContextRepository {

SecurityContext loadContext(HttpRequestResponseHolder requestResponseHolder);

<span class="hl-keyword">void</span> saveContext(SecurityContext context, HttpServletRequest request,
		HttpServletResponse response);
}</pre>
<p>The <code class="literal">HttpRequestResponseHolder</code> is simply a container for the incoming request and response objects, allowing the implementation to replace these with wrapper classes. The returned contents will be passed to the filter chain.</p>
<p>The default implementation is <code class="literal">HttpSessionSecurityContextRepository</code>, which stores the security context as an <code class="literal">HttpSession</code> attribute <a href="index.html#ftn.d5e3371" class="footnote" name="d5e3371"><sup class="footnote">[12]</sup></a>. The most important configuration parameter for this implementation is the <code class="literal">allowSessionCreation</code> property, which defaults to <code class="literal">true</code>, thus allowing the class to create a session if it needs one to store the security context for an authenticated user (it won&#8217;t create one unless authentication has taken place and the contents of the security context have changed). If you don&#8217;t want a session to be created, then you can set this property to <code class="literal">false</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"securityContextPersistenceFilter"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.context.SecurityContextPersistenceFilter"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">'securityContextRepository'</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">'org.springframework.security.web.context.HttpSessionSecurityContextRepository'</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">'allowSessionCreation'</span> <span class="hl-attribute">value</span>=<span class="hl-value">'false'</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>Alternatively you could provide an instance of <code class="literal">NullSecurityContextRepository</code>, a <a class="ulink" href="https://en.wikipedia.org/wiki/Null_Object_pattern" target="_top">null object</a> implementation, which will prevent the security context from being stored, even if a session has already been created during the request.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="form-login-filter" href="index.html#form-login-filter"></a>15.4&nbsp;UsernamePasswordAuthenticationFilter</h2></div></div></div>
<p>We&#8217;ve now seen the three main filters which are always present in a Spring Security web configuration. These are also the three which are automatically created by the namespace <code class="literal">&lt;http&gt;</code> element and cannot be substituted with alternatives. The only thing that&#8217;s missing now is an actual authentication mechanism, something that will allow a user to authenticate. This filter is the most commonly used authentication filter and the one that is most often customized <a href="index.html#ftn.d5e3386" class="footnote" name="d5e3386"><sup class="footnote">[13]</sup></a>. It also provides the implementation used by the <code class="literal">&lt;form-login&gt;</code> element from the namespace. There are three stages required to configure it.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Configure a <code class="literal">LoginUrlAuthenticationEntryPoint</code> with the URL of the login page, just as we did above, and set it on the <code class="literal">ExceptionTranslationFilter</code>.
</li><li class="listitem">
Implement the login page (using a JSP or MVC controller).
</li><li class="listitem">
Configure an instance of <code class="literal">UsernamePasswordAuthenticationFilter</code> in the application context
</li><li class="listitem">
Add the filter bean to your filter chain proxy (making sure you pay attention to the order).
</li></ul></div>
<p>The login form simply contains <code class="literal">username</code> and <code class="literal">password</code> input fields, and posts to the URL that is monitored by the filter (by default this is <code class="literal">/login</code>). The basic filter configuration looks something like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"authenticationFilter"</span> <span class="hl-attribute">class</span>=
<span class="hl-value">"org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authenticationManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"authenticationManager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="form-login-flow-handling" href="index.html#form-login-flow-handling"></a>15.4.1&nbsp;Application Flow on Authentication Success and Failure</h3></div></div></div>
<p>The filter calls the configured <code class="literal">AuthenticationManager</code> to process each authentication request. The destination following a successful authentication or an authentication failure is controlled by the <code class="literal">AuthenticationSuccessHandler</code> and <code class="literal">AuthenticationFailureHandler</code> strategy interfaces, respectively. The filter has properties which allow you to set these so you can customize the behaviour completely <a href="index.html#ftn.d5e3414" class="footnote" name="d5e3414"><sup class="footnote">[14]</sup></a>. Some standard implementations are supplied such as <code class="literal">SimpleUrlAuthenticationSuccessHandler</code>, <code class="literal">SavedRequestAwareAuthenticationSuccessHandler</code>, <code class="literal">SimpleUrlAuthenticationFailureHandler</code>, <code class="literal">ExceptionMappingAuthenticationFailureHandler</code> and <code class="literal">DelegatingAuthenticationFailureHandler</code>. Have a look at the Javadoc for these classes and also for <code class="literal">AbstractAuthenticationProcessingFilter</code> to get an overview of how they work and the supported features.</p>
<p>If authentication is successful, the resulting <code class="literal">Authentication</code> object will be placed into the <code class="literal">SecurityContextHolder</code>. The configured <code class="literal">AuthenticationSuccessHandler</code> will then be called to either redirect or forward the user to the appropriate destination. By default a <code class="literal">SavedRequestAwareAuthenticationSuccessHandler</code> is used, which means that the user will be redirected to the original destination they requested before they were asked to login.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">ExceptionTranslationFilter</code> caches the original request a user makes. When the user authenticates, the request handler makes use of this cached request to obtain the original URL and redirect to it. The original request is then rebuilt and used as an alternative.</p>
</td></tr></table></div>
<p>If authentication fails, the configured <code class="literal">AuthenticationFailureHandler</code> will be invoked.</p>
</div>
</div>
<div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.d5e3332" class="footnote"><p><a href="index.html#d5e3332" class="simpara"><sup class="simpara">[11] </sup></a>We use a forward so that the SecurityContextHolder still contains details of the principal, which may be useful for displaying to the user. In old releases of Spring Security we relied upon the servlet container to handle a 403 error message, which lacked this useful contextual information.</p></div><div id="ftn.d5e3371" class="footnote"><p><a href="index.html#d5e3371" class="simpara"><sup class="simpara">[12] </sup></a>In Spring Security 2.0 and earlier, this filter was called <code class="literal">HttpSessionContextIntegrationFilter</code> and performed all the work of storing the context was performed by the filter itself. If you were familiar with this class, then most of the configuration options which were available can now be found on <code class="literal">HttpSessionSecurityContextRepository</code>.</p></div><div id="ftn.d5e3386" class="footnote"><p><a href="index.html#d5e3386" class="simpara"><sup class="simpara">[13] </sup></a>For historical reasons, prior to Spring Security 3.0, this filter was called <code class="literal">AuthenticationProcessingFilter</code> and the entry point was called <code class="literal">AuthenticationProcessingFilterEntryPoint</code>. Since the framework now supports many different forms of authentication, they have both been given more specific names in 3.0.</p></div><div id="ftn.d5e3414" class="footnote"><p><a href="index.html#d5e3414" class="simpara"><sup class="simpara">[14] </sup></a>In versions prior to 3.0, the application flow at this point had evolved to a stage was controlled by a mix of properties on this class and strategy plugins. The decision was made for 3.0 to refactor the code to make these two strategies entirely responsible.</p></div></div></div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="servletapi" href="index.html#servletapi"></a>16.&nbsp;Servlet API integration</h2></div></div></div>
<p>This section describes how Spring Security is integrated with the Servlet API. The <a class="ulink" href="https://github.com/spring-projects/spring-security/tree/master/samples/xml/servletapi" target="_top">servletapi-xml</a> sample application demonstrates the usage of each of these methods.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="servletapi-25" href="index.html#servletapi-25"></a>16.1&nbsp;Servlet 2.5+ Integration</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="servletapi-remote-user" href="index.html#servletapi-remote-user"></a>16.1.1&nbsp;HttpServletRequest.getRemoteUser()</h3></div></div></div>
<p>The <a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#getRemoteUser()" target="_top">HttpServletRequest.getRemoteUser()</a> will return the result of <code class="literal">SecurityContextHolder.getContext().getAuthentication().getName()</code> which is typically the current username. This can be useful if you want to display the current username in your application. Additionally, checking if this is null can be used to indicate if a user has authenticated or is anonymous. Knowing if the user is authenticated or not can be useful for determining if certain UI elements should be shown or not (i.e. a log out link should only be displayed if the user is authenticated).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="servletapi-user-principal" href="index.html#servletapi-user-principal"></a>16.1.2&nbsp;HttpServletRequest.getUserPrincipal()</h3></div></div></div>
<p>The <a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#getUserPrincipal()" target="_top">HttpServletRequest.getUserPrincipal()</a> will return the result of <code class="literal">SecurityContextHolder.getContext().getAuthentication()</code>. This means it is an <code class="literal">Authentication</code> which is typically an instance of <code class="literal">UsernamePasswordAuthenticationToken</code> when using username and password based authentication. This can be useful if you need additional information about your user. For example, you might have created a custom <code class="literal">UserDetailsService</code> that returns a custom <code class="literal">UserDetails</code> containing a first and last name for your user. You could obtain this information with the following:</p>
<pre class="programlisting">Authentication auth = httpServletRequest.getUserPrincipal();
<span class="hl-comment">// assume integrated custom UserDetails called MyCustomUserDetails</span>
<span class="hl-comment">// by default, typically instance of UserDetails</span>
MyCustomUserDetails userDetails = (MyCustomUserDetails) auth.getPrincipal();
String firstName = userDetails.getFirstName();
String lastName = userDetails.getLastName();</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It should be noted that it is typically bad practice to perform so much logic throughout your application. Instead, one should centralize it to reduce any coupling of Spring Security and the Servlet API&#8217;s.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="servletapi-user-in-role" href="index.html#servletapi-user-in-role"></a>16.1.3&nbsp;HttpServletRequest.isUserInRole(String)</h3></div></div></div>
<p>The <a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#isUserInRole(java.lang.String)" target="_top">HttpServletRequest.isUserInRole(String)</a> will determine if <code class="literal">SecurityContextHolder.getContext().getAuthentication().getAuthorities()</code> contains a <code class="literal">GrantedAuthority</code> with the role passed into <code class="literal">isUserInRole(String)</code>. Typically users should not pass in the "ROLE_" prefix into this method since it is added automatically. For example, if you want to determine if the current user has the authority "ROLE_ADMIN", you could use the following:</p>
<pre class="programlisting"><span class="hl-keyword">boolean</span> isAdmin = httpServletRequest.isUserInRole(<span class="hl-string">"ADMIN"</span>);</pre>
<p>This might be useful to determine if certain UI components should be displayed. For example, you might display admin links only if the current user is an admin.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="servletapi-3" href="index.html#servletapi-3"></a>16.2&nbsp;Servlet 3+ Integration</h2></div></div></div>
<p>The following section describes the Servlet 3 methods that Spring Security integrates with.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="servletapi-authenticate" href="index.html#servletapi-authenticate"></a>16.2.1&nbsp;HttpServletRequest.authenticate(HttpServletRequest,HttpServletResponse)</h3></div></div></div>
<p>The <a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#authenticate%28javax.servlet.http.HttpServletResponse%29" target="_top">HttpServletRequest.authenticate(HttpServletRequest,HttpServletResponse)</a> method can be used to ensure that a user is authenticated. If they are not authenticated, the configured AuthenticationEntryPoint will be used to request the user to authenticate (i.e. redirect to the login page).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="servletapi-login" href="index.html#servletapi-login"></a>16.2.2&nbsp;HttpServletRequest.login(String,String)</h3></div></div></div>
<p>The <a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#login%28java.lang.String,%20java.lang.String%29" target="_top">HttpServletRequest.login(String,String)</a> method can be used to authenticate the user with the current <code class="literal">AuthenticationManager</code>. For example, the following would attempt to authenticate with the username "user" and password "password":</p>
<pre class="programlisting"><span class="hl-keyword">try</span> {
httpServletRequest.login(<span class="hl-string">"user"</span>,<span class="hl-string">"password"</span>);
} <span class="hl-keyword">catch</span>(ServletException e) {
<span class="hl-comment">// fail to authenticate</span>
}</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It is not necessary to catch the ServletException if you want Spring Security to process the failed authentication attempt.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="servletapi-logout" href="index.html#servletapi-logout"></a>16.2.3&nbsp;HttpServletRequest.logout()</h3></div></div></div>
<p>The <a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html#logout%28%29" target="_top">HttpServletRequest.logout()</a> method can be used to log the current user out.</p>
<p>Typically this means that the SecurityContextHolder will be cleared out, the HttpSession will be invalidated, any "Remember Me" authentication will be cleaned up, etc. However, the configured LogoutHandler implementations will vary depending on your Spring Security configuration. It is important to note that after HttpServletRequest.logout() has been invoked, you are still in charge of writing a response out. Typically this would involve a redirect to the welcome page.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="servletapi-start-runnable" href="index.html#servletapi-start-runnable"></a>16.2.4&nbsp;AsyncContext.start(Runnable)</h3></div></div></div>
<p>The <a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/servlet/AsyncContext.html#start%28java.lang.Runnable%29" target="_top">AsynchContext.start(Runnable)</a> method that ensures your credentials will be propagated to the new Thread. Using Spring Security&#8217;s concurrency support, Spring Security overrides the AsyncContext.start(Runnable) to ensure that the current SecurityContext is used when processing the Runnable. For example, the following would output the current user&#8217;s Authentication:</p>
<pre class="programlisting"><span class="hl-keyword">final</span> AsyncContext async = httpServletRequest.startAsync();
async.start(<span class="hl-keyword">new</span> Runnable() {
	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> run() {
		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
		<span class="hl-keyword">try</span> {
			<span class="hl-keyword">final</span> HttpServletResponse asyncResponse = (HttpServletResponse) async.getResponse();
			asyncResponse.setStatus(HttpServletResponse.SC_OK);
			asyncResponse.getWriter().write(String.valueOf(authentication));
			async.complete();
		} <span class="hl-keyword">catch</span>(Exception e) {
			<span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> RuntimeException(e);
		}
	}
});</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="servletapi-async" href="index.html#servletapi-async"></a>16.2.5&nbsp;Async Servlet Support</h3></div></div></div>
<p>If you are using Java Based configuration, you are ready to go. If you are using XML configuration, there are a few updates that are necessary. The first step is to ensure you have updated your web.xml to use at least the 3.0 schema as shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;web-app</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://java.sun.com/xml/ns/javaee"</span>
<span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
<span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"</span>
<span class="hl-attribute">version</span>=<span class="hl-value">"3.0"</span><span class="hl-tag">&gt;</span>

<span class="hl-tag">&lt;/web-app&gt;</span></pre>
<p>Next you need to ensure that your springSecurityFilterChain is setup for processing asynchronous requests.</p>
<pre class="programlisting"><span class="hl-tag">&lt;filter&gt;</span>
<span class="hl-tag">&lt;filter-name&gt;</span>springSecurityFilterChain<span class="hl-tag">&lt;/filter-name&gt;</span>
<span class="hl-tag">&lt;filter-class&gt;</span>
	org.springframework.web.filter.DelegatingFilterProxy
<span class="hl-tag">&lt;/filter-class&gt;</span>
<span class="hl-tag">&lt;async-supported&gt;</span>true<span class="hl-tag">&lt;/async-supported&gt;</span>
<span class="hl-tag">&lt;/filter&gt;</span>
<span class="hl-tag">&lt;filter-mapping&gt;</span>
<span class="hl-tag">&lt;filter-name&gt;</span>springSecurityFilterChain<span class="hl-tag">&lt;/filter-name&gt;</span>
<span class="hl-tag">&lt;url-pattern&gt;</span>/*<span class="hl-tag">&lt;/url-pattern&gt;</span>
<span class="hl-tag">&lt;dispatcher&gt;</span>REQUEST<span class="hl-tag">&lt;/dispatcher&gt;</span>
<span class="hl-tag">&lt;dispatcher&gt;</span>ASYNC<span class="hl-tag">&lt;/dispatcher&gt;</span>
<span class="hl-tag">&lt;/filter-mapping&gt;</span></pre>
<p>That&#8217;s it! Now Spring Security will ensure that your SecurityContext is propagated on asynchronous requests too.</p>
<p>So how does it work? If you are not really interested, feel free to skip the remainder of this section, otherwise read on. Most of this is built into the Servlet specification, but there is a little bit of tweaking that Spring Security does to ensure things work with asynchronous requests properly. Prior to Spring Security 3.2, the SecurityContext from the SecurityContextHolder was automatically saved as soon as the HttpServletResponse was committed. This can cause issues in an Async environment. For example, consider the following:</p>
<pre class="programlisting">httpServletRequest.startAsync();
<span class="hl-keyword">new</span> Thread(<span class="hl-string">"AsyncThread"</span>) {
	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> run() {
		<span class="hl-keyword">try</span> {
			<span class="hl-comment">// Do work</span>
			TimeUnit.SECONDS.sleep(<span class="hl-number">1</span>);

			<span class="hl-comment">// Write to and commit the httpServletResponse</span>
			httpServletResponse.getOutputStream().flush();
		} <span class="hl-keyword">catch</span> (Exception e) {
			e.printStackTrace();
		}
	}
}.start();</pre>
<p>The issue is that this Thread is not known to Spring Security, so the SecurityContext is not propagated to it. This means when we commit the HttpServletResponse there is no SecuriytContext. When Spring Security automatically saved the SecurityContext on committing the HttpServletResponse it would lose our logged in user.</p>
<p>Since version 3.2, Spring Security is smart enough to no longer automatically save the SecurityContext on commiting the HttpServletResponse as soon as HttpServletRequest.startAsync() is invoked.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="servletapi-31" href="index.html#servletapi-31"></a>16.3&nbsp;Servlet 3.1+ Integration</h2></div></div></div>
<p>The following section describes the Servlet 3.1 methods that Spring Security integrates with.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="servletapi-change-session-id" href="index.html#servletapi-change-session-id"></a>16.3.1&nbsp;HttpServletRequest#changeSessionId()</h3></div></div></div>
<p>The <a class="ulink" href="http://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpServletRequest.html#changeSessionId()" target="_top">HttpServletRequest.changeSessionId()</a> is the default method for protecting against <a class="link" href="index.html#ns-session-fixation" title="Session Fixation Attack Protection">Session Fixation</a> attacks in Servlet 3.1 and higher.</p>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="basic" href="index.html#basic"></a>17.&nbsp;Basic and Digest Authentication</h2></div></div></div>
<p>Basic and digest authentication are alternative authentication mechanisms which are popular in web applications. Basic authentication is often used with stateless clients which pass their credentials on each request. It&#8217;s quite common to use it in combination with form-based authentication where an application is used through both a browser-based user interface and as a web-service. However, basic authentication transmits the password as plain text so it should only really be used over an encrypted transport layer such as HTTPS.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="basic-processing-filter" href="index.html#basic-processing-filter"></a>17.1&nbsp;BasicAuthenticationFilter</h2></div></div></div>
<p><code class="literal">BasicAuthenticationFilter</code> is responsible for processing basic authentication credentials presented in HTTP headers. This can be used for authenticating calls made by Spring remoting protocols (such as Hessian and Burlap), as well as normal browser user agents (such as Firefox and Internet Explorer). The standard governing HTTP Basic Authentication is defined by RFC 1945, Section 11, and <code class="literal">BasicAuthenticationFilter</code> conforms with this RFC. Basic Authentication is an attractive approach to authentication, because it is very widely deployed in user agents and implementation is extremely simple (it&#8217;s just a Base64 encoding of the username:password, specified in an HTTP header).</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="basic-config" href="index.html#basic-config"></a>17.1.1&nbsp;Configuration</h3></div></div></div>
<p>To implement HTTP Basic Authentication, you need to add a <code class="literal">BasicAuthenticationFilter</code> to your filter chain. The application context should contain <code class="literal">BasicAuthenticationFilter</code> and its required collaborator:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"basicAuthenticationFilter"</span>
<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.authentication.www.BasicAuthenticationFilter"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authenticationManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"authenticationManager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authenticationEntryPoint"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"authenticationEntryPoint"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"authenticationEntryPoint"</span>
<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.authentication.www.BasicAuthenticationEntryPoint"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"realmName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Name Of Your Realm"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>The configured <code class="literal">AuthenticationManager</code> processes each authentication request. If authentication fails, the configured <code class="literal">AuthenticationEntryPoint</code> will be used to retry the authentication process. Usually you will use the filter in combination with a <code class="literal">BasicAuthenticationEntryPoint</code>, which returns a 401 response with a suitable header to retry HTTP Basic authentication. If authentication is successful, the resulting <code class="literal">Authentication</code> object will be placed into the <code class="literal">SecurityContextHolder</code> as usual.</p>
<p>If the authentication event was successful, or authentication was not attempted because the HTTP header did not contain a supported authentication request, the filter chain will continue as normal. The only time the filter chain will be interrupted is if authentication fails and the <code class="literal">AuthenticationEntryPoint</code> is called.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="digest-processing-filter" href="index.html#digest-processing-filter"></a>17.2&nbsp;DigestAuthenticationFilter</h2></div></div></div>
<p><code class="literal">DigestAuthenticationFilter</code> is capable of processing digest authentication credentials presented in HTTP headers. Digest Authentication attempts to solve many of the weaknesses of Basic authentication, specifically by ensuring credentials are never sent in clear text across the wire. Many user agents support Digest Authentication, including Mozilla Firefox and Internet Explorer. The standard governing HTTP Digest Authentication is defined by RFC 2617, which updates an earlier version of the Digest Authentication standard prescribed by RFC 2069. Most user agents implement RFC 2617. Spring Security&#8217;s <code class="literal">DigestAuthenticationFilter</code> is compatible with the &#8220;auth&#8221; quality of protection (<code class="literal">qop</code>) prescribed by RFC 2617, which also provides backward compatibility with RFC 2069. Digest Authentication is a more attractive option if you need to use unencrypted HTTP (i.e. no TLS/HTTPS) and wish to maximise security of the authentication process. Indeed Digest Authentication is a mandatory requirement for the WebDAV protocol, as noted by RFC 2518 Section 17.1.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You should not use Digest in modern applications because it is not considered secure.
The most obvious problem is that you must store your passwords in plaintext, encrypted, or an MD5 format.
All of these storage formats are considered insecure.
Instead, you should use a one way adaptive password hash (i.e. bCrypt, PBKDF2, SCrypt, etc).</p>
</td></tr></table></div>
<p>Central to Digest Authentication is a "nonce". This is a value the server generates. Spring Security&#8217;s nonce adopts the following format:</p>
<pre class="programlisting">base64(expirationTime + ":" + md5Hex(expirationTime + ":" + key))
expirationTime:   The date and time when the nonce expires, expressed in milliseconds
key:              A private key to prevent modification of the nonce token</pre>
<p>The <code class="literal">DigestAuthenticatonEntryPoint</code> has a property specifying the <code class="literal">key</code> used for generating the nonce tokens, along with a <code class="literal">nonceValiditySeconds</code> property for determining the expiration time (default 300, which equals five minutes). Whist ever the nonce is valid, the digest is computed by concatenating various strings including the username, password, nonce, URI being requested, a client-generated nonce (merely a random value which the user agent generates each request), the realm name etc, then performing an MD5 hash. Both the server and user agent perform this digest computation, resulting in different hash codes if they disagree on an included value (eg password). In Spring Security implementation, if the server-generated nonce has merely expired (but the digest was otherwise valid), the <code class="literal">DigestAuthenticationEntryPoint</code> will send a <code class="literal">"stale=true"</code> header. This tells the user agent there is no need to disturb the user (as the password and username etc is correct), but simply to try again using a new nonce.</p>
<p>An appropriate value for the <code class="literal">nonceValiditySeconds</code> parameter of <code class="literal">DigestAuthenticationEntryPoint</code> depends on your application. Extremely secure applications should note that an intercepted authentication header can be used to impersonate the principal until the <code class="literal">expirationTime</code> contained in the nonce is reached. This is the key principle when selecting an appropriate setting, but it would be unusual for immensely secure applications to not be running over TLS/HTTPS in the first instance.</p>
<p>Because of the more complex implementation of Digest Authentication, there are often user agent issues. For example, Internet Explorer fails to present an &#8220;opaque&#8221; token on subsequent requests in the same session. Spring Security filters therefore encapsulate all state information into the &#8220;nonce&#8221; token instead. In our testing, Spring Security&#8217;s implementation works reliably with Mozilla Firefox and Internet Explorer, correctly handling nonce timeouts etc.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="digest-config" href="index.html#digest-config"></a>17.2.1&nbsp;Configuration</h3></div></div></div>
<p>Now that we&#8217;ve reviewed the theory, let&#8217;s see how to use it. To implement HTTP Digest Authentication, it is necessary to define <code class="literal">DigestAuthenticationFilter</code> in the filter chain. The application context will need to define the <code class="literal">DigestAuthenticationFilter</code> and its required collaborators:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"digestFilter"</span> <span class="hl-attribute">class</span>=
	<span class="hl-value">"org.springframework.security.web.authentication.www.DigestAuthenticationFilter"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"userDetailsService"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"jdbcDaoImpl"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authenticationEntryPoint"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"digestEntryPoint"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"userCache"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"userCache"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"digestEntryPoint"</span> <span class="hl-attribute">class</span>=
	<span class="hl-value">"org.springframework.security.web.authentication.www.DigestAuthenticationEntryPoint"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"realmName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Contacts Realm via Digest Authentication"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"key"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"acegi"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"nonceValiditySeconds"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>The configured <code class="literal">UserDetailsService</code> is needed because <code class="literal">DigestAuthenticationFilter</code> must have direct access to the clear text password of a user. Digest Authentication will NOT work if you are using encoded passwords in your DAO <a href="index.html#ftn.d5e3560" class="footnote" name="d5e3560"><sup class="footnote">[15]</sup></a>. The DAO collaborator, along with the <code class="literal">UserCache</code>, are typically shared directly with a <code class="literal">DaoAuthenticationProvider</code>. The <code class="literal">authenticationEntryPoint</code> property must be <code class="literal">DigestAuthenticationEntryPoint</code>, so that <code class="literal">DigestAuthenticationFilter</code> can obtain the correct <code class="literal">realmName</code> and <code class="literal">key</code> for digest calculations.</p>
<p>Like <code class="literal">BasicAuthenticationFilter</code>, if authentication is successful an <code class="literal">Authentication</code> request token will be placed into the <code class="literal">SecurityContextHolder</code>. If the authentication event was successful, or authentication was not attempted because the HTTP header did not contain a Digest Authentication request, the filter chain will continue as normal. The only time the filter chain will be interrupted is if authentication fails and the <code class="literal">AuthenticationEntryPoint</code> is called, as discussed in the previous paragraph.</p>
<p>Digest Authentication&#8217;s RFC offers a range of additional features to further increase security. For example, the nonce can be changed on every request. Despite this, Spring Security implementation was designed to minimise the complexity of the implementation (and the doubtless user agent incompatibilities that would emerge), and avoid needing to store server-side state. You are invited to review RFC 2617 if you wish to explore these features in more detail. As far as we are aware, Spring Security&#8217;s implementation does comply with the minimum standards of this RFC.</p>
</div>
</div>
<div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.d5e3560" class="footnote"><p><a href="index.html#d5e3560" class="simpara"><sup class="simpara">[15] </sup></a>It is possible to encode the password in the format HEX( MD5(username:realm:password) ) provided the <code class="literal">DigestAuthenticationFilter.passwordAlreadyEncoded</code> is set to <code class="literal">true</code>. However, other password encodings will not work with digest authentication.</p></div></div></div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="remember-me" href="index.html#remember-me"></a>18.&nbsp;Remember-Me Authentication</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="remember-me-overview" href="index.html#remember-me-overview"></a>18.1&nbsp;Overview</h2></div></div></div>
<p>Remember-me or persistent-login authentication refers to web sites being able to remember the identity of a principal between sessions. This is typically accomplished by sending a cookie to the browser, with the cookie being detected during future sessions and causing automated login to take place. Spring Security provides the necessary hooks for these operations to take place, and has two concrete remember-me implementations. One uses hashing to preserve the security of cookie-based tokens and the other uses a database or other persistent storage mechanism to store the generated tokens.</p>
<p>Note that both implementations require a <code class="literal">UserDetailsService</code>. If you are using an authentication provider which doesn&#8217;t use a <code class="literal">UserDetailsService</code> (for example, the LDAP provider) then it won&#8217;t work unless you also have a <code class="literal">UserDetailsService</code> bean in your application context.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="remember-me-hash-token" href="index.html#remember-me-hash-token"></a>18.2&nbsp;Simple Hash-Based Token Approach</h2></div></div></div>
<p>This approach uses hashing to achieve a useful remember-me strategy. In essence a cookie is sent to the browser upon successful interactive authentication, with the cookie being composed as follows:</p>
<pre class="programlisting">base64(username + ":" + expirationTime + ":" +
md5Hex(username + ":" + expirationTime + ":" password + ":" + key))

username:          As identifiable to the UserDetailsService
password:          That matches the one in the retrieved UserDetails
expirationTime:    The date and time when the remember-me token expires, expressed in milliseconds
key:               A private key to prevent modification of the remember-me token</pre>
<p>As such the remember-me token is valid only for the period specified, and provided that the username, password and key does not change. Notably, this has a potential security issue in that a captured remember-me token will be usable from any user agent until such time as the token expires. This is the same issue as with digest authentication. If a principal is aware a token has been captured, they can easily change their password and immediately invalidate all remember-me tokens on issue. If more significant security is needed you should use the approach described in the next section. Alternatively remember-me services should simply not be used at all.</p>
<p>If you are familiar with the topics discussed in the chapter on <a class="link" href="index.html#ns-config" title="6.&nbsp;Security Namespace Configuration">namespace configuration</a>, you can enable remember-me authentication just by adding the <code class="literal">&lt;remember-me&gt;</code> element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
...
<span class="hl-tag">&lt;remember-me</span> <span class="hl-attribute">key</span>=<span class="hl-value">"myAppKey"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>The <code class="literal">UserDetailsService</code> will normally be selected automatically. If you have more than one in your application context, you need to specify which one should be used with the <code class="literal">user-service-ref</code> attribute, where the value is the name of your <code class="literal">UserDetailsService</code> bean.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="remember-me-persistent-token" href="index.html#remember-me-persistent-token"></a>18.3&nbsp;Persistent Token Approach</h2></div></div></div>
<p>This approach is based on the article <a class="ulink" href="http://jaspan.com/improved_persistent_login_cookie_best_practice" target="_top">http://jaspan.com/improved_persistent_login_cookie_best_practice</a> with some minor modifications <a href="index.html#ftn.d5e3603" class="footnote" name="d5e3603"><sup class="footnote">[16]</sup></a>. To use the this approach with namespace configuration, you would supply a datasource reference:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
...
<span class="hl-tag">&lt;remember-me</span> <span class="hl-attribute">data-source-ref</span>=<span class="hl-value">"someDataSource"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>The database should contain a <code class="literal">persistent_logins</code> table, created using the following SQL (or equivalent):</p>
<pre class="programlisting">create table persistent_logins (username varchar(64) not null,
								series varchar(64) primary key,
								token varchar(64) not null,
								last_used timestamp not null)</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="remember-me-impls" href="index.html#remember-me-impls"></a>18.4&nbsp;Remember-Me Interfaces and Implementations</h2></div></div></div>
<p>Remember-me is used with <code class="literal">UsernamePasswordAuthenticationFilter</code>, and is implemented via hooks in the <code class="literal">AbstractAuthenticationProcessingFilter</code> superclass.
It is also used within <code class="literal">BasicAuthenticationFilter</code>.
The hooks will invoke a concrete <code class="literal">RememberMeServices</code> at the appropriate times.
The interface looks like this:</p>
<pre class="programlisting">Authentication autoLogin(HttpServletRequest request, HttpServletResponse response);

<span class="hl-keyword">void</span> loginFail(HttpServletRequest request, HttpServletResponse response);

<span class="hl-keyword">void</span> loginSuccess(HttpServletRequest request, HttpServletResponse response,
	Authentication successfulAuthentication);</pre>
<p>Please refer to the Javadoc for a fuller discussion on what the methods do, although note at this stage that <code class="literal">AbstractAuthenticationProcessingFilter</code> only calls the <code class="literal">loginFail()</code> and <code class="literal">loginSuccess()</code> methods. The <code class="literal">autoLogin()</code> method is called by <code class="literal">RememberMeAuthenticationFilter</code> whenever the <code class="literal">SecurityContextHolder</code> does not contain an <code class="literal">Authentication</code>. This interface therefore provides the underlying remember-me implementation with sufficient notification of authentication-related events, and delegates to the implementation whenever a candidate web request might contain a cookie and wish to be remembered. This design allows any number of remember-me implementation strategies. We&#8217;ve seen above that Spring Security provides two implementations. We&#8217;ll look at these in turn.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tokenbasedremembermeservices" href="index.html#tokenbasedremembermeservices"></a>18.4.1&nbsp;TokenBasedRememberMeServices</h3></div></div></div>
<p>This implementation supports the simpler approach described in <a class="xref" href="index.html#remember-me-hash-token" title="18.2&nbsp;Simple Hash-Based Token Approach">Section&nbsp;18.2, &#8220;Simple Hash-Based Token Approach&#8221;</a>. <code class="literal">TokenBasedRememberMeServices</code> generates a <code class="literal">RememberMeAuthenticationToken</code>, which is processed by <code class="literal">RememberMeAuthenticationProvider</code>. A <code class="literal">key</code> is shared between this authentication provider and the <code class="literal">TokenBasedRememberMeServices</code>. In addition, <code class="literal">TokenBasedRememberMeServices</code> requires A UserDetailsService from which it can retrieve the username and password for signature comparison purposes, and generate the <code class="literal">RememberMeAuthenticationToken</code> to contain the correct <code class="literal">GrantedAuthority</code> s. Some sort of logout command should be provided by the application that invalidates the cookie if the user requests this. <code class="literal">TokenBasedRememberMeServices</code> also implements Spring Security&#8217;s <code class="literal">LogoutHandler</code> interface so can be used with <code class="literal">LogoutFilter</code> to have the cookie cleared automatically.</p>
<p>The beans required in an application context to enable remember-me services are as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"rememberMeFilter"</span> <span class="hl-attribute">class</span>=
<span class="hl-value">"org.springframework.security.web.authentication.rememberme.RememberMeAuthenticationFilter"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"rememberMeServices"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"rememberMeServices"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authenticationManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"theAuthenticationManager"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"rememberMeServices"</span> <span class="hl-attribute">class</span>=
<span class="hl-value">"org.springframework.security.web.authentication.rememberme.TokenBasedRememberMeServices"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"userDetailsService"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myUserDetailsService"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"key"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"springRocks"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"rememberMeAuthenticationProvider"</span> <span class="hl-attribute">class</span>=
<span class="hl-value">"org.springframework.security.authentication.RememberMeAuthenticationProvider"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"key"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"springRocks"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>Don&#8217;t forget to add your <code class="literal">RememberMeServices</code> implementation to your <code class="literal">UsernamePasswordAuthenticationFilter.setRememberMeServices()</code> property, include the <code class="literal">RememberMeAuthenticationProvider</code> in your <code class="literal">AuthenticationManager.setProviders()</code> list, and add <code class="literal">RememberMeAuthenticationFilter</code> into your <code class="literal">FilterChainProxy</code> (typically immediately after your <code class="literal">UsernamePasswordAuthenticationFilter</code>).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="persistenttokenbasedremembermeservices" href="index.html#persistenttokenbasedremembermeservices"></a>18.4.2&nbsp;PersistentTokenBasedRememberMeServices</h3></div></div></div>
<p>This class can be used in the same way as <code class="literal">TokenBasedRememberMeServices</code>, but it additionally needs to be configured with a <code class="literal">PersistentTokenRepository</code> to store the tokens. There are two standard implementations.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">InMemoryTokenRepositoryImpl</code> which is intended for testing only.
</li><li class="listitem">
<code class="literal">JdbcTokenRepositoryImpl</code> which stores the tokens in a database.
</li></ul></div>
<p>The database schema is described above in <a class="xref" href="index.html#remember-me-persistent-token" title="18.3&nbsp;Persistent Token Approach">Section&nbsp;18.3, &#8220;Persistent Token Approach&#8221;</a>.</p>
</div>
</div>
<div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.d5e3603" class="footnote"><p><a href="index.html#d5e3603" class="simpara"><sup class="simpara">[16] </sup></a>Essentially, the username is not included in the cookie, to prevent exposing a valid login name unecessarily. There is a discussion on this in the comments section of this article.</p></div></div></div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="csrf" href="index.html#csrf"></a>19.&nbsp;Cross Site Request Forgery (CSRF)</h2></div></div></div>
<p>This section discusses Spring Security&#8217;s <a class="ulink" href="https://en.wikipedia.org/wiki/Cross-site_request_forgery" target="_top"> Cross Site Request Forgery (CSRF)</a> support.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="csrf-attacks" href="index.html#csrf-attacks"></a>19.1&nbsp;CSRF Attacks</h2></div></div></div>
<p>Before we discuss how Spring Security can protect applications from CSRF attacks, we will explain what a CSRF attack is. Let&#8217;s take a look at a concrete example to get a better understanding.</p>
<p>Assume that your bank&#8217;s website provides a form that allows transferring money from the currently logged in user to another bank account. For example, the HTTP request might look like:</p>
<pre class="screen">POST /transfer HTTP/1.1
Host: bank.example.com
Cookie: JSESSIONID=randomid; Domain=bank.example.com; Secure; HttpOnly
Content-Type: application/x-www-form-urlencoded

amount=100.00&amp;routingNumber=1234&amp;account=9876</pre>
<p>Now pretend you authenticate to your bank&#8217;s website and then, without logging out, visit an evil website. The evil website contains an HTML page with the following form:</p>
<pre class="programlisting"><span class="hl-tag">&lt;form</span> <span class="hl-attribute">action</span>=<span class="hl-value">"https://bank.example.com/transfer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"post"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span>
	<span class="hl-attribute">name</span>=<span class="hl-value">"amount"</span>
	<span class="hl-attribute">value</span>=<span class="hl-value">"100.00"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span>
	<span class="hl-attribute">name</span>=<span class="hl-value">"routingNumber"</span>
	<span class="hl-attribute">value</span>=<span class="hl-value">"evilsRoutingNumber"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span>
	<span class="hl-attribute">name</span>=<span class="hl-value">"account"</span>
	<span class="hl-attribute">value</span>=<span class="hl-value">"evilsAccountNumber"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span>
	<span class="hl-attribute">value</span>=<span class="hl-value">"Win Money!"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/form&gt;</span></pre>
<p>You like to win money, so you click on the submit button. In the process, you have unintentionally transferred $100 to a malicious user. This happens because, while the evil website cannot see your cookies, the cookies associated with your bank are still sent along with the request.</p>
<p>Worst yet, this whole process could have been automated using JavaScript. This means you didn&#8217;t even need to click on the button. So how do we protect ourselves from such attacks?</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="synchronizer-token-pattern" href="index.html#synchronizer-token-pattern"></a>19.2&nbsp;Synchronizer Token Pattern</h2></div></div></div>
<p>The issue is that the HTTP request from the bank&#8217;s website and the request from the evil website are exactly the same. This means there is no way to reject requests coming from the evil website and allow requests coming from the bank&#8217;s website. To protect against CSRF attacks we need to ensure there is something in the request that the evil site is unable to provide.</p>
<p>One solution is to use the <a class="ulink" href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet#General_Recommendation:_Synchronizer_Token_Pattern" target="_top">Synchronizer Token Pattern</a>. This solution is to ensure that each request requires, in addition to our session cookie, a randomly generated token as an HTTP parameter. When a request is submitted, the server must look up the expected value for the parameter and compare it against the actual value in the request. If the values do not match, the request should fail.</p>
<p>We can relax the expectations to only require the token for each HTTP request that updates state. This can be safely done since the same origin policy ensures the evil site cannot read the response. Additionally, we do not want to include the random token in HTTP GET as this can cause the tokens to be leaked.</p>
<p>Let&#8217;s take a look at how our example would change. Assume the randomly generated token is present in an HTTP parameter named _csrf. For example, the request to transfer money would look like this:</p>
<pre class="screen">POST /transfer HTTP/1.1
Host: bank.example.com
Cookie: JSESSIONID=randomid; Domain=bank.example.com; Secure; HttpOnly
Content-Type: application/x-www-form-urlencoded

amount=100.00&amp;routingNumber=1234&amp;account=9876&amp;_csrf=&lt;secure-random&gt;</pre>
<p>You will notice that we added the _csrf parameter with a random value. Now the evil website will not be able to guess the correct value for the _csrf parameter (which must be explicitly provided on the evil website) and the transfer will fail when the server compares the actual token to the expected token.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="when-to-use-csrf-protection" href="index.html#when-to-use-csrf-protection"></a>19.3&nbsp;When to use CSRF protection</h2></div></div></div>
<p>When should you use CSRF protection? Our recommendation is to use CSRF protection for any request that could be processed by a browser by normal users. If you are only creating a service that is used by non-browser clients, you will likely want to disable CSRF protection.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="csrf-protection-and-json" href="index.html#csrf-protection-and-json"></a>19.3.1&nbsp;CSRF protection and JSON</h3></div></div></div>
<p>A common question is "do I need to protect JSON requests made by javascript?" The short answer is, it depends. However, you must be very careful as there are CSRF exploits that can impact JSON requests. For example, a malicious user can create a <a class="ulink" href="http://blog.opensecurityresearch.com/2012/02/json-csrf-with-parameter-padding.html" target="_top">CSRF with JSON using the following form</a>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;form</span> <span class="hl-attribute">action</span>=<span class="hl-value">"https://bank.example.com/transfer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"post"</span> <span class="hl-attribute">enctype</span>=<span class="hl-value">"text/plain"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;input</span> <span class="hl-attribute">name</span>=<span class="hl-value">'{"amount":100,"routingNumber":"evilsRoutingNumber","account":"evilsAccountNumber", "ignore_me":"'</span> <span class="hl-attribute">value</span>=<span class="hl-value">'test"}'</span> <span class="hl-attribute">type</span>=<span class="hl-value">'hidden'</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span>
	<span class="hl-attribute">value</span>=<span class="hl-value">"Win Money!"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/form&gt;</span></pre>
<p>This will produce the following JSON structure</p>
<pre class="programlisting">{ <span class="hl-string">"amount"</span>: <span class="hl-number">100</span>,
<span class="hl-string">"routingNumber"</span>: <span class="hl-string">"evilsRoutingNumber"</span>,
<span class="hl-string">"account"</span>: <span class="hl-string">"evilsAccountNumber"</span>,
<span class="hl-string">"ignore_me"</span>: <span class="hl-string">"=test"</span>
}</pre>
<p>If an application were not validating the Content-Type, then it would be exposed to this exploit. Depending on the setup, a Spring MVC application that validates the Content-Type could still be exploited by updating the URL suffix to end with ".json" as shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;form</span> <span class="hl-attribute">action</span>=<span class="hl-value">"https://bank.example.com/transfer.json"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"post"</span> <span class="hl-attribute">enctype</span>=<span class="hl-value">"text/plain"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;input</span> <span class="hl-attribute">name</span>=<span class="hl-value">'{"amount":100,"routingNumber":"evilsRoutingNumber","account":"evilsAccountNumber", "ignore_me":"'</span> <span class="hl-attribute">value</span>=<span class="hl-value">'test"}'</span> <span class="hl-attribute">type</span>=<span class="hl-value">'hidden'</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span>
	<span class="hl-attribute">value</span>=<span class="hl-value">"Win Money!"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/form&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="csrf-and-stateless-browser-applications" href="index.html#csrf-and-stateless-browser-applications"></a>19.3.2&nbsp;CSRF and Stateless Browser Applications</h3></div></div></div>
<p>What if my application is stateless? That doesn&#8217;t necessarily mean you are protected. In fact, if a user does not need to perform any actions in the web browser for a given request, they are likely still vulnerable to CSRF attacks.</p>
<p>For example, consider an application uses a custom cookie that contains all the state within it for authentication instead of the JSESSIONID. When the CSRF attack is made the custom cookie will be sent with the request in the same manner that the JSESSIONID cookie was sent in our previous example.</p>
<p>Users using basic authentication are also vulnerable to CSRF attacks since the browser will automatically include the username password in any requests in the same manner that the JSESSIONID cookie was sent in our previous example.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="csrf-using" href="index.html#csrf-using"></a>19.4&nbsp;Using Spring Security CSRF Protection</h2></div></div></div>
<p>So what are the steps necessary to use Spring Security&#8217;s to protect our site against CSRF attacks? The steps to using Spring Security&#8217;s CSRF protection are outlined below:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#csrf-use-proper-verbs" title="19.4.1&nbsp;Use proper HTTP verbs">Use proper HTTP verbs</a>
</li><li class="listitem">
<a class="link" href="index.html#csrf-configure" title="19.4.2&nbsp;Configure CSRF Protection">Configure CSRF Protection</a>
</li><li class="listitem">
<a class="link" href="index.html#csrf-include-csrf-token" title="19.4.3&nbsp;Include the CSRF Token">Include the CSRF Token</a>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="csrf-use-proper-verbs" href="index.html#csrf-use-proper-verbs"></a>19.4.1&nbsp;Use proper HTTP verbs</h3></div></div></div>
<p>The first step to protecting against CSRF attacks is to ensure your website uses proper HTTP verbs. Specifically, before Spring Security&#8217;s CSRF support can be of use, you need to be certain that your application is using PATCH, POST, PUT, and/or DELETE for anything that modifies state.</p>
<p>This is not a limitation of Spring Security&#8217;s support, but instead a general requirement for proper CSRF prevention. The reason is that including private information in an HTTP GET can cause the information to be leaked. See <a class="ulink" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec15.html#sec15.1.3" target="_top">RFC 2616 Section 15.1.3 Encoding Sensitive Information in URI&#8217;s</a> for general guidance on using POST instead of GET for sensitive information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="csrf-configure" href="index.html#csrf-configure"></a>19.4.2&nbsp;Configure CSRF Protection</h3></div></div></div>
<p>The next step is to include Spring Security&#8217;s CSRF protection within your application. Some frameworks handle invalid CSRF tokens by invaliding the user&#8217;s session, but this causes <a class="link" href="index.html#csrf-logout" title="19.5.3&nbsp;Logging Out">its own problems</a>. Instead by default Spring Security&#8217;s CSRF protection will produce an HTTP 403 access denied. This can be customized by configuring the <a class="link" href="index.html#access-denied-handler" title="15.2.2&nbsp;AccessDeniedHandler">AccessDeniedHandler</a> to process <code class="literal">InvalidCsrfTokenException</code> differently.</p>
<p>As of Spring Security 4.0, CSRF protection is enabled by default with XML configuration. If you would like to disable CSRF protection, the corresponding XML configuration can be seen below.</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-comment">&lt;!-- ... --&gt;</span>
	<span class="hl-tag">&lt;csrf</span> <span class="hl-attribute">disabled</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>CSRF protection is enabled by default with Java Configuration. If you would like to disable CSRF, the corresponding Java configuration can be seen below. Refer to the Javadoc of csrf() for additional customizations in how CSRF protection is configured.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span>
WebSecurityConfigurerAdapter {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			.csrf().disable();
	}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="csrf-include-csrf-token" href="index.html#csrf-include-csrf-token"></a>19.4.3&nbsp;Include the CSRF Token</h3></div></div></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="csrf-include-csrf-token-form" href="index.html#csrf-include-csrf-token-form"></a>Form Submissions</h4></div></div></div>
<p>The last step is to ensure that you include the CSRF token in all PATCH, POST, PUT, and DELETE methods. One way to approach this is to use the <code class="literal">_csrf</code> request attribute to obtain the current <code class="literal">CsrfToken</code>. An example of doing this with a JSP is shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;c:url</span> <span class="hl-attribute">var</span>=<span class="hl-value">"logoutUrl"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/logout"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;form</span> <span class="hl-attribute">action</span>=<span class="hl-value">"${logoutUrl}"</span>
	<span class="hl-attribute">method</span>=<span class="hl-value">"post"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span>
	<span class="hl-attribute">value</span>=<span class="hl-value">"Log out"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span>
	<span class="hl-attribute">name</span>=<span class="hl-value">"${_csrf.parameterName}"</span>
	<span class="hl-attribute">value</span>=<span class="hl-value">"${_csrf.token}"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/form&gt;</span></pre>
<p>An easier approach is to use <a class="link" href="index.html#the-csrfinput-tag" title="32.5&nbsp;The csrfInput Tag">the csrfInput tag</a> from the Spring Security JSP tag library.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you are using Spring MVC <code class="literal">&lt;form:form&gt;</code> tag or <a class="ulink" href="http://www.thymeleaf.org/whatsnew21.html#reqdata" target="_top">Thymeleaf 2.1+</a> and are using <code class="literal">@EnableWebSecurity</code>, the <code class="literal">CsrfToken</code> is automatically included for you (using the <code class="literal">CsrfRequestDataValueProcessor</code>).</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="csrf-include-csrf-token-ajax" href="index.html#csrf-include-csrf-token-ajax"></a>Ajax and JSON Requests</h4></div></div></div>
<p>If you are using JSON, then it is not possible to submit the CSRF token within an HTTP parameter. Instead you can submit the token within a HTTP header. A typical pattern would be to include the CSRF token within your meta tags. An example with a JSP is shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;html&gt;</span>
<span class="hl-tag">&lt;head&gt;</span>
	<span class="hl-tag">&lt;meta</span> <span class="hl-attribute">name</span>=<span class="hl-value">"_csrf"</span> <span class="hl-attribute">content</span>=<span class="hl-value">"${_csrf.token}"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-comment">&lt;!-- default header name is X-CSRF-TOKEN --&gt;</span>
	<span class="hl-tag">&lt;meta</span> <span class="hl-attribute">name</span>=<span class="hl-value">"_csrf_header"</span> <span class="hl-attribute">content</span>=<span class="hl-value">"${_csrf.headerName}"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-comment">&lt;!-- ... --&gt;</span>
<span class="hl-tag">&lt;/head&gt;</span>
<span class="hl-comment">&lt;!-- ... --&gt;</span></pre>
<p>Instead of manually creating the meta tags, you can use the simpler <a class="link" href="index.html#the-csrfmetatags-tag" title="32.6&nbsp;The csrfMetaTags Tag">csrfMetaTags tag</a> from the Spring Security JSP tag library.</p>
<p>You can then include the token within all your Ajax requests. If you were using jQuery, this could be done with the following:</p>
<pre class="programlisting">$(<span class="hl-keyword">function</span> () {
<span class="hl-keyword">var</span> token = $(<span class="hl-string">"meta[name='_csrf']"</span>).attr(<span class="hl-string">"content"</span>);
<span class="hl-keyword">var</span> header = $(<span class="hl-string">"meta[name='_csrf_header']"</span>).attr(<span class="hl-string">"content"</span>);
$(document).ajaxSend(<span class="hl-keyword">function</span>(e, xhr, options) {
	xhr.setRequestHeader(header, token);
});
});</pre>
<p>As an alternative to jQuery, we recommend using <a class="ulink" href="http://cujojs.com/" target="_top">cujoJS&#8217;s</a> rest.js. The <a class="ulink" href="https://github.com/cujojs/rest" target="_top">rest.js</a> module provides advanced support for working with HTTP requests and responses in RESTful ways. A core capability is the ability to contextualize the HTTP client adding behavior as needed by chaining interceptors on to the client.</p>
<pre class="programlisting"><span class="hl-keyword">var</span> client = rest.chain(csrf, {
token: $(<span class="hl-string">"meta[name='_csrf']"</span>).attr(<span class="hl-string">"content"</span>),
name: $(<span class="hl-string">"meta[name='_csrf_header']"</span>).attr(<span class="hl-string">"content"</span>)
});</pre>
<p>The configured client can be shared with any component of the application that needs to make a request to the CSRF protected resource. One significant different between rest.js and jQuery is that only requests made with the configured client will contain the CSRF token, vs jQuery where <span class="emphasis"><em>all</em></span> requests will include the token. The ability to scope which requests receive the token helps guard against leaking the CSRF token to a third party. Please refer to the <a class="ulink" href="https://github.com/cujojs/rest/tree/master/docs" target="_top">rest.js reference documentation</a> for more information on rest.js.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="csrf-cookie" href="index.html#csrf-cookie"></a>CookieCsrfTokenRepository</h4></div></div></div>
<p>There can be cases where users will want to persist the <code class="literal">CsrfToken</code> in a cookie.
By default the <code class="literal">CookieCsrfTokenRepository</code> will write to a cookie named <code class="literal">XSRF-TOKEN</code> and read it from a header named <code class="literal">X-XSRF-TOKEN</code> or the HTTP parameter <code class="literal">_csrf</code>.
These defaults come from <a class="ulink" href="https://docs.angularjs.org/api/ng/service/$http#cross-site-request-forgery-xsrf-protection" target="_top">AngularJS</a></p>
<p>You can configure <code class="literal">CookieCsrfTokenRepository</code> in XML using the following:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-comment">&lt;!-- ... --&gt;</span>
	<span class="hl-tag">&lt;csrf</span> <span class="hl-attribute">token-repository-ref</span>=<span class="hl-value">"tokenRepository"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span>
<span class="hl-tag">&lt;b:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"tokenRepository"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.csrf.CookieCsrfTokenRepository"</span>
	<span class="hl-attribute">p:cookieHttpOnly</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The sample explicitly sets <code class="literal">cookieHttpOnly=false</code>.
This is necessary to allow JavaScript (i.e. AngularJS) to read it.
If you do not need the ability to read the cookie with JavaScript directly, it is recommended to omit <code class="literal">cookieHttpOnly=false</code> to improve security.</p>
</td></tr></table></div>
<p>You can configure <code class="literal">CookieCsrfTokenRepository</code> in Java Configuration using:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span>
		WebSecurityConfigurerAdapter {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			.csrf()
				.csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse());
	}
}</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The sample explicitly sets <code class="literal">cookieHttpOnly=false</code>.
This is necessary to allow JavaScript (i.e. AngularJS) to read it.
If you do not need the ability to read the cookie with JavaScript directly, it is recommended to omit <code class="literal">cookieHttpOnly=false</code> (by using <code class="literal">new CookieCsrfTokenRepository()</code> instead) to improve security.</p>
</td></tr></table></div>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="csrf-caveats" href="index.html#csrf-caveats"></a>19.5&nbsp;CSRF Caveats</h2></div></div></div>
<p>There are a few caveats when implementing CSRF.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="csrf-timeouts" href="index.html#csrf-timeouts"></a>19.5.1&nbsp;Timeouts</h3></div></div></div>
<p>One issue is that the expected CSRF token is stored in the HttpSession, so as soon as the HttpSession expires your configured <code class="literal">AccessDeniedHandler</code> will receive a InvalidCsrfTokenException. If you are using the default <code class="literal">AccessDeniedHandler</code>, the browser will get an HTTP 403 and display a poor error message.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>One might ask why the expected <code class="literal">CsrfToken</code> isn&#8217;t stored in a cookie by default. This is because there are known exploits in which headers (i.e. specify the cookies) can be set by another domain. This is the same reason Ruby on Rails <a class="ulink" href="http://weblog.rubyonrails.org/2011/2/8/csrf-protection-bypass-in-ruby-on-rails/" target="_top">no longer skips CSRF checks when the header X-Requested-With is present</a>. See <a class="ulink" href="http://lists.webappsec.org/pipermail/websecurity_lists.webappsec.org/2011-February/007533.html" target="_top">this webappsec.org thread</a> for details on how to perform the exploit. Another disadvantage is that by removing the state (i.e. the timeout) you lose the ability to forcibly terminate the token if it is compromised.</p>
</td></tr></table></div>
<p>A simple way to mitigate an active user experiencing a timeout is to have some JavaScript that lets the user know their session is about to expire. The user can click a button to continue and refresh the session.</p>
<p>Alternatively, specifying a custom <code class="literal">AccessDeniedHandler</code> allows you to process the <code class="literal">InvalidCsrfTokenException</code> any way you like. For an example of how to customize the <code class="literal">AccessDeniedHandler</code> refer to the provided links for both <a class="link" href="index.html#nsa-access-denied-handler" title="43.1.3&nbsp;<access-denied-handler&gt;">xml</a> and <a class="ulink" href="https://github.com/spring-projects/spring-security/blob/3.2.0.RC1/config/src/test/groovy/org/springframework/security/config/annotation/web/configurers/NamespaceHttpAccessDeniedHandlerTests.groovy#L64" target="_top">Java configuration</a>.</p>
<p>Finally, the application can be configured to use <a class="link" href="index.html#csrf-cookie" title="CookieCsrfTokenRepository">CookieCsrfTokenRepository</a> which will not expire.
As previously mentioned, this is not as secure as using a session, but in many cases can be good enough.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="csrf-login" href="index.html#csrf-login"></a>19.5.2&nbsp;Logging In</h3></div></div></div>
<p>In order to protect against <a class="ulink" href="https://en.wikipedia.org/wiki/Cross-site_request_forgery#Forging_login_requests" target="_top">forging log in requests</a> the log in form should be protected against CSRF attacks too. Since the <code class="literal">CsrfToken</code> is stored in HttpSession, this means an HttpSession will be created as soon as <code class="literal">CsrfToken</code> token attribute is accessed. While this sounds bad in a RESTful / stateless architecture the reality is that state is necessary to implement practical security. Without state, we have nothing we can do if a token is compromised. Practically speaking, the CSRF token is quite small in size and should have a negligible impact on our architecture.</p>
<p>A common technique to protect the log in form is by using a JavaScript function to obtain a valid CSRF token before the form submission. By doing this, there is no need to think about session timeouts (discussed in the previous section) because the session is created right before the form submission (assuming that <a class="link" href="index.html#csrf-cookie" title="CookieCsrfTokenRepository">CookieCsrfTokenRepository</a> isn&#8217;t configured instead), so the user can stay on the login page and submit the username/password when he wants. In order to achieve this, you can take advantage of the <code class="literal">CsrfTokenArgumentResolver</code> provided by Spring Security and expose an endpoint like it&#8217;s described on <a class="link" href="index.html#mvc-csrf-resolver" title="39.5.2&nbsp;Resolving the CsrfToken">here</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="csrf-logout" href="index.html#csrf-logout"></a>19.5.3&nbsp;Logging Out</h3></div></div></div>
<p>Adding CSRF will update the LogoutFilter to only use HTTP POST. This ensures that log out requires a CSRF token and that a malicious user cannot forcibly log out your users.</p>
<p>One approach is to use a form for log out. If you really want a link, you can use JavaScript to have the link perform a POST (i.e. maybe on a hidden form). For browsers with JavaScript that is disabled, you can optionally have the link take the user to a log out confirmation page that will perform the POST.</p>
<p>If you really want to use HTTP GET with logout you can do so, but remember this is generally not recommended. For example, the following Java Configuration will perform logout with the URL /logout is requested with any HTTP method:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span>
WebSecurityConfigurerAdapter {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			.logout()
				.logoutRequestMatcher(<span class="hl-keyword">new</span> AntPathRequestMatcher(<span class="hl-string">"/logout"</span>));
	}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="csrf-multipart" href="index.html#csrf-multipart"></a>19.5.4&nbsp;Multipart (file upload)</h3></div></div></div>
<p>There are two options to using CSRF protection with multipart/form-data. Each option has its tradeoffs.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#csrf-multipartfilter" title="Placing MultipartFilter before Spring Security">Placing MultipartFilter before Spring Security</a>
</li><li class="listitem">
<a class="link" href="index.html#csrf-include-csrf-token-in-action" title="Include CSRF token in action">Include CSRF token in action</a>
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Before you integrate Spring Security&#8217;s CSRF protection with multipart file upload, ensure that you can upload without the CSRF protection first. More information about using multipart forms with Spring can be found within the <a class="ulink" href="https://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/mvc.html#mvc-multipart" target="_top">17.10 Spring&#8217;s multipart (file upload) support</a> section of the Spring reference and the <a class="ulink" href="https://docs.spring.io/spring/docs/3.2.x/javadoc-api/org/springframework/web/multipart/support/MultipartFilter.html" target="_top">MultipartFilter javadoc</a>.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="csrf-multipartfilter" href="index.html#csrf-multipartfilter"></a>Placing MultipartFilter before Spring Security</h4></div></div></div>
<p>The first option is to ensure that the <code class="literal">MultipartFilter</code> is specified before the Spring Security filter. Specifying the <code class="literal">MultipartFilter</code> before the Spring Security filter means that there is no authorization for invoking the <code class="literal">MultipartFilter</code> which means anyone can place temporary files on your server. However, only authorized users will be able to submit a File that is processed by your application. In general, this is the recommended approach because the temporary file upload should have a negligble impact on most servers.</p>
<p>To ensure <code class="literal">MultipartFilter</code> is specified before the Spring Security filter with java configuration, users can override beforeSpringSecurityFilterChain as shown below:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SecurityApplicationInitializer <span class="hl-keyword">extends</span> AbstractSecurityWebApplicationInitializer {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> beforeSpringSecurityFilterChain(ServletContext servletContext) {
		insertFilters(servletContext, <span class="hl-keyword">new</span> MultipartFilter());
	}
}</pre>
<p>To ensure <code class="literal">MultipartFilter</code> is specified before the Spring Security filter with XML configuration, users can ensure the &lt;filter-mapping&gt; element of the <code class="literal">MultipartFilter</code> is placed before the springSecurityFilterChain within the web.xml as shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;filter&gt;</span>
	<span class="hl-tag">&lt;filter-name&gt;</span>MultipartFilter<span class="hl-tag">&lt;/filter-name&gt;</span>
	<span class="hl-tag">&lt;filter-class&gt;</span>org.springframework.web.multipart.support.MultipartFilter<span class="hl-tag">&lt;/filter-class&gt;</span>
<span class="hl-tag">&lt;/filter&gt;</span>
<span class="hl-tag">&lt;filter&gt;</span>
	<span class="hl-tag">&lt;filter-name&gt;</span>springSecurityFilterChain<span class="hl-tag">&lt;/filter-name&gt;</span>
	<span class="hl-tag">&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="hl-tag">&lt;/filter-class&gt;</span>
<span class="hl-tag">&lt;/filter&gt;</span>
<span class="hl-tag">&lt;filter-mapping&gt;</span>
	<span class="hl-tag">&lt;filter-name&gt;</span>MultipartFilter<span class="hl-tag">&lt;/filter-name&gt;</span>
	<span class="hl-tag">&lt;url-pattern&gt;</span>/*<span class="hl-tag">&lt;/url-pattern&gt;</span>
<span class="hl-tag">&lt;/filter-mapping&gt;</span>
<span class="hl-tag">&lt;filter-mapping&gt;</span>
	<span class="hl-tag">&lt;filter-name&gt;</span>springSecurityFilterChain<span class="hl-tag">&lt;/filter-name&gt;</span>
	<span class="hl-tag">&lt;url-pattern&gt;</span>/*<span class="hl-tag">&lt;/url-pattern&gt;</span>
<span class="hl-tag">&lt;/filter-mapping&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="csrf-include-csrf-token-in-action" href="index.html#csrf-include-csrf-token-in-action"></a>Include CSRF token in action</h4></div></div></div>
<p>If allowing unauthorized users to upload temporariy files is not acceptable, an alternative is to place the <code class="literal">MultipartFilter</code> after the Spring Security filter and include the CSRF as a query parameter in the action attribute of the form. An example with a jsp is shown below</p>
<pre class="programlisting"><span class="hl-tag">&lt;form</span> <span class="hl-attribute">action</span>=<span class="hl-value">"./upload?${_csrf.parameterName}=${_csrf.token}"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"post"</span> <span class="hl-attribute">enctype</span>=<span class="hl-value">"multipart/form-data"</span><span class="hl-tag">&gt;</span></pre>
<p>The disadvantage to this approach is that query parameters can be leaked. More genearlly, it is considered best practice to place sensitive data within the body or headers to ensure it is not leaked. Additional information can be found in <a class="ulink" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec15.html#sec15.1.3" target="_top">RFC 2616 Section 15.1.3 Encoding Sensitive Information in URI&#8217;s</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="hiddenhttpmethodfilter" href="index.html#hiddenhttpmethodfilter"></a>19.5.5&nbsp;HiddenHttpMethodFilter</h3></div></div></div>
<p>The HiddenHttpMethodFilter should be placed before the Spring Security filter. In general this is true, but it could have additional implications when protecting against CSRF attacks.</p>
<p>Note that the HiddenHttpMethodFilter only overrides the HTTP method on a POST, so this is actually unlikely to cause any real problems. However, it is still best practice to ensure it is placed before Spring Security&#8217;s filters.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="overriding-defaults" href="index.html#overriding-defaults"></a>19.6&nbsp;Overriding Defaults</h2></div></div></div>
<p>Spring Security&#8217;s goal is to provide defaults that protect your users from exploits. This does not mean that you are forced to accept all of its defaults.</p>
<p>For example, you can provide a custom CsrfTokenRepository to override the way in which the <code class="literal">CsrfToken</code> is stored.</p>
<p>You can also specify a custom RequestMatcher to determine which requests are protected by CSRF (i.e. perhaps you don&#8217;t care if log out is exploited). In short, if Spring Security&#8217;s CSRF protection doesn&#8217;t behave exactly as you want it, you are able to customize the behavior. Refer to the <a class="xref" href="index.html#nsa-csrf" title="43.1.18&nbsp;<csrf&gt;">Section&nbsp;43.1.18, &#8220;&lt;csrf&gt;&#8221;</a> documentation for details on how to make these customizations with XML and the <code class="literal">CsrfConfigurer</code> javadoc for details on how to make these customizations when using Java configuration.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="cors" href="index.html#cors"></a>20.&nbsp;CORS</h2></div></div></div>
<p>Spring Framework provides <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/#cors" target="_top">first class support for CORS</a>.
CORS must be processed before Spring Security because the pre-flight request will not contain any cookies (i.e. the <code class="literal">JSESSIONID</code>).
If the request does not contain any cookies and Spring Security is first, the request will determine the user is not authenticated (since there are no cookies in the request) and reject it.</p>
<p>The easiest way to ensure that CORS is handled first is to use the <code class="literal">CorsFilter</code>.
Users can integrate the <code class="literal">CorsFilter</code> with Spring Security by providing a <code class="literal">CorsConfigurationSource</code> using the following:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			<span class="hl-comment">// by default uses a Bean by the name of corsConfigurationSource</span>
			.cors().and()
			...
	}

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	CorsConfigurationSource corsConfigurationSource() {
		CorsConfiguration configuration = <span class="hl-keyword">new</span> CorsConfiguration();
		configuration.setAllowedOrigins(Arrays.asList(<span class="hl-string">"https://example.com"</span>));
		configuration.setAllowedMethods(Arrays.asList(<span class="hl-string">"GET"</span>,<span class="hl-string">"POST"</span>));
		UrlBasedCorsConfigurationSource source = <span class="hl-keyword">new</span> UrlBasedCorsConfigurationSource();
		source.registerCorsConfiguration(<span class="hl-string">"/**"</span>, configuration);
		<span class="hl-keyword">return</span> source;
	}
}</pre>
<p>or in XML</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-tag">&lt;cors</span> <span class="hl-attribute">configuration-source-ref</span>=<span class="hl-value">"corsSource"</span><span class="hl-tag">/&gt;</span>
	...
<span class="hl-tag">&lt;/http&gt;</span>
<span class="hl-tag">&lt;b:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"corsSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.cors.UrlBasedCorsConfigurationSource"</span><span class="hl-tag">&gt;</span>
	...
<span class="hl-tag">&lt;/b:bean&gt;</span></pre>
<p>If you are using Spring MVC&#8217;s CORS support, you can omit specifying the <code class="literal">CorsConfigurationSource</code> and Spring Security will leverage the CORS configuration provided to Spring MVC.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			<span class="hl-comment">// if Spring MVC is on classpath and no CorsConfigurationSource is provided,</span>
			<span class="hl-comment">// Spring Security will use CORS configuration provided to Spring MVC</span>
			.cors().and()
			...
	}
}</pre>
<p>or in XML</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-comment">&lt;!-- Default to Spring MVC's CORS configuration --&gt;</span>
	<span class="hl-tag">&lt;cors /&gt;</span>
	...
<span class="hl-tag">&lt;/http&gt;</span></pre>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="headers" href="index.html#headers"></a>21.&nbsp;Security HTTP Response Headers</h2></div></div></div>
<p>This section discusses Spring Security&#8217;s support for adding various security headers to the response.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="default-security-headers" href="index.html#default-security-headers"></a>21.1&nbsp;Default Security Headers</h2></div></div></div>
<p>Spring Security allows users to easily inject the default security headers to assist in protecting their application.
The default for Spring Security is to include the following headers:</p>
<pre class="programlisting">Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Content-Type-Options: nosniff
Strict-Transport-Security: max-age=31536000 ; includeSubDomains
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Strict-Transport-Security is only added on HTTPS requests</p>
</td></tr></table></div>
<p>For additional details on each of these headers, refer to the corresponding sections:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#headers-cache-control" title="21.1.1&nbsp;Cache Control">Cache Control</a>
</li><li class="listitem">
<a class="link" href="index.html#headers-content-type-options" title="21.1.2&nbsp;Content Type Options">Content Type Options</a>
</li><li class="listitem">
<a class="link" href="index.html#headers-hsts" title="21.1.3&nbsp;HTTP Strict Transport Security (HSTS)">HTTP Strict Transport Security</a>
</li><li class="listitem">
<a class="link" href="index.html#headers-frame-options" title="21.1.5&nbsp;X-Frame-Options">X-Frame-Options</a>
</li><li class="listitem">
<a class="link" href="index.html#headers-xss-protection" title="21.1.6&nbsp;X-XSS-Protection">X-XSS-Protection</a>
</li></ul></div>
<p>While each of these headers are considered best practice, it should be noted that not all clients utilize the headers, so additional testing is encouraged.</p>
<p>You can customize specific headers.
For example, assume that want your HTTP response headers to look like the following:</p>
<pre class="programlisting">Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
X-XSS-Protection: 1; mode=block</pre>
<p>Specifically, you want all of the default headers with the following customizations:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#headers-frame-options" title="21.1.5&nbsp;X-Frame-Options">X-Frame-Options</a> to allow any request from same domain
</li><li class="listitem">
<a class="link" href="index.html#headers-hsts" title="21.1.3&nbsp;HTTP Strict Transport Security (HSTS)">HTTP Strict Transport Security (HSTS)</a> will not be addded to the response
</li></ul></div>
<p>You can easily do this with the following Java Configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span>
		WebSecurityConfigurerAdapter {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			<span class="hl-comment">// ...</span>
			.headers()
				.frameOptions().sameOrigin()
				.httpStrictTransportSecurity().disable();
	}
}</pre>
<p>Alternatively, if you are using Spring Security XML Configuration, you can use the following:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-comment">&lt;!-- ... --&gt;</span>

	<span class="hl-tag">&lt;headers&gt;</span>
		<span class="hl-tag">&lt;frame-options</span> <span class="hl-attribute">policy</span>=<span class="hl-value">"SAMEORIGIN"</span><span class="hl-tag"> /&gt;</span>
		<span class="hl-tag">&lt;hsts</span> <span class="hl-attribute">disable</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/headers&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>If you do not want the defaults to be added and want explicit control over what should be used, you can disable the defaults.
An example for both Java and XML based configuration is provided below:</p>
<p>If you are using Spring Security&#8217;s Java Configuration the following will only add <a class="link" href="index.html#headers-cache-control" title="21.1.1&nbsp;Cache Control">Cache Control</a>.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span>
WebSecurityConfigurerAdapter {

<em><span class="hl-annotation" style="color: gray">@Override</span></em>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
	<span class="hl-comment">// ...</span>
	.headers()
		<span class="hl-comment">// do not use any default headers unless explicitly listed</span>
		.defaultsDisabled()
		.cacheControl();
}
}</pre>
<p>The following XML will only add <a class="link" href="index.html#headers-cache-control" title="21.1.1&nbsp;Cache Control">Cache Control</a>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-comment">&lt;!-- ... --&gt;</span>

	<span class="hl-tag">&lt;headers</span> <span class="hl-attribute">defaults-disabled</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;cache-control/&gt;</span>
	<span class="hl-tag">&lt;/headers&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>If necessary, you can disable all of the HTTP Security response headers with the following Java Configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span>
WebSecurityConfigurerAdapter {

<em><span class="hl-annotation" style="color: gray">@Override</span></em>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
	<span class="hl-comment">// ...</span>
	.headers().disable();
}
}</pre>
<p>If necessary, you can disable all of the HTTP Security response headers with the following XML configuration below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-comment">&lt;!-- ... --&gt;</span>

	<span class="hl-tag">&lt;headers</span> <span class="hl-attribute">disabled</span>=<span class="hl-value">"true"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="headers-cache-control" href="index.html#headers-cache-control"></a>21.1.1&nbsp;Cache Control</h3></div></div></div>
<p>In the past Spring Security required you to provide your own cache control for your web application. This seemed reasonable at the time, but browser caches have evolved to include caches for secure connections as well. This means that a user may view an authenticated page, log out, and then a malicious user can use the browser history to view the cached page. To help mitigate this Spring Security has added cache control support which will insert the following headers into you response.</p>
<pre class="screen">Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0</pre>
<p>Simply adding the <a class="link" href="index.html#nsa-headers" title="43.1.5&nbsp;<headers&gt;">&lt;headers</a>&gt; element with no child elements will automatically add Cache Control and quite a few other protections.
However, if you only want cache control, you can enable this feature using Spring Security&#8217;s XML namespace with the <a class="link" href="index.html#nsa-cache-control" title="43.1.6&nbsp;<cache-control&gt;">&lt;cache-control</a>&gt; element and the <a class="link" href="index.html#nsa-headers-defaults-disabled"><span class="__cf_email__" data-cfemail="84ece1e5e0e1f6f7c4e0e1e2e5f1e8f0f7a9e0edf7e5e6e8e1e0">[email&#160;protected]</span></a> attribute.</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-comment">&lt;!-- ... --&gt;</span>

	<span class="hl-tag">&lt;headers</span> <span class="hl-attribute">defaults-disable</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;cache-control /&gt;</span>
	<span class="hl-tag">&lt;/headers&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>Similarly, you can enable only cache control within Java Configuration with the following:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span>
WebSecurityConfigurerAdapter {

<em><span class="hl-annotation" style="color: gray">@Override</span></em>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
	<span class="hl-comment">// ...</span>
	.headers()
		.defaultsDisabled()
		.cacheControl();
}
}</pre>
<p>If you actually want to cache specific responses, your application can selectively invoke <a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletResponse.html#setHeader(java.lang.String,java.lang.String)" target="_top">HttpServletResponse.setHeader(String,String)</a> to override the header set by Spring Security. This is useful to ensure things like CSS, JavaScript, and images are properly cached.</p>
<p>When using Spring Web MVC, this is typically done within your configuration. For example, the following configuration will ensure that the cache headers are set for all of your resources:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebMvc</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebMvcConfiguration <span class="hl-keyword">implements</span> WebMvcConfigurer {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> addResourceHandlers(ResourceHandlerRegistry registry) {
		registry
			.addResourceHandler(<span class="hl-string">"/resources/**"</span>)
			.addResourceLocations(<span class="hl-string">"/resources/"</span>)
			.setCachePeriod(<span class="hl-number">31556926</span>);
	}

	<span class="hl-comment">// ...</span>
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="headers-content-type-options" href="index.html#headers-content-type-options"></a>21.1.2&nbsp;Content Type Options</h3></div></div></div>
<p>Historically browsers, including Internet Explorer, would try to guess the content type of a request using <a class="ulink" href="https://en.wikipedia.org/wiki/Content_sniffing" target="_top">content sniffing</a>. This allowed browsers to improve the user experience by guessing the content type on resources that had not specified the content type. For example, if a browser encountered a JavaScript file that did not have the content type specified, it would be able to guess the content type and then execute it.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>There are many additional things one should do (i.e. only display the document in a distinct domain, ensure Content-Type header is set, sanitize the document, etc) when allowing content to be uploaded. However, these measures are out of the scope of what Spring Security provides. It is also important to point out when disabling content sniffing, you must specify the content type in order for things to work properly.</p>
</td></tr></table></div>
<p>The problem with content sniffing is that this allowed malicious users to use polyglots (i.e. a file that is valid as multiple content types) to execute XSS attacks. For example, some sites may allow users to submit a valid postscript document to a website and view it. A malicious user might create a <a class="ulink" href="http://webblaze.cs.berkeley.edu/papers/barth-caballero-song.pdf" target="_top">postscript document that is also a valid JavaScript file</a> and execute a XSS attack with it.</p>
<p>Content sniffing can be disabled by adding the following header to our response:</p>
<pre class="screen">X-Content-Type-Options: nosniff</pre>
<p>Just as with the cache control element, the nosniff directive is added by default when using the &lt;headers&gt; element with no child elements.
However, if you want more control over which headers are added you can use the <a class="link" href="index.html#nsa-content-type-options" title="43.1.15&nbsp;<content-type-options&gt;">&lt;content-type-options</a>&gt; element and the <a class="link" href="index.html#nsa-headers-defaults-disabled"><span class="__cf_email__" data-cfemail="2f474a4e4b4a5d5c6f4b4a494e5a435b5c024b465c4e4d434a4b">[email&#160;protected]</span></a> attribute as shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-comment">&lt;!-- ... --&gt;</span>

	<span class="hl-tag">&lt;headers</span> <span class="hl-attribute">defaults-disabled</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;content-type-options /&gt;</span>
	<span class="hl-tag">&lt;/headers&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>The X-Content-Type-Options header is added by default with Spring Security Java configuration. If you want more control over the headers, you can explicitly specify the content type options with the following:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span>
WebSecurityConfigurerAdapter {

<em><span class="hl-annotation" style="color: gray">@Override</span></em>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
	<span class="hl-comment">// ...</span>
	.headers()
		.defaultsDisabled()
		.contentTypeOptions();
}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="headers-hsts" href="index.html#headers-hsts"></a>21.1.3&nbsp;HTTP Strict Transport Security (HSTS)</h3></div></div></div>
<p>When you type in your bank&#8217;s website, do you enter mybank.example.com or do you enter <a class="ulink" href="https://mybank.example.com" target="_top">https://mybank.example.com</a>? If you omit the https protocol, you are potentially vulnerable to <a class="ulink" href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack" target="_top">Man in the Middle attacks</a>. Even if the website performs a redirect to <a class="ulink" href="https://mybank.example.com" target="_top">https://mybank.example.com</a> a malicious user could intercept the initial HTTP request and manipulate the response (i.e. redirect to <a class="ulink" href="https://mibank.example.com" target="_top">https://mibank.example.com</a> and steal their credentials).</p>
<p>Many users omit the https protocol and this is why <a class="ulink" href="https://tools.ietf.org/html/rfc6797" target="_top">HTTP Strict Transport Security (HSTS)</a> was created. Once mybank.example.com is added as a <a class="ulink" href="https://tools.ietf.org/html/rfc6797#section-5.1" target="_top">HSTS host</a>, a browser can know ahead of time that any request to mybank.example.com should be interpreted as <a class="ulink" href="https://mybank.example.com" target="_top">https://mybank.example.com</a>. This greatly reduces the possibility of a Man in the Middle attack occurring.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In accordance with <a class="ulink" href="https://tools.ietf.org/html/rfc6797#section-7.2" target="_top">RFC6797</a>, the HSTS header is only injected into HTTPS responses. In order for the browser to acknowledge the header, the browser must first trust the CA that signed the SSL certificate used to make the connection (not just the SSL certificate).</p>
</td></tr></table></div>
<p>One way for a site to be marked as a HSTS host is to have the host preloaded into the browser. Another is to add the "Strict-Transport-Security" header to the response. For example the following would instruct the browser to treat the domain as an HSTS host for a year (there are approximately 31536000 seconds in a year):</p>
<pre class="screen">Strict-Transport-Security: max-age=31536000 ; includeSubDomains</pre>
<p>The optional includeSubDomains directive instructs Spring Security that subdomains (i.e. secure.mybank.example.com) should also be treated as an HSTS domain.</p>
<p>As with the other headers, Spring Security adds HSTS by default. You can customize HSTS headers with the <a class="link" href="index.html#nsa-hsts" title="43.1.7&nbsp;<hsts&gt;">&lt;hsts</a>&gt; element as shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-comment">&lt;!-- ... --&gt;</span>

	<span class="hl-tag">&lt;headers&gt;</span>
		<span class="hl-tag">&lt;hsts</span>
			<span class="hl-attribute">include-subdomains</span>=<span class="hl-value">"true"</span>
			<span class="hl-attribute">max-age-seconds</span>=<span class="hl-value">"31536000"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/headers&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>Similarly, you can enable only HSTS headers with Java Configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span>
WebSecurityConfigurerAdapter {

<em><span class="hl-annotation" style="color: gray">@Override</span></em>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
	<span class="hl-comment">// ...</span>
	.headers()
		.httpStrictTransportSecurity()
			.includeSubdomains(true)
			.maxAgeSeconds(<span class="hl-number">31536000</span>);
}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="headers-hpkp" href="index.html#headers-hpkp"></a>21.1.4&nbsp;HTTP Public Key Pinning (HPKP)</h3></div></div></div>
<p>HTTP Public Key Pinning (HPKP) is a security feature that tells a web client to associate a specific cryptographic public key with a certain web server to prevent Man in the Middle (MITM) attacks with forged certificates.</p>
<p>To ensure the authenticity of a server&#8217;s public key used in TLS sessions, this public key is wrapped into a X.509 certificate which is usually signed by a certificate authority (CA). Web clients such as browsers trust a lot of these CAs, which can all create certificates for arbitrary domain names.
If an attacker is able to compromise a single CA, they can perform MITM attacks on various TLS connections. HPKP can circumvent this threat for the HTTPS protocol by telling the client which public key belongs to a certain web server.
HPKP is a Trust on First Use (TOFU) technique. The first time a web server tells a client via a special HTTP header which public keys belong to it, the client stores this information for a given period of time.
When the client visits the server again, it expects a certificate containing a public key whose fingerprint is already known via HPKP. If the server delivers an unknown public key, the client should present a warning to the user.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Because the user-agent needs to validate the pins against the SSL certificate chain, the HPKP header is only injected into HTTPS responses.</p>
</td></tr></table></div>
<p>Enabling this feature for your site is as simple as returning the Public-Key-Pins HTTP header when your site is accessed over HTTPS.
For example, the following would instruct the user-agent to only report pin validation failures to a given URI (via the <a class="ulink" href="https://tools.ietf.org/html/rfc7469#section-2.1.4" target="_top"><span class="strong"><strong><span class="emphasis"><em>report-uri</em></span></strong></span></a> directive) for 2 pins:</p>
<pre class="screen">Public-Key-Pins-Report-Only: max-age=5184000 ; pin-sha256="d6qzRu9zOECb90Uez27xWltNsj0e1Md7GkYYkVoZWmM=" ; pin-sha256="E9CZ9INDbd+2eRQozYqqbQ2yXLVKB9+xcprMF+44U1g=" ; report-uri="http://example.net/pkp-report" ; includeSubDomains</pre>
<p>A <a class="ulink" href="https://tools.ietf.org/html/rfc7469#section-3" target="_top"><span class="strong"><strong><span class="emphasis"><em>pin validation failure report</em></span></strong></span></a> is a standard JSON structure that can be captured
either by the web application&#8217;s own API or by a publicly hosted HPKP reporting service, such as, <a class="ulink" href="https://report-uri.io/" target="_top"><span class="strong"><strong><span class="emphasis"><em>REPORT-URI</em></span></strong></span></a>.</p>
<p>The optional includeSubDomains directive instructs the browser to also validate subdomains with the given pins.</p>
<p>Opposed to the other headers, Spring Security does not add HPKP by default. You can customize HPKP headers with the <a class="link" href="index.html#nsa-hpkp" title="43.1.8&nbsp;<hpkp&gt;">&lt;hpkp</a>&gt; element as shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-comment">&lt;!-- ... --&gt;</span>

	<span class="hl-tag">&lt;headers&gt;</span>
		<span class="hl-tag">&lt;hpkp</span>
			<span class="hl-attribute">include-subdomains</span>=<span class="hl-value">"true"</span>
			<span class="hl-attribute">report-uri</span>=<span class="hl-value">"http://example.net/pkp-report"</span><span class="hl-tag">&gt;</span>
			<span class="hl-tag">&lt;pins&gt;</span>
					<span class="hl-tag">&lt;pin</span> <span class="hl-attribute">algorithm</span>=<span class="hl-value">"sha256"</span><span class="hl-tag">&gt;</span>d6qzRu9zOECb90Uez27xWltNsj0e1Md7GkYYkVoZWmM=<span class="hl-tag">&lt;/pin&gt;</span>
					<span class="hl-tag">&lt;pin</span> <span class="hl-attribute">algorithm</span>=<span class="hl-value">"sha256"</span><span class="hl-tag">&gt;</span>E9CZ9INDbd+2eRQozYqqbQ2yXLVKB9+xcprMF+44U1g=<span class="hl-tag">&lt;/pin&gt;</span>
			<span class="hl-tag">&lt;/pins&gt;</span>
		<span class="hl-tag">&lt;/hpkp&gt;</span>
	<span class="hl-tag">&lt;/headers&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>Similarly, you can enable HPKP headers with Java Configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span>
WebSecurityConfigurerAdapter {

		<em><span class="hl-annotation" style="color: gray">@Override</span></em>
		<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
				http
				<span class="hl-comment">// ...</span>
				.headers()
						.httpPublicKeyPinning()
								.includeSubdomains(true)
								.reportUri(<span class="hl-string">"http://example.net/pkp-report"</span>)
								.addSha256Pins(<span class="hl-string">"d6qzRu9zOECb90Uez27xWltNsj0e1Md7GkYYkVoZWmM="</span>, <span class="hl-string">"E9CZ9INDbd+2eRQozYqqbQ2yXLVKB9+xcprMF+44U1g="</span>;
		}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="headers-frame-options" href="index.html#headers-frame-options"></a>21.1.5&nbsp;X-Frame-Options</h3></div></div></div>
<p>Allowing your website to be added to a frame can be a security issue. For example, using clever CSS styling users could be tricked into clicking on something that they were not intending (<a class="ulink" href="https://www.youtube.com/watch?v=3mk0RySeNsU" target="_top">video demo</a>). For example, a user that is logged into their bank might click a button that grants access to other users. This sort of attack is known as <a class="ulink" href="https://en.wikipedia.org/wiki/Clickjacking" target="_top">Clickjacking</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Another modern approach to dealing with clickjacking is to use <a class="xref" href="index.html#headers-csp" title="21.1.7&nbsp;Content Security Policy (CSP)">Section&nbsp;21.1.7, &#8220;Content Security Policy (CSP)&#8221;</a>.</p>
</td></tr></table></div>
<p>There are a number ways to mitigate clickjacking attacks. For example, to protect legacy browsers from clickjacking attacks you can use <a class="ulink" href="https://www.owasp.org/index.php/Clickjacking_Defense_Cheat_Sheet#Best-for-now_Legacy_Browser_Frame_Breaking_Script" target="_top">frame breaking code</a>. While not perfect, the frame breaking code is the best you can do for the legacy browsers.</p>
<p>A more modern approach to address clickjacking is to use <a class="ulink" href="https://developer.mozilla.org/en-US/docs/HTTP/X-Frame-Options" target="_top">X-Frame-Options</a> header:</p>
<pre class="screen">X-Frame-Options: DENY</pre>
<p>The X-Frame-Options response header instructs the browser to prevent any site with this header in the response from being rendered within a frame.
By default, Spring Security disables rendering within an iframe.</p>
<p>You can customize X-Frame-Options with the <a class="link" href="index.html#nsa-frame-options" title="43.1.13&nbsp;<frame-options&gt;">frame-options</a> element.
For example, the following will instruct Spring Security to use "X-Frame-Options: SAMEORIGIN" which allows iframes within the same domain:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-comment">&lt;!-- ... --&gt;</span>

	<span class="hl-tag">&lt;headers&gt;</span>
		<span class="hl-tag">&lt;frame-options</span>
		<span class="hl-attribute">policy</span>=<span class="hl-value">"SAMEORIGIN"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/headers&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>Similarly, you can customize frame options to use the same origin within Java Configuration using the following:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span>
WebSecurityConfigurerAdapter {

<em><span class="hl-annotation" style="color: gray">@Override</span></em>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
	<span class="hl-comment">// ...</span>
	.headers()
		.frameOptions()
			.sameOrigin();
}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="headers-xss-protection" href="index.html#headers-xss-protection"></a>21.1.6&nbsp;X-XSS-Protection</h3></div></div></div>
<p>Some browsers have built in support for filtering out <a class="ulink" href="https://www.owasp.org/index.php/Testing_for_Reflected_Cross_site_scripting_(OWASP-DV-001)" target="_top">reflected XSS attacks</a>. This is by no means foolproof, but does assist in XSS protection.</p>
<p>The filtering is typically enabled by default, so adding the header typically just ensures it is enabled and instructs the browser what to do when a XSS attack is detected. For example, the filter might try to change the content in the least invasive way to still render everything. At times, this type of replacement can become a <a class="ulink" href="https://hackademix.net/2009/11/21/ies-xss-filter-creates-xss-vulnerabilities/" target="_top">XSS vulnerability in itself</a>. Instead, it is best to block the content rather than attempt to fix it. To do this we can add the following header:</p>
<pre class="screen">X-XSS-Protection: 1; mode=block</pre>
<p>This header is included by default. However, we can customize it if we wanted. For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-comment">&lt;!-- ... --&gt;</span>

	<span class="hl-tag">&lt;headers&gt;</span>
		<span class="hl-tag">&lt;xss-protection</span> <span class="hl-attribute">block</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/headers&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>Similarly, you can customize XSS protection within Java Configuration with the following:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span>
WebSecurityConfigurerAdapter {

<em><span class="hl-annotation" style="color: gray">@Override</span></em>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
	<span class="hl-comment">// ...</span>
	.headers()
		.xssProtection()
			.block(false);
}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="headers-csp" href="index.html#headers-csp"></a>21.1.7&nbsp;Content Security Policy (CSP)</h3></div></div></div>
<p><a class="ulink" href="https://www.w3.org/TR/CSP2/" target="_top">Content Security Policy (CSP)</a> is a mechanism that web applications can leverage to mitigate content injection vulnerabilities,
such as cross-site scripting (XSS). CSP is a declarative policy that provides a facility for web application authors to declare and ultimately inform
the client (user-agent) about the sources from which the web application expects to load resources.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Content Security Policy is not intended to solve all content injection vulnerabilities.
Instead, CSP can be leveraged to help reduce the harm caused by content injection attacks.
As a first line of defense, web application authors should validate their input and encode their output.</p>
</td></tr></table></div>
<p>A web application may employ the use of CSP by including one of the following HTTP headers in the response:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong><span class="emphasis"><em>Content-Security-Policy</em></span></strong></span>
</li><li class="listitem">
<span class="strong"><strong><span class="emphasis"><em>Content-Security-Policy-Report-Only</em></span></strong></span>
</li></ul></div>
<p>Each of these headers are used as a mechanism to deliver a <span class="strong"><strong><span class="emphasis"><em>security policy</em></span></strong></span> to the client.
A security policy contains a set of <span class="strong"><strong><span class="emphasis"><em>security policy directives</em></span></strong></span> (for example, <span class="emphasis"><em>script-src</em></span> and <span class="emphasis"><em>object-src</em></span>),
each responsible for declaring the restrictions for a particular resource representation.</p>
<p>For example, a web application can declare that it expects to load scripts from specific, trusted sources,
by including the following header in the response:</p>
<pre class="screen">Content-Security-Policy: script-src https://trustedscripts.example.com</pre>
<p>An attempt to load a script from another source other than what is declared in the <span class="emphasis"><em>script-src</em></span> directive will be blocked by the user-agent.
Additionally, if the <a class="ulink" href="https://www.w3.org/TR/CSP2/#directive-report-uri" target="_top"><span class="strong"><strong><span class="emphasis"><em>report-uri</em></span></strong></span></a> directive is declared in the security policy,
then the violation will be reported by the user-agent to the declared URL.</p>
<p>For example, if a web application violates the declared security policy,
the following response header will instruct the user-agent to send violation reports to the URL specified in the policy&#8217;s <span class="emphasis"><em>report-uri</em></span> directive.</p>
<pre class="screen">Content-Security-Policy: script-src https://trustedscripts.example.com; report-uri /csp-report-endpoint/</pre>
<p><a class="ulink" href="https://www.w3.org/TR/CSP2/#violation-reports" target="_top"><span class="strong"><strong><span class="emphasis"><em>Violation reports</em></span></strong></span></a> are standard JSON structures that can be captured
either by the web application&#8217;s own API or by a publicly hosted CSP violation reporting service, such as, <a class="ulink" href="https://report-uri.io/" target="_top"><span class="strong"><strong><span class="emphasis"><em>REPORT-URI</em></span></strong></span></a>.</p>
<p>The <span class="strong"><strong><span class="emphasis"><em>Content-Security-Policy-Report-Only</em></span></strong></span> header provides the capability for web application authors and administrators to monitor security policies, rather than enforce them.
This header is typically used when experimenting and/or developing security policies for a site.
When a policy is deemed effective, it can be enforced by using the <span class="emphasis"><em>Content-Security-Policy</em></span> header field instead.</p>
<p>Given the following response header, the policy declares that scripts may be loaded from one of two possible sources.</p>
<pre class="screen">Content-Security-Policy-Report-Only: script-src 'self' https://trustedscripts.example.com; report-uri /csp-report-endpoint/</pre>
<p>If the site violates this policy, by attempting to load a script from <span class="emphasis"><em>evil.com</em></span>,
the user-agent will send a violation report to the declared URL specified by the <span class="emphasis"><em>report-uri</em></span> directive,
but still allow the violating resource to load nevertheless.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="headers-csp-configure" href="index.html#headers-csp-configure"></a>Configuring Content Security Policy</h4></div></div></div>
<p>It&#8217;s important to note that Spring Security <span class="strong"><strong><span class="emphasis"><em>does not add</em></span></strong></span> Content Security Policy by default.
The web application author must declare the security policy(s) to enforce and/or monitor for the protected resources.</p>
<p>For example, given the following security policy:</p>
<pre class="screen">script-src 'self' https://trustedscripts.example.com; object-src https://trustedplugins.example.com; report-uri /csp-report-endpoint/</pre>
<p>You can enable the CSP header using XML configuration with the <a class="link" href="index.html#nsa-content-security-policy" title="43.1.11&nbsp;<content-security-policy&gt;">&lt;content-security-policy</a>&gt; element as shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-comment">&lt;!-- ... --&gt;</span>

	<span class="hl-tag">&lt;headers&gt;</span>
		<span class="hl-tag">&lt;content-security-policy</span>
			<span class="hl-attribute">policy-directives</span>=<span class="hl-value">"script-src 'self' https://trustedscripts.example.com; object-src https://trustedplugins.example.com; report-uri /csp-report-endpoint/"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/headers&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>To enable the CSP <span class="emphasis"><em>'report-only'</em></span> header, configure the element as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-comment">&lt;!-- ... --&gt;</span>

	<span class="hl-tag">&lt;headers&gt;</span>
		<span class="hl-tag">&lt;content-security-policy</span>
			<span class="hl-attribute">policy-directives</span>=<span class="hl-value">"script-src 'self' https://trustedscripts.example.com; object-src https://trustedplugins.example.com; report-uri /csp-report-endpoint/"</span>
			<span class="hl-attribute">report-only</span>=<span class="hl-value">"true"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/headers&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>Similarly, you can enable the CSP header using Java configuration as shown below:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span>
WebSecurityConfigurerAdapter {

<em><span class="hl-annotation" style="color: gray">@Override</span></em>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
	<span class="hl-comment">// ...</span>
	.headers()
		.contentSecurityPolicy(<span class="hl-string">"script-src 'self' https://trustedscripts.example.com; object-src https://trustedplugins.example.com; report-uri /csp-report-endpoint/"</span>);
}
}</pre>
<p>To enable the CSP <span class="emphasis"><em>'report-only'</em></span> header, provide the following Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span>
WebSecurityConfigurerAdapter {

<em><span class="hl-annotation" style="color: gray">@Override</span></em>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
	<span class="hl-comment">// ...</span>
	.headers()
		.contentSecurityPolicy(<span class="hl-string">"script-src 'self' https://trustedscripts.example.com; object-src https://trustedplugins.example.com; report-uri /csp-report-endpoint/"</span>)
		.reportOnly();
}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="headers-csp-links" href="index.html#headers-csp-links"></a>Additional Resources</h4></div></div></div>
<p>Applying Content Security Policy to a web application is often a non-trivial undertaking.
The following resources may provide further assistance in developing effective security policies for your site.</p>
<p><a class="ulink" href="https://www.html5rocks.com/en/tutorials/security/content-security-policy/" target="_top">An Introduction to Content Security Policy</a></p>
<p><a class="ulink" href="https://developer.mozilla.org/en-US/docs/Web/Security/CSP" target="_top">CSP Guide - Mozilla Developer Network</a></p>
<p><a class="ulink" href="https://www.w3.org/TR/CSP2/" target="_top">W3C Candidate Recommendation</a></p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="headers-referrer" href="index.html#headers-referrer"></a>21.1.8&nbsp;Referrer Policy</h3></div></div></div>
<p><a class="ulink" href="https://www.w3.org/TR/referrer-policy" target="_top">Referrer Policy</a> is a mechanism that web applications can leverage to manage the referrer field, which contains the last
page the user was on.</p>
<p>Spring Security&#8217;s approach is to use <a class="ulink" href="https://www.w3.org/TR/referrer-policy/" target="_top">Referrer Policy</a> header, which provides different <a class="ulink" href="https://www.w3.org/TR/referrer-policy/#referrer-policies" target="_top">policies</a>:</p>
<pre class="screen">Referrer-Policy: same-origin</pre>
<p>The Referrer-Policy response header instructs the browser to let the destination knows the source where the user was previously.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="headers-referrer-configure" href="index.html#headers-referrer-configure"></a>Configuring Referrer Policy</h4></div></div></div>
<p>Spring Security <span class="strong"><strong><span class="emphasis"><em>doesn&#8217;t add</em></span></strong></span> Referrer Policy header by default.</p>
<p>You can enable the Referrer-Policy header using XML configuration with the <a class="link" href="index.html#nsa-referrer-policy" title="43.1.12&nbsp;<referrer-policy&gt;">&lt;referrer-policy</a>&gt; element as shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-comment">&lt;!-- ... --&gt;</span>

	<span class="hl-tag">&lt;headers&gt;</span>
		<span class="hl-tag">&lt;referrer-policy</span> <span class="hl-attribute">policy</span>=<span class="hl-value">"same-origin"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/headers&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>Similarly, you can enable the Referrer Policy header using Java configuration as shown below:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span>
WebSecurityConfigurerAdapter {

<em><span class="hl-annotation" style="color: gray">@Override</span></em>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
	<span class="hl-comment">// ...</span>
	.headers()
		.referrerPolicy(ReferrerPolicy.SAME_ORIGIN);
}
}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="headers-custom" href="index.html#headers-custom"></a>21.2&nbsp;Custom Headers</h2></div></div></div>
<p>Spring Security has mechanisms to make it convenient to add the more common security headers to your application. However, it also provides hooks to enable adding custom headers.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="headers-static" href="index.html#headers-static"></a>21.2.1&nbsp;Static Headers</h3></div></div></div>
<p>There may be times you wish to inject custom security headers into your application that are not supported out of the box.
For example, given the following custom security header:</p>
<pre class="screen">X-Custom-Security-Header: header-value</pre>
<p>When using the XML namespace, these headers can be added to the response using the <a class="link" href="index.html#nsa-header" title="43.1.16&nbsp;<header&gt;">&lt;header</a>&gt; element as shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-comment">&lt;!-- ... --&gt;</span>

	<span class="hl-tag">&lt;headers&gt;</span>
		<span class="hl-tag">&lt;header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"X-Custom-Security-Header"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"header-value"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/headers&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>Similarly, the headers could be added to the response using Java Configuration as shown in the following:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span>
WebSecurityConfigurerAdapter {

<em><span class="hl-annotation" style="color: gray">@Override</span></em>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
	<span class="hl-comment">// ...</span>
	.headers()
		.addHeaderWriter(<span class="hl-keyword">new</span> StaticHeadersWriter(<span class="hl-string">"X-Custom-Security-Header"</span>,<span class="hl-string">"header-value"</span>));
}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="headers-writer" href="index.html#headers-writer"></a>21.2.2&nbsp;Headers Writer</h3></div></div></div>
<p>When the namespace or Java configuration does not support the headers you want, you can create a custom <code class="literal">HeadersWriter</code> instance or even provide a custom implementation of the <code class="literal">HeadersWriter</code>.</p>
<p>Let&#8217;s take a look at an example of using an custom instance of <code class="literal">XFrameOptionsHeaderWriter</code>. Perhaps you want to allow framing of content for the same origin. This is easily supported by setting the <a class="link" href="index.html#nsa-frame-options-policy">policy</a> attribute to "SAMEORIGIN", but let&#8217;s take a look at a more explicit example using the <a class="link" href="index.html#nsa-header-ref">ref</a> attribute.</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-comment">&lt;!-- ... --&gt;</span>

	<span class="hl-tag">&lt;headers&gt;</span>
		<span class="hl-tag">&lt;header</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"frameOptionsWriter"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/headers&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span>
<span class="hl-comment">&lt;!-- Requires the c-namespace.
See http://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/#beans-c-namespace
--&gt;</span>
<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"frameOptionsWriter"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.header.writers.frameoptions.XFrameOptionsHeaderWriter"</span>
	<span class="hl-attribute">c:frameOptionsMode</span>=<span class="hl-value">"SAMEORIGIN"</span><span class="hl-tag">/&gt;</span></pre>
<p>We could also restrict framing of content to the same origin with Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span>
WebSecurityConfigurerAdapter {

<em><span class="hl-annotation" style="color: gray">@Override</span></em>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
	<span class="hl-comment">// ...</span>
	.headers()
		.addHeaderWriter(<span class="hl-keyword">new</span> XFrameOptionsHeaderWriter(XFrameOptionsMode.SAMEORIGIN));
}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="headers-delegatingrequestmatcherheaderwriter" href="index.html#headers-delegatingrequestmatcherheaderwriter"></a>21.2.3&nbsp;DelegatingRequestMatcherHeaderWriter</h3></div></div></div>
<p>At times you may want to only write a header for certain requests. For example, perhaps you want to only protect your log in page from being framed. You could use the <code class="literal">DelegatingRequestMatcherHeaderWriter</code> to do so. When using the XML namespace configuration, this can be done with the following:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-comment">&lt;!-- ... --&gt;</span>

	<span class="hl-tag">&lt;headers&gt;</span>
		<span class="hl-tag">&lt;frame-options</span> <span class="hl-attribute">disabled</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
		<span class="hl-tag">&lt;header</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"headerWriter"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/headers&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"headerWriter"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.header.writers.DelegatingRequestMatcherHeaderWriter"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;beans:constructor-arg&gt;</span>
		<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.util.matcher.AntPathRequestMatcher"</span>
			<span class="hl-attribute">c:pattern</span>=<span class="hl-value">"/login"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/beans:constructor-arg&gt;</span>
	<span class="hl-tag">&lt;beans:constructor-arg&gt;</span>
		<span class="hl-tag">&lt;beans:bean</span>
			<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.header.writers.frameoptions.XFrameOptionsHeaderWriter"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/beans:constructor-arg&gt;</span>
<span class="hl-tag">&lt;/beans:bean&gt;</span></pre>
<p>We could also prevent framing of content to the log in page using java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span>
WebSecurityConfigurerAdapter {

<em><span class="hl-annotation" style="color: gray">@Override</span></em>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	RequestMatcher matcher = <span class="hl-keyword">new</span> AntPathRequestMatcher(<span class="hl-string">"/login"</span>);
	DelegatingRequestMatcherHeaderWriter headerWriter =
		<span class="hl-keyword">new</span> DelegatingRequestMatcherHeaderWriter(matcher,<span class="hl-keyword">new</span> XFrameOptionsHeaderWriter());
	http
	<span class="hl-comment">// ...</span>
	.headers()
		.frameOptions().disabled()
		.addHeaderWriter(headerWriter);
}
}</pre>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="session-mgmt" href="index.html#session-mgmt"></a>22.&nbsp;Session Management</h2></div></div></div>
<p>HTTP session related functionality is handled by a combination of the <code class="literal">SessionManagementFilter</code> and the <code class="literal">SessionAuthenticationStrategy</code> interface, which the filter delegates to. Typical usage includes session-fixation protection attack prevention, detection of session timeouts and restrictions on how many sessions an authenticated user may have open concurrently.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sessionmanagementfilter" href="index.html#sessionmanagementfilter"></a>22.1&nbsp;SessionManagementFilter</h2></div></div></div>
<p>The <code class="literal">SessionManagementFilter</code> checks the contents of the <code class="literal">SecurityContextRepository</code> against the current contents of the <code class="literal">SecurityContextHolder</code> to determine whether a user has been authenticated during the current request, typically by a non-interactive authentication mechanism, such as pre-authentication or remember-me <a href="index.html#ftn.d5e4184" class="footnote" name="d5e4184"><sup class="footnote">[17]</sup></a>. If the repository contains a security context, the filter does nothing. If it doesn&#8217;t, and the thread-local <code class="literal">SecurityContext</code> contains a (non-anonymous) <code class="literal">Authentication</code> object, the filter assumes they have been authenticated by a previous filter in the stack. It will then invoke the configured <code class="literal">SessionAuthenticationStrategy</code>.</p>
<p>If the user is not currently authenticated, the filter will check whether an invalid session ID has been requested (because of a timeout, for example) and will invoke the configured <code class="literal">InvalidSessionStrategy</code>, if one is set. The most common behaviour is just to redirect to a fixed URL and this is encapsulated in the standard implementation <code class="literal">SimpleRedirectInvalidSessionStrategy</code>. The latter is also used when configuring an invalid session URL through the namespace,<a class="link" href="index.html#ns-session-mgmt" title="6.3.3&nbsp;Session Management">as described earlier</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sessionauthenticationstrategy" href="index.html#sessionauthenticationstrategy"></a>22.2&nbsp;SessionAuthenticationStrategy</h2></div></div></div>
<p><code class="literal">SessionAuthenticationStrategy</code> is used by both <code class="literal">SessionManagementFilter</code> and <code class="literal">AbstractAuthenticationProcessingFilter</code>, so if you are using a customized form-login class, for example, you will need to inject it into both of these. In this case, a typical configuration, combining the namespace and custom beans might look like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
<span class="hl-tag">&lt;custom-filter</span> <span class="hl-attribute">position</span>=<span class="hl-value">"FORM_LOGIN_FILTER"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myAuthFilter"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;session-management</span> <span class="hl-attribute">session-authentication-strategy-ref</span>=<span class="hl-value">"sas"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myAuthFilter"</span> <span class="hl-attribute">class</span>=
<span class="hl-value">"org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionAuthenticationStrategy"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"sas"</span><span class="hl-tag"> /&gt;</span>
	...
<span class="hl-tag">&lt;/beans:bean&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sas"</span> <span class="hl-attribute">class</span>=
<span class="hl-value">"org.springframework.security.web.authentication.session.SessionFixationProtectionStrategy"</span><span class="hl-tag"> /&gt;</span></pre>
<p>Note that the use of the default, <code class="literal">SessionFixationProtectionStrategy</code> may cause issues if you are storing beans in the session which implement <code class="literal">HttpSessionBindingListener</code>, including Spring session-scoped beans. See the Javadoc for this class for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="concurrent-sessions" href="index.html#concurrent-sessions"></a>22.3&nbsp;Concurrency Control</h2></div></div></div>
<p>Spring Security is able to prevent a principal from concurrently authenticating to the same application more than a specified number of times. Many ISVs take advantage of this to enforce licensing, whilst network administrators like this feature because it helps prevent people from sharing login names. You can, for example, stop user "Batman" from logging onto the web application from two different sessions. You can either expire their previous login or you can report an error when they try to log in again, preventing the second login. Note that if you are using the second approach, a user who has not explicitly logged out (but who has just closed their browser, for example) will not be able to log in again until their original session expires.</p>
<p>Concurrency control is supported by the namespace, so please check the earlier namespace chapter for the simplest configuration. Sometimes you need to customize things though.</p>
<p>The implementation uses a specialized version of <code class="literal">SessionAuthenticationStrategy</code>, called <code class="literal">ConcurrentSessionControlAuthenticationStrategy</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Previously the concurrent authentication check was made by the <code class="literal">ProviderManager</code>, which could be injected with a <code class="literal">ConcurrentSessionController</code>. The latter would check if the user was attempting to exceed the number of permitted sessions. However, this approach required that an HTTP session be created in advance, which is undesirable. In Spring Security 3, the user is first authenticated by the <code class="literal">AuthenticationManager</code> and once they are successfully authenticated, a session is created and the check is made whether they are allowed to have another session open.</p>
</td></tr></table></div>
<p>To use concurrent session support, you&#8217;ll need to add the following to <code class="literal">web.xml</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;listener&gt;</span>
	<span class="hl-tag">&lt;listener-class&gt;</span>
	org.springframework.security.web.session.HttpSessionEventPublisher
	<span class="hl-tag">&lt;/listener-class&gt;</span>
<span class="hl-tag">&lt;/listener&gt;</span></pre>
<p>In addition, you will need to add the <code class="literal">ConcurrentSessionFilter</code> to your <code class="literal">FilterChainProxy</code>. The <code class="literal">ConcurrentSessionFilter</code> requires two constructor arguments, <code class="literal">sessionRegistry</code>, which generally points to an instance of <code class="literal">SessionRegistryImpl</code>, and <code class="literal">sessionInformationExpiredStrategy</code>, which defines the strategy to apply when a session has expired. A configuration using the namespace to create the <code class="literal">FilterChainProxy</code> and other default beans might look like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
<span class="hl-tag">&lt;custom-filter</span> <span class="hl-attribute">position</span>=<span class="hl-value">"CONCURRENT_SESSION_FILTER"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"concurrencyFilter"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;custom-filter</span> <span class="hl-attribute">position</span>=<span class="hl-value">"FORM_LOGIN_FILTER"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myAuthFilter"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;session-management</span> <span class="hl-attribute">session-authentication-strategy-ref</span>=<span class="hl-value">"sas"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redirectSessionInformationExpiredStrategy"</span>
<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.session.SimpleRedirectSessionInformationExpiredStrategy"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;beans:constructor-arg</span> <span class="hl-attribute">name</span>=<span class="hl-value">"invalidSessionUrl"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/session-expired.htm"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/beans:bean&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"concurrencyFilter"</span>
<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.session.ConcurrentSessionFilter"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;beans:constructor-arg</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionRegistry"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"sessionRegistry"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;beans:constructor-arg</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionInformationExpiredStrategy"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"redirectSessionInformationExpiredStrategy"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/beans:bean&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myAuthFilter"</span> <span class="hl-attribute">class</span>=
<span class="hl-value">"org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionAuthenticationStrategy"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"sas"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authenticationManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"authenticationManager"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/beans:bean&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sas"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.authentication.session.CompositeSessionAuthenticationStrategy"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;beans:constructor-arg&gt;</span>
	<span class="hl-tag">&lt;beans:list&gt;</span>
	<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.authentication.session.ConcurrentSessionControlAuthenticationStrategy"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;beans:constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"sessionRegistry"</span><span class="hl-tag">/&gt;</span>
		<span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maximumSessions"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1"</span><span class="hl-tag"> /&gt;</span>
		<span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"exceptionIfMaximumExceeded"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/beans:bean&gt;</span>
	<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.authentication.session.SessionFixationProtectionStrategy"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;/beans:bean&gt;</span>
	<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.authentication.session.RegisterSessionAuthenticationStrategy"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;beans:constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"sessionRegistry"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/beans:bean&gt;</span>
	<span class="hl-tag">&lt;/beans:list&gt;</span>
<span class="hl-tag">&lt;/beans:constructor-arg&gt;</span>
<span class="hl-tag">&lt;/beans:bean&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sessionRegistry"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.core.session.SessionRegistryImpl"</span><span class="hl-tag"> /&gt;</span></pre>
<p>Adding the listener to <code class="literal">web.xml</code> causes an <code class="literal">ApplicationEvent</code> to be published to the Spring <code class="literal">ApplicationContext</code> every time a <code class="literal">HttpSession</code> commences or terminates. This is critical, as it allows the <code class="literal">SessionRegistryImpl</code> to be notified when a session ends. Without it, a user will never be able to log back in again once they have exceeded their session allowance, even if they log out of another session or it times out.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="list-authenticated-principals" href="index.html#list-authenticated-principals"></a>22.3.1&nbsp;Querying the SessionRegistry for currently authenticated users and their sessions</h3></div></div></div>
<p>Setting up concurrency-control, either through the namespace or using plain beans has the useful side effect of providing you with a reference to the <code class="literal">SessionRegistry</code> which you can use directly within your application, so even if you don&#8217;t want to restrict the number of sessions a user may have, it may be worth setting up the infrastructure anyway. You can set the <code class="literal">maximumSession</code> property to -1 to allow unlimited sessions. If you&#8217;re using the namespace, you can set an alias for the internally-created <code class="literal">SessionRegistry</code> using the <code class="literal">session-registry-alias</code> attribute, providing a reference which you can inject into your own beans.</p>
<p>The <code class="literal">getAllPrincipals()</code> method supplies you with a list of the currently authenticated users. You can list a user&#8217;s sessions by calling the <code class="literal">getAllSessions(Object principal, boolean includeExpiredSessions)</code> method, which returns a list of <code class="literal">SessionInformation</code> objects. You can also expire a user&#8217;s session by calling <code class="literal">expireNow()</code> on a <code class="literal">SessionInformation</code> instance. When the user returns to the application, they will be prevented from proceeding. You may find these methods useful in an administration application, for example. Have a look at the Javadoc for more information.</p>
</div>
</div>
<div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.d5e4184" class="footnote"><p><a href="index.html#d5e4184" class="simpara"><sup class="simpara">[17] </sup></a>Authentication by mechanisms which perform a redirect after authenticating (such as form-login) will not be detected by <code class="literal">SessionManagementFilter</code>, as the filter will not be invoked during the authenticating request. Session-management functionality has to be handled separately in these cases.</p></div></div></div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="anonymous" href="index.html#anonymous"></a>23.&nbsp;Anonymous Authentication</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="anonymous-overview" href="index.html#anonymous-overview"></a>23.1&nbsp;Overview</h2></div></div></div>
<p>It&#8217;s generally considered good security practice to adopt a "deny-by-default" where you explicitly specify what is allowed and disallow everything else. Defining what is accessible to unauthenticated users is a similar situation, particularly for web applications. Many sites require that users must be authenticated for anything other than a few URLs (for example the home and login pages). In this case it is easiest to define access configuration attributes for these specific URLs rather than have for every secured resource. Put differently, sometimes it is nice to say <code class="literal">ROLE_SOMETHING</code> is required by default and only allow certain exceptions to this rule, such as for login, logout and home pages of an application. You could also omit these pages from the filter chain entirely, thus bypassing the access control checks, but this may be undesirable for other reasons, particularly if the pages behave differently for authenticated users.</p>
<p>This is what we mean by anonymous authentication. Note that there is no real conceptual difference between a user who is "anonymously authenticated" and an unauthenticated user. Spring Security&#8217;s anonymous authentication just gives you a more convenient way to configure your access-control attributes. Calls to servlet API calls such as <code class="literal">getCallerPrincipal</code>, for example, will still return null even though there is actually an anonymous authentication object in the <code class="literal">SecurityContextHolder</code>.</p>
<p>There are other situations where anonymous authentication is useful, such as when an auditing interceptor queries the <code class="literal">SecurityContextHolder</code> to identify which principal was responsible for a given operation. Classes can be authored more robustly if they know the <code class="literal">SecurityContextHolder</code> always contains an <code class="literal">Authentication</code> object, and never <code class="literal">null</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="anonymous-config" href="index.html#anonymous-config"></a>23.2&nbsp;Configuration</h2></div></div></div>
<p>Anonymous authentication support is provided automatically when using the HTTP configuration Spring Security 3.0 and can be customized (or disabled) using the <code class="literal">&lt;anonymous&gt;</code> element. You don&#8217;t need to configure the beans described here unless you are using traditional bean configuration.</p>
<p>Three classes that together provide the anonymous authentication feature. <code class="literal">AnonymousAuthenticationToken</code> is an implementation of <code class="literal">Authentication</code>, and stores the <code class="literal">GrantedAuthority</code> s which apply to the anonymous principal. There is a corresponding <code class="literal">AnonymousAuthenticationProvider</code>, which is chained into the <code class="literal">ProviderManager</code> so that <code class="literal">AnonymousAuthenticationToken</code> s are accepted. Finally, there is an <code class="literal">AnonymousAuthenticationFilter</code>, which is chained after the normal authentication mechanisms and automatically adds an <code class="literal">AnonymousAuthenticationToken</code> to the <code class="literal">SecurityContextHolder</code> if there is no existing <code class="literal">Authentication</code> held there. The definition of the filter and authentication provider appears as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"anonymousAuthFilter"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.authentication.AnonymousAuthenticationFilter"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"key"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"foobar"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"userAttribute"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"anonymousUser,ROLE_ANONYMOUS"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"anonymousAuthenticationProvider"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.authentication.AnonymousAuthenticationProvider"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"key"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"foobar"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>The <code class="literal">key</code> is shared between the filter and authentication provider, so that tokens created by the former are accepted by the latter <a href="index.html#ftn.d5e4279" class="footnote" name="d5e4279"><sup class="footnote">[18]</sup></a>. The <code class="literal">userAttribute</code> is expressed in the form of <code class="literal">usernameInTheAuthenticationToken,grantedAuthority[,grantedAuthority]</code>. This is the same syntax as used after the equals sign for the <code class="literal">userMap</code> property of <code class="literal">InMemoryDaoImpl</code>.</p>
<p>As explained earlier, the benefit of anonymous authentication is that all URI patterns can have security applied to them. For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filterSecurityInterceptor"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.access.intercept.FilterSecurityInterceptor"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authenticationManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"authenticationManager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"accessDecisionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"httpRequestAccessDecisionManager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"securityMetadata"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;security:filter-security-metadata-source&gt;</span>
	<span class="hl-tag">&lt;security:intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">'/index.jsp'</span> <span class="hl-attribute">access</span>=<span class="hl-value">'ROLE_ANONYMOUS,ROLE_USER'</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;security:intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">'/hello.htm'</span> <span class="hl-attribute">access</span>=<span class="hl-value">'ROLE_ANONYMOUS,ROLE_USER'</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;security:intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">'/logoff.jsp'</span> <span class="hl-attribute">access</span>=<span class="hl-value">'ROLE_ANONYMOUS,ROLE_USER'</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;security:intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">'/login.jsp'</span> <span class="hl-attribute">access</span>=<span class="hl-value">'ROLE_ANONYMOUS,ROLE_USER'</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;security:intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">'/**'</span> <span class="hl-attribute">access</span>=<span class="hl-value">'ROLE_USER'</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/security:filter-security-metadata-source&gt;</span>" +
<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="anonymous-auth-trust-resolver" href="index.html#anonymous-auth-trust-resolver"></a>23.3&nbsp;AuthenticationTrustResolver</h2></div></div></div>
<p>Rounding out the anonymous authentication discussion is the <code class="literal">AuthenticationTrustResolver</code> interface, with its corresponding <code class="literal">AuthenticationTrustResolverImpl</code> implementation. This interface provides an <code class="literal">isAnonymous(Authentication)</code> method, which allows interested classes to take into account this special type of authentication status. The <code class="literal">ExceptionTranslationFilter</code> uses this interface in processing <code class="literal">AccessDeniedException</code> s. If an <code class="literal">AccessDeniedException</code> is thrown, and the authentication is of an anonymous type, instead of throwing a 403 (forbidden) response, the filter will instead commence the <code class="literal">AuthenticationEntryPoint</code> so the principal can authenticate properly. This is a necessary distinction, otherwise principals would always be deemed "authenticated" and never be given an opportunity to login via form, basic, digest or some other normal authentication mechanism.</p>
<p>You will often see the <code class="literal">ROLE_ANONYMOUS</code> attribute in the above interceptor configuration replaced with <code class="literal">IS_AUTHENTICATED_ANONYMOUSLY</code>, which is effectively the same thing when defining access controls. This is an example of the use of the <code class="literal">AuthenticatedVoter</code> which we will see in the <a class="link" href="index.html#authz-authenticated-voter" title="AuthenticatedVoter">authorization chapter</a>. It uses an <code class="literal">AuthenticationTrustResolver</code> to process this particular configuration attribute and grant access to anonymous users. The <code class="literal">AuthenticatedVoter</code> approach is more powerful, since it allows you to differentiate between anonymous, remember-me and fully-authenticated users. If you don&#8217;t need this functionality though, then you can stick with <code class="literal">ROLE_ANONYMOUS</code>, which will be processed by Spring Security&#8217;s standard <code class="literal">RoleVoter</code>.</p>
</div>
<div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.d5e4279" class="footnote"><p><a href="index.html#d5e4279" class="simpara"><sup class="simpara">[18] </sup></a>The use of the <code class="literal">key</code> property should not be regarded as providing any real security here. It is merely a book-keeping exercise. If you are sharing a <code class="literal">ProviderManager</code> which contains an <code class="literal">AnonymousAuthenticationProvider</code> in a scenario where it is possible for an authenticating client to construct the <code class="literal">Authentication</code> object (such as with RMI invocations), then a malicious client could submit an <code class="literal">AnonymousAuthenticationToken</code> which it had created itself (with chosen username and authority list). If the <code class="literal">key</code> is guessable or can be found out, then the token would be accepted by the anonymous provider. This isn&#8217;t a problem with normal usage but if you are using RMI you would be best to use a customized <code class="literal">ProviderManager</code> which omits the anonymous provider rather than sharing the one you use for your HTTP authentication mechanisms.</p></div></div></div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="websocket" href="index.html#websocket"></a>24.&nbsp;WebSocket Security</h2></div></div></div>
<p>Spring Security 4 added support for securing <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/websocket.html" target="_top">Spring&#8217;s WebSocket support</a>.
This section describes how to use Spring Security&#8217;s WebSocket support.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You can find a complete working sample of WebSocket security in samples/javaconfig/chat.</p>
</td></tr></table></div>
<div class="sidebar"><div class="titlepage"><div><div><p class="title"><b>Direct JSR-356 Support</b></p></div></div></div>
<p>Spring Security does not provide direct JSR-356 support because doing so would provide little value.
This is because the format is unknown, so there is <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/websocket.html#websocket-intro-sub-protocol" target="_top">little Spring can do to secure an unknown format</a>.
Additionally, JSR-356 does not provide a way to intercept messages, so security would be rather invasive.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="websocket-configuration" href="index.html#websocket-configuration"></a>24.1&nbsp;WebSocket Configuration</h2></div></div></div>
<p>Spring Security 4.0 has introduced authorization support for WebSockets through the Spring Messaging abstraction.
To configure authorization using Java Configuration, simply extend the <code class="literal">AbstractSecurityWebSocketMessageBrokerConfigurer</code> and configure the <code class="literal">MessageSecurityMetadataSourceRegistry</code>.
For example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSocketSecurityConfig
      <span class="hl-keyword">extends</span> AbstractSecurityWebSocketMessageBrokerConfigurer { <a name="CO13-1" href="index.html#CO13-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span> <a name="CO13-2" href="index.html#CO13-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>

    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configureInbound(MessageSecurityMetadataSourceRegistry messages) {
        messages
                .simpDestMatchers(<span class="hl-string">"/user/*"</span>).authenticated() <a name="CO13-3" href="index.html#CO13-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    }
}</pre>
<p>This will ensure that:</p>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO13-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Any inbound CONNECT message requires a valid CSRF token to enforce <a class="link" href="index.html#websocket-sameorigin" title="24.4&nbsp;Enforcing Same Origin Policy">Same Origin Policy</a></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO13-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The SecurityContextHolder is populated with the user within the simpUser header attribute for any inbound request.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO13-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Our messages require the proper authorization. Specifically, any inbound message that starts with "/user/" will require ROLE_USER. Additional details on authorization can be found in <a class="xref" href="index.html#websocket-authorization" title="24.3&nbsp;WebSocket Authorization">Section&nbsp;24.3, &#8220;WebSocket Authorization&#8221;</a></p>
</td></tr></table></div>
<p>Spring Security also provides <a class="link" href="index.html#nsa-websocket-security" title="43.2&nbsp;WebSocket Security">XML Namespace</a> support for securing WebSockets.
A comparable XML based configuration looks like the following:</p>
<pre class="programlisting"><span class="hl-tag">&lt;websocket-message-broker&gt;</span> <a name="CO14-1" href="index.html#CO14-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span> <a name="CO14-2" href="index.html#CO14-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    <a name="CO14-3" href="index.html#CO14-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    <span class="hl-tag">&lt;intercept-message</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/user/**"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"hasRole('USER')"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/websocket-message-broker&gt;</span></pre>
<p>This will ensure that:</p>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO14-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Any inbound CONNECT message requires a valid CSRF token to enforce <a class="link" href="index.html#websocket-sameorigin" title="24.4&nbsp;Enforcing Same Origin Policy">Same Origin Policy</a></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO14-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The SecurityContextHolder is populated with the user within the simpUser header attribute for any inbound request.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO14-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Our messages require the proper authorization. Specifically, any inbound message that starts with "/user/" will require ROLE_USER. Additional details on authorization can be found in <a class="xref" href="index.html#websocket-authorization" title="24.3&nbsp;WebSocket Authorization">Section&nbsp;24.3, &#8220;WebSocket Authorization&#8221;</a></p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="websocket-authentication" href="index.html#websocket-authentication"></a>24.2&nbsp;WebSocket Authentication</h2></div></div></div>
<p>WebSockets reuse the same authentication information that is found in the HTTP request when the WebSocket connection was made.
This means that the <code class="literal">Principal</code> on the <code class="literal">HttpServletRequest</code> will be handed off to WebSockets.
If you are using Spring Security, the <code class="literal">Principal</code> on the <code class="literal">HttpServletRequest</code> is overridden automatically.</p>
<p>More concretely, to ensure a user has authenticated to your WebSocket application, all that is necessary is to ensure that you setup Spring Security to authenticate your HTTP based web application.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="websocket-authorization" href="index.html#websocket-authorization"></a>24.3&nbsp;WebSocket Authorization</h2></div></div></div>
<p>Spring Security 4.0 has introduced authorization support for WebSockets through the Spring Messaging abstraction.
To configure authorization using Java Configuration, simply extend the <code class="literal">AbstractSecurityWebSocketMessageBrokerConfigurer</code> and configure the <code class="literal">MessageSecurityMetadataSourceRegistry</code>.
For example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSocketSecurityConfig <span class="hl-keyword">extends</span> AbstractSecurityWebSocketMessageBrokerConfigurer {

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configureInbound(MessageSecurityMetadataSourceRegistry messages) {
        messages
                .nullDestMatcher().authenticated() <a name="CO15-1" href="index.html#CO15-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                .simpSubscribeDestMatchers(<span class="hl-string">"/user/queue/errors"</span>).permitAll() <a name="CO15-2" href="index.html#CO15-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                .simpDestMatchers(<span class="hl-string">"/app/**"</span>).hasRole(<span class="hl-string">"USER"</span>) <a name="CO15-3" href="index.html#CO15-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                .simpSubscribeDestMatchers(<span class="hl-string">"/user/**"</span>, <span class="hl-string">"/topic/friends/*"</span>).hasRole(<span class="hl-string">"USER"</span>) <a name="CO15-4" href="index.html#CO15-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                .simpTypeMatchers(MESSAGE, SUBSCRIBE).denyAll() <a name="CO15-5" href="index.html#CO15-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                .anyMessage().denyAll(); <a name="CO15-6" href="index.html#CO15-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>

    }
}</pre>
<p>This will ensure that:</p>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO15-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Any message without a destination (i.e. anything other than Message type of MESSAGE or SUBSCRIBE) will require the user to be authenticated</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO15-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Anyone can subscribe to /user/queue/errors</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO15-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Any message that has a destination starting with "/app/" will be require the user to have the role ROLE_USER</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO15-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Any message that starts with "/user/" or "/topic/friends/" that is of type SUBSCRIBE will require ROLE_USER</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO15-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Any other message of type MESSAGE or SUBSCRIBE is rejected. Due to 6 we do not need this step, but it illustrates how one can match on specific message types.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO15-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Any other Message is rejected. This is a good idea to ensure that you do not miss any messages.</p>
</td></tr></table></div>
<p>Spring Security also provides <a class="link" href="index.html#nsa-websocket-security" title="43.2&nbsp;WebSocket Security">XML Namespace</a> support for securing WebSockets.
A comparable XML based configuration looks like the following:</p>
<pre class="programlisting"><span class="hl-tag">&lt;websocket-message-broker&gt;</span>
    <a name="CO16-1" href="index.html#CO16-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    <span class="hl-tag">&lt;intercept-message</span> <span class="hl-attribute">type</span>=<span class="hl-value">"CONNECT"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"permitAll"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;intercept-message</span> <span class="hl-attribute">type</span>=<span class="hl-value">"UNSUBSCRIBE"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"permitAll"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;intercept-message</span> <span class="hl-attribute">type</span>=<span class="hl-value">"DISCONNECT"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"permitAll"</span><span class="hl-tag"> /&gt;</span>

    <span class="hl-tag">&lt;intercept-message</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/user/queue/errors"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"SUBSCRIBE"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"permitAll"</span><span class="hl-tag"> /&gt;</span> <a name="CO16-2" href="index.html#CO16-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    <span class="hl-tag">&lt;intercept-message</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/app/**"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"hasRole('USER')"</span><span class="hl-tag"> /&gt;</span>      <a name="CO16-3" href="index.html#CO16-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>

    <a name="CO16-4" href="index.html#CO16-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    <span class="hl-tag">&lt;intercept-message</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/user/**"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"hasRole('USER')"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;intercept-message</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/topic/friends/*"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"hasRole('USER')"</span><span class="hl-tag"> /&gt;</span>

    <a name="CO16-5" href="index.html#CO16-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    <span class="hl-tag">&lt;intercept-message</span> <span class="hl-attribute">type</span>=<span class="hl-value">"MESSAGE"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"denyAll"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;intercept-message</span> <span class="hl-attribute">type</span>=<span class="hl-value">"SUBSCRIBE"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"denyAll"</span><span class="hl-tag"> /&gt;</span>

    <span class="hl-tag">&lt;intercept-message</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/**"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"denyAll"</span><span class="hl-tag"> /&gt;</span> <a name="CO16-6" href="index.html#CO16-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
<span class="hl-tag">&lt;/websocket-message-broker&gt;</span></pre>
<p>This will ensure that:</p>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO16-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Any message of type CONNECT, UNSUBSCRIBE, or DISCONNECT will require the user to be authenticated</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO16-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Anyone can subscribe to /user/queue/errors</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO16-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Any message that has a destination starting with "/app/" will be require the user to have the role ROLE_USER</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO16-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Any message that starts with "/user/" or "/topic/friends/" that is of type SUBSCRIBE will require ROLE_USER</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO16-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Any other message of type MESSAGE or SUBSCRIBE is rejected. Due to 6 we do not need this step, but it illustrates how one can match on specific message types.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="index.html#CO16-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Any other message with a destination is rejected. This is a good idea to ensure that you do not miss any messages.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-authorization-notes" href="index.html#websocket-authorization-notes"></a>24.3.1&nbsp;WebSocket Authorization Notes</h3></div></div></div>
<p>In order to properly secure your application it is important to understand Spring&#8217;s WebSocket support.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="websocket-authorization-notes-messagetypes" href="index.html#websocket-authorization-notes-messagetypes"></a>WebSocket Authorization on Message Types</h4></div></div></div>
<p>It is important to understand the distinction between SUBSCRIBE and MESSAGE types of messages and how it works within Spring.</p>
<p>Consider a chat application.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The system can send notifications MESSAGE to all users through a destination of "/topic/system/notifications"
</li><li class="listitem">
Clients can receive notifications by SUBSCRIBE to the "/topic/system/notifications".
</li></ul></div>
<p>While we want clients to be able to SUBSCRIBE to "/topic/system/notifications", we do not want to enable them to send a MESSAGE to that destination.
If we allowed sending a MESSAGE to "/topic/system/notifications", then clients could send a message directly to that endpoint and impersonate the system.</p>
<p>In general, it is common for applications to deny any MESSAGE sent to a message that starts with the <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/websocket.html#websocket-stomp" target="_top">broker prefix</a> (i.e. "/topic/" or "/queue/").</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="websocket-authorization-notes-destinations" href="index.html#websocket-authorization-notes-destinations"></a>WebSocket Authorization on Destinations</h4></div></div></div>
<p>It is also is important to understand how destinations are transformed.</p>
<p>Consider a chat application.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Users can send messages to a specific user by sending a message to the destination of "/app/chat".
</li><li class="listitem">
The application sees the message, ensures that the "from" attribute is specified as the current user (we cannot trust the client).
</li><li class="listitem">
The application then sends the message to the recipient using <code class="literal">SimpMessageSendingOperations.convertAndSendToUser("toUser", "/queue/messages", message)</code>.
</li><li class="listitem">
The message gets turned into the destination of "/queue/user/messages-&lt;sessionid&gt;"
</li></ul></div>
<p>With the application above, we want to allow our client to listen to "/user/queue" which is transformed into "/queue/user/messages-&lt;sessionid&gt;".
However, we do not want the client to be able to listen to "/queue/*" because that would allow the client to see messages for every user.</p>
<p>In general, it is common for applications to deny any SUBSCRIBE sent to a message that starts with the <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/websocket.html#websocket-stomp" target="_top">broker prefix</a> (i.e. "/topic/" or "/queue/").
Of course we may provide exceptions to account for things like</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-authorization-notes-outbound" href="index.html#websocket-authorization-notes-outbound"></a>24.3.2&nbsp;Outbound Messages</h3></div></div></div>
<p>Spring contains a section titled <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/websocket.html#websocket-stomp-message-flow" target="_top">Flow of Messages</a> that describes how messages flow through the system.
It is important to note that Spring Security only secures the <code class="literal">clientInboundChannel</code>.
Spring Security does not attempt to secure the <code class="literal">clientOutboundChannel</code>.</p>
<p>The most important reason for this is performance.
For every message that goes in, there are typically many more that go out.
Instead of securing the outbound messages, we encourage securing the subscription to the endpoints.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="websocket-sameorigin" href="index.html#websocket-sameorigin"></a>24.4&nbsp;Enforcing Same Origin Policy</h2></div></div></div>
<p>It is important to emphasize that the browser does not enforce the <a class="ulink" href="https://en.wikipedia.org/wiki/Same-origin_policy" target="_top">Same Origin Policy</a> for WebSocket connections.
This is an extremely important consideration.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-sameorigin-why" href="index.html#websocket-sameorigin-why"></a>24.4.1&nbsp;Why Same Origin?</h3></div></div></div>
<p>Consider the following scenario.
A user visits bank.com and authenticates to their account.
The same user opens another tab in their browser and visits evil.com.
The Same Origin Policy ensures that evil.com cannot read or write data to bank.com.</p>
<p>With WebSockets the Same Origin Policy does not apply.
In fact, unless bank.com explicitly forbids it, evil.com can read and write data on behalf of the user.
This means that anything the user can do over the webSocket (i.e. transfer money), evil.com can do on that users behalf.</p>
<p>Since SockJS tries to emulate WebSockets it also bypasses the Same Origin Policy.
This means developers need to explicitly protect their applications from external domains when using SockJS.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-sameorigin-spring" href="index.html#websocket-sameorigin-spring"></a>24.4.2&nbsp;Spring WebSocket Allowed Origin</h3></div></div></div>
<p>Fortunately, since Spring 4.1.5 Spring&#8217;s WebSocket and SockJS support restricts access to the <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/websocket.html#websocket-server-allowed-origins" target="_top">current domain</a>.
Spring Security adds an additional layer of protection to provide <a class="ulink" href="https://en.wikipedia.org/wiki/Defense_in_depth_%28computing%29" target="_top">defence in depth</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-sameorigin-csrf" href="index.html#websocket-sameorigin-csrf"></a>24.4.3&nbsp;Adding CSRF to Stomp Headers</h3></div></div></div>
<p>By default Spring Security requires the <a class="link" href="index.html#csrf" title="19.&nbsp;Cross Site Request Forgery (CSRF)">CSRF token</a> in any CONNECT message type.
This ensures that only a site that has access to the CSRF token can connect.
Since only the <span class="strong"><strong>Same Origin</strong></span> can access the CSRF token, external domains are not allowed to make a connection.</p>
<p>Typically we need to include the CSRF token in an HTTP header or an HTTP parameter.
However, SockJS does not allow for these options.
Instead, we must include the token in the Stomp headers</p>
<p>Applications can <a class="link" href="index.html#csrf-include-csrf-token" title="19.4.3&nbsp;Include the CSRF Token">obtain a CSRF token</a> by accessing the request attribute named _csrf.
For example, the following will allow accessing the <code class="literal">CsrfToken</code> in a JSP:</p>
<pre class="programlisting"><span class="hl-keyword">var</span> headerName = <span class="hl-string">"${_csrf.headerName}"</span>;
<span class="hl-keyword">var</span> token = <span class="hl-string">"${_csrf.token}"</span>;</pre>
<p>If you are using static HTML, you can expose the <code class="literal">CsrfToken</code> on a REST endpoint.
For example, the following would expose the <code class="literal">CsrfToken</code> on the URL /csrf</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RestController</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CsrfController {

    <em><span class="hl-annotation" style="color: gray">@RequestMapping("/csrf")</span></em>
    <span class="hl-keyword">public</span> CsrfToken csrf(CsrfToken token) {
        <span class="hl-keyword">return</span> token;
    }
}</pre>
<p>The JavaScript can make a REST call to the endpoint and use the response to populate the headerName and the token.</p>
<p>We can now include the token in our Stomp client.
For example:</p>
<pre class="programlisting">...
<span class="hl-keyword">var</span> headers = {};
headers[headerName] = token;
stompClient.connect(headers, <span class="hl-keyword">function</span>(frame) {
  ...

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-sameorigin-disable" href="index.html#websocket-sameorigin-disable"></a>24.4.4&nbsp;Disable CSRF within WebSockets</h3></div></div></div>
<p>If you want to allow other domains to access your site, you can disable Spring Security&#8217;s protection.
For example, in Java Configuration you can use the following:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSocketSecurityConfig <span class="hl-keyword">extends</span> AbstractSecurityWebSocketMessageBrokerConfigurer {

    ...

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">boolean</span> sameOriginDisabled() {
        <span class="hl-keyword">return</span> true;
    }
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="websocket-sockjs" href="index.html#websocket-sockjs"></a>24.5&nbsp;Working with SockJS</h2></div></div></div>
<p><a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/websocket.html#websocket-fallback" target="_top">SockJS</a> provides fallback transports to support older browsers.
When using the fallback options we need to relax a few security constraints to allow SockJS to work with Spring Security.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-sockjs-sameorigin" href="index.html#websocket-sockjs-sameorigin"></a>24.5.1&nbsp;SockJS &amp; frame-options</h3></div></div></div>
<p>SockJS may use an <a class="ulink" href="https://github.com/sockjs/sockjs-client/tree/v0.3.4" target="_top">transport that leverages an iframe</a>.
By default Spring Security will <a class="link" href="index.html#headers-frame-options" title="21.1.5&nbsp;X-Frame-Options">deny</a> the site from being framed to prevent Clickjacking attacks.
To allow SockJS frame based transports to work, we need to configure Spring Security to allow the same origin to frame the content.</p>
<p>You can customize X-Frame-Options with the <a class="link" href="index.html#nsa-frame-options" title="43.1.13&nbsp;<frame-options&gt;">frame-options</a> element.
For example, the following will instruct Spring Security to use "X-Frame-Options: SAMEORIGIN" which allows iframes within the same domain:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
    <span class="hl-comment">&lt;!-- ... --&gt;</span>

    <span class="hl-tag">&lt;headers&gt;</span>
        <span class="hl-tag">&lt;frame-options</span>
          <span class="hl-attribute">policy</span>=<span class="hl-value">"SAMEORIGIN"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/headers&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>Similarly, you can customize frame options to use the same origin within Java Configuration using the following:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig <span class="hl-keyword">extends</span>
   WebSecurityConfigurerAdapter {

  <em><span class="hl-annotation" style="color: gray">@Override</span></em>
  <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
    http
      <span class="hl-comment">// ...</span>
      .headers()
        .frameOptions()
            .sameOrigin();
  }
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-sockjs-csrf" href="index.html#websocket-sockjs-csrf"></a>24.5.2&nbsp;SockJS &amp; Relaxing CSRF</h3></div></div></div>
<p>SockJS uses a POST on the CONNECT messages for any HTTP based transport.
Typically we need to include the CSRF token in an HTTP header or an HTTP parameter.
However, SockJS does not allow for these options.
Instead, we must include the token in the Stomp headers as described in <a class="xref" href="index.html#websocket-sameorigin-csrf" title="24.4.3&nbsp;Adding CSRF to Stomp Headers">Section&nbsp;24.4.3, &#8220;Adding CSRF to Stomp Headers&#8221;</a>.</p>
<p>It also means we need to relax our CSRF protection with the web layer.
Specifically, we want to disable CSRF protection for our connect URLs.
We do NOT want to disable CSRF protection for every URL.
Otherwise our site will be vulnerable to CSRF attacks.</p>
<p>We can easily achieve this by providing a CSRF RequestMatcher.
Our Java Configuration makes this extremely easy.
For example, if our stomp endpoint is "/chat" we can disable CSRF protection for only URLs that start with "/chat/" using the following configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurityConfig
    <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {

        http
            .csrf()
                <span class="hl-comment">// ignore our stomp endpoints since they are protected using Stomp headers</span>
                .ignoringAntMatchers(<span class="hl-string">"/chat/**"</span>)
                .and()
            .headers()
                <span class="hl-comment">// allow same origin to frame our site to support iframe SockJS</span>
                .frameOptions().sameOrigin()
                .and()
            .authorizeRequests()

            ...</pre>
<p>If we are using XML based configuration, we can use the <a class="link" href="index.html#nsa-csrf-request-matcher-ref"><span class="__cf_email__" data-cfemail="a2c1d1d0c4e2d0c7d3d7c7d1d68fcfc3d6c1cac7d08fd0c7c4">[email&#160;protected]</span></a>.
For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http</span> <span class="hl-attribute">...&gt;</span>
    <span class="hl-attribute">&lt;csrf</span> <span class="hl-attribute">request-matcher-ref</span>=<span class="hl-value">"csrfMatcher"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;headers&gt;</span>
        <span class="hl-tag">&lt;frame-options</span> <span class="hl-attribute">policy</span>=<span class="hl-value">"SAMEORIGIN"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/headers&gt;</span>

    ...
<span class="hl-tag">&lt;/http&gt;</span>

<span class="hl-tag">&lt;b:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"csrfMatcher"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"AndRequestMatcher"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;b:constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"#{T(org.springframework.security.web.csrf.CsrfFilter).DEFAULT_CSRF_MATCHER}"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;b:constructor-arg&gt;</span>
        <span class="hl-tag">&lt;b:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.util.matcher.NegatedRequestMatcher"</span><span class="hl-tag">&gt;</span>
          <span class="hl-tag">&lt;b:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.util.matcher.AntPathRequestMatcher"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;b:constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/chat/**"</span><span class="hl-tag">/&gt;</span>
          <span class="hl-tag">&lt;/b:bean&gt;</span>
        <span class="hl-tag">&lt;/b:bean&gt;</span>
    <span class="hl-tag">&lt;/b:constructor-arg&gt;</span>
<span class="hl-tag">&lt;/b:bean&gt;</span></pre>
</div>
</div>
</div>
</div>
<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="authorization" href="index.html#authorization"></a>Part&nbsp;V.&nbsp;Authorization</h1></div></div></div>
<div class="partintro"><div></div>
<p>The advanced authorization capabilities within Spring Security represent one of the most compelling reasons for its popularity. Irrespective of how you choose to authenticate - whether using a Spring Security-provided mechanism and provider, or integrating with a container or other non-Spring Security authentication authority - you will find the authorization services can be used within your application in a consistent and simple way.</p>
<p>In this part we&#8217;ll explore the different <code class="literal">AbstractSecurityInterceptor</code> implementations, which were introduced in Part I. We then move on to explore how to fine-tune authorization through use of domain access control lists.</p>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="authz-arch" href="index.html#authz-arch"></a>25.&nbsp;Authorization Architecture</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="authz-authorities" href="index.html#authz-authorities"></a>25.1&nbsp;Authorities</h2></div></div></div>
<p>As we saw in the <a class="link" href="index.html#tech-granted-authority" title="9.2.3&nbsp;GrantedAuthority">technical overview</a>, all <code class="literal">Authentication</code> implementations store a list of <code class="literal">GrantedAuthority</code> objects. These represent the authorities that have been granted to the principal. the <code class="literal">GrantedAuthority</code> objects are inserted into the <code class="literal">Authentication</code> object by the <code class="literal">AuthenticationManager</code> and are later read by <code class="literal">AccessDecisionManager</code> s when making authorization decisions.</p>
<p><code class="literal">GrantedAuthority</code> is an interface with only one method:</p>
<pre class="programlisting">String getAuthority();</pre>
<p>This method allows
<code class="literal">AccessDecisionManager</code> s to obtain a precise <code class="literal">String</code> representation of the <code class="literal">GrantedAuthority</code>. By returning a representation as a <code class="literal">String</code>, a <code class="literal">GrantedAuthority</code> can be easily "read" by most <code class="literal">AccessDecisionManager</code> s. If a <code class="literal">GrantedAuthority</code> cannot be precisely represented as a <code class="literal">String</code>, the <code class="literal">GrantedAuthority</code> is considered "complex" and <code class="literal">getAuthority()</code> must return <code class="literal">null</code>.</p>
<p>An example of a "complex" <code class="literal">GrantedAuthority</code> would be an implementation that stores a list of operations and authority thresholds that apply to different customer account numbers. Representing this complex <code class="literal">GrantedAuthority</code> as a <code class="literal">String</code> would be quite difficult, and as a result the <code class="literal">getAuthority()</code> method should return <code class="literal">null</code>. This will indicate to any <code class="literal">AccessDecisionManager</code> that it will need to specifically support the <code class="literal">GrantedAuthority</code> implementation in order to understand its contents.</p>
<p>Spring Security includes one concrete <code class="literal">GrantedAuthority</code> implementation, <code class="literal">SimpleGrantedAuthority</code>. This allows any user-specified <code class="literal">String</code> to be converted into a <code class="literal">GrantedAuthority</code>. All <code class="literal">AuthenticationProvider</code> s included with the security architecture use <code class="literal">SimpleGrantedAuthority</code> to populate the <code class="literal">Authentication</code> object.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="authz-pre-invocation" href="index.html#authz-pre-invocation"></a>25.2&nbsp;Pre-Invocation Handling</h2></div></div></div>
<p>As we&#8217;ve also seen in the <a class="link" href="index.html#secure-objects" title="9.5.2&nbsp;Secure Objects and the AbstractSecurityInterceptor">Technical Overview</a> chapter, Spring Security provides interceptors which control access to secure objects such as method invocations or web requests. A pre-invocation decision on whether the invocation is allowed to proceed is made by the <code class="literal">AccessDecisionManager</code>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="authz-access-decision-manager" href="index.html#authz-access-decision-manager"></a>25.2.1&nbsp;The AccessDecisionManager</h3></div></div></div>
<p>The <code class="literal">AccessDecisionManager</code> is called by the <code class="literal">AbstractSecurityInterceptor</code> and is responsible for making final access control decisions. the <code class="literal">AccessDecisionManager</code> interface contains three methods:</p>
<pre class="programlisting"><span class="hl-keyword">void</span> decide(Authentication authentication, Object secureObject,
	Collection&lt;ConfigAttribute&gt; attrs) <span class="hl-keyword">throws</span> AccessDeniedException;

<span class="hl-keyword">boolean</span> supports(ConfigAttribute attribute);

<span class="hl-keyword">boolean</span> supports(Class clazz);</pre>
<p>The <code class="literal">AccessDecisionManager</code>'s <code class="literal">decide</code> method is passed all the relevant information it needs in order to make an authorization decision. In particular, passing the secure <code class="literal">Object</code> enables those arguments contained in the actual secure object invocation to be inspected. For example, let&#8217;s assume the secure object was a <code class="literal">MethodInvocation</code>. It would be easy to query the <code class="literal">MethodInvocation</code> for any <code class="literal">Customer</code> argument, and then implement some sort of security logic in the <code class="literal">AccessDecisionManager</code> to ensure the principal is permitted to operate on that customer. Implementations are expected to throw an <code class="literal">AccessDeniedException</code> if access is denied.</p>
<p>The <code class="literal">supports(ConfigAttribute)</code> method is called by the <code class="literal">AbstractSecurityInterceptor</code> at startup time to determine if the <code class="literal">AccessDecisionManager</code> can process the passed <code class="literal">ConfigAttribute</code>. The <code class="literal">supports(Class)</code> method is called by a security interceptor implementation to ensure the configured <code class="literal">AccessDecisionManager</code> supports the type of secure object that the security interceptor will present.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="authz-voting-based" href="index.html#authz-voting-based"></a>25.2.2&nbsp;Voting-Based AccessDecisionManager Implementations</h3></div></div></div>
<p>Whilst users can implement their own <code class="literal">AccessDecisionManager</code> to control all aspects of authorization, Spring Security includes several <code class="literal">AccessDecisionManager</code> implementations that are based on voting. <a class="xref" href="index.html#authz-access-voting" title="Figure&nbsp;25.1.&nbsp;Voting Decision Manager">Figure&nbsp;25.1, &#8220;Voting Decision Manager&#8221;</a> illustrates the relevant classes.</p>
<div class="figure"><a name="authz-access-voting" href="index.html#authz-access-voting"></a><p class="title"><b>Figure&nbsp;25.1.&nbsp;Voting Decision Manager</b></p><div class="figure-contents">
<div class="mediaobject"><img src="images/access-decision-voting.png" alt="access decision voting"></div>
</div></div><br class="figure-break">
<p>Using this approach, a series of <code class="literal">AccessDecisionVoter</code> implementations are polled on an authorization decision. The <code class="literal">AccessDecisionManager</code> then decides whether or not to throw an <code class="literal">AccessDeniedException</code> based on its assessment of the votes.</p>
<p>The <code class="literal">AccessDecisionVoter</code> interface has three methods:</p>
<pre class="programlisting"><span class="hl-keyword">int</span> vote(Authentication authentication, Object object, Collection&lt;ConfigAttribute&gt; attrs);

<span class="hl-keyword">boolean</span> supports(ConfigAttribute attribute);

<span class="hl-keyword">boolean</span> supports(Class clazz);</pre>
<p>Concrete implementations return an <code class="literal">int</code>, with possible values being reflected in the <code class="literal">AccessDecisionVoter</code> static fields <code class="literal">ACCESS_ABSTAIN</code>, <code class="literal">ACCESS_DENIED</code> and <code class="literal">ACCESS_GRANTED</code>. A voting implementation will return <code class="literal">ACCESS_ABSTAIN</code> if it has no opinion on an authorization decision. If it does have an opinion, it must return either <code class="literal">ACCESS_DENIED</code> or <code class="literal">ACCESS_GRANTED</code>.</p>
<p>There are three concrete <code class="literal">AccessDecisionManager</code> s provided with Spring Security that tally the votes. The <code class="literal">ConsensusBased</code> implementation will grant or deny access based on the consensus of non-abstain votes. Properties are provided to control behavior in the event of an equality of votes or if all votes are abstain. The <code class="literal">AffirmativeBased</code> implementation will grant access if one or more <code class="literal">ACCESS_GRANTED</code> votes were received (i.e. a deny vote will be ignored, provided there was at least one grant vote). Like the <code class="literal">ConsensusBased</code> implementation, there is a parameter that controls the behavior if all voters abstain. The <code class="literal">UnanimousBased</code> provider expects unanimous <code class="literal">ACCESS_GRANTED</code> votes in order to grant access, ignoring abstains. It will deny access if there is any <code class="literal">ACCESS_DENIED</code> vote. Like the other implementations, there is a parameter that controls the behaviour if all voters abstain.</p>
<p>It is possible to implement a custom <code class="literal">AccessDecisionManager</code> that tallies votes differently. For example, votes from a particular <code class="literal">AccessDecisionVoter</code> might receive additional weighting, whilst a deny vote from a particular voter may have a veto effect.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="authz-role-voter" href="index.html#authz-role-voter"></a>RoleVoter</h4></div></div></div>
<p>The most commonly used <code class="literal">AccessDecisionVoter</code> provided with Spring Security is the simple <code class="literal">RoleVoter</code>, which treats configuration attributes as simple role names and votes to grant access if the user has been assigned that role.</p>
<p>It will vote if any <code class="literal">ConfigAttribute</code> begins with the prefix <code class="literal">ROLE_</code>. It will vote to grant access if there is a <code class="literal">GrantedAuthority</code> which returns a <code class="literal">String</code> representation (via the <code class="literal">getAuthority()</code> method) exactly equal to one or more <code class="literal">ConfigAttributes</code> starting with the prefix <code class="literal">ROLE_</code>. If there is no exact match of any <code class="literal">ConfigAttribute</code> starting with <code class="literal">ROLE_</code>, the <code class="literal">RoleVoter</code> will vote to deny access. If no <code class="literal">ConfigAttribute</code> begins with <code class="literal">ROLE_</code>, the voter will abstain.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="authz-authenticated-voter" href="index.html#authz-authenticated-voter"></a>AuthenticatedVoter</h4></div></div></div>
<p>Another voter which we&#8217;ve implicitly seen is the <code class="literal">AuthenticatedVoter</code>, which can be used to differentiate between anonymous, fully-authenticated and remember-me authenticated users. Many sites allow certain limited access under remember-me authentication, but require a user to confirm their identity by logging in for full access.</p>
<p>When we&#8217;ve used the attribute <code class="literal">IS_AUTHENTICATED_ANONYMOUSLY</code> to grant anonymous access, this attribute was being processed by the <code class="literal">AuthenticatedVoter</code>. See the Javadoc for this class for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="authz-custom-voter" href="index.html#authz-custom-voter"></a>Custom Voters</h4></div></div></div>
<p>Obviously, you can also implement a custom <code class="literal">AccessDecisionVoter</code> and you can put just about any access-control logic you want in it. It might be specific to your application (business-logic related) or it might implement some security administration logic. For example, you&#8217;ll find a <a class="ulink" href="https://spring.io/blog/2009/01/03/spring-security-customization-part-2-adjusting-secured-session-in-real-time" target="_top">blog article</a> on the Spring web site which describes how to use a voter to deny access in real-time to users whose accounts have been suspended.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="authz-after-invocation-handling" href="index.html#authz-after-invocation-handling"></a>25.3&nbsp;After Invocation Handling</h2></div></div></div>
<p>Whilst the <code class="literal">AccessDecisionManager</code> is called by the <code class="literal">AbstractSecurityInterceptor</code> before proceeding with the secure object invocation, some applications need a way of modifying the object actually returned by the secure object invocation. Whilst you could easily implement your own AOP concern to achieve this, Spring Security provides a convenient hook that has several concrete implementations that integrate with its ACL capabilities.</p>
<p><a class="xref" href="index.html#authz-after-invocation" title="Figure&nbsp;25.2.&nbsp;After Invocation Implementation">Figure&nbsp;25.2, &#8220;After Invocation Implementation&#8221;</a> illustrates Spring Security&#8217;s <code class="literal">AfterInvocationManager</code> and its concrete implementations.</p>
<div class="figure"><a name="authz-after-invocation" href="index.html#authz-after-invocation"></a><p class="title"><b>Figure&nbsp;25.2.&nbsp;After Invocation Implementation</b></p><div class="figure-contents">
<div class="mediaobject"><img src="images/after-invocation.png" alt="after invocation"></div>
</div></div><br class="figure-break">
<p>Like many other parts of Spring Security, <code class="literal">AfterInvocationManager</code> has a single concrete implementation, <code class="literal">AfterInvocationProviderManager</code>, which polls a list of <code class="literal">AfterInvocationProvider</code> s. Each <code class="literal">AfterInvocationProvider</code> is allowed to modify the return object or throw an <code class="literal">AccessDeniedException</code>. Indeed multiple providers can modify the object, as the result of the previous provider is passed to the next in the list.</p>
<p>Please be aware that if you&#8217;re using <code class="literal">AfterInvocationManager</code>, you will still need configuration attributes that allow the <code class="literal">MethodSecurityInterceptor</code>'s <code class="literal">AccessDecisionManager</code> to allow an operation. If you&#8217;re using the typical Spring Security included <code class="literal">AccessDecisionManager</code> implementations, having no configuration attributes defined for a particular secure method invocation will cause each <code class="literal">AccessDecisionVoter</code> to abstain from voting. In turn, if the <code class="literal">AccessDecisionManager</code> property &#8220;allowIfAllAbstainDecisions&#8221; is <code class="literal">false</code>, an <code class="literal">AccessDeniedException</code> will be thrown. You may avoid this potential issue by either (i) setting &#8220;allowIfAllAbstainDecisions&#8221; to <code class="literal">true</code> (although this is generally not recommended) or (ii) simply ensure that there is at least one configuration attribute that an <code class="literal">AccessDecisionVoter</code> will vote to grant access for. This latter (recommended) approach is usually achieved through a <code class="literal">ROLE_USER</code> or <code class="literal">ROLE_AUTHENTICATED</code> configuration attribute.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="authz-hierarchical-roles" href="index.html#authz-hierarchical-roles"></a>25.4&nbsp;Hierarchical Roles</h2></div></div></div>
<p>It is a common requirement that a particular role in an application should automatically "include" other roles. For example, in an application which has the concept of an "admin" and a "user" role, you may want an admin to be able to do everything a normal user can. To achieve this, you can either make sure that all admin users are also assigned the "user" role. Alternatively, you can modify every access constraint which requires the "user" role to also include the "admin" role. This can get quite complicated if you have a lot of different roles in your application.</p>
<p>The use of a role-hierarchy allows you to configure which roles (or authorities) should include others. An extended version of Spring Security&#8217;s <a class="link" href="index.html#authz-role-voter" title="RoleVoter">RoleVoter</a>, <code class="literal">RoleHierarchyVoter</code>, is configured with a <code class="literal">RoleHierarchy</code>, from which it obtains all the "reachable authorities" which the user is assigned. A typical configuration might look like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"roleVoter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.access.vote.RoleHierarchyVoter"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"roleHierarchy"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"roleHierarchy"</span>
		<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.access.hierarchicalroles.RoleHierarchyImpl"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"hierarchy"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;value&gt;</span>
			ROLE_ADMIN &gt; ROLE_STAFF
			ROLE_STAFF &gt; ROLE_USER
			ROLE_USER &gt; ROLE_GUEST
		<span class="hl-tag">&lt;/value&gt;</span>
	<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>Here we have four roles in a hierarchy <code class="literal">ROLE_ADMIN &#8658; ROLE_STAFF &#8658; ROLE_USER &#8658; ROLE_GUEST</code>. A user who is authenticated with <code class="literal">ROLE_ADMIN</code>, will behave as if they have all four roles when security constraints are evaluated against an <code class="literal">AccessDecisionManager</code> cconfigured with the above <code class="literal">RoleHierarchyVoter</code>. The <code class="literal">&gt;</code> symbol can be thought of as meaning "includes".</p>
<p>Role hierarchies offer a convenient means of simplifying the access-control configuration data for your application and/or reducing the number of authorities which you need to assign to a user. For more complex requirements you may wish to define a logical mapping between the specific access-rights your application requires and the roles that are assigned to users, translating between the two when loading the user information.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="secure-object-impls" href="index.html#secure-object-impls"></a>26.&nbsp;Secure Object Implementations</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-alliance" href="index.html#aop-alliance"></a>26.1&nbsp;AOP Alliance (MethodInvocation) Security Interceptor</h2></div></div></div>
<p>Prior to Spring Security 2.0, securing <code class="literal">MethodInvocation</code> s needed quite a lot of boiler plate configuration. Now the recommended approach for method security is to use <a class="link" href="index.html#ns-method-security" title="6.4&nbsp;Method Security">namespace configuration</a>. This way the method security infrastructure beans are configured automatically for you so you don&#8217;t really need to know about the implementation classes. We&#8217;ll just provide a quick overview of the classes that are involved here.</p>
<p>Method security in enforced using a <code class="literal">MethodSecurityInterceptor</code>, which secures <code class="literal">MethodInvocation</code> s. Depending on the configuration approach, an interceptor may be specific to a single bean or shared between multiple beans. The interceptor uses a <code class="literal">MethodSecurityMetadataSource</code> instance to obtain the configuration attributes that apply to a particular method invocation. <code class="literal">MapBasedMethodSecurityMetadataSource</code> is used to store configuration attributes keyed by method names (which can be wildcarded) and will be used internally when the attributes are defined in the application context using the <code class="literal">&lt;intercept-methods&gt;</code> or <code class="literal">&lt;protect-point&gt;</code> elements. Other implementations will be used to handle annotation-based configuration.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="explicit-methodsecurityinterceptor-configuration" href="index.html#explicit-methodsecurityinterceptor-configuration"></a>26.1.1&nbsp;Explicit MethodSecurityInterceptor Configuration</h3></div></div></div>
<p>You can of course configure a <code class="literal">MethodSecurityIterceptor</code> directly in your application context for use with one of Spring AOP&#8217;s proxying mechanisms:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"bankManagerSecurity"</span> <span class="hl-attribute">class</span>=
	<span class="hl-value">"org.springframework.security.access.intercept.aopalliance.MethodSecurityInterceptor"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authenticationManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"authenticationManager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"accessDecisionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"accessDecisionManager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"afterInvocationManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"afterInvocationManager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"securityMetadataSource"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;sec:method-security-metadata-source&gt;</span>
	<span class="hl-tag">&lt;sec:protect</span> <span class="hl-attribute">method</span>=<span class="hl-value">"com.mycompany.BankManager.delete*"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_SUPERVISOR"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;sec:protect</span> <span class="hl-attribute">method</span>=<span class="hl-value">"com.mycompany.BankManager.getBalance"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_TELLER,ROLE_SUPERVISOR"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/sec:method-security-metadata-source&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aspectj" href="index.html#aspectj"></a>26.2&nbsp;AspectJ (JoinPoint) Security Interceptor</h2></div></div></div>
<p>The AspectJ security interceptor is very similar to the AOP Alliance security interceptor discussed in the previous section. Indeed we will only discuss the differences in this section.</p>
<p>The AspectJ interceptor is named <code class="literal">AspectJSecurityInterceptor</code>. Unlike the AOP Alliance security interceptor, which relies on the Spring application context to weave in the security interceptor via proxying, the <code class="literal">AspectJSecurityInterceptor</code> is weaved in via the AspectJ compiler. It would not be uncommon to use both types of security interceptors in the same application, with <code class="literal">AspectJSecurityInterceptor</code> being used for domain object instance security and the AOP Alliance <code class="literal">MethodSecurityInterceptor</code> being used for services layer security.</p>
<p>Let&#8217;s first consider how the <code class="literal">AspectJSecurityInterceptor</code> is configured in the Spring application context:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"bankManagerSecurity"</span> <span class="hl-attribute">class</span>=
	<span class="hl-value">"org.springframework.security.access.intercept.aspectj.AspectJMethodSecurityInterceptor"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authenticationManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"authenticationManager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"accessDecisionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"accessDecisionManager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"afterInvocationManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"afterInvocationManager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"securityMetadataSource"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;sec:method-security-metadata-source&gt;</span>
	<span class="hl-tag">&lt;sec:protect</span> <span class="hl-attribute">method</span>=<span class="hl-value">"com.mycompany.BankManager.delete*"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_SUPERVISOR"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;sec:protect</span> <span class="hl-attribute">method</span>=<span class="hl-value">"com.mycompany.BankManager.getBalance"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_TELLER,ROLE_SUPERVISOR"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/sec:method-security-metadata-source&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>As you can see, aside from the class name, the <code class="literal">AspectJSecurityInterceptor</code> is exactly the same as the AOP Alliance security interceptor. Indeed the two interceptors can share the same <code class="literal">securityMetadataSource</code>, as the <code class="literal">SecurityMetadataSource</code> works with <code class="literal">java.lang.reflect.Method</code> s rather than an AOP library-specific class. Of course, your access decisions have access to the relevant AOP library-specific invocation (ie <code class="literal">MethodInvocation</code> or <code class="literal">JoinPoint</code>) and as such can consider a range of addition criteria when making access decisions (such as method arguments).</p>
<p>Next you&#8217;ll need to define an AspectJ <code class="literal">aspect</code>. For example:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.springframework.security.samples.aspectj;

<span class="hl-keyword">import</span> org.springframework.security.access.intercept.aspectj.AspectJSecurityInterceptor;
<span class="hl-keyword">import</span> org.springframework.security.access.intercept.aspectj.AspectJCallback;
<span class="hl-keyword">import</span> org.springframework.beans.factory.InitializingBean;

<span class="hl-keyword">public</span> aspect DomainObjectInstanceSecurityAspect <span class="hl-keyword">implements</span> InitializingBean {

	<span class="hl-keyword">private</span> AspectJSecurityInterceptor securityInterceptor;

	pointcut domainObjectInstanceExecution(): target(PersistableEntity)
		&amp;&amp; execution(<span class="hl-keyword">public</span> * *(..)) &amp;&amp; !within(DomainObjectInstanceSecurityAspect);

	Object around(): domainObjectInstanceExecution() {
		<span class="hl-keyword">if</span> (<span class="hl-keyword">this</span>.securityInterceptor == null) {
			<span class="hl-keyword">return</span> proceed();
		}

		AspectJCallback callback = <span class="hl-keyword">new</span> AspectJCallback() {
			<span class="hl-keyword">public</span> Object proceedWithObject() {
				<span class="hl-keyword">return</span> proceed();
			}
		};

		<span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.securityInterceptor.invoke(thisJoinPoint, callback);
	}

	<span class="hl-keyword">public</span> AspectJSecurityInterceptor getSecurityInterceptor() {
		<span class="hl-keyword">return</span> securityInterceptor;
	}

	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setSecurityInterceptor(AspectJSecurityInterceptor securityInterceptor) {
		<span class="hl-keyword">this</span>.securityInterceptor = securityInterceptor;
	}

	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterPropertiesSet() <span class="hl-keyword">throws</span> Exception {
		<span class="hl-keyword">if</span> (<span class="hl-keyword">this</span>.securityInterceptor == null)
			<span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> IllegalArgumentException(<span class="hl-string">"securityInterceptor required"</span>);
		}
	}
}</pre>
<p>In the above example, the security interceptor will be applied to every instance of <code class="literal">PersistableEntity</code>, which is an abstract class not shown (you can use any other class or <code class="literal">pointcut</code> expression you like). For those curious, <code class="literal">AspectJCallback</code> is needed because the <code class="literal">proceed();</code> statement has special meaning only within an <code class="literal">around()</code> body. The <code class="literal">AspectJSecurityInterceptor</code> calls this anonymous <code class="literal">AspectJCallback</code> class when it wants the target object to continue.</p>
<p>You will need to configure Spring to load the aspect and wire it with the <code class="literal">AspectJSecurityInterceptor</code>. A bean declaration which achieves this is shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"domainObjectInstanceSecurityAspect"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"security.samples.aspectj.DomainObjectInstanceSecurityAspect"</span>
	<span class="hl-attribute">factory-method</span>=<span class="hl-value">"aspectOf"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"securityInterceptor"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"bankManagerSecurity"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>That&#8217;s it! Now you can create your beans from anywhere within your application, using whatever means you think fit (eg <code class="literal">new Person();</code>) and they will have the security interceptor applied.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="el-access" href="index.html#el-access"></a>27.&nbsp;Expression-Based Access Control</h2></div></div></div>
<p>Spring Security 3.0 introduced the ability to use Spring EL expressions as an authorization mechanism in addition to the simple use of configuration attributes and access-decision voters which have seen before. Expression-based access control is built on the same architecture but allows complicated Boolean logic to be encapsulated in a single expression.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="overview" href="index.html#overview"></a>27.1&nbsp;Overview</h2></div></div></div>
<p>Spring Security uses Spring EL for expression support and you should look at how that works if you are interested in understanding the topic in more depth. Expressions are evaluated with a "root object" as part of the evaluation context. Spring Security uses specific classes for web and method security as the root object, in order to provide built-in expressions and access to values such as the current principal.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="el-common-built-in" href="index.html#el-common-built-in"></a>27.1.1&nbsp;Common Built-In Expressions</h3></div></div></div>
<p>The base class for expression root objects is <code class="literal">SecurityExpressionRoot</code>. This provides some common expressions which are available in both web and method security.</p>
<div class="table"><a name="common-expressions" href="index.html#common-expressions"></a><p class="title"><b>Table&nbsp;27.1.&nbsp;Common built-in expressions</b></p><div class="table-contents">
<table summary="Common built-in expressions" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Expression</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">hasRole([role])</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Returns <code class="literal">true</code> if the current principal has the specified role. By default if the supplied role does not start with 'ROLE_' it will be added. This can be customized by modifying the <code class="literal">defaultRolePrefix</code> on <code class="literal">DefaultWebSecurityExpressionHandler</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">hasAnyRole([role1,role2])</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Returns <code class="literal">true</code> if the current principal has any of the supplied roles (given as a comma-separated list of strings). By default if the supplied role does not start with 'ROLE_' it will be added. This can be customized by modifying the <code class="literal">defaultRolePrefix</code> on <code class="literal">DefaultWebSecurityExpressionHandler</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">hasAuthority([authority])</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Returns <code class="literal">true</code> if the current principal has the specified authority.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">hasAnyAuthority([authority1,authority2])</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Returns <code class="literal">true</code> if the current principal has any of the supplied roles (given as a comma-separated list of strings)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">principal</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Allows direct access to the principal object representing the current user</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">authentication</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Allows direct access to the current <code class="literal">Authentication</code> object obtained from the <code class="literal">SecurityContext</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">permitAll</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Always evaluates to <code class="literal">true</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">denyAll</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Always evaluates to <code class="literal">false</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">isAnonymous()</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Returns <code class="literal">true</code> if the current principal is an anonymous user</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">isRememberMe()</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Returns <code class="literal">true</code> if the current principal is a remember-me user</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">isAuthenticated()</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Returns <code class="literal">true</code> if the user is not anonymous</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">isFullyAuthenticated()</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Returns <code class="literal">true</code> if the user is not an anonymous or a remember-me user</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">hasPermission(Object target, Object permission)</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Returns <code class="literal">true</code> if the user has access to the provided target for the given permission. For example, <code class="literal">hasPermission(domainObject, 'read')</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">hasPermission(Object targetId, String targetType, Object permission)</code></p></td><td style="" align="left" valign="top"><p>Returns <code class="literal">true</code> if the user has access to the provided target for the given permission. For example, <code class="literal">hasPermission(1, 'com.example.domain.Message', 'read')</code></p></td></tr></tbody></table>
</div></div><br class="table-break">
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="el-access-web" href="index.html#el-access-web"></a>27.2&nbsp;Web Security Expressions</h2></div></div></div>
<p>To use expressions to secure individual URLs, you would first need to set the <code class="literal">use-expressions</code> attribute in the <code class="literal">&lt;http&gt;</code> element to <code class="literal">true</code>.
Spring Security will then expect the <code class="literal">access</code> attributes of the <code class="literal">&lt;intercept-url&gt;</code> elements to contain Spring EL expressions.
The expressions should evaluate to a Boolean, defining whether access should be allowed or not.
For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-tag">&lt;intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/admin*"</span>
		<span class="hl-attribute">access</span>=<span class="hl-value">"hasRole('admin') and hasIpAddress('192.168.1.0/24')"</span><span class="hl-tag">/&gt;</span>
	...
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>Here we have defined that the "admin" area of an application (defined by the URL pattern) should only be available to users who have the granted authority "admin" and whose IP address matches a local subnet.
We&#8217;ve already seen the built-in <code class="literal">hasRole</code> expression in the previous section.
The expression <code class="literal">hasIpAddress</code> is an additional built-in expression which is specific to web security.
It is defined by the <code class="literal">WebSecurityExpressionRoot</code> class, an instance of which is used as the expression root object when evaluation web-access expressions.
This object also directly exposed the <code class="literal">HttpServletRequest</code> object under the name <code class="literal">request</code> so you can invoke the request directly in an expression.
If expressions are being used, a <code class="literal">WebExpressionVoter</code> will be added to the <code class="literal">AccessDecisionManager</code> which is used by the namespace.
So if you aren&#8217;t using the namespace and want to use expressions, you will have to add one of these to your configuration.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="el-access-web-beans" href="index.html#el-access-web-beans"></a>27.2.1&nbsp;Referring to Beans in Web Security Expressions</h3></div></div></div>
<p>If you wish to extend the expressions that are available, you can easily refer to any Spring Bean you expose.
For example, assuming you have a Bean with the name of <code class="literal">webSecurity</code> that contains the following method signature:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurity {
		<span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> check(Authentication authentication, HttpServletRequest request) {
				...
		}
}</pre>
<p>You could refer to the method using:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-tag">&lt;intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/user/**"</span>
		<span class="hl-attribute">access</span>=<span class="hl-value">"@webSecurity.check(authentication,request)"</span><span class="hl-tag">/&gt;</span>
	...
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>or in Java configuration</p>
<pre class="programlisting">http
		.authorizeRequests()
				.antMatchers(<span class="hl-string">"/user/**"</span>).access(<span class="hl-string">"@webSecurity.check(authentication,request)"</span>)
				...</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="el-access-web-path-variables" href="index.html#el-access-web-path-variables"></a>27.2.2&nbsp;Path Variables in Web Security Expressions</h3></div></div></div>
<p>At times it is nice to be able to refer to path variables within a URL.
For example, consider a RESTful application that looks up a user by id from the URL path in the format <code class="literal">/user/{userId}</code>.</p>
<p>You can easily refer to the path variable by placing it in the pattern.
For example, if you had a Bean with the name of <code class="literal">webSecurity</code> that contains the following method signature:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebSecurity {
		<span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> checkUserId(Authentication authentication, <span class="hl-keyword">int</span> id) {
				...
		}
}</pre>
<p>You could refer to the method using:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-tag">&lt;intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/user/{userId}/**"</span>
		<span class="hl-attribute">access</span>=<span class="hl-value">"@webSecurity.checkUserId(authentication,#userId)"</span><span class="hl-tag">/&gt;</span>
	...
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>or in Java configuration</p>
<pre class="programlisting">http
		.authorizeRequests()
				.antMatchers(<span class="hl-string">"/user/{userId}/**"</span>).access(<span class="hl-string">"@webSecurity.checkUserId(authentication,#userId)"</span>)
				...</pre>
<p>In both configurations URLs that match would pass in the path variable (and convert it) into checkUserId method.
For example, if the URL were <code class="literal">/user/123/resource</code>, then the id passed in would be <code class="literal">123</code>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="method-security-expressions" href="index.html#method-security-expressions"></a>27.3&nbsp;Method Security Expressions</h2></div></div></div>
<p>Method security is a bit more complicated than a simple allow or deny rule. Spring Security 3.0 introduced some new annotations in order to allow comprehensive support for the use of expressions.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="el-pre-post-annotations" href="index.html#el-pre-post-annotations"></a>27.3.1&nbsp;@Pre and @Post Annotations</h3></div></div></div>
<p>There are four annotations which support expression attributes to allow pre and post-invocation authorization checks and also to support filtering of submitted collection arguments or return values. They are <code class="literal">@PreAuthorize</code>, <code class="literal">@PreFilter</code>, <code class="literal">@PostAuthorize</code> and <code class="literal">@PostFilter</code>. Their use is enabled through the <code class="literal">global-method-security</code> namespace element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;global-method-security</span> <span class="hl-attribute">pre-post-annotations</span>=<span class="hl-value">"enabled"</span><span class="hl-tag">/&gt;</span></pre>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="access-control-using-preauthorize-and-postauthorize" href="index.html#access-control-using-preauthorize-and-postauthorize"></a>Access Control using @PreAuthorize and @PostAuthorize</h4></div></div></div>
<p>The most obviously useful annotation is <code class="literal">@PreAuthorize</code> which decides whether a method can actually be invoked or not. For example (from the"Contacts" sample application)</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@PreAuthorize("hasRole('USER')")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> create(Contact contact);</pre>
<p>which means that access will only be allowed for users with the role "ROLE_USER". Obviously the same thing could easily be achieved using a traditional configuration and a simple configuration attribute for the required role. But what about:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@PreAuthorize("hasPermission(#contact, 'admin')")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> deletePermission(Contact contact, Sid recipient, Permission permission);</pre>
<p>Here we&#8217;re actually using a method argument as part of the expression to decide whether the current user has the "admin"permission for the given contact. The built-in <code class="literal">hasPermission()</code> expression is linked into the Spring Security ACL module through the application context, as we&#8217;ll<a class="link" href="index.html#el-permission-evaluator" title="The PermissionEvaluator interface">see below</a>. You can access any of the method arguments by name as expression variables.</p>
<p>There are a number of ways in which Spring Security can resolve the method arguments. Spring Security uses <code class="literal">DefaultSecurityParameterNameDiscoverer</code> to discover the parameter names. By default, the following options are tried for a method as a whole.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<p class="simpara">If Spring Security&#8217;s <code class="literal">@P</code> annotation is present on a single argument to the method, the value will be used. This is useful for interfaces compiled with a JDK prior to JDK 8 which do not contain any information about the parameter names. For example:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.security.access.method.P;

...

<em><span class="hl-annotation" style="color: gray">@PreAuthorize("#c.name == authentication.name")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doSomething(<em><span class="hl-annotation" style="color: gray">@P("c")</span></em> Contact contact);</pre>
<p class="simpara">Behind the scenes this use implemented using <code class="literal">AnnotationParameterNameDiscoverer</code> which can be customized to support the value attribute of any specified annotation.</p>
</li><li class="listitem">
<p class="simpara">If Spring Data&#8217;s <code class="literal">@Param</code> annotation is present on at least one parameter for the method, the value will be used. This is useful for interfaces compiled with a JDK prior to JDK 8 which do not contain any information about the parameter names. For example:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.data.repository.query.Param;

...

<em><span class="hl-annotation" style="color: gray">@PreAuthorize("#n == authentication.name")</span></em>
Contact findContactByName(<em><span class="hl-annotation" style="color: gray">@Param("n")</span></em> String name);</pre>
<p class="simpara">Behind the scenes this use implemented using <code class="literal">AnnotationParameterNameDiscoverer</code> which can be customized to support the value attribute of any specified annotation.</p>
</li><li class="listitem">
If JDK 8 was used to compile the source with the -parameters argument and Spring 4+ is being used, then the standard JDK reflection API is used to discover the parameter names. This works on both classes and interfaces.
</li><li class="listitem">
Last, if the code was compiled with the debug symbols, the parameter names will be discovered using the debug symbols. This will not work for interfaces since they do not have debug information about the parameter names. For interfaces, annotations or the JDK 8 approach must be used.
</li></ul></div>
<p>Any Spring-EL functionality is available within the expression, so you can also access properties on the arguments. For example, if you wanted a particular method to only allow access to a user whose username matched that of the contact, you could write</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@PreAuthorize("#contact.name == authentication.name")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doSomething(Contact contact);</pre>
<p>Here we are accessing another built-in expression, <code class="literal">authentication</code>, which is the <code class="literal">Authentication</code> stored in the security context. You can also access its "principal" property directly, using the expression <code class="literal">principal</code>. The value will often be a <code class="literal">UserDetails</code> instance, so you might use an expression like <code class="literal">principal.username</code> or <code class="literal">principal.enabled</code>.</p>
<p>Less commonly, you may wish to perform an access-control check after the method has been invoked. This can be achieved using the <code class="literal">@PostAuthorize</code> annotation. To access the return value from a method, use the built-in name <code class="literal">returnObject</code> in the expression.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="filtering-using-prefilter-and-postfilter" href="index.html#filtering-using-prefilter-and-postfilter"></a>Filtering using @PreFilter and @PostFilter</h4></div></div></div>
<p>As you may already be aware, Spring Security supports filtering of collections and arrays and this can now be achieved using expressions. This is most commonly performed on the return value of a method. For example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@PreAuthorize("hasRole('USER')")</span></em>
<em><span class="hl-annotation" style="color: gray">@PostFilter("hasPermission(filterObject, 'read') or hasPermission(filterObject, 'admin')")</span></em>
<span class="hl-keyword">public</span> List&lt;Contact&gt; getAll();</pre>
<p>When using the <code class="literal">@PostFilter</code> annotation, Spring Security iterates through the returned collection and removes any elements for which the supplied expression is false. The name <code class="literal">filterObject</code> refers to the current object in the collection. You can also filter before the method call, using <code class="literal">@PreFilter</code>, though this is a less common requirement. The syntax is just the same, but if there is more than one argument which is a collection type then you have to select one by name using the <code class="literal">filterTarget</code> property of this annotation.</p>
<p>Note that filtering is obviously not a substitute for tuning your data retrieval queries. If you are filtering large collections and removing many of the entries then this is likely to be inefficient.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="el-method-built-in" href="index.html#el-method-built-in"></a>27.3.2&nbsp;Built-In Expressions</h3></div></div></div>
<p>There are some built-in expressions which are specific to method security, which we have already seen in use above. The <code class="literal">filterTarget</code> and <code class="literal">returnValue</code> values are simple enough, but the use of the <code class="literal">hasPermission()</code> expression warrants a closer look.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="el-permission-evaluator" href="index.html#el-permission-evaluator"></a>The PermissionEvaluator interface</h4></div></div></div>
<p><code class="literal">hasPermission()</code> expressions are delegated to an instance of <code class="literal">PermissionEvaluator</code>. It is intended to bridge between the expression system and Spring Security&#8217;s ACL system, allowing you to specify authorization constraints on domain objects, based on abstract permissions. It has no explicit dependencies on the ACL module, so you could swap that out for an alternative implementation if required. The interface has two methods:</p>
<pre class="programlisting"><span class="hl-keyword">boolean</span> hasPermission(Authentication authentication, Object targetDomainObject,
							Object permission);

<span class="hl-keyword">boolean</span> hasPermission(Authentication authentication, Serializable targetId,
							String targetType, Object permission);</pre>
<p>which map directly to the available versions of the expression, with the exception that the first argument (the <code class="literal">Authentication</code> object) is not supplied. The first is used in situations where the domain object, to which access is being controlled, is already loaded. Then expression will return true if the current user has the given permission for that object. The second version is used in cases where the object is not loaded, but its identifier is known. An abstract "type" specifier for the domain object is also required, allowing the correct ACL permissions to be loaded. This has traditionally been the Java class of the object, but does not have to be as long as it is consistent with how the permissions are loaded.</p>
<p>To use <code class="literal">hasPermission()</code> expressions, you have to explicitly configure a <code class="literal">PermissionEvaluator</code> in your application context. This would look something like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;security:global-method-security</span> <span class="hl-attribute">pre-post-annotations</span>=<span class="hl-value">"enabled"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;security:expression-handler</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"expressionHandler"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/security:global-method-security&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"expressionHandler"</span> <span class="hl-attribute">class</span>=
<span class="hl-value">"org.springframework.security.access.expression.method.DefaultMethodSecurityExpressionHandler"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"permissionEvaluator"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myPermissionEvaluator"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>Where <code class="literal">myPermissionEvaluator</code> is the bean which implements <code class="literal">PermissionEvaluator</code>. Usually this will be the implementation from the ACL module which is called <code class="literal">AclPermissionEvaluator</code>. See the "Contacts" sample application configuration for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="method-security-meta-annotations" href="index.html#method-security-meta-annotations"></a>Method Security Meta Annotations</h4></div></div></div>
<p>You can make use of meta annotations for method security to make your code more readable.
This is especially convenient if you find that you are repeating the same complex expression throughout your code base.
For example, consider the following:</p>
<pre class="programlisting">@PreAuthorize(<span class="hl-string">"#contact.name == authentication.name"</span>)</pre>
<p>Instead of repeating this everywhere, we can create a meta annotation that can be used instead.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></em>
<em><span class="hl-annotation" style="color: gray">@PreAuthorize("#contact.name == authentication.name")</span></em>
<span class="hl-keyword">public</span> <em><span class="hl-annotation" style="color: gray">@interface</span></em> ContactPermission {}</pre>
<p>Meta annotations can be used for any of the Spring Security method security annotations.
In order to remain compliant with the specification JSR-250 annotations do not support meta annotations.</p>
</div>
</div>
</div>
</div>
</div>
<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="advanced-topics" href="index.html#advanced-topics"></a>Part&nbsp;VI.&nbsp;Additional Topics</h1></div></div></div>
<div class="partintro"><div></div>
<p>In this part we cover features which require knowledge of previous chapters as well as some of the more advanced and less-commonly used features of the framework.</p>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="domain-acls" href="index.html#domain-acls"></a>28.&nbsp;Domain Object Security (ACLs)</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="domain-acls-overview" href="index.html#domain-acls-overview"></a>28.1&nbsp;Overview</h2></div></div></div>
<p>Complex applications often will find the need to define access permissions not simply at a web request or method invocation level. Instead, security decisions need to comprise both who (<code class="literal">Authentication</code>), where (<code class="literal">MethodInvocation</code>) and what (<code class="literal">SomeDomainObject</code>). In other words, authorization decisions also need to consider the actual domain object instance subject of a method invocation.</p>
<p>Imagine you&#8217;re designing an application for a pet clinic. There will be two main groups of users of your Spring-based application: staff of the pet clinic, as well as the pet clinic&#8217;s customers. The staff will have access to all of the data, whilst your customers will only be able to see their own customer records. To make it a little more interesting, your customers can allow other users to see their customer records, such as their "puppy preschool" mentor or president of their local "Pony Club". Using Spring Security as the foundation, you have several approaches that can be used:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Write your business methods to enforce the security. You could consult a collection within the <code class="literal">Customer</code> domain object instance to determine which users have access. By using the <code class="literal">SecurityContextHolder.getContext().getAuthentication()</code>, you&#8217;ll be able to access the <code class="literal">Authentication</code> object.
</li><li class="listitem">
Write an <code class="literal">AccessDecisionVoter</code> to enforce the security from the <code class="literal">GrantedAuthority[]</code> s stored in the <code class="literal">Authentication</code> object. This would mean your <code class="literal">AuthenticationManager</code> would need to populate the <code class="literal">Authentication</code> with custom <code class="literal">GrantedAuthority[]</code>s representing each of the <code class="literal">Customer</code> domain object instances the principal has access to.
</li><li class="listitem">
Write an <code class="literal">AccessDecisionVoter</code> to enforce the security and open the target <code class="literal">Customer</code> domain object directly. This would mean your voter needs access to a DAO that allows it to retrieve the <code class="literal">Customer</code> object. It would then access the <code class="literal">Customer</code> object&#8217;s collection of approved users and make the appropriate decision.
</li></ul></div>
<p>Each one of these approaches is perfectly legitimate. However, the first couples your authorization checking to your business code. The main problems with this include the enhanced difficulty of unit testing and the fact it would be more difficult to reuse the <code class="literal">Customer</code> authorization logic elsewhere. Obtaining the <code class="literal">GrantedAuthority[]</code> s from the <code class="literal">Authentication</code> object is also fine, but will not scale to large numbers of <code class="literal">Customer</code> s. If a user might be able to access 5,000 <code class="literal">Customer</code> s (unlikely in this case, but imagine if it were a popular vet for a large Pony Club!) the amount of memory consumed and time required to construct the <code class="literal">Authentication</code> object would be undesirable. The final method, opening the <code class="literal">Customer</code> directly from external code, is probably the best of the three. It achieves separation of concerns, and doesn&#8217;t misuse memory or CPU cycles, but it is still inefficient in that both the <code class="literal">AccessDecisionVoter</code> and the eventual business method itself will perform a call to the DAO responsible for retrieving the <code class="literal">Customer</code> object. Two accesses per method invocation is clearly undesirable. In addition, with every approach listed you&#8217;ll need to write your own access control list (ACL) persistence and business logic from scratch.</p>
<p>Fortunately, there is another alternative, which we&#8217;ll talk about below.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="domain-acls-key-concepts" href="index.html#domain-acls-key-concepts"></a>28.2&nbsp;Key Concepts</h2></div></div></div>
<p>Spring Security&#8217;s ACL services are shipped in the <code class="literal">spring-security-acl-xxx.jar</code>. You will need to add this JAR to your classpath to use Spring Security&#8217;s domain object instance security capabilities.</p>
<p>Spring Security&#8217;s domain object instance security capabilities centre on the concept of an access control list (ACL). Every domain object instance in your system has its own ACL, and the ACL records details of who can and can&#8217;t work with that domain object. With this in mind, Spring Security delivers three main ACL-related capabilities to your application:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A way of efficiently retrieving ACL entries for all of your domain objects (and modifying those ACLs)
</li><li class="listitem">
A way of ensuring a given principal is permitted to work with your objects, before methods are called
</li><li class="listitem">
A way of ensuring a given principal is permitted to work with your objects (or something they return), after methods are called
</li></ul></div>
<p>As indicated by the first bullet point, one of the main capabilities of the Spring Security ACL module is providing a high-performance way of retrieving ACLs. This ACL repository capability is extremely important, because every domain object instance in your system might have several access control entries, and each ACL might inherit from other ACLs in a tree-like structure (this is supported out-of-the-box by Spring Security, and is very commonly used). Spring Security&#8217;s ACL capability has been carefully designed to provide high performance retrieval of ACLs, together with pluggable caching, deadlock-minimizing database updates, independence from ORM frameworks (we use JDBC directly), proper encapsulation, and transparent database updating.</p>
<p>Given databases are central to the operation of the ACL module, let&#8217;s explore the four main tables used by default in the implementation. The tables are presented below in order of size in a typical Spring Security ACL deployment, with the table with the most rows listed last:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
ACL_SID allows us to uniquely identify any principal or authority in the system ("SID" stands for "security identity"). The only columns are the ID, a textual representation of the SID, and a flag to indicate whether the textual representation refers to a principal name or a <code class="literal">GrantedAuthority</code>. Thus, there is a single row for each unique principal or <code class="literal">GrantedAuthority</code>. When used in the context of receiving a permission, a SID is generally called a "recipient".
</li><li class="listitem">
ACL_CLASS allows us to uniquely identify any domain object class in the system. The only columns are the ID and the Java class name. Thus, there is a single row for each unique Class we wish to store ACL permissions for.
</li><li class="listitem">
ACL_OBJECT_IDENTITY stores information for each unique domain object instance in the system. Columns include the ID, a foreign key to the ACL_CLASS table, a unique identifier so we know which ACL_CLASS instance we&#8217;re providing information for, the parent, a foreign key to the ACL_SID table to represent the owner of the domain object instance, and whether we allow ACL entries to inherit from any parent ACL. We have a single row for every domain object instance we&#8217;re storing ACL permissions for.
</li><li class="listitem">
Finally, ACL_ENTRY stores the individual permissions assigned to each recipient. Columns include a foreign key to the ACL_OBJECT_IDENTITY, the recipient (ie a foreign key to ACL_SID), whether we&#8217;ll be auditing or not, and the integer bit mask that represents the actual permission being granted or denied. We have a single row for every recipient that receives a permission to work with a domain object.
</li></ul></div>
<p>As mentioned in the last paragraph, the ACL system uses integer bit masking. Don&#8217;t worry, you need not be aware of the finer points of bit shifting to use the ACL system, but suffice to say that we have 32 bits we can switch on or off. Each of these bits represents a permission, and by default the permissions are read (bit 0), write (bit 1), create (bit 2), delete (bit 3) and administer (bit 4). It&#8217;s easy to implement your own <code class="literal">Permission</code> instance if you wish to use other permissions, and the remainder of the ACL framework will operate without knowledge of your extensions.</p>
<p>It is important to understand that the number of domain objects in your system has absolutely no bearing on the fact we&#8217;ve chosen to use integer bit masking. Whilst you have 32 bits available for permissions, you could have billions of domain object instances (which will mean billions of rows in ACL_OBJECT_IDENTITY and quite probably ACL_ENTRY). We make this point because we&#8217;ve found sometimes people mistakenly believe they need a bit for each potential domain object, which is not the case.</p>
<p>Now that we&#8217;ve provided a basic overview of what the ACL system does, and what it looks like at a table structure, let&#8217;s explore the key interfaces. The key interfaces are:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">Acl</code>: Every domain object has one and only one <code class="literal">Acl</code> object, which internally holds the <code class="literal">AccessControlEntry</code> s as well as knows the owner of the <code class="literal">Acl</code>. An Acl does not refer directly to the domain object, but instead to an <code class="literal">ObjectIdentity</code>. The <code class="literal">Acl</code> is stored in the ACL_OBJECT_IDENTITY table.
</li><li class="listitem">
<code class="literal">AccessControlEntry</code>: An <code class="literal">Acl</code> holds multiple <code class="literal">AccessControlEntry</code> s, which are often abbreviated as ACEs in the framework. Each ACE refers to a specific tuple of <code class="literal">Permission</code>, <code class="literal">Sid</code> and <code class="literal">Acl</code>. An ACE can also be granting or non-granting and contain audit settings. The ACE is stored in the ACL_ENTRY table.
</li><li class="listitem">
<code class="literal">Permission</code>: A permission represents a particular immutable bit mask, and offers convenience functions for bit masking and outputting information. The basic permissions presented above (bits 0 through 4) are contained in the <code class="literal">BasePermission</code> class.
</li><li class="listitem">
<code class="literal">Sid</code>: The ACL module needs to refer to principals and <code class="literal">GrantedAuthority[]</code> s. A level of indirection is provided by the <code class="literal">Sid</code> interface, which is an abbreviation of "security identity". Common classes include <code class="literal">PrincipalSid</code> (to represent the principal inside an <code class="literal">Authentication</code> object) and <code class="literal">GrantedAuthoritySid</code>. The security identity information is stored in the ACL_SID table.
</li><li class="listitem">
<code class="literal">ObjectIdentity</code>: Each domain object is represented internally within the ACL module by an <code class="literal">ObjectIdentity</code>. The default implementation is called <code class="literal">ObjectIdentityImpl</code>.
</li><li class="listitem">
<code class="literal">AclService</code>: Retrieves the <code class="literal">Acl</code> applicable for a given <code class="literal">ObjectIdentity</code>. In the included implementation (<code class="literal">JdbcAclService</code>), retrieval operations are delegated to a <code class="literal">LookupStrategy</code>. The <code class="literal">LookupStrategy</code> provides a highly optimized strategy for retrieving ACL information, using batched retrievals <code class="literal">(BasicLookupStrategy</code>) and supporting custom implementations that leverage materialized views, hierarchical queries and similar performance-centric, non-ANSI SQL capabilities.
</li><li class="listitem">
<code class="literal">MutableAclService</code>: Allows a modified <code class="literal">Acl</code> to be presented for persistence. It is not essential to use this interface if you do not wish.
</li></ul></div>
<p>Please note that our out-of-the-box AclService and related database classes all use ANSI SQL. This should therefore work with all major databases. At the time of writing, the system had been successfully tested using Hypersonic SQL, PostgreSQL, Microsoft SQL Server and Oracle.</p>
<p>Two samples ship with Spring Security that demonstrate the ACL module. The first is the Contacts Sample, and the other is the Document Management System (DMS) Sample. We suggest taking a look over these for examples.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="domain-acls-getting-started" href="index.html#domain-acls-getting-started"></a>28.3&nbsp;Getting Started</h2></div></div></div>
<p>To get starting using Spring Security&#8217;s ACL capability, you will need to store your ACL information somewhere. This necessitates the instantiation of a <code class="literal">DataSource</code> using Spring. The <code class="literal">DataSource</code> is then injected into a <code class="literal">JdbcMutableAclService</code> and <code class="literal">BasicLookupStrategy</code> instance. The latter provides high-performance ACL retrieval capabilities, and the former provides mutator capabilities. Refer to one of the samples that ship with Spring Security for an example configuration. You&#8217;ll also need to populate the database with the four ACL-specific tables listed in the last section (refer to the ACL samples for the appropriate SQL statements).</p>
<p>Once you&#8217;ve created the required schema and instantiated <code class="literal">JdbcMutableAclService</code>, you&#8217;ll next need to ensure your domain model supports interoperability with the Spring Security ACL package. Hopefully <code class="literal">ObjectIdentityImpl</code> will prove sufficient, as it provides a large number of ways in which it can be used. Most people will have domain objects that contain a <code class="literal">public Serializable getId()</code> method. If the return type is long, or compatible with long (eg an int), you will find you need not give further consideration to <code class="literal">ObjectIdentity</code> issues. Many parts of the ACL module rely on long identifiers. If you&#8217;re not using long (or an int, byte etc), there is a very good chance you&#8217;ll need to reimplement a number of classes. We do not intend to support non-long identifiers in Spring Security&#8217;s ACL module, as longs are already compatible with all database sequences, the most common identifier data type, and are of sufficient length to accommodate all common usage scenarios.</p>
<p>The following fragment of code shows how to create an <code class="literal">Acl</code>, or modify an existing <code class="literal">Acl</code>:</p>
<pre class="programlisting"><span class="hl-comment">// Prepare the information we'd like in our access control entry (ACE)</span>
ObjectIdentity oi = <span class="hl-keyword">new</span> ObjectIdentityImpl(Foo.<span class="hl-keyword">class</span>, <span class="hl-keyword">new</span> Long(<span class="hl-number">44</span>));
Sid sid = <span class="hl-keyword">new</span> PrincipalSid(<span class="hl-string">"Samantha"</span>);
Permission p = BasePermission.ADMINISTRATION;

<span class="hl-comment">// Create or update the relevant ACL</span>
MutableAcl acl = null;
<span class="hl-keyword">try</span> {
acl = (MutableAcl) aclService.readAclById(oi);
} <span class="hl-keyword">catch</span> (NotFoundException nfe) {
acl = aclService.createAcl(oi);
}

<span class="hl-comment">// Now grant some permissions via an access control entry (ACE)</span>
acl.insertAce(acl.getEntries().length, p, sid, true);
aclService.updateAcl(acl);</pre>
<p>In the example above, we&#8217;re retrieving the ACL associated with the "Foo" domain object with identifier number 44. We&#8217;re then adding an ACE so that a principal named "Samantha" can "administer" the object. The code fragment is relatively self-explanatory, except the insertAce method. The first argument to the insertAce method is determining at what position in the Acl the new entry will be inserted. In the example above, we&#8217;re just putting the new ACE at the end of the existing ACEs. The final argument is a Boolean indicating whether the ACE is granting or denying. Most of the time it will be granting (true), but if it is denying (false), the permissions are effectively being blocked.</p>
<p>Spring Security does not provide any special integration to automatically create, update or delete ACLs as part of your DAO or repository operations. Instead, you will need to write code like shown above for your individual domain objects. It&#8217;s worth considering using AOP on your services layer to automatically integrate the ACL information with your services layer operations. We&#8217;ve found this quite an effective approach in the past.</p>
<p>Once you&#8217;ve used the above techniques to store some ACL information in the database, the next step is to actually use the ACL information as part of authorization decision logic. You have a number of choices here. You could write your own <code class="literal">AccessDecisionVoter</code> or <code class="literal">AfterInvocationProvider</code> that respectively fires before or after a method invocation. Such classes would use <code class="literal">AclService</code> to retrieve the relevant ACL and then call <code class="literal">Acl.isGranted(Permission[] permission, Sid[] sids, boolean administrativeMode)</code> to decide whether permission is granted or denied. Alternately, you could use our <code class="literal">AclEntryVoter</code>, <code class="literal">AclEntryAfterInvocationProvider</code> or <code class="literal">AclEntryAfterInvocationCollectionFilteringProvider</code> classes. All of these classes provide a declarative-based approach to evaluating ACL information at runtime, freeing you from needing to write any code. Please refer to the sample applications to learn how to use these classes.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="preauth" href="index.html#preauth"></a>29.&nbsp;Pre-Authentication Scenarios</h2></div></div></div>
<p>There are situations where you want to use Spring Security for authorization, but the user has already been reliably authenticated by some external system prior to accessing the application. We refer to these situations as "pre-authenticated" scenarios. Examples include X.509, Siteminder and authentication by the Java EE container in which the application is running. When using pre-authentication, Spring Security has to</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Identify the user making the request.
</li><li class="listitem">
Obtain the authorities for the user.
</li></ul></div>
<p>The details will depend on the external authentication mechanism. A user might be identified by their certificate information in the case of X.509, or by an HTTP request header in the case of Siteminder. If relying on container authentication, the user will be identified by calling the <code class="literal">getUserPrincipal()</code> method on the incoming HTTP request. In some cases, the external mechanism may supply role/authority information for the user but in others the authorities must be obtained from a separate source, such as a <code class="literal">UserDetailsService</code>.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="pre-authentication-framework-classes" href="index.html#pre-authentication-framework-classes"></a>29.1&nbsp;Pre-Authentication Framework Classes</h2></div></div></div>
<p>Because most pre-authentication mechanisms follow the same pattern, Spring Security has a set of classes which provide an internal framework for implementing pre-authenticated authentication providers. This removes duplication and allows new implementations to be added in a structured fashion, without having to write everything from scratch. You don&#8217;t need to know about these classes if you want to use something like <a class="link" href="index.html#x509" title="35.&nbsp;X.509 Authentication">X.509 authentication</a>, as it already has a namespace configuration option which is simpler to use and get started with. If you need to use explicit bean configuration or are planning on writing your own implementation then an understanding of how the provided implementations work will be useful. You will find classes under the <code class="literal">org.springframework.security.web.authentication.preauth</code>. We just provide an outline here so you should consult the Javadoc and source where appropriate.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="abstractpreauthenticatedprocessingfilter" href="index.html#abstractpreauthenticatedprocessingfilter"></a>29.1.1&nbsp;AbstractPreAuthenticatedProcessingFilter</h3></div></div></div>
<p>This class will check the current contents of the security context and, if empty, it will attempt to extract user information from the HTTP request and submit it to the <code class="literal">AuthenticationManager</code>. Subclasses override the following methods to obtain this information:</p>
<pre class="programlisting"><span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> Object getPreAuthenticatedPrincipal(HttpServletRequest request);

<span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> Object getPreAuthenticatedCredentials(HttpServletRequest request);</pre>
<p>After calling these, the filter will create a <code class="literal">PreAuthenticatedAuthenticationToken</code> containing the returned data and submit it for authentication. By "authentication" here, we really just mean further processing to perhaps load the user&#8217;s authorities, but the standard Spring Security authentication architecture is followed.</p>
<p>Like other Spring Security authentication filters, the pre-authentication filter has an <code class="literal">authenticationDetailsSource</code> property which by default will create a <code class="literal">WebAuthenticationDetails</code> object to store additional information such as the session-identifier and originating IP address in the <code class="literal">details</code> property of the <code class="literal">Authentication</code> object. In cases where user role information can be obtained from the pre-authentication mechanism, the data is also stored in this property, with the details implementing the <code class="literal">GrantedAuthoritiesContainer</code> interface. This enables the authentication provider to read the authorities which were externally allocated to the user. We&#8217;ll look at a concrete example next.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="j2ee-preauth-details" href="index.html#j2ee-preauth-details"></a>J2eeBasedPreAuthenticatedWebAuthenticationDetailsSource</h4></div></div></div>
<p>If the filter is configured with an <code class="literal">authenticationDetailsSource</code> which is an instance of this class, the authority information is obtained by calling the <code class="literal">isUserInRole(String role)</code> method for each of a pre-determined set of "mappable roles". The class gets these from a configured <code class="literal">MappableAttributesRetriever</code>. Possible implementations include hard-coding a list in the application context and reading the role information from the <code class="literal">&lt;security-role&gt;</code> information in a <code class="literal">web.xml</code> file. The pre-authentication sample application uses the latter approach.</p>
<p>There is an additional stage where the roles (or attributes) are mapped to Spring Security <code class="literal">GrantedAuthority</code> objects using a configured <code class="literal">Attributes2GrantedAuthoritiesMapper</code>. The default will just add the usual <code class="literal">ROLE_</code> prefix to the names, but it gives you full control over the behaviour.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="preauthenticatedauthenticationprovider" href="index.html#preauthenticatedauthenticationprovider"></a>29.1.2&nbsp;PreAuthenticatedAuthenticationProvider</h3></div></div></div>
<p>The pre-authenticated provider has little more to do than load the <code class="literal">UserDetails</code> object for the user. It does this by delegating to an <code class="literal">AuthenticationUserDetailsService</code>. The latter is similar to the standard <code class="literal">UserDetailsService</code> but takes an <code class="literal">Authentication</code> object rather than just user name:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> AuthenticationUserDetailsService {
	UserDetails loadUserDetails(Authentication token) <span class="hl-keyword">throws</span> UsernameNotFoundException;
}</pre>
<p>This interface may have also other uses but with pre-authentication it allows access to the authorities which were packaged in the <code class="literal">Authentication</code> object, as we saw in the previous section. The <code class="literal">PreAuthenticatedGrantedAuthoritiesUserDetailsService</code> class does this. Alternatively, it may delegate to a standard <code class="literal">UserDetailsService</code> via the <code class="literal">UserDetailsByNameServiceWrapper</code> implementation.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="http403forbiddenentrypoint" href="index.html#http403forbiddenentrypoint"></a>29.1.3&nbsp;Http403ForbiddenEntryPoint</h3></div></div></div>
<p>The <code class="literal">AuthenticationEntryPoint</code> was discussed in the <a class="link" href="index.html#tech-intro-auth-entry-point" title="9.4.2&nbsp;AuthenticationEntryPoint">technical overview</a> chapter. Normally it is responsible for kick-starting the authentication process for an unauthenticated user (when they try to access a protected resource), but in the pre-authenticated case this doesn&#8217;t apply. You would only configure the <code class="literal">ExceptionTranslationFilter</code> with an instance of this class if you aren&#8217;t using pre-authentication in combination with other authentication mechanisms. It will be called if the user is rejected by the <code class="literal">AbstractPreAuthenticatedProcessingFilter</code> resulting in a null authentication. It always returns a <code class="literal">403</code>-forbidden response code if called.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="concrete-implementations" href="index.html#concrete-implementations"></a>29.2&nbsp;Concrete Implementations</h2></div></div></div>
<p>X.509 authentication is covered in its <a class="link" href="index.html#x509" title="35.&nbsp;X.509 Authentication">own chapter</a>. Here we&#8217;ll look at some classes which provide support for other pre-authenticated scenarios.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="request-header-authentication-siteminder" href="index.html#request-header-authentication-siteminder"></a>29.2.1&nbsp;Request-Header Authentication (Siteminder)</h3></div></div></div>
<p>An external authentication system may supply information to the application by setting specific headers on the HTTP request. A well-known example of this is Siteminder, which passes the username in a header called <code class="literal">SM_USER</code>. This mechanism is supported by the class <code class="literal">RequestHeaderAuthenticationFilter</code> which simply extracts the username from the header. It defaults to using the name <code class="literal">SM_USER</code> as the header name. See the Javadoc for more details.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Note that when using a system like this, the framework performs no authentication checks at all and it is <span class="emphasis"><em>extremely</em></span> important that the external system is configured properly and protects all access to the application. If an attacker is able to forge the headers in their original request without this being detected then they could potentially choose any username they wished.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="siteminder-example-configuration" href="index.html#siteminder-example-configuration"></a>Siteminder Example Configuration</h4></div></div></div>
<p>A typical configuration using this filter would look like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;security:http&gt;</span>
<span class="hl-comment">&lt;!-- Additional http configuration omitted --&gt;</span>
<span class="hl-tag">&lt;security:custom-filter</span> <span class="hl-attribute">position</span>=<span class="hl-value">"PRE_AUTH_FILTER"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"siteminderFilter"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/security:http&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"siteminderFilter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.authentication.preauth.RequestHeaderAuthenticationFilter"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"principalRequestHeader"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"SM_USER"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authenticationManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"authenticationManager"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"preauthAuthProvider"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.authentication.preauth.PreAuthenticatedAuthenticationProvider"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"preAuthenticatedUserDetailsService"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userDetailsServiceWrapper"</span>
		<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.core.userdetails.UserDetailsByNameServiceWrapper"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"userDetailsService"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"userDetailsService"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;security:authentication-manager</span> <span class="hl-attribute">alias</span>=<span class="hl-value">"authenticationManager"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;security:authentication-provider</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"preauthAuthProvider"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/security:authentication-manager&gt;</span></pre>
<p>We&#8217;ve assumed here that the <a class="link" href="index.html#ns-config" title="6.&nbsp;Security Namespace Configuration">security namespace</a> is being used for configuration. It&#8217;s also assumed that you have added a <code class="literal">UserDetailsService</code> (called "userDetailsService") to your configuration to load the user&#8217;s roles.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="java-ee-container-authentication" href="index.html#java-ee-container-authentication"></a>29.2.2&nbsp;Java EE Container Authentication</h3></div></div></div>
<p>The class <code class="literal">J2eePreAuthenticatedProcessingFilter</code> will extract the username from the <code class="literal">userPrincipal</code> property of the <code class="literal">HttpServletRequest</code>. Use of this filter would usually be combined with the use of Java EE roles as described above in <a class="xref" href="index.html#j2ee-preauth-details" title="J2eeBasedPreAuthenticatedWebAuthenticationDetailsSource">the section called &#8220;J2eeBasedPreAuthenticatedWebAuthenticationDetailsSource&#8221;</a>.</p>
<p>There is a sample application in the codebase which uses this approach, so get hold of the code from github and have a look at the application context file if you are interested. The code is in the <code class="literal">samples/xml/preauth</code> directory.</p>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ldap" href="index.html#ldap"></a>30.&nbsp;LDAP Authentication</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ldap-overview" href="index.html#ldap-overview"></a>30.1&nbsp;Overview</h2></div></div></div>
<p>LDAP is often used by organizations as a central repository for user information and as an authentication service. It can also be used to store the role information for application users.</p>
<p>There are many different scenarios for how an LDAP server may be configured so Spring Security&#8217;s LDAP provider is fully configurable. It uses separate strategy interfaces for authentication and role retrieval and provides default implementations which can be configured to handle a wide range of situations.</p>
<p>You should be familiar with LDAP before trying to use it with Spring Security. The following link provides a good introduction to the concepts involved and a guide to setting up a directory using the free LDAP server OpenLDAP: <a class="ulink" href="http://www.zytrax.com/books/ldap/" target="_top">http://www.zytrax.com/books/ldap/</a>. Some familiarity with the JNDI APIs used to access LDAP from Java may also be useful. We don&#8217;t use any third-party LDAP libraries (Mozilla, JLDAP etc.) in the LDAP provider, but extensive use is made of Spring LDAP, so some familiarity with that project may be useful if you plan on adding your own customizations.</p>
<p>When using LDAP authentication, it is important to ensure that you configure LDAP connection pooling properly. If you are unfamiliar with how to do this, you can refer to the <a class="ulink" href="http://docs.oracle.com/javase/jndi/tutorial/ldap/connect/config.html" target="_top">Java LDAP documentation</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="using-ldap-with-spring-security" href="index.html#using-ldap-with-spring-security"></a>30.2&nbsp;Using LDAP with Spring Security</h2></div></div></div>
<p>LDAP authentication in Spring Security can be roughly divided into the following stages.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Obtaining the unique LDAP "Distinguished Name", or DN, from the login name. This will often mean performing a search in the directory, unless the exact mapping of usernames to DNs is known in advance. So a user might enter the name "joe" when logging in, but the actual name used to authenticate to LDAP will be the full DN, such as <code class="literal">uid=joe,ou=users,dc=spring,dc=io</code>.
</li><li class="listitem">
Authenticating the user, either by "binding" as that user or by performing a remote "compare" operation of the user&#8217;s password against the password attribute in the directory entry for the DN.
</li><li class="listitem">
Loading the list of authorities for the user.
</li></ul></div>
<p>The exception is when the LDAP directory is just being used to retrieve user information and authenticate against it locally. This may not be possible as directories are often set up with limited read access for attributes such as user passwords.</p>
<p>We will look at some configuration scenarios below. For full information on available configuration options, please consult the security namespace schema (information from which should be available in your XML editor).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ldap-server" href="index.html#ldap-server"></a>30.3&nbsp;Configuring an LDAP Server</h2></div></div></div>
<p>The first thing you need to do is configure the server against which authentication should take place. This is done using the <code class="literal">&lt;ldap-server&gt;</code> element from the security namespace. This can be configured to point at an external LDAP server, using the <code class="literal">url</code> attribute:</p>
<pre class="programlisting"><span class="hl-tag">&lt;ldap-server</span> <span class="hl-attribute">url</span>=<span class="hl-value">"ldap://springframework.org:389/dc=springframework,dc=org"</span><span class="hl-tag"> /&gt;</span></pre>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="using-an-embedded-test-server" href="index.html#using-an-embedded-test-server"></a>30.3.1&nbsp;Using an Embedded Test Server</h3></div></div></div>
<p>The <code class="literal">&lt;ldap-server&gt;</code> element can also be used to create an embedded server, which can be very useful for testing and demonstrations. In this case you use it without the <code class="literal">url</code> attribute:</p>
<pre class="programlisting"><span class="hl-tag">&lt;ldap-server</span> <span class="hl-attribute">root</span>=<span class="hl-value">"dc=springframework,dc=org"</span><span class="hl-tag">/&gt;</span></pre>
<p>Here we&#8217;ve specified that the root DIT of the directory should be "dc=springframework,dc=org", which is the default. Used this way, the namespace parser will create an embedded Apache Directory server and scan the classpath for any LDIF files, which it will attempt to load into the server. You can customize this behaviour using the <code class="literal">ldif</code> attribute, which defines an LDIF resource to be loaded:</p>
<pre class="programlisting"><span class="hl-tag">&lt;ldap-server</span> <span class="hl-attribute">ldif</span>=<span class="hl-value">"classpath:users.ldif"</span><span class="hl-tag"> /&gt;</span></pre>
<p>This makes it a lot easier to get up and running with LDAP, since it can be inconvenient to work all the time with an external server. It also insulates the user from the complex bean configuration needed to wire up an Apache Directory server. Using plain Spring Beans the configuration would be much more cluttered. You must have the necessary Apache Directory dependency jars available for your application to use. These can be obtained from the LDAP sample application.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="using-bind-authentication" href="index.html#using-bind-authentication"></a>30.3.2&nbsp;Using Bind Authentication</h3></div></div></div>
<p>This is the most common LDAP authentication scenario.</p>
<pre class="programlisting"><span class="hl-tag">&lt;ldap-authentication-provider</span> <span class="hl-attribute">user-dn-pattern</span>=<span class="hl-value">"uid={0},ou=people"</span><span class="hl-tag">/&gt;</span></pre>
<p>This simple example would obtain the DN for the user by substituting the user login name in the supplied pattern and attempting to bind as that user with the login password. This is OK if all your users are stored under a single node in the directory. If instead you wished to configure an LDAP search filter to locate the user, you could use the following:</p>
<pre class="programlisting"><span class="hl-tag">&lt;ldap-authentication-provider</span> <span class="hl-attribute">user-search-filter</span>=<span class="hl-value">"(uid={0})"</span>
	<span class="hl-attribute">user-search-base</span>=<span class="hl-value">"ou=people"</span><span class="hl-tag">/&gt;</span></pre>
<p>If used with the server definition above, this would perform a search under the DN <code class="literal">ou=people,dc=springframework,dc=org</code> using the value of the <code class="literal">user-search-filter</code> attribute as a filter. Again the user login name is substituted for the parameter in the filter name, so it will search for an entry with the <code class="literal">uid</code> attribute equal to the user name. If <code class="literal">user-search-base</code> isn&#8217;t supplied, the search will be performed from the root.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="loading-authorities" href="index.html#loading-authorities"></a>30.3.3&nbsp;Loading Authorities</h3></div></div></div>
<p>How authorities are loaded from groups in the LDAP directory is controlled by the following attributes.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">group-search-base</code>. Defines the part of the directory tree under which group searches should be performed.
</li><li class="listitem">
<code class="literal">group-role-attribute</code>. The attribute which contains the name of the authority defined by the group entry. Defaults to <code class="literal">cn</code>
</li><li class="listitem">
<code class="literal">group-search-filter</code>. The filter which is used to search for group membership. The default is <code class="literal">uniqueMember={0}</code>, corresponding to the <code class="literal">groupOfUniqueNames</code> LDAP class <a href="index.html#ftn.d5e5325" class="footnote" name="d5e5325"><sup class="footnote">[19]</sup></a>. In this case, the substituted parameter is the full distinguished name of the user. The parameter <code class="literal">{1}</code> can be used if you want to filter on the login name.
</li></ul></div>
<p>So if we used the following configuration</p>
<pre class="programlisting"><span class="hl-tag">&lt;ldap-authentication-provider</span> <span class="hl-attribute">user-dn-pattern</span>=<span class="hl-value">"uid={0},ou=people"</span>
		<span class="hl-attribute">group-search-base</span>=<span class="hl-value">"ou=groups"</span><span class="hl-tag"> /&gt;</span></pre>
<p>and authenticated successfully as user "ben", the subsequent loading of authorities would perform a search under the directory entry <code class="literal">ou=groups,dc=springframework,dc=org</code>, looking for entries which contain the attribute <code class="literal">uniqueMember</code> with value <code class="literal">uid=ben,ou=people,dc=springframework,dc=org</code>. By default the authority names will have the prefix <code class="literal">ROLE_</code> prepended. You can change this using the <code class="literal">role-prefix</code> attribute. If you don&#8217;t want any prefix, use <code class="literal">role-prefix="none"</code>. For more information on loading authorities, see the Javadoc for the <code class="literal">DefaultLdapAuthoritiesPopulator</code> class.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="implementation-classes" href="index.html#implementation-classes"></a>30.4&nbsp;Implementation Classes</h2></div></div></div>
<p>The namespace configuration options we&#8217;ve used above are simple to use and much more concise than using Spring beans explicitly. There are situations when you may need to know how to configure Spring Security LDAP directly in your application context. You may wish to customize the behaviour of some of the classes, for example. If you&#8217;re happy using namespace configuration then you can skip this section and the next one.</p>
<p>The main LDAP provider class, <code class="literal">LdapAuthenticationProvider</code>, doesn&#8217;t actually do much itself but delegates the work to two other beans, an <code class="literal">LdapAuthenticator</code> and an <code class="literal">LdapAuthoritiesPopulator</code> which are responsible for authenticating the user and retrieving the user&#8217;s set of <code class="literal">GrantedAuthority</code> s respectively.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ldap-ldap-authenticators" href="index.html#ldap-ldap-authenticators"></a>30.4.1&nbsp;LdapAuthenticator Implementations</h3></div></div></div>
<p>The authenticator is also responsible for retrieving any required user attributes. This is because the permissions on the attributes may depend on the type of authentication being used. For example, if binding as the user, it may be necessary to read them with the user&#8217;s own permissions.</p>
<p>There are currently two authentication strategies supplied with Spring Security:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Authentication directly to the LDAP server ("bind" authentication).
</li><li class="listitem">
Password comparison, where the password supplied by the user is compared with the one stored in the repository. This can either be done by retrieving the value of the password attribute and checking it locally or by performing an LDAP "compare" operation, where the supplied password is passed to the server for comparison and the real password value is never retrieved.
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="ldap-ldap-authenticators-common" href="index.html#ldap-ldap-authenticators-common"></a>Common Functionality</h4></div></div></div>
<p>Before it is possible to authenticate a user (by either strategy), the distinguished name (DN) has to be obtained from the login name supplied to the application. This can be done either by simple pattern-matching (by setting the <code class="literal">setUserDnPatterns</code> array property) or by setting the <code class="literal">userSearch</code> property. For the DN pattern-matching approach, a standard Java pattern format is used, and the login name will be substituted for the parameter <code class="literal">{0}</code>. The pattern should be relative to the DN that the configured <code class="literal">SpringSecurityContextSource</code> will bind to (see the section on <a class="link" href="index.html#ldap-context-source" title="30.4.2&nbsp;Connecting to the LDAP Server">connecting to the LDAP server</a> for more information on this). For example, if you are using an LDAP server with the URL <code class="literal">ldap://monkeymachine.co.uk/dc=springframework,dc=org</code>, and have a pattern <code class="literal">uid={0},ou=greatapes</code>, then a login name of "gorilla" will map to a DN <code class="literal">uid=gorilla,ou=greatapes,dc=springframework,dc=org</code>. Each configured DN pattern will be tried in turn until a match is found. For information on using a search, see the section on <a class="link" href="index.html#ldap-searchobjects" title="30.4.3&nbsp;LDAP Search Objects">search objects</a> below. A combination of the two approaches can also be used - the patterns will be checked first and if no matching DN is found, the search will be used.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="ldap-ldap-authenticators-bind" href="index.html#ldap-ldap-authenticators-bind"></a>BindAuthenticator</h4></div></div></div>
<p>The class <code class="literal">BindAuthenticator</code> in the package <code class="literal">org.springframework.security.ldap.authentication</code> implements the bind authentication strategy. It simply attempts to bind as the user.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="ldap-ldap-authenticators-password" href="index.html#ldap-ldap-authenticators-password"></a>PasswordComparisonAuthenticator</h4></div></div></div>
<p>The class <code class="literal">PasswordComparisonAuthenticator</code> implements the password comparison authentication strategy.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ldap-context-source" href="index.html#ldap-context-source"></a>30.4.2&nbsp;Connecting to the LDAP Server</h3></div></div></div>
<p>The beans discussed above have to be able to connect to the server. They both have to be supplied with a <code class="literal">SpringSecurityContextSource</code> which is an extension of Spring LDAP&#8217;s <code class="literal">ContextSource</code>. Unless you have special requirements, you will usually configure a <code class="literal">DefaultSpringSecurityContextSource</code> bean, which can be configured with the URL of your LDAP server and optionally with the username and password of a "manager" user which will be used by default when binding to the server (instead of binding anonymously). For more information read the Javadoc for this class and for Spring LDAP&#8217;s <code class="literal">AbstractContextSource</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ldap-searchobjects" href="index.html#ldap-searchobjects"></a>30.4.3&nbsp;LDAP Search Objects</h3></div></div></div>
<p>Often a more complicated strategy than simple DN-matching is required to locate a user entry in the directory. This can be encapsulated in an <code class="literal">LdapUserSearch</code> instance which can be supplied to the authenticator implementations, for example, to allow them to locate a user. The supplied implementation is <code class="literal">FilterBasedLdapUserSearch</code>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="ldap-searchobjects-filter" href="index.html#ldap-searchobjects-filter"></a>FilterBasedLdapUserSearch</h4></div></div></div>
<p>This bean uses an LDAP filter to match the user object in the directory. The process is explained in the Javadoc for the corresponding search method on the <a class="ulink" href="http://java.sun.com/j2se/1.4.2/docs/api/javax/naming/directory/DirContext.html#search(javax.naming.Name%2C%2520java.lang.String%2C%2520java.lang.Object%5B%5D%2C%2520javax.naming.directory.SearchControls)" target="_top">JDK DirContext class</a>. As explained there, the search filter can be supplied with parameters. For this class, the only valid parameter is <code class="literal">{0}</code> which will be replaced with the user&#8217;s login name.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ldap-authorities" href="index.html#ldap-authorities"></a>30.4.4&nbsp;LdapAuthoritiesPopulator</h3></div></div></div>
<p>After authenticating the user successfully, the <code class="literal">LdapAuthenticationProvider</code> will attempt to load a set of authorities for the user by calling the configured <code class="literal">LdapAuthoritiesPopulator</code> bean. The <code class="literal">DefaultLdapAuthoritiesPopulator</code> is an implementation which will load the authorities by searching the directory for groups of which the user is a member (typically these will be <code class="literal">groupOfNames</code> or <code class="literal">groupOfUniqueNames</code> entries in the directory). Consult the Javadoc for this class for more details on how it works.</p>
<p>If you want to use LDAP only for authentication, but load the authorities from a difference source (such as a database) then you can provide your own implementation of this interface and inject that instead.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ldap-bean-config" href="index.html#ldap-bean-config"></a>30.4.5&nbsp;Spring Bean Configuration</h3></div></div></div>
<p>A typical configuration, using some of the beans we&#8217;ve discussed here, might look like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"contextSource"</span>
		<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.ldap.DefaultSpringSecurityContextSource"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"ldap://monkeymachine:389/dc=springframework,dc=org"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"userDn"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"cn=manager,dc=springframework,dc=org"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"password"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ldapAuthProvider"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.ldap.authentication.LdapAuthenticationProvider"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;constructor-arg&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.ldap.authentication.BindAuthenticator"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"contextSource"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"userDnPatterns"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;list&gt;</span><span class="hl-tag">&lt;value&gt;</span>uid={0},ou=people<span class="hl-tag">&lt;/value&gt;</span><span class="hl-tag">&lt;/list&gt;</span>
	<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;constructor-arg&gt;</span>
<span class="hl-tag">&lt;bean</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.ldap.userdetails.DefaultLdapAuthoritiesPopulator"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"contextSource"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"ou=groups"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"groupRoleAttribute"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"ou"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>This would set up the provider to access an LDAP server with URL <code class="literal">ldap://monkeymachine:389/dc=springframework,dc=org</code>. Authentication will be performed by attempting to bind with the DN <code class="literal">uid=&lt;user-login-name&gt;,ou=people,dc=springframework,dc=org</code>. After successful authentication, roles will be assigned to the user by searching under the DN <code class="literal">ou=groups,dc=springframework,dc=org</code> with the default filter <code class="literal">(member=&lt;user&#8217;s-DN&gt;)</code>. The role name will be taken from the "ou" attribute of each match.</p>
<p>To configure a user search object, which uses the filter <code class="literal">(uid=&lt;user-login-name&gt;)</code> for use instead of the DN-pattern (or in addition to it), you would configure the following bean</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userSearch"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.ldap.search.FilterBasedLdapUserSearch"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">index</span>=<span class="hl-value">"0"</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">index</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"(uid={0})"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">index</span>=<span class="hl-value">"2"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"contextSource"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>and use it by setting the <code class="literal">BindAuthenticator</code> bean&#8217;s <code class="literal">userSearch</code> property. The authenticator would then call the search object to obtain the correct user&#8217;s DN before attempting to bind as this user.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ldap-custom-user-details" href="index.html#ldap-custom-user-details"></a>30.4.6&nbsp;LDAP Attributes and Customized UserDetails</h3></div></div></div>
<p>The net result of an authentication using <code class="literal">LdapAuthenticationProvider</code> is the same as a normal Spring Security authentication using the standard <code class="literal">UserDetailsService</code> interface. A <code class="literal">UserDetails</code> object is created and stored in the returned <code class="literal">Authentication</code> object. As with using a <code class="literal">UserDetailsService</code>, a common requirement is to be able to customize this implementation and add extra properties. When using LDAP, these will normally be attributes from the user entry. The creation of the <code class="literal">UserDetails</code> object is controlled by the provider&#8217;s <code class="literal">UserDetailsContextMapper</code> strategy, which is responsible for mapping user objects to and from LDAP context data:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> UserDetailsContextMapper {

UserDetails mapUserFromContext(DirContextOperations ctx, String username,
		Collection&lt;GrantedAuthority&gt; authorities);

<span class="hl-keyword">void</span> mapUserToContext(UserDetails user, DirContextAdapter ctx);
}</pre>
<p>Only the first method is relevant for authentication. If you provide an implementation of this interface and inject it into the <code class="literal">LdapAuthenticationProvider</code>, you have control over exactly how the UserDetails object is created. The first parameter is an instance of Spring LDAP&#8217;s <code class="literal">DirContextOperations</code> which gives you access to the LDAP attributes which were loaded during authentication. The <code class="literal">username</code> parameter is the name used to authenticate and the final parameter is the collection of authorities loaded for the user by the configured <code class="literal">LdapAuthoritiesPopulator</code>.</p>
<p>The way the context data is loaded varies slightly depending on the type of authentication you are using. With the <code class="literal">BindAuthenticator</code>, the context returned from the bind operation will be used to read the attributes, otherwise the data will be read using the standard context obtained from the configured <code class="literal">ContextSource</code> (when a search is configured to locate the user, this will be the data returned by the search object).</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ldap-active-directory" href="index.html#ldap-active-directory"></a>30.5&nbsp;Active Directory Authentication</h2></div></div></div>
<p>Active Directory supports its own non-standard authentication options, and the normal usage pattern doesn&#8217;t fit too cleanly with the standard <code class="literal">LdapAuthenticationProvider</code>. Typically authentication is performed using the domain username (in the form <code class="literal"><a href="https://docs.spring.io/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="f98c8a9c8bb99d9694989097">[email&#160;protected]</a></code>), rather than using an LDAP distinguished name. To make this easier, Spring Security 3.1 has an authentication provider which is customized for a typical Active Directory setup.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="activedirectoryldapauthenticationprovider" href="index.html#activedirectoryldapauthenticationprovider"></a>30.5.1&nbsp;ActiveDirectoryLdapAuthenticationProvider</h3></div></div></div>
<p>Configuring <code class="literal">ActiveDirectoryLdapAuthenticationProvider</code> is quite straightforward. You just need to supply the domain name and an LDAP URL supplying the address of the server <a href="index.html#ftn.d5e5447" class="footnote" name="d5e5447"><sup class="footnote">[20]</sup></a>. An example configuration would then look like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"adAuthenticationProvider"</span>
<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.ldap.authentication.ad.ActiveDirectoryLdapAuthenticationProvider"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"mydomain.com"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"ldap://adserver.mydomain.com/"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>
}</pre>
<p>Note that there is no need to specify a separate <code class="literal">ContextSource</code> in order to define the server location - the bean is completely self-contained. A user named "Sharon", for example, would then be able to authenticate by entering either the username <code class="literal">sharon</code> or the full Active Directory <code class="literal">userPrincipalName</code>, namely <code class="literal"><a href="https://docs.spring.io/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="57243f36253839173a2e33383a363e397934383a">[email&#160;protected]</a></code>. The user&#8217;s directory entry will then be located, and the attributes returned for possible use in customizing the created <code class="literal">UserDetails</code> object (a <code class="literal">UserDetailsContextMapper</code> can be injected for this purpose, as described above). All interaction with the directory takes place with the identity of the user themselves. There is no concept of a "manager" user.</p>
<p>By default, the user authorities are obtained from the <code class="literal">memberOf</code> attribute values of the user entry. The authorities allocated to the user can again be customized using a <code class="literal">UserDetailsContextMapper</code>. You can also inject a <code class="literal">GrantedAuthoritiesMapper</code> into the provider instance to control the authorities which end up in the <code class="literal">Authentication</code> object.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="active-directory-error-codes" href="index.html#active-directory-error-codes"></a>Active Directory Error Codes</h4></div></div></div>
<p>By default, a failed result will cause a standard Spring Security <code class="literal">BadCredentialsException</code>. If you set the property <code class="literal">convertSubErrorCodesToExceptions</code> to <code class="literal">true</code>, the exception messages will be parsed to attempt to extract the Active Directory-specific error code and raise a more specific exception. Check the class Javadoc for more information.</p>
</div>
</div>
</div>
<div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.d5e5325" class="footnote"><p><a href="index.html#d5e5325" class="simpara"><sup class="simpara">[19] </sup></a>Note that this is different from the default configuration of the underlying <code class="literal">DefaultLdapAuthoritiesPopulator</code> which uses <code class="literal">member={0}</code>.</p></div><div id="ftn.d5e5447" class="footnote"><p><a href="index.html#d5e5447" class="simpara"><sup class="simpara">[20] </sup></a>It is also possible to obtain the server&#8217;s IP address using a DNS lookup. This is not currently supported, but hopefully will be in a future version.</p></div></div></div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="oauth2login-advanced" href="index.html#oauth2login-advanced"></a>31.&nbsp;OAuth 2.0 Login&#8201;&#8212;&#8201;Advanced Configuration</h2></div></div></div>
<p><code class="literal">HttpSecurity.oauth2Login()</code> provides a number of configuration options for customizing OAuth 2.0 Login.
The main configuration options are grouped into their protocol endpoint counterparts.</p>
<p>For example, <code class="literal">oauth2Login().authorizationEndpoint()</code> allows configuring the <span class="emphasis"><em>Authorization Endpoint</em></span>,
whereas <code class="literal">oauth2Login().tokenEndpoint()</code> allows configuring the <span class="emphasis"><em>Token Endpoint</em></span>.</p>
<p>The following code shows an example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OAuth2LoginSecurityConfig <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			.oauth2Login()
				.authorizationEndpoint()
					...
				.redirectionEndpoint()
					...
				.tokenEndpoint()
					...
				.userInfoEndpoint()
					...
	}
}</pre>
<p>The main goal of the <code class="literal">oauth2Login()</code> DSL was to closely align with the naming, as defined in the specifications.</p>
<p>The OAuth 2.0 Authorization Framework defines the <a class="ulink" href="https://tools.ietf.org/html/rfc6749#section-3" target="_top">Protocol Endpoints</a> as follows:</p>
<p>The authorization process utilizes two authorization server endpoints (HTTP resources):</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Authorization Endpoint: Used by the client to obtain authorization from the resource owner via user-agent redirection.
</li><li class="listitem">
Token Endpoint: Used by the client to exchange an authorization grant for an access token, typically with client authentication.
</li></ul></div>
<p>As well as one client endpoint:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Redirection Endpoint: Used by the authorization server to return responses
containing authorization credentials to the client via the resource owner user-agent.
</li></ul></div>
<p>The OpenID Connect Core 1.0 specification defines the <a class="ulink" href="https://openid.net/specs/openid-connect-core-1_0.html#UserInfo" target="_top">UserInfo Endpoint</a> as follows:</p>
<p>The UserInfo Endpoint is an OAuth 2.0 Protected Resource that returns claims about the authenticated end-user.
To obtain the requested claims about the end-user, the client makes a request to the UserInfo Endpoint
by using an access token obtained through OpenID Connect Authentication.
These claims are normally represented by a JSON object that contains a collection of name-value pairs for the claims.</p>
<p>The following code shows the complete configuration options available for the <code class="literal">oauth2Login()</code> DSL:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OAuth2LoginSecurityConfig <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			.oauth2Login()
				.clientRegistrationRepository(<span class="hl-keyword">this</span>.clientRegistrationRepository())
				.authorizedClientService(<span class="hl-keyword">this</span>.authorizedClientService())
				.loginPage(<span class="hl-string">"/login"</span>)
				.authorizationEndpoint()
					.baseUri(<span class="hl-keyword">this</span>.authorizationRequestBaseUri())
					.authorizationRequestRepository(<span class="hl-keyword">this</span>.authorizationRequestRepository())
					.and()
				.redirectionEndpoint()
					.baseUri(<span class="hl-keyword">this</span>.authorizationResponseBaseUri())
					.and()
				.tokenEndpoint()
					.accessTokenResponseClient(<span class="hl-keyword">this</span>.accessTokenResponseClient())
					.and()
				.userInfoEndpoint()
					.userAuthoritiesMapper(<span class="hl-keyword">this</span>.userAuthoritiesMapper())
					.userService(<span class="hl-keyword">this</span>.oauth2UserService())
					.oidcUserService(<span class="hl-keyword">this</span>.oidcUserService())
					.customUserType(GitHubOAuth2User.<span class="hl-keyword">class</span>, <span class="hl-string">"github"</span>);
	}
}</pre>
<p>The sections to follow go into more detail on each of the configuration options available:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="index.html#oauth2login-advanced-login-page" title="31.1&nbsp;OAuth 2.0 Login Page">Section&nbsp;31.1, &#8220;OAuth 2.0 Login Page&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#oauth2login-advanced-authorization-endpoint" title="31.2&nbsp;Authorization Endpoint">Section&nbsp;31.2, &#8220;Authorization Endpoint&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#oauth2login-advanced-redirection-endpoint" title="31.3&nbsp;Redirection Endpoint">Section&nbsp;31.3, &#8220;Redirection Endpoint&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#oauth2login-advanced-token-endpoint" title="31.4&nbsp;Token Endpoint">Section&nbsp;31.4, &#8220;Token Endpoint&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#oauth2login-advanced-userinfo-endpoint" title="31.5&nbsp;UserInfo Endpoint">Section&nbsp;31.5, &#8220;UserInfo Endpoint&#8221;</a>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oauth2login-advanced-login-page" href="index.html#oauth2login-advanced-login-page"></a>31.1&nbsp;OAuth 2.0 Login Page</h2></div></div></div>
<p>By default, the OAuth 2.0 Login Page is auto-generated by the <code class="literal">DefaultLoginPageGeneratingFilter</code>.
The default login page shows each configured OAuth Client with its <code class="literal">ClientRegistration.clientName</code>
as a link, which is capable of initiating the Authorization Request (or OAuth 2.0 Login).</p>
<p>The link&#8217;s destination for each OAuth Client defaults to the following:</p>
<p><code class="literal">OAuth2AuthorizationRequestRedirectFilter.DEFAULT_AUTHORIZATION_REQUEST_BASE_URI</code> + "/{registrationId}"</p>
<p>The following line shows an example:</p>
<pre class="programlisting">&lt;a <span class="hl-attribute">href</span>=<span class="hl-value">"/oauth2/authorization/google"</span>&gt;Google&lt;/a&gt;</pre>
<p>To override the default login page,
configure <code class="literal">oauth2Login().loginPage()</code> and (optionally) <code class="literal">oauth2Login().authorizationEndpoint().baseUri()</code>.</p>
<p>The following listing shows an example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OAuth2LoginSecurityConfig <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			.oauth2Login()
				.loginPage(<span class="hl-string">"/login/oauth2"</span>)
				...
				.authorizationEndpoint()
					.baseUri(<span class="hl-string">"/login/oauth2/authorization"</span>)
					....
	}
}</pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>You need to provide a <code class="literal">@Controller</code> with a <code class="literal">@RequestMapping("/login/oauth2")</code> that is capable of rendering the custom login page.</p>
</td></tr></table></div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>As noted earlier, configuring <code class="literal">oauth2Login().authorizationEndpoint().baseUri()</code> is optional.
However, if you choose to customize it, ensure the link to each OAuth Client matches the <code class="literal">authorizationEndpoint().baseUri()</code>.</p>
<p>The following line shows an example:</p>
<pre class="programlisting">&lt;a <span class="hl-attribute">href</span>=<span class="hl-value">"/login/oauth2/authorization/google"</span>&gt;Google&lt;/a&gt;</pre>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oauth2login-advanced-authorization-endpoint" href="index.html#oauth2login-advanced-authorization-endpoint"></a>31.2&nbsp;Authorization Endpoint</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="oauth2login-advanced-authorization-request-repository" href="index.html#oauth2login-advanced-authorization-request-repository"></a>31.2.1&nbsp;<code class="literal">AuthorizationRequestRepository</code></h3></div></div></div>
<p><code class="literal">AuthorizationRequestRepository</code> is responsible for the persistence of the <code class="literal">OAuth2AuthorizationRequest</code>
from the time the Authorization Request is initiated to the time the Authorization Response
is received (the callback).</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">OAuth2AuthorizationRequest</code> is used to correlate and validate the Authorization Response.</p>
</td></tr></table></div>
<p>The default implementation of <code class="literal">AuthorizationRequestRepository</code> is <code class="literal">HttpSessionOAuth2AuthorizationRequestRepository</code>,
which stores the <code class="literal">OAuth2AuthorizationRequest</code> in the <code class="literal">HttpSession</code>.</p>
<p>If you would like to provide a custom implementation of <code class="literal">AuthorizationRequestRepository</code>
that stores the attributes of <code class="literal">OAuth2AuthorizationRequest</code> in a <code class="literal">Cookie</code>,
configure it as shown in the following example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OAuth2LoginSecurityConfig <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			.oauth2Login()
				.authorizationEndpoint()
					.authorizationRequestRepository(<span class="hl-keyword">this</span>.cookieAuthorizationRequestRepository())
					...
	}

	<span class="hl-keyword">private</span> AuthorizationRequestRepository&lt;OAuth2AuthorizationRequest&gt; cookieAuthorizationRequestRepository() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> HttpCookieOAuth2AuthorizationRequestRepository();
	}
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oauth2login-advanced-redirection-endpoint" href="index.html#oauth2login-advanced-redirection-endpoint"></a>31.3&nbsp;Redirection Endpoint</h2></div></div></div>
<p>The Redirection Endpoint is used by the Authorization Server for returning the Authorization Response
(which contains the authorization credentials) to the client via the Resource Owner user-agent.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>OAuth 2.0 Login leverages the Authorization Code Grant. Therefore, the authorization credential is the authorization code.</p>
</td></tr></table></div>
<p>The default Authorization Response <code class="literal">baseUri</code> (redirection endpoint) is <code class="literal"><span class="strong"><strong>/login/oauth2/code/</strong></span>*</code>, which is defined in <code class="literal">OAuth2LoginAuthenticationFilter.DEFAULT_FILTER_PROCESSES_URI</code>.</p>
<p>If you would like to customize the Authorization Response <code class="literal">baseUri</code>, configure it as shown in the following example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OAuth2LoginSecurityConfig <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			.oauth2Login()
				.redirectionEndpoint()
					.baseUri(<span class="hl-string">"/login/oauth2/callback/*"</span>)
					....
	}
}</pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>You also need to ensure the <code class="literal">ClientRegistration.redirectUriTemplate</code> matches the custom Authorization Response <code class="literal">baseUri</code>.</p>
<p>The following listing shows an example:</p>
<pre class="programlisting"><span class="hl-keyword">return</span> CommonOAuth2Provider.GOOGLE.getBuilder(<span class="hl-string">"google"</span>)
	.clientId(<span class="hl-string">"google-client-id"</span>)
	.clientSecret(<span class="hl-string">"google-client-secret"</span>)
	.redirectUriTemplate(<span class="hl-string">"{baseUrl}/login/oauth2/callback/{registrationId}"</span>)
	.build();</pre>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oauth2login-advanced-token-endpoint" href="index.html#oauth2login-advanced-token-endpoint"></a>31.4&nbsp;Token Endpoint</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="oauth2login-advanced-token-client" href="index.html#oauth2login-advanced-token-client"></a>31.4.1&nbsp;OAuth2AccessTokenResponseClient</h3></div></div></div>
<p><code class="literal">OAuth2AccessTokenResponseClient</code> is responsible for exchanging an authorization grant credential
for an access token credential at the Authorization Server&#8217;s Token Endpoint.</p>
<p>The default implementation of <code class="literal">OAuth2AccessTokenResponseClient</code> is <code class="literal">NimbusAuthorizationCodeTokenResponseClient</code>,
which exchanges an authorization code for an access token at the Token Endpoint.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">NimbusAuthorizationCodeTokenResponseClient</code> uses the <a class="ulink" href="https://connect2id.com/products/nimbus-oauth-openid-connect-sdk" target="_top">Nimbus OAuth 2.0 SDK</a> internally.</p>
</td></tr></table></div>
<p>If you would like to provide a custom implementation of <code class="literal">OAuth2AccessTokenResponseClient</code>
that uses Spring Framework 5 reactive <code class="literal">WebClient</code> for initiating requests to the Token Endpoint,
configure it as shown in the following example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OAuth2LoginSecurityConfig <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			.oauth2Login()
				.tokenEndpoint()
					.accessTokenResponseClient(<span class="hl-keyword">this</span>.accessTokenResponseClient())
					...
	}

	<span class="hl-keyword">private</span> OAuth2AccessTokenResponseClient&lt;OAuth2AuthorizationCodeGrantRequest&gt; accessTokenResponseClient() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SpringWebClientAuthorizationCodeTokenResponseClient();
	}
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="oauth2login-advanced-userinfo-endpoint" href="index.html#oauth2login-advanced-userinfo-endpoint"></a>31.5&nbsp;UserInfo Endpoint</h2></div></div></div>
<p>The UserInfo Endpoint includes a number of configuration options, as described in the following sub-sections:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="index.html#oauth2login-advanced-map-authorities" title="31.5.1&nbsp;Mapping User Authorities">Section&nbsp;31.5.1, &#8220;Mapping User Authorities&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#oauth2login-advanced-custom-user" title="31.5.2&nbsp;Configuring a Custom OAuth2User">Section&nbsp;31.5.2, &#8220;Configuring a Custom OAuth2User&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#oauth2login-advanced-oauth2-user-service" title="31.5.3&nbsp;OAuth 2.0 UserService">Section&nbsp;31.5.3, &#8220;OAuth 2.0 UserService&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#oauth2login-advanced-oidc-user-service" title="31.5.4&nbsp;OpenID Connect 1.0 UserService">Section&nbsp;31.5.4, &#8220;OpenID Connect 1.0 UserService&#8221;</a>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="oauth2login-advanced-map-authorities" href="index.html#oauth2login-advanced-map-authorities"></a>31.5.1&nbsp;Mapping User Authorities</h3></div></div></div>
<p>After the user successfully authenticates with the OAuth 2.0 Provider,
the <code class="literal">OAuth2User.getAuthorities()</code> may be mapped to a new set of <code class="literal">GrantedAuthority</code> instances, which are then supplied to <code class="literal">OAuth2AuthenticationToken</code>.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p><code class="literal">OAuth2AuthenticationToken.getAuthorities()</code> is used for authorizing requests, such as in <code class="literal">hasRole('USER')</code> or <code class="literal">hasRole('ADMIN')</code>.</p>
</td></tr></table></div>
<p>In order to map user authorities, you need to provide an implementation of <code class="literal">GrantedAuthoritiesMapper</code>
and configure it as shown in the following example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OAuth2LoginSecurityConfig <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			.oauth2Login()
				.userInfoEndpoint()
					.userAuthoritiesMapper(<span class="hl-keyword">this</span>.userAuthoritiesMapper())
					...
	}

	<span class="hl-keyword">private</span> GrantedAuthoritiesMapper userAuthoritiesMapper() {
		<span class="hl-keyword">return</span> (authorities) -&gt; {
			Set&lt;GrantedAuthority&gt; mappedAuthorities = <span class="hl-keyword">new</span> HashSet&lt;&gt;();

			authorities.forEach(authority -&gt; {
				<span class="hl-keyword">if</span> (OidcUserAuthority.<span class="hl-keyword">class</span>.isInstance(authority)) {
					OidcUserAuthority oidcUserAuthority = (OidcUserAuthority)authority;

					OidcIdToken idToken = oidcUserAuthority.getIdToken();
					OidcUserInfo userInfo = oidcUserAuthority.getUserInfo();

					<span class="hl-comment">// Map the claims found in idToken and/or userInfo</span>
					<span class="hl-comment">// to one or more GrantedAuthority's and add it to mappedAuthorities</span>

				} <span class="hl-keyword">else</span> <span class="hl-keyword">if</span> (OAuth2UserAuthority.<span class="hl-keyword">class</span>.isInstance(authority)) {
					OAuth2UserAuthority oauth2UserAuthority = (OAuth2UserAuthority)authority;

					Map&lt;String, Object&gt; userAttributes = oauth2UserAuthority.getAttributes();

					<span class="hl-comment">// Map the attributes found in userAttributes</span>
					<span class="hl-comment">// to one or more GrantedAuthority's and add it to mappedAuthorities</span>

				}
			});

			<span class="hl-keyword">return</span> mappedAuthorities;
		};
	}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="oauth2login-advanced-custom-user" href="index.html#oauth2login-advanced-custom-user"></a>31.5.2&nbsp;Configuring a Custom OAuth2User</h3></div></div></div>
<p><code class="literal">CustomUserTypesOAuth2UserService</code> is an implementation of an <code class="literal">OAuth2UserService</code>
that provides support for custom <code class="literal">OAuth2User</code> types.</p>
<p>If the default implementation (<code class="literal">DefaultOAuth2User</code>) does not suit your needs,
you can define your own implementation of <code class="literal">OAuth2User</code>.</p>
<p>The following code demonstrates how you would register a custom <code class="literal">OAuth2User</code> type for GitHub:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OAuth2LoginSecurityConfig <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			.oauth2Login()
				.userInfoEndpoint()
					.customUserType(GitHubOAuth2User.<span class="hl-keyword">class</span>, <span class="hl-string">"github"</span>)
					...
	}
}</pre>
<p>The following code shows an example of a custom <code class="literal">OAuth2User</code> type for GitHub:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> GitHubOAuth2User <span class="hl-keyword">implements</span> OAuth2User {
	<span class="hl-keyword">private</span> List&lt;GrantedAuthority&gt; authorities =
		AuthorityUtils.createAuthorityList(<span class="hl-string">"ROLE_USER"</span>);
	<span class="hl-keyword">private</span> Map&lt;String, Object&gt; attributes;
	<span class="hl-keyword">private</span> String id;
	<span class="hl-keyword">private</span> String name;
	<span class="hl-keyword">private</span> String login;
	<span class="hl-keyword">private</span> String email;

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">public</span> Collection&lt;? <span class="hl-keyword">extends</span> GrantedAuthority&gt; getAuthorities() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.authorities;
	}

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">public</span> Map&lt;String, Object&gt; getAttributes() {
		<span class="hl-keyword">if</span> (<span class="hl-keyword">this</span>.attributes == null) {
			<span class="hl-keyword">this</span>.attributes = <span class="hl-keyword">new</span> HashMap&lt;&gt;();
			<span class="hl-keyword">this</span>.attributes.put(<span class="hl-string">"id"</span>, <span class="hl-keyword">this</span>.getId());
			<span class="hl-keyword">this</span>.attributes.put(<span class="hl-string">"name"</span>, <span class="hl-keyword">this</span>.getName());
			<span class="hl-keyword">this</span>.attributes.put(<span class="hl-string">"login"</span>, <span class="hl-keyword">this</span>.getLogin());
			<span class="hl-keyword">this</span>.attributes.put(<span class="hl-string">"email"</span>, <span class="hl-keyword">this</span>.getEmail());
		}
		<span class="hl-keyword">return</span> attributes;
	}

	<span class="hl-keyword">public</span> String getId() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.id;
	}

	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setId(String id) {
		<span class="hl-keyword">this</span>.id = id;
	}

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">public</span> String getName() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.name;
	}

	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setName(String name) {
		<span class="hl-keyword">this</span>.name = name;
	}

	<span class="hl-keyword">public</span> String getLogin() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.login;
	}

	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setLogin(String login) {
		<span class="hl-keyword">this</span>.login = login;
	}

	<span class="hl-keyword">public</span> String getEmail() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.email;
	}

	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setEmail(String email) {
		<span class="hl-keyword">this</span>.email = email;
	}
}</pre>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p><code class="literal">id</code>, <code class="literal">name</code>, <code class="literal">login</code>, and <code class="literal">email</code> are attributes returned in GitHub&#8217;s UserInfo Response.
For detailed information returned from the UserInfo Endpoint, see the API documentation
for <a class="ulink" href="https://developer.github.com/v3/users/#get-the-authenticated-user" target="_top">"Get the authenticated user"</a>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="oauth2login-advanced-oauth2-user-service" href="index.html#oauth2login-advanced-oauth2-user-service"></a>31.5.3&nbsp;OAuth 2.0 UserService</h3></div></div></div>
<p><code class="literal">DefaultOAuth2UserService</code> is an implementation of an <code class="literal">OAuth2UserService</code>
that supports standard OAuth 2.0 Provider&#8217;s.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">OAuth2UserService</code> obtains the user attributes
of the end-user (the resource owner) from the UserInfo Endpoint (by using the
access token granted to the client during the authorization flow)
and returns an <code class="literal">AuthenticatedPrincipal</code> in the form of an <code class="literal">OAuth2User</code>.</p>
</td></tr></table></div>
<p>If the default implementation does not suit your needs, you can define your own implementation of <code class="literal">OAuth2UserService</code>
for standard OAuth 2.0 Provider&#8217;s.</p>
<p>The following configuration demonstrates how to configure a custom <code class="literal">OAuth2UserService</code>:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OAuth2LoginSecurityConfig <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			.oauth2Login()
				.userInfoEndpoint()
					.userService(<span class="hl-keyword">this</span>.oauth2UserService())
					...
	}

	<span class="hl-keyword">private</span> OAuth2UserService&lt;OAuth2UserRequest, OAuth2User&gt; oauth2UserService() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CustomOAuth2UserService();
	}
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="oauth2login-advanced-oidc-user-service" href="index.html#oauth2login-advanced-oidc-user-service"></a>31.5.4&nbsp;OpenID Connect 1.0 UserService</h3></div></div></div>
<p><code class="literal">OidcUserService</code> is an implementation of an <code class="literal">OAuth2UserService</code>
that supports OpenID Connect 1.0 Provider&#8217;s.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">OAuth2UserService</code> is responsible for obtaining the user attributes
of the end user (the resource owner) from the UserInfo Endpoint (by using the
access token granted to the client during the authorization flow)
and return an <code class="literal">AuthenticatedPrincipal</code> in the form of an <code class="literal">OidcUser</code>.</p>
</td></tr></table></div>
<p>If the default implementation does not suit your needs, you can define your own implementation of <code class="literal">OAuth2UserService</code>
for OpenID Connect 1.0 Provider&#8217;s.</p>
<p>The following configuration demonstrates how to configure a custom OpenID Connect 1.0 <code class="literal">OAuth2UserService</code>:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OAuth2LoginSecurityConfig <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
		http
			.oauth2Login()
				.userInfoEndpoint()
					.oidcUserService(<span class="hl-keyword">this</span>.oidcUserService())
					...
	}

	<span class="hl-keyword">private</span> OAuth2UserService&lt;OidcUserRequest, OidcUser&gt; oidcUserService() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CustomOidcUserService();
	}
}</pre>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="taglibs" href="index.html#taglibs"></a>32.&nbsp;JSP Tag Libraries</h2></div></div></div>
<p>Spring Security has its own taglib which provides basic support for accessing security information and applying security constraints in JSPs.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="declaring-the-taglib" href="index.html#declaring-the-taglib"></a>32.1&nbsp;Declaring the Taglib</h2></div></div></div>
<p>To use any of the tags, you must have the security taglib declared in your JSP:</p>
<pre class="programlisting"><span class="hl-tag">&lt;%@</span> <span class="hl-attribute">taglib</span> <span class="hl-attribute">prefix</span>=<span class="hl-value">"sec"</span> <span class="hl-attribute">uri</span>=<span class="hl-value">"http://www.springframework.org/security/tags"</span> <span class="hl-attribute">%&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="taglibs-authorize" href="index.html#taglibs-authorize"></a>32.2&nbsp;The authorize Tag</h2></div></div></div>
<p>This tag is used to determine whether its contents should be evaluated or not. In Spring Security 3.0, it can be used in two ways <a href="index.html#ftn.d5e5690" class="footnote" name="d5e5690"><sup class="footnote">[21]</sup></a>. The first approach uses a <a class="link" href="index.html#el-access-web" title="27.2&nbsp;Web Security Expressions">web-security expression</a>, specified in the <code class="literal">access</code> attribute of the tag. The expression evaluation will be delegated to the <code class="literal">SecurityExpressionHandler&lt;FilterInvocation&gt;</code> defined in the application context (you should have web expressions enabled in your <code class="literal">&lt;http&gt;</code> namespace configuration to make sure this service is available). So, for example, you might have</p>
<pre class="programlisting"><span class="hl-tag">&lt;sec:authorize</span> <span class="hl-attribute">access</span>=<span class="hl-value">"hasRole('supervisor')"</span><span class="hl-tag">&gt;</span>

This content will only be visible to users who have the "supervisor" authority in their list of <span class="hl-tag">&lt;tt&gt;</span>GrantedAuthority<span class="hl-tag">&lt;/tt&gt;</span>s.

<span class="hl-tag">&lt;/sec:authorize&gt;</span></pre>
<p>When used in conjuction with Spring Security&#8217;s PermissionEvaluator, the tag can also be used to check permissions. For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;sec:authorize</span> <span class="hl-attribute">access</span>=<span class="hl-value">"hasPermission(#domain,'read') or hasPermission(#domain,'write')"</span><span class="hl-tag">&gt;</span>

This content will only be visible to users who have read or write permission to the Object found as a request attribute named "domain".

<span class="hl-tag">&lt;/sec:authorize&gt;</span></pre>
<p>A common requirement is to only show a particular link, if the user is actually allowed to click it. How can we determine in advance whether something will be allowed? This tag can also operate in an alternative mode which allows you to define a particular URL as an attribute. If the user is allowed to invoke that URL, then the tag body will be evaluated, otherwise it will be skipped. So you might have something like</p>
<pre class="programlisting"><span class="hl-tag">&lt;sec:authorize</span> <span class="hl-attribute">url</span>=<span class="hl-value">"/admin"</span><span class="hl-tag">&gt;</span>

This content will only be visible to users who are authorized to send requests to the "/admin" URL.

<span class="hl-tag">&lt;/sec:authorize&gt;</span></pre>
<p>To use this tag there must also be an instance of <code class="literal">WebInvocationPrivilegeEvaluator</code> in your application context. If you are using the namespace, one will automatically be registered. This is an instance of <code class="literal">DefaultWebInvocationPrivilegeEvaluator</code>, which creates a dummy web request for the supplied URL and invokes the security interceptor to see whether the request would succeed or fail. This allows you to delegate to the access-control setup you defined using <code class="literal">intercept-url</code> declarations within the <code class="literal">&lt;http&gt;</code> namespace configuration and saves having to duplicate the information (such as the required roles) within your JSPs. This approach can also be combined with a <code class="literal">method</code> attribute, supplying the HTTP method, for a more specific match.</p>
<p>The Boolean result of evaluating the tag (whether it grants or denies access) can be stored in a page context scope variable by setting the <code class="literal">var</code> attribute to the variable name, avoiding the need for duplicating and re-evaluating the condition at other points in the page.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="disabling-tag-authorization-for-testing" href="index.html#disabling-tag-authorization-for-testing"></a>32.2.1&nbsp;Disabling Tag Authorization for Testing</h3></div></div></div>
<p>Hiding a link in a page for unauthorized users doesn&#8217;t prevent them from accessing the URL. They could just type it into their browser directly, for example. As part of your testing process, you may want to reveal the hidden areas in order to check that links really are secured at the back end. If you set the system property <code class="literal">spring.security.disableUISecurity</code> to <code class="literal">true</code>, the <code class="literal">authorize</code> tag will still run but will not hide its contents. By default it will also surround the content with <code class="literal">&lt;span class="securityHiddenUI"&gt;&#8230;&#8203;&lt;/span&gt;</code> tags. This allows you to display "hidden" content with a particular CSS style such as a different background colour. Try running the "tutorial" sample application with this property enabled, for example.</p>
<p>You can also set the properties <code class="literal">spring.security.securedUIPrefix</code> and <code class="literal">spring.security.securedUISuffix</code> if you want to change surrounding text from the default <code class="literal">span</code> tags (or use empty strings to remove it completely).</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="the-authentication-tag" href="index.html#the-authentication-tag"></a>32.3&nbsp;The authentication Tag</h2></div></div></div>
<p>This tag allows access to the current <code class="literal">Authentication</code> object stored in the security context. It renders a property of the object directly in the JSP. So, for example, if the <code class="literal">principal</code> property of the <code class="literal">Authentication</code> is an instance of Spring Security&#8217;s <code class="literal">UserDetails</code> object, then using <code class="literal">&lt;sec:authentication property="principal.username" /&gt;</code> will render the name of the current user.</p>
<p>Of course, it isn&#8217;t necessary to use JSP tags for this kind of thing and some people prefer to keep as little logic as possible in the view. You can access the <code class="literal">Authentication</code> object in your MVC controller (by calling <code class="literal">SecurityContextHolder.getContext().getAuthentication()</code>) and add the data directly to your model for rendering by the view.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="the-accesscontrollist-tag" href="index.html#the-accesscontrollist-tag"></a>32.4&nbsp;The accesscontrollist Tag</h2></div></div></div>
<p>This tag is only valid when used with Spring Security&#8217;s ACL module. It checks a comma-separated list of required permissions for a specified domain object. If the current user has all of those permissions, then the tag body will be evaluated. If they don&#8217;t, it will be skipped. An example might be</p>
<div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/caution.png"></td><th align="left">Caution</th></tr><tr><td align="left" valign="top">
<p>In general this tag should be considered deprecated. Instead use the <a class="xref" href="index.html#taglibs-authorize" title="32.2&nbsp;The authorize Tag">Section&nbsp;32.2, &#8220;The authorize Tag&#8221;</a>.</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;sec:accesscontrollist</span> <span class="hl-attribute">hasPermission</span>=<span class="hl-value">"1,2"</span> <span class="hl-attribute">domainObject</span>=<span class="hl-value">"${someObject}"</span><span class="hl-tag">&gt;</span>

This will be shown if the user has all of the permissions represented by the values "1" or "2" on the given object.

<span class="hl-tag">&lt;/sec:accesscontrollist&gt;</span></pre>
<p>The permissions are passed to the <code class="literal">PermissionFactory</code> defined in the application context, converting them to ACL <code class="literal">Permission</code> instances, so they may be any format which is supported by the factory - they don&#8217;t have to be integers, they could be strings like <code class="literal">READ</code> or <code class="literal">WRITE</code>. If no <code class="literal">PermissionFactory</code> is found, an instance of <code class="literal">DefaultPermissionFactory</code> will be used. The <code class="literal">AclService</code> from the application context will be used to load the <code class="literal">Acl</code> instance for the supplied object. The <code class="literal">Acl</code> will be invoked with the required permissions to check if all of them are granted.</p>
<p>This tag also supports the <code class="literal">var</code> attribute, in the same way as the <code class="literal">authorize</code> tag.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="the-csrfinput-tag" href="index.html#the-csrfinput-tag"></a>32.5&nbsp;The csrfInput Tag</h2></div></div></div>
<p>If CSRF protection is enabled, this tag inserts a hidden form field with the correct name and value for the CSRF protection token. If CSRF protection is not enabled, this tag outputs nothing.</p>
<p>Normally Spring Security automatically inserts a CSRF form field for any <code class="literal">&lt;form:form&gt;</code> tags you use, but if for some reason you cannot use <code class="literal">&lt;form:form&gt;</code>, <code class="literal">csrfInput</code> is a handy replacement.</p>
<p>You should place this tag within an HTML <code class="literal">&lt;form&gt;&lt;/form&gt;</code> block, where you would normally place other input fields. Do NOT place this tag within a Spring <code class="literal">&lt;form:form&gt;&lt;/form:form&gt;</code> block. Spring Security handles Spring forms automatically.</p>
<pre class="programlisting">	<span class="hl-tag">&lt;form</span> <span class="hl-attribute">method</span>=<span class="hl-value">"post"</span> <span class="hl-attribute">action</span>=<span class="hl-value">"/do/something"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;sec:csrfInput /&gt;</span>
		Name:<span class="hl-tag">&lt;br /&gt;</span>
		<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span><span class="hl-tag"> /&gt;</span>
		...
	<span class="hl-tag">&lt;/form&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="the-csrfmetatags-tag" href="index.html#the-csrfmetatags-tag"></a>32.6&nbsp;The csrfMetaTags Tag</h2></div></div></div>
<p>If CSRF protection is enabled, this tag inserts meta tags containing the CSRF protection token form field and header names and CSRF protection token value. These meta tags are useful for employing CSRF protection within JavaScript in your applications.</p>
<p>You should place <code class="literal">csrfMetaTags</code> within an HTML <code class="literal">&lt;head&gt;&lt;/head&gt;</code> block, where you would normally place other meta tags. Once you use this tag, you can access the form field name, header name, and token value easily using JavaScript. JQuery is used in this example to make the task easier.</p>
<pre class="programlisting"><strong class="hl-tag" style="color: blue">&lt;!DOCTYPE html&gt;</strong>
<span class="hl-tag">&lt;html&gt;</span>
	<span class="hl-tag">&lt;head&gt;</span>
		<span class="hl-tag">&lt;title&gt;</span>CSRF Protected JavaScript Page<span class="hl-tag">&lt;/title&gt;</span>
		<span class="hl-tag">&lt;meta</span> <span class="hl-attribute">name</span>=<span class="hl-value">"description"</span> <span class="hl-attribute">content</span>=<span class="hl-value">"This is the description for this page"</span><span class="hl-tag"> /&gt;</span>
		<span class="hl-tag">&lt;sec:csrfMetaTags /&gt;</span>
		<span class="hl-tag">&lt;script</span> <span class="hl-attribute">type</span>=<span class="hl-value">"text/javascript"</span> <span class="hl-attribute">language</span>=<span class="hl-value">"javascript"</span><span class="hl-tag">&gt;</span>

			var csrfParameter = $("meta[name='_csrf_parameter']").attr("content");
			var csrfHeader = $("meta[name='_csrf_header']").attr("content");
			var csrfToken = $("meta[name='_csrf']").attr("content");

			// using XMLHttpRequest directly to send an x-www-form-urlencoded request
			var ajax = new XMLHttpRequest();
			ajax.open("POST", "http://www.example.org/do/something", true);
			ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded data");
			ajax.send(csrfParameter + "=" + csrfToken + "&amp;name=John&amp;...");

			// using XMLHttpRequest directly to send a non-x-www-form-urlencoded request
			var ajax = new XMLHttpRequest();
			ajax.open("POST", "http://www.example.org/do/something", true);
			ajax.setRequestHeader(csrfHeader, csrfToken);
			ajax.send("...");

			// using JQuery to send an x-www-form-urlencoded request
			var data = {};
			data[csrfParameter] = csrfToken;
			data["name"] = "John";
			...
			$.ajax({
				url: "http://www.example.org/do/something",
				type: "POST",
				data: data,
				...
			});

			// using JQuery to send a non-x-www-form-urlencoded request
			var headers = {};
			headers[csrfHeader] = csrfToken;
			$.ajax({
				url: "http://www.example.org/do/something",
				type: "POST",
				headers: headers,
				...
			});

		<span class="hl-tag">&lt;script&gt;</span>
	<span class="hl-tag">&lt;/head&gt;</span>
	<span class="hl-tag">&lt;body&gt;</span>
		...
	<span class="hl-tag">&lt;/body&gt;</span>
<span class="hl-tag">&lt;/html&gt;</span></pre>
<p>If CSRF protection is not enabled, <code class="literal">csrfMetaTags</code> outputs nothing.</p>
</div>
<div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.d5e5690" class="footnote"><p><a href="index.html#d5e5690" class="simpara"><sup class="simpara">[21] </sup></a>The legacy options from Spring Security 2.0 are also supported, but discouraged.</p></div></div></div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="jaas" href="index.html#jaas"></a>33.&nbsp;Java Authentication and Authorization Service (JAAS) Provider</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="overview-2" href="index.html#overview-2"></a>33.1&nbsp;Overview</h2></div></div></div>
<p>Spring Security provides a package able to delegate authentication requests to the Java Authentication and Authorization Service (JAAS). This package is discussed in detail below.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jaas-abstractjaasauthenticationprovider" href="index.html#jaas-abstractjaasauthenticationprovider"></a>33.2&nbsp;AbstractJaasAuthenticationProvider</h2></div></div></div>
<p>The <code class="literal">AbstractJaasAuthenticationProvider</code> is the basis for the provided JAAS <code class="literal">AuthenticationProvider</code> implementations. Subclasses must implement a method that creates the <code class="literal">LoginContext</code>. The <code class="literal">AbstractJaasAuthenticationProvider</code> has a number of dependencies that can be injected into it that are discussed below.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jaas-callbackhandler" href="index.html#jaas-callbackhandler"></a>33.2.1&nbsp;JAAS CallbackHandler</h3></div></div></div>
<p>Most JAAS <code class="literal">LoginModule</code> s require a callback of some sort. These callbacks are usually used to obtain the username and password from the user.</p>
<p>In a Spring Security deployment, Spring Security is responsible for this user interaction (via the authentication mechanism). Thus, by the time the authentication request is delegated through to JAAS, Spring Security&#8217;s authentication mechanism will already have fully-populated an <code class="literal">Authentication</code> object containing all the information required by the JAAS <code class="literal">LoginModule</code>.</p>
<p>Therefore, the JAAS package for Spring Security provides two default callback handlers, <code class="literal">JaasNameCallbackHandler</code> and <code class="literal">JaasPasswordCallbackHandler</code>. Each of these callback handlers implement <code class="literal">JaasAuthenticationCallbackHandler</code>. In most cases these callback handlers can simply be used without understanding the internal mechanics.</p>
<p>For those needing full control over the callback behavior, internally <code class="literal">AbstractJaasAuthenticationProvider</code> wraps these <code class="literal">JaasAuthenticationCallbackHandler</code> s with an <code class="literal">InternalCallbackHandler</code>. The <code class="literal">InternalCallbackHandler</code> is the class that actually implements JAAS normal <code class="literal">CallbackHandler</code> interface. Any time that the JAAS <code class="literal">LoginModule</code> is used, it is passed a list of application context configured <code class="literal">InternalCallbackHandler</code> s. If the <code class="literal">LoginModule</code> requests a callback against the <code class="literal">InternalCallbackHandler</code> s, the callback is in-turn passed to the <code class="literal">JaasAuthenticationCallbackHandler</code> s being wrapped.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jaas-authoritygranter" href="index.html#jaas-authoritygranter"></a>33.2.2&nbsp;JAAS AuthorityGranter</h3></div></div></div>
<p>JAAS works with principals. Even "roles" are represented as principals in JAAS. Spring Security, on the other hand, works with <code class="literal">Authentication</code> objects. Each <code class="literal">Authentication</code> object contains a single principal, and multiple <code class="literal">GrantedAuthority</code> s. To facilitate mapping between these different concepts, Spring Security&#8217;s JAAS package includes an <code class="literal">AuthorityGranter</code> interface.</p>
<p>An <code class="literal">AuthorityGranter</code> is responsible for inspecting a JAAS principal and returning a set of <code class="literal">String</code> s, representing the authorities assigned to the principal. For each returned authority string, the <code class="literal">AbstractJaasAuthenticationProvider</code> creates a <code class="literal">JaasGrantedAuthority</code> (which implements Spring Security&#8217;s <code class="literal">GrantedAuthority</code> interface) containing the authority string and the JAAS principal that the <code class="literal">AuthorityGranter</code> was passed. The <code class="literal">AbstractJaasAuthenticationProvider</code> obtains the JAAS principals by firstly successfully authenticating the user&#8217;s credentials using the JAAS <code class="literal">LoginModule</code>, and then accessing the <code class="literal">LoginContext</code> it returns. A call to <code class="literal">LoginContext.getSubject().getPrincipals()</code> is made, with each resulting principal passed to each <code class="literal">AuthorityGranter</code> defined against the <code class="literal">AbstractJaasAuthenticationProvider.setAuthorityGranters(List)</code> property.</p>
<p>Spring Security does not include any production <code class="literal">AuthorityGranter</code> s given that every JAAS principal has an implementation-specific meaning. However, there is a <code class="literal">TestAuthorityGranter</code> in the unit tests that demonstrates a simple <code class="literal">AuthorityGranter</code> implementation.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jaas-defaultjaasauthenticationprovider" href="index.html#jaas-defaultjaasauthenticationprovider"></a>33.3&nbsp;DefaultJaasAuthenticationProvider</h2></div></div></div>
<p>The <code class="literal">DefaultJaasAuthenticationProvider</code> allows a JAAS <code class="literal">Configuration</code> object to be injected into it as a dependency. It then creates a <code class="literal">LoginContext</code> using the injected JAAS <code class="literal">Configuration</code>. This means that <code class="literal">DefaultJaasAuthenticationProvider</code> is not bound any particular implementation of <code class="literal">Configuration</code> as <code class="literal">JaasAuthenticationProvider</code> is.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jaas-inmemoryconfiguration" href="index.html#jaas-inmemoryconfiguration"></a>33.3.1&nbsp;InMemoryConfiguration</h3></div></div></div>
<p>In order to make it easy to inject a <code class="literal">Configuration</code> into <code class="literal">DefaultJaasAuthenticationProvider</code>, a default in-memory implementation named <code class="literal">InMemoryConfiguration</code> is provided. The implementation constructor accepts a <code class="literal">Map</code> where each key represents a login configuration name and the value represents an <code class="literal">Array</code> of <code class="literal">AppConfigurationEntry</code> s. <code class="literal">InMemoryConfiguration</code> also supports a default <code class="literal">Array</code> of <code class="literal">AppConfigurationEntry</code> objects that will be used if no mapping is found within the provided <code class="literal">Map</code>. For details, refer to the class level javadoc of <code class="literal">InMemoryConfiguration</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jaas-djap-config" href="index.html#jaas-djap-config"></a>33.3.2&nbsp;DefaultJaasAuthenticationProvider Example Configuration</h3></div></div></div>
<p>While the Spring configuration for <code class="literal">InMemoryConfiguration</code> can be more verbose than the standarad JAAS configuration files, using it in conjuction with <code class="literal">DefaultJaasAuthenticationProvider</code> is more flexible than <code class="literal">JaasAuthenticationProvider</code> since it not dependant on the default <code class="literal">Configuration</code> implementation.</p>
<p>An example configuration of <code class="literal">DefaultJaasAuthenticationProvider</code> using <code class="literal">InMemoryConfiguration</code> is provided below. Note that custom implementations of <code class="literal">Configuration</code> can easily be injected into <code class="literal">DefaultJaasAuthenticationProvider</code> as well.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jaasAuthProvider"</span>
<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.authentication.jaas.DefaultJaasAuthenticationProvider"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"configuration"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.authentication.jaas.memory.InMemoryConfiguration"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;constructor-arg&gt;</span>
	<span class="hl-tag">&lt;map&gt;</span>
	<span class="hl-comment">&lt;!--
	SPRINGSECURITY is the default loginContextName
	for AbstractJaasAuthenticationProvider
	--&gt;</span>
	<span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"SPRINGSECURITY"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;array&gt;</span>
	<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"javax.security.auth.login.AppConfigurationEntry"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"sample.SampleLoginModule"</span><span class="hl-tag"> /&gt;</span>
		<span class="hl-tag">&lt;constructor-arg&gt;</span>
		<span class="hl-tag">&lt;util:constant</span> <span class="hl-attribute">static-field</span>=
			<span class="hl-value">"javax.security.auth.login.AppConfigurationEntry$LoginModuleControlFlag.REQUIRED"</span><span class="hl-tag">/&gt;</span>
		<span class="hl-tag">&lt;/constructor-arg&gt;</span>
		<span class="hl-tag">&lt;constructor-arg&gt;</span>
		<span class="hl-tag">&lt;map&gt;</span><span class="hl-tag">&lt;/map&gt;</span>
		<span class="hl-tag">&lt;/constructor-arg&gt;</span>
		<span class="hl-tag">&lt;/bean&gt;</span>
	<span class="hl-tag">&lt;/array&gt;</span>
	<span class="hl-tag">&lt;/entry&gt;</span>
	<span class="hl-tag">&lt;/map&gt;</span>
	<span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authorityGranters"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;list&gt;</span>
	<span class="hl-comment">&lt;!-- You will need to write your own implementation of AuthorityGranter --&gt;</span>
	<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.authentication.jaas.TestAuthorityGranter"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/list&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jaas-jaasauthenticationprovider" href="index.html#jaas-jaasauthenticationprovider"></a>33.4&nbsp;JaasAuthenticationProvider</h2></div></div></div>
<p>The <code class="literal">JaasAuthenticationProvider</code> assumes the default <code class="literal">Configuration</code> is an instance of <a class="ulink" href="http://download.oracle.com/javase/1.4.2/docs/guide/security/jaas/spec/com/sun/security/auth/login/ConfigFile.html" target="_top"> ConfigFile</a>. This assumption is made in order to attempt to update the <code class="literal">Configuration</code>. The <code class="literal">JaasAuthenticationProvider</code> then uses the default <code class="literal">Configuration</code> to create the <code class="literal">LoginContext</code>.</p>
<p>Let&#8217;s assume we have a JAAS login configuration file, <code class="literal">/WEB-INF/login.conf</code>, with the following contents:</p>
<pre class="programlisting">JAASTest {
	sample.SampleLoginModule required;
};</pre>
<p>Like all Spring Security beans, the <code class="literal">JaasAuthenticationProvider</code> is configured via the application context. The following definitions would correspond to the above JAAS login configuration file:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jaasAuthenticationProvider"</span>
<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.authentication.jaas.JaasAuthenticationProvider"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"loginConfig"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/WEB-INF/login.conf"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"loginContextName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"JAASTest"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"callbackHandlers"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;list&gt;</span>
<span class="hl-tag">&lt;bean</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.authentication.jaas.JaasNameCallbackHandler"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;bean</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.authentication.jaas.JaasPasswordCallbackHandler"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/list&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authorityGranters"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;list&gt;</span>
	<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.authentication.jaas.TestAuthorityGranter"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/list&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jaas-apiprovision" href="index.html#jaas-apiprovision"></a>33.5&nbsp;Running as a Subject</h2></div></div></div>
<p>If configured, the <code class="literal">JaasApiIntegrationFilter</code> will attempt to run as the <code class="literal">Subject</code> on the <code class="literal">JaasAuthenticationToken</code>. This means that the <code class="literal">Subject</code> can be accessed using:</p>
<pre class="programlisting">Subject subject = Subject.getSubject(AccessController.getContext());</pre>
<p>This integration can easily be configured using the <a class="link" href="index.html#nsa-http-jaas-api-provision">jaas-api-provision</a> attribute. This feature is useful when integrating with legacy or external API&#8217;s that rely on the JAAS Subject being populated.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="cas" href="index.html#cas"></a>34.&nbsp;CAS Authentication</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="cas-overview" href="index.html#cas-overview"></a>34.1&nbsp;Overview</h2></div></div></div>
<p>JA-SIG produces an enterprise-wide single sign on system known as CAS. Unlike other initiatives, JA-SIG&#8217;s Central Authentication Service is open source, widely used, simple to understand, platform independent, and supports proxy capabilities. Spring Security fully supports CAS, and provides an easy migration path from single-application deployments of Spring Security through to multiple-application deployments secured by an enterprise-wide CAS server.</p>
<p>You can learn more about CAS at <a class="ulink" href="https://www.apereo.org/" target="_top">http://www.ja-sig.org/cas</a>. You will also need to visit this site to download the CAS Server files.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="cas-how-it-works" href="index.html#cas-how-it-works"></a>34.2&nbsp;How CAS Works</h2></div></div></div>
<p>Whilst the CAS web site contains documents that detail the architecture of CAS, we present the general overview again here within the context of Spring Security. Spring Security 3.x supports CAS 3. At the time of writing, the CAS server was at version 3.4.</p>
<p>Somewhere in your enterprise you will need to setup a CAS server. The CAS server is simply a standard WAR file, so there isn&#8217;t anything difficult about setting up your server. Inside the WAR file you will customise the login and other single sign on pages displayed to users.</p>
<p>When deploying a CAS 3.4 server, you will also need to specify an <code class="literal">AuthenticationHandler</code> in the <code class="literal">deployerConfigContext.xml</code> included with CAS. The <code class="literal">AuthenticationHandler</code> has a simple method that returns a boolean as to whether a given set of Credentials is valid. Your <code class="literal">AuthenticationHandler</code> implementation will need to link into some type of backend authentication repository, such as an LDAP server or database. CAS itself includes numerous <code class="literal">AuthenticationHandler</code> s out of the box to assist with this. When you download and deploy the server war file, it is set up to successfully authenticate users who enter a password matching their username, which is useful for testing.</p>
<p>Apart from the CAS server itself, the other key players are of course the secure web applications deployed throughout your enterprise. These web applications are known as "services". There are three types of services. Those that authenticate service tickets, those that can obtain proxy tickets, and those that authenticate proxy tickets. Authenticating a proxy ticket differs because the list of proxies must be validated and often times a proxy ticket can be reused.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="cas-sequence" href="index.html#cas-sequence"></a>34.2.1&nbsp;Spring Security and CAS Interaction Sequence</h3></div></div></div>
<p>The basic interaction between a web browser, CAS server and a Spring Security-secured service is as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The web user is browsing the service&#8217;s public pages. CAS or Spring Security is not involved.
</li><li class="listitem">
The user eventually requests a page that is either secure or one of the beans it uses is secure. Spring Security&#8217;s <code class="literal">ExceptionTranslationFilter</code> will detect the <code class="literal">AccessDeniedException</code> or <code class="literal">AuthenticationException</code>.
</li><li class="listitem">
Because the user&#8217;s <code class="literal">Authentication</code> object (or lack thereof) caused an <code class="literal">AuthenticationException</code>, the <code class="literal">ExceptionTranslationFilter</code> will call the configured <code class="literal">AuthenticationEntryPoint</code>. If using CAS, this will be the <code class="literal">CasAuthenticationEntryPoint</code> class.
</li><li class="listitem">
The <code class="literal">CasAuthenticationEntryPoint</code> will redirect the user&#8217;s browser to the CAS server. It will also indicate a <code class="literal">service</code> parameter, which is the callback URL for the Spring Security service (your application). For example, the URL to which the browser is redirected might be <a class="ulink" href="https://my.company.com/cas/login?service=https%3A%2F%2Fserver3.company.com%2Fwebapp%2Flogin/cas" target="_top">https://my.company.com/cas/login?service=https%3A%2F%2Fserver3.company.com%2Fwebapp%2Flogin/cas</a>.
</li><li class="listitem">
After the user&#8217;s browser redirects to CAS, they will be prompted for their username and password. If the user presents a session cookie which indicates they&#8217;ve previously logged on, they will not be prompted to login again (there is an exception to this procedure, which we&#8217;ll cover later). CAS will use the <code class="literal">PasswordHandler</code> (or <code class="literal">AuthenticationHandler</code> if using CAS 3.0) discussed above to decide whether the username and password is valid.
</li><li class="listitem">
Upon successful login, CAS will redirect the user&#8217;s browser back to the original service. It will also include a <code class="literal">ticket</code> parameter, which is an opaque string representing the "service ticket". Continuing our earlier example, the URL the browser is redirected to might be <a class="ulink" href="https://server3.company.com/webapp/login/cas?ticket=ST-0-ER94xMJmn6pha35CQRoZ" target="_top">https://server3.company.com/webapp/login/cas?ticket=ST-0-ER94xMJmn6pha35CQRoZ</a>.
</li><li class="listitem">
Back in the service web application, the <code class="literal">CasAuthenticationFilter</code> is always listening for requests to <code class="literal">/login/cas</code> (this is configurable, but we&#8217;ll use the defaults in this introduction). The processing filter will construct a <code class="literal">UsernamePasswordAuthenticationToken</code> representing the service ticket. The principal will be equal to <code class="literal">CasAuthenticationFilter.CAS_STATEFUL_IDENTIFIER</code>, whilst the credentials will be the service ticket opaque value. This authentication request will then be handed to the configured <code class="literal">AuthenticationManager</code>.
</li><li class="listitem">
The <code class="literal">AuthenticationManager</code> implementation will be the <code class="literal">ProviderManager</code>, which is in turn configured with the <code class="literal">CasAuthenticationProvider</code>. The <code class="literal">CasAuthenticationProvider</code> only responds to <code class="literal">UsernamePasswordAuthenticationToken</code> s containing the CAS-specific principal (such as <code class="literal">CasAuthenticationFilter.CAS_STATEFUL_IDENTIFIER</code>) and <code class="literal">CasAuthenticationToken</code> s (discussed later).
</li><li class="listitem">
<code class="literal">CasAuthenticationProvider</code> will validate the service ticket using a <code class="literal">TicketValidator</code> implementation. This will typically be a <code class="literal">Cas20ServiceTicketValidator</code> which is one of the classes included in the CAS client library. In the event the application needs to validate proxy tickets, the <code class="literal">Cas20ProxyTicketValidator</code> is used. The <code class="literal">TicketValidator</code> makes an HTTPS request to the CAS server in order to validate the service ticket. It may also include a proxy callback URL, which is included in this example: <a class="ulink" href="https://my.company.com/cas/proxyValidate?service=https%3A%2F%2Fserver3.company.com%2Fwebapp%2Flogin/cas&amp;ticket=ST-0-ER94xMJmn6pha35CQRoZ&amp;pgtUrl=https://server3.company.com/webapp/login/cas/proxyreceptor" target="_top">https://my.company.com/cas/proxyValidate?service=https%3A%2F%2Fserver3.company.com%2Fwebapp%2Flogin/cas&amp;ticket=ST-0-ER94xMJmn6pha35CQRoZ&amp;pgtUrl=https://server3.company.com/webapp/login/cas/proxyreceptor</a>.
</li><li class="listitem">
Back on the CAS server, the validation request will be received. If the presented service ticket matches the service URL the ticket was issued to, CAS will provide an affirmative response in XML indicating the username. If any proxy was involved in the authentication (discussed below), the list of proxies is also included in the XML response.
</li><li class="listitem">
[OPTIONAL] If the request to the CAS validation service included the proxy callback URL (in the <code class="literal">pgtUrl</code> parameter), CAS will include a <code class="literal">pgtIou</code> string in the XML response. This <code class="literal">pgtIou</code> represents a proxy-granting ticket IOU. The CAS server will then create its own HTTPS connection back to the <code class="literal">pgtUrl</code>. This is to mutually authenticate the CAS server and the claimed service URL. The HTTPS connection will be used to send a proxy granting ticket to the original web application. For example, <a class="ulink" href="https://server3.company.com/webapp/login/cas/proxyreceptor?pgtIou=PGTIOU-0-R0zlgrl4pdAQwBvJWO3vnNpevwqStbSGcq3vKB2SqSFFRnjPHt&amp;pgtId=PGT-1-si9YkkHLrtACBo64rmsi3v2nf7cpCResXg5MpESZFArbaZiOKH" target="_top">https://server3.company.com/webapp/login/cas/proxyreceptor?pgtIou=PGTIOU-0-R0zlgrl4pdAQwBvJWO3vnNpevwqStbSGcq3vKB2SqSFFRnjPHt&amp;pgtId=PGT-1-si9YkkHLrtACBo64rmsi3v2nf7cpCResXg5MpESZFArbaZiOKH</a>.
</li><li class="listitem">
The <code class="literal">Cas20TicketValidator</code> will parse the XML received from the CAS server. It will return to the <code class="literal">CasAuthenticationProvider</code> a <code class="literal">TicketResponse</code>, which includes the username (mandatory), proxy list (if any were involved), and proxy-granting ticket IOU (if the proxy callback was requested).
</li><li class="listitem">
Next <code class="literal">CasAuthenticationProvider</code> will call a configured <code class="literal">CasProxyDecider</code>. The <code class="literal">CasProxyDecider</code> indicates whether the proxy list in the <code class="literal">TicketResponse</code> is acceptable to the service. Several implementations are provided with Spring Security: <code class="literal">RejectProxyTickets</code>, <code class="literal">AcceptAnyCasProxy</code> and <code class="literal">NamedCasProxyDecider</code>. These names are largely self-explanatory, except <code class="literal">NamedCasProxyDecider</code> which allows a <code class="literal">List</code> of trusted proxies to be provided.
</li><li class="listitem">
<code class="literal">CasAuthenticationProvider</code> will next request a <code class="literal">AuthenticationUserDetailsService</code> to load the <code class="literal">GrantedAuthority</code> objects that apply to the user contained in the <code class="literal">Assertion</code>.
</li><li class="listitem">
If there were no problems, <code class="literal">CasAuthenticationProvider</code> constructs a <code class="literal">CasAuthenticationToken</code> including the details contained in the <code class="literal">TicketResponse</code> and the <code class="literal">GrantedAuthority</code>s.
</li><li class="listitem">
Control then returns to <code class="literal">CasAuthenticationFilter</code>, which places the created <code class="literal">CasAuthenticationToken</code> in the security context.
</li><li class="listitem">
The user&#8217;s browser is redirected to the original page that caused the <code class="literal">AuthenticationException</code> (or a <a class="link" href="index.html#form-login-flow-handling" title="15.4.1&nbsp;Application Flow on Authentication Success and Failure">custom destination</a> depending on the configuration).
</li></ul></div>
<p>It&#8217;s good that you&#8217;re still here! Let&#8217;s now look at how this is configured</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="cas-client" href="index.html#cas-client"></a>34.3&nbsp;Configuration of CAS Client</h2></div></div></div>
<p>The web application side of CAS is made easy due to Spring Security. It is assumed you already know the basics of using Spring Security, so these are not covered again below. We&#8217;ll assume a namespace based configuration is being used and add in the CAS beans as required. Each section builds upon the previous section. A full<a class="link" href="index.html#cas-sample" title="7.5&nbsp;CAS Sample">CAS sample application</a> can be found in the Spring Security Samples.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="cas-st" href="index.html#cas-st"></a>34.3.1&nbsp;Service Ticket Authentication</h3></div></div></div>
<p>This section describes how to setup Spring Security to authenticate Service Tickets. Often times this is all a web application requires. You will need to add a <code class="literal">ServiceProperties</code> bean to your application context. This represents your CAS service:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"serviceProperties"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.cas.ServiceProperties"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"service"</span>
	<span class="hl-attribute">value</span>=<span class="hl-value">"https://localhost:8443/cas-sample/login/cas"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sendRenew"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>The <code class="literal">service</code> must equal a URL that will be monitored by the <code class="literal">CasAuthenticationFilter</code>. The <code class="literal">sendRenew</code> defaults to false, but should be set to true if your application is particularly sensitive. What this parameter does is tell the CAS login service that a single sign on login is unacceptable. Instead, the user will need to re-enter their username and password in order to gain access to the service.</p>
<p>The following beans should be configured to commence the CAS authentication process (assuming you&#8217;re using a namespace configuration):</p>
<pre class="programlisting"><span class="hl-tag">&lt;security:http</span> <span class="hl-attribute">entry-point-ref</span>=<span class="hl-value">"casEntryPoint"</span><span class="hl-tag">&gt;</span>
...
<span class="hl-tag">&lt;security:custom-filter</span> <span class="hl-attribute">position</span>=<span class="hl-value">"CAS_FILTER"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"casFilter"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/security:http&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"casFilter"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.cas.web.CasAuthenticationFilter"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authenticationManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"authenticationManager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"casEntryPoint"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.cas.web.CasAuthenticationEntryPoint"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"loginUrl"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"https://localhost:9443/cas/login"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceProperties"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"serviceProperties"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>For CAS to operate, the <code class="literal">ExceptionTranslationFilter</code> must have its <code class="literal">authenticationEntryPoint</code> property set to the <code class="literal">CasAuthenticationEntryPoint</code> bean. This can easily be done using <a class="link" href="index.html#ns-entry-point-ref" title="Setting a Custom AuthenticationEntryPoint">entry-point-ref</a> as is done in the example above. The <code class="literal">CasAuthenticationEntryPoint</code> must refer to the <code class="literal">ServiceProperties</code> bean (discussed above), which provides the URL to the enterprise&#8217;s CAS login server. This is where the user&#8217;s browser will be redirected.</p>
<p>The <code class="literal">CasAuthenticationFilter</code> has very similar properties to the <code class="literal">UsernamePasswordAuthenticationFilter</code> (used for form-based logins). You can use these properties to customize things like behavior for authentication success and failure.</p>
<p>Next you need to add a <code class="literal">CasAuthenticationProvider</code> and its collaborators:</p>
<pre class="programlisting"><span class="hl-tag">&lt;security:authentication-manager</span> <span class="hl-attribute">alias</span>=<span class="hl-value">"authenticationManager"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;security:authentication-provider</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"casAuthenticationProvider"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/security:authentication-manager&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"casAuthenticationProvider"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.cas.authentication.CasAuthenticationProvider"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authenticationUserDetailsService"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.core.userdetails.UserDetailsByNameServiceWrapper"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"userService"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceProperties"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"serviceProperties"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"ticketValidator"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jasig.cas.client.validation.Cas20ServiceTicketValidator"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">index</span>=<span class="hl-value">"0"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"https://localhost:9443/cas"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"key"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"an_id_for_this_auth_provider_only"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;security:user-service</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userService"</span><span class="hl-tag">&gt;</span>
<span class="hl-comment">&lt;!-- Password is prefixed with {noop} to indicate to DelegatingPasswordEncoder that
NoOpPasswordEncoder should be used. This is not safe for production, but makes reading
in samples easier. Normally passwords should be hashed using BCrypt --&gt;</span>
<span class="hl-tag">&lt;security:user</span> <span class="hl-attribute">name</span>=<span class="hl-value">"joe"</span> <span class="hl-attribute">password</span>=<span class="hl-value">"{noop}joe"</span> <span class="hl-attribute">authorities</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag"> /&gt;</span>
...
<span class="hl-tag">&lt;/security:user-service&gt;</span></pre>
<p>The <code class="literal">CasAuthenticationProvider</code> uses a <code class="literal">UserDetailsService</code> instance to load the authorities for a user, once they have been authenticated by CAS. We&#8217;ve shown a simple in-memory setup here. Note that the <code class="literal">CasAuthenticationProvider</code> does not actually use the password for authentication, but it does use the authorities.</p>
<p>The beans are all reasonably self-explanatory if you refer back to the <a class="link" href="index.html#cas-how-it-works" title="34.2&nbsp;How CAS Works">How CAS Works</a> section.</p>
<p>This completes the most basic configuration for CAS. If you haven&#8217;t made any mistakes, your web application should happily work within the framework of CAS single sign on. No other parts of Spring Security need to be concerned about the fact CAS handled authentication. In the following sections we will discuss some (optional) more advanced configurations.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="cas-singlelogout" href="index.html#cas-singlelogout"></a>34.3.2&nbsp;Single Logout</h3></div></div></div>
<p>The CAS protocol supports Single Logout and can be easily added to your Spring Security configuration. Below are updates to the Spring Security configuration that handle Single Logout</p>
<pre class="programlisting"><span class="hl-tag">&lt;security:http</span> <span class="hl-attribute">entry-point-ref</span>=<span class="hl-value">"casEntryPoint"</span><span class="hl-tag">&gt;</span>
...
<span class="hl-tag">&lt;security:logout</span> <span class="hl-attribute">logout-success-url</span>=<span class="hl-value">"/cas-logout.jsp"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;security:custom-filter</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"requestSingleLogoutFilter"</span> <span class="hl-attribute">before</span>=<span class="hl-value">"LOGOUT_FILTER"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;security:custom-filter</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"singleLogoutFilter"</span> <span class="hl-attribute">before</span>=<span class="hl-value">"CAS_FILTER"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/security:http&gt;</span>

<span class="hl-comment">&lt;!-- This filter handles a Single Logout Request from the CAS Server --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"singleLogoutFilter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jasig.cas.client.session.SingleSignOutFilter"</span><span class="hl-tag">/&gt;</span>

<span class="hl-comment">&lt;!-- This filter redirects to the CAS Server to signal Single Logout should be performed --&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"requestSingleLogoutFilter"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.authentication.logout.LogoutFilter"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"https://localhost:9443/cas/logout"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;constructor-arg&gt;</span>
	<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=
		<span class="hl-value">"org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"filterProcessesUrl"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/logout/cas"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>The <code class="literal">logout</code> element logs the user out of the local application, but does not terminate the session with the CAS server or any other applications that have been logged into. The <code class="literal">requestSingleLogoutFilter</code> filter will allow the URL of <code class="literal">/spring_security_cas_logout</code> to be requested to redirect the application to the configured CAS Server logout URL. Then the CAS Server will send a Single Logout request to all the services that were signed into. The <code class="literal">singleLogoutFilter</code> handles the Single Logout request by looking up the <code class="literal">HttpSession</code> in a static <code class="literal">Map</code> and then invalidating it.</p>
<p>It might be confusing why both the <code class="literal">logout</code> element and the <code class="literal">singleLogoutFilter</code> are needed. It is considered best practice to logout locally first since the <code class="literal">SingleSignOutFilter</code> just stores the <code class="literal">HttpSession</code> in a static <code class="literal">Map</code> in order to call invalidate on it. With the configuration above, the flow of logout would be:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The user requests <code class="literal">/logout</code> which would log the user out of the local application and send the user to the logout success page.
</li><li class="listitem">
The logout success page, <code class="literal">/cas-logout.jsp</code>, should instruct the user to click a link pointing to <code class="literal">/logout/cas</code> in order to logout out of all applications.
</li><li class="listitem">
When the user clicks the link, the user is redirected to the CAS single logout URL (<a class="ulink" href="https://localhost:9443/cas/logout" target="_top">https://localhost:9443/cas/logout</a>).
</li><li class="listitem">
On the CAS Server side, the CAS single logout URL then submits single logout requests to all the CAS Services. On the CAS Service side, JASIG&#8217;s <code class="literal">SingleSignOutFilter</code> processes the logout request by invaliditing the original session.
</li></ul></div>
<p>The next step is to add the following to your web.xml</p>
<pre class="programlisting"><span class="hl-tag">&lt;filter&gt;</span>
<span class="hl-tag">&lt;filter-name&gt;</span>characterEncodingFilter<span class="hl-tag">&lt;/filter-name&gt;</span>
<span class="hl-tag">&lt;filter-class&gt;</span>
	org.springframework.web.filter.CharacterEncodingFilter
<span class="hl-tag">&lt;/filter-class&gt;</span>
<span class="hl-tag">&lt;init-param&gt;</span>
	<span class="hl-tag">&lt;param-name&gt;</span>encoding<span class="hl-tag">&lt;/param-name&gt;</span>
	<span class="hl-tag">&lt;param-value&gt;</span>UTF-8<span class="hl-tag">&lt;/param-value&gt;</span>
<span class="hl-tag">&lt;/init-param&gt;</span>
<span class="hl-tag">&lt;/filter&gt;</span>
<span class="hl-tag">&lt;filter-mapping&gt;</span>
<span class="hl-tag">&lt;filter-name&gt;</span>characterEncodingFilter<span class="hl-tag">&lt;/filter-name&gt;</span>
<span class="hl-tag">&lt;url-pattern&gt;</span>/*<span class="hl-tag">&lt;/url-pattern&gt;</span>
<span class="hl-tag">&lt;/filter-mapping&gt;</span>
<span class="hl-tag">&lt;listener&gt;</span>
<span class="hl-tag">&lt;listener-class&gt;</span>
	org.jasig.cas.client.session.SingleSignOutHttpSessionListener
<span class="hl-tag">&lt;/listener-class&gt;</span>
<span class="hl-tag">&lt;/listener&gt;</span></pre>
<p>When using the SingleSignOutFilter you might encounter some encoding issues. Therefore it is recommended to add the <code class="literal">CharacterEncodingFilter</code> to ensure that the character encoding is correct when using the <code class="literal">SingleSignOutFilter</code>. Again, refer to JASIG&#8217;s documentation for details. The <code class="literal">SingleSignOutHttpSessionListener</code> ensures that when an <code class="literal">HttpSession</code> expires, the mapping used for single logout is removed.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="cas-pt-client" href="index.html#cas-pt-client"></a>34.3.3&nbsp;Authenticating to a Stateless Service with CAS</h3></div></div></div>
<p>This section describes how to authenticate to a service using CAS. In other words, this section discusses how to setup a client that uses a service that authenticates with CAS. The next section describes how to setup a stateless service to Authenticate using CAS.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="cas-pt-client-config" href="index.html#cas-pt-client-config"></a>Configuring CAS to Obtain Proxy Granting Tickets</h4></div></div></div>
<p>In order to authenticate to a stateless service, the application needs to obtain a proxy granting ticket (PGT). This section describes how to configure Spring Security to obtain a PGT building upon thencas-st[Service Ticket Authentication] configuration.</p>
<p>The first step is to include a <code class="literal">ProxyGrantingTicketStorage</code> in your Spring Security configuration. This is used to store PGT&#8217;s that are obtained by the <code class="literal">CasAuthenticationFilter</code> so that they can be used to obtain proxy tickets. An example configuration is shown below</p>
<pre class="programlisting"><span class="hl-comment">&lt;!--
NOTE: In a real application you should not use an in
		memory implementation. You will also want to ensure
		to clean up expired tickets by calling ProxyGrantingTicketStorage.cleanup()
--&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pgtStorage"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jasig.cas.client.proxy.ProxyGrantingTicketStorageImpl"</span><span class="hl-tag">/&gt;</span></pre>
<p>The next step is to update the <code class="literal">CasAuthenticationProvider</code> to be able to obtain proxy tickets. To do this replace the <code class="literal">Cas20ServiceTicketValidator</code> with a <code class="literal">Cas20ProxyTicketValidator</code>. The <code class="literal">proxyCallbackUrl</code> should be set to a URL that the application will receive PGT&#8217;s at. Last, the configuration should also reference the <code class="literal">ProxyGrantingTicketStorage</code> so it can use a PGT to obtain proxy tickets. You can find an example of the configuration changes that should be made below.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"casAuthenticationProvider"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.cas.authentication.CasAuthenticationProvider"</span><span class="hl-tag">&gt;</span>
...
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"ticketValidator"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jasig.cas.client.validation.Cas20ProxyTicketValidator"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"https://localhost:9443/cas"</span><span class="hl-tag">/&gt;</span>
		<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"proxyCallbackUrl"</span>
		<span class="hl-attribute">value</span>=<span class="hl-value">"https://localhost:8443/cas-sample/login/cas/proxyreceptor"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"proxyGrantingTicketStorage"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"pgtStorage"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>The last step is to update the <code class="literal">CasAuthenticationFilter</code> to accept PGT and to store them in the <code class="literal">ProxyGrantingTicketStorage</code>. It is important the <code class="literal">proxyReceptorUrl</code> matches the <code class="literal">proxyCallbackUrl</code> of the <code class="literal">Cas20ProxyTicketValidator</code>. An example configuration is shown below.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"casFilter"</span>
		<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.cas.web.CasAuthenticationFilter"</span><span class="hl-tag">&gt;</span>
	...
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"proxyGrantingTicketStorage"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"pgtStorage"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"proxyReceptorUrl"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/login/cas/proxyreceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="cas-pt-client-sample" href="index.html#cas-pt-client-sample"></a>Calling a Stateless Service Using a Proxy Ticket</h4></div></div></div>
<p>Now that Spring Security obtains PGTs, you can use them to create proxy tickets which can be used to authenticate to a stateless service. The <a class="link" href="index.html#cas-sample" title="7.5&nbsp;CAS Sample">CAS sample application</a> contains a working example in the <code class="literal">ProxyTicketSampleServlet</code>. Example code can be found below:</p>
<pre class="programlisting"><span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> doGet(HttpServletRequest request, HttpServletResponse response)
	<span class="hl-keyword">throws</span> ServletException, IOException {
<span class="hl-comment">// NOTE: The CasAuthenticationToken can also be obtained using</span>
<span class="hl-comment">// SecurityContextHolder.getContext().getAuthentication()</span>
<span class="hl-keyword">final</span> CasAuthenticationToken token = (CasAuthenticationToken) request.getUserPrincipal();
<span class="hl-comment">// proxyTicket could be reused to make calls to the CAS service even if the</span>
<span class="hl-comment">// target url differs</span>
<span class="hl-keyword">final</span> String proxyTicket = token.getAssertion().getPrincipal().getProxyTicketFor(targetUrl);

<span class="hl-comment">// Make a remote call using the proxy ticket</span>
<span class="hl-keyword">final</span> String serviceUrl = targetUrl+<span class="hl-string">"?ticket="</span>+URLEncoder.encode(proxyTicket, <span class="hl-string">"UTF-8"</span>);
String proxyResponse = CommonUtils.getResponseFromServer(serviceUrl, <span class="hl-string">"UTF-8"</span>);
...
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="cas-pt" href="index.html#cas-pt"></a>34.3.4&nbsp;Proxy Ticket Authentication</h3></div></div></div>
<p>The <code class="literal">CasAuthenticationProvider</code> distinguishes between stateful and stateless clients. A stateful client is considered any that submits to the <code class="literal">filterProcessUrl</code> of the <code class="literal">CasAuthenticationFilter</code>. A stateless client is any that presents an authentication request to <code class="literal">CasAuthenticationFilter</code> on a URL other than the <code class="literal">filterProcessUrl</code>.</p>
<p>Because remoting protocols have no way of presenting themselves within the context of an <code class="literal">HttpSession</code>, it isn&#8217;t possible to rely on the default practice of storing the security context in the session between requests. Furthermore, because the CAS server invalidates a ticket after it has been validated by the <code class="literal">TicketValidator</code>, presenting the same proxy ticket on subsequent requests will not work.</p>
<p>One obvious option is to not use CAS at all for remoting protocol clients. However, this would eliminate many of the desirable features of CAS. As a middle-ground, the <code class="literal">CasAuthenticationProvider</code> uses a <code class="literal">StatelessTicketCache</code>. This is used solely for stateless clients which use a principal equal to <code class="literal">CasAuthenticationFilter.CAS_STATELESS_IDENTIFIER</code>. What happens is the <code class="literal">CasAuthenticationProvider</code> will store the resulting <code class="literal">CasAuthenticationToken</code> in the <code class="literal">StatelessTicketCache</code>, keyed on the proxy ticket. Accordingly, remoting protocol clients can present the same proxy ticket and the <code class="literal">CasAuthenticationProvider</code> will not need to contact the CAS server for validation (aside from the first request). Once authenticated, the proxy ticket could be used for URLs other than the original target service.</p>
<p>This section builds upon the previous sections to accommodate proxy ticket authentication. The first step is to specify to authenticate all artifacts as shown below.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"serviceProperties"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.cas.ServiceProperties"</span><span class="hl-tag">&gt;</span>
...
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authenticateAllArtifacts"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>The next step is to specify <code class="literal">serviceProperties</code> and the <code class="literal">authenticationDetailsSource</code> for the <code class="literal">CasAuthenticationFilter</code>. The <code class="literal">serviceProperties</code> property instructs the <code class="literal">CasAuthenticationFilter</code> to attempt to authenticate all artifacts instead of only ones present on the <code class="literal">filterProcessUrl</code>. The <code class="literal">ServiceAuthenticationDetailsSource</code> creates a <code class="literal">ServiceAuthenticationDetails</code> that ensures the current URL, based upon the <code class="literal">HttpServletRequest</code>, is used as the service URL when validating the ticket. The method for generating the service URL can be customized by injecting a custom <code class="literal">AuthenticationDetailsSource</code> that returns a custom <code class="literal">ServiceAuthenticationDetails</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"casFilter"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.cas.web.CasAuthenticationFilter"</span><span class="hl-tag">&gt;</span>
...
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"serviceProperties"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"serviceProperties"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authenticationDetailsSource"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=
	<span class="hl-value">"org.springframework.security.cas.web.authentication.ServiceAuthenticationDetailsSource"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"serviceProperties"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>You will also need to update the <code class="literal">CasAuthenticationProvider</code> to handle proxy tickets. To do this replace the <code class="literal">Cas20ServiceTicketValidator</code> with a <code class="literal">Cas20ProxyTicketValidator</code>. You will need to configure the <code class="literal">statelessTicketCache</code> and which proxies you want to accept. You can find an example of the updates required to accept all proxies below.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"casAuthenticationProvider"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.cas.authentication.CasAuthenticationProvider"</span><span class="hl-tag">&gt;</span>
...
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"ticketValidator"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jasig.cas.client.validation.Cas20ProxyTicketValidator"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"https://localhost:9443/cas"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"acceptAnyProxy"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"statelessTicketCache"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.cas.authentication.EhCacheBasedTicketCache"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"cache"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"net.sf.ehcache.Cache"</span>
			<span class="hl-attribute">init-method</span>=<span class="hl-value">"initialise"</span> <span class="hl-attribute">destroy-method</span>=<span class="hl-value">"dispose"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"casTickets"</span><span class="hl-tag">/&gt;</span>
		<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"50"</span><span class="hl-tag">/&gt;</span>
		<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
		<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span>
		<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"3600"</span><span class="hl-tag">/&gt;</span>
		<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"900"</span><span class="hl-tag">/&gt;</span>
		<span class="hl-tag">&lt;/bean&gt;</span>
	<span class="hl-tag">&lt;/property&gt;</span>
	<span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="x509" href="index.html#x509"></a>35.&nbsp;X.509 Authentication</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x509-overview" href="index.html#x509-overview"></a>35.1&nbsp;Overview</h2></div></div></div>
<p>The most common use of X.509 certificate authentication is in verifying the identity of a server when using SSL, most commonly when using HTTPS from a browser. The browser will automatically check that the certificate presented by a server has been issued (ie digitally signed) by one of a list of trusted certificate authorities which it maintains.</p>
<p>You can also use SSL with "mutual authentication"; the server will then request a valid certificate from the client as part of the SSL handshake. The server will authenticate the client by checking that its certificate is signed by an acceptable authority. If a valid certificate has been provided, it can be obtained through the servlet API in an application. Spring Security X.509 module extracts the certificate using a filter. It maps the certificate to an application user and loads that user&#8217;s set of granted authorities for use with the standard Spring Security infrastructure.</p>
<p>You should be familiar with using certificates and setting up client authentication for your servlet container before attempting to use it with Spring Security. Most of the work is in creating and installing suitable certificates and keys. For example, if you&#8217;re using Tomcat then read the instructions here <a class="ulink" href="https://tomcat.apache.org/tomcat-6.0-doc/ssl-howto.html" target="_top">http://tomcat.apache.org/tomcat-6.0-doc/ssl-howto.html</a>. It&#8217;s important that you get this working before trying it out with Spring Security</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="adding-x-509-authentication-to-your-web-application" href="index.html#adding-x-509-authentication-to-your-web-application"></a>35.2&nbsp;Adding X.509 Authentication to Your Web Application</h2></div></div></div>
<p>Enabling X.509 client authentication is very straightforward. Just add the <code class="literal">&lt;x509/&gt;</code> element to your http security namespace configuration.</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
...
	<span class="hl-tag">&lt;x509</span> <span class="hl-attribute">subject-principal-regex</span>=<span class="hl-value">"CN=(.*?),"</span> <span class="hl-attribute">user-service-ref</span>=<span class="hl-value">"userService"</span><span class="hl-tag">/&gt;</span>;
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>The element has two optional attributes:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">subject-principal-regex</code>. The regular expression used to extract a username from the certificate&#8217;s subject name. The default value is shown above. This is the username which will be passed to the <code class="literal">UserDetailsService</code> to load the authorities for the user.
</li><li class="listitem">
<code class="literal">user-service-ref</code>. This is the bean Id of the <code class="literal">UserDetailsService</code> to be used with X.509. It isn&#8217;t needed if there is only one defined in your application context.
</li></ul></div>
<p>The <code class="literal">subject-principal-regex</code> should contain a single group. For example the default expression "CN=(.*?)," matches the common name field. So if the subject name in the certificate is "CN=Jimi Hendrix, OU=&#8230;&#8203;", this will give a user name of "Jimi Hendrix". The matches are case insensitive. So "emailAddress=(.?)," will match "EMAILADDRESS=<a class="ulink" href="https://docs.spring.io/cdn-cgi/l/email-protection#3b515256527b535e555f4952431554495c" target="_top"><span class="__cf_email__" data-cfemail="066c6f6b6f466e636862746f7e28697461">[email&#160;protected]</span></a>,CN=&#8230;&#8203;" giving a user name "<a class="ulink" href="https://docs.spring.io/cdn-cgi/l/email-protection#deb4b7b3b79eb6bbb0baacb7a6f0b1acb9" target="_top"><span class="__cf_email__" data-cfemail="86ecefebefc6eee3e8e2f4effea8e9f4e1">[email&#160;protected]</span></a>". If the client presents a certificate and a valid username is successfully extracted, then there should be a valid <code class="literal">Authentication</code> object in the security context. If no certificate is found, or no corresponding user could be found then the security context will remain empty. This means that you can easily use X.509 authentication with other options such as a form-based login.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x509-ssl-config" href="index.html#x509-ssl-config"></a>35.3&nbsp;Setting up SSL in Tomcat</h2></div></div></div>
<p>There are some pre-generated certificates in the <code class="literal">samples/certificate</code> directory in the Spring Security project. You can use these to enable SSL for testing if you don&#8217;t want to generate your own. The file <code class="literal">server.jks</code> contains the server certificate, private key and the issuing certificate authority certificate. There are also some client certificate files for the users from the sample applications. You can install these in your browser to enable SSL client authentication.</p>
<p>To run tomcat with SSL support, drop the <code class="literal">server.jks</code> file into the tomcat <code class="literal">conf</code> directory and add the following connector to the <code class="literal">server.xml</code> file</p>
<pre class="programlisting"><span class="hl-tag">&lt;Connector</span> <span class="hl-attribute">port</span>=<span class="hl-value">"8443"</span> <span class="hl-attribute">protocol</span>=<span class="hl-value">"HTTP/1.1"</span> <span class="hl-attribute">SSLEnabled</span>=<span class="hl-value">"true"</span> <span class="hl-attribute">scheme</span>=<span class="hl-value">"https"</span> <span class="hl-attribute">secure</span>=<span class="hl-value">"true"</span>
			<span class="hl-attribute">clientAuth</span>=<span class="hl-value">"true"</span> <span class="hl-attribute">sslProtocol</span>=<span class="hl-value">"TLS"</span>
			<span class="hl-attribute">keystoreFile</span>=<span class="hl-value">"${catalina.home}/conf/server.jks"</span>
			<span class="hl-attribute">keystoreType</span>=<span class="hl-value">"JKS"</span> <span class="hl-attribute">keystorePass</span>=<span class="hl-value">"password"</span>
			<span class="hl-attribute">truststoreFile</span>=<span class="hl-value">"${catalina.home}/conf/server.jks"</span>
			<span class="hl-attribute">truststoreType</span>=<span class="hl-value">"JKS"</span> <span class="hl-attribute">truststorePass</span>=<span class="hl-value">"password"</span><span class="hl-tag">
/&gt;</span></pre>
<p><code class="literal">clientAuth</code> can also be set to <code class="literal">want</code> if you still want SSL connections to succeed even if the client doesn&#8217;t provide a certificate. Clients which don&#8217;t present a certificate won&#8217;t be able to access any objects secured by Spring Security unless you use a non-X.509 authentication mechanism, such as form authentication.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="runas" href="index.html#runas"></a>36.&nbsp;Run-As Authentication Replacement</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="runas-overview" href="index.html#runas-overview"></a>36.1&nbsp;Overview</h2></div></div></div>
<p>The <code class="literal">AbstractSecurityInterceptor</code> is able to temporarily replace the <code class="literal">Authentication</code> object in the <code class="literal">SecurityContext</code> and <code class="literal">SecurityContextHolder</code> during the secure object callback phase. This only occurs if the original <code class="literal">Authentication</code> object was successfully processed by the <code class="literal">AuthenticationManager</code> and <code class="literal">AccessDecisionManager</code>. The <code class="literal">RunAsManager</code> will indicate the replacement <code class="literal">Authentication</code> object, if any, that should be used during the <code class="literal">SecurityInterceptorCallback</code>.</p>
<p>By temporarily replacing the <code class="literal">Authentication</code> object during the secure object callback phase, the secured invocation will be able to call other objects which require different authentication and authorization credentials. It will also be able to perform any internal security checks for specific <code class="literal">GrantedAuthority</code> objects. Because Spring Security provides a number of helper classes that automatically configure remoting protocols based on the contents of the <code class="literal">SecurityContextHolder</code>, these run-as replacements are particularly useful when calling remote web services</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="runas-config" href="index.html#runas-config"></a>36.2&nbsp;Configuration</h2></div></div></div>
<p>A <code class="literal">RunAsManager</code> interface is provided by Spring Security:</p>
<pre class="programlisting">Authentication buildRunAs(Authentication authentication, Object object,
	List&lt;ConfigAttribute&gt; config);

<span class="hl-keyword">boolean</span> supports(ConfigAttribute attribute);

<span class="hl-keyword">boolean</span> supports(Class clazz);</pre>
<p>The first method returns the <code class="literal">Authentication</code> object that should replace the existing <code class="literal">Authentication</code> object for the duration of the method invocation. If the method returns <code class="literal">null</code>, it indicates no replacement should be made. The second method is used by the <code class="literal">AbstractSecurityInterceptor</code> as part of its startup validation of configuration attributes. The <code class="literal">supports(Class)</code> method is called by a security interceptor implementation to ensure the configured <code class="literal">RunAsManager</code> supports the type of secure object that the security interceptor will present.</p>
<p>One concrete implementation of a <code class="literal">RunAsManager</code> is provided with Spring Security. The <code class="literal">RunAsManagerImpl</code> class returns a replacement <code class="literal">RunAsUserToken</code> if any <code class="literal">ConfigAttribute</code> starts with <code class="literal">RUN_AS_</code>. If any such <code class="literal">ConfigAttribute</code> is found, the replacement <code class="literal">RunAsUserToken</code> will contain the same principal, credentials and granted authorities as the original <code class="literal">Authentication</code> object, along with a new <code class="literal">SimpleGrantedAuthority</code> for each <code class="literal">RUN_AS_</code> <code class="literal">ConfigAttribute</code>. Each new <code class="literal">SimpleGrantedAuthority</code> will be prefixed with <code class="literal">ROLE_</code>, followed by the <code class="literal">RUN_AS</code> <code class="literal">ConfigAttribute</code>. For example, a <code class="literal">RUN_AS_SERVER</code> will result in the replacement <code class="literal">RunAsUserToken</code> containing a <code class="literal">ROLE_RUN_AS_SERVER</code> granted authority.</p>
<p>The replacement <code class="literal">RunAsUserToken</code> is just like any other <code class="literal">Authentication</code> object. It needs to be authenticated by the <code class="literal">AuthenticationManager</code>, probably via delegation to a suitable <code class="literal">AuthenticationProvider</code>. The <code class="literal">RunAsImplAuthenticationProvider</code> performs such authentication. It simply accepts as valid any <code class="literal">RunAsUserToken</code> presented.</p>
<p>To ensure malicious code does not create a <code class="literal">RunAsUserToken</code> and present it for guaranteed acceptance by the <code class="literal">RunAsImplAuthenticationProvider</code>, the hash of a key is stored in all generated tokens. The <code class="literal">RunAsManagerImpl</code> and <code class="literal">RunAsImplAuthenticationProvider</code> is created in the bean context with the same key:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"runAsManager"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.access.intercept.RunAsManagerImpl"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"key"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"my_run_as_password"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"runAsAuthenticationProvider"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.access.intercept.RunAsImplAuthenticationProvider"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"key"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"my_run_as_password"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>By using the same key, each <code class="literal">RunAsUserToken</code> can be validated it was created by an approved <code class="literal">RunAsManagerImpl</code>. The <code class="literal">RunAsUserToken</code> is immutable after creation for security reasons</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="crypto" href="index.html#crypto"></a>37.&nbsp;Spring Security Crypto Module</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-security-crypto-introduction" href="index.html#spring-security-crypto-introduction"></a>37.1&nbsp;Introduction</h2></div></div></div>
<p>The Spring Security Crypto module provides support for symmetric encryption, key generation, and password encoding. The code is distributed as part of the core module but has no dependencies on any other Spring Security (or Spring) code.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-security-crypto-encryption" href="index.html#spring-security-crypto-encryption"></a>37.2&nbsp;Encryptors</h2></div></div></div>
<p>The Encryptors class provides factory methods for constructing symmetric encryptors. Using this class, you can create ByteEncryptors to encrypt data in raw byte[] form. You can also construct TextEncryptors to encrypt text strings. Encryptors are thread-safe.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="spring-security-crypto-encryption-bytes" href="index.html#spring-security-crypto-encryption-bytes"></a>37.2.1&nbsp;BytesEncryptor</h3></div></div></div>
<p>Use the Encryptors.standard factory method to construct a "standard" BytesEncryptor:</p>
<pre class="programlisting">Encryptors.standard(<span class="hl-string">"password"</span>, <span class="hl-string">"salt"</span>);</pre>
<p>The "standard" encryption method is 256-bit AES using PKCS #5&#8217;s PBKDF2 (Password-Based Key Derivation Function #2). This method requires Java 6. The password used to generate the SecretKey should be kept in a secure place and not be shared. The salt is used to prevent dictionary attacks against the key in the event your encrypted data is compromised. A 16-byte random initialization vector is also applied so each encrypted message is unique.</p>
<p>The provided salt should be in hex-encoded String form, be random, and be at least 8 bytes in length. Such a salt may be generated using a KeyGenerator:</p>
<pre class="programlisting">String salt = KeyGenerators.string().generateKey(); <span class="hl-comment">// generates a random 8-byte salt that is then hex-encoded</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="spring-security-crypto-encryption-text" href="index.html#spring-security-crypto-encryption-text"></a>37.2.2&nbsp;TextEncryptor</h3></div></div></div>
<p>Use the Encryptors.text factory method to construct a standard TextEncryptor:</p>
<pre class="programlisting">Encryptors.text(<span class="hl-string">"password"</span>, <span class="hl-string">"salt"</span>);</pre>
<p>A TextEncryptor uses a standard BytesEncryptor to encrypt text data. Encrypted results are returned as hex-encoded strings for easy storage on the filesystem or in the database.</p>
<p>Use the Encryptors.queryableText factory method to construct a "queryable" TextEncryptor:</p>
<pre class="programlisting">Encryptors.queryableText(<span class="hl-string">"password"</span>, <span class="hl-string">"salt"</span>);</pre>
<p>The difference between a queryable TextEncryptor and a standard TextEncryptor has to do with initialization vector (iv) handling. The iv used in a queryable TextEncryptor#encrypt operation is shared, or constant, and is not randomly generated. This means the same text encrypted multiple times will always produce the same encryption result. This is less secure, but necessary for encrypted data that needs to be queried against. An example of queryable encrypted text would be an OAuth apiKey.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-security-crypto-keygenerators" href="index.html#spring-security-crypto-keygenerators"></a>37.3&nbsp;Key Generators</h2></div></div></div>
<p>The KeyGenerators class provides a number of convenience factory methods for constructing different types of key generators. Using this class, you can create a BytesKeyGenerator to generate byte[] keys. You can also construct a StringKeyGenerator to generate string keys. KeyGenerators are thread-safe.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="byteskeygenerator" href="index.html#byteskeygenerator"></a>37.3.1&nbsp;BytesKeyGenerator</h3></div></div></div>
<p>Use the KeyGenerators.secureRandom factory methods to generate a BytesKeyGenerator backed by a SecureRandom instance:</p>
<pre class="programlisting">BytesKeyGenerator generator = KeyGenerators.secureRandom();
<span class="hl-keyword">byte</span>[] key = generator.generateKey();</pre>
<p>The default key length is 8 bytes. There is also a KeyGenerators.secureRandom variant that provides control over the key length:</p>
<pre class="programlisting">KeyGenerators.secureRandom(<span class="hl-number">16</span>);</pre>
<p>Use the KeyGenerators.shared factory method to construct a BytesKeyGenerator that always returns the same key on every invocation:</p>
<pre class="programlisting">KeyGenerators.shared(<span class="hl-number">16</span>);</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="stringkeygenerator" href="index.html#stringkeygenerator"></a>37.3.2&nbsp;StringKeyGenerator</h3></div></div></div>
<p>Use the KeyGenerators.string factory method to construct a 8-byte, SecureRandom KeyGenerator that hex-encodes each key as a String:</p>
<pre class="programlisting">KeyGenerators.string();</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-security-crypto-passwordencoders" href="index.html#spring-security-crypto-passwordencoders"></a>37.4&nbsp;Password Encoding</h2></div></div></div>
<p>The password package of the spring-security-crypto module provides support for encoding passwords. <code class="literal">PasswordEncoder</code> is the central service interface and has the following signature:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> PasswordEncoder {

String encode(String rawPassword);

<span class="hl-keyword">boolean</span> matches(String rawPassword, String encodedPassword);
}</pre>
<p>The matches method returns true if the rawPassword, once encoded, equals the encodedPassword. This method is designed to support password-based authentication schemes.</p>
<p>The <code class="literal">BCryptPasswordEncoder</code> implementation uses the widely supported "bcrypt" algorithm to hash the passwords. Bcrypt uses a random 16 byte salt value and is a deliberately slow algorithm, in order to hinder password crackers. The amount of work it does can be tuned using the "strength" parameter which takes values from 4 to 31. The higher the value, the more work has to be done to calculate the hash. The default value is 10. You can change this value in your deployed system without affecting existing passwords, as the value is also stored in the encoded hash.</p>
<pre class="programlisting"><span class="hl-comment">// Create an encoder with strength 16</span>
BCryptPasswordEncoder encoder = <span class="hl-keyword">new</span> BCryptPasswordEncoder(<span class="hl-number">16</span>);
String result = encoder.encode(<span class="hl-string">"myPassword"</span>);
assertTrue(encoder.matches(<span class="hl-string">"myPassword"</span>, result));</pre>
<p>The <code class="literal">Pbkdf2PasswordEncoder</code> implementation uses PBKDF2 algorithm to hash the passwords.
In order to defeat password cracking PBKDF2 is a deliberately slow algorithm and should be tuned to take about .5 seconds to verify a password on your system.</p>
<pre class="programlisting"><span class="hl-comment">// Create an encoder with all the defaults</span>
Pbkdf2PasswordEncoder encoder = <span class="hl-keyword">new</span> Pbkdf2PasswordEncoder();
String result = encoder.encode(<span class="hl-string">"myPassword"</span>);
assertTrue(encoder.matches(<span class="hl-string">"myPassword"</span>, result));</pre>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="concurrency" href="index.html#concurrency"></a>38.&nbsp;Concurrency Support</h2></div></div></div>
<p>In most environments, Security is stored on a per <code class="literal">Thread</code> basis. This means that when work is done on a new <code class="literal">Thread</code>, the <code class="literal">SecurityContext</code> is lost. Spring Security provides some infrastructure to help make this much easier for users. Spring Security provides low level abstractions for working with Spring Security in multi-threaded environments. In fact, this is what Spring Security builds on to integration with <a class="xref" href="index.html#servletapi-start-runnable" title="16.2.4&nbsp;AsyncContext.start(Runnable)">Section&nbsp;16.2.4, &#8220;AsyncContext.start(Runnable)&#8221;</a> and <a class="xref" href="index.html#mvc-async" title="39.4&nbsp;Spring MVC Async Integration">Section&nbsp;39.4, &#8220;Spring MVC Async Integration&#8221;</a>.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="delegatingsecuritycontextrunnable" href="index.html#delegatingsecuritycontextrunnable"></a>38.1&nbsp;DelegatingSecurityContextRunnable</h2></div></div></div>
<p>One of the most fundamental building blocks within Spring Security&#8217;s concurrency support is the <code class="literal">DelegatingSecurityContextRunnable</code>. It wraps a delegate <code class="literal">Runnable</code> in order to initialize the <code class="literal">SecurityContextHolder</code> with a specified <code class="literal">SecurityContext</code> for the delegate. It then invokes the delegate Runnable ensuring to clear the <code class="literal">SecurityContextHolder</code> afterwards. The <code class="literal">DelegatingSecurityContextRunnable</code> looks something like this:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">void</span> run() {
<span class="hl-keyword">try</span> {
	SecurityContextHolder.setContext(securityContext);
	delegate.run();
} <span class="hl-keyword">finally</span> {
	SecurityContextHolder.clearContext();
}
}</pre>
<p>While very simple, it makes it seamless to transfer the SecurityContext from one Thread to another. This is important since, in most cases, the SecurityContextHolder acts on a per Thread basis. For example, you might have used Spring Security&#8217;s <a class="xref" href="index.html#nsa-global-method-security" title="43.4.1&nbsp;<global-method-security&gt;">Section&nbsp;43.4.1, &#8220;&lt;global-method-security&gt;&#8221;</a> support to secure one of your services. You can now easily transfer the <code class="literal">SecurityContext</code> of the current <code class="literal">Thread</code> to the <code class="literal">Thread</code> that invokes the secured service. An example of how you might do this can be found below:</p>
<pre class="programlisting">Runnable originalRunnable = <span class="hl-keyword">new</span> Runnable() {
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> run() {
	<span class="hl-comment">// invoke secured service</span>
}
};

SecurityContext context = SecurityContextHolder.getContext();
DelegatingSecurityContextRunnable wrappedRunnable =
	<span class="hl-keyword">new</span> DelegatingSecurityContextRunnable(originalRunnable, context);

<span class="hl-keyword">new</span> Thread(wrappedRunnable).start();</pre>
<p>The code above performs the following steps:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Creates a <code class="literal">Runnable</code> that will be invoking our secured service. Notice that it is not aware of Spring Security
</li><li class="listitem">
Obtains the <code class="literal">SecurityContext</code> that we wish to use from the <code class="literal">SecurityContextHolder</code> and initializes the <code class="literal">DelegatingSecurityContextRunnable</code>
</li><li class="listitem">
Use the <code class="literal">DelegatingSecurityContextRunnable</code> to create a Thread
</li><li class="listitem">
Start the Thread we created
</li></ul></div>
<p>Since it is quite common to create a <code class="literal">DelegatingSecurityContextRunnable</code> with the <code class="literal">SecurityContext</code> from the <code class="literal">SecurityContextHolder</code> there is a shortcut constructor for it. The following code is the same as the code above:</p>
<pre class="programlisting">Runnable originalRunnable = <span class="hl-keyword">new</span> Runnable() {
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> run() {
	<span class="hl-comment">// invoke secured service</span>
}
};

DelegatingSecurityContextRunnable wrappedRunnable =
	<span class="hl-keyword">new</span> DelegatingSecurityContextRunnable(originalRunnable);

<span class="hl-keyword">new</span> Thread(wrappedRunnable).start();</pre>
<p>The code we have is simple to use, but it still requires knowledge that we are using Spring Security. In the next section we will take a look at how we can utilize <code class="literal">DelegatingSecurityContextExecutor</code> to hide the fact that we are using Spring Security.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="delegatingsecuritycontextexecutor" href="index.html#delegatingsecuritycontextexecutor"></a>38.2&nbsp;DelegatingSecurityContextExecutor</h2></div></div></div>
<p>In the previous section we found that it was easy to use the <code class="literal">DelegatingSecurityContextRunnable</code>, but it was not ideal since we had to be aware of Spring Security in order to use it. Let&#8217;s take a look at how <code class="literal">DelegatingSecurityContextExecutor</code> can shield our code from any knowledge that we are using Spring Security.</p>
<p>The design of <code class="literal">DelegatingSecurityContextExecutor</code> is very similar to that of <code class="literal">DelegatingSecurityContextRunnable</code> except it accepts a delegate <code class="literal">Executor</code> instead of a delegate <code class="literal">Runnable</code>. You can see an example of how it might be used below:</p>
<pre class="programlisting">SecurityContext context = SecurityContextHolder.createEmptyContext();
Authentication authentication =
	<span class="hl-keyword">new</span> UsernamePasswordAuthenticationToken(<span class="hl-string">"user"</span>,<span class="hl-string">"doesnotmatter"</span>, AuthorityUtils.createAuthorityList(<span class="hl-string">"ROLE_USER"</span>));
context.setAuthentication(authentication);

SimpleAsyncTaskExecutor delegateExecutor =
	<span class="hl-keyword">new</span> SimpleAsyncTaskExecutor();
DelegatingSecurityContextExecutor executor =
	<span class="hl-keyword">new</span> DelegatingSecurityContextExecutor(delegateExecutor, context);

Runnable originalRunnable = <span class="hl-keyword">new</span> Runnable() {
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> run() {
	<span class="hl-comment">// invoke secured service</span>
}
};

executor.execute(originalRunnable);</pre>
<p>The code performs the following steps:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Creates the <code class="literal">SecurityContext</code> to be used for our <code class="literal">DelegatingSecurityContextExecutor</code>. Note that in this example we simply create the <code class="literal">SecurityContext</code> by hand. However, it does not matter where or how we get the <code class="literal">SecurityContext</code> (i.e. we could obtain it from the <code class="literal">SecurityContextHolder</code> if we wanted).
</li><li class="listitem">
Creates a delegateExecutor that is in charge of executing submitted <code class="literal">Runnable</code>s
</li><li class="listitem">
Finally we create a <code class="literal">DelegatingSecurityContextExecutor</code> which is in charge of wrapping any Runnable that is passed into the execute method with a <code class="literal">DelegatingSecurityContextRunnable</code>. It then passes the wrapped Runnable to the delegateExecutor. In this instance, the same <code class="literal">SecurityContext</code> will be used for every Runnable submitted to our <code class="literal">DelegatingSecurityContextExecutor</code>. This is nice if we are running background tasks that need to be run by a user with elevated privileges.
</li><li class="listitem">
At this point you may be asking yourself "How does this shield my code of any knowledge of Spring Security?" Instead of creating the <code class="literal">SecurityContext</code> and the <code class="literal">DelegatingSecurityContextExecutor</code> in our own code, we can inject an already initialized instance of <code class="literal">DelegatingSecurityContextExecutor</code>.
</li></ul></div>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
<span class="hl-keyword">private</span> Executor executor; <span class="hl-comment">// becomes an instance of our DelegatingSecurityContextExecutor</span>

<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> submitRunnable() {
Runnable originalRunnable = <span class="hl-keyword">new</span> Runnable() {
	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> run() {
	<span class="hl-comment">// invoke secured service</span>
	}
};
executor.execute(originalRunnable);
}</pre>
<p>Now our code is unaware that the <code class="literal">SecurityContext</code> is being propagated to the <code class="literal">Thread</code>, then the <code class="literal">originalRunnable</code> is executed, and then the <code class="literal">SecurityContextHolder</code> is cleared out. In this example, the same user is being used to execute each Thread. What if we wanted to use the user from <code class="literal">SecurityContextHolder</code> at the time we invoked <code class="literal">executor.execute(Runnable)</code> (i.e. the currently logged in user) to process <code class="literal">originalRunnable</code>? This can be done by removing the <code class="literal">SecurityContext</code> argument from our <code class="literal">DelegatingSecurityContextExecutor</code> constructor. For example:</p>
<pre class="programlisting">SimpleAsyncTaskExecutor delegateExecutor = <span class="hl-keyword">new</span> SimpleAsyncTaskExecutor();
DelegatingSecurityContextExecutor executor =
	<span class="hl-keyword">new</span> DelegatingSecurityContextExecutor(delegateExecutor);</pre>
<p>Now anytime <code class="literal">executor.execute(Runnable)</code> is executed the <code class="literal">SecurityContext</code> is first obtained by the <code class="literal">SecurityContextHolder</code> and then that <code class="literal">SecurityContext</code> is used to create our <code class="literal">DelegatingSecurityContextRunnable</code>. This means that we are executing our <code class="literal">Runnable</code> with the same user that was used to invoke the <code class="literal">executor.execute(Runnable)</code> code.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-security-concurrency-classes" href="index.html#spring-security-concurrency-classes"></a>38.3&nbsp;Spring Security Concurrency Classes</h2></div></div></div>
<p>Refer to the Javadoc for additional integrations with both the Java concurrent APIs and the Spring Task abstractions. They are quite self-explanatory once you understand the previous code.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
DelegatingSecurityContextCallable
</li><li class="listitem">
DelegatingSecurityContextExecutor
</li><li class="listitem">
DelegatingSecurityContextExecutorService
</li><li class="listitem">
DelegatingSecurityContextRunnable
</li><li class="listitem">
DelegatingSecurityContextScheduledExecutorService
</li><li class="listitem">
DelegatingSecurityContextSchedulingTaskExecutor
</li><li class="listitem">
DelegatingSecurityContextAsyncTaskExecutor
</li><li class="listitem">
DelegatingSecurityContextTaskExecutor
</li></ul></div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="mvc" href="index.html#mvc"></a>39.&nbsp;Spring MVC Integration</h2></div></div></div>
<p>Spring Security provides a number of optional integrations with Spring MVC. This section covers the integration in further detail.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-enablewebmvcsecurity" href="index.html#mvc-enablewebmvcsecurity"></a>39.1&nbsp;@EnableWebMvcSecurity</h2></div></div></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As of Spring Security 4.0, <code class="literal">@EnableWebMvcSecurity</code> is deprecated. The replacement is <code class="literal">@EnableWebSecurity</code> which will determine adding the Spring MVC features based upon the classpath.</p>
</td></tr></table></div>
<p>To enable Spring Security integration with Spring MVC add the <code class="literal">@EnableWebSecurity</code> annotation to your configuration.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring Security provides the configuration using Spring MVC&#8217;s <a class="ulink" href="https://docs.spring.io/spring/docs/5.0.0.RELEASE/spring-framework-reference/web.html#mvc-config-customize" target="_top">WebMvcConfigurer</a>. This means that if you are using more advanced options, like integrating with <code class="literal">WebMvcConfigurationSupport</code> directly, then you will need to manually provide the Spring Security configuration.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-requestmatcher" href="index.html#mvc-requestmatcher"></a>39.2&nbsp;MvcRequestMatcher</h2></div></div></div>
<p>Spring Security provides deep integration with how Spring MVC matches on URLs with <code class="literal">MvcRequestMatcher</code>.
This is helpful to ensure your Security rules match the logic used to handle your requests.</p>
<p>In order to use <code class="literal">MvcRequestMatcher</code> you must place the Spring Security Configuration in the same <code class="literal">ApplicationContext</code> as your <code class="literal">DispatcherServlet</code>.
This is necessary because Spring Security&#8217;s <code class="literal">MvcRequestMatcher</code> expects a <code class="literal">HandlerMappingIntrospector</code> bean with the name of <code class="literal">mvcHandlerMappingIntrospector</code> to be registered by your Spring MVC configuration that is used to perform the matching.</p>
<p>For a <code class="literal">web.xml</code> this means that you should place your configuration in the <code class="literal">DispatcherServlet.xml</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;listener&gt;</span>
  <span class="hl-tag">&lt;listener-class&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="hl-tag">&lt;/listener-class&gt;</span>
<span class="hl-tag">&lt;/listener&gt;</span>

<span class="hl-comment">&lt;!-- All Spring Configuration (both MVC and Security) are in /WEB-INF/spring/ --&gt;</span>
<span class="hl-tag">&lt;context-param&gt;</span>
  <span class="hl-tag">&lt;param-name&gt;</span>contextConfigLocation<span class="hl-tag">&lt;/param-name&gt;</span>
  <span class="hl-tag">&lt;param-value&gt;</span>/WEB-INF/spring/*.xml<span class="hl-tag">&lt;/param-value&gt;</span>
<span class="hl-tag">&lt;/context-param&gt;</span>

<span class="hl-tag">&lt;servlet&gt;</span>
  <span class="hl-tag">&lt;servlet-name&gt;</span>spring<span class="hl-tag">&lt;/servlet-name&gt;</span>
  <span class="hl-tag">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="hl-tag">&lt;/servlet-class&gt;</span>
  <span class="hl-comment">&lt;!-- Load from the ContextLoaderListener --&gt;</span>
  <span class="hl-tag">&lt;init-param&gt;</span>
    <span class="hl-tag">&lt;param-name&gt;</span>contextConfigLocation<span class="hl-tag">&lt;/param-name&gt;</span>
    <span class="hl-tag">&lt;param-value&gt;</span><span class="hl-tag">&lt;/param-value&gt;</span>
  <span class="hl-tag">&lt;/init-param&gt;</span>
<span class="hl-tag">&lt;/servlet&gt;</span>

<span class="hl-tag">&lt;servlet-mapping&gt;</span>
  <span class="hl-tag">&lt;servlet-name&gt;</span>spring<span class="hl-tag">&lt;/servlet-name&gt;</span>
  <span class="hl-tag">&lt;url-pattern&gt;</span>/<span class="hl-tag">&lt;/url-pattern&gt;</span>
<span class="hl-tag">&lt;/servlet-mapping&gt;</span></pre>
<p>Below <code class="literal">WebSecurityConfiguration</code> in placed in the <code class="literal">DispatcherServlet</code>s <code class="literal">ApplicationContext</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SecurityInitializer <span class="hl-keyword">extends</span>
    AbstractAnnotationConfigDispatcherServletInitializer {

  <em><span class="hl-annotation" style="color: gray">@Override</span></em>
  <span class="hl-keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() {
    <span class="hl-keyword">return</span> null;
  }

  <em><span class="hl-annotation" style="color: gray">@Override</span></em>
  <span class="hl-keyword">protected</span> Class&lt;?&gt;[] getServletConfigClasses() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Class[] { RootConfiguration.<span class="hl-keyword">class</span>,
        WebMvcConfiguration.<span class="hl-keyword">class</span> };
  }

  <em><span class="hl-annotation" style="color: gray">@Override</span></em>
  <span class="hl-keyword">protected</span> String[] getServletMappings() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> String[] { <span class="hl-string">"/"</span> };
  }
}</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It is always recommended to provide authorization rules by matching on the <code class="literal">HttpServletRequest</code> and method security.</p>
<p>Providing authorization rules by matching on <code class="literal">HttpServletRequest</code> is good because it happens very early in the code path and helps reduce the <a class="ulink" href="https://en.wikipedia.org/wiki/Attack_surface" target="_top">attack surface</a>.
Method security ensures that if someone has bypassed the web authorization rules, that your application is still secured.
This is what is known as <a class="ulink" href="https://en.wikipedia.org/wiki/Defense_in_depth_(computing)" target="_top">Defence in Depth</a></p>
</td></tr></table></div>
<p>Consider a controller that is mapped as follows:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RequestMapping("/admin")</span></em>
<span class="hl-keyword">public</span> String admin() {</pre>
<p>If we wanted to restrict access to this controller method to admin users, a developer can provide authorization rules by matching on the <code class="literal">HttpServletRequest</code> with the following:</p>
<pre class="programlisting"><span class="hl-keyword">protected</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
		.authorizeRequests()
			.antMatchers(<span class="hl-string">"/admin"</span>).hasRole(<span class="hl-string">"ADMIN"</span>);
}</pre>
<p>or in XML</p>
<pre class="programlisting"><span class="hl-tag">&lt;http&gt;</span>
	<span class="hl-tag">&lt;intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/admin"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"hasRole('ADMIN')"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
<p>With either configuration, the URL <code class="literal">/admin</code> will require the authenticated user to be an admin user.
However, depending on our Spring MVC configuration, the URL <code class="literal">/admin.html</code> will also map to our <code class="literal">admin()</code> method.
Additionally, depending on our Spring MVC configuration, the URL <code class="literal">/admin/</code> will also map to our <code class="literal">admin()</code> method.</p>
<p>The problem is that our security rule is only protecting <code class="literal">/admin</code>.
We could add additional rules for all the permutations of Spring MVC, but this would be quite verbose and tedious.</p>
<p>Instead, we can leverage Spring Security&#8217;s <code class="literal">MvcRequestMatcher</code>.
The following configuration will protect the same URLs that Spring MVC will match on by using Spring MVC to match on the URL.</p>
<pre class="programlisting"><span class="hl-keyword">protected</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	http
		.authorizeRequests()
			.mvcMatchers(<span class="hl-string">"/admin"</span>).hasRole(<span class="hl-string">"ADMIN"</span>);
}</pre>
<p>or in XML</p>
<pre class="programlisting"><span class="hl-tag">&lt;http</span> <span class="hl-attribute">request-matcher</span>=<span class="hl-value">"mvc"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/admin"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"hasRole('ADMIN')"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/http&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-authentication-principal" href="index.html#mvc-authentication-principal"></a>39.3&nbsp;@AuthenticationPrincipal</h2></div></div></div>
<p>Spring Security provides <code class="literal">AuthenticationPrincipalArgumentResolver</code> which can automatically resolve the current <code class="literal">Authentication.getPrincipal()</code> for Spring MVC arguments. By using <code class="literal">@EnableWebSecurity</code> you will automatically have this added to your Spring MVC configuration. If you use XML based configuration, you must add this yourself. For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;mvc:annotation-driven&gt;</span>
		<span class="hl-tag">&lt;mvc:argument-resolvers&gt;</span>
				<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.web.method.annotation.AuthenticationPrincipalArgumentResolver"</span><span class="hl-tag"> /&gt;</span>
		<span class="hl-tag">&lt;/mvc:argument-resolvers&gt;</span>
<span class="hl-tag">&lt;/mvc:annotation-driven&gt;</span></pre>
<p>Once <code class="literal">AuthenticationPrincipalArgumentResolver</code> is properly configured, you can be entirely decoupled from Spring Security in your Spring MVC layer.</p>
<p>Consider a situation where a custom <code class="literal">UserDetailsService</code> that returns an <code class="literal">Object</code> that implements <code class="literal">UserDetails</code> and your own <code class="literal">CustomUser</code> <code class="literal">Object</code>. The <code class="literal">CustomUser</code> of the currently authenticated user could be accessed using the following code:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RequestMapping("/messages/inbox")</span></em>
<span class="hl-keyword">public</span> ModelAndView findMessagesForUser() {
	Authentication authentication =
	SecurityContextHolder.getContext().getAuthentication();
	CustomUser custom = (CustomUser) authentication == null ? null : authentication.getPrincipal();

	<span class="hl-comment">// .. find messages for this user and return them ...</span>
}</pre>
<p>As of Spring Security 3.2 we can resolve the argument more directly by adding an annotation. For example:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.security.core.annotation.AuthenticationPrincipal;

<span class="hl-comment">// ...</span>

<em><span class="hl-annotation" style="color: gray">@RequestMapping("/messages/inbox")</span></em>
<span class="hl-keyword">public</span> ModelAndView findMessagesForUser(<em><span class="hl-annotation" style="color: gray">@AuthenticationPrincipal</span></em> CustomUser customUser) {

	<span class="hl-comment">// .. find messages for this user and return them ...</span>
}</pre>
<p>Sometimes it may be necessary to transform the principal in some way.
For example, if <code class="literal">CustomUser</code> needed to be final it could not be extended.
In this situation the <code class="literal">UserDetailsService</code> might returns an <code class="literal">Object</code> that implements <code class="literal">UserDetails</code> and provides a method named <code class="literal">getCustomUser</code> to access <code class="literal">CustomUser</code>.
For example, it might look like:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CustomUserUserDetails <span class="hl-keyword">extends</span> User {
		<span class="hl-comment">// ...</span>
		<span class="hl-keyword">public</span> CustomUser getCustomUser() {
				<span class="hl-keyword">return</span> customUser;
		}
}</pre>
<p>We could then access the <code class="literal">CustomUser</code> using a <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html" target="_top">SpEL expression</a> that uses <code class="literal">Authentication.getPrincipal()</code> as the root object:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.security.core.annotation.AuthenticationPrincipal;

<span class="hl-comment">// ...</span>

<em><span class="hl-annotation" style="color: gray">@RequestMapping("/messages/inbox")</span></em>
<span class="hl-keyword">public</span> ModelAndView findMessagesForUser(<em><span class="hl-annotation" style="color: gray">@AuthenticationPrincipal(expression = "customUser")</span></em> CustomUser customUser) {

	<span class="hl-comment">// .. find messags for this user and return them ...</span>
}</pre>
<p>We can also refer to Beans in our SpEL expressions.
For example, the following could be used if we were using JPA to manage our Users and we wanted to modify and save a property on the current user.</p>
<pre class="programlisting"><span class="hl-keyword">import</span> org.springframework.security.core.annotation.AuthenticationPrincipal;

<span class="hl-comment">// ...</span>

<em><span class="hl-annotation" style="color: gray">@PutMapping("/users/self")</span></em>
<span class="hl-keyword">public</span> ModelAndView updateName(<em><span class="hl-annotation" style="color: gray">@AuthenticationPrincipal(expression = "@jpaEntityManager.merge(#this)")</span></em> CustomUser attachedCustomUser,
		<em><span class="hl-annotation" style="color: gray">@RequestParam</span></em> String firstName) {

	<span class="hl-comment">// change the firstName on an attached instance which will be persisted to the database</span>
	attachedCustomUser.setFirstName(firstName);

	<span class="hl-comment">// ...</span>
}</pre>
<p>We can further remove our dependency on Spring Security by making <code class="literal">@AuthenticationPrincipal</code> a meta annotation on our own annotation. Below we demonstrate how we could do this on an annotation named <code class="literal">@CurrentUser</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It is important to realize that in order to remove the dependency on Spring Security, it is the consuming application that would create <code class="literal">@CurrentUser</code>. This step is not strictly required, but assists in isolating your dependency to Spring Security to a more central location.</p>
</td></tr></table></div>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Target({ElementType.PARAMETER, ElementType.TYPE})</span></em>
<em><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></em>
<em><span class="hl-annotation" style="color: gray">@Documented</span></em>
<em><span class="hl-annotation" style="color: gray">@AuthenticationPrincipal</span></em>
<span class="hl-keyword">public</span> <em><span class="hl-annotation" style="color: gray">@interface</span></em> CurrentUser {}</pre>
<p>Now that <code class="literal">@CurrentUser</code> has been specified, we can use it to signal to resolve our <code class="literal">CustomUser</code> of the currently authenticated user. We have also isolated our dependency on Spring Security to a single file.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RequestMapping("/messages/inbox")</span></em>
<span class="hl-keyword">public</span> ModelAndView findMessagesForUser(<em><span class="hl-annotation" style="color: gray">@CurrentUser</span></em> CustomUser customUser) {

	<span class="hl-comment">// .. find messages for this user and return them ...</span>
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-async" href="index.html#mvc-async"></a>39.4&nbsp;Spring MVC Async Integration</h2></div></div></div>
<p>Spring Web MVC 3.2+ has excellent support for <a class="ulink" href="https://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/mvc.html#mvc-ann-async" target="_top">Asynchronous Request Processing</a>. With no additional configuration, Spring Security will automatically setup the <code class="literal">SecurityContext</code> to the <code class="literal">Thread</code> that executes a <code class="literal">Callable</code> returned by your controllers. For example, the following method will automatically have its <code class="literal">Callable</code> executed with the <code class="literal">SecurityContext</code> that was available when the <code class="literal">Callable</code> was created:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RequestMapping(method=RequestMethod.POST)</span></em>
<span class="hl-keyword">public</span> Callable&lt;String&gt; processUpload(<span class="hl-keyword">final</span> MultipartFile file) {

<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Callable&lt;String&gt;() {
	<span class="hl-keyword">public</span> Object call() <span class="hl-keyword">throws</span> Exception {
	<span class="hl-comment">// ...</span>
	<span class="hl-keyword">return</span> <span class="hl-string">"someView"</span>;
	}
};
}</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Associating SecurityContext to Callable&#8217;s"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Associating SecurityContext to Callable&#8217;s</th></tr><tr><td align="left" valign="top">
<p>More technically speaking, Spring Security integrates with <code class="literal">WebAsyncManager</code>. The <code class="literal">SecurityContext</code> that is used to process the <code class="literal">Callable</code> is the <code class="literal">SecurityContext</code> that exists on the <code class="literal">SecurityContextHolder</code> at the time <code class="literal">startCallableProcessing</code> is invoked.</p>
</td></tr></table></div>
<p>There is no automatic integration with a <code class="literal">DeferredResult</code> that is returned by controllers.
This is because <code class="literal">DeferredResult</code> is processed by the users and thus there is no way of automatically integrating with it.
However, you can still use <a class="link" href="index.html#concurrency" title="38.&nbsp;Concurrency Support">Concurrency Support</a> to provide transparent integration with Spring Security.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mvc-csrf" href="index.html#mvc-csrf"></a>39.5&nbsp;Spring MVC and CSRF Integration</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="automatic-token-inclusion" href="index.html#automatic-token-inclusion"></a>39.5.1&nbsp;Automatic Token Inclusion</h3></div></div></div>
<p>Spring Security will automatically <a class="link" href="index.html#csrf-include-csrf-token" title="19.4.3&nbsp;Include the CSRF Token">include the CSRF Token</a> within forms that use the <a class="ulink" href="https://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/view.html#view-jsp-formtaglib-formtag" target="_top">Spring MVC form tag</a>. For example, the following JSP:</p>
<pre class="programlisting"><span class="hl-tag">&lt;jsp:root</span> <span class="hl-attribute">xmlns:jsp</span>=<span class="hl-value">"http://java.sun.com/JSP/Page"</span>
	<span class="hl-attribute">xmlns:c</span>=<span class="hl-value">"http://java.sun.com/jsp/jstl/core"</span>
	<span class="hl-attribute">xmlns:form</span>=<span class="hl-value">"http://www.springframework.org/tags/form"</span> <span class="hl-attribute">version</span>=<span class="hl-value">"2.0"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;jsp:directive.page</span> <span class="hl-attribute">language</span>=<span class="hl-value">"java"</span> <span class="hl-attribute">contentType</span>=<span class="hl-value">"text/html"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;html</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.w3.org/1999/xhtml"</span> <span class="hl-attribute">lang</span>=<span class="hl-value">"en"</span> <span class="hl-attribute">xml:lang</span>=<span class="hl-value">"en"</span><span class="hl-tag">&gt;</span>
	<span class="hl-comment">&lt;!-- ... --&gt;</span>

	<span class="hl-tag">&lt;c:url</span> <span class="hl-attribute">var</span>=<span class="hl-value">"logoutUrl"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/logout"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;form:form</span> <span class="hl-attribute">action</span>=<span class="hl-value">"${logoutUrl}"</span>
		<span class="hl-attribute">method</span>=<span class="hl-value">"post"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span>
		<span class="hl-attribute">value</span>=<span class="hl-value">"Log out"</span><span class="hl-tag"> /&gt;</span>
	<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span>
		<span class="hl-attribute">name</span>=<span class="hl-value">"${_csrf.parameterName}"</span>
		<span class="hl-attribute">value</span>=<span class="hl-value">"${_csrf.token}"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;/form:form&gt;</span>

	<span class="hl-comment">&lt;!-- ... --&gt;</span>
<span class="hl-tag">&lt;/html&gt;</span>
<span class="hl-tag">&lt;/jsp:root&gt;</span></pre>
<p>Will output HTML that is similar to the following:</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- ... --&gt;</span>

<span class="hl-tag">&lt;form</span> <span class="hl-attribute">action</span>=<span class="hl-value">"/context/logout"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"post"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"submit"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Log out"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;input</span> <span class="hl-attribute">type</span>=<span class="hl-value">"hidden"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"_csrf"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"f81d4fae-7dec-11d0-a765-00a0c91e6bf6"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/form&gt;</span>

<span class="hl-comment">&lt;!-- ... --&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mvc-csrf-resolver" href="index.html#mvc-csrf-resolver"></a>39.5.2&nbsp;Resolving the CsrfToken</h3></div></div></div>
<p>Spring Security provides <code class="literal">CsrfTokenArgumentResolver</code> which can automatically resolve the current <code class="literal">CsrfToken</code> for Spring MVC arguments.
By using <a class="link" href="index.html#jc-hello-wsca">@EnableWebSecurity</a> you will automatically have this added to your Spring MVC configuration.
If you use XML based configuraiton, you must add this yourself.</p>
<p>Once <code class="literal">CsrfTokenArgumentResolver</code> is properly configured, you can expose the <code class="literal">CsrfToken</code> to your static HTML based application.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RestController</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CsrfController {

	<em><span class="hl-annotation" style="color: gray">@RequestMapping("/csrf")</span></em>
	<span class="hl-keyword">public</span> CsrfToken csrf(CsrfToken token) {
		<span class="hl-keyword">return</span> token;
	}
}</pre>
<p>It is important to keep the <code class="literal">CsrfToken</code> a secret from other domains.
This means if you are using <a class="ulink" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS" target="_top">Cross Origin Sharing (CORS)</a>, you should <span class="strong"><strong>NOT</strong></span> expose the <code class="literal">CsrfToken</code> to any external domains.</p>
</div>
</div>
</div>
</div>
<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="data" href="index.html#data"></a>Part&nbsp;VII.&nbsp;Spring Data Integration</h1></div></div></div>
<div class="partintro"><div></div>
<p>Spring Security provides Spring Data integration that allows referring to the current user within your queries.
It is not only useful but necessary to include the user in the queries to support paged results since filtering the results afterwards would not scale.</p>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="data-configuration" href="index.html#data-configuration"></a>40.&nbsp;Spring Data &amp; Spring Security Configuration</h2></div></div></div>
<p>To use this support, provide a bean of type <code class="literal">SecurityEvaluationContextExtension</code>.
In Java Configuration, this would look like:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> SecurityEvaluationContextExtension securityEvaluationContextExtension() {
	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SecurityEvaluationContextExtension();
}</pre>
<p>In XML Configuration, this would look like:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.data.repository.query.SecurityEvaluationContextExtension"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="data-query" href="index.html#data-query"></a>41.&nbsp;Security Expressions within @Query</h2></div></div></div>
<p>Now Spring Security can be used within your queries.
For example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Repository</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MessageRepository <span class="hl-keyword">extends</span> PagingAndSortingRepository&lt;Message,Long&gt; {
	<em><span class="hl-annotation" style="color: gray">@Query("select m from Message m where m.to.id = ?#{ principal?.id }")</span></em>
	Page&lt;Message&gt; findInbox(Pageable pageable);
}</pre>
<p>This checks to see if the <code class="literal">Authentication.getPrincipal().getId()</code> is equal to the recipient of the <code class="literal">Message</code>.
Note that this example assumes you have customized the principal to be an Object that has an id property.
By exposing the <code class="literal">SecurityEvaluationContextExtension</code> bean, all of the <a class="link" href="index.html#common-expressions" title="Table&nbsp;27.1.&nbsp;Common built-in expressions">Common Security Expressions</a> are available within the Query.</p>
</div>
</div>
<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="appendix" href="index.html#appendix"></a>Part&nbsp;VIII.&nbsp;Appendix</h1></div></div></div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="appendix-schema" href="index.html#appendix-schema"></a>42.&nbsp;Security Database Schema</h2></div></div></div>
<p>There are various database schema used by the framework and this appendix provides a single reference point to them all. You only need to provide the tables for the areas of functionality you require.</p>
<p>DDL statements are given for the HSQLDB database. You can use these as a guideline for defining the schema for the database you are using.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="user-schema" href="index.html#user-schema"></a>42.1&nbsp;User Schema</h2></div></div></div>
<p>The standard JDBC implementation of the <code class="literal">UserDetailsService</code> (<code class="literal">JdbcDaoImpl</code>) requires tables to load the password, account status (enabled or disabled) and a list of authorities (roles) for the user. You will need to adjust this schema to match the database dialect you are using.</p>
<pre class="screen">create table users(
	username varchar_ignorecase(50) not null primary key,
	password varchar_ignorecase(50) not null,
	enabled boolean not null
);

create table authorities (
	username varchar_ignorecase(50) not null,
	authority varchar_ignorecase(50) not null,
	constraint fk_authorities_users foreign key(username) references users(username)
);
create unique index ix_auth_username on authorities (username,authority);</pre>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="group-authorities" href="index.html#group-authorities"></a>42.1.1&nbsp;Group Authorities</h3></div></div></div>
<p>Spring Security 2.0 introduced support for group authorities in <code class="literal">JdbcDaoImpl</code>. The table structure if groups are enabled is as follows. You will need to adjust this schema to match the database dialect you are using.</p>
<pre class="screen">create table groups (
	id bigint generated by default as identity(start with 0) primary key,
	group_name varchar_ignorecase(50) not null
);

create table group_authorities (
	group_id bigint not null,
	authority varchar(50) not null,
	constraint fk_group_authorities_group foreign key(group_id) references groups(id)
);

create table group_members (
	id bigint generated by default as identity(start with 0) primary key,
	username varchar(50) not null,
	group_id bigint not null,
	constraint fk_group_members_group foreign key(group_id) references groups(id)
);</pre>
<p>Remember that these tables are only required if you are using the provided JDBC <code class="literal">UserDetailsService</code> implementation. If you write your own or choose to implement <code class="literal">AuthenticationProvider</code> without a <code class="literal">UserDetailsService</code>, then you have complete freedom over how you store the data, as long as the interface contract is satisfied.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="persistent-login-remember-me-schema" href="index.html#persistent-login-remember-me-schema"></a>42.2&nbsp;Persistent Login (Remember-Me) Schema</h2></div></div></div>
<p>This table is used to store data used by the more secure <a class="link" href="index.html#remember-me-persistent-token" title="18.3&nbsp;Persistent Token Approach">persistent token</a> remember-me implementation. If you are using <code class="literal">JdbcTokenRepositoryImpl</code> either directly or through the namespace, then you will need this table. Remember to adjust this schema to match the database dialect you are using.</p>
<pre class="screen">create table persistent_logins (
	username varchar(64) not null,
	series varchar(64) primary key,
	token varchar(64) not null,
	last_used timestamp not null
);</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="dbschema-acl" href="index.html#dbschema-acl"></a>42.3&nbsp;ACL Schema</h2></div></div></div>
<p>There are four tables used by the Spring Security <a class="link" href="index.html#domain-acls" title="28.&nbsp;Domain Object Security (ACLs)">ACL</a> implementation.</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<code class="literal">acl_sid</code> stores the security identities recognised by the ACL system. These can be unique principals or authorities which may apply to multiple principals.
</li><li class="listitem">
<code class="literal">acl_class</code> defines the domain object types to which ACLs apply. The <code class="literal">class</code> column stores the Java class name of the object.
</li><li class="listitem">
<code class="literal">acl_object_identity</code> stores the object identity definitions of specific domai objects.
</li><li class="listitem">
<code class="literal">acl_entry</code> stores the ACL permissions which apply to a specific object identity and security identity.
</li></ol></div>
<p>It is assumed that the database will auto-generate the primary keys for each of the identities. The <code class="literal">JdbcMutableAclService</code> has to be able to retrieve these when it has created a new row in the <code class="literal">acl_sid</code> or <code class="literal">acl_class</code> tables. It has two properties which define the SQL needed to retrieve these values <code class="literal">classIdentityQuery</code> and <code class="literal">sidIdentityQuery</code>. Both of these default to <code class="literal">call identity()</code></p>
<p>The ACL artifact JAR contains files for creating the ACL schema in HyperSQL (HSQLDB), PostgreSQL, MySQL/MariaDB, Microsoft SQL Server, and Oracle Database. These schemas are also demonstrated in the following sections.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="hypersql" href="index.html#hypersql"></a>42.3.1&nbsp;HyperSQL</h3></div></div></div>
<p>The default schema works with the embedded HSQLDB database that is used in unit tests within the framework.</p>
<pre class="programlisting">create table acl_sid(
	id bigint generated by default as identity(start with 100) not null primary key,
	principal boolean not null,
	sid varchar_ignorecase(100) not null,
	constraint unique_uk_1 unique(sid,principal)
);

create table acl_class(
	id bigint generated by default as identity(start with 100) not null primary key,
	class varchar_ignorecase(100) not null,
	constraint unique_uk_2 unique(class)
);

create table acl_object_identity(
	id bigint generated by default as identity(start with 100) not null primary key,
	object_id_class bigint not null,
	object_id_identity varchar_ignorecase(36) not null,
	parent_object bigint,
	owner_sid bigint,
	entries_inheriting boolean not null,
	constraint unique_uk_3 unique(object_id_class,object_id_identity),
	constraint foreign_fk_1 foreign key(parent_object)references acl_object_identity(id),
	constraint foreign_fk_2 foreign key(object_id_class)references acl_class(id),
	constraint foreign_fk_3 foreign key(owner_sid)references acl_sid(id)
);

create table acl_entry(
	id bigint generated by default as identity(start with 100) not null primary key,
	acl_object_identity bigint not null,
	ace_order int not null,
	sid bigint not null,
	mask integer not null,
	granting boolean not null,
	audit_success boolean not null,
	audit_failure boolean not null,
	constraint unique_uk_4 unique(acl_object_identity,ace_order),
	constraint foreign_fk_4 foreign key(acl_object_identity) references acl_object_identity(id),
	constraint foreign_fk_5 foreign key(sid) references acl_sid(id)
);</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="postgresql" href="index.html#postgresql"></a>42.3.2&nbsp;PostgreSQL</h3></div></div></div>
<pre class="programlisting">create table acl_sid(
	id bigserial not null primary key,
	principal boolean not null,
	sid varchar(100) not null,
	constraint unique_uk_1 unique(sid,principal)
);

create table acl_class(
	id bigserial not null primary key,
	class varchar(100) not null,
	constraint unique_uk_2 unique(class)
);

create table acl_object_identity(
	id bigserial primary key,
	object_id_class bigint not null,
	object_id_identity varchar(36) not null,
	parent_object bigint,
	owner_sid bigint,
	entries_inheriting boolean not null,
	constraint unique_uk_3 unique(object_id_class,object_id_identity),
	constraint foreign_fk_1 foreign key(parent_object)references acl_object_identity(id),
	constraint foreign_fk_2 foreign key(object_id_class)references acl_class(id),
	constraint foreign_fk_3 foreign key(owner_sid)references acl_sid(id)
);

create table acl_entry(
	id bigserial primary key,
	acl_object_identity bigint not null,
	ace_order int not null,
	sid bigint not null,
	mask integer not null,
	granting boolean not null,
	audit_success boolean not null,
	audit_failure boolean not null,
	constraint unique_uk_4 unique(acl_object_identity,ace_order),
	constraint foreign_fk_4 foreign key(acl_object_identity) references acl_object_identity(id),
	constraint foreign_fk_5 foreign key(sid) references acl_sid(id)
);</pre>
<p>You will have to set the <code class="literal">classIdentityQuery</code> and <code class="literal">sidIdentityQuery</code> properties of <code class="literal">JdbcMutableAclService</code> to the following values, respectively:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">select currval(pg_get_serial_sequence('acl_class', 'id'))</code>
</li><li class="listitem">
<code class="literal">select currval(pg_get_serial_sequence('acl_sid', 'id'))</code>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mysql-and-mariadb" href="index.html#mysql-and-mariadb"></a>42.3.3&nbsp;MySQL and MariaDB</h3></div></div></div>
<pre class="programlisting">CREATE TABLE acl_sid (
	id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
	principal BOOLEAN NOT NULL,
	sid VARCHAR(100) NOT NULL,
	UNIQUE KEY unique_acl_sid (sid, principal)
) ENGINE=InnoDB;

CREATE TABLE acl_class (
	id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
	class VARCHAR(100) NOT NULL,
	UNIQUE KEY uk_acl_class (class)
) ENGINE=InnoDB;

CREATE TABLE acl_object_identity (
	id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
	object_id_class BIGINT UNSIGNED NOT NULL,
	object_id_identity VARCHAR(36) NOT NULL,
	parent_object BIGINT UNSIGNED,
	owner_sid BIGINT UNSIGNED,
	entries_inheriting BOOLEAN NOT NULL,
	UNIQUE KEY uk_acl_object_identity (object_id_class, object_id_identity),
	CONSTRAINT fk_acl_object_identity_parent FOREIGN KEY (parent_object) REFERENCES acl_object_identity (id),
	CONSTRAINT fk_acl_object_identity_class FOREIGN KEY (object_id_class) REFERENCES acl_class (id),
	CONSTRAINT fk_acl_object_identity_owner FOREIGN KEY (owner_sid) REFERENCES acl_sid (id)
) ENGINE=InnoDB;

CREATE TABLE acl_entry (
	id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
	acl_object_identity BIGINT UNSIGNED NOT NULL,
	ace_order INTEGER NOT NULL,
	sid BIGINT UNSIGNED NOT NULL,
	mask INTEGER UNSIGNED NOT NULL,
	granting BOOLEAN NOT NULL,
	audit_success BOOLEAN NOT NULL,
	audit_failure BOOLEAN NOT NULL,
	UNIQUE KEY unique_acl_entry (acl_object_identity, ace_order),
	CONSTRAINT fk_acl_entry_object FOREIGN KEY (acl_object_identity) REFERENCES acl_object_identity (id),
	CONSTRAINT fk_acl_entry_acl FOREIGN KEY (sid) REFERENCES acl_sid (id)
) ENGINE=InnoDB;</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="microsoft-sql-server" href="index.html#microsoft-sql-server"></a>42.3.4&nbsp;Microsoft SQL Server</h3></div></div></div>
<pre class="programlisting">CREATE TABLE acl_sid (
	id BIGINT NOT NULL IDENTITY PRIMARY KEY,
	principal BIT NOT NULL,
	sid VARCHAR(100) NOT NULL,
	CONSTRAINT unique_acl_sid UNIQUE (sid, principal)
);

CREATE TABLE acl_class (
	id BIGINT NOT NULL IDENTITY PRIMARY KEY,
	class VARCHAR(100) NOT NULL,
	CONSTRAINT uk_acl_class UNIQUE (class)
);

CREATE TABLE acl_object_identity (
	id BIGINT NOT NULL IDENTITY PRIMARY KEY,
	object_id_class BIGINT NOT NULL,
	object_id_identity VARCHAR(36) NOT NULL,
	parent_object BIGINT,
	owner_sid BIGINT,
	entries_inheriting BIT NOT NULL,
	CONSTRAINT uk_acl_object_identity UNIQUE (object_id_class, object_id_identity),
	CONSTRAINT fk_acl_object_identity_parent FOREIGN KEY (parent_object) REFERENCES acl_object_identity (id),
	CONSTRAINT fk_acl_object_identity_class FOREIGN KEY (object_id_class) REFERENCES acl_class (id),
	CONSTRAINT fk_acl_object_identity_owner FOREIGN KEY (owner_sid) REFERENCES acl_sid (id)
);

CREATE TABLE acl_entry (
	id BIGINT NOT NULL IDENTITY PRIMARY KEY,
	acl_object_identity BIGINT NOT NULL,
	ace_order INTEGER NOT NULL,
	sid BIGINT NOT NULL,
	mask INTEGER NOT NULL,
	granting BIT NOT NULL,
	audit_success BIT NOT NULL,
	audit_failure BIT NOT NULL,
	CONSTRAINT unique_acl_entry UNIQUE (acl_object_identity, ace_order),
	CONSTRAINT fk_acl_entry_object FOREIGN KEY (acl_object_identity) REFERENCES acl_object_identity (id),
	CONSTRAINT fk_acl_entry_acl FOREIGN KEY (sid) REFERENCES acl_sid (id)
);</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="oracle-database" href="index.html#oracle-database"></a>42.3.5&nbsp;Oracle Database</h3></div></div></div>
<pre class="programlisting">CREATE TABLE acl_sid (
	id NUMBER(38) NOT NULL PRIMARY KEY,
	principal NUMBER(1) NOT NULL CHECK (principal in (0, 1)),
	sid NVARCHAR2(100) NOT NULL,
	CONSTRAINT unique_acl_sid UNIQUE (sid, principal)
);
CREATE SEQUENCE acl_sid_sequence START WITH 1 INCREMENT BY 1 NOMAXVALUE;
CREATE OR REPLACE TRIGGER acl_sid_id_trigger
	BEFORE INSERT ON acl_sid
	FOR EACH ROW
BEGIN
	SELECT acl_sid_sequence.nextval INTO :new.id FROM dual;
END;

CREATE TABLE acl_class (
	id NUMBER(38) NOT NULL PRIMARY KEY,
	class NVARCHAR2(100) NOT NULL,
	CONSTRAINT uk_acl_class UNIQUE (class)
);
CREATE SEQUENCE acl_class_sequence START WITH 1 INCREMENT BY 1 NOMAXVALUE;
CREATE OR REPLACE TRIGGER acl_class_id_trigger
	BEFORE INSERT ON acl_class
	FOR EACH ROW
BEGIN
	SELECT acl_class_sequence.nextval INTO :new.id FROM dual;
END;

CREATE TABLE acl_object_identity (
	id NUMBER(38) NOT NULL PRIMARY KEY,
	object_id_class NUMBER(38) NOT NULL,
	object_id_identity NVARCHAR2(36) NOT NULL,
	parent_object NUMBER(38),
	owner_sid NUMBER(38),
	entries_inheriting NUMBER(1) NOT NULL CHECK (entries_inheriting in (0, 1)),
	CONSTRAINT uk_acl_object_identity UNIQUE (object_id_class, object_id_identity),
	CONSTRAINT fk_acl_object_identity_parent FOREIGN KEY (parent_object) REFERENCES acl_object_identity (id),
	CONSTRAINT fk_acl_object_identity_class FOREIGN KEY (object_id_class) REFERENCES acl_class (id),
	CONSTRAINT fk_acl_object_identity_owner FOREIGN KEY (owner_sid) REFERENCES acl_sid (id)
);
CREATE SEQUENCE acl_object_identity_sequence START WITH 1 INCREMENT BY 1 NOMAXVALUE;
CREATE OR REPLACE TRIGGER acl_object_identity_id_trigger
	BEFORE INSERT ON acl_object_identity
	FOR EACH ROW
BEGIN
	SELECT acl_object_identity_sequence.nextval INTO :new.id FROM dual;
END;

CREATE TABLE acl_entry (
	id NUMBER(38) NOT NULL PRIMARY KEY,
	acl_object_identity NUMBER(38) NOT NULL,
	ace_order INTEGER NOT NULL,
	sid NUMBER(38) NOT NULL,
	mask INTEGER NOT NULL,
	granting NUMBER(1) NOT NULL CHECK (granting in (0, 1)),
	audit_success NUMBER(1) NOT NULL CHECK (audit_success in (0, 1)),
	audit_failure NUMBER(1) NOT NULL CHECK (audit_failure in (0, 1)),
	CONSTRAINT unique_acl_entry UNIQUE (acl_object_identity, ace_order),
	CONSTRAINT fk_acl_entry_object FOREIGN KEY (acl_object_identity) REFERENCES acl_object_identity (id),
	CONSTRAINT fk_acl_entry_acl FOREIGN KEY (sid) REFERENCES acl_sid (id)
);
CREATE SEQUENCE acl_entry_sequence START WITH 1 INCREMENT BY 1 NOMAXVALUE;
CREATE OR REPLACE TRIGGER acl_entry_id_trigger
	BEFORE INSERT ON acl_entry
	FOR EACH ROW
BEGIN
	SELECT acl_entry_sequence.nextval INTO :new.id FROM dual;
END;</pre>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="appendix-namespace" href="index.html#appendix-namespace"></a>43.&nbsp;The Security Namespace</h2></div></div></div>
<p>This appendix provides a reference to the elements available in the security namespace and information on the underlying beans they create (a knowledge of the individual classes and how they work together is assumed - you can find more information in the project Javadoc and elsewhere in this document). If you haven&#8217;t used the namespace before, please read the <a class="link" href="index.html#ns-config" title="6.&nbsp;Security Namespace Configuration">introductory chapter</a> on namespace configuration, as this is intended as a supplement to the information there. Using a good quality XML editor while editing a configuration based on the schema is recommended as this will provide contextual information on which elements and attributes are available as well as comments explaining their purpose. The namespace is written in <a class="ulink" href="http://www.relaxng.org/" target="_top">RELAX NG</a> Compact format and later converted into an XSD schema. If you are familiar with this format, you may wish to examine the <a class="ulink" href="https://raw.githubusercontent.com/spring-projects/spring-security/master/config/src/main/resources/org/springframework/security/config/spring-security-4.1.rnc" target="_top">schema file</a> directly.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="nsa-web" href="index.html#nsa-web"></a>43.1&nbsp;Web Application Security</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-debug" href="index.html#nsa-debug"></a>43.1.1&nbsp;&lt;debug&gt;</h3></div></div></div>
<p>Enables Spring Security debugging infrastructure. This will provide human-readable (multi-line) debugging information to monitor requests coming into the security filters. This may include sensitive information, such as request parameters or headers, and should only be used in a development environment.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-http" href="index.html#nsa-http"></a>43.1.2&nbsp;&lt;http&gt;</h3></div></div></div>
<p>If you use an <code class="literal">&lt;http&gt;</code> element within your application, a <code class="literal">FilterChainProxy</code> bean named "springSecurityFilterChain" is created and the configuration within the element is used to build a filter chain within
<code class="literal">FilterChainProxy</code>. As of Spring Security 3.1, additional <code class="literal">http</code> elements can be used to add extra filter chains <a href="index.html#ftn.d5e6706" class="footnote" name="d5e6706"><sup class="footnote">[22]</sup></a>.
Some core filters are always created in a filter chain and others will be added to the stack depending on the attributes and child elements which are present. The positions of the standard filters are fixed (see
<a class="link" href="index.html#filter-stack" title="Table&nbsp;6.1.&nbsp;Standard Filter Aliases and Ordering">the filter order table</a> in the namespace introduction), removing a common source of errors with previous versions of the framework when users had to configure the filter chain explicitly in the
<code class="literal">FilterChainProxy</code> bean. You can, of course, still do this if you need full control of the configuration.</p>
<p>All filters which require a reference to the <code class="literal">AuthenticationManager</code> will be automatically injected with the internal instance created by the namespace configuration (see the <a class="link" href="index.html#ns-auth-manager" title="6.6&nbsp;The Authentication Manager and the Namespace">introductory chapter</a> for more on the <code class="literal">AuthenticationManager</code>).</p>
<p>Each <code class="literal">&lt;http&gt;</code> namespace block always creates an <code class="literal">SecurityContextPersistenceFilter</code>, an <code class="literal">ExceptionTranslationFilter</code> and a <code class="literal">FilterSecurityInterceptor</code>. These are fixed and cannot be replaced with alternatives.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-http-attributes" href="index.html#nsa-http-attributes"></a>&lt;http&gt; Attributes</h4></div></div></div>
<p>The attributes on the <code class="literal">&lt;http&gt;</code> element control some of the properties on the core filters.</p>
<div class="itemizedlist"><a name="nsa-http-access-decision-manager-ref" href="index.html#nsa-http-access-decision-manager-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>access-decision-manager-ref</strong></span>
Optional attribute specifying the ID of the <code class="literal">AccessDecisionManager</code> implementation which should be used for authorizing HTTP requests. By default an <code class="literal">AffirmativeBased</code> implementation is used for with a <code class="literal">RoleVoter</code> and an <code class="literal">AuthenticatedVoter</code>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-http-authentication-manager-ref" href="index.html#nsa-http-authentication-manager-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>authentication-manager-ref</strong></span>
A reference to the <code class="literal">AuthenticationManager</code> used for the <code class="literal">FilterChain</code> created by this http element.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-http-auto-config" href="index.html#nsa-http-auto-config"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>auto-config</strong></span>
Automatically registers a login form, BASIC authentication, logout services. If set to "true", all of these capabilities are added (although you can still customize the configuration of each by providing the respective element). If unspecified, defaults to "false". Use of this attribute is not recommended. Use explicit configuration elements instead to avoid confusion.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-http-create-session" href="index.html#nsa-http-create-session"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<p class="simpara"><span class="strong"><strong>create-session</strong></span>
Controls the eagerness with which an HTTP session is created by Spring Security classes. Options include:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<code class="literal">always</code> - Spring Security will proactively create a session if one does not exist.
</li><li class="listitem">
<code class="literal">ifRequired</code> - Spring Security will only create a session only if one is required (default value).
</li><li class="listitem">
<code class="literal">never</code> - Spring Security will never create a session, but will make use of one if the application does.
</li><li class="listitem">
<code class="literal">stateless</code> - Spring Security will not create a session and ignore the session for obtaining a Spring <code class="literal">Authentication</code>.
</li></ul></div>
</li></ul></div>
<div class="itemizedlist"><a name="nsa-http-disable-url-rewriting" href="index.html#nsa-http-disable-url-rewriting"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>disable-url-rewriting</strong></span>
Prevents session IDs from being appended to URLs in the application. Clients must use cookies if this attribute is set to <code class="literal">true</code>. The default is <code class="literal">true</code>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-http-entry-point-ref" href="index.html#nsa-http-entry-point-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>entry-point-ref</strong></span>
Normally the <code class="literal">AuthenticationEntryPoint</code> used will be set depending on which authentication mechanisms have been configured. This attribute allows this behaviour to be overridden by defining a customized <code class="literal">AuthenticationEntryPoint</code> bean which will start the authentication process.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-http-jaas-api-provision" href="index.html#nsa-http-jaas-api-provision"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>jaas-api-provision</strong></span>
If available, runs the request as the <code class="literal">Subject</code> acquired from the <code class="literal">JaasAuthenticationToken</code> which is implemented by adding a <code class="literal">JaasApiIntegrationFilter</code> bean to the stack. Defaults to <code class="literal">false</code>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-http-name" href="index.html#nsa-http-name"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>name</strong></span>
A bean identifier, used for referring to the bean elsewhere in the context.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-http-once-per-request" href="index.html#nsa-http-once-per-request"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>once-per-request</strong></span>
Corresponds to the <code class="literal">observeOncePerRequest</code> property of <code class="literal">FilterSecurityInterceptor</code>. Defaults to <code class="literal">true</code>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-http-pattern" href="index.html#nsa-http-pattern"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>pattern</strong></span>
Defining a pattern for the <a class="link" href="index.html#nsa-http" title="43.1.2&nbsp;<http&gt;">http</a> element controls the requests which will be filtered through the list of filters which it defines. The interpretation is dependent on the configured <a class="link" href="index.html#nsa-http-request-matcher">request-matcher</a>. If no pattern is defined, all requests will be matched, so the most specific patterns should be declared first.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-http-realm" href="index.html#nsa-http-realm"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>realm</strong></span>
Sets the realm name used for basic authentication (if enabled). Corresponds to the <code class="literal">realmName</code> property on <code class="literal">BasicAuthenticationEntryPoint</code>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-http-request-matcher" href="index.html#nsa-http-request-matcher"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>request-matcher</strong></span>
Defines the <code class="literal">RequestMatcher</code> strategy used in the <code class="literal">FilterChainProxy</code> and the beans created by the <code class="literal">intercept-url</code> to match incoming requests. Options are currently <code class="literal">mvc</code>, <code class="literal">ant</code>, <code class="literal">regex</code> and <code class="literal">ciRegex</code>, for Spring MVC, ant, regular-expression and case-insensitive regular-expression respectively. A separate instance is created for each <a class="link" href="index.html#nsa-intercept-url" title="43.1.24&nbsp;<intercept-url&gt;">intercept-url</a> element using its <a class="link" href="index.html#nsa-intercept-url-pattern">pattern</a>, <a class="link" href="index.html#nsa-intercept-url-method">method</a> and <a class="link" href="index.html#nsa-intercept-url-servlet-path">servlet-path</a> attributes. Ant paths are matched using an <code class="literal">AntPathRequestMatcher</code>, regular expressions are matched using a <code class="literal">RegexRequestMatcher</code> and for Spring MVC path matching the <code class="literal">MvcRequestMatcher</code> is used. See the Javadoc for these classes for more details on exactly how the matching is performed. Ant paths are the default strategy.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-http-request-matcher-ref" href="index.html#nsa-http-request-matcher-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>request-matcher-ref</strong></span>
A reference to a bean that implements <code class="literal">RequestMatcher</code> that will determine if this <code class="literal">FilterChain</code> should be used. This is a more powerful alternative to <a class="link" href="index.html#nsa-http-pattern">pattern</a>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-http-security" href="index.html#nsa-http-security"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>security</strong></span>
A request pattern can be mapped to an empty filter chain, by setting this attribute to <code class="literal">none</code>. No security will be applied and none of Spring Security&#8217;s features will be available.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-http-security-context-repository-ref" href="index.html#nsa-http-security-context-repository-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>security-context-repository-ref</strong></span>
Allows injection of a custom <code class="literal">SecurityContextRepository</code> into the <code class="literal">SecurityContextPersistenceFilter</code>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-http-servlet-api-provision" href="index.html#nsa-http-servlet-api-provision"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>servlet-api-provision</strong></span>
Provides versions of <code class="literal">HttpServletRequest</code> security methods such as <code class="literal">isUserInRole()</code> and <code class="literal">getPrincipal()</code> which are implemented by adding a <code class="literal">SecurityContextHolderAwareRequestFilter</code> bean to the stack. Defaults to <code class="literal">true</code>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-http-use-expressions" href="index.html#nsa-http-use-expressions"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>use-expressions</strong></span>
Enables EL-expressions in the <code class="literal">access</code> attribute, as described in the chapter on <a class="link" href="index.html#el-access-web" title="27.2&nbsp;Web Security Expressions">expression-based access-control</a>. The default value is true.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-http-children" href="index.html#nsa-http-children"></a>Child Elements of &lt;http&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-access-denied-handler" title="43.1.3&nbsp;<access-denied-handler&gt;">access-denied-handler</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-anonymous" title="43.1.17&nbsp;<anonymous&gt;">anonymous</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-cors" title="43.1.4&nbsp;<cors&gt;">cors</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-csrf" title="43.1.18&nbsp;<csrf&gt;">csrf</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-custom-filter" title="43.1.19&nbsp;<custom-filter&gt;">custom-filter</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-expression-handler" title="43.1.20&nbsp;<expression-handler&gt;">expression-handler</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-form-login" title="43.1.21&nbsp;<form-login&gt;">form-login</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-headers" title="43.1.5&nbsp;<headers&gt;">headers</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-http-basic" title="43.1.22&nbsp;<http-basic&gt;">http-basic</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-intercept-url" title="43.1.24&nbsp;<intercept-url&gt;">intercept-url</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-jee" title="43.1.25&nbsp;<jee&gt;">jee</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-logout" title="43.1.26&nbsp;<logout&gt;">logout</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-openid-login" title="43.1.27&nbsp;<openid-login&gt;">openid-login</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-port-mappings" title="43.1.30&nbsp;<port-mappings&gt;">port-mappings</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-remember-me" title="43.1.32&nbsp;<remember-me&gt;">remember-me</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-request-cache" title="43.1.33&nbsp;<request-cache&gt; Element">request-cache</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-session-management" title="43.1.34&nbsp;<session-management&gt;">session-management</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-x509" title="43.1.36&nbsp;<x509&gt;">x509</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-access-denied-handler" href="index.html#nsa-access-denied-handler"></a>43.1.3&nbsp;&lt;access-denied-handler&gt;</h3></div></div></div>
<p>This element allows you to set the <code class="literal">errorPage</code> property for the default <code class="literal">AccessDeniedHandler</code> used by the <code class="literal">ExceptionTranslationFilter</code>, using the <a class="link" href="index.html#nsa-access-denied-handler-error-page">error-page</a> attribute, or to supply your own implementation using the<a class="link" href="index.html#nsa-access-denied-handler-ref">ref</a> attribute. This is discussed in more detail in the section on the <a class="link" href="index.html#access-denied-handler" title="15.2.2&nbsp;AccessDeniedHandler">ExceptionTranslationFilter</a>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-access-denied-handler-parents" href="index.html#nsa-access-denied-handler-parents"></a>Parent Elements of &lt;access-denied-handler&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-http" title="43.1.2&nbsp;<http&gt;">http</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-access-denied-handler-attributes" href="index.html#nsa-access-denied-handler-attributes"></a>&lt;access-denied-handler&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-access-denied-handler-error-page" href="index.html#nsa-access-denied-handler-error-page"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>error-page</strong></span>
The access denied page that an authenticated user will be redirected to if they request a page which they don&#8217;t have the authority to access.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-access-denied-handler-ref" href="index.html#nsa-access-denied-handler-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>ref</strong></span>
Defines a reference to a Spring bean of type <code class="literal">AccessDeniedHandler</code>.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-cors" href="index.html#nsa-cors"></a>43.1.4&nbsp;&lt;cors&gt;</h3></div></div></div>
<p>This element allows for configuring a <code class="literal">CorsFilter</code>.
If no <code class="literal">CorsFilter</code> or <code class="literal">CorsConfigurationSource</code> is specified and Spring MVC is on the classpath, a <code class="literal">HandlerMappingIntrospector</code> is used as the <code class="literal">CorsConfigurationSource</code>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-cors-attributes" href="index.html#nsa-cors-attributes"></a>&lt;cors&gt; Attributes</h4></div></div></div>
<p>The attributes on the <code class="literal">&lt;cors&gt;</code> element control the headers element.</p>
<div class="itemizedlist"><a name="nsa-cors-ref" href="index.html#nsa-cors-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>ref</strong></span>
Optional attribute that specifies the bean name of a <code class="literal">CorsFilter</code>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-cors-configuration-source-ref" href="index.html#nsa-cors-configuration-source-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>cors-configuration-source-ref</strong></span>
Optional attribute that specifies the bean name of a <code class="literal">CorsConfigurationSource</code> to be injected into a <code class="literal">CorsFilter</code> created by the XML namespace.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-cors-parents" href="index.html#nsa-cors-parents"></a>Parent Elements of &lt;cors&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-http" title="43.1.2&nbsp;<http&gt;">http</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-headers" href="index.html#nsa-headers"></a>43.1.5&nbsp;&lt;headers&gt;</h3></div></div></div>
<p>This element allows for configuring additional (security) headers to be send with the response. It enables easy configuration for several headers and also allows for setting custom headers through the <a class="link" href="index.html#nsa-header" title="43.1.16&nbsp;<header&gt;">header</a> element. Additional information, can be found in the <a class="link" href="index.html#headers" title="21.&nbsp;Security HTTP Response Headers">Security Headers</a> section of the reference.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">Cache-Control</code>, <code class="literal">Pragma</code>, and <code class="literal">Expires</code> - Can be set using the <a class="link" href="index.html#nsa-cache-control" title="43.1.6&nbsp;<cache-control&gt;">cache-control</a> element. This ensures that the browser does not cache your secured pages.
</li><li class="listitem">
<code class="literal">Strict-Transport-Security</code> - Can be set using the <a class="link" href="index.html#nsa-hsts" title="43.1.7&nbsp;<hsts&gt;">hsts</a> element. This ensures that the browser automatically requests HTTPS for future requests.
</li><li class="listitem">
<code class="literal">X-Frame-Options</code> - Can be set using the <a class="link" href="index.html#nsa-frame-options" title="43.1.13&nbsp;<frame-options&gt;">frame-options</a> element. The <a class="ulink" href="https://en.wikipedia.org/wiki/Clickjacking#X-Frame-Options" target="_top">X-Frame-Options</a> header can be used to prevent clickjacking attacks.
</li><li class="listitem">
<code class="literal">X-XSS-Protection</code> - Can be set using the <a class="link" href="index.html#nsa-xss-protection" title="43.1.14&nbsp;<xss-protection&gt;">xss-protection</a> element. The <a class="ulink" href="https://en.wikipedia.org/wiki/Cross-site_scripting" target="_top">X-XSS-Protection </a> header can be used by browser to do basic control.
</li><li class="listitem">
<code class="literal">X-Content-Type-Options</code> - Can be set using the <a class="link" href="index.html#nsa-content-type-options" title="43.1.15&nbsp;<content-type-options&gt;">content-type-options</a> element. The <a class="ulink" href="https://blogs.msdn.com/b/ie/archive/2008/09/02/ie8-security-part-vi-beta-2-update.aspx" target="_top">X-Content-Type-Options</a> header prevents Internet Explorer from MIME-sniffing a response away from the declared content-type. This also applies to Google Chrome, when downloading extensions.
</li><li class="listitem">
<code class="literal">Public-Key-Pinning</code> or <code class="literal">Public-Key-Pinning-Report-Only</code> - Can be set using the <a class="link" href="index.html#nsa-hpkp" title="43.1.8&nbsp;<hpkp&gt;">hpkp</a> element. This allows HTTPS websites to resist impersonation by attackers using mis-issued or otherwise fraudulent certificates.
</li><li class="listitem">
<code class="literal">Content-Security-Policy</code> or <code class="literal">Content-Security-Policy-Report-Only</code> - Can be set using the <a class="link" href="index.html#nsa-content-security-policy" title="43.1.11&nbsp;<content-security-policy&gt;">content-security-policy</a> element. <a class="ulink" href="https://www.w3.org/TR/CSP2/" target="_top">Content Security Policy (CSP)</a> is a mechanism that web applications can leverage to mitigate content injection vulnerabilities, such as cross-site scripting (XSS).
</li><li class="listitem">
<code class="literal">Referrer-Policy</code> - Can be set using the <a class="link" href="index.html#nsa-referrer-policy" title="43.1.12&nbsp;<referrer-policy&gt;">referrer-policy</a> element, <a class="ulink" href="https://www.w3.org/TR/referrer-policy/" target="_top">Referrer-Policy</a> is a mechanism that web applications can leverage to manage the referrer field, which contains the last page the user was on.
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-headers-attributes" href="index.html#nsa-headers-attributes"></a>&lt;headers&gt; Attributes</h4></div></div></div>
<p>The attributes on the <code class="literal">&lt;headers&gt;</code> element control the headers element.</p>
<div class="itemizedlist"><a name="nsa-headers-defaults-disabled" href="index.html#nsa-headers-defaults-disabled"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>defaults-disabled</strong></span>
Optional attribute that specifies to disable the default Spring Security&#8217;s HTTP response headers. The default is false (the default headers are included).
</li></ul></div>
<div class="itemizedlist"><a name="nsa-headers-disabled" href="index.html#nsa-headers-disabled"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>disabled</strong></span>
Optional attribute that specifies to disable Spring Security&#8217;s HTTP response headers. The default is false (the headers are enabled).
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-headers-parents" href="index.html#nsa-headers-parents"></a>Parent Elements of &lt;headers&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-http" title="43.1.2&nbsp;<http&gt;">http</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-headers-children" href="index.html#nsa-headers-children"></a>Child Elements of &lt;headers&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-cache-control" title="43.1.6&nbsp;<cache-control&gt;">cache-control</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-content-security-policy" title="43.1.11&nbsp;<content-security-policy&gt;">content-security-policy</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-content-type-options" title="43.1.15&nbsp;<content-type-options&gt;">content-type-options</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-frame-options" title="43.1.13&nbsp;<frame-options&gt;">frame-options</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-header" title="43.1.16&nbsp;<header&gt;">header</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-hpkp" title="43.1.8&nbsp;<hpkp&gt;">hpkp</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-hsts" title="43.1.7&nbsp;<hsts&gt;">hsts</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-referrer-policy" title="43.1.12&nbsp;<referrer-policy&gt;">referrer-policy</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-xss-protection" title="43.1.14&nbsp;<xss-protection&gt;">xss-protection</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-cache-control" href="index.html#nsa-cache-control"></a>43.1.6&nbsp;&lt;cache-control&gt;</h3></div></div></div>
<p>Adds <code class="literal">Cache-Control</code>, <code class="literal">Pragma</code>, and <code class="literal">Expires</code> headers to ensure that the browser does not cache your secured pages.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-cache-control-attributes" href="index.html#nsa-cache-control-attributes"></a>&lt;cache-control&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-cache-control-disabled" href="index.html#nsa-cache-control-disabled"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>disabled</strong></span>
Specifies if Cache Control should be disabled. Default false.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-cache-control-parents" href="index.html#nsa-cache-control-parents"></a>Parent Elements of &lt;cache-control&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-headers" title="43.1.5&nbsp;<headers&gt;">headers</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-hsts" href="index.html#nsa-hsts"></a>43.1.7&nbsp;&lt;hsts&gt;</h3></div></div></div>
<p>When enabled adds the <a class="ulink" href="https://tools.ietf.org/html/rfc6797" target="_top">Strict-Transport-Security</a> header to the response for any secure request. This allows the server to instruct browsers to automatically use HTTPS for future requests.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-hsts-attributes" href="index.html#nsa-hsts-attributes"></a>&lt;hsts&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-hsts-disabled" href="index.html#nsa-hsts-disabled"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>disabled</strong></span>
Specifies if Strict-Transport-Security should be disabled. Default false.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-hsts-include-subdomains" href="index.html#nsa-hsts-include-subdomains"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>include-sub-domains</strong></span>
Specifies if subdomains should be included. Default true.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-hsts-max-age-seconds" href="index.html#nsa-hsts-max-age-seconds"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>max-age-seconds</strong></span>
Specifies the maximum amount of time the host should be considered a Known HSTS Host. Default one year.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-hsts-request-matcher-ref" href="index.html#nsa-hsts-request-matcher-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>request-matcher-ref</strong></span>
The RequestMatcher instance to be used to determine if the header should be set. Default is if HttpServletRequest.isSecure() is true.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-hsts-parents" href="index.html#nsa-hsts-parents"></a>Parent Elements of &lt;hsts&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-headers" title="43.1.5&nbsp;<headers&gt;">headers</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-hpkp" href="index.html#nsa-hpkp"></a>43.1.8&nbsp;&lt;hpkp&gt;</h3></div></div></div>
<p>When enabled adds the <a class="ulink" href="https://tools.ietf.org/html/rfc7469" target="_top">Public Key Pinning Extension for HTTP</a> header to the response for any secure request. This allows HTTPS websites to resist impersonation by attackers using mis-issued or otherwise fraudulent certificates.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-hpkp-attributes" href="index.html#nsa-hpkp-attributes"></a>&lt;hpkp&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-hpkp-disabled" href="index.html#nsa-hpkp-disabled"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>disabled</strong></span>
Specifies if HTTP Public Key Pinning (HPKP) should be disabled. Default true.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-hpkp-include-subdomains" href="index.html#nsa-hpkp-include-subdomains"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>include-sub-domains</strong></span>
Specifies if subdomains should be included. Default false.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-hpkp-max-age-seconds" href="index.html#nsa-hpkp-max-age-seconds"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>max-age-seconds</strong></span>
Sets the value for the max-age directive of the Public-Key-Pins header. Default 60 days.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-hpkp-report-only" href="index.html#nsa-hpkp-report-only"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>report-only</strong></span>
Specifies if the browser should only report pin validation failures. Default true.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-hpkp-report-uri" href="index.html#nsa-hpkp-report-uri"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>report-uri</strong></span>
Specifies the URI to which the browser should report pin validation failures.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-hpkp-parents" href="index.html#nsa-hpkp-parents"></a>Parent Elements of &lt;hpkp&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-headers" title="43.1.5&nbsp;<headers&gt;">headers</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-pins" href="index.html#nsa-pins"></a>43.1.9&nbsp;&lt;pins&gt;</h3></div></div></div>
<p>The list of pins</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-pins-children" href="index.html#nsa-pins-children"></a>Child Elements of &lt;pins&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-pin" title="43.1.10&nbsp;<pin&gt;">pin</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-pin" href="index.html#nsa-pin"></a>43.1.10&nbsp;&lt;pin&gt;</h3></div></div></div>
<p>A pin is specified using the base64-encoded SPKI fingerprint as value and the cryptographic hash algorithm as attribute</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-pin-attributes" href="index.html#nsa-pin-attributes"></a>&lt;pin&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-pin-algorithm" href="index.html#nsa-pin-algorithm"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>algorithm</strong></span>
The cryptographic hash algorithm. Default is SHA256.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-pin-parents" href="index.html#nsa-pin-parents"></a>Parent Elements of &lt;pin&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-pins" title="43.1.9&nbsp;<pins&gt;">pins</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-content-security-policy" href="index.html#nsa-content-security-policy"></a>43.1.11&nbsp;&lt;content-security-policy&gt;</h3></div></div></div>
<p>When enabled adds the <a class="ulink" href="https://www.w3.org/TR/CSP2/" target="_top">Content Security Policy (CSP)</a> header to the response. CSP is a mechanism that web applications can leverage to mitigate content injection vulnerabilities, such as cross-site scripting (XSS).</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-content-security-policy-attributes" href="index.html#nsa-content-security-policy-attributes"></a>&lt;content-security-policy&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-content-security-policy-policy-directives" href="index.html#nsa-content-security-policy-policy-directives"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>policy-directives</strong></span>
The security policy directive(s) for the Content-Security-Policy header or if report-only is set to true, then the Content-Security-Policy-Report-Only header is used.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-content-security-policy-report-only" href="index.html#nsa-content-security-policy-report-only"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>report-only</strong></span>
Set to true, to enable the Content-Security-Policy-Report-Only header for reporting policy violations only. Defaults to false.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-content-security-policy-parents" href="index.html#nsa-content-security-policy-parents"></a>Parent Elements of &lt;content-security-policy&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-headers" title="43.1.5&nbsp;<headers&gt;">headers</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-referrer-policy" href="index.html#nsa-referrer-policy"></a>43.1.12&nbsp;&lt;referrer-policy&gt;</h3></div></div></div>
<p>When enabled adds the <a class="ulink" href="https://www.w3.org/TR/referrer-policy/" target="_top">Referrer Policy</a> header to the response.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-referrer-policy-attributes" href="index.html#nsa-referrer-policy-attributes"></a>&lt;referrer-policy&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-referrer-policy-policy" href="index.html#nsa-referrer-policy-policy"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>policy</strong></span>
The policy for the Referrer-Policy header. Default "no-referrer".
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-referrer-policy-parents" href="index.html#nsa-referrer-policy-parents"></a>Parent Elements of &lt;referrer-policy&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-headers" title="43.1.5&nbsp;<headers&gt;">headers</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-frame-options" href="index.html#nsa-frame-options"></a>43.1.13&nbsp;&lt;frame-options&gt;</h3></div></div></div>
<p>When enabled adds the <a class="ulink" href="https://tools.ietf.org/html/draft-ietf-websec-x-frame-options" target="_top">X-Frame-Options header</a> to the response, this allows newer browsers to do some security checks and prevent <a class="ulink" href="https://en.wikipedia.org/wiki/Clickjacking" target="_top">clickjacking</a> attacks.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-frame-options-attributes" href="index.html#nsa-frame-options-attributes"></a>&lt;frame-options&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-frame-options-disabled" href="index.html#nsa-frame-options-disabled"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>disabled</strong></span>
If disabled, the X-Frame-Options header will not be included. Default false.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-frame-options-policy" href="index.html#nsa-frame-options-policy"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<p class="simpara"><span class="strong"><strong>policy</strong></span></p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<code class="literal">DENY</code> The page cannot be displayed in a frame, regardless of the site attempting to do so. This is the default when frame-options-policy is specified.
</li><li class="listitem">
<code class="literal">SAMEORIGIN</code> The page can only be displayed in a frame on the same origin as the page itself
</li><li class="listitem">
<code class="literal">ALLOW-FROM origin</code> The page can only be displayed in a frame on the specified origin.
</li></ul></div>
<p class="simpara">In other words, if you specify DENY, not only will attempts to load the page in a frame fail when loaded from other sites, attempts to do so will fail when loaded from the same site. On the other hand, if you specify SAMEORIGIN, you can still use the page in a frame as long as the site including it in a frame it is the same as the one serving the page.</p>
</li></ul></div>
<div class="itemizedlist"><a name="nsa-frame-options-strategy" href="index.html#nsa-frame-options-strategy"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<p class="simpara"><span class="strong"><strong>strategy</strong></span>
Select the <code class="literal">AllowFromStrategy</code> to use when using the ALLOW-FROM policy.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<code class="literal">static</code> Use a single static ALLOW-FROM value. The value can be set through the <a class="link" href="index.html#nsa-frame-options-value">value</a> attribute.
</li><li class="listitem">
<code class="literal">regexp</code> Use a regelur expression to validate incoming requests and if they are allowed. The regular expression can be set through the <a class="link" href="index.html#nsa-frame-options-value">value</a> attribute. The request parameter used to retrieve the value to validate can be specified using the <a class="link" href="index.html#nsa-frame-options-from-parameter">from-parameter</a>.
</li><li class="listitem">
<code class="literal">whitelist</code> A comma-seperated list containing the allowed domains. The comma-seperated list can be set through the <a class="link" href="index.html#nsa-frame-options-value">value</a> attribute. The request parameter used to retrieve the value to validate can be specified using the <a class="link" href="index.html#nsa-frame-options-from-parameter">from-parameter</a>.
</li></ul></div>
</li></ul></div>
<div class="itemizedlist"><a name="nsa-frame-options-ref" href="index.html#nsa-frame-options-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>ref</strong></span>
Instead of using one of the predefined strategies it is also possible to use a custom <code class="literal">AllowFromStrategy</code>. The reference to this bean can be specified through this ref attribute.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-frame-options-value" href="index.html#nsa-frame-options-value"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>value</strong></span>
The value to use when ALLOW-FROM is used a <a class="link" href="index.html#nsa-frame-options-strategy">strategy</a>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-frame-options-from-parameter" href="index.html#nsa-frame-options-from-parameter"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>from-parameter</strong></span>
Specify the name of the request parameter to use when using regexp or whitelist for the ALLOW-FROM strategy.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-frame-options-parents" href="index.html#nsa-frame-options-parents"></a>Parent Elements of &lt;frame-options&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-headers" title="43.1.5&nbsp;<headers&gt;">headers</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-xss-protection" href="index.html#nsa-xss-protection"></a>43.1.14&nbsp;&lt;xss-protection&gt;</h3></div></div></div>
<p>Adds the <a class="ulink" href="https://blogs.msdn.com/b/ie/archive/2008/07/02/ie8-security-part-iv-the-xss-filter.aspx" target="_top">X-XSS-Protection header</a> to the response to assist in protecting against <a class="ulink" href="https://en.wikipedia.org/wiki/Cross-site_scripting#Non-Persistent" target="_top">reflected / Type-1 Cross-Site Scripting (XSS)</a> attacks. This is in no-way a full protection to XSS attacks!</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-xss-protection-attributes" href="index.html#nsa-xss-protection-attributes"></a>&lt;xss-protection&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-xss-protection-disabled" href="index.html#nsa-xss-protection-disabled"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>xss-protection-disabled</strong></span>
Do not include the header for <a class="ulink" href="https://en.wikipedia.org/wiki/Cross-site_scripting#Non-Persistent" target="_top">reflected / Type-1 Cross-Site Scripting (XSS)</a> protection.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-xss-protection-enabled" href="index.html#nsa-xss-protection-enabled"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>xss-protection-enabled</strong></span>
Explicitly enable or disable <a class="ulink" href="https://en.wikipedia.org/wiki/Cross-site_scripting#Non-Persistent" target="_top">reflected / Type-1 Cross-Site Scripting (XSS)</a> protection.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-xss-protection-block" href="index.html#nsa-xss-protection-block"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>xss-protection-block</strong></span>
When true and xss-protection-enabled is true, adds mode=block to the header. This indicates to the browser that the page should not be loaded at all. When false and xss-protection-enabled is true, the page will still be rendered when an reflected attack is detected but the response will be modified to protect against the attack. Note that there are sometimes ways of bypassing this mode which can often times make blocking the page more desirable.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-xss-protection-parents" href="index.html#nsa-xss-protection-parents"></a>Parent Elements of &lt;xss-protection&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-headers" title="43.1.5&nbsp;<headers&gt;">headers</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-content-type-options" href="index.html#nsa-content-type-options"></a>43.1.15&nbsp;&lt;content-type-options&gt;</h3></div></div></div>
<p>Add the X-Content-Type-Options header with the value of nosniff to the response. This <a class="ulink" href="https://blogs.msdn.com/b/ie/archive/2008/09/02/ie8-security-part-vi-beta-2-update.aspx" target="_top">disables MIME-sniffing</a> for IE8+ and Chrome extensions.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-content-type-options-attributes" href="index.html#nsa-content-type-options-attributes"></a>&lt;content-type-options&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-content-type-options-disabled" href="index.html#nsa-content-type-options-disabled"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>disabled</strong></span>
Specifies if Content Type Options should be disabled. Default false.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-content-type-options-parents" href="index.html#nsa-content-type-options-parents"></a>Parent Elements of &lt;content-type-options&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-headers" title="43.1.5&nbsp;<headers&gt;">headers</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-header" href="index.html#nsa-header"></a>43.1.16&nbsp;&lt;header&gt;</h3></div></div></div>
<p>Add additional headers to the response, both the name and value need to be specified.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-header-attributes" href="index.html#nsa-header-attributes"></a>&lt;header-attributes&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-header-name" href="index.html#nsa-header-name"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>header-name</strong></span>
The <code class="literal">name</code> of the header.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-header-value" href="index.html#nsa-header-value"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>value</strong></span>
The <code class="literal">value</code> of the header to add.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-header-ref" href="index.html#nsa-header-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>ref</strong></span>
Reference to a custom implementation of the <code class="literal">HeaderWriter</code> interface.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-header-parents" href="index.html#nsa-header-parents"></a>Parent Elements of &lt;header&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-headers" title="43.1.5&nbsp;<headers&gt;">headers</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-anonymous" href="index.html#nsa-anonymous"></a>43.1.17&nbsp;&lt;anonymous&gt;</h3></div></div></div>
<p>Adds an <code class="literal">AnonymousAuthenticationFilter</code> to the stack and an <code class="literal">AnonymousAuthenticationProvider</code>. Required if you are using the <code class="literal">IS_AUTHENTICATED_ANONYMOUSLY</code> attribute.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-anonymous-parents" href="index.html#nsa-anonymous-parents"></a>Parent Elements of &lt;anonymous&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-http" title="43.1.2&nbsp;<http&gt;">http</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-anonymous-attributes" href="index.html#nsa-anonymous-attributes"></a>&lt;anonymous&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-anonymous-enabled" href="index.html#nsa-anonymous-enabled"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>enabled</strong></span>
With the default namespace setup, the anonymous "authentication" facility is automatically enabled. You can disable it using this property.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-anonymous-granted-authority" href="index.html#nsa-anonymous-granted-authority"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>granted-authority</strong></span>
The granted authority that should be assigned to the anonymous request. Commonly this is used to assign the anonymous request particular roles, which can subsequently be used in authorization decisions. If unset, defaults to <code class="literal">ROLE_ANONYMOUS</code>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-anonymous-key" href="index.html#nsa-anonymous-key"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>key</strong></span>
The key shared between the provider and filter. This generally does not need to be set. If unset, it will default to a secure randomly generated value. This means setting this value can improve startup time when using the anonymous functionality since secure random values can take a while to be generated.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-anonymous-username" href="index.html#nsa-anonymous-username"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>username</strong></span>
The username that should be assigned to the anonymous request. This allows the principal to be identified, which may be important for logging and auditing. if unset, defaults to <code class="literal">anonymousUser</code>.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-csrf" href="index.html#nsa-csrf"></a>43.1.18&nbsp;&lt;csrf&gt;</h3></div></div></div>
<p>This element will add <a class="ulink" href="https://en.wikipedia.org/wiki/Cross-site_request_forgery" target="_top">Cross Site Request Forger (CSRF)</a> protection to the application. It also updates the default RequestCache to only replay "GET" requests upon successful authentication. Additional information can be found in the <a class="link" href="index.html#csrf" title="19.&nbsp;Cross Site Request Forgery (CSRF)">Cross Site Request Forgery (CSRF)</a> section of the reference.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-csrf-parents" href="index.html#nsa-csrf-parents"></a>Parent Elements of &lt;csrf&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-http" title="43.1.2&nbsp;<http&gt;">http</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-csrf-attributes" href="index.html#nsa-csrf-attributes"></a>&lt;csrf&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-csrf-disabled" href="index.html#nsa-csrf-disabled"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>disabled</strong></span>
Optional attribute that specifies to disable Spring Security&#8217;s CSRF protection. The default is false (CSRF protection is enabled). It is highly recommended to leave CSRF protection enabled.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-csrf-token-repository-ref" href="index.html#nsa-csrf-token-repository-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>token-repository-ref</strong></span>
The CsrfTokenRepository to use. The default is <code class="literal">HttpSessionCsrfTokenRepository</code>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-csrf-request-matcher-ref" href="index.html#nsa-csrf-request-matcher-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>request-matcher-ref</strong></span>
The RequestMatcher instance to be used to determine if CSRF should be applied. Default is any HTTP method except "GET", "TRACE", "HEAD", "OPTIONS".
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-custom-filter" href="index.html#nsa-custom-filter"></a>43.1.19&nbsp;&lt;custom-filter&gt;</h3></div></div></div>
<p>This element is used to add a filter to the filter chain. It doesn&#8217;t create any additional beans but is used to select a bean of type <code class="literal">javax.servlet.Filter</code> which is already defined in the application context and add that at a particular position in the filter chain maintained by Spring Security. Full details can be found in the <a class="link" href="index.html#ns-custom-filters" title="6.3.6&nbsp;Adding in Your Own Filters">namespace chapter</a>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-custom-filter-parents" href="index.html#nsa-custom-filter-parents"></a>Parent Elements of &lt;custom-filter&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-http" title="43.1.2&nbsp;<http&gt;">http</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-custom-filter-attributes" href="index.html#nsa-custom-filter-attributes"></a>&lt;custom-filter&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-custom-filter-after" href="index.html#nsa-custom-filter-after"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>after</strong></span>
The filter immediately after which the custom-filter should be placed in the chain. This feature will only be needed by advanced users who wish to mix their own filters into the security filter chain and have some knowledge of the standard Spring Security filters. The filter names map to specific Spring Security implementation filters.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-custom-filter-before" href="index.html#nsa-custom-filter-before"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>before</strong></span>
The filter immediately before which the custom-filter should be placed in the chain
</li></ul></div>
<div class="itemizedlist"><a name="nsa-custom-filter-position" href="index.html#nsa-custom-filter-position"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>position</strong></span>
The explicit position at which the custom-filter should be placed in the chain. Use if you are replacing a standard filter.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-custom-filter-ref" href="index.html#nsa-custom-filter-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>ref</strong></span>
Defines a reference to a Spring bean that implements <code class="literal">Filter</code>.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-expression-handler" href="index.html#nsa-expression-handler"></a>43.1.20&nbsp;&lt;expression-handler&gt;</h3></div></div></div>
<p>Defines the <code class="literal">SecurityExpressionHandler</code> instance which will be used if expression-based access-control is enabled. A default implementation (with no ACL support) will be used if not supplied.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-expression-handler-parents" href="index.html#nsa-expression-handler-parents"></a>Parent Elements of &lt;expression-handler&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-global-method-security" title="43.4.1&nbsp;<global-method-security&gt;">global-method-security</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-http" title="43.1.2&nbsp;<http&gt;">http</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-websocket-message-broker" title="43.2.1&nbsp;<websocket-message-broker&gt;">websocket-message-broker</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-expression-handler-attributes" href="index.html#nsa-expression-handler-attributes"></a>&lt;expression-handler&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-expression-handler-ref" href="index.html#nsa-expression-handler-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>ref</strong></span>
Defines a reference to a Spring bean that implements <code class="literal">SecurityExpressionHandler</code>.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-form-login" href="index.html#nsa-form-login"></a>43.1.21&nbsp;&lt;form-login&gt;</h3></div></div></div>
<p>Used to add an <code class="literal">UsernamePasswordAuthenticationFilter</code> to the filter stack and an <code class="literal">LoginUrlAuthenticationEntryPoint</code> to the application context to provide authentication on demand. This will always take precedence over other namespace-created entry points. If no attributes are supplied, a login page will be generated automatically at the URL "/login" <a href="index.html#ftn.d5e7451" class="footnote" name="d5e7451"><sup class="footnote">[23]</sup></a> The behaviour can be customized using the <a class="link" href="index.html#nsa-form-login-attributes" title="<form-login&gt; Attributes"><code class="literal">&lt;form-login&gt;</code> Attributes</a>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-form-login-parents" href="index.html#nsa-form-login-parents"></a>Parent Elements of &lt;form-login&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-http" title="43.1.2&nbsp;<http&gt;">http</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-form-login-attributes" href="index.html#nsa-form-login-attributes"></a>&lt;form-login&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-form-login-always-use-default-target" href="index.html#nsa-form-login-always-use-default-target"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>always-use-default-target</strong></span>
If set to <code class="literal">true</code>, the user will always start at the value given by <a class="link" href="index.html#nsa-form-login-default-target-url">default-target-url</a>, regardless of how they arrived at the login page. Maps to the <code class="literal">alwaysUseDefaultTargetUrl</code> property of <code class="literal">UsernamePasswordAuthenticationFilter</code>. Default value is <code class="literal">false</code>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-form-login-authentication-details-source-ref" href="index.html#nsa-form-login-authentication-details-source-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>authentication-details-source-ref</strong></span>
Reference to an <code class="literal">AuthenticationDetailsSource</code> which will be used by the authentication filter
</li></ul></div>
<div class="itemizedlist"><a name="nsa-form-login-authentication-failure-handler-ref" href="index.html#nsa-form-login-authentication-failure-handler-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>authentication-failure-handler-ref</strong></span>
Can be used as an alternative to <a class="link" href="index.html#nsa-form-login-authentication-failure-url">authentication-failure-url</a>, giving you full control over the navigation flow after an authentication failure. The value should be the name of an <code class="literal">AuthenticationFailureHandler</code> bean in the application context.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-form-login-authentication-failure-url" href="index.html#nsa-form-login-authentication-failure-url"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>authentication-failure-url</strong></span>
Maps to the <code class="literal">authenticationFailureUrl</code> property of <code class="literal">UsernamePasswordAuthenticationFilter</code>. Defines the URL the browser will be redirected to on login failure. Defaults to <code class="literal">/login?error</code>, which will be automatically handled by the automatic login page generator, re-rendering the login page with an error message.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-form-login-authentication-success-handler-ref" href="index.html#nsa-form-login-authentication-success-handler-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>authentication-success-handler-ref</strong></span>
This can be used as an alternative to <a class="link" href="index.html#nsa-form-login-default-target-url">default-target-url</a> and <a class="link" href="index.html#nsa-form-login-always-use-default-target">always-use-default-target</a>, giving you full control over the navigation flow after a successful authentication. The value should be the name of an <code class="literal">AuthenticationSuccessHandler</code> bean in the application context. By default, an implementation of <code class="literal">SavedRequestAwareAuthenticationSuccessHandler</code> is used and injected with the <a class="link" href="index.html#nsa-form-login-default-target-url">default-target-url</a>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-form-login-default-target-url" href="index.html#nsa-form-login-default-target-url"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>default-target-url</strong></span>
Maps to the <code class="literal">defaultTargetUrl</code> property of <code class="literal">UsernamePasswordAuthenticationFilter</code>. If not set, the default value is "/" (the application root). A user will be taken to this URL after logging in, provided they were not asked to login while attempting to access a secured resource, when they will be taken to the originally requested URL.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-form-login-login-page" href="index.html#nsa-form-login-login-page"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>login-page</strong></span>
The URL that should be used to render the login page. Maps to the <code class="literal">loginFormUrl</code> property of the <code class="literal">LoginUrlAuthenticationEntryPoint</code>. Defaults to "/login".
</li></ul></div>
<div class="itemizedlist"><a name="nsa-form-login-login-processing-url" href="index.html#nsa-form-login-login-processing-url"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>login-processing-url</strong></span>
Maps to the <code class="literal">filterProcessesUrl</code> property of <code class="literal">UsernamePasswordAuthenticationFilter</code>. The default value is "/login".
</li></ul></div>
<div class="itemizedlist"><a name="nsa-form-login-password-parameter" href="index.html#nsa-form-login-password-parameter"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>password-parameter</strong></span>
The name of the request parameter which contains the password. Defaults to "password".
</li></ul></div>
<div class="itemizedlist"><a name="nsa-form-login-username-parameter" href="index.html#nsa-form-login-username-parameter"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>username-parameter</strong></span>
The name of the request parameter which contains the username. Defaults to "username".
</li></ul></div>
<div class="itemizedlist"><a name="nsa-form-login-authentication-success-forward-url" href="index.html#nsa-form-login-authentication-success-forward-url"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>authentication-success-forward-url</strong></span>
Maps a <code class="literal">ForwardAuthenticationSuccessHandler</code> to <code class="literal">authenticationSuccessHandler</code> property of <code class="literal">UsernamePasswordAuthenticationFilter</code>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-form-login-authentication-failure-forward-url" href="index.html#nsa-form-login-authentication-failure-forward-url"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>authentication-failure-forward-url</strong></span>
Maps a <code class="literal">ForwardAuthenticationFailureHandler</code> to <code class="literal">authenticationFailureHandler</code> property of <code class="literal">UsernamePasswordAuthenticationFilter</code>.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-http-basic" href="index.html#nsa-http-basic"></a>43.1.22&nbsp;&lt;http-basic&gt;</h3></div></div></div>
<p>Adds a <code class="literal">BasicAuthenticationFilter</code> and <code class="literal">BasicAuthenticationEntryPoint</code> to the configuration. The latter will only be used as the configuration entry point if form-based login is not enabled.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-http-basic-parents" href="index.html#nsa-http-basic-parents"></a>Parent Elements of &lt;http-basic&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-http" title="43.1.2&nbsp;<http&gt;">http</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-http-basic-attributes" href="index.html#nsa-http-basic-attributes"></a>&lt;http-basic&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-http-basic-authentication-details-source-ref" href="index.html#nsa-http-basic-authentication-details-source-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>authentication-details-source-ref</strong></span>
Reference to an <code class="literal">AuthenticationDetailsSource</code> which will be used by the authentication filter
</li></ul></div>
<div class="itemizedlist"><a name="nsa-http-basic-entry-point-ref" href="index.html#nsa-http-basic-entry-point-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>entry-point-ref</strong></span>
Sets the <code class="literal">AuthenticationEntryPoint</code> which is used by the <code class="literal">BasicAuthenticationFilter</code>.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-http-firewall" href="index.html#nsa-http-firewall"></a>43.1.23&nbsp;&lt;http-firewall&gt; Element</h3></div></div></div>
<p>This is a top-level element which can be used to inject a custom implementation of <code class="literal">HttpFirewall</code> into the <code class="literal">FilterChainProxy</code> created by the namespace. The default implementation should be suitable for most applications.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-http-firewall-attributes" href="index.html#nsa-http-firewall-attributes"></a>&lt;http-firewall&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-http-firewall-ref" href="index.html#nsa-http-firewall-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>ref</strong></span>
Defines a reference to a Spring bean that implements <code class="literal">HttpFirewall</code>.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-intercept-url" href="index.html#nsa-intercept-url"></a>43.1.24&nbsp;&lt;intercept-url&gt;</h3></div></div></div>
<p>This element is used to define the set of URL patterns that the application is interested in and to configure how they should be handled. It is used to construct the <code class="literal">FilterInvocationSecurityMetadataSource</code> used by the <code class="literal">FilterSecurityInterceptor</code>. It is also responsible for configuring a <code class="literal">ChannelProcessingFilter</code> if particular URLs need to be accessed by HTTPS, for example. When matching the specified patterns against an incoming request, the matching is done in the order in which the elements are declared. So the most specific patterns should come first and the most general should come last.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-intercept-url-parents" href="index.html#nsa-intercept-url-parents"></a>Parent Elements of &lt;intercept-url&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-filter-security-metadata-source" title="43.1.39&nbsp;<filter-security-metadata-source&gt;">filter-security-metadata-source</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-http" title="43.1.2&nbsp;<http&gt;">http</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-intercept-url-attributes" href="index.html#nsa-intercept-url-attributes"></a>&lt;intercept-url&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-intercept-url-access" href="index.html#nsa-intercept-url-access"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>access</strong></span>
Lists the access attributes which will be stored in the <code class="literal">FilterInvocationSecurityMetadataSource</code> for the defined URL pattern/method combination. This should be a comma-separated list of the security configuration attributes (such as role names).
</li></ul></div>
<div class="itemizedlist"><a name="nsa-intercept-url-filters" href="index.html#nsa-intercept-url-filters"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>filters</strong></span>
Can only take the value "none". This will cause any matching request to bypass the Spring Security filter chain entirely. None of the rest of the <code class="literal">&lt;http&gt;</code> configuration will have any effect on the request and there will be no security context available for its duration. Access to secured methods during the request will fail.
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This property is invalid for <a class="link" href="index.html#nsa-filter-security-metadata-source" title="43.1.39&nbsp;<filter-security-metadata-source&gt;">filter-security-metadata-source</a></p>
</td></tr></table></div>
<div class="itemizedlist"><a name="nsa-intercept-url-method" href="index.html#nsa-intercept-url-method"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>method</strong></span>
The HTTP Method which will be used in combination with the pattern and servlet path (optional) to match an incoming request. If omitted, any method will match. If an identical pattern is specified with and without a method, the method-specific match will take precedence.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-intercept-url-pattern" href="index.html#nsa-intercept-url-pattern"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>pattern</strong></span>
The pattern which defines the URL path. The content will depend on the <code class="literal">request-matcher</code> attribute from the containing http element, so will default to ant path syntax.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-intercept-url-request-matcher-ref" href="index.html#nsa-intercept-url-request-matcher-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>request-matcher-ref</strong></span>
A reference to a <code class="literal">RequestMatcher</code> that will be used to determine if this <code class="literal">&lt;intercept-url&gt;</code> is used.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-intercept-url-requires-channel" href="index.html#nsa-intercept-url-requires-channel"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>requires-channel</strong></span>
Can be "http" or "https" depending on whether a particular URL pattern should be accessed over HTTP or HTTPS respectively. Alternatively the value "any" can be used when there is no preference. If this attribute is present on any <code class="literal">&lt;intercept-url&gt;</code> element, then a <code class="literal">ChannelProcessingFilter</code> will be added to the filter stack and its additional dependencies added to the application context.
</li></ul></div>
<p>If a <code class="literal">&lt;port-mappings&gt;</code> configuration is added, this will be used to by the <code class="literal">SecureChannelProcessor</code> and <code class="literal">InsecureChannelProcessor</code> beans to determine the ports used for redirecting to HTTP/HTTPS.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This property is invalid for <a class="link" href="index.html#nsa-filter-security-metadata-source" title="43.1.39&nbsp;<filter-security-metadata-source&gt;">filter-security-metadata-source</a></p>
</td></tr></table></div>
<div class="itemizedlist"><a name="nsa-intercept-url-servlet-path" href="index.html#nsa-intercept-url-servlet-path"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>servlet-path</strong></span>
The servlet path which will be used in combination with the pattern and HTTP method to match an incoming request. This attribute is only applicable when <a class="link" href="index.html#nsa-http-request-matcher">request-matcher</a> is 'mvc'. In addition, the value is only required in the following 2 use cases: 1) There are 2 or more <code class="literal">HttpServlet</code> 's registered in the <code class="literal">ServletContext</code> that have mappings starting with <code class="literal">'/'</code> and are different; 2) The pattern starts with the same value of a registered <code class="literal">HttpServlet</code> path, excluding the default (root) <code class="literal">HttpServlet</code> <code class="literal">'/'</code>.
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This property is invalid for <a class="link" href="index.html#nsa-filter-security-metadata-source" title="43.1.39&nbsp;<filter-security-metadata-source&gt;">filter-security-metadata-source</a></p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-jee" href="index.html#nsa-jee"></a>43.1.25&nbsp;&lt;jee&gt;</h3></div></div></div>
<p>Adds a J2eePreAuthenticatedProcessingFilter to the filter chain to provide integration with container authentication.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-jee-parents" href="index.html#nsa-jee-parents"></a>Parent Elements of &lt;jee&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-http" title="43.1.2&nbsp;<http&gt;">http</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-jee-attributes" href="index.html#nsa-jee-attributes"></a>&lt;jee&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-jee-mappable-roles" href="index.html#nsa-jee-mappable-roles"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>mappable-roles</strong></span>
A comma-separate list of roles to look for in the incoming HttpServletRequest.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-jee-user-service-ref" href="index.html#nsa-jee-user-service-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>user-service-ref</strong></span>
A reference to a user-service (or UserDetailsService bean) Id
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-logout" href="index.html#nsa-logout"></a>43.1.26&nbsp;&lt;logout&gt;</h3></div></div></div>
<p>Adds a <code class="literal">LogoutFilter</code> to the filter stack. This is configured with a <code class="literal">SecurityContextLogoutHandler</code>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-logout-parents" href="index.html#nsa-logout-parents"></a>Parent Elements of &lt;logout&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-http" title="43.1.2&nbsp;<http&gt;">http</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-logout-attributes" href="index.html#nsa-logout-attributes"></a>&lt;logout&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-logout-delete-cookies" href="index.html#nsa-logout-delete-cookies"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>delete-cookies</strong></span>
A comma-separated list of the names of cookies which should be deleted when the user logs out.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-logout-invalidate-session" href="index.html#nsa-logout-invalidate-session"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>invalidate-session</strong></span>
Maps to the <code class="literal">invalidateHttpSession</code> of the <code class="literal">SecurityContextLogoutHandler</code>. Defaults to "true", so the session will be invalidated on logout.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-logout-logout-success-url" href="index.html#nsa-logout-logout-success-url"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<p class="simpara"><span class="strong"><strong>logout-success-url</strong></span>
The destination URL which the user will be taken to after logging out. Defaults to &lt;form-login-login-page&gt;/?logout (i.e. /login?logout)</p>
<p class="simpara">Setting this attribute will inject the <code class="literal">SessionManagementFilter</code> with a <code class="literal">SimpleRedirectInvalidSessionStrategy</code> configured with the attribute value. When an invalid session ID is submitted, the strategy will be invoked, redirecting to the configured URL.</p>
</li></ul></div>
<div class="itemizedlist"><a name="nsa-logout-logout-url" href="index.html#nsa-logout-logout-url"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>logout-url</strong></span>
The URL which will cause a logout (i.e. which will be processed by the filter). Defaults to "/logout".
</li></ul></div>
<div class="itemizedlist"><a name="nsa-logout-success-handler-ref" href="index.html#nsa-logout-success-handler-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>success-handler-ref</strong></span>
May be used to supply an instance of <code class="literal">LogoutSuccessHandler</code> which will be invoked to control the navigation after logging out.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-openid-login" href="index.html#nsa-openid-login"></a>43.1.27&nbsp;&lt;openid-login&gt;</h3></div></div></div>
<p>Similar to <code class="literal">&lt;form-login&gt;</code> and has the same attributes. The default value for <code class="literal">login-processing-url</code> is "/login/openid". An <code class="literal">OpenIDAuthenticationFilter</code> and <code class="literal">OpenIDAuthenticationProvider</code> will be registered. The latter requires a reference to a <code class="literal">UserDetailsService</code>. Again, this can be specified by <code class="literal">id</code>, using the <code class="literal">user-service-ref</code> attribute, or will be located automatically in the application context.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-openid-login-parents" href="index.html#nsa-openid-login-parents"></a>Parent Elements of &lt;openid-login&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-http" title="43.1.2&nbsp;<http&gt;">http</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-openid-login-attributes" href="index.html#nsa-openid-login-attributes"></a>&lt;openid-login&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-openid-login-always-use-default-target" href="index.html#nsa-openid-login-always-use-default-target"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>always-use-default-target</strong></span>
Whether the user should always be redirected to the default-target-url after login.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-openid-login-authentication-details-source-ref" href="index.html#nsa-openid-login-authentication-details-source-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>authentication-details-source-ref</strong></span>
Reference to an AuthenticationDetailsSource which will be used by the authentication filter
</li></ul></div>
<div class="itemizedlist"><a name="nsa-openid-login-authentication-failure-handler-ref" href="index.html#nsa-openid-login-authentication-failure-handler-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>authentication-failure-handler-ref</strong></span>
Reference to an AuthenticationFailureHandler bean which should be used to handle a failed authentication request. Should not be used in combination with authentication-failure-url as the implementation should always deal with navigation to the subsequent destination
</li></ul></div>
<div class="itemizedlist"><a name="nsa-openid-login-authentication-failure-url" href="index.html#nsa-openid-login-authentication-failure-url"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>authentication-failure-url</strong></span>
The URL for the login failure page. If no login failure URL is specified, Spring Security will automatically create a failure login URL at /login?login_error and a corresponding filter to render that login failure URL when requested.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-openid-login-authentication-success-forward-url" href="index.html#nsa-openid-login-authentication-success-forward-url"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>authentication-success-forward-url</strong></span>
Maps a <code class="literal">ForwardAuthenticationSuccessHandler</code> to <code class="literal">authenticationSuccessHandler</code> property of <code class="literal">UsernamePasswordAuthenticationFilter</code>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-openid-login-authentication-failure-forward-url" href="index.html#nsa-openid-login-authentication-failure-forward-url"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>authentication-failure-forward-url</strong></span>
Maps a <code class="literal">ForwardAuthenticationFailureHandler</code> to <code class="literal">authenticationFailureHandler</code> property of <code class="literal">UsernamePasswordAuthenticationFilter</code>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-openid-login-authentication-success-handler-ref" href="index.html#nsa-openid-login-authentication-success-handler-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>authentication-success-handler-ref</strong></span>
Reference to an AuthenticationSuccessHandler bean which should be used to handle a successful authentication request. Should not be used in combination with <a class="link" href="index.html#nsa-openid-login-default-target-url">default-target-url</a> (or <a class="link" href="index.html#nsa-openid-login-always-use-default-target">always-use-default-target</a>) as the implementation should always deal with navigation to the subsequent destination
</li></ul></div>
<div class="itemizedlist"><a name="nsa-openid-login-default-target-url" href="index.html#nsa-openid-login-default-target-url"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>default-target-url</strong></span>
The URL that will be redirected to after successful authentication, if the user&#8217;s previous action could not be resumed. This generally happens if the user visits a login page without having first requested a secured operation that triggers authentication. If unspecified, defaults to the root of the application.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-openid-login-login-page" href="index.html#nsa-openid-login-login-page"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>login-page</strong></span>
The URL for the login page. If no login URL is specified, Spring Security will automatically create a login URL at /login and a corresponding filter to render that login URL when requested.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-openid-login-login-processing-url" href="index.html#nsa-openid-login-login-processing-url"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>login-processing-url</strong></span>
The URL that the login form is posted to. If unspecified, it defaults to /login.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-openid-login-password-parameter" href="index.html#nsa-openid-login-password-parameter"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>password-parameter</strong></span>
The name of the request parameter which contains the password. Defaults to "password".
</li></ul></div>
<div class="itemizedlist"><a name="nsa-openid-login-user-service-ref" href="index.html#nsa-openid-login-user-service-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>user-service-ref</strong></span>
A reference to a user-service (or UserDetailsService bean) Id
</li></ul></div>
<div class="itemizedlist"><a name="nsa-openid-login-username-parameter" href="index.html#nsa-openid-login-username-parameter"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>username-parameter</strong></span>
The name of the request parameter which contains the username. Defaults to "username".
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-openid-login-children" href="index.html#nsa-openid-login-children"></a>Child Elements of &lt;openid-login&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-attribute-exchange" title="43.1.28&nbsp;<attribute-exchange&gt;">attribute-exchange</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-attribute-exchange" href="index.html#nsa-attribute-exchange"></a>43.1.28&nbsp;&lt;attribute-exchange&gt;</h3></div></div></div>
<p>The <code class="literal">attribute-exchange</code> element defines the list of attributes which should be requested from the identity provider. An example can be found in the <a class="link" href="index.html#ns-openid" title="6.3.4&nbsp;OpenID Support">OpenID Support</a> section of the namespace configuration chapter. More than one can be used, in which case each must have an <code class="literal">identifier-match</code> attribute, containing a regular expression which is matched against the supplied OpenID identifier. This allows different attribute lists to be fetched from different providers (Google, Yahoo etc).</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-attribute-exchange-parents" href="index.html#nsa-attribute-exchange-parents"></a>Parent Elements of &lt;attribute-exchange&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-openid-login" title="43.1.27&nbsp;<openid-login&gt;">openid-login</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-attribute-exchange-attributes" href="index.html#nsa-attribute-exchange-attributes"></a>&lt;attribute-exchange&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-attribute-exchange-identifier-match" href="index.html#nsa-attribute-exchange-identifier-match"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>identifier-match</strong></span>
A regular expression which will be compared against the claimed identity, when deciding which attribute-exchange configuration to use during authentication.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-attribute-exchange-children" href="index.html#nsa-attribute-exchange-children"></a>Child Elements of &lt;attribute-exchange&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-openid-attribute" title="43.1.29&nbsp;<openid-attribute&gt;">openid-attribute</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-openid-attribute" href="index.html#nsa-openid-attribute"></a>43.1.29&nbsp;&lt;openid-attribute&gt;</h3></div></div></div>
<p>Attributes used when making an OpenID AX <a class="ulink" href="https://openid.net/specs/openid-attribute-exchange-1_0.html#fetch_request" target="_top"> Fetch Request</a></p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-openid-attribute-parents" href="index.html#nsa-openid-attribute-parents"></a>Parent Elements of &lt;openid-attribute&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-attribute-exchange" title="43.1.28&nbsp;<attribute-exchange&gt;">attribute-exchange</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-openid-attribute-attributes" href="index.html#nsa-openid-attribute-attributes"></a>&lt;openid-attribute&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-openid-attribute-count" href="index.html#nsa-openid-attribute-count"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>count</strong></span>
Specifies the number of attributes that you wish to get back. For example, return 3 emails. The default value is 1.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-openid-attribute-name" href="index.html#nsa-openid-attribute-name"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>name</strong></span>
Specifies the name of the attribute that you wish to get back. For example, email.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-openid-attribute-required" href="index.html#nsa-openid-attribute-required"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>required</strong></span>
Specifies if this attribute is required to the OP, but does not error out if the OP does not return the attribute. Default is false.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-openid-attribute-type" href="index.html#nsa-openid-attribute-type"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>type</strong></span>
Specifies the attribute type. For example, <a class="ulink" href="http://axschema.org/contact/email" target="_top">http://axschema.org/contact/email</a>. See your OP&#8217;s documentation for valid attribute types.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-port-mappings" href="index.html#nsa-port-mappings"></a>43.1.30&nbsp;&lt;port-mappings&gt;</h3></div></div></div>
<p>By default, an instance of <code class="literal">PortMapperImpl</code> will be added to the configuration for use in redirecting to secure and insecure URLs. This element can optionally be used to override the default mappings which that class defines. Each child <code class="literal">&lt;port-mapping&gt;</code> element defines a pair of HTTP:HTTPS ports. The default mappings are 80:443 and 8080:8443. An example of overriding these can be found in the <a class="link" href="index.html#ns-requires-channel" title="6.3.2&nbsp;Adding HTTP/HTTPS Channel Security">namespace introduction</a>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-port-mappings-parents" href="index.html#nsa-port-mappings-parents"></a>Parent Elements of &lt;port-mappings&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-http" title="43.1.2&nbsp;<http&gt;">http</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-port-mappings-children" href="index.html#nsa-port-mappings-children"></a>Child Elements of &lt;port-mappings&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-port-mapping" title="43.1.31&nbsp;<port-mapping&gt;">port-mapping</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-port-mapping" href="index.html#nsa-port-mapping"></a>43.1.31&nbsp;&lt;port-mapping&gt;</h3></div></div></div>
<p>Provides a method to map http ports to https ports when forcing a redirect.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-port-mapping-parents" href="index.html#nsa-port-mapping-parents"></a>Parent Elements of &lt;port-mapping&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-port-mappings" title="43.1.30&nbsp;<port-mappings&gt;">port-mappings</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-port-mapping-attributes" href="index.html#nsa-port-mapping-attributes"></a>&lt;port-mapping&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-port-mapping-http" href="index.html#nsa-port-mapping-http"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>http</strong></span>
The http port to use.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-port-mapping-https" href="index.html#nsa-port-mapping-https"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>https</strong></span>
The https port to use.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-remember-me" href="index.html#nsa-remember-me"></a>43.1.32&nbsp;&lt;remember-me&gt;</h3></div></div></div>
<p>Adds the <code class="literal">RememberMeAuthenticationFilter</code> to the stack. This in turn will be configured with either a <code class="literal">TokenBasedRememberMeServices</code>, a <code class="literal">PersistentTokenBasedRememberMeServices</code> or a user-specified bean implementing <code class="literal">RememberMeServices</code> depending on the attribute settings.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-remember-me-parents" href="index.html#nsa-remember-me-parents"></a>Parent Elements of &lt;remember-me&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-http" title="43.1.2&nbsp;<http&gt;">http</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-remember-me-attributes" href="index.html#nsa-remember-me-attributes"></a>&lt;remember-me&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-remember-me-authentication-success-handler-ref" href="index.html#nsa-remember-me-authentication-success-handler-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>authentication-success-handler-ref</strong></span>
Sets the <code class="literal">authenticationSuccessHandler</code> property on the <code class="literal">RememberMeAuthenticationFilter</code> if custom navigation is required. The value should be the name of a <code class="literal">AuthenticationSuccessHandler</code> bean in the application context.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-remember-me-data-source-ref" href="index.html#nsa-remember-me-data-source-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>data-source-ref</strong></span>
A reference to a <code class="literal">DataSource</code> bean. If this is set, <code class="literal">PersistentTokenBasedRememberMeServices</code> will be used and configured with a <code class="literal">JdbcTokenRepositoryImpl</code> instance.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-remember-me-remember-me-parameter" href="index.html#nsa-remember-me-remember-me-parameter"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>remember-me-parameter</strong></span>
The name of the request parameter which toggles remember-me authentication. Defaults to "remember-me". Maps to the "parameter" property of <code class="literal">AbstractRememberMeServices</code>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-remember-me-remember-me-cookie" href="index.html#nsa-remember-me-remember-me-cookie"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>remember-me-cookie</strong></span>
The name of cookie which store the token for remember-me authentication. Defaults to "remember-me". Maps to the "cookieName" property of <code class="literal">AbstractRememberMeServices</code>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-remember-me-key" href="index.html#nsa-remember-me-key"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>key</strong></span>
Maps to the "key" property of <code class="literal">AbstractRememberMeServices</code>. Should be set to a unique value to ensure that remember-me cookies are only valid within the one application <a href="index.html#ftn.d5e7924" class="footnote" name="d5e7924"><sup class="footnote">[24]</sup></a>. If this is not set a secure random value will be generated. Since generating secure random values can take a while, setting this value explicitly can help improve startup times when using the remember-me functionality.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-remember-me-services-alias" href="index.html#nsa-remember-me-services-alias"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>services-alias</strong></span>
Exports the internally defined <code class="literal">RememberMeServices</code> as a bean alias, allowing it to be used by other beans in the application context.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-remember-me-services-ref" href="index.html#nsa-remember-me-services-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>services-ref</strong></span>
Allows complete control of the <code class="literal">RememberMeServices</code> implementation that will be used by the filter. The value should be the <code class="literal">id</code> of a bean in the application context which implements this interface. Should also implement <code class="literal">LogoutHandler</code> if a logout filter is in use.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-remember-me-token-repository-ref" href="index.html#nsa-remember-me-token-repository-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>token-repository-ref</strong></span>
Configures a <code class="literal">PersistentTokenBasedRememberMeServices</code> but allows the use of a custom <code class="literal">PersistentTokenRepository</code> bean.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-remember-me-token-validity-seconds" href="index.html#nsa-remember-me-token-validity-seconds"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>token-validity-seconds</strong></span>
Maps to the <code class="literal">tokenValiditySeconds</code> property of <code class="literal">AbstractRememberMeServices</code>. Specifies the period in seconds for which the remember-me cookie should be valid. By default it will be valid for 14 days.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-remember-me-use-secure-cookie" href="index.html#nsa-remember-me-use-secure-cookie"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>use-secure-cookie</strong></span>
It is recommended that remember-me cookies are only submitted over HTTPS and thus should be flagged as "secure". By default, a secure cookie will be used if the connection over which the login request is made is secure (as it should be). If you set this property to <code class="literal">false</code>, secure cookies will not be used. Setting it to <code class="literal">true</code> will always set the secure flag on the cookie. This attribute maps to the <code class="literal">useSecureCookie</code> property of <code class="literal">AbstractRememberMeServices</code>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-remember-me-user-service-ref" href="index.html#nsa-remember-me-user-service-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>user-service-ref</strong></span>
The remember-me services implementations require access to a <code class="literal">UserDetailsService</code>, so there has to be one defined in the application context. If there is only one, it will be selected and used automatically by the namespace configuration. If there are multiple instances, you can specify a bean <code class="literal">id</code> explicitly using this attribute.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-request-cache" href="index.html#nsa-request-cache"></a>43.1.33&nbsp;&lt;request-cache&gt; Element</h3></div></div></div>
<p>Sets the <code class="literal">RequestCache</code> instance which will be used by the <code class="literal">ExceptionTranslationFilter</code> to store request information before invoking an <code class="literal">AuthenticationEntryPoint</code>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-request-cache-parents" href="index.html#nsa-request-cache-parents"></a>Parent Elements of &lt;request-cache&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-http" title="43.1.2&nbsp;<http&gt;">http</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-request-cache-attributes" href="index.html#nsa-request-cache-attributes"></a>&lt;request-cache&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-request-cache-ref" href="index.html#nsa-request-cache-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>ref</strong></span>
Defines a reference to a Spring bean that is a <code class="literal">RequestCache</code>.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-session-management" href="index.html#nsa-session-management"></a>43.1.34&nbsp;&lt;session-management&gt;</h3></div></div></div>
<p>Session-management related functionality is implemented by the addition of a <code class="literal">SessionManagementFilter</code> to the filter stack.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-session-management-parents" href="index.html#nsa-session-management-parents"></a>Parent Elements of &lt;session-management&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-http" title="43.1.2&nbsp;<http&gt;">http</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-session-management-attributes" href="index.html#nsa-session-management-attributes"></a>&lt;session-management&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-session-management-invalid-session-url" href="index.html#nsa-session-management-invalid-session-url"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>invalid-session-url</strong></span>
Setting this attribute will inject the <code class="literal">SessionManagementFilter</code> with a <code class="literal">SimpleRedirectInvalidSessionStrategy</code> configured with the attribute value. When an invalid session ID is submitted, the strategy will be invoked, redirecting to the configured URL.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-session-management-invalid-session-strategy-ref" href="index.html#nsa-session-management-invalid-session-strategy-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>invalid-session-url</strong></span>
Allows injection of the InvalidSessionStrategy instance used by the SessionManagementFilter. Use either this or the <code class="literal">invalid-session-url</code> attribute but not both.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-session-management-session-authentication-error-url" href="index.html#nsa-session-management-session-authentication-error-url"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>session-authentication-error-url</strong></span>
Defines the URL of the error page which should be shown when the SessionAuthenticationStrategy raises an exception. If not set, an unauthorized (401) error code will be returned to the client. Note that this attribute doesn&#8217;t apply if the error occurs during a form-based login, where the URL for authentication failure will take precedence.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-session-management-session-authentication-strategy-ref" href="index.html#nsa-session-management-session-authentication-strategy-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>session-authentication-strategy-ref</strong></span>
Allows injection of the SessionAuthenticationStrategy instance used by the SessionManagementFilter
</li></ul></div>
<div class="itemizedlist"><a name="nsa-session-management-session-fixation-protection" href="index.html#nsa-session-management-session-fixation-protection"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<p class="simpara"><span class="strong"><strong>session-fixation-protection</strong></span>
Indicates how session fixation protection will be applied when a user authenticates. If set to "none", no protection will be applied. "newSession" will create a new empty session, with only Spring Security-related attributes migrated. "migrateSession" will create a new session and copy all session attributes to the new session. In Servlet 3.1 (Java EE 7) and newer containers, specifying "changeSessionId" will keep the existing session and use the container-supplied session fixation protection (HttpServletRequest#changeSessionId()). Defaults to "changeSessionId" in Servlet 3.1 and newer containers, "migrateSession" in older containers. Throws an exception if "changeSessionId" is used in older containers.</p>
<p class="simpara">If session fixation protection is enabled, the <code class="literal">SessionManagementFilter</code> is injected with an appropriately configured <code class="literal">DefaultSessionAuthenticationStrategy</code>. See the Javadoc for this class for more details.</p>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-session-management-children" href="index.html#nsa-session-management-children"></a>Child Elements of &lt;session-management&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-concurrency-control" title="43.1.35&nbsp;<concurrency-control&gt;">concurrency-control</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-concurrency-control" href="index.html#nsa-concurrency-control"></a>43.1.35&nbsp;&lt;concurrency-control&gt;</h3></div></div></div>
<p>Adds support for concurrent session control, allowing limits to be placed on the number of active sessions a user can have. A <code class="literal">ConcurrentSessionFilter</code> will be created, and a <code class="literal">ConcurrentSessionControlAuthenticationStrategy</code> will be used with the <code class="literal">SessionManagementFilter</code>. If a <code class="literal">form-login</code> element has been declared, the strategy object will also be injected into the created authentication filter. An instance of <code class="literal">SessionRegistry</code> (a <code class="literal">SessionRegistryImpl</code> instance unless the user wishes to use a custom bean) will be created for use by the strategy.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-concurrency-control-parents" href="index.html#nsa-concurrency-control-parents"></a>Parent Elements of &lt;concurrency-control&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-session-management" title="43.1.34&nbsp;<session-management&gt;">session-management</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-concurrency-control-attributes" href="index.html#nsa-concurrency-control-attributes"></a>&lt;concurrency-control&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-concurrency-control-error-if-maximum-exceeded" href="index.html#nsa-concurrency-control-error-if-maximum-exceeded"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>error-if-maximum-exceeded</strong></span>
If set to "true" a <code class="literal">SessionAuthenticationException</code> will be raised when a user attempts to exceed the maximum allowed number of sessions. The default behaviour is to expire the original session.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-concurrency-control-expired-url" href="index.html#nsa-concurrency-control-expired-url"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>expired-url</strong></span>
The URL a user will be redirected to if they attempt to use a session which has been "expired" by the concurrent session controller because the user has exceeded the number of allowed sessions and has logged in again elsewhere. Should be set unless <code class="literal">exception-if-maximum-exceeded</code> is set. If no value is supplied, an expiry message will just be written directly back to the response.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-concurrency-control-expired-session-strategy-ref" href="index.html#nsa-concurrency-control-expired-session-strategy-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>expired-url</strong></span>
Allows injection of the ExpiredSessionStrategy instance used by the ConcurrentSessionFilter
</li></ul></div>
<div class="itemizedlist"><a name="nsa-concurrency-control-max-sessions" href="index.html#nsa-concurrency-control-max-sessions"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>max-sessions</strong></span>
Maps to the <code class="literal">maximumSessions</code> property of <code class="literal">ConcurrentSessionControlAuthenticationStrategy</code>.
Specify <code class="literal">-1</code> as the value to support unlimited sessions.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-concurrency-control-session-registry-alias" href="index.html#nsa-concurrency-control-session-registry-alias"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>session-registry-alias</strong></span>
It can also be useful to have a reference to the internal session registry for use in your own beans or an admin interface. You can expose the internal bean using the <code class="literal">session-registry-alias</code> attribute, giving it a name that you can use elsewhere in your configuration.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-concurrency-control-session-registry-ref" href="index.html#nsa-concurrency-control-session-registry-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>session-registry-ref</strong></span>
The user can supply their own <code class="literal">SessionRegistry</code> implementation using the <code class="literal">session-registry-ref</code> attribute. The other concurrent session control beans will be wired up to use it.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-x509" href="index.html#nsa-x509"></a>43.1.36&nbsp;&lt;x509&gt;</h3></div></div></div>
<p>Adds support for X.509 authentication. An <code class="literal">X509AuthenticationFilter</code> will be added to the stack and an <code class="literal">Http403ForbiddenEntryPoint</code> bean will be created. The latter will only be used if no other authentication mechanisms are in use (its only functionality is to return an HTTP 403 error code). A <code class="literal">PreAuthenticatedAuthenticationProvider</code> will also be created which delegates the loading of user authorities to a <code class="literal">UserDetailsService</code>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-x509-parents" href="index.html#nsa-x509-parents"></a>Parent Elements of &lt;x509&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-http" title="43.1.2&nbsp;<http&gt;">http</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-x509-attributes" href="index.html#nsa-x509-attributes"></a>&lt;x509&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-x509-authentication-details-source-ref" href="index.html#nsa-x509-authentication-details-source-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>authentication-details-source-ref</strong></span>
A reference to an <code class="literal">AuthenticationDetailsSource</code>
</li></ul></div>
<div class="itemizedlist"><a name="nsa-x509-subject-principal-regex" href="index.html#nsa-x509-subject-principal-regex"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>subject-principal-regex</strong></span>
Defines a regular expression which will be used to extract the username from the certificate (for use with the <code class="literal">UserDetailsService</code>).
</li></ul></div>
<div class="itemizedlist"><a name="nsa-x509-user-service-ref" href="index.html#nsa-x509-user-service-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>user-service-ref</strong></span>
Allows a specific <code class="literal">UserDetailsService</code> to be used with X.509 in the case where multiple instances are configured. If not set, an attempt will be made to locate a suitable instance automatically and use that.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-filter-chain-map" href="index.html#nsa-filter-chain-map"></a>43.1.37&nbsp;&lt;filter-chain-map&gt;</h3></div></div></div>
<p>Used to explicitly configure a FilterChainProxy instance with a FilterChainMap</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-filter-chain-map-attributes" href="index.html#nsa-filter-chain-map-attributes"></a>&lt;filter-chain-map&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-filter-chain-map-request-matcher" href="index.html#nsa-filter-chain-map-request-matcher"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>request-matcher</strong></span>
Defines the strategy to use for matching incoming requests. Currently the options are 'ant' (for ant path patterns), 'regex' for regular expressions and 'ciRegex' for case-insensitive regular expressions.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-filter-chain-map-children" href="index.html#nsa-filter-chain-map-children"></a>Child Elements of &lt;filter-chain-map&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-filter-chain" title="43.1.38&nbsp;<filter-chain&gt;">filter-chain</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-filter-chain" href="index.html#nsa-filter-chain"></a>43.1.38&nbsp;&lt;filter-chain&gt;</h3></div></div></div>
<p>Used within to define a specific URL pattern and the list of filters which apply to the URLs matching that pattern. When multiple filter-chain elements are assembled in a list in order to configure a FilterChainProxy, the most specific patterns must be placed at the top of the list, with most general ones at the bottom.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-filter-chain-parents" href="index.html#nsa-filter-chain-parents"></a>Parent Elements of &lt;filter-chain&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-filter-chain-map" title="43.1.37&nbsp;<filter-chain-map&gt;">filter-chain-map</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-filter-chain-attributes" href="index.html#nsa-filter-chain-attributes"></a>&lt;filter-chain&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-filter-chain-filters" href="index.html#nsa-filter-chain-filters"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>filters</strong></span>
A comma separated list of references to Spring beans that implement <code class="literal">Filter</code>. The value "none" means that no <code class="literal">Filter</code> should be used for this <code class="literal">FilterChain</code>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-filter-chain-pattern" href="index.html#nsa-filter-chain-pattern"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>pattern</strong></span>
A pattern that creates RequestMatcher in combination with the <a class="link" href="index.html#nsa-filter-chain-map-request-matcher">request-matcher</a>
</li></ul></div>
<div class="itemizedlist"><a name="nsa-filter-chain-request-matcher-ref" href="index.html#nsa-filter-chain-request-matcher-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>request-matcher-ref</strong></span>
A reference to a <code class="literal">RequestMatcher</code> that will be used to determine if any <code class="literal">Filter</code> from the <code class="literal">filters</code> attribute should be invoked.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-filter-security-metadata-source" href="index.html#nsa-filter-security-metadata-source"></a>43.1.39&nbsp;&lt;filter-security-metadata-source&gt;</h3></div></div></div>
<p>Used to explicitly configure a FilterSecurityMetadataSource bean for use with a FilterSecurityInterceptor. Usually only needed if you are configuring a FilterChainProxy explicitly, rather than using the&lt;http&gt; element. The intercept-url elements used should only contain pattern, method and access attributes. Any others will result in a configuration error.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-filter-security-metadata-source-attributes" href="index.html#nsa-filter-security-metadata-source-attributes"></a>&lt;filter-security-metadata-source&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-filter-security-metadata-source-id" href="index.html#nsa-filter-security-metadata-source-id"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>id</strong></span>
A bean identifier, used for referring to the bean elsewhere in the context.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-filter-security-metadata-source-request-matcher" href="index.html#nsa-filter-security-metadata-source-request-matcher"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>request-matcher</strong></span>
Defines the strategy use for matching incoming requests. Currently the options are 'ant' (for ant path patterns), 'regex' for regular expressions and 'ciRegex' for case-insensitive regular expressions.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-filter-security-metadata-source-use-expressions" href="index.html#nsa-filter-security-metadata-source-use-expressions"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>use-expressions</strong></span>
Enables the use of expressions in the 'access' attributes in &lt;intercept-url&gt; elements rather than the traditional list of configuration attributes. Defaults to 'true'. If enabled, each attribute should contain a single Boolean expression. If the expression evaluates to 'true', access will be granted.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-filter-security-metadata-source-children" href="index.html#nsa-filter-security-metadata-source-children"></a>Child Elements of &lt;filter-security-metadata-source&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-intercept-url" title="43.1.24&nbsp;<intercept-url&gt;">intercept-url</a>
</li></ul></div>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="nsa-websocket-security" href="index.html#nsa-websocket-security"></a>43.2&nbsp;WebSocket Security</h2></div></div></div>
<p>Spring Security 4.0+ provides support for authorizing messages. One concrete example of where this is useful is to provide authorization in WebSocket based applications.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-websocket-message-broker" href="index.html#nsa-websocket-message-broker"></a>43.2.1&nbsp;&lt;websocket-message-broker&gt;</h3></div></div></div>
<p>The websocket-message-broker element has two different modes.
If the <a class="link" href="index.html#nsa-websocket-message-broker-id"><span class="__cf_email__" data-cfemail="10677572637f737b75643d7d7563637177753d72627f7b7562507974">[email&#160;protected]</span></a> is not specified, then it will do the following things:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Ensure that any SimpAnnotationMethodMessageHandler has the AuthenticationPrincipalArgumentResolver registered as a custom argument resolver. This allows the use of <code class="literal">@AuthenticationPrincipal</code> to resolve the principal of the current <code class="literal">Authentication</code>
</li><li class="listitem">
Ensures that the SecurityContextChannelInterceptor is automatically registered for the clientInboundChannel. This populates the SecurityContextHolder with the user that is found in the Message
</li><li class="listitem">
Ensures that a ChannelSecurityInterceptor is registered with the clientInboundChannel. This allows authorization rules to be specified for a message.
</li><li class="listitem">
Ensures that a CsrfChannelInterceptor is registered with the clientInboundChannel. This ensures that only requests from the original domain are enabled.
</li><li class="listitem">
Ensures that a CsrfTokenHandshakeInterceptor is registered with WebSocketHttpRequestHandler, TransportHandlingSockJsService, or DefaultSockJsService. This ensures that the expected CsrfToken from the HttpServletRequest is copied into the WebSocket Session attributes.
</li></ul></div>
<p>If additional control is necessary, the id can be specified and a ChannelSecurityInterceptor will be assigned to the specified id. All the wiring with Spring&#8217;s messaging infrastructure can then be done manually. This is more cumbersome, but provides greater control over the configuration.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-websocket-message-broker-attributes" href="index.html#nsa-websocket-message-broker-attributes"></a>&lt;websocket-message-broker&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-websocket-message-broker-id" href="index.html#nsa-websocket-message-broker-id"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>id</strong></span> A bean identifier, used for referring to the ChannelSecurityInterceptor bean elsewhere in the context. If specified, Spring Security requires explicit configuration within Spring Messaging. If not specified, Spring Security will automatically integrate with the messaging infrastructure as described in <a class="xref" href="index.html#nsa-websocket-message-broker" title="43.2.1&nbsp;<websocket-message-broker&gt;">Section&nbsp;43.2.1, &#8220;&lt;websocket-message-broker&gt;&#8221;</a>
</li></ul></div>
<div class="itemizedlist"><a name="nsa-websocket-message-broker-same-origin-disabled" href="index.html#nsa-websocket-message-broker-same-origin-disabled"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>same-origin-disabled</strong></span> Disables the requirement for CSRF token to be present in the Stomp headers (default false). Changing the default is useful if it is necessary to allow other origins to make SockJS connections.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-websocket-message-broker-children" href="index.html#nsa-websocket-message-broker-children"></a>Child Elements of &lt;websocket-message-broker&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-expression-handler" title="43.1.20&nbsp;<expression-handler&gt;">expression-handler</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-intercept-message" title="43.2.2&nbsp;<intercept-message&gt;">intercept-message</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-intercept-message" href="index.html#nsa-intercept-message"></a>43.2.2&nbsp;&lt;intercept-message&gt;</h3></div></div></div>
<p>Defines an authorization rule for a message.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-intercept-message-parents" href="index.html#nsa-intercept-message-parents"></a>Parent Elements of &lt;intercept-message&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-websocket-message-broker" title="43.2.1&nbsp;<websocket-message-broker&gt;">websocket-message-broker</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-intercept-message-attributes" href="index.html#nsa-intercept-message-attributes"></a>&lt;intercept-message&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-intercept-message-pattern" href="index.html#nsa-intercept-message-pattern"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>pattern</strong></span> An ant based pattern that matches on the Message destination. For example, "/<span class="strong"><strong>" matches any Message with a destination; "/admin/</strong></span>" matches any Message that has a destination that starts with "/admin/**".
</li></ul></div>
<div class="itemizedlist"><a name="nsa-intercept-message-type" href="index.html#nsa-intercept-message-type"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>type</strong></span> The type of message to match on.
Valid values are defined in SimpMessageType (i.e. CONNECT, CONNECT_ACK, HEARTBEAT, MESSAGE, SUBSCRIBE, UNSUBSCRIBE, DISCONNECT, DISCONNECT_ACK, OTHER).
</li></ul></div>
<div class="itemizedlist"><a name="nsa-intercept-message-access" href="index.html#nsa-intercept-message-access"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>access</strong></span> The expression used to secure the Message. For example, "denyAll" will deny access to all of the matching Messages; "permitAll" will grant access to all of the matching Messages; "hasRole('ADMIN') requires the current user to have the role 'ROLE_ADMIN' for the matching Messages.
</li></ul></div>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="nsa-authentication" href="index.html#nsa-authentication"></a>43.3&nbsp;Authentication Services</h2></div></div></div>
<p>Before Spring Security 3.0, an <code class="literal">AuthenticationManager</code> was automatically registered internally. Now you must register one explicitly using the <code class="literal">&lt;authentication-manager&gt;</code> element. This creates an instance of Spring Security&#8217;s <code class="literal">ProviderManager</code> class, which needs to be configured with a list of one or more <code class="literal">AuthenticationProvider</code> instances. These can either be created using syntax elements provided by the namespace, or they can be standard bean definitions, marked for addition to the list using the <code class="literal">authentication-provider</code> element.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-authentication-manager" href="index.html#nsa-authentication-manager"></a>43.3.1&nbsp;&lt;authentication-manager&gt;</h3></div></div></div>
<p>Every Spring Security application which uses the namespace must have include this element somewhere. It is responsible for registering the <code class="literal">AuthenticationManager</code> which provides authentication services to the application. All elements which create <code class="literal">AuthenticationProvider</code> instances should be children of this element.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-authentication-manager-attributes" href="index.html#nsa-authentication-manager-attributes"></a>&lt;authentication-manager&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-authentication-manager-alias" href="index.html#nsa-authentication-manager-alias"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>alias</strong></span>
This attribute allows you to define an alias name for the internal instance for use in your own configuration. Its use is described in the<a class="link" href="index.html#ns-auth-manager" title="6.6&nbsp;The Authentication Manager and the Namespace">namespace introduction</a>.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-authentication-manager-erase-credentials" href="index.html#nsa-authentication-manager-erase-credentials"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>erase-credentials</strong></span>
If set to true, the AuthenticationManager will attempt to clear any credentials data in the returned Authentication object, once the user has been authenticated. Literally it maps to the <code class="literal">eraseCredentialsAfterAuthentication</code> property of the <code class="literal">ProviderManager</code>. This is discussed in the <a class="link" href="index.html#core-services-erasing-credentials" title="10.1.1&nbsp;Erasing Credentials on Successful Authentication">Core Services</a> chapter.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-authentication-manager-id" href="index.html#nsa-authentication-manager-id"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>id</strong></span>
This attribute allows you to define an id for the internal instance for use in your own configuration. It is the same as the alias element, but provides a more consistent experience with elements that use the id attribute.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-authentication-manager-children" href="index.html#nsa-authentication-manager-children"></a>Child Elements of &lt;authentication-manager&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-authentication-provider" title="43.3.2&nbsp;<authentication-provider&gt;">authentication-provider</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-ldap-authentication-provider" title="43.5.2&nbsp;<ldap-authentication-provider&gt;">ldap-authentication-provider</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-authentication-provider" href="index.html#nsa-authentication-provider"></a>43.3.2&nbsp;&lt;authentication-provider&gt;</h3></div></div></div>
<p>Unless used with a <code class="literal">ref</code> attribute, this element is shorthand for configuring a <a class="link" href="index.html#core-services-dao-provider" title="10.1.2&nbsp;DaoAuthenticationProvider">DaoAuthenticationProvider</a>. <code class="literal">DaoAuthenticationProvider</code> loads user information from a <code class="literal">UserDetailsService</code> and compares the username/password combination with the values supplied at login. The <code class="literal">UserDetailsService</code> instance can be defined either by using an available namespace element (<code class="literal">jdbc-user-service</code> or by using the <code class="literal">user-service-ref</code> attribute to point to a bean defined elsewhere in the application context). You can find examples of these variations in the <a class="link" href="index.html#ns-auth-providers" title="6.2.5&nbsp;Using other Authentication Providers">namespace introduction</a>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-authentication-provider-parents" href="index.html#nsa-authentication-provider-parents"></a>Parent Elements of &lt;authentication-provider&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-authentication-manager" title="43.3.1&nbsp;<authentication-manager&gt;">authentication-manager</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-authentication-provider-attributes" href="index.html#nsa-authentication-provider-attributes"></a>&lt;authentication-provider&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-authentication-provider-ref" href="index.html#nsa-authentication-provider-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>ref</strong></span>
Defines a reference to a Spring bean that implements <code class="literal">AuthenticationProvider</code>.
</li></ul></div>
<p>If you have written your own <code class="literal">AuthenticationProvider</code> implementation (or want to configure one of Spring Security&#8217;s own implementations as a traditional bean for some reason, then you can use the following syntax to add it to the internal list of <code class="literal">ProviderManager</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;security:authentication-manager&gt;</span>
<span class="hl-tag">&lt;security:authentication-provider</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myAuthenticationProvider"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/security:authentication-manager&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myAuthenticationProvider"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.something.MyAuthenticationProvider"</span><span class="hl-tag">/&gt;</span></pre>
<div class="itemizedlist"><a name="nsa-authentication-provider-user-service-ref" href="index.html#nsa-authentication-provider-user-service-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>user-service-ref</strong></span>
A reference to a bean that implements UserDetailsService that may be created using the standard bean element or the custom user-service element.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-authentication-provider-children" href="index.html#nsa-authentication-provider-children"></a>Child Elements of &lt;authentication-provider&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-jdbc-user-service" title="43.3.3&nbsp;<jdbc-user-service&gt;">jdbc-user-service</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-ldap-user-service" title="43.5.4&nbsp;<ldap-user-service&gt;">ldap-user-service</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-password-encoder" title="43.3.4&nbsp;<password-encoder&gt;">password-encoder</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-user-service" title="43.3.5&nbsp;<user-service&gt;">user-service</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-jdbc-user-service" href="index.html#nsa-jdbc-user-service"></a>43.3.3&nbsp;&lt;jdbc-user-service&gt;</h3></div></div></div>
<p>Causes creation of a JDBC-based UserDetailsService.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-jdbc-user-service-attributes" href="index.html#nsa-jdbc-user-service-attributes"></a>&lt;jdbc-user-service&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-jdbc-user-service-authorities-by-username-query" href="index.html#nsa-jdbc-user-service-authorities-by-username-query"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>authorities-by-username-query</strong></span>
An SQL statement to query for a user&#8217;s granted authorities given a username.
</li></ul></div>
<p>The default is</p>
<pre class="screen">select username, authority from authorities where username = ?</pre>
<div class="itemizedlist"><a name="nsa-jdbc-user-service-cache-ref" href="index.html#nsa-jdbc-user-service-cache-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>cache-ref</strong></span>
Defines a reference to a cache for use with a UserDetailsService.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-jdbc-user-service-data-source-ref" href="index.html#nsa-jdbc-user-service-data-source-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>data-source-ref</strong></span>
The bean ID of the DataSource which provides the required tables.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-jdbc-user-service-group-authorities-by-username-query" href="index.html#nsa-jdbc-user-service-group-authorities-by-username-query"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<p class="simpara"><span class="strong"><strong>group-authorities-by-username-query</strong></span>
An SQL statement to query user&#8217;s group authorities given a username. The default is</p>
<pre class="screen">select
g.id, g.group_name, ga.authority
from
groups g, group_members gm, group_authorities ga
where
gm.username = ? and g.id = ga.group_id and g.id = gm.group_id</pre>
</li></ul></div>
<div class="itemizedlist"><a name="nsa-jdbc-user-service-id" href="index.html#nsa-jdbc-user-service-id"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>id</strong></span>
A bean identifier, used for referring to the bean elsewhere in the context.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-jdbc-user-service-role-prefix" href="index.html#nsa-jdbc-user-service-role-prefix"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>role-prefix</strong></span>
A non-empty string prefix that will be added to role strings loaded from persistent storage (default is "ROLE_"). Use the value "none" for no prefix in cases where the default is non-empty.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-jdbc-user-service-users-by-username-query" href="index.html#nsa-jdbc-user-service-users-by-username-query"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<p class="simpara"><span class="strong"><strong>users-by-username-query</strong></span>
An SQL statement to query a username, password, and enabled status given a username. The default is</p>
<pre class="screen">select username, password, enabled from users where username = ?</pre>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-password-encoder" href="index.html#nsa-password-encoder"></a>43.3.4&nbsp;&lt;password-encoder&gt;</h3></div></div></div>
<p>Authentication providers can optionally be configured to use a password encoder as described in the <a class="link" href="index.html#ns-password-encoder" title="Adding a Password Encoder">namespace introduction</a>. This will result in the bean being injected with the appropriate <code class="literal">PasswordEncoder</code> instance.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-password-encoder-parents" href="index.html#nsa-password-encoder-parents"></a>Parent Elements of &lt;password-encoder&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-authentication-provider" title="43.3.2&nbsp;<authentication-provider&gt;">authentication-provider</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-password-compare" title="43.5.3&nbsp;<password-compare&gt;">password-compare</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-password-encoder-attributes" href="index.html#nsa-password-encoder-attributes"></a>&lt;password-encoder&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-password-encoder-hash" href="index.html#nsa-password-encoder-hash"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>hash</strong></span>
Defines the hashing algorithm used on user passwords. We recommend strongly against using MD4, as it is a very weak hashing algorithm.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-password-encoder-ref" href="index.html#nsa-password-encoder-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>ref</strong></span>
Defines a reference to a Spring bean that implements <code class="literal">PasswordEncoder</code>.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-user-service" href="index.html#nsa-user-service"></a>43.3.5&nbsp;&lt;user-service&gt;</h3></div></div></div>
<p>Creates an in-memory UserDetailsService from a properties file or a list of "user" child elements. Usernames are converted to lower-case internally to allow for case-insensitive lookups, so this should not be used if case-sensitivity is required.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-user-service-attributes" href="index.html#nsa-user-service-attributes"></a>&lt;user-service&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-user-service-id" href="index.html#nsa-user-service-id"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>id</strong></span>
A bean identifier, used for referring to the bean elsewhere in the context.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-user-service-properties" href="index.html#nsa-user-service-properties"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<p class="simpara"><span class="strong"><strong>properties</strong></span>
The location of a Properties file where each line is in the format of</p>
<pre class="screen">username=password,grantedAuthority[,grantedAuthority][,enabled|disabled]</pre>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-user-service-children" href="index.html#nsa-user-service-children"></a>Child Elements of &lt;user-service&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-user" title="43.3.6&nbsp;<user&gt;">user</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-user" href="index.html#nsa-user"></a>43.3.6&nbsp;&lt;user&gt;</h3></div></div></div>
<p>Represents a user in the application.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-user-parents" href="index.html#nsa-user-parents"></a>Parent Elements of &lt;user&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-user-service" title="43.3.5&nbsp;<user-service&gt;">user-service</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-user-attributes" href="index.html#nsa-user-attributes"></a>&lt;user&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-user-authorities" href="index.html#nsa-user-authorities"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>authorities</strong></span>
One of more authorities granted to the user. Separate authorities with a comma (but no space). For example, "ROLE_USER,ROLE_ADMINISTRATOR"
</li></ul></div>
<div class="itemizedlist"><a name="nsa-user-disabled" href="index.html#nsa-user-disabled"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>disabled</strong></span>
Can be set to "true" to mark an account as disabled and unusable.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-user-locked" href="index.html#nsa-user-locked"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>locked</strong></span>
Can be set to "true" to mark an account as locked and unusable.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-user-name" href="index.html#nsa-user-name"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>name</strong></span>
The username assigned to the user.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-user-password" href="index.html#nsa-user-password"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>password</strong></span>
The password assigned to the user. This may be hashed if the corresponding authentication provider supports hashing (remember to set the "hash" attribute of the "user-service" element). This attribute be omitted in the case where the data will not be used for authentication, but only for accessing authorities. If omitted, the namespace will generate a random value, preventing its accidental use for authentication. Cannot be empty.
</li></ul></div>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="nsa-method-security" href="index.html#nsa-method-security"></a>43.4&nbsp;Method Security</h2></div></div></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-global-method-security" href="index.html#nsa-global-method-security"></a>43.4.1&nbsp;&lt;global-method-security&gt;</h3></div></div></div>
<p>This element is the primary means of adding support for securing methods on Spring Security beans. Methods can be secured by the use of annotations (defined at the interface or class level) or by defining a set of pointcuts as child elements, using AspectJ syntax.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-global-method-security-attributes" href="index.html#nsa-global-method-security-attributes"></a>&lt;global-method-security&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-global-method-security-access-decision-manager-ref" href="index.html#nsa-global-method-security-access-decision-manager-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>access-decision-manager-ref</strong></span>
Method security uses the same <code class="literal">AccessDecisionManager</code> configuration as web security, but this can be overridden using this attribute. By default an AffirmativeBased implementation is used for with a RoleVoter and an AuthenticatedVoter.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-global-method-security-authentication-manager-ref" href="index.html#nsa-global-method-security-authentication-manager-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>authentication-manager-ref</strong></span>
A reference to an <code class="literal">AuthenticationManager</code> that should be used for method security.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-global-method-security-jsr250-annotations" href="index.html#nsa-global-method-security-jsr250-annotations"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>jsr250-annotations</strong></span>
Specifies whether JSR-250 style attributes are to be used (for example "RolesAllowed"). This will require the javax.annotation.security classes on the classpath. Setting this to true also adds a <code class="literal">Jsr250Voter</code> to the <code class="literal">AccessDecisionManager</code>, so you need to make sure you do this if you are using a custom implementation and want to use these annotations.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-global-method-security-metadata-source-ref" href="index.html#nsa-global-method-security-metadata-source-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>metadata-source-ref</strong></span>
An external <code class="literal">MethodSecurityMetadataSource</code> instance can be supplied which will take priority over other sources (such as the default annotations).
</li></ul></div>
<div class="itemizedlist"><a name="nsa-global-method-security-mode" href="index.html#nsa-global-method-security-mode"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>mode</strong></span>
This attribute can be set to "aspectj" to specify that AspectJ should be used instead of the default Spring AOP. Secured methods must be woven with the <code class="literal">AnnotationSecurityAspect</code> from the <code class="literal">spring-security-aspects</code> module.
</li></ul></div>
<p>It is important to note that AspectJ follows Java&#8217;s rule that annotations on interfaces are not inherited. This means that methods that define the Security annotations on the interface will not be secured. Instead, you must place the Security annotation on the class when using AspectJ.</p>
<div class="itemizedlist"><a name="nsa-global-method-security-order" href="index.html#nsa-global-method-security-order"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>order</strong></span>
Allows the advice "order" to be set for the method security interceptor.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-global-method-security-pre-post-annotations" href="index.html#nsa-global-method-security-pre-post-annotations"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>pre-post-annotations</strong></span>
Specifies whether the use of Spring Security&#8217;s pre and post invocation annotations (@PreFilter, @PreAuthorize, @PostFilter, @PostAuthorize) should be enabled for this application context. Defaults to "disabled".
</li></ul></div>
<div class="itemizedlist"><a name="nsa-global-method-security-proxy-target-class" href="index.html#nsa-global-method-security-proxy-target-class"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>proxy-target-class</strong></span>
If true, class based proxying will be used instead of interface based proxying.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-global-method-security-run-as-manager-ref" href="index.html#nsa-global-method-security-run-as-manager-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>run-as-manager-ref</strong></span>
A reference to an optional <code class="literal">RunAsManager</code> implementation which will be used by the configured <code class="literal">MethodSecurityInterceptor</code>
</li></ul></div>
<div class="itemizedlist"><a name="nsa-global-method-security-secured-annotations" href="index.html#nsa-global-method-security-secured-annotations"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>secured-annotations</strong></span>
Specifies whether the use of Spring Security&#8217;s @Secured annotations should be enabled for this application context. Defaults to "disabled".
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-global-method-security-children" href="index.html#nsa-global-method-security-children"></a>Child Elements of &lt;global-method-security&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-after-invocation-provider" title="43.4.2&nbsp;<after-invocation-provider&gt;">after-invocation-provider</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-expression-handler" title="43.1.20&nbsp;<expression-handler&gt;">expression-handler</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-pre-post-annotation-handling" title="43.4.3&nbsp;<pre-post-annotation-handling&gt;">pre-post-annotation-handling</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-protect-pointcut" title="43.4.7&nbsp;Securing Methods using">protect-pointcut</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-after-invocation-provider" href="index.html#nsa-after-invocation-provider"></a>43.4.2&nbsp;&lt;after-invocation-provider&gt;</h3></div></div></div>
<p>This element can be used to decorate an <code class="literal">AfterInvocationProvider</code> for use by the security interceptor maintained by the <code class="literal">&lt;global-method-security&gt;</code> namespace. You can define zero or more of these within the <code class="literal">global-method-security</code> element, each with a <code class="literal">ref</code> attribute pointing to an <code class="literal">AfterInvocationProvider</code> bean instance within your application context.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-after-invocation-provider-parents" href="index.html#nsa-after-invocation-provider-parents"></a>Parent Elements of &lt;after-invocation-provider&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-global-method-security" title="43.4.1&nbsp;<global-method-security&gt;">global-method-security</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-after-invocation-provider-attributes" href="index.html#nsa-after-invocation-provider-attributes"></a>&lt;after-invocation-provider&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-after-invocation-provider-ref" href="index.html#nsa-after-invocation-provider-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>ref</strong></span>
Defines a reference to a Spring bean that implements <code class="literal">AfterInvocationProvider</code>.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-pre-post-annotation-handling" href="index.html#nsa-pre-post-annotation-handling"></a>43.4.3&nbsp;&lt;pre-post-annotation-handling&gt;</h3></div></div></div>
<p>Allows the default expression-based mechanism for handling Spring Security&#8217;s pre and post invocation annotations (@PreFilter, @PreAuthorize, @PostFilter, @PostAuthorize) to be replaced entirely. Only applies if these annotations are enabled.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-pre-post-annotation-handling-parents" href="index.html#nsa-pre-post-annotation-handling-parents"></a>Parent Elements of &lt;pre-post-annotation-handling&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-global-method-security" title="43.4.1&nbsp;<global-method-security&gt;">global-method-security</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-pre-post-annotation-handling-children" href="index.html#nsa-pre-post-annotation-handling-children"></a>Child Elements of &lt;pre-post-annotation-handling&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-invocation-attribute-factory" title="43.4.4&nbsp;<invocation-attribute-factory&gt;">invocation-attribute-factory</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-post-invocation-advice" title="43.4.5&nbsp;<post-invocation-advice&gt;">post-invocation-advice</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-pre-invocation-advice" title="43.4.6&nbsp;<pre-invocation-advice&gt;">pre-invocation-advice</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-invocation-attribute-factory" href="index.html#nsa-invocation-attribute-factory"></a>43.4.4&nbsp;&lt;invocation-attribute-factory&gt;</h3></div></div></div>
<p>Defines the PrePostInvocationAttributeFactory instance which is used to generate pre and post invocation metadata from the annotated methods.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-invocation-attribute-factory-parents" href="index.html#nsa-invocation-attribute-factory-parents"></a>Parent Elements of &lt;invocation-attribute-factory&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-pre-post-annotation-handling" title="43.4.3&nbsp;<pre-post-annotation-handling&gt;">pre-post-annotation-handling</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-invocation-attribute-factory-attributes" href="index.html#nsa-invocation-attribute-factory-attributes"></a>&lt;invocation-attribute-factory&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-invocation-attribute-factory-ref" href="index.html#nsa-invocation-attribute-factory-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>ref</strong></span>
Defines a reference to a Spring bean Id.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-post-invocation-advice" href="index.html#nsa-post-invocation-advice"></a>43.4.5&nbsp;&lt;post-invocation-advice&gt;</h3></div></div></div>
<p>Customizes the <code class="literal">PostInvocationAdviceProvider</code> with the ref as the <code class="literal">PostInvocationAuthorizationAdvice</code> for the &lt;pre-post-annotation-handling&gt; element.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-post-invocation-advice-parents" href="index.html#nsa-post-invocation-advice-parents"></a>Parent Elements of &lt;post-invocation-advice&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-pre-post-annotation-handling" title="43.4.3&nbsp;<pre-post-annotation-handling&gt;">pre-post-annotation-handling</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-post-invocation-advice-attributes" href="index.html#nsa-post-invocation-advice-attributes"></a>&lt;post-invocation-advice&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-post-invocation-advice-ref" href="index.html#nsa-post-invocation-advice-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>ref</strong></span>
Defines a reference to a Spring bean Id.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-pre-invocation-advice" href="index.html#nsa-pre-invocation-advice"></a>43.4.6&nbsp;&lt;pre-invocation-advice&gt;</h3></div></div></div>
<p>Customizes the <code class="literal">PreInvocationAuthorizationAdviceVoter</code> with the ref as the <code class="literal">PreInvocationAuthorizationAdviceVoter</code> for the &lt;pre-post-annotation-handling&gt; element.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-pre-invocation-advice-parents" href="index.html#nsa-pre-invocation-advice-parents"></a>Parent Elements of &lt;pre-invocation-advice&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-pre-post-annotation-handling" title="43.4.3&nbsp;<pre-post-annotation-handling&gt;">pre-post-annotation-handling</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-pre-invocation-advice-attributes" href="index.html#nsa-pre-invocation-advice-attributes"></a>&lt;pre-invocation-advice&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-pre-invocation-advice-ref" href="index.html#nsa-pre-invocation-advice-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>ref</strong></span>
Defines a reference to a Spring bean Id.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-protect-pointcut" href="index.html#nsa-protect-pointcut"></a>43.4.7&nbsp;Securing Methods using</h3></div></div></div>
<p><code class="literal">&lt;protect-pointcut&gt;</code>
Rather than defining security attributes on an individual method or class basis using the <code class="literal">@Secured</code> annotation, you can define cross-cutting security constraints across whole sets of methods and interfaces in your service layer using the <code class="literal">&lt;protect-pointcut&gt;</code> element. You can find an example in the <a class="link" href="index.html#ns-protect-pointcut" title="Adding Security Pointcuts using protect-pointcut">namespace introduction</a>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-protect-pointcut-parents" href="index.html#nsa-protect-pointcut-parents"></a>Parent Elements of &lt;protect-pointcut&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-global-method-security" title="43.4.1&nbsp;<global-method-security&gt;">global-method-security</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-protect-pointcut-attributes" href="index.html#nsa-protect-pointcut-attributes"></a>&lt;protect-pointcut&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-protect-pointcut-access" href="index.html#nsa-protect-pointcut-access"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>access</strong></span>
Access configuration attributes list that applies to all methods matching the pointcut, e.g. "ROLE_A,ROLE_B"
</li></ul></div>
<div class="itemizedlist"><a name="nsa-protect-pointcut-expression" href="index.html#nsa-protect-pointcut-expression"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>expression</strong></span>
An AspectJ expression, including the 'execution' keyword. For example, 'execution(int com.foo.TargetObject.countLength(String))' (without the quotes).
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-intercept-methods" href="index.html#nsa-intercept-methods"></a>43.4.8&nbsp;&lt;intercept-methods&gt;</h3></div></div></div>
<p>Can be used inside a bean definition to add a security interceptor to the bean and set up access configuration attributes for the bean&#8217;s methods</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-intercept-methods-attributes" href="index.html#nsa-intercept-methods-attributes"></a>&lt;intercept-methods&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-intercept-methods-access-decision-manager-ref" href="index.html#nsa-intercept-methods-access-decision-manager-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>access-decision-manager-ref</strong></span>
Optional AccessDecisionManager bean ID to be used by the created method security interceptor.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-intercept-methods-children" href="index.html#nsa-intercept-methods-children"></a>Child Elements of &lt;intercept-methods&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-protect" title="43.4.10&nbsp;<protect&gt;">protect</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-method-security-metadata-source" href="index.html#nsa-method-security-metadata-source"></a>43.4.9&nbsp;&lt;method-security-metadata-source&gt;</h3></div></div></div>
<p>Creates a MethodSecurityMetadataSource instance</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-method-security-metadata-source-attributes" href="index.html#nsa-method-security-metadata-source-attributes"></a>&lt;method-security-metadata-source&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-method-security-metadata-source-id" href="index.html#nsa-method-security-metadata-source-id"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>id</strong></span>
A bean identifier, used for referring to the bean elsewhere in the context.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-method-security-metadata-source-use-expressions" href="index.html#nsa-method-security-metadata-source-use-expressions"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>use-expressions</strong></span>
Enables the use of expressions in the 'access' attributes in &lt;intercept-url&gt; elements rather than the traditional list of configuration attributes. Defaults to 'false'. If enabled, each attribute should contain a single Boolean expression. If the expression evaluates to 'true', access will be granted.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-method-security-metadata-source-children" href="index.html#nsa-method-security-metadata-source-children"></a>Child Elements of &lt;method-security-metadata-source&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-protect" title="43.4.10&nbsp;<protect&gt;">protect</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-protect" href="index.html#nsa-protect"></a>43.4.10&nbsp;&lt;protect&gt;</h3></div></div></div>
<p>Defines a protected method and the access control configuration attributes that apply to it. We strongly advise you NOT to mix "protect" declarations with any services provided "global-method-security".</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-protect-parents" href="index.html#nsa-protect-parents"></a>Parent Elements of &lt;protect&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-intercept-methods" title="43.4.8&nbsp;<intercept-methods&gt;">intercept-methods</a>
</li><li class="listitem">
<a class="link" href="index.html#nsa-method-security-metadata-source" title="43.4.9&nbsp;<method-security-metadata-source&gt;">method-security-metadata-source</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-protect-attributes" href="index.html#nsa-protect-attributes"></a>&lt;protect&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-protect-access" href="index.html#nsa-protect-access"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>access</strong></span>
Access configuration attributes list that applies to the method, e.g. "ROLE_A,ROLE_B".
</li></ul></div>
<div class="itemizedlist"><a name="nsa-protect-method" href="index.html#nsa-protect-method"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>method</strong></span>
A method name
</li></ul></div>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="nsa-ldap" href="index.html#nsa-ldap"></a>43.5&nbsp;LDAP Namespace Options</h2></div></div></div>
<p>LDAP is covered in some details in <a class="link" href="index.html#ldap" title="30.&nbsp;LDAP Authentication">its own chapter</a>. We will expand on that here with some explanation of how the namespace options map to Spring beans. The LDAP implementation uses Spring LDAP extensively, so some familiarity with that project&#8217;s API may be useful.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-ldap-server" href="index.html#nsa-ldap-server"></a>43.5.1&nbsp;Defining the LDAP Server using the</h3></div></div></div>
<p><code class="literal">&lt;ldap-server&gt;</code> Element
This element sets up a Spring LDAP <code class="literal">ContextSource</code> for use by the other LDAP beans, defining the location of the LDAP server and other information (such as a username and password, if it doesn&#8217;t allow anonymous access) for connecting to it. It can also be used to create an embedded server for testing. Details of the syntax for both options are covered in the <a class="link" href="index.html#ldap-server" title="30.3&nbsp;Configuring an LDAP Server">LDAP chapter</a>. The actual <code class="literal">ContextSource</code> implementation is <code class="literal">DefaultSpringSecurityContextSource</code> which extends Spring LDAP&#8217;s <code class="literal">LdapContextSource</code> class. The <code class="literal">manager-dn</code> and <code class="literal">manager-password</code> attributes map to the latter&#8217;s <code class="literal">userDn</code> and <code class="literal">password</code> properties respectively.</p>
<p>If you only have one server defined in your application context, the other LDAP namespace-defined beans will use it automatically. Otherwise, you can give the element an "id" attribute and refer to it from other namespace beans using the <code class="literal">server-ref</code> attribute. This is actually the bean <code class="literal">id</code> of the <code class="literal">ContextSource</code> instance, if you want to use it in other traditional Spring beans.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-ldap-server-attributes" href="index.html#nsa-ldap-server-attributes"></a>&lt;ldap-server&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-ldap-server-id" href="index.html#nsa-ldap-server-id"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>id</strong></span>
A bean identifier, used for referring to the bean elsewhere in the context.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-server-ldif" href="index.html#nsa-ldap-server-ldif"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>ldif</strong></span>
Explicitly specifies an ldif file resource to load into an embedded LDAP server. The ldiff is should be a Spring resource pattern (i.e. classpath:init.ldiff). The default is classpath*:*.ldiff
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-server-manager-dn" href="index.html#nsa-ldap-server-manager-dn"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>manager-dn</strong></span>
Username (DN) of the "manager" user identity which will be used to authenticate to a (non-embedded) LDAP server. If omitted, anonymous access will be used.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-server-manager-password" href="index.html#nsa-ldap-server-manager-password"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>manager-password</strong></span>
The password for the manager DN. This is required if the manager-dn is specified.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-server-port" href="index.html#nsa-ldap-server-port"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>port</strong></span>
Specifies an IP port number. Used to configure an embedded LDAP server, for example. The default value is 33389.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-server-root" href="index.html#nsa-ldap-server-root"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>root</strong></span>
Optional root suffix for the embedded LDAP server. Default is "dc=springframework,dc=org"
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-server-url" href="index.html#nsa-ldap-server-url"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>url</strong></span>
Specifies the ldap server URL when not using the embedded LDAP server.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-ldap-authentication-provider" href="index.html#nsa-ldap-authentication-provider"></a>43.5.2&nbsp;&lt;ldap-authentication-provider&gt;</h3></div></div></div>
<p>This element is shorthand for the creation of an <code class="literal">LdapAuthenticationProvider</code> instance. By default this will be configured with a <code class="literal">BindAuthenticator</code> instance and a <code class="literal">DefaultAuthoritiesPopulator</code>. As with all namespace authentication providers, it must be included as a child of the <code class="literal">authentication-provider</code> element.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-ldap-authentication-provider-parents" href="index.html#nsa-ldap-authentication-provider-parents"></a>Parent Elements of &lt;ldap-authentication-provider&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-authentication-manager" title="43.3.1&nbsp;<authentication-manager&gt;">authentication-manager</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-ldap-authentication-provider-attributes" href="index.html#nsa-ldap-authentication-provider-attributes"></a>&lt;ldap-authentication-provider&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-ldap-authentication-provider-group-role-attribute" href="index.html#nsa-ldap-authentication-provider-group-role-attribute"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>group-role-attribute</strong></span>
The LDAP attribute name which contains the role name which will be used within Spring Security. Maps to the <code class="literal">DefaultLdapAuthoritiesPopulator</code>'s <code class="literal">groupRoleAttribute</code> property. Defaults to "cn".
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-authentication-provider-group-search-base" href="index.html#nsa-ldap-authentication-provider-group-search-base"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>group-search-base</strong></span>
Search base for group membership searches. Maps to the <code class="literal">DefaultLdapAuthoritiesPopulator</code>'s <code class="literal">groupSearchBase</code> constructor argument. Defaults to "" (searching from the root).
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-authentication-provider-group-search-filter" href="index.html#nsa-ldap-authentication-provider-group-search-filter"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>group-search-filter</strong></span>
Group search filter. Maps to the <code class="literal">DefaultLdapAuthoritiesPopulator</code>'s <code class="literal">groupSearchFilter</code> property. Defaults to (uniqueMember={0}). The substituted parameter is the DN of the user.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-authentication-provider-role-prefix" href="index.html#nsa-ldap-authentication-provider-role-prefix"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>role-prefix</strong></span>
A non-empty string prefix that will be added to role strings loaded from persistent. Maps to the <code class="literal">DefaultLdapAuthoritiesPopulator</code>'s <code class="literal">rolePrefix</code> property. Defaults to "ROLE_". Use the value "none" for no prefix in cases where the default is non-empty.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-authentication-provider-server-ref" href="index.html#nsa-ldap-authentication-provider-server-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>server-ref</strong></span>
The optional server to use. If omitted, and a default LDAP server is registered (using &lt;ldap-server&gt; with no Id), that server will be used.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-authentication-provider-user-context-mapper-ref" href="index.html#nsa-ldap-authentication-provider-user-context-mapper-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>user-context-mapper-ref</strong></span>
Allows explicit customization of the loaded user object by specifying a UserDetailsContextMapper bean which will be called with the context information from the user&#8217;s directory entry
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-authentication-provider-user-details-class" href="index.html#nsa-ldap-authentication-provider-user-details-class"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>user-details-class</strong></span>
Allows the objectClass of the user entry to be specified. If set, the framework will attempt to load standard attributes for the defined class into the returned UserDetails object
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-authentication-provider-user-dn-pattern" href="index.html#nsa-ldap-authentication-provider-user-dn-pattern"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>user-dn-pattern</strong></span>
If your users are at a fixed location in the directory (i.e. you can work out the DN directly from the username without doing a directory search), you can use this attribute to map directly to the DN. It maps directly to the <code class="literal">userDnPatterns</code> property of <code class="literal">AbstractLdapAuthenticator</code>. The value is a specific pattern used to build the user&#8217;s DN, for example "uid={0},ou=people". The key "{0}" must be present and will be substituted with the username.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-authentication-provider-user-search-base" href="index.html#nsa-ldap-authentication-provider-user-search-base"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<p class="simpara"><span class="strong"><strong>user-search-base</strong></span>
Search base for user searches. Defaults to "". Only used with a 'user-search-filter'.</p>
<p class="simpara">If you need to perform a search to locate the user in the directory, then you can set these attributes to control the search. The <code class="literal">BindAuthenticator</code> will be configured with a <code class="literal">FilterBasedLdapUserSearch</code> and the attribute values map directly to the first two arguments of that bean&#8217;s constructor. If these attributes aren&#8217;t set and no <code class="literal">user-dn-pattern</code> has been supplied as an alternative, then the default search values of <code class="literal">user-search-filter="(uid={0})"</code> and <code class="literal">user-search-base=""</code> will be used.</p>
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-authentication-provider-user-search-filter" href="index.html#nsa-ldap-authentication-provider-user-search-filter"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<p class="simpara"><span class="strong"><strong>user-search-filter</strong></span>
The LDAP filter used to search for users (optional). For example "(uid={0})". The substituted parameter is the user&#8217;s login name.</p>
<p class="simpara">If you need to perform a search to locate the user in the directory, then you can set these attributes to control the search. The <code class="literal">BindAuthenticator</code> will be configured with a <code class="literal">FilterBasedLdapUserSearch</code> and the attribute values map directly to the first two arguments of that bean&#8217;s constructor. If these attributes aren&#8217;t set and no <code class="literal">user-dn-pattern</code> has been supplied as an alternative, then the default search values of <code class="literal">user-search-filter="(uid={0})"</code> and <code class="literal">user-search-base=""</code> will be used.</p>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-ldap-authentication-provider-children" href="index.html#nsa-ldap-authentication-provider-children"></a>Child Elements of &lt;ldap-authentication-provider&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-password-compare" title="43.5.3&nbsp;<password-compare&gt;">password-compare</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-password-compare" href="index.html#nsa-password-compare"></a>43.5.3&nbsp;&lt;password-compare&gt;</h3></div></div></div>
<p>This is used as child element to <code class="literal">&lt;ldap-provider&gt;</code> and switches the authentication strategy from <code class="literal">BindAuthenticator</code> to <code class="literal">PasswordComparisonAuthenticator</code>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-password-compare-parents" href="index.html#nsa-password-compare-parents"></a>Parent Elements of &lt;password-compare&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-ldap-authentication-provider" title="43.5.2&nbsp;<ldap-authentication-provider&gt;">ldap-authentication-provider</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-password-compare-attributes" href="index.html#nsa-password-compare-attributes"></a>&lt;password-compare&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-password-compare-hash" href="index.html#nsa-password-compare-hash"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>hash</strong></span>
Defines the hashing algorithm used on user passwords. We recommend strongly against using MD4, as it is a very weak hashing algorithm.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-password-compare-password-attribute" href="index.html#nsa-password-compare-password-attribute"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>password-attribute</strong></span>
The attribute in the directory which contains the user password. Defaults to "userPassword".
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-password-compare-children" href="index.html#nsa-password-compare-children"></a>Child Elements of &lt;password-compare&gt;</h4></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="index.html#nsa-password-encoder" title="43.3.4&nbsp;<password-encoder&gt;">password-encoder</a>
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nsa-ldap-user-service" href="index.html#nsa-ldap-user-service"></a>43.5.4&nbsp;&lt;ldap-user-service&gt;</h3></div></div></div>
<p>This element configures an LDAP <code class="literal">UserDetailsService</code>. The class used is <code class="literal">LdapUserDetailsService</code> which is a combination of a <code class="literal">FilterBasedLdapUserSearch</code> and a <code class="literal">DefaultLdapAuthoritiesPopulator</code>. The attributes it supports have the same usage as in <code class="literal">&lt;ldap-provider&gt;</code>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="nsa-ldap-user-service-attributes" href="index.html#nsa-ldap-user-service-attributes"></a>&lt;ldap-user-service&gt; Attributes</h4></div></div></div>
<div class="itemizedlist"><a name="nsa-ldap-user-service-cache-ref" href="index.html#nsa-ldap-user-service-cache-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>cache-ref</strong></span>
Defines a reference to a cache for use with a UserDetailsService.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-user-service-group-role-attribute" href="index.html#nsa-ldap-user-service-group-role-attribute"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>group-role-attribute</strong></span>
The LDAP attribute name which contains the role name which will be used within Spring Security. Defaults to "cn".
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-user-service-group-search-base" href="index.html#nsa-ldap-user-service-group-search-base"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>group-search-base</strong></span>
Search base for group membership searches. Defaults to "" (searching from the root).
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-user-service-group-search-filter" href="index.html#nsa-ldap-user-service-group-search-filter"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>group-search-filter</strong></span>
Group search filter. Defaults to (uniqueMember={0}). The substituted parameter is the DN of the user.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-user-service-id" href="index.html#nsa-ldap-user-service-id"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>id</strong></span>
A bean identifier, used for referring to the bean elsewhere in the context.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-user-service-role-prefix" href="index.html#nsa-ldap-user-service-role-prefix"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>role-prefix</strong></span>
A non-empty string prefix that will be added to role strings loaded from persistent storage (e.g. "ROLE_"). Use the value "none" for no prefix in cases where the default is non-empty.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-user-service-server-ref" href="index.html#nsa-ldap-user-service-server-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>server-ref</strong></span>
The optional server to use. If omitted, and a default LDAP server is registered (using &lt;ldap-server&gt; with no Id), that server will be used.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-user-service-user-context-mapper-ref" href="index.html#nsa-ldap-user-service-user-context-mapper-ref"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>user-context-mapper-ref</strong></span>
Allows explicit customization of the loaded user object by specifying a UserDetailsContextMapper bean which will be called with the context information from the user&#8217;s directory entry
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-user-service-user-details-class" href="index.html#nsa-ldap-user-service-user-details-class"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>user-details-class</strong></span>
Allows the objectClass of the user entry to be specified. If set, the framework will attempt to load standard attributes for the defined class into the returned UserDetails object
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-user-service-user-search-base" href="index.html#nsa-ldap-user-service-user-search-base"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>user-search-base</strong></span>
Search base for user searches. Defaults to "". Only used with a 'user-search-filter'.
</li></ul></div>
<div class="itemizedlist"><a name="nsa-ldap-user-service-user-search-filter" href="index.html#nsa-ldap-user-service-user-search-filter"></a><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>user-search-filter</strong></span>
The LDAP filter used to search for users (optional). For example "(uid={0})". The substituted parameter is the user&#8217;s login name.
</li></ul></div>
</div>
</div>
</div>
<div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.d5e6706" class="footnote"><p><a href="index.html#d5e6706" class="simpara"><sup class="simpara">[22] </sup></a>See the <a class="link" href="index.html#ns-web-xml" title="6.2.1&nbsp;web.xml Configuration">introductory chapter</a> for how to set up the mapping from your <code class="literal">web.xml</code></p></div><div id="ftn.d5e7451" class="footnote"><p><a href="index.html#d5e7451" class="simpara"><sup class="simpara">[23] </sup></a>This feature is really just provided for convenience and is not intended for production (where a view technology will have been chosen and can be used to render a customized login page). The class <code class="literal">DefaultLoginPageGeneratingFilter</code> is responsible for rendering the login page and will provide login forms for both normal form login and/or OpenID if required.</p></div><div id="ftn.d5e7924" class="footnote"><p><a href="index.html#d5e7924" class="simpara"><sup class="simpara">[24] </sup></a>This doesn&#8217;t affect the use of <code class="literal">PersistentTokenBasedRememberMeServices</code>, where the tokens are stored on the server side.</p></div></div></div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="appendix-dependencies" href="index.html#appendix-dependencies"></a>44.&nbsp;Spring Security Dependencies</h2></div></div></div>
<p>This appendix provides a reference of the modules in Spring Security and the additional dependencies that they require in order to function in a running application. We don&#8217;t include dependencies that are only used when building or testing Spring Security itself. Nor do we include transitive dependencies which are required by external dependencies.</p>
<p>The version of Spring required is listed on the project website, so the specific versions are omitted for Spring dependencies below. Note that some of the dependencies listed as "optional" below may still be required for other non-security functionality in a Spring application. Also dependencies listed as "optional" may not actually be marked as such in the project&#8217;s Maven POM files if they are used in most applications. They are "optional" only in the sense that you don&#8217;t need them unless you are using the specified functionality.</p>
<p>Where a module depends on another Spring Security module, the non-optional dependencies of the module it depends on are also assumed to be required and are not listed separately.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-security-core-2" href="index.html#spring-security-core-2"></a>44.1&nbsp;spring-security-core</h2></div></div></div>
<p>The core module must be included in any project using Spring Security.</p>
<div class="table"><a name="d5e8906" href="index.html#d5e8906"></a><p class="title"><b>Table&nbsp;44.1.&nbsp;Core Dependencies</b></p><div class="table-contents">
<table summary="Core Dependencies" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Dependency</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Version</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ehcache</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1.6.2</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Required if the Ehcache-based user cache implementation is used (optional).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-aop</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Method security is based on Spring AOP</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-beans</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Required for Spring configuration</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-expression</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Required for expression-based method security (optional)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-jdbc</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Required if using a database to store user data (optional).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-tx</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Required if using a database to store user data (optional).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>aspectjrt</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1.6.10</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Required if using AspectJ support (optional).</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>jsr250-api</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>1.0</p></td><td style="" align="left" valign="top"><p>Required if you are using JSR-250 method-security annotations (optional).</p></td></tr></tbody></table>
</div></div><br class="table-break">
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-security-remoting-2" href="index.html#spring-security-remoting-2"></a>44.2&nbsp;spring-security-remoting</h2></div></div></div>
<p>This module is typically required in web applications which use the Servlet API.</p>
<div class="table"><a name="d5e8972" href="index.html#d5e8972"></a><p class="title"><b>Table&nbsp;44.2.&nbsp;Remoting Dependencies</b></p><div class="table-contents">
<table summary="Remoting Dependencies" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Dependency</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Version</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-security-core</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>spring-web</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="" align="left" valign="top"><p>Required for clients which use HTTP remoting support.</p></td></tr></tbody></table>
</div></div><br class="table-break">
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-security-web-2" href="index.html#spring-security-web-2"></a>44.3&nbsp;spring-security-web</h2></div></div></div>
<p>This module is typically required in web applications which use the Servlet API.</p>
<div class="table"><a name="d5e8998" href="index.html#d5e8998"></a><p class="title"><b>Table&nbsp;44.3.&nbsp;Web Dependencies</b></p><div class="table-contents">
<table summary="Web Dependencies" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Dependency</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Version</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-security-core</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-web</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Spring web support classes are used extensively.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-jdbc</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Required for JDBC-based persistent remember-me token repository (optional).</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>spring-tx</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="" align="left" valign="top"><p>Required by remember-me persistent token repository implementations (optional).</p></td></tr></tbody></table>
</div></div><br class="table-break">
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-security-ldap-2" href="index.html#spring-security-ldap-2"></a>44.4&nbsp;spring-security-ldap</h2></div></div></div>
<p>This module is only required if you are using LDAP authentication.</p>
<div class="table"><a name="d5e9036" href="index.html#d5e9036"></a><p class="title"><b>Table&nbsp;44.4.&nbsp;LDAP Dependencies</b></p><div class="table-contents">
<table summary="LDAP Dependencies" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Dependency</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Version</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-security-core</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-ldap-core</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1.3.0</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>LDAP support is based on Spring LDAP.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-tx</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Data exception classes are required.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>apache-ds <a href="index.html#ftn.d5e9069" class="footnote" name="d5e9069"><sup class="footnote">[1]</sup></a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1.5.5</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Required if you are using an embedded LDAP server (optional).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>shared-ldap</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0.9.15</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Required if you are using an embedded LDAP server (optional).</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>ldapsdk</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>4.1</p></td><td style="" align="left" valign="top"><p>Mozilla LdapSDK. Used for decoding LDAP password policy controls if you are using password-policy functionality with OpenLDAP, for example.</p></td></tr></tbody><tbody class="footnotes"><tr><td colspan="3"><div id="ftn.d5e9069" class="footnote"><p><a href="index.html#d5e9069" class="simpara"><sup class="simpara">[1] </sup></a>The modules <code class="literal">apacheds-core</code>, <code class="literal">apacheds-core-entry</code>, <code class="literal">apacheds-protocol-shared</code>, <code class="literal">apacheds-protocol-ldap</code> and <code class="literal">apacheds-server-jndi</code> are required.</p></div></td></tr></tbody></table>
</div></div><br class="table-break">
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-security-config-2" href="index.html#spring-security-config-2"></a>44.5&nbsp;spring-security-config</h2></div></div></div>
<p>This module is required if you are using Spring Security namespace configuration.</p>
<div class="table"><a name="d5e9097" href="index.html#d5e9097"></a><p class="title"><b>Table&nbsp;44.5.&nbsp;Config Dependencies</b></p><div class="table-contents">
<table summary="Config Dependencies" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Dependency</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Version</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-security-core</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-security-web</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Required if you are using any web-related namespace configuration (optional).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-security-ldap</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Required if you are using the LDAP namespace options (optional).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-security-openid</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Required if you are using OpenID authentication (optional).</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>aspectjweaver</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>1.6.10</p></td><td style="" align="left" valign="top"><p>Required if using the protect-pointcut namespace syntax (optional).</p></td></tr></tbody></table>
</div></div><br class="table-break">
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-security-acl-2" href="index.html#spring-security-acl-2"></a>44.6&nbsp;spring-security-acl</h2></div></div></div>
<p>The ACL module.</p>
<div class="table"><a name="d5e9142" href="index.html#d5e9142"></a><p class="title"><b>Table&nbsp;44.6.&nbsp;ACL Dependencies</b></p><div class="table-contents">
<table summary="ACL Dependencies" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Dependency</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Version</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-security-core</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ehcache</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1.6.2</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Required if the Ehcache-based ACL cache implementation is used (optional if you are using your own implementation).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-jdbc</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Required if you are using the default JDBC-based AclService (optional if you implement your own).</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>spring-tx</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="" align="left" valign="top"><p>Required if you are using the default JDBC-based AclService (optional if you implement your own).</p></td></tr></tbody></table>
</div></div><br class="table-break">
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-security-cas-2" href="index.html#spring-security-cas-2"></a>44.7&nbsp;spring-security-cas</h2></div></div></div>
<p>The CAS module provides integration with JA-SIG CAS.</p>
<div class="table"><a name="d5e9181" href="index.html#d5e9181"></a><p class="title"><b>Table&nbsp;44.7.&nbsp;CAS Dependencies</b></p><div class="table-contents">
<table summary="CAS Dependencies" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Dependency</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Version</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-security-core</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-security-web</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>cas-client-core</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>3.1.12</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The JA-SIG CAS Client. This is the basis of the Spring Security integration.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>ehcache</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>1.6.2</p></td><td style="" align="left" valign="top"><p>Required if you are using the Ehcache-based ticket cache (optional).</p></td></tr></tbody></table>
</div></div><br class="table-break">
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-security-openid-2" href="index.html#spring-security-openid-2"></a>44.8&nbsp;spring-security-openid</h2></div></div></div>
<p>The OpenID module.</p>
<div class="table"><a name="d5e9220" href="index.html#d5e9220"></a><p class="title"><b>Table&nbsp;44.8.&nbsp;OpenID Dependencies</b></p><div class="table-contents">
<table summary="OpenID Dependencies" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Dependency</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Version</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-security-core</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-security-web</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>openid4java-nodeps</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0.9.6</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Spring Security&#8217;s OpenID integration uses OpenID4Java.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>httpclient</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>4.1.1</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>openid4java-nodeps depends on HttpClient 4.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>guice</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>2.0</p></td><td style="" align="left" valign="top"><p>openid4java-nodeps depends on Guice 2.</p></td></tr></tbody></table>
</div></div><br class="table-break">
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-security-taglibs" href="index.html#spring-security-taglibs"></a>44.9&nbsp;spring-security-taglibs</h2></div></div></div>
<p>Provides Spring Security&#8217;s JSP tag implementations.</p>
<div class="table"><a name="d5e9266" href="index.html#d5e9266"></a><p class="title"><b>Table&nbsp;44.9.&nbsp;Taglib Dependencies</b></p><div class="table-contents">
<table summary="Taglib Dependencies" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Dependency</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Version</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-security-core</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-security-web</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>spring-security-acl</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Required if you are using the <code class="literal">accesscontrollist</code> tag or <code class="literal">hasPermission()</code> expressions with ACLs (optional).</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>spring-expression</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="" align="left" valign="top"><p>Required if you are using SPEL expressions in your tag access constraints.</p></td></tr></tbody></table>
</div></div><br class="table-break">
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="appendix-proxy-server" href="index.html#appendix-proxy-server"></a>45.&nbsp;Proxy Server Configuration</h2></div></div></div>
<p>When using a proxy server it is important to ensure that you have configured your application properly.
For example, many applications will have a load balancer that responds to request for <a class="ulink" href="https://example.com/" target="_top">https://example.com/</a> by forwarding the request to an application server at <a class="ulink" href="http://192.168.1:8080" target="_top">http://192.168.1:8080</a>
Without proper configuration, the application server will not know that the load balancer exists and treat the request as though <a class="ulink" href="http://192.168.1:8080" target="_top">http://192.168.1:8080</a> was requested by the client.</p>
<p>To fix this you can use <a class="ulink" href="https://tools.ietf.org/html/rfc7239" target="_top">RFC 7239</a> to specify that a load balancer is being used.
To make the application aware of this, you need to either configure your application server aware of the X-Forwarded headers.
For example Tomcat uses the <a class="ulink" href="https://tomcat.apache.org/tomcat-8.0-doc/api/org/apache/catalina/valves/RemoteIpValve.html" target="_top">RemoteIpValve</a> and Jetty uses <a class="ulink" href="http://download.eclipse.org/jetty/stable-9/apidocs/org/eclipse/jetty/server/ForwardedRequestCustomizer.html" target="_top">ForwardedRequestCustomizer</a>.
Alternatively, Spring 4.3+ users can leverage <a class="ulink" href="https://github.com/spring-projects/spring-framework/blob/v4.3.3.RELEASE/spring-web/src/main/java/org/springframework/web/filter/ForwardedHeaderFilter.java" target="_top">ForwardedHeaderFilter</a>.</p>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="appendix-faq" href="index.html#appendix-faq"></a>46.&nbsp;Spring Security FAQ</h2></div></div></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="index.html#appendix-faq-general-questions" title="46.1&nbsp;General Questions">Section&nbsp;46.1, &#8220;General Questions&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-common-problems" title="46.2&nbsp;Common Problems">Section&nbsp;46.2, &#8220;Common Problems&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-architecture" title="46.3&nbsp;Spring Security Architecture Questions">Section&nbsp;46.3, &#8220;Spring Security Architecture Questions&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-howto" title="46.4&nbsp;Common &#34;Howto&#34; Requests">Section&nbsp;46.4, &#8220;Common "Howto" Requests&#8221;</a>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="appendix-faq-general-questions" href="index.html#appendix-faq-general-questions"></a>46.1&nbsp;General Questions</h2></div></div></div>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<a class="xref" href="index.html#appendix-faq-other-concerns" title="46.1.1&nbsp;Will Spring Security take care of all my application security requirements?">Section&nbsp;46.1.1, &#8220;Will Spring Security take care of all my application security requirements?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-web-xml" title="46.1.2&nbsp;Why not just use web.xml security?">Section&nbsp;46.1.2, &#8220;Why not just use web.xml security?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-requirements" title="46.1.3&nbsp;What Java and Spring Framework versions are required?">Section&nbsp;46.1.3, &#8220;What Java and Spring Framework versions are required?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-start-simple" title="46.1.4&nbsp;I&#8217;m new to Spring Security and I need to build an application that supports CAS single sign-on over HTTPS, while allowing Basic authentication locally for certain URLs, authenticating against multiple back end user information sources (LDAP and JDBC). I&#8217;ve copied some configuration files I found but it doesn&#8217;t work. What could be wrong?">Section&nbsp;46.1.4, &#8220;I&#8217;m new to Spring Security and I need to build an application that supports CAS single sign-on over HTTPS, while allowing Basic authentication locally for certain URLs, authenticating against multiple back end user information sources (LDAP and JDBC). I&#8217;ve copied some configuration files I found but it doesn&#8217;t work. What could be wrong?&#8221;</a>
</li></ol></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-other-concerns" href="index.html#appendix-faq-other-concerns"></a>46.1.1&nbsp;Will Spring Security take care of all my application security requirements?</h3></div></div></div>
<p>Spring Security provides you with a very flexible framework for your authentication and authorization requirements, but there are many other considerations for building a secure application that are outside its scope. Web applications are vulnerable to all kinds of attacks which you should be familiar with, preferably before you start development so you can design and code with them in mind from the beginning. Check out thehttp://www.owasp.org/[OWASP web site] for information on the major issues facing web application developers and the countermeasures you can use against them.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-web-xml" href="index.html#appendix-faq-web-xml"></a>46.1.2&nbsp;Why not just use web.xml security?</h3></div></div></div>
<p>Let&#8217;s assume you&#8217;re developing an enterprise application based on Spring. There are four security concerns you typically need to address: authentication, web request security, service layer security (i.e. your methods that implement business logic), and domain object instance security (i.e. different domain objects have different permissions). With these typical requirements in mind:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<span class="emphasis"><em>Authentication</em></span>: The servlet specification provides an approach to authentication. However, you will need to configure the container to perform authentication which typically requires editing of container-specific "realm" settings. This makes a non-portable configuration, and if you need to write an actual Java class to implement the container&#8217;s authentication interface, it becomes even more non-portable. With Spring Security you achieve complete portability - right down to the WAR level. Also, Spring Security offers a choice of production-proven authentication providers and mechanisms, meaning you can switch your authentication approaches at deployment time. This is particularly valuable for software vendors writing products that need to work in an unknown target environment.
</li><li class="listitem">
<span class="emphasis"><em>Web request security:</em></span> The servlet specification provides an approach to secure your request URIs. However, these URIs can only be expressed in the servlet specification&#8217;s own limited URI path format. Spring Security provides a far more comprehensive approach. For instance, you can use Ant paths or regular expressions, you can consider parts of the URI other than simply the requested page (e.g. you can consider HTTP GET parameters) and you can implement your own runtime source of configuration data. This means your web request security can be dynamically changed during the actual execution of your webapp.
</li><li class="listitem">
<p class="simpara"><span class="emphasis"><em>Service layer and domain object security:</em></span> The absence of support in the servlet specification for services layer security or domain object instance security represent serious limitations for multi-tiered applications. Typically developers either ignore these requirements, or implement security logic within their MVC controller code (or even worse, inside the views). There are serious disadvantages with this approach:</p>
<div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem">
<span class="emphasis"><em>Separation of concerns:</em></span> Authorization is a crosscutting concern and should be implemented as such. MVC controllers or views implementing authorization code makes it more difficult to test both the controller and authorization logic, more difficult to debug, and will often lead to code duplication.
</li><li class="listitem">
<span class="emphasis"><em>Support for rich clients and web services:</em></span> If an additional client type must ultimately be supported, any authorization code embedded within the web layer is non-reusable. It should be considered that Spring remoting exporters only export service layer beans (not MVC controllers). As such authorization logic needs to be located in the services layer to support a multitude of client types.
</li><li class="listitem">
<span class="emphasis"><em>Layering issues:</em></span> An MVC controller or view is simply the incorrect architectural layer to implement authorization decisions concerning services layer methods or domain object instances. Whilst the Principal may be passed to the services layer to enable it to make the authorization decision, doing so would introduce an additional argument on every services layer method. A more elegant approach is to use a ThreadLocal to hold the Principal, although this would likely increase development time to a point where it would become more economical (on a cost-benefit basis) to simply use a dedicated security framework.
</li><li class="listitem">
<span class="emphasis"><em>Authorisation code quality:</em></span> It is often said of web frameworks that they "make it easier to do the right things, and harder to do the wrong things". Security frameworks are the same, because they are designed in an abstract manner for a wide range of purposes. Writing your own authorization code from scratch does not provide the "design check" a framework would offer, and in-house authorization code will typically lack the improvements that emerge from widespread deployment, peer review and new versions.
</li></ol></div>
</li></ol></div>
<p>For simple applications, servlet specification security may just be enough. Although when considered within the context of web container portability, configuration requirements, limited web request security flexibility, and non-existent services layer and domain object instance security, it becomes clear why developers often look to alternative solutions.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-requirements" href="index.html#appendix-faq-requirements"></a>46.1.3&nbsp;What Java and Spring Framework versions are required?</h3></div></div></div>
<p>Spring Security 3.0 and 3.1 require at least JDK 1.5 and also require Spring 3.0.3 as a minimum. Ideally you should be using the latest release versions to avoid problems.</p>
<p>Spring Security 2.0.x requires a minimum JDK version of 1.4 and is built against Spring 2.0.x. It should also be compatible with applications using Spring 2.5.x.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-start-simple" href="index.html#appendix-faq-start-simple"></a>46.1.4&nbsp;I&#8217;m new to Spring Security and I need to build an application that supports CAS single sign-on over HTTPS, while allowing Basic authentication locally for certain URLs, authenticating against multiple back end user information sources (LDAP and JDBC). I&#8217;ve copied some configuration files I found but it doesn&#8217;t work. What could be wrong?</h3></div></div></div>
<p>Or subsititute an alternative complex scenario&#8230;&#8203;</p>
<p>Realistically, you need an understanding of the technolgies you are intending to use before you can successfully build applications with them. Security is complicated. Setting up a simple configuration using a login form and some hard-coded users using Spring Security&#8217;s namespace is reasonably straightforward. Moving to using a backed JDBC database is also easy enough. But if you try and jump straight to a complicated deployment scenario like this you will almost certainly be frustrated. There is a big jump in the learning curve required to set up systems like CAS, configure LDAP servers and install SSL certificates properly. So you need to take things one step at a time.</p>
<p>From a Spring Security perspective, the first thing you should do is follow the "Getting Started" guide on the web site. This will take you through a series of steps to get up and running and get some idea of how the framework operates. If you are using other technologies which you aren&#8217;t familiar with then you should do some research and try to make sure you can use them in isolation before combining them in a complex system.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="appendix-faq-common-problems" href="index.html#appendix-faq-common-problems"></a>46.2&nbsp;Common Problems</h2></div></div></div>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<p class="simpara">Authentication</p>
<div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem">
<a class="xref" href="index.html#appendix-faq-bad-credentials" title="46.2.1&nbsp;When I try to log in, I get an error message that says &#34;Bad Credentials&#34;. What&#8217;s wrong?">Section&nbsp;46.2.1, &#8220;When I try to log in, I get an error message that says "Bad Credentials". What&#8217;s wrong?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-login-loop" title="46.2.2&nbsp;My application goes into an &#34;endless loop&#34; when I try to login, what&#8217;s going on?">Section&nbsp;46.2.2, &#8220;My application goes into an "endless loop" when I try to login, what&#8217;s going on?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-anon-access-denied" title="46.2.3&nbsp;I get an exception with the message &#34;Access is denied (user is anonymous);&#34;. What&#8217;s wrong?">Section&nbsp;46.2.3, &#8220;I get an exception with the message "Access is denied (user is anonymous);". What&#8217;s wrong?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-cached-secure-page" title="46.2.4&nbsp;Why can I still see a secured page even after I&#8217;ve logged out of my application?">Section&nbsp;46.2.4, &#8220;Why can I still see a secured page even after I&#8217;ve logged out of my application?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#auth-exception-credentials-not-found" title="46.2.5&nbsp;I get an exception with the message &#34;An Authentication object was not found in the SecurityContext&#34;. What&#8217;s wrong?">Section&nbsp;46.2.5, &#8220;I get an exception with the message "An Authentication object was not found in the SecurityContext". What&#8217;s wrong?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-ldap-authentication" title="46.2.6&nbsp;I can&#8217;t get LDAP authentication to work. What&#8217;s wrong with my configuration?">Section&nbsp;46.2.6, &#8220;I can&#8217;t get LDAP authentication to work. What&#8217;s wrong with my configuration?&#8221;</a>
</li></ol></div>
</li><li class="listitem">
<p class="simpara">Session Management</p>
<div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem">
<a class="xref" href="index.html#appendix-faq-concurrent-session-same-browser" title="46.2.8&nbsp;I&#8217;m using Spring Security&#8217;s concurrent session control to prevent users from logging in more than once at a time. When I open another browser window after logging in, it doesn&#8217;t stop me from logging in again. Why can I log in more than once?">Section&nbsp;46.2.8, &#8220;I&#8217;m using Spring Security&#8217;s concurrent session control to prevent users from logging in more than once at a time. When I open another browser window after logging in, it doesn&#8217;t stop me from logging in again. Why can I log in more than once?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-new-session-on-authentication" title="46.2.9&nbsp;Why does the session Id change when I authenticate through Spring Security?">Section&nbsp;46.2.9, &#8220;Why does the session Id change when I authenticate through Spring Security?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-tomcat-https-session" title="46.2.10&nbsp;I&#8217;m using Tomcat (or some other servlet container) and have enabled HTTPS for my login page, switching back to HTTP afterwards. It doesn&#8217;t work - I just end up back at the login page after authenticating.">Section&nbsp;46.2.10, &#8220;I&#8217;m using Tomcat (or some other servlet container) and have enabled HTTPS for my login page, switching back to HTTP afterwards. It doesn&#8217;t work - I just end up back at the login page after authenticating.&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-session-listener-missing" title="46.2.12&nbsp;I&#8217;m trying to use the concurrent session-control support but it won&#8217;t let me log back in, even if I&#8217;m sure I&#8217;ve logged out and haven&#8217;t exceeded the allowed sessions.">Section&nbsp;46.2.12, &#8220;I&#8217;m trying to use the concurrent session-control support but it won&#8217;t let me log back in, even if I&#8217;m sure I&#8217;ve logged out and haven&#8217;t exceeded the allowed sessions.&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-unwanted-session-creation" title="46.2.13&nbsp;Spring Security is creating a session somewhere, even though I&#8217;ve configured it not to, by setting the create-session attribute to never.">Section&nbsp;46.2.13, &#8220;Spring Security is creating a session somewhere, even though I&#8217;ve configured it not to, by setting the create-session attribute to never.&#8221;</a>
</li></ol></div>
</li><li class="listitem">
<p class="simpara">Miscellaneous</p>
<div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem">
<a class="xref" href="index.html#appendix-faq-forbidden-csrf" title="46.2.14&nbsp;I get a 403 Forbidden when performing a POST">Section&nbsp;46.2.14, &#8220;I get a 403 Forbidden when performing a POST&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-no-security-on-forward" title="46.2.15&nbsp;I&#8217;m forwarding a request to another URL using the RequestDispatcher, but my security constraints aren&#8217;t being applied.">Section&nbsp;46.2.15, &#8220;I&#8217;m forwarding a request to another URL using the RequestDispatcher, but my security constraints aren&#8217;t being applied.&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-method-security-in-web-context" title="46.2.16&nbsp;I have added Spring Security&#8217;s <global-method-security&gt; element to my application context but if I add security annotations to my Spring MVC controller beans (Struts actions etc.) then they don&#8217;t seem to have an effect.">Section&nbsp;46.2.16, &#8220;I have added Spring Security&#8217;s &lt;global-method-security&gt; element to my application context but if I add security annotations to my Spring MVC controller beans (Struts actions etc.) then they don&#8217;t seem to have an effect.&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-no-filters-no-context" title="46.2.17&nbsp;I have a user who has definitely been authenticated, but when I try to access the SecurityContextHolder during some requests, the Authentication is null. Why can&#8217;t I see the user information?">Section&nbsp;46.2.17, &#8220;I have a user who has definitely been authenticated, but when I try to access the SecurityContextHolder during some requests, the Authentication is null. Why can&#8217;t I see the user information?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-method-security-with-taglib" title="46.2.18&nbsp;The authorize JSP Tag doesn&#8217;t respect my method security annotations when using the URL attribute.">Section&nbsp;46.2.18, &#8220;The authorize JSP Tag doesn&#8217;t respect my method security annotations when using the URL attribute.&#8221;</a>
</li></ol></div>
</li></ol></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-bad-credentials" href="index.html#appendix-faq-bad-credentials"></a>46.2.1&nbsp;When I try to log in, I get an error message that says "Bad Credentials". What&#8217;s wrong?</h3></div></div></div>
<p>This means that authentication has failed. It doesn&#8217;t say why, as it is good practice to avoid giving details which might help an attacker guess account names or passwords.</p>
<p>This also means that if you ask this question in the forum, you will not get an answer unless you provide additional information. As with any issue you should check the output from the debug log, note any exception stacktraces and related messages. Step through the code in a debugger to see where the authentication fails and why. Write a test case which exercises your authentication configuration outside of the application. More often than not, the failure is due to a difference in the password data stored in a database and that entered by the user. If you are using hashed passwords, make sure the value stored in your database is <span class="emphasis"><em>exactly</em></span> the same as the value produced by the <code class="literal">PasswordEncoder</code> configured in your application.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-login-loop" href="index.html#appendix-faq-login-loop"></a>46.2.2&nbsp;My application goes into an "endless loop" when I try to login, what&#8217;s going on?</h3></div></div></div>
<p>A common user problem with infinite loop and redirecting to the login page is caused by accidently configuring the login page as a "secured" resource. Make sure your configuration allows anonymous access to the login page, either by excluding it from the security filter chain or marking it as requiring ROLE_ANONYMOUS.</p>
<p>If your AccessDecisionManager includes an AuthenticatedVoter, you can use the attribute "IS_AUTHENTICATED_ANONYMOUSLY". This is automatically available if you are using the standard namespace configuration setup.</p>
<p>From Spring Security 2.0.1 onwards, when you are using namespace-based configuration, a check will be made on loading the application context and a warning message logged if your login page appears to be protected.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-anon-access-denied" href="index.html#appendix-faq-anon-access-denied"></a>46.2.3&nbsp;I get an exception with the message "Access is denied (user is anonymous);". What&#8217;s wrong?</h3></div></div></div>
<p>This is a debug level message which occurs the first time an anonymous user attempts to access a protected resource.</p>
<pre class="screen">DEBUG [ExceptionTranslationFilter] - Access is denied (user is anonymous); redirecting to authentication entry point
org.springframework.security.AccessDeniedException: Access is denied
at org.springframework.security.vote.AffirmativeBased.decide(AffirmativeBased.java:68)
at org.springframework.security.intercept.AbstractSecurityInterceptor.beforeInvocation(AbstractSecurityInterceptor.java:262)</pre>
<p>It is normal and shouldn&#8217;t be anything to worry about.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-cached-secure-page" href="index.html#appendix-faq-cached-secure-page"></a>46.2.4&nbsp;Why can I still see a secured page even after I&#8217;ve logged out of my application?</h3></div></div></div>
<p>The most common reason for this is that your browser has cached the page and you are seeing a copy which is being retrieved from the browsers cache. Verify this by checking whether the browser is actually sending the request (check your server access logs, the debug log or use a suitable browser debugging plugin such as "Tamper Data" for Firefox). This has nothing to do with Spring Security and you should configure your application or server to set the appropriate <code class="literal">Cache-Control</code> response headers. Note that SSL requests are never cached.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="auth-exception-credentials-not-found" href="index.html#auth-exception-credentials-not-found"></a>46.2.5&nbsp;I get an exception with the message "An Authentication object was not found in the SecurityContext". What&#8217;s wrong?</h3></div></div></div>
<p>This is a another debug level message which occurs the first time an anonymous user attempts to access a protected resource, but when you do not have an <code class="literal">AnonymousAuthenticationFilter</code> in your filter chain configuration.</p>
<pre class="screen">DEBUG [ExceptionTranslationFilter] - Authentication exception occurred; redirecting to authentication entry point
org.springframework.security.AuthenticationCredentialsNotFoundException:
							An Authentication object was not found in the SecurityContext
at org.springframework.security.intercept.AbstractSecurityInterceptor.credentialsNotFound(AbstractSecurityInterceptor.java:342)
at org.springframework.security.intercept.AbstractSecurityInterceptor.beforeInvocation(AbstractSecurityInterceptor.java:254)</pre>
<p>It is normal and shouldn&#8217;t be anything to worry about.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-ldap-authentication" href="index.html#appendix-faq-ldap-authentication"></a>46.2.6&nbsp;I can&#8217;t get LDAP authentication to work. What&#8217;s wrong with my configuration?</h3></div></div></div>
<p>Note that the permissions for an LDAP directory often do not allow you to read the password for a user. Hence it is often not possible to use the <a class="xref" href="index.html#appendix-faq-what-is-userdetailservice" title="46.3.6&nbsp;What is a UserDetailsService and do I need one?">Section&nbsp;46.3.6, &#8220;What is a UserDetailsService and do I need one?&#8221;</a> where Spring Security compares the stored password with the one submitted by the user. The most common approach is to use LDAP "bind", which is one of the operations supported by <a class="ulink" href="https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol" target="_top">the LDAP protocol</a>. With this approach, Spring Security validates the password by attempting to authenticate to the directory as the user.</p>
<p>The most common problem with LDAP authentication is a lack of knowledge of the directory server tree structure and configuration. This will be different in different companies, so you have to find it out yourself. Before adding a Spring Security LDAP configuration to an application, it&#8217;s a good idea to write a simple test using standard Java LDAP code (without Spring Security involved), and make sure you can get that to work first. For example, to authenticate a user, you could use the following code:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> ldapAuthenticationIsSuccessful() <span class="hl-keyword">throws</span> Exception {
		Hashtable&lt;String,String&gt; env = <span class="hl-keyword">new</span> Hashtable&lt;String,String&gt;();
		env.put(Context.SECURITY_AUTHENTICATION, <span class="hl-string">"simple"</span>);
		env.put(Context.SECURITY_PRINCIPAL, <span class="hl-string">"cn=joe,ou=users,dc=mycompany,dc=com"</span>);
		env.put(Context.PROVIDER_URL, <span class="hl-string">"ldap://mycompany.com:389/dc=mycompany,dc=com"</span>);
		env.put(Context.SECURITY_CREDENTIALS, <span class="hl-string">"joespassword"</span>);
		env.put(Context.INITIAL_CONTEXT_FACTORY, <span class="hl-string">"com.sun.jndi.ldap.LdapCtxFactory"</span>);

		InitialLdapContext ctx = <span class="hl-keyword">new</span> InitialLdapContext(env, null);

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="session-management" href="index.html#session-management"></a>46.2.7&nbsp;Session Management</h3></div></div></div>
<p>Session management issues are a common source of forum questions. If you are developing Java web applications, you should understand how the session is maintained between the servlet container and the user&#8217;s browser. You should also understand the difference between secure and non-secure cookies and the implications of using HTTP/HTTPS and switching between the two. Spring Security has nothing to do with maintaining the session or providing session identifiers. This is entirely handled by the servlet container.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-concurrent-session-same-browser" href="index.html#appendix-faq-concurrent-session-same-browser"></a>46.2.8&nbsp;I&#8217;m using Spring Security&#8217;s concurrent session control to prevent users from logging in more than once at a time. When I open another browser window after logging in, it doesn&#8217;t stop me from logging in again. Why can I log in more than once?</h3></div></div></div>
<p>Browsers generally maintain a single session per browser instance. You cannot have two separate sessions at once. So if you log in again in another window or tab you are just reauthenticating in the same session. The server doesn&#8217;t know anything about tabs, windows or browser instances. All it sees are HTTP requests and it ties those to a particular session according to the value of the JSESSIONID cookie that they contain. When a user authenticates during a session, Spring Security&#8217;s concurrent session control checks the number of<span class="emphasis"><em>other authenticated sessions</em></span> that they have. If they are already authenticated with the same session, then re-authenticating will have no effect.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-new-session-on-authentication" href="index.html#appendix-faq-new-session-on-authentication"></a>46.2.9&nbsp;Why does the session Id change when I authenticate through Spring Security?</h3></div></div></div>
<p>With the default configuration, Spring Security changes the session ID when the user authenticates. If you&#8217;re using a Servlet 3.1 or newer container, the session ID is simply changed. If you&#8217;re using an older container, Spring Security invalidates the existing session, creates a new session, and transfers the session data to the new session. Changing the session identifier in this manner prevents"session-fixation" attacks. You can find more about this online and in the reference manual.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-tomcat-https-session" href="index.html#appendix-faq-tomcat-https-session"></a>46.2.10&nbsp;I&#8217;m using Tomcat (or some other servlet container) and have enabled HTTPS for my login page, switching back to HTTP afterwards. It doesn&#8217;t work - I just end up back at the login page after authenticating.</h3></div></div></div>
<p>This happens because sessions created under HTTPS, for which the session cookie is marked as "secure", cannot subsequently be used under HTTP. The browser will not send the cookie back to the server and any session state will be lost (including the security context information). Starting a session in HTTP first should work as the session cookie won&#8217;t be marked as secure. However, Spring Security&#8217;s <a class="ulink" href="http://static.springsource.org/spring-security/site/docs/3.1.x/reference/springsecurity-single.html#ns-session-fixation" target="_top">Session Fixation Protection</a> can interfere with this because it results in a new session ID cookie being sent back to the user&#8217;s browser, usually with the secure flag. To get around this, you can disable session fixation protection, but in newer Servlet containers you can also configure session cookies to never use the secure flag. Note that switching between HTTP and HTTPS is not a good idea in general, as any application which uses HTTP at all is vulnerable to man-in-the-middle attacks. To be truly secure, the user should begin accessing your site in HTTPS and continue using it until they log out. Even clicking on an HTTPS link from a page accessed over HTTP is potentially risky. If you need more convincing, check out a tool like <a class="ulink" href="http://www.thoughtcrime.org/software/sslstrip/" target="_top">sslstrip</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="i-m-not-switching-between-http-and-https-but-my-session-is-still-getting-lost" href="index.html#i-m-not-switching-between-http-and-https-but-my-session-is-still-getting-lost"></a>46.2.11&nbsp;I&#8217;m not switching between HTTP and HTTPS but my session is still getting lost</h3></div></div></div>
<p>Sessions are maintained either by exchanging a session cookie or by adding a <code class="literal">jsessionid</code> parameter to URLs (this happens automatically if you are using JSTL to output URLs, or if you call <code class="literal">HttpServletResponse.encodeUrl</code> on URLs (before a redirect, for example). If clients have cookies disabled, and you are not rewriting URLs to include the <code class="literal">jsessionid</code>, then the session will be lost. Note that the use of cookies is preferred for security reasons, as it does not expose the session information in the URL.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-session-listener-missing" href="index.html#appendix-faq-session-listener-missing"></a>46.2.12&nbsp;I&#8217;m trying to use the concurrent session-control support but it won&#8217;t let me log back in, even if I&#8217;m sure I&#8217;ve logged out and haven&#8217;t exceeded the allowed sessions.</h3></div></div></div>
<p>Make sure you have added the listener to your web.xml file. It is essential to make sure that the Spring Security session registry is notified when a session is destroyed. Without it, the session information will not be removed from the registry.</p>
<pre class="programlisting"><span class="hl-tag">&lt;listener&gt;</span>
		<span class="hl-tag">&lt;listener-class&gt;</span>org.springframework.security.web.session.HttpSessionEventPublisher<span class="hl-tag">&lt;/listener-class&gt;</span>
<span class="hl-tag">&lt;/listener&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-unwanted-session-creation" href="index.html#appendix-faq-unwanted-session-creation"></a>46.2.13&nbsp;Spring Security is creating a session somewhere, even though I&#8217;ve configured it not to, by setting the create-session attribute to never.</h3></div></div></div>
<p>This usually means that the user&#8217;s application is creating a session somewhere, but that they aren&#8217;t aware of it. The most common culprit is a JSP. Many people aren&#8217;t aware that JSPs create sessions by default. To prevent a JSP from creating a session, add the directive <code class="literal">&lt;%@ page session="false" %&gt;</code> to the top of the page.</p>
<p>If you are having trouble working out where a session is being created, you can add some debugging code to track down the location(s). One way to do this would be to add a <code class="literal">javax.servlet.http.HttpSessionListener</code> to your application, which calls <code class="literal">Thread.dumpStack()</code> in the <code class="literal">sessionCreated</code> method.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-forbidden-csrf" href="index.html#appendix-faq-forbidden-csrf"></a>46.2.14&nbsp;I get a 403 Forbidden when performing a POST</h3></div></div></div>
<p>If an HTTP 403 Forbidden is returned for HTTP POST, but works for HTTP GET then the issue is most likely related to <a class="ulink" href="https://docs.spring.io/spring-security/site/docs/3.2.x/reference/htmlsingle/#csrf" target="_top">CSRF</a>. Either provide the CSRF Token or disable CSRF protection (not recommended).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-no-security-on-forward" href="index.html#appendix-faq-no-security-on-forward"></a>46.2.15&nbsp;I&#8217;m forwarding a request to another URL using the RequestDispatcher, but my security constraints aren&#8217;t being applied.</h3></div></div></div>
<p>Filters are not applied by default to forwards or includes. If you really want the security filters to be applied to forwards and/or includes, then you have to configure these explicitly in your web.xml using the &lt;dispatcher&gt; element, a child element of &lt;filter-mapping&gt;.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-method-security-in-web-context" href="index.html#appendix-faq-method-security-in-web-context"></a>46.2.16&nbsp;I have added Spring Security&#8217;s &lt;global-method-security&gt; element to my application context but if I add security annotations to my Spring MVC controller beans (Struts actions etc.) then they don&#8217;t seem to have an effect.</h3></div></div></div>
<p>In a Spring web application, the application context which holds the Spring MVC beans for the dispatcher servlet is often separate from the main application context. It is often defined in a file called <code class="literal">myapp-servlet.xml</code>, where "myapp" is the name assigned to the Spring <code class="literal">DispatcherServlet</code> in <code class="literal">web.xml</code>. An application can have multiple <code class="literal">DispatcherServlet</code>s, each with its own isolated application context. The beans in these "child" contexts are not visible to the rest of the application. The"parent" application context is loaded by the <code class="literal">ContextLoaderListener</code> you define in your <code class="literal">web.xml</code> and is visible to all the child contexts. This parent context is usually where you define your security configuration, including the <code class="literal">&lt;global-method-security&gt;</code> element). As a result any security constraints applied to methods in these web beans will not be enforced, since the beans cannot be seen from the <code class="literal">DispatcherServlet</code> context. You need to either move the <code class="literal">&lt;global-method-security&gt;</code> declaration to the web context or moved the beans you want secured into the main application context.</p>
<p>Generally we would recommend applying method security at the service layer rather than on individual web controllers.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-no-filters-no-context" href="index.html#appendix-faq-no-filters-no-context"></a>46.2.17&nbsp;I have a user who has definitely been authenticated, but when I try to access the SecurityContextHolder during some requests, the Authentication is null. Why can&#8217;t I see the user information?</h3></div></div></div>
<p>If you have excluded the request from the security filter chain using the attribute <code class="literal">filters='none'</code> in the <code class="literal">&lt;intercept-url&gt;</code> element that matches the URL pattern, then the <code class="literal">SecurityContextHolder</code> will not be populated for that request. Check the debug log to see whether the request is passing through the filter chain. (You are reading the debug log, right?).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-method-security-with-taglib" href="index.html#appendix-faq-method-security-with-taglib"></a>46.2.18&nbsp;The authorize JSP Tag doesn&#8217;t respect my method security annotations when using the URL attribute.</h3></div></div></div>
<p>Method security will not hide links when using the <code class="literal">url</code> attribute in <code class="literal">&lt;sec:authorize&gt;</code> because we cannot readily reverse engineer what URL is mapped to what controller endpoint as controllers can rely on headers, current user, etc to determine what method to invoke.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="appendix-faq-architecture" href="index.html#appendix-faq-architecture"></a>46.3&nbsp;Spring Security Architecture Questions</h2></div></div></div>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<a class="xref" href="index.html#appendix-faq-where-is-class-x" title="46.3.1&nbsp;How do I know which package class X is in?">Section&nbsp;46.3.1, &#8220;How do I know which package class X is in?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-namespace-to-bean-mapping" title="46.3.2&nbsp;How do the namespace elements map to conventional bean configurations?">Section&nbsp;46.3.2, &#8220;How do the namespace elements map to conventional bean configurations?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-role-prefix" title="46.3.3&nbsp;What does &#34;ROLE_&#34; mean and why do I need it on my role names?">Section&nbsp;46.3.3, &#8220;What does "ROLE_" mean and why do I need it on my role names?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-what-dependencies" title="46.3.4&nbsp;How do I know which dependencies to add to my application to work with Spring Security?">Section&nbsp;46.3.4, &#8220;How do I know which dependencies to add to my application to work with Spring Security?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-apacheds-deps" title="46.3.5&nbsp;What dependencies are needed to run an embedded ApacheDS LDAP server?">Section&nbsp;46.3.5, &#8220;What dependencies are needed to run an embedded ApacheDS LDAP server?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-what-is-userdetailservice" title="46.3.6&nbsp;What is a UserDetailsService and do I need one?">Section&nbsp;46.3.6, &#8220;What is a UserDetailsService and do I need one?&#8221;</a>
</li></ol></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-where-is-class-x" href="index.html#appendix-faq-where-is-class-x"></a>46.3.1&nbsp;How do I know which package class X is in?</h3></div></div></div>
<p>The best way of locating classes is by installing the Spring Security source in your IDE. The distribution includes source jars for each of the modules the project is divided up into. Add these to your project source path and you can navigate directly to Spring Security classes (<code class="literal">Ctrl-Shift-T</code> in Eclipse). This also makes debugging easier and allows you to troubleshoot exceptions by looking directly at the code where they occur to see what&#8217;s going on there.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-namespace-to-bean-mapping" href="index.html#appendix-faq-namespace-to-bean-mapping"></a>46.3.2&nbsp;How do the namespace elements map to conventional bean configurations?</h3></div></div></div>
<p>There is a general overview of what beans are created by the namespace in the namespace appendix of the reference guide. There is also a detailed blog article called "Behind the Spring Security Namespace" on <a class="ulink" href="http://blog.springsource.com/2010/03/06/behind-the-spring-security-namespace/" target="_top">blog.springsource.com</a>. If want to know the full details then the code is in the <code class="literal">spring-security-config</code> module within the Spring Security 3.0 distribution. You should probably read the chapters on namespace parsing in the standard Spring Framework reference documentation first.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-role-prefix" href="index.html#appendix-faq-role-prefix"></a>46.3.3&nbsp;What does "ROLE_" mean and why do I need it on my role names?</h3></div></div></div>
<p>Spring Security has a voter-based architecture which means that an access decision is made by a series of <code class="literal">AccessDecisionVoter</code>s. The voters act on the "configuration attributes" which are specified for a secured resource (such as a method invocation). With this approach, not all attributes may be relevant to all voters and a voter needs to know when it should ignore an attribute (abstain) and when it should vote to grant or deny access based on the attribute value. The most common voter is the <code class="literal">RoleVoter</code> which by default votes whenever it finds an attribute with the "ROLE_" prefix. It makes a simple comparison of the attribute (such as "ROLE_USER") with the names of the authorities which the current user has been assigned. If it finds a match (they have an authority called "ROLE_USER"), it votes to grant access, otherwise it votes to deny access.</p>
<p>The prefix can be changed by setting the <code class="literal">rolePrefix</code> property of <code class="literal">RoleVoter</code>. If you only need to use roles in your application and have no need for other custom voters, then you can set the prefix to a blank string, in which case the <code class="literal">RoleVoter</code> will treat all attributes as roles.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-what-dependencies" href="index.html#appendix-faq-what-dependencies"></a>46.3.4&nbsp;How do I know which dependencies to add to my application to work with Spring Security?</h3></div></div></div>
<p>It will depend on what features you are using and what type of application you are developing. With Spring Security 3.0, the project jars are divided into clearly distinct areas of functionality, so it is straightforward to work out which Spring Security jars you need from your application requirements. All applications will need the <code class="literal">spring-security-core</code> jar. If you&#8217;re developing a web application, you need the <code class="literal">spring-security-web</code> jar. If you&#8217;re using security namespace configuration you need the <code class="literal">spring-security-config</code> jar, for LDAP support you need the <code class="literal">spring-security-ldap</code> jar and so on.</p>
<p>For third-party jars the situation isn&#8217;t always quite so obvious. A good starting point is to copy those from one of the pre-built sample applications WEB-INF/lib directories. For a basic application, you can start with the tutorial sample. If you want to use LDAP, with an embedded test server, then use the LDAP sample as a starting point. The reference manual also includeshttp://static.springsource.org/spring-security/site/docs/3.1.x/reference/springsecurity-single.html#appendix-dependencies[an appendix] listing the first-level dependencies for each Spring Security module with some information on whether they are optional and what they are required for.</p>
<p>If you are building your project with maven, then adding the appropriate Spring Security modules as dependencies to your pom.xml will automatically pull in the core jars that the framework requires. Any which are marked as "optional" in the Spring Security POM files will have to be added to your own pom.xml file if you need them.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-apacheds-deps" href="index.html#appendix-faq-apacheds-deps"></a>46.3.5&nbsp;What dependencies are needed to run an embedded ApacheDS LDAP server?</h3></div></div></div>
<p>If you are using Maven, you need to add the folowing to your pom dependencies:</p>
<pre class="screen">&lt;dependency&gt;
		&lt;groupId&gt;org.apache.directory.server&lt;/groupId&gt;
		&lt;artifactId&gt;apacheds-core&lt;/artifactId&gt;
		&lt;version&gt;1.5.5&lt;/version&gt;
		&lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
		&lt;groupId&gt;org.apache.directory.server&lt;/groupId&gt;
		&lt;artifactId&gt;apacheds-server-jndi&lt;/artifactId&gt;
		&lt;version&gt;1.5.5&lt;/version&gt;
		&lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;</pre>
<p>The other required jars should be pulled in transitively.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-what-is-userdetailservice" href="index.html#appendix-faq-what-is-userdetailservice"></a>46.3.6&nbsp;What is a UserDetailsService and do I need one?</h3></div></div></div>
<p><code class="literal">UserDetailsService</code> is a DAO interface for loading data that is specific to a user account. It has no other function other to load that data for use by other components within the framework. It is not responsible for authenticating the user. Authenticating a user with a username/password combination is most commonly performed by the <code class="literal">DaoAuthenticationProvider</code>, which is injected with a <code class="literal">UserDetailsService</code> to allow it to load the password (and other data) for a user in order to compare it with the submitted value. Note that if you are using LDAP, <a class="link" href="index.html#appendix-faq-ldap-authentication" title="46.2.6&nbsp;I can&#8217;t get LDAP authentication to work. What&#8217;s wrong with my configuration?">this approach may not work</a>.</p>
<p>If you want to customize the authentication process then you should implement <code class="literal">AuthenticationProvider</code> yourself. See this <a class="ulink" href="http://blog.springsource.com/2010/08/02/spring-security-in-google-app-engine/" target="_top"> blog article</a> for an example integrating Spring Security authentication with Google App Engine.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="appendix-faq-howto" href="index.html#appendix-faq-howto"></a>46.4&nbsp;Common "Howto" Requests</h2></div></div></div>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<a class="xref" href="index.html#appendix-faq-extra-login-fields" title="46.4.1&nbsp;I need to login in with more information than just the username. How do I add support for extra login fields (e.g. a company name)?">Section&nbsp;46.4.1, &#8220;I need to login in with more information than just the username. How do I add support for extra login fields (e.g. a company name)?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-matching-url-fragments" title="46.4.2&nbsp;How do I apply different intercept-url constraints where only the fragment value of the requested URLs differs (e.g./foo#bar and /foo#blah?">Section&nbsp;46.4.2, &#8220;How do I apply different intercept-url constraints where only the fragment value of the requested URLs differs (e.g./foo#bar and /foo#blah?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-request-details-in-user-service" title="46.4.3&nbsp;How do I access the user&#8217;s IP Address (or other web-request data) in a UserDetailsService?">Section&nbsp;46.4.3, &#8220;How do I access the user&#8217;s IP Address (or other web-request data) in a UserDetailsService?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-access-session-from-user-service" title="46.4.4&nbsp;How do I access the HttpSession from a UserDetailsService?">Section&nbsp;46.4.4, &#8220;How do I access the HttpSession from a UserDetailsService?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-password-in-user-service" title="46.4.5&nbsp;How do I access the user&#8217;s password in a UserDetailsService?">Section&nbsp;46.4.5, &#8220;How do I access the user&#8217;s password in a UserDetailsService?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-dynamic-url-metadata" title="46.4.6&nbsp;How do I define the secured URLs within an application dynamically?">Section&nbsp;46.4.6, &#8220;How do I define the secured URLs within an application dynamically?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-ldap-authorities" title="46.4.7&nbsp;How do I authenticate against LDAP but load user roles from a database?">Section&nbsp;46.4.7, &#8220;How do I authenticate against LDAP but load user roles from a database?&#8221;</a>
</li><li class="listitem">
<a class="xref" href="index.html#appendix-faq-namespace-post-processor" title="46.4.8&nbsp;I want to modify the property of a bean that is created by the namespace, but there is nothing in the schema to support it. What can I do short of abandoning namespace use?">Section&nbsp;46.4.8, &#8220;I want to modify the property of a bean that is created by the namespace, but there is nothing in the schema to support it. What can I do short of abandoning namespace use?&#8221;</a>
</li></ol></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-extra-login-fields" href="index.html#appendix-faq-extra-login-fields"></a>46.4.1&nbsp;I need to login in with more information than just the username. How do I add support for extra login fields (e.g. a company name)?</h3></div></div></div>
<p>This question comes up repeatedly in the Spring Security forum so you will find more information there by searching the archives (or through google).</p>
<p>The submitted login information is processed by an instance of <code class="literal">UsernamePasswordAuthenticationFilter</code>. You will need to customize this class to handle the extra data field(s). One option is to use your own customized authentication token class (rather than the standard <code class="literal">UsernamePasswordAuthenticationToken</code>), another is simply to concatenate the extra fields with the username (for example, using a ":" as the separator) and pass them in the username property of <code class="literal">UsernamePasswordAuthenticationToken</code>.</p>
<p>You will also need to customize the actual authentication process. If you are using a custom authentication token class, for example, you will have to write an <code class="literal">AuthenticationProvider</code> to handle it (or extend the standard <code class="literal">DaoAuthenticationProvider</code>). If you have concatenated the fields, you can implement your own <code class="literal">UserDetailsService</code> which splits them up and loads the appropriate user data for authentication.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-matching-url-fragments" href="index.html#appendix-faq-matching-url-fragments"></a>46.4.2&nbsp;How do I apply different intercept-url constraints where only the fragment value of the requested URLs differs (e.g./foo#bar and /foo#blah?</h3></div></div></div>
<p>You can&#8217;t do this, since the fragment is not transmitted from the browser to the server. The URLs above are identical from the server&#8217;s perspective. This is a common question from GWT users.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-request-details-in-user-service" href="index.html#appendix-faq-request-details-in-user-service"></a>46.4.3&nbsp;How do I access the user&#8217;s IP Address (or other web-request data) in a UserDetailsService?</h3></div></div></div>
<p>Obviously you can&#8217;t (without resorting to something like thread-local variables) since the only information supplied to the interface is the username. Instead of implementing <code class="literal">UserDetailsService</code>, you should implement <code class="literal">AuthenticationProvider</code> directly and extract the information from the supplied <code class="literal">Authentication</code> token.</p>
<p>In a standard web setup, the <code class="literal">getDetails()</code> method on the <code class="literal">Authentication</code> object will return an instance of <code class="literal">WebAuthenticationDetails</code>. If you need additional information, you can inject a custom <code class="literal">AuthenticationDetailsSource</code> into the authentication filter you are using. If you are using the namespace, for example with the <code class="literal">&lt;form-login&gt;</code> element, then you should remove this element and replace it with a <code class="literal">&lt;custom-filter&gt;</code> declaration pointing to an explicitly configured <code class="literal">UsernamePasswordAuthenticationFilter</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-access-session-from-user-service" href="index.html#appendix-faq-access-session-from-user-service"></a>46.4.4&nbsp;How do I access the HttpSession from a UserDetailsService?</h3></div></div></div>
<p>You can&#8217;t, since the <code class="literal">UserDetailsService</code> has no awareness of the servlet API. If you want to store custom user data, then you should customize the <code class="literal">UserDetails</code> object which is returned. This can then be accessed at any point, via the thread-local <code class="literal">SecurityContextHolder</code>. A call to <code class="literal">SecurityContextHolder.getContext().getAuthentication().getPrincipal()</code> will return this custom object.</p>
<p>If you really need to access the session, then it must be done by customizing the web tier.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-password-in-user-service" href="index.html#appendix-faq-password-in-user-service"></a>46.4.5&nbsp;How do I access the user&#8217;s password in a UserDetailsService?</h3></div></div></div>
<p>You can&#8217;t (and shouldn&#8217;t). You are probably misunderstanding its purpose. See "<a class="link" href="index.html#appendix-faq-what-is-userdetailservice" title="46.3.6&nbsp;What is a UserDetailsService and do I need one?">What is a UserDetailsService?</a>" above.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-dynamic-url-metadata" href="index.html#appendix-faq-dynamic-url-metadata"></a>46.4.6&nbsp;How do I define the secured URLs within an application dynamically?</h3></div></div></div>
<p>People often ask about how to store the mapping between secured URLs and security metadata attributes in a database, rather than in the application context.</p>
<p>The first thing you should ask yourself is if you really need to do this. If an application requires securing, then it also requires that the security be tested thoroughly based on a defined policy. It may require auditing and acceptance testing before being rolled out into a production environment. A security-conscious organization should be aware that the benefits of their diligent testing process could be wiped out instantly by allowing the security settings to be modified at runtime by changing a row or two in a configuration database. If you have taken this into account (perhaps using multiple layers of security within your application) then Spring Security allows you to fully customize the source of security metadata. You can make it fully dynamic if you choose.</p>
<p>Both method and web security are protected by subclasses of <code class="literal">AbstractSecurityInterceptor</code> which is configured with a <code class="literal">SecurityMetadataSource</code> from which it obtains the metadata for a particular method or filter invocation. For web security, the interceptor class is <code class="literal">FilterSecurityInterceptor</code> and it uses the marker interface <code class="literal">FilterInvocationSecurityMetadataSource</code>. The "secured object" type it operates on is a <code class="literal">FilterInvocation</code>. The default implementation which is used (both in the namespace <code class="literal">&lt;http&gt;</code> and when configuring the interceptor explicitly, stores the list of URL patterns and their corresponding list of "configuration attributes" (instances of <code class="literal">ConfigAttribute</code>) in an in-memory map.</p>
<p>To load the data from an alternative source, you must be using an explicitly declared security filter chain (typically Spring Security&#8217;s <code class="literal">FilterChainProxy</code>) in order to customize the <code class="literal">FilterSecurityInterceptor</code> bean. You can&#8217;t use the namespace. You would then implement <code class="literal">FilterInvocationSecurityMetadataSource</code> to load the data as you please for a particular <code class="literal">FilterInvocation</code> <a href="index.html#ftn.d5e9686" class="footnote" name="d5e9686"><sup class="footnote">[25]</sup></a>. A very basic outline would look something like this:</p>
<pre class="programlisting">	<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyFilterSecurityMetadataSource <span class="hl-keyword">implements</span> FilterInvocationSecurityMetadataSource {

		<span class="hl-keyword">public</span> List&lt;ConfigAttribute&gt; getAttributes(Object object) {
			FilterInvocation fi = (FilterInvocation) object;
				String url = fi.getRequestUrl();
				String httpMethod = fi.getRequest().getMethod();
				List&lt;ConfigAttribute&gt; attributes = <span class="hl-keyword">new</span> ArrayList&lt;ConfigAttribute&gt;();

				<span class="hl-comment">// Lookup your database (or other source) using this information and populate the</span>
				<span class="hl-comment">// list of attributes</span>

				<span class="hl-keyword">return</span> attributes;
		}

		<span class="hl-keyword">public</span> Collection&lt;ConfigAttribute&gt; getAllConfigAttributes() {
			<span class="hl-keyword">return</span> null;
		}

		<span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> supports(Class&lt;?&gt; clazz) {
			<span class="hl-keyword">return</span> FilterInvocation.<span class="hl-keyword">class</span>.isAssignableFrom(clazz);
		}
	}</pre>
<p>For more information, look at the code for <code class="literal">DefaultFilterInvocationSecurityMetadataSource</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-ldap-authorities" href="index.html#appendix-faq-ldap-authorities"></a>46.4.7&nbsp;How do I authenticate against LDAP but load user roles from a database?</h3></div></div></div>
<p>The <code class="literal">LdapAuthenticationProvider</code> bean (which handles normal LDAP authentication in Spring Security) is configured with two separate strategy interfaces, one which performs the authentication and one which loads the user authorities, called <code class="literal">LdapAuthenticator</code> and <code class="literal">LdapAuthoritiesPopulator</code> respectively. The <code class="literal">DefaultLdapAuthoritiesPopulator</code> loads the user authorities from the LDAP directory and has various configuration parameters to allow you to specify how these should be retrieved.</p>
<p>To use JDBC instead, you can implement the interface yourself, using whatever SQL is appropriate for your schema:</p>
<pre class="programlisting">	<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyAuthoritiesPopulator <span class="hl-keyword">implements</span> LdapAuthoritiesPopulator {
		<em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
		JdbcTemplate template;

		List&lt;GrantedAuthority&gt; getGrantedAuthorities(DirContextOperations userData, String username) {
			List&lt;GrantedAuthority&gt; = template.query(<span class="hl-string">"select role from roles where username = ?"</span>,
																									<span class="hl-keyword">new</span> String[] {username},
																									<span class="hl-keyword">new</span> RowMapper&lt;GrantedAuthority&gt;() {
				<strong class="hl-tag" style="color: blue">/**
				 *  We're assuming here that you're using the standard convention of using the role
				 *  prefix "ROLE_" to mark attributes which are supported by Spring Security's RoleVoter.
				 */</strong>
				<span class="hl-keyword">public</span> GrantedAuthority mapRow(ResultSet rs, <span class="hl-keyword">int</span> rowNum) <span class="hl-keyword">throws</span> SQLException {
					<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SimpleGrantedAuthority(<span class="hl-string">"ROLE_"</span> + rs.getString(<span class="hl-number">1</span>);
				}
			}
		}
	}</pre>
<p>You would then add a bean of this type to your application context and inject it into the <code class="literal">LdapAuthenticationProvider</code>. This is covered in the section on configuring LDAP using explicit Spring beans in the LDAP chapter of the reference manual. Note that you can&#8217;t use the namespace for configuration in this case. You should also consult the Javadoc for the relevant classes and interfaces.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="appendix-faq-namespace-post-processor" href="index.html#appendix-faq-namespace-post-processor"></a>46.4.8&nbsp;I want to modify the property of a bean that is created by the namespace, but there is nothing in the schema to support it. What can I do short of abandoning namespace use?</h3></div></div></div>
<p>The namespace functionality is intentionally limited, so it doesn&#8217;t cover everything that you can do with plain beans. If you want to do something simple, like modify a bean, or inject a different dependency, you can do this by adding a <code class="literal">BeanPostProcessor</code> to your configuration. More information can be found in the <a class="ulink" href="http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/htmlsingle/spring-framework-reference.html#beans-factory-extension-bpp" target="_top">Spring Reference Manual</a>. In order to do this, you need to know a bit about which beans are created, so you should also read the blog article in the above question on <a class="link" href="index.html#appendix-faq-namespace-to-bean-mapping" title="46.3.2&nbsp;How do the namespace elements map to conventional bean configurations?">how the namespace maps to Spring beans</a>.</p>
<p>Normally, you would add the functionality you require to the <code class="literal">postProcessBeforeInitialization</code> method of <code class="literal">BeanPostProcessor</code>. Let&#8217;s say that you want to customize the <code class="literal">AuthenticationDetailsSource</code> used by the <code class="literal">UsernamePasswordAuthenticationFilter</code>, (created by the <code class="literal">form-login</code> element). You want to extract a particular header called <code class="literal">CUSTOM_HEADER</code> from the request and make use of it while authenticating the user. The processor class would look like this:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BeanPostProcessor <span class="hl-keyword">implements</span> BeanPostProcessor {

		<span class="hl-keyword">public</span> Object postProcessAfterInitialization(Object bean, String name) {
				<span class="hl-keyword">if</span> (bean <span class="hl-keyword">instanceof</span> UsernamePasswordAuthenticationFilter) {
						System.out.println(<span class="hl-string">"********* Post-processing "</span> + name);
						((UsernamePasswordAuthenticationFilter)bean).setAuthenticationDetailsSource(
										<span class="hl-keyword">new</span> AuthenticationDetailsSource() {
												<span class="hl-keyword">public</span> Object buildDetails(Object context) {
														<span class="hl-keyword">return</span> ((HttpServletRequest)context).getHeader(<span class="hl-string">"CUSTOM_HEADER"</span>);
												}
										});
				}
				<span class="hl-keyword">return</span> bean;
		}

		<span class="hl-keyword">public</span> Object postProcessBeforeInitialization(Object bean, String name) {
				<span class="hl-keyword">return</span> bean;
		}
}</pre>
<p>You would then register this bean in your application context. Spring will automatically invoke it on the beans defined in the application context.</p>
</div>
</div>
<div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.d5e9686" class="footnote"><p><a href="index.html#d5e9686" class="simpara"><sup class="simpara">[25] </sup></a>The <code class="literal">FilterInvocation</code> object contains the <code class="literal">HttpServletRequest</code>, so you can obtain the URL or any other relevant information on which to base your decision on what the list of returned attributes will contain.</p></div></div></div>
</div>
</div><script data-cfasync="false" src="../../../../../../cdn-cgi/scripts/d07b1474/cloudflare-static/email-decode.min.js"></script><script>if(window.parent==window){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-2728886-23','auto',{'siteSpeedSampleRate':100});ga('send','pageview');}</script></body></html>