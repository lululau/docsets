<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
  <link href='../../../fonts.googleapis.com/css%3Ffamily=Inconsolata.css' rel='stylesheet' type='text/css'>
    <title>Queries</title><link rel="shortcut icon" href="../../../media.mongodb.org/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="robots" content="index" />

  <meta name="release" content="3.0"/>
  <meta name="version" content="3.0"/>
  <meta name="DC.Source" content="https://github.com/mongodb/docs-ecosystem/blob/master/source/tutorial/mongoid-queries.txt"/>
  
   <link rel="stylesheet" href="../_static/mongodb-docs.css" type="text/css" />
   <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
     URL_ROOT:    '../../',
     VERSION:     '3.0',
     COLLAPSE_INDEX: false,
     FILE_SUFFIX: '',
     HAS_SOURCE:  false,
    };
  </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/lib/bootstrap.js"></script>
    <script type="text/javascript" src="../_static/lib/jquery.cookie.js"></script>
    <script type="text/javascript" src="../_static/navbar.js"></script>

  <script defer type="text/javascript" src="../_static/feedback.js"></script>
      <link rel="search" type="application/opensearchdescription+xml" href="https://docs.mongodb.com/osd.xml" title="MongoDB Help"/>
<link rel="top" title="MongoDB Ecosystem" href="https://docs.mongodb.com/ecosystem/" />
<link rel="up" title="Mongoid Documentation (5.1.0)" href="https://docs.mongodb.com/ecosystem/tutorial/ruby-mongoid-tutorial/" />
<link rel="next" title="Relations" href="mongoid-relations.html" />
<link rel="prev" title="Persistence Methods" href="mongoid-persistence.html" />
      <script type="text/javascript">
        (function() {
           var cx = '017213726194841070573:WMX6838984';
           var gcse = document.createElement('script'); gcse.type = 'text/javascript'; gcse.async = true;
           gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//www.google.com/cse/cse.js?cx=' + cx;
           gcse.onload = gcse.onreadystatechange = function() {
            $(function() {
              // hack to set a placeholder in google's custom search input
              var pollInput = window.setInterval(function() {
                var $input = $('.gsc-input input.gsc-input'),
                    $div = $('.search-db');

                if ($input.length) {
                  $input.on('focus', function(e) { $div.addClass('wide').removeClass('narrow'); });
                  $input.on('blur', function(e) {
                    if (!$input.val().length) { $div.addClass('narrow').removeClass('wide'); }
                  });
                  $input.attr('placeholder', "Search mongodb.com");
                  window.clearInterval(pollInput);
                }
              }, 10);
            });
           };
           var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(gcse, s);
           })();
      </script><script type='text/javascript'>
   var gptadslots=[];
   var googletag = googletag || {};
   googletag.cmd = googletag.cmd || [];
   (function(){ var gads = document.createElement('script');
      gads.async = true; gads.type = 'text/javascript';
      var useSSL = 'https:' == document.location.protocol;
      gads.src = (useSSL ? 'https:' : 'http:') + '//www.googletagservices.com/tag/js/gpt.js';
      var node = document.getElementsByTagName('script')[0];
      node.parentNode.insertBefore(gads, node);
   })();
</script>

<script type="text/javascript">
   googletag.cmd.push(function() {

      //Adslot 1 declaration
      gptadslots[1]= googletag.defineSlot('/40039723/docs.mongodb.org/ecosystem', [[160,600],[243,202],[293,244]],'mongodb-docs-eco-1').addService(googletag.pubads());

      googletag.pubads().enableSingleRequest();
      googletag.pubads().enableAsyncRendering();
      googletag.enableServices();
   });
</script></head>
<body data-project="mongodb-ecosystem">
  
    <script
    async
    id='mongodb-nav-data'
    data-props='{"environment":"docs","isOpaque":true,
                 "includeSearch":true,
                 "searchUrl":"https://docs.mongodb.com/manual/search/?query=",
                 "contactUrl":"https://www.mongodb.com/contact?jmp=docs"}'
    data-container='#header-db'
    src="../_static/header.js"></script>
  
  <!-- Google Tag Manager -->
  <noscript><iframe src="../../../www.googletagmanager.com/ns.html%3Fid=GTM-JQHP.html"
                    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push(
     {'gtm.start': new Date().getTime(),event:'gtm.js'}
   );var f=d.getElementsByTagName(s)[0],
   j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
   '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
   })(window,document,'script','dataLayer','GTM-JQHP');</script>
  <div class="content">
    <div class="main-column pull-left">

      
        <div class="document">
            <div class="documentwrapper"><div class="bodywrapper">
              <div class="body" data-pagename="tutorial/mongoid-queries">
                   <a class="edit-link" href="https://github.com/mongodb/docs-ecosystem/blob/master/source/tutorial/mongoid-queries.txt" target="_blank" title="Edit tutorial/mongoid-queries.txt on GitHub">
    
      <span class="icon-edit"></span>
    
  </a>
                  <div class="section" id="queries">
<h1>Queries<a class="headerlink" href="mongoid-queries.html#queries" title="Permalink to this headline">¶</a></h1>
<div class="contents singlecol local topic" id="on-this-page">
<p class="topic-title first">On this page</p>
<ul class="simple">
<li><a class="reference internal" href="mongoid-queries.html#id1" id="id2">Queries</a></li>
<li><a class="reference internal" href="mongoid-queries.html#queries-persistence" id="id3">Queries + Persistence</a></li>
<li><a class="reference internal" href="mongoid-queries.html#scoping" id="id4">Scoping</a></li>
<li><a class="reference internal" href="mongoid-queries.html#map-reduce" id="id5">Map/Reduce</a></li>
</ul>
</div>
<p>One of MongoDB&#8217;s greatest features is its ability to execute dynamic
queries, which Origin abstracts in a familiar Arel-style DSL that
Mongoid includes.</p>
<div class="section" id="id1">
<h2>Queries<a class="headerlink" href="mongoid-queries.html#id1" title="Permalink to this headline">¶</a></h2>
<p>All queries in Mongoid are <tt class="docutils literal"><span class="pre">Mongoid::Criteria</span></tt>, which is a chainable and
lazily evaluated wrapper to a MongoDB dynamic query. Criteria only
touch the database when they need to, for example on iteration of the
results, and when executed wrap a cursor in order to keep memory
management and performance predictable.</p>
<div class="section" id="queryable-dsl">
<h3>Queryable DSL<a class="headerlink" href="mongoid-queries.html#queryable-dsl" title="Permalink to this headline">¶</a></h3>
<p>Mongoid&#8217;s main query DSL is provided by Origin. Any method that is available
on an <tt class="docutils literal"><span class="pre">Origin::Queryable</span></tt> exists on a <tt class="docutils literal"><span class="pre">Mongoid::Criteria</span></tt>
<em>as well as</em> off the model&#8217;s class.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Depeche Mode&quot;</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span>
  <span class="n">where</span><span class="p">(</span><span class="ss">:founded</span><span class="o">.</span><span class="n">gte</span> <span class="o">=&gt;</span> <span class="s2">&quot;1980-1-1&quot;</span><span class="p">)</span><span class="o">.</span>
  <span class="k">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span> <span class="s2">&quot;Tool&quot;</span><span class="p">,</span> <span class="s2">&quot;Deftones&quot;</span> <span class="o">]</span><span class="p">)</span><span class="o">.</span>
  <span class="n">union</span><span class="o">.</span>
  <span class="k">in</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="o">[</span> <span class="s2">&quot;Melvins&quot;</span> <span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
<p>With each chained method on a criteria, a newly cloned criteria
is returned with the new query added. This is so that with scoping
or exposures, for example, the original queries are unmodified
and remain reusable.</p>
</div>
<div class="section" id="additional-query-methods">
<h3>Additional Query Methods<a class="headerlink" href="mongoid-queries.html#additional-query-methods" title="Permalink to this headline">¶</a></h3>
<p>In addition to behavior that Origin provides, Mongoid also has some helpful
methods on criteria.</p>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operation</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#count</span></tt></p>
<p class="last"><em>Get a count of persisted documents. Note this will always hit
the database for the count.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">count</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#distinct</span></tt></p>
<p class="last"><em>Get a list of distinct values for a single field. Note this will always hit
the database for the distinct values.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:fans</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">100000</span><span class="p">)</span><span class="o">.</span>
  <span class="n">distinct</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#each</span></tt></p>
<p class="last"><em>Iterate over all matching documents in the criteria.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">band</span><span class="o">|</span>
  <span class="nb">p</span> <span class="n">band</span><span class="o">.</span><span class="n">name</span>
<span class="k">end</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#exists?</span></tt></p>
<p class="last"><em>Determine if any matching documents exist. Will return true if there
are 1 or more.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">exists?</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists?</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#find</span></tt></p>
<p class="last"><em>Find a document or multiple documents by their ids. Will raise
an error by default if any of the ids do not match.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;4baa56f1230048567300485c&quot;</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
  <span class="s2">&quot;4baa56f1230048567300485c&quot;</span><span class="p">,</span>
  <span class="s2">&quot;4baa56f1230048567300485d&quot;</span>
<span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
  <span class="s2">&quot;4baa56f1230048567300485c&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#find_by</span></tt></p>
<p class="last"><em>Find a document by the provided attributes, and if not found
raise an error or return nil depending on the
* ``raise_not_found_error`` *configuration option.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span>

<span class="no">Band</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">band</span><span class="o">|</span>
  <span class="n">band</span><span class="o">.</span><span class="n">impressions</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="k">end</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#find_or_create_by</span></tt></p>
<p class="last"><em>Find a document by the provided attributes, and if not found
create and return a newly persisted one.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">find_or_create_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:likes</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">find_or_create_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#find_or_initialize_by</span></tt></p>
<p class="last"><em>Find a document by the provided attributes, and if not found
return a new one.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">find_or_initialize_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:likes</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">find_or_initialize_by</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#first|last</span></tt></p>
<p class="last"><em>Finds a single document given the provided criteria. This guarantees no order.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">first</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:members</span><span class="o">.</span><span class="n">with_size</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:members</span><span class="o">.</span><span class="n">with_size</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#first_or_create</span></tt></p>
<p class="last"><em>Find the first document by the provided attributes, and if not found
create and return a newly persisted one.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_create</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#first_or_create!</span></tt></p>
<p class="last"><em>Find the first document by the provided attributes, and if not found
create and return a newly persisted one using</em> <tt class="docutils literal"><span class="pre">create!</span></tt>.</p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_create!</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#first_or_initialize</span></tt></p>
<p class="last"><em>Find the first document by the provided attributes, and if not found
return a new one.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_initialize</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#for_js</span></tt></p>
<p class="last"><em>Find documents for a provided javascript expression. This will
wrap the javascript in a `BSON::Code` object which is the
safe way to avoid javascript injection attacks.*</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">for_js</span><span class="p">(</span><span class="s2">&quot;this.name = param&quot;</span><span class="p">,</span> <span class="ss">param</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#length|size</span></tt></p>
<p class="last"><em>Same as count but caches subsequent calls to the database</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">length</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;FKA Twigs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">size</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#pluck</span></tt></p>
<p class="last"><em>Get all the values for the provided field.
Returns nil for unset fields and for non-existent fields.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="eager-loading">
<h3>Eager Loading<a class="headerlink" href="mongoid-queries.html#eager-loading" title="Permalink to this headline">¶</a></h3>
<p>Mongoid provides a facility to eager load documents
from relations to prevent the n+1 issue when
iterating over documents with relation access. Eager loaded is supported on
all relations with the exception of polymorphic <tt class="docutils literal"><span class="pre">belongs_to</span></tt>
associations.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">has_many</span> <span class="ss">:albums</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Album</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">belongs_to</span> <span class="ss">:band</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:albums</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">band</span><span class="o">|</span>
  <span class="nb">p</span> <span class="n">band</span><span class="o">.</span><span class="n">albums</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">name</span> <span class="c1"># Does not hit the database again.</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="queries-persistence">
<h2>Queries + Persistence<a class="headerlink" href="mongoid-queries.html#queries-persistence" title="Permalink to this headline">¶</a></h2>
<p>Mongoid supports persistence operations off of criteria
in a light capacity for when you want to expressively perform multi
document inserts, updates, and deletion.</p>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operation</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#create</span></tt></p>
<p class="last"><em>Create a newly persisted document.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#create!</span></tt></p>
<p class="last"><em>Create a newly persisted document and raise an exception on validation failure.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">create!</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#build|new</span></tt></p>
<p class="last"><em>Create a new (unsaved) document.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">build</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">new</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#update</span></tt></p>
<p class="last"><em>Update attributes of the first matching document.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s2">&quot;Mute&quot;</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#update_all</span></tt></p>
<p class="last"><em>Update attributes of all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">update_all</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s2">&quot;Mute&quot;</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#add_to_set</span></tt></p>
<p class="last"><em>Perform an $addToSet on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_to_set</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s2">&quot;Mute&quot;</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#bit</span></tt></p>
<p class="last"><em>Perform a $bit on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">bit</span><span class="p">(</span><span class="ss">likes</span><span class="p">:</span> <span class="p">{</span> <span class="ow">and</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="ow">or</span><span class="p">:</span> <span class="mi">4</span> <span class="p">})</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#inc</span></tt></p>
<p class="last"><em>Perform an $inc on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="ss">likes</span><span class="p">:</span> <span class="mi">123</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#pop</span></tt></p>
<p class="last"><em>Perform a $pop on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Photek&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#pull</span></tt></p>
<p class="last"><em>Perform a $pull on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="s2">&quot;Maynard&quot;</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#pull_all</span></tt></p>
<p class="last"><em>Perform a $pullAll on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span>
  <span class="n">pull_all</span><span class="p">(</span><span class="ss">:members</span><span class="p">,</span> <span class="o">[</span> <span class="s2">&quot;Maynard&quot;</span><span class="p">,</span> <span class="s2">&quot;Danny&quot;</span> <span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#push</span></tt></p>
<p class="last"><em>Perform a $push on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="s2">&quot;Maynard&quot;</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#push_all</span></tt></p>
<p class="last"><em>Perform a $pushAll on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span>
  <span class="n">push_all</span><span class="p">(</span><span class="ss">members</span><span class="p">:</span> <span class="o">[</span> <span class="s2">&quot;Maynard&quot;</span><span class="p">,</span> <span class="s2">&quot;Danny&quot;</span> <span class="o">]</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#rename</span></tt></p>
<p class="last"><em>Perform a $rename on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="ss">:title</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#set</span></tt></p>
<p class="last"><em>Perform a $set on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="ss">likes</span><span class="p">:</span> <span class="mi">10000</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#unset</span></tt></p>
<p class="last"><em>Perform a $unset on all matching documents.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Tool&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="ss">:likes</span><span class="p">)</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#delete</span></tt></p>
<p class="last"><em>Deletes all matching documents in the database.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s2">&quot;Mute&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first"><tt class="docutils literal"><span class="pre">Criteria#destroy</span></tt></p>
<p class="last"><em>Deletes all matching documents in the database while running callbacks for all.
This loads all documents into memory and can be an expensive operation.</em></p>
</td>
<td><div class="first last highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">label</span><span class="p">:</span> <span class="s2">&quot;Mute&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="scoping">
<h2>Scoping<a class="headerlink" href="mongoid-queries.html#scoping" title="Permalink to this headline">¶</a></h2>
<p>Scopes provide a convenient way to reuse common criteria with more
business domain style syntax.</p>
<div class="section" id="named-scopes">
<h3>Named Scopes<a class="headerlink" href="mongoid-queries.html#named-scopes" title="Permalink to this headline">¶</a></h3>
<p>Named scopes are simply criteria defined at class load that are referenced
by a provided name. Just like normal criteria, they are lazy and chainable.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:country</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:genres</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span>

  <span class="n">scope</span> <span class="ss">:english</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">country</span><span class="p">:</span> <span class="s2">&quot;England&quot;</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:rock</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">:genres</span><span class="o">.</span><span class="n">in</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="s2">&quot;rock&quot;</span> <span class="o">]</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">english</span><span class="o">.</span><span class="n">rock</span> <span class="c1"># Get the English rock bands.</span>
</pre></div>
</div>
<p>Named scopes can take procs and blocks for accepting parameters or
extending functionality.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:country</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">true</span>

  <span class="n">scope</span> <span class="ss">:named</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="nb">name</span><span class="p">){</span> <span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="nb">name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">{</span>
    <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
      <span class="k">def</span> <span class="nf">deutsch</span>
        <span class="n">tap</span> <span class="o">|</span><span class="n">scope</span><span class="o">|</span> <span class="k">do</span>
          <span class="n">scope</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="s2">&quot;origin&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Deutschland&quot;</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">named</span><span class="p">(</span><span class="s2">&quot;Depeche Mode&quot;</span><span class="p">)</span> <span class="c1"># Find Depeche Mode.</span>
<span class="no">Band</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">deutsch</span> <span class="c1"># Find active German bands.</span>
</pre></div>
</div>
</div>
<div class="section" id="default-scopes">
<h3>Default Scopes<a class="headerlink" href="mongoid-queries.html#default-scopes" title="Permalink to this headline">¶</a></h3>
<p>Default scopes can be useful when you find yourself applying the same
criteria to most queries, and want something to be there by default.
Default scopes take procs that return criteria objects.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">true</span>

  <span class="n">default_scope</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">band</span><span class="o">|</span>
  <span class="c1"># All bands here are active.</span>
<span class="k">end</span>
</pre></div>
</div>
<p>You can tell Mongoid not to apply the default scope by using
<tt class="docutils literal"><span class="pre">unscoped</span></tt>, which can be inline or take a block.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">unscoped</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Depeche Mode&quot;</span><span class="p">)</span>
<span class="no">Band</span><span class="o">.</span><span class="n">unscoped</span> <span class="k">do</span>
  <span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Depeche Mode&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>You can also tell Mongoid to explicitly apply the default scope
again later to always ensure it&#8217;s there.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">unscoped</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Depeche Mode&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">scoped</span>
</pre></div>
</div>
<p>If you are using a default scope on a model that is part of a relation,
you must reload the relation to have scoping reapplied.
This is important to note if you change a value of a document in the relation
that would affect its visibility within the scoped relation.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Label</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">embeds_many</span> <span class="ss">:bands</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">true</span>
  <span class="n">embedded_in</span> <span class="ss">:label</span>
  <span class="n">default_scoped</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">label</span><span class="o">.</span><span class="n">bands</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
<span class="n">label</span><span class="o">.</span><span class="n">bands</span> <span class="c1">#=&gt; [ band ]</span>
<span class="n">band</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:active</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span>
<span class="n">label</span><span class="o">.</span><span class="n">bands</span> <span class="c1">#=&gt; [ band ] Must reload.</span>
<span class="n">label</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">bands</span> <span class="c1">#=&gt; []</span>
</pre></div>
</div>
</div>
<div class="section" id="class-methods">
<h3>Class Methods<a class="headerlink" href="mongoid-queries.html#class-methods" title="Permalink to this headline">¶</a></h3>
<p>Class methods on models that return criteria objects are also
treated like scopes, and can be chained as well.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Band</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
  <span class="n">field</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">true</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">active</span>
    <span class="n">where</span><span class="p">(</span><span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Band</span><span class="o">.</span><span class="n">active</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="map-reduce">
<h2>Map/Reduce<a class="headerlink" href="mongoid-queries.html#map-reduce" title="Permalink to this headline">¶</a></h2>
<p>Mongoid provides a DSL around MongoDB&#8217;s map/reduce framework, for performing
custom map/reduce jobs or simple aggregations.</p>
<div class="section" id="execution">
<h3>Execution<a class="headerlink" href="mongoid-queries.html#execution" title="Permalink to this headline">¶</a></h3>
<p>You can tell Mongoid off the class or a criteria to perform a map/reduce
by calling <tt class="docutils literal"><span class="pre">map_reduce</span></tt> and providing map and reduce javascript
functions.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">map</span> <span class="o">=</span> <span class="sx">%Q{</span>
<span class="sx">  function() {</span>
<span class="sx">    emit(this.name, { likes: this.likes });</span>
<span class="sx">  }</span>
<span class="sx">}</span>

<span class="n">reduce</span> <span class="o">=</span> <span class="sx">%Q{</span>
<span class="sx">  function(key, values) {</span>
<span class="sx">    var result = { likes: 0 };</span>
<span class="sx">    values.forEach(function(value) {</span>
<span class="sx">      result.likes += value.likes;</span>
<span class="sx">    });</span>
<span class="sx">    return result;</span>
<span class="sx">  }</span>
<span class="sx">}</span>

<span class="no">Band</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:likes</span><span class="o">.</span><span class="n">gt</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">map_reduce</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">reduce</span><span class="p">)</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="ss">inline</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
</pre></div>
</div>
<p>Just like criteria, map/reduce calls are lazily evaluated. So nothing will
hit the database until you iterate over the results, or make a call on the
wrapper that would need to force a database hit.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="no">Band</span><span class="o">.</span><span class="n">map_reduce</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">reduce</span><span class="p">)</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="ss">replace</span><span class="p">:</span> <span class="s2">&quot;mr-results&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">p</span> <span class="n">document</span> <span class="c1"># { &quot;_id&quot; =&gt; &quot;Tool&quot;, &quot;value&quot; =&gt; { &quot;likes&quot; =&gt; 200 }}</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The only required thing you provide along with a map/reduce is where to
output the results. If you do not provide this an error will be raised.
Valid options to <tt class="docutils literal"><span class="pre">#out</span></tt> are:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">inline:</span> <span class="pre">1</span></tt>: Don&#8217;t store the output in a collection.</li>
<li><tt class="docutils literal"><span class="pre">replace:</span> <span class="pre">&quot;name&quot;</span></tt>: Store in a collection with the
provided name, and overwrite any documents that exist in it.</li>
<li><tt class="docutils literal"><span class="pre">merge:</span> <span class="pre">&quot;name&quot;</span></tt>: Store in a collection with the
provided name, and merge the results with the existing documents.</li>
<li><tt class="docutils literal"><span class="pre">reduce:</span> <span class="pre">&quot;name&quot;</span></tt>: Store in a collection with the
provided name, and reduce all existing results in that collection.</li>
</ul>
</div>
</div>
</div>

                  <div class="footer">
                    <div class="copyright">
                      <p>&copy; MongoDB, Inc 2008-2016. MongoDB, Mongo, and the leaf logo are registered trademarks of MongoDB, Inc.</p>
                    </div>
                  </div>
              </div></div>
            </div>
        </div>
    </div>
    <div class="right-column">
      <div class="wrapper"> 
          <div class="report-link">
            <a class="jira-link jirafeedback" href="https://jira.mongodb.org/secure/CreateIssueDetails!init.jspa?pid=10380&issuetype=4&priority=4&summary=Comment+on%3a+%22tutorial/mongoid-queries%2Etxt%22" target="_blank" title="Report a problem with tutorial/mongoid-queries.txt on Jira">Report a Problem</a>
          </div>
        
           <div class="social">
             <a class="twitter-icon" href="https://twitter.com/MongoDB"><i class="fa fa-twitter-square"></i></a>
             <a class="youtube-icon" href="https://www.youtube.com/user/MongoDB"><i class="fa fa-youtube-square"></i></a>
             <a class="facebook-icon" href="https://www.facebook.com/mongodb"><i class="fa fa-facebook-square"></i></a>
             <a class="gplus-icon" href="https://plus.google.com/u/1/101024085748034940765/posts?cfem=1"><i class="fa fa-google-plus-square"></i></a>
           </div>
        
      </div>
    </div>
    <div class="clearfix"></div>
  </div>
  

  <script type="text/javascript">
  window.fullDocsPath = function(base) {
    var body = document.getElementsByClassName('body')[0]
    var path = body.getAttribute('data-pagename');

    // skip if pagename is undefined (index.html)
    if (path == 'index') {
        path = '';
    } else if (path) {
      path = path + '/';
    }

    return '/' + base + '/' + path;
  }
  // Bootstrap array of links that should trigger a full page reload
  window.docsExcludedNav = ['/drivers', '/drivers/c', '/drivers/cpp', '/drivers/csharp', '/drivers/go', '/drivers/erlang', '/drivers/node-js', '/drivers/perl', '/drivers/php', '/drivers/python', '/drivers/ruby', '/drivers/scala'];

  $(document).ready(function(){
    $(".version-selector").on('click', function(e) {
      e.preventDefault();
      var base = $(e.currentTarget).data('path');
      window.location.href = fullDocsPath(base);
    });

    $("select.language-selector").on('change', function(e) {
      var path = $(e.currentTarget).find('option:selected').data('path');
      window.location.href = path;
    });
  });

  </script></body>
</html>
