<!DOCTYPE html>
<html>
  <head>
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta content='A Ruby ODM for MongoDB' name='description'>
    <meta content='mongoid, mongodb, ruby, rails, odm, durran jordan' name='keywords'>
    <!--[if lt IE 9]>
      <script src='http://html5shiv.googlecode.com/svn/trunk/html5.js'></script>
    <![endif]-->
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0' name='viewport'>
    <link href="../../../stylesheets/bootstrap.min.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="../../../stylesheets/bootstrap-responsive.min.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="../../../stylesheets/mongoid.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="../../../stylesheets/mongoid-coderay.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="../../../javascripts/jquery-1.8.1.min.js" type="text/javascript"></script>
    <script src="../../../javascripts/bootstrap-dropdown.js" type="text/javascript"></script>
    <script src="../../../javascripts/bootstrap-scrollspy.js" type="text/javascript"></script>
    <script src="../../../javascripts/bootstrap-tooltip.js" type="text/javascript"></script>
    <script src="../../../javascripts/mongoid.js" type="text/javascript"></script>
    <title>Mongoid: Installation</title>
  </head>
  <body data-offset='100' data-spy='scroll-spy' data-target='.page-nav'>
    <div id='content'>
      <div class='container'>
        <p style='background-color:#EEE;padding: 5px 10px;margin-top:30px;'>
          You are looking at the docs for v4.x. You can check out this page for Mongoid
          <a href='https://mongoid.github.io/en/mongoid/v3/installation.html'>v3.x</a>
          if you haven't upgraded yet.
        </p>
        <h1>Getting Started</h1>
        <div class='page-nav'>
          <div class='container'>
            <ul class='nav nav-pills'>
              <li><a href="installation.html#prerequisites">Prerequisites</a></li>
              <li><a href="installation.html#installation">Installation</a></li>
              <li><a href="installation.html#configuration">Configuration</a></li>
              <li><a href="installation.html#logging">Logging</a></li>
              <li><a href="installation.html#replica">Replica Sets</a></li>
              <li><a href="installation.html#sharding">Sharding</a></li>
            </ul>
          </div>
        </div>
        <section id='prerequisites'>
          <h2>Prerequisites</h2>
          <p>
            There are a few things you need to have in your toolbox before tackling
            a web application using Mongoid.
            <ul>
              <li>A good to advanced knowledge of Ruby.</li>
              <li>Have good knowledge of your web framework if using one.</li>
              <li>A thorough understanding of MongoDB.</li>
            </ul>
          </p>
          <p>
            This may seem like a "thank you Captain Obvious" moment, however if you
            believe that you can just hop over to Mongoid because you read a blog
            post on how cool Ruby and MongoDB were, you are in for a
            <i>world of pain</i>.
          </p>
          <p>
            Mongoid leverages many aspects of the Ruby programming
            language that are not for beginner use, and sending the core
            team into a frenzy tracking down a bug for a common Ruby mistake is a
            waste of our time, and all of the other users of the framework as well.
          </p>
          <div class='well'>
            <table>
              <tr>
                <td class='achtung'><img src="../../../images/achtung.png" /></td>
                <td class='note'>
                  <p>
                    <i>THE DATABASE IS NOT A BLACK BOX</i>.
                  </p>
                  Mongoid is an abstraction to make application developers'
                  lives easier, however the internals leverage the
                  power of MongoDB and it is truly important to know what is going on
                  under the covers. This is why the documentation provides the exact
                  queries that Mongoid is executing against the database when you call a
                  persistence operation. If we took the time to tell you, you should listen. :)
                </td>
              </tr>
            </table>
          </div>
        </section>
        <section id='installation'>
          <h2>Installation</h2>
          <p>
            The preferred method for installing Mongoid is with bundler. Simply add
            Mongoid to your <code>Gemfile</code>.
          </p>
          <div class="CodeRay">
            <div class="code"><pre>gem <span class="string"><span class="delimiter">&quot;</span><span class="content">mongoid</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">~&gt; 4.0.0</span><span class="delimiter">&quot;</span></span>&#x000A;</pre></div>
          </div>
          <p>
            Alternatively you can get the Mongoid gem direcly from rubygems.org:
          </p>
          <div class="CodeRay">
            <div class="code"><pre><span class="error">$</span> gem install mongoid&#x000A;</pre></div>
          </div>
          <div class='well'>
            <table>
              <tr>
                <td class='achtung'><img src="../../../images/achtung.png" /></td>
                <td class='note'>
                  The minimum version of MongoDB that is required for you to run Mongoid
                  4.0.0 is <code>2.4.0</code>.
                </td>
              </tr>
            </table>
          </div>
        </section>
        <section id='configuration'>
          <h2>Configuration</h2>
          <p>
            Mongoid configuration can be done through a <code>mongoid.yml</code> that
            specifies your options and database sessions. The simplest configuration
            is as follows, which sets the default session to "localhost:27017"
            and provides a single database in that session named "mongoid".
          </p>
          <div class="CodeRay">
            <div class="code"><pre><span class="key">development</span>:&#x000A;  <span class="key">sessions</span>:&#x000A;    <span class="key">default</span>:&#x000A;      <span class="key">database</span>: <span class="string"><span class="content">mongoid</span></span>&#x000A;      <span class="key">hosts</span>:&#x000A;        - <span class="string"><span class="content">localhost:27017</span></span>&#x000A;</pre></div>
          </div>
          <h3>Rails Applications</h3>
          <p>
            You can generate a config file by executing the generator and then editing
            <code>myapp/config/mongoid.yml</code> to your heart's desire. Mongoid will
            then handle everything else from there.
          </p>
          <div class="CodeRay">
            <div class="code"><pre>$ rails g mongoid:config&#x000A;</pre></div>
          </div>
          <p>
            When Mongoid loads its configuration, it chooses the environment to used
            based on the following order:
            <ul>
              <li><code>Rails.env</code> if using Rails.</li>
              <li><code>Sinatra::Base.environment</code> if using Sinatra.</li>
              <li><code>RACK_ENV</code> environment variable.</li>
              <li><code>MONGOID_ENV</code> environment variable.</li>
            </ul>
          </p>
          <p>
            If you are not using any rack based application and want to override the
            environment programatically, you can pass a second paramter to <code>load!</code>
            and Mongoid will use that.
          </p>
          <div class="CodeRay">
            <div class="code"><pre><span class="constant">Mongoid</span>.load!(<span class="string"><span class="delimiter">&quot;</span><span class="content">path/to/your/mongoid.yml</span><span class="delimiter">&quot;</span></span>, <span class="symbol">:production</span>)&#x000A;&#x000A;</pre></div>
          </div>
          <h3>Anatomy of a Mongoid Config</h3>
          <p>
            Let's have a look at a full-blown <code>mongoid.yml</code> and explain
            the full power of what Mongoid can do. The following configuration has its
            explanation in the comments above each key.
          </p>
          <div class="CodeRay">
            <div class="code"><pre><span class="comment"># Tell Mongoid which environment this configuration is for.</span>&#x000A;<span class="key">production</span>:&#x000A;  <span class="comment"># This starts the session configuration settings. You may have as</span>&#x000A;  <span class="comment"># many sessions as you like, but you must have at least 1 named</span>&#x000A;  <span class="comment"># 'default'.</span>&#x000A;  <span class="key">sessions</span>:&#x000A;    <span class="comment"># Define the default session.</span>&#x000A;    <span class="key">default</span>:&#x000A;      <span class="comment"># A session can have any number of hosts. Usually 1 for a single</span>&#x000A;      <span class="comment"># server setup, and at least 3 for a replica set. Hosts must be</span>&#x000A;      <span class="comment"># an array of host:port pairs. This session is single server.</span>&#x000A;      <span class="key">hosts</span>:&#x000A;        - <span class="string"><span class="content">flame.mongohq.com:27017</span></span>&#x000A;      <span class="comment"># Define the default database name.</span>&#x000A;      <span class="key">database</span>: <span class="string"><span class="content">mongoid</span></span>&#x000A;      <span class="comment"># Since this database points at a session connected to MongoHQ, we must</span>&#x000A;      <span class="comment"># provide the authentication details.</span>&#x000A;      <span class="key">username</span>: <span class="string"><span class="content">user</span></span>&#x000A;      <span class="key">password</span>: <span class="string"><span class="content">password</span></span>&#x000A;    <span class="comment"># This defines a secondary session at a replica set.</span>&#x000A;    <span class="key">replica_set</span>:&#x000A;      <span class="comment"># This configuration is a 3 node replica set.</span>&#x000A;      <span class="key">hosts</span>:&#x000A;        - <span class="string"><span class="content">dedicated1.myapp.com:27017</span></span>&#x000A;        - <span class="string"><span class="content">dedicated2.myapp.com:27017</span></span>&#x000A;        - <span class="string"><span class="content">dedicated3.myapp.com:27017</span></span>&#x000A;      <span class="key">database</span>: <span class="string"><span class="content">mongoid</span></span>&#x000A;      <span class="comment"># We can set session specific options, like reads executing</span>&#x000A;      <span class="comment"># on secondary nodes, and defaulting the session to safe mode.</span>&#x000A;      <span class="key">options</span>:&#x000A;        <span class="key">read</span>: <span class="string"><span class="content">:secondary</span></span>&#x000A;        <span class="key">write</span>:&#x000A;          <span class="key">w</span>: <span class="string"><span class="content">:majority</span></span>&#x000A;    <span class="comment"># This defines a tertiary session at a Mongos fronted shard.</span>&#x000A;    <span class="key">shard</span>:&#x000A;      <span class="comment"># This configuration is a Mongos shard server.</span>&#x000A;      <span class="key">hosts</span>:&#x000A;        - <span class="string"><span class="content">mongos.myapp.com:27017</span></span>&#x000A;      <span class="key">database</span>: <span class="string"><span class="content">mongoid</span></span>&#x000A;    <span class="comment"># This configuration shows an authenticated replica set via a uri.</span>&#x000A;    <span class="key">another</span>:&#x000A;      <span class="key">uri</span>: <span class="string"><span class="content">mongodb://user:pass@59.1.22.1:27017,59.1.22.2:27017/mongoid</span></span>&#x000A;  <span class="comment"># Here we put the Mongoid specific configuration options. These are explained</span>&#x000A;  <span class="comment"># in more detail next.</span>&#x000A;  <span class="key">options</span>:&#x000A;    <span class="key">include_root_in_json</span>: <span class="string"><span class="content">true</span></span>&#x000A;    <span class="key">include_type_for_serialization</span>: <span class="string"><span class="content">true</span></span>&#x000A;    <span class="comment"># Note this can also be true if you want to preload everything, but this is</span>&#x000A;    <span class="comment"># almost never necessary. Most of the time set this to false.</span>&#x000A;    <span class="key">preload_models</span>:&#x000A;      - <span class="string"><span class="content">Canvas</span></span>&#x000A;      - <span class="string"><span class="content">Browser</span></span>&#x000A;      - <span class="string"><span class="content">Firefox</span></span>&#x000A;    <span class="key">scope_overwrite_exception</span>: <span class="string"><span class="content">true</span></span>&#x000A;    <span class="key">raise_not_found_error</span>: <span class="string"><span class="content">false</span></span>&#x000A;    <span class="key">use_activesupport_time_zone</span>: <span class="string"><span class="content">false</span></span>&#x000A;    <span class="key">use_utc</span>: <span class="string"><span class="content">true</span></span>&#x000A;</pre></div>
          </div>
          <h3>Configuration options</h3>
          <p>
            Mongoid currently supports the following configuration options, either
            provided in the mongoid.yml or programatically (defaults in
            parenthesis).
          </p>
          <ul class='config'>
            <li>
              <code>include_root_in_json</code>(false): When set to true mongoid will
              include the name of the root document and the name of each association
              as the root element when calling <code>#to_json</code> on a model.
            </li>
            <li>
              <code>include_type_for_serialization</code>(false): When set to true this will
              tell Mongoid to include the "_type" field when serializing to JSON and XML.
            </li>
            <li>
              <code>preload_models</code>(false): Tells Mongoid to preload application
              model classes on each request in environments where classes are not
              being cached. Specify an array of class names when enabling, only to the
              classes that use inheritance.
            </li>
            <li>
              <code>protect_sensitive_fields</code>(true): Mongoid by default will auto
              protect '_id' and '_type' from mass assignment. Set this to false if you
              are daring with your application's security.
            </li>
            <li>
              <code>raise_not_found_error</code>(true): Will raise a
              <code>Mongoid::Errors::DocumentNotFound</code> when attempting to find a
              document by an id that doesnt exist. When set to false will only return
              nil for the same query.
            </li>
            <li>
              <code>scope_overwrite_exception</code>(false): This will instruct Mongoid
              to raise an error if you define a scope with the same name as an existing
              method.
            </li>
            <li>
              <code>use_activesupport_time_zone</code>(true): When in a Rails app will
              tell Mongoid to convert all times in the application to the local defined
              time zone in Active Support.
            </li>
            <li>
              <code>use_utc</code>(false): Instructs Mongoid to convert all times to
              UTC times in all cases.
            </li>
          </ul>
          <p>
            If you would like to see samples, there is one in the
            <a href="https://github.com/mongoid/mongoid/blob/master/spec/config/mongoid.yml">
            Mongoid repository</a> and one in the
            <a href="https://github.com/mongoid/echo/blob/master/config/mongoid.yml">
            Echo sample application</a>.
          </p>
          <h3>Getting Rid of Active Record</h3>
          <p>
            Now that you have a <code>mongoid.yml</code> you can't wait to delete that
            pesky <code>database.yml</code>, right? Do it and you'll start getting
            <code>ActiveRecord</code> errors all over the place.
            You don't need ActiveRecord unless you're trying to use Mongo in concert
            with a SQL database. Here's how you remove ActiveRecord from the most
            recent version of Rails.
          </p>
          <p>
            Open <code>myapp/config/application.rb</code> and near the top, remove
            the line <code>require "rails/all"</code> and add the following lines
            so you end up with this:
          </p>
          <div class="CodeRay">
            <div class="code"><pre>require <span class="string"><span class="delimiter">&quot;</span><span class="content">action_controller/railtie</span><span class="delimiter">&quot;</span></span>&#x000A;require <span class="string"><span class="delimiter">&quot;</span><span class="content">action_mailer/railtie</span><span class="delimiter">&quot;</span></span>&#x000A;require <span class="string"><span class="delimiter">&quot;</span><span class="content">active_resource/railtie</span><span class="delimiter">&quot;</span></span> <span class="comment"># Comment this line for Rails 4.0+</span>&#x000A;require <span class="string"><span class="delimiter">&quot;</span><span class="content">rails/test_unit/railtie</span><span class="delimiter">&quot;</span></span>&#x000A;<span class="comment"># require &quot;sprockets/railtie&quot; # Uncomment this line for Rails 3.1+</span>&#x000A;</pre></div>
          </div>
          <p>
            For Rails 3.2+ you'll also need to remove configuration options for
            Active Record that reside in your environments, ie
            <code>myapp/config/environments/development.rb</code>. Make sure any
            references to <code>active_record</code> are commented out like as follows
          </p>
          <div class="CodeRay">
            <div class="code"><pre><span class="comment"># Rails 3.2+, &lt; 4.0</span>&#x000A;<span class="comment"># config.active_record.mass_assignment_sanitizer = :strict</span>&#x000A;<span class="comment"># config.active_record.auto_explain_threshold_in_seconds = 0.5</span>&#x000A;<span class="comment">#</span>&#x000A;<span class="comment"># Rails 4.0+</span>&#x000A;<span class="comment"># config.active_record.migration_error = :page_load</span>&#x000A;</pre></div>
          </div>
          <p>
            For Rails 3.2.3+ but < 4.0 you'll also need to comment out the following line in
            <code>myapp/config/application.rb</code>.
          </p>
          <div class="CodeRay">
            <div class="code"><pre><span class="comment"># config.active_record.whitelist_attributes = true</span>&#x000A;</pre></div>
          </div>
          <p>
            You can also generate your new rails app sans Active Record like so.
          </p>
          <div class="CodeRay">
            <div class="code"><pre>rails new app_name --skip-active-record&#x000A;</pre></div>
          </div>
          <h3>Sinatra, Padrino, and others</h3>
          <p>
            You can create your <code>mongoid.yml</code> and place it anywhere you like.
            Just be sure that on application initialization you do the following:
          </p>
          <div class="CodeRay">
            <div class="code"><pre><span class="constant">Mongoid</span>.load!(<span class="string"><span class="delimiter">&quot;</span><span class="content">path/to/your/mongoid.yml</span><span class="delimiter">&quot;</span></span>)&#x000A;</pre></div>
          </div>
        </section>
        <section id='logging'>
          <h2>Logging</h2>
          <p>
            Changing logging options is done simply by telling Mongoid or Moped's
            logger to have a different level. Logging is turned off by default.
          </p>
          <div class="CodeRay">
            <div class="code"><pre><span class="keyword">module</span> <span class="class">MyApplication</span>&#x000A;  <span class="keyword">class</span> <span class="class">Application</span> &lt; <span class="constant">Rails</span>::<span class="constant">Application</span>&#x000A;    <span class="constant">Mongoid</span>.logger.level = <span class="constant">Logger</span>::<span class="constant">DEBUG</span>&#x000A;    <span class="constant">Moped</span>.logger.level = <span class="constant">Logger</span>::<span class="constant">DEBUG</span>&#x000A;  <span class="keyword">end</span>&#x000A;<span class="keyword">end</span>&#x000A;</pre></div>
          </div>
          <p>
            If you want to change the logger instance, you can simply just set a
            new one.
          </p>
          <div class="CodeRay">
            <div class="code"><pre><span class="constant">Mongoid</span>.logger = <span class="constant">Logger</span>.new(<span class="global-variable">$stdout</span>)&#x000A;<span class="constant">Moped</span>.logger = <span class="constant">Logger</span>.new(<span class="global-variable">$stdout</span>)&#x000A;</pre></div>
          </div>
        </section>
        <section id='replica'>
          <h2>Replica Sets</h2>
          <p>
            For replica sets, you only need to put each member of the replica set
            under the <code>hosts</code> section in your <code>mongoid.yml</code> -
            Mongoid and Moped will take care of the rest. The default read option is
            <code>:primary</code>, which means that reads will happen on the primary
            node. If you don't want this, switch this option to
            <code>:secondary</code>, which will send reads to the secondary(slaves) nodes.
          </p>
          <div class="CodeRay">
            <div class="code"><pre><span class="key">sessions</span>:&#x000A;  <span class="key">default</span>:&#x000A;    <span class="key">hosts</span>:&#x000A;      - <span class="string"><span class="content">repl0.myapp.com:27017</span></span>&#x000A;      - <span class="string"><span class="content">repl1.myapp.com:27017</span></span>&#x000A;      - <span class="string"><span class="content">repl3.myapp.com:27017</span></span>&#x000A;    <span class="key">database</span>: <span class="string"><span class="content">mongoid</span></span>&#x000A;    <span class="key">options</span>:&#x000A;      <span class="key">read</span>: <span class="string"><span class="content">:secondary</span></span>&#x000A;</pre></div>
          </div>
        </section>
        <section id='sharding'>
          <h2>Sharding</h2>
          <p>
            If you are using Mongoid in a sharded MongoDB environment and want to tell
            Mongoid to include the shard keys in its updates, specify this at the
            model class level.
          </p>
          <div class="CodeRay">
            <div class="code"><pre><span class="keyword">class</span> <span class="class">Person</span>&#x000A;  include <span class="constant">Mongoid</span>::<span class="constant">Document</span>&#x000A;&#x000A;  field <span class="symbol">:first_name</span>, <span class="key">type</span>: <span class="constant">String</span>&#x000A;  field <span class="symbol">:last_name</span>, <span class="key">type</span>: <span class="constant">String</span>&#x000A;&#x000A;  shard_key <span class="symbol">:first_name</span>, <span class="symbol">:last_name</span>&#x000A;<span class="keyword">end</span>&#x000A;</pre></div>
          </div>
          <p>
            In your <code>mongoid.yml</code>, just ensure that you are pointed at the
            <code>mongos</code> server in your hosts.
          </p>
          <div class="CodeRay">
            <div class="code"><pre><span class="key">sessions</span>:&#x000A;  <span class="key">default</span>:&#x000A;    <span class="key">hosts</span>:&#x000A;      - <span class="string"><span class="content">mongos.myapp.com:27017</span></span>&#x000A;    <span class="key">database</span>: <span class="string"><span class="content">mongoid</span></span>&#x000A;    <span class="key">options</span>:&#x000A;      <span class="key">read</span>: <span class="string"><span class="content">:secondary</span></span></pre></div>
          </div>
        </section>
      </div>
    </div>
  </body>
</html>
